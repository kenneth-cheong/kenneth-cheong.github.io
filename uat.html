<!DOCTYPE html>
<html>

<head>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // Google Sign-In variables (global scope)
        let googleUser = null; // Store the Google user object
        let codeReceiverURI = 'https://ts9k398yn8.execute-api.ap-southeast-1.amazonaws.com/googleLogin'; // Update with your actual URI

        // Function called after successful Google Sign-In
        function handleCredentialResponse(response) {
            fetch(codeReceiverURI, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ credential: response.credential })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.body.success) {
                        googleUser = data.body.user;
                        localStorage.setItem('googleUser', JSON.stringify(googleUser));
                        updateUI(true); // User logged in
                        console.log(data.body);
                        document.getElementById('logoutLink').querySelector('span') = "Logout " + data.body.user.name;
                    } else {
                        console.error("Backend verification failed:", data.message);
                        document.getElementById('loginError').textContent = data.message || "Google login failed.";
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loginError').textContent = "An error occurred.";
                });
        }

        function checkGoogleLogin() {
            const storedUser = localStorage.getItem('googleUser');
            if (storedUser) {
                googleUser = JSON.parse(storedUser);
                updateUI(true); // Already logged in via Google
                return true; // Indicate Google login success
            }

            google.accounts.id.initialize({
                client_id: '365369983219-12iqvk3v35kf03p3ts1gikglddtkofvq.apps.googleusercontent.com',
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.getElementById('googleSignInButton'),
                { theme: "outline", size: "large" }
            );
            return false; // Google login not yet completed
        }

        // Function to update UI based on login status (modified)
        function updateUI(isLoggedIn) {
            document.getElementById('loginForm').style.display = isLoggedIn ? 'none' : 'flex';
            document.getElementById('main-content').style.display = isLoggedIn ? 'block' : 'none';

            //Optionally: Display user info after Google login
            if (isLoggedIn && googleUser) {
                // Example: Show username after successful login
                const welcomeMessage = document.createElement('p');
                welcomeMessage.textContent = `Welcome, ${googleUser.name}!`;
                //document.getElementById('main-content').prepend(welcomeMessage);  // or wherever you want to display it.
            }
        }

        window.onload = async () => {
            const isLoggedIn = checkGoogleLogin();
            if (!isLoggedIn) {
                // Show the regular login form only if neither Google nor cookie login are active.
                document.getElementById('loginForm').style.display = 'flex';
            }
        };

    </script>
    <title>UAT</title>
    <style>
        body {
            font-family: sans-serif;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }

        th {
            background-color: #f2f2f2;
        }

        #loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        #error {
            color: red;
            margin-top: 10px;
            display: none;
        }

        .thumbnail {
            max-width: 100px;
            max-height: 100px;
            cursor: pointer;
        }

        .expanded-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .expanded-image img {
            max-width: 90%;
            max-height: 90%;
        }

        .hidden {
            display: none;
        }

        #google-tags ul {
            list-style-type: none;
            padding: 0;
        }

        #google-tags li {
            margin-bottom: 5px;
            /* Add some space between list items */
        }

        .page-break {
            page-break-before: always;
        }

        #loginForm {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            /* Semi-transparent background */
            z-index: 9999;
            /* Ensure it's on top */
        }

        #loginForm input {
            margin: 10px 0;
            padding: 8px;
            min-width: 40%;
        }

        #loginForm button {
            background-color: #004c9d;
            /* Example color */
            color: white;
            /* Text color */
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        body {
            font-family: sans-serif;
            margin: 20px;
            line-height: 1.6;
            color: #333;
            /* Darker, readable text */
        }

        h1 {
            color: #004c9d;
            /* Primary color */
            text-align: center;
            margin-bottom: 30px;
        }

        h2,
        h3 {
            color: #004c9d;
            /* Primary color */
            margin-top: 25px;
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="url"] {
            width: 95%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        button {
            background-color: #004c9d;
            /* Primary color */
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #003366;
            /* Darker shade on hover */
        }

        #loading {
            display: none;
            text-align: center;
            margin-top: 20px;
            font-style: italic;
            color: #777;
        }

        #error {
            color: #d32f2f;
            /* Error color */
            margin-top: 10px;
            display: none;
            text-align: center;
            font-weight: bold;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
            color: #555;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
            /* Slight background for even rows */
        }

        .header-text {
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            /* Needed for text-overflow */
            vertical-align: middle;
            /* Align with header tag */
        }

        .thumbnail {
            max-width: 80px;
            max-height: 80px;
            cursor: pointer;
            border-radius: 5px;
            /* Optional: rounded corners for thumbnails */
            transition: transform 0.2s ease;
        }

        .thumbnail:hover {
            transform: scale(1.1);
            /* Slight scale on hover */
        }

        .expanded-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .expanded-image img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            /* Ensures image fits without distortion */
        }

        .hidden {
            display: none;
        }

        #google-tags ul {
            list-style-type: none;
            padding: 0;
        }

        #google-tags li {
            margin-bottom: 8px;
        }

        .page-break {
            page-break-before: always;
        }

        /* Specific to GTmetrix */
        #gtmetrix-results {
            margin-bottom: 20px;
        }

        #gtmetrix-grade {
            font-size: 1.2em;
            font-weight: bold;
            color: #2e7d32;
            /* Success color */
        }

        #gtmetrix-report a {
            color: #1565c0;
            /* Link color */
            text-decoration: none;
            transition: color 0.2s ease;
        }

        #gtmetrix-report a:hover {
            color: #0d47a1;
            /* Darker link color on hover */
        }

        /* New Styles */

        /* Container for results to add spacing and potential background */
        #main-content {
            padding: 20px;
            border-radius: 10px;
            /* Optional: Adds rounded corners to the content area */
            background-color: #fff;
            /* White or very light background */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
    </style>
    <!-- jsPDF and html2pdf libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas library (required by jsPDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="icon"
        href="https://mediaonemarketing.com.sg/wp-content/uploads/2023/11/cropped-MediaOne-M-favicon-logo-32x32.png"
        sizes="32x32">

</head>

<body>

    <div id="loginForm">
        <div id="googleSignInButton"></div>
        <p id="loginError" style="color: red;"></p>
    </div>
    <div id="main-content">

        <h1>User Acceptance Test</h1>

        <label for="url">Enter URL:</label>
        <input type="url" id="url" name="url" size="50">
        <button onclick="analyzeURL()">Analyse</button>

        <div id="loading">Loading...</div>
        <div id="error"></div>


        <h2>Results</h2>

        <h3>GTmetrix</h3>
        <div id="gtmetrix-results">
            <div id="gtmetrix-grade"></div>
            <div id="gtmetrix-report"></div>
        </div>

        <h3>Google Tags</h3>
        <div id="google-tags"></div>


        <h3>Page Speed Performance</h3>
        <table id="page-speed-table">
            <thead>
                <tr>
                    <th>Strategy</th>
                    <th>Performance Score</th>
                    <th>Final Screenshot</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Desktop</td>
                    <td id="desktop-score"></td>
                    <td id="desktop-screenshot"></td>
                </tr>
                <tr>
                    <td>Mobile</td>
                    <td id="mobile-score"></td>
                    <td id="mobile-screenshot"></td>
                </tr>
            </tbody>
        </table>

        <div id="expanded-image-container" class="expanded-image hidden">
            <img id="expanded-image" src="" alt="Expanded Screenshot">
        </div>

        <h3>Meta Information</h3>
        <table id="meta-table">
            <thead>
                <tr>
                    <th>Property</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Meta Title</td>
                    <td id="meta-title"></td>
                </tr>
                <tr>
                    <td>Meta Description</td>
                    <td id="meta-description"></td>
                </tr>
                <tr>
                    <td>Canonical Tag</td>
                    <td id="canonical-tag"></td>
                </tr>
            </tbody>
        </table>

        <h3>Webpage Formatting</h3>
        <div id="webpage-formatting"></div>

        <h3>robots.txt</h3>
        <div id="visible-text"></div>

        <h3>SSL</h3>
        <div id="ssl-info"></div>


        <h3>Website Crawler Results</h3>
        <table id="website-crawler-table">
            <thead>
                <tr>
                    <th>URL</th>
                    <th>Status Code</th>
                    <th>(Possible) Misspelled</th>
                    <th>HTTPS</th>
                    <th>Server</th>
                    <th>Flesch Kincaid Index</th>
                </tr>
            </thead>
            <tbody id="website-crawler-body">
            </tbody>
        </table>

        <div class="page-break"></div>
        <!-- Page break before Headers -->
        <h3>Headers</h3>
        <table id="headers-table">
            <thead>
                <tr>
                    <th>Header</th>
                </tr>
            </thead>
            <tbody id="headers-body">
            </tbody>
        </table>

        <div class="page-break"></div>
        <!-- Page break before Links -->
        <h3>Links</h3>
        <table id="links-table">
            <thead>
                <tr>
                    <th>Link Type</th>
                    <th>URL</th>
                    <th>Link Text</th>
                    <th>Status Code</th>
                </tr>
            </thead>
            <tbody id="links-body">
            </tbody>
        </table>


        <h3>Image Alt Text</h3>
        <table id="image-alt-table">
            <thead>
                <tr>
                    <th>Thumbnail</th>
                    <th>Image URL</th>
                    <th>Alt Text</th>
                </tr>
            </thead>
            <tbody id="image-alt-body">
            </tbody>
        </table>

    </div>




    <script>
        function showExpandedImage(base64Data) {
            const expandedImageContainer = document.getElementById('expanded-image-container');
            const expandedImage = document.getElementById('expanded-image');

            expandedImage.src = base64Data;
            expandedImageContainer.classList.remove('hidden');

            expandedImageContainer.onclick = function () {
                expandedImageContainer.classList.add('hidden');
                expandedImage.src = "";
            };
        }

        async function analyzeURL() {
            clearTables();
            const url = document.getElementById('url').value;
            if (!url) {
                alert("Please enter a URL.");
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';

            try {
                // Extract domain
                let domain;
                try {
                    const urlObj = new URL(url);
                    domain = urlObj.origin;
                } catch (e) {
                    console.error("Invalid URL:", url, e);
                    document.getElementById('error').innerText = "Invalid URL.  Please enter a valid URL.";
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                    return;
                }

                // Function to handle successful results and display them
                const handleResult = (result, displayFunction, elementId) => {
                    try {
                        if (displayFunction) {
                            displayFunction(result);
                        } else if (elementId) {
                            document.getElementById(elementId).innerText = result;
                        }
                    } catch (e) {
                        console.error("Error displaying result:", e);
                        document.getElementById('error').innerText = "Error displaying result: " + e;
                        document.getElementById('error').style.display = 'block';
                    }
                };

                // Function to handle errors from each promise
                const handleError = (error, functionName) => {
                    console.error(`Error in ${functionName}:`, error);
                    document.getElementById('error').innerText = `Error in ${functionName}: ` + error;
                    document.getElementById('error').style.display = 'block';
                };

                // Fetch HTML content  - needs special handling due to displayResults
                const htmlPromise = fetch('https://abrhhnjp4m.execute-api.ap-southeast-1.amazonaws.com/getHtml', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url
                    })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error fetching HTML! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(htmlData => {
                        return displayResults(htmlData.body);  // displayResults *returns* a promise or void
                    })
                    .catch(error => handleError(error, 'fetchHtml'));

                // Start all asynchronous operations and handle results as they come in
                fetchRobots(domain)
                    .then(result => handleResult(result, null, 'visible-text')) // Display result immediately
                    .catch(error => handleError(error, 'fetchRobots'));

                checkSsl(domain)
                    .then(result => handleResult(result, null, 'ssl-info')) // Display result immediately
                    .catch(error => handleError(error, 'checkSsl'));

                checkPageSpeed(url)
                    .then(result => {
                        displayPageSpeedResults(result); // Display result immediately
                        return result;
                    })
                    .catch(error => handleError(error, 'checkPageSpeed'));

                checkGTmetrix(url)
                    .then(result => {
                        displayGTmetrixResults(result); // Display result immediately
                        return result;
                    })
                    .catch(error => handleError(error, 'checkGTmetrix'));

                websiteCrawler(domain, url)
                    .then(result => {
                        displayWebsiteCrawlerResults(result); // Display result immediately
                        return result;
                    })
                    .catch(error => handleError(error, 'websiteCrawler'));

                checkWebpageFormatting(url)
                    .then(result => {
                        displayWebpageFormattingResults(result); // Display result immediately
                        return result;
                    })
                    .catch(error => handleError(error, 'checkWebpageFormatting'));


                // Optionally, keep track of all promises to ensure they all complete
                Promise.all([
                    htmlPromise, fetchRobots(domain), checkSsl(domain), checkPageSpeed(url), checkGTmetrix(url), websiteCrawler(domain, url), checkWebpageFormatting(url)
                ]).then(() => {
                    document.getElementById('loading').style.display = 'none'; // Hide loading when ALL are done
                }).catch(() => {
                    document.getElementById('loading').style.display = 'none';// Hide loading even if some error
                });


            } catch (error) {
                console.error('General Error:', error);
                document.getElementById('error').innerText = "An error occurred: " + error;
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function checkWebpageFormatting(url) {
            try {
                const response = await fetch('https://d0yvj1jopb.execute-api.ap-southeast-1.amazonaws.com/webpageFomatting', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error fetching Webpage Formatting data! Status: ${response.status}`);
                }

                const data = await response.json();
                return data.body;

            } catch (error) {
                console.error("Error checking Webpage Formatting:", error);
                document.getElementById('error').innerText = "Error checking Webpage Formatting: " + error;
                document.getElementById('error').style.display = 'block';
                return "Error fetching Webpage Formatting data.";
            }
        }


        function displayWebpageFormattingResults(data) {
            document.getElementById('webpage-formatting').innerHTML = data;
        }

        async function websiteCrawler(domain, url) {
            try {
                response = await fetch('https://781r68gcz9.execute-api.ap-southeast-1.amazonaws.com/websiteCrawler', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        domain: domain,
                        start_url: url
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error in websiteCrawler! status: ${response.status}`);
                }

                const taskId = await response.json();

                console.log(taskId);

                // Wait for 20 seconds (20000 milliseconds)
                await new Promise(resolve => setTimeout(resolve, 20000));

                response = await fetch('https://68x3gtrb48.execute-api.ap-southeast-1.amazonaws.com/getWebsiteCrawlerResults', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        task_id: taskId
                    })
                });


                const crawlerResults = await response.json();

                console.log(crawlerResults);
                return (crawlerResults.body);

            } catch (error) {
                console.error("Error fetching from websiteCrawler:", error);
                throw error;
            }

        }


        function displayWebsiteCrawlerResults(data) {
            const tableBody = document.getElementById('website-crawler-body');
            tableBody.innerHTML = ''; // Clear existing results

            if (Array.isArray(data)) {
                data.forEach(item => {
                    const row = tableBody.insertRow();

                    const urlCell = row.insertCell();
                    urlCell.innerHTML = `<a href="${item.url}" target="_blank" rel="noopener noreferrer">${item.url}</a>`;

                    const statusCodeCell = row.insertCell();
                    statusCodeCell.innerText = item.status_code;

                    const misspelledCell = row.insertCell();
                    misspelledCell.innerText = item.meta.spell && item.meta.spell.misspelled && Array.isArray(item.meta.spell.misspelled) && item.meta.spell.misspelled.length > 0 ?
                        item.meta.spell.misspelled.map(wordObj => wordObj.word).join(', ') :
                        'None';

                    const isHttpsCell = row.insertCell();
                    isHttpsCell.innerText = item.checks.is_https ? 'Yes' : 'No';

                    const serverCell = row.insertCell();
                    serverCell.innerText = item.server;

                    const fleschKincaidIndexCell = row.insertCell();
                    fleschKincaidIndexCell.innerText = Math.round(item.meta.content.flesch_kincaid_readability_index);
                });
            } else {
                // Handle the case where data is not an array (e.g., an error message)
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 6; // Span across all columns
                cell.innerText = "Error: Could not retrieve crawler data.";
            }
        }



        async function checkGTmetrix(url) {
            try {
                const response = await fetch('https://y5830908vh.execute-api.ap-southeast-1.amazonaws.com/gtmetrix', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error fetching GTmetrix data! Status: ${response.status}`);
                }

                const data = await response.json();
                return data;


            } catch (error) {
                console.error("Error checking GTmetrix:", error);
                document.getElementById('error').innerText = "Error checking GTmetrix: " + error;
                document.getElementById('error').style.display = 'block';
                return {
                    grade: "Error fetching GTmetrix grade.",
                    reportUrl: ""
                };
            }
        }

        function displayGTmetrixResults(data) {
            const grade = data.body.data.attributes.gtmetrix_grade;
            const reportUrl = data.body.data.links.report_url;

            document.getElementById('gtmetrix-grade').innerText = `GTmetrix Grade: ${grade}`;
            document.getElementById('gtmetrix-report').innerHTML = `<a href="${reportUrl}" target="_blank">View GTmetrix Report</a>`;
        }

        async function checkPageSpeed(url) {
            try {
                const desktopResponse = await fetch('https://olcgoflh75.execute-api.ap-southeast-1.amazonaws.com/pageSpeed', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url,
                        strategy: 'desktop'
                    })
                });

                const mobileResponse = await fetch('https://olcgoflh75.execute-api.ap-southeast-1.amazonaws.com/pageSpeed', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url,
                        strategy: 'mobile'
                    })
                });

                if (!desktopResponse.ok || !mobileResponse.ok) {
                    throw new Error(
                        `HTTP error fetching PageSpeed Insights! Desktop Status: ${desktopResponse.status}, Mobile Status: ${mobileResponse.status}`
                    );
                }

                const desktopData = await desktopResponse.json();
                const mobileData = await mobileResponse.json();

                return {
                    desktopData,
                    mobileData
                };

            } catch (error) {
                console.error("Error checking Page Speed:", error);
                document.getElementById('error').innerText = "Error checking Page Speed: " + error;
                document.getElementById('error').style.display = 'block';
                return {
                    desktopData: null,
                    mobileData: null
                };
            }
        }

        function displayPageSpeedResults(data) {
            if (!data || !data.desktopData || !data.mobileData) {
                document.getElementById('desktop-score').innerText = "Error";
                document.getElementById('mobile-score').innerText = "Error";
                document.getElementById('desktop-screenshot').innerText = "Error";
                document.getElementById('mobile-screenshot').innerText = "Error";
                return;
            }

            const desktopScore = data.desktopData.lighthouseResult.categories.performance.score;
            const mobileScore = data.mobileData.lighthouseResult.categories.performance.score;
            const desktopScreenshotData = data.desktopData.lighthouseResult.audits['final-screenshot'].details.data;
            const mobileScreenshotData = data.mobileData.lighthouseResult.audits['final-screenshot'].details.data;

            document.getElementById('desktop-score').innerText = desktopScore;
            document.getElementById('mobile-score').innerText = mobileScore;

            // Display Thumbnails, making them clickable
            document.getElementById('desktop-screenshot').innerHTML =
                `<img src="${desktopScreenshotData}" alt="Desktop Screenshot" class="thumbnail" onclick="showExpandedImage('${desktopScreenshotData}')">`;
            document.getElementById('mobile-screenshot').innerHTML =
                `<img src="${mobileScreenshotData}" alt="Mobile Screenshot" class="thumbnail" onclick="showExpandedImage('${mobileScreenshotData}')">`;

        }


        async function checkSsl(url) {
            try {
                const response = await fetch('https://2kxt49bwp1.execute-api.ap-southeast-1.amazonaws.com/checkSsl', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error checking SSL! status: ${response.status}`);
                }

                const data = await response.json();
                return data.message;
            } catch (error) {
                console.error("Error checking SSL:", error);
                return "Error checking SSL";
            }
        }


        async function fetchRobots(domain) {
            const robotsUrl = domain + "/robots.txt";
            try {
                const urlLibResponse = await fetch('https://1pfsx12au9.execute-api.ap-southeast-1.amazonaws.com/url_lib_lite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: robotsUrl
                    })
                });

                if (!urlLibResponse.ok) {
                    throw new Error(`HTTP error fetching URL + robots.txt! status: ${urlLibResponse.status}`);
                }

                const urlLibData = await urlLibResponse.json();

                return urlLibData.body.visible_text;
            } catch (e) {
                console.error("Error in fetchRobots:", e);
                return "Error fetching robots.txt";
            }

        }


        async function fetchStatusCode(url) {
            try {
                const response = await fetch('https://n0ge4xdang.execute-api.ap-southeast-1.amazonaws.com/getStatusCode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url
                    })
                });

                if (!response.ok) {
                    return `Error: ${response.status}`;
                }

                const data = await response.json();
                return data.body;
            } catch (error) {
                console.error("Error fetching status code:", error);
                return "Error";
            }
        }


        async function displayResults(html) {
            return new Promise((resolve, reject) => {
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // Meta Information
                    document.getElementById('meta-title').innerText = doc.querySelector('meta[name="title"]') ? doc
                        .querySelector('meta[name="title"]').content : doc.title;
                    document.getElementById('meta-description').innerText = doc.querySelector('meta[name="description"]') ?
                        doc.querySelector('meta[name="description"]').content : "";
                    document.getElementById('canonical-tag').innerText = doc.querySelector('link[rel="canonical"]') ? doc
                        .querySelector('link[rel="canonical"]').href : "";


                    // Headers (H1-H6)
                    const headers = doc.querySelectorAll('h1, h2, h3, h4, h5, h6');
                    const headersBody = document.getElementById('headers-body');
                    const indentation = {
                        'H1': 0,
                        'H2': 1,
                        'H3': 2,
                        'H4': 3,
                        'H5': 4,
                        'H6': 5
                    };
                    headers.forEach(header => {
                        let row = headersBody.insertRow();
                        let cell = row.insertCell();
                        // Remove whitespace and newlines
                        const headerText = header.innerText.trim().replace(/\s+/g, ' ');
                        const indentLevel = indentation[header.tagName];
                        const indent = ' '.repeat(indentLevel * 4); // Adjust the number for desired indentation
                        cell.innerHTML = `<span class="header-text">${indent}${header.tagName}: ${headerText}</span>`;
                    });


                    // Links (Internal and External)
                    const links = doc.querySelectorAll('a[href]');
                    const linksBody = document.getElementById('links-body');
                    const existingLinks = new Set();

                    const linkPromises = [];

                    links.forEach(async link => {
                        const href = link.href;
                        const linkText = link.innerText.trim(); // Extract link text and trim whitespace

                        if (existingLinks.has(href)) {
                            return;
                        }

                        existingLinks.add(href);

                        let linkType = 'External';
                        try {
                            const url = new URL(href);
                            const currentUrl = new URL(document.getElementById('url').value);
                            if (url.hostname === currentUrl.hostname) {
                                linkType = 'Internal';
                            }
                        } catch (e) {
                            linkType = 'Internal';
                        }

                        let row = linksBody.insertRow();
                        let typeCell = row.insertCell();
                        let urlCell = row.insertCell();
                        let linkTextCell = row.insertCell(); // Add cell for link text
                        let statusCell = row.insertCell();

                        typeCell.innerText = linkType;
                        urlCell.innerHTML = `<a href="${href}" target="_blank" rel="noopener noreferrer">${href}</a>`;
                        linkTextCell.innerText = linkText; // Set the link text
                        statusCell.innerText = "Loading...";


                        if (href.startsWith('mailto:') || href.startsWith('wa.me/') || href.startsWith('tel:')) {
                            statusCell.innerText = "N/A";
                        } else {

                            linkPromises.push(
                                fetchStatusCode(href)
                                    .then(statusCode => {
                                        statusCell.innerText = statusCode;
                                    })
                                    .catch(error => {
                                        statusCell.innerText = "Error";
                                        console.error(`Failed to fetch status for ${href}:`, error);
                                    })
                            );
                        }
                    });

                    // Image Alt Text
                    const images = doc.querySelectorAll('img');
                    const imageAltBody = document.getElementById('image-alt-body');
                    images.forEach(image => {
                        let row = imageAltBody.insertRow();
                        let thumbCell = row.insertCell();
                        let urlCell = row.insertCell();
                        let altCell = row.insertCell();

                        thumbCell.innerHTML = `<img src="${image.src}" alt="Thumbnail" class="thumbnail">`;
                        urlCell.innerText = image.src;
                        altCell.innerText = image.alt;
                    });

                    // Google Tags
                    const googleTagsDiv = document.getElementById('google-tags');
                    let googleTags = [];

                    // Find gtag script tags
                    const gtagScriptTags = doc.querySelectorAll('script[src*="googletagmanager.com/gtag/js?id="]');
                    gtagScriptTags.forEach(scriptTag => {
                        const src = scriptTag.src;
                        const match = src.match(/id=([^&]*)/); // Extract the ID from the URL

                        if (match) {
                            const tagId = match[1];
                            if (tagId.length >= 8) { // Check the length
                                googleTags.push(tagId);
                            }
                        }
                    });

                    //Enhanced GTM Tag Detection
                    const gtmScriptTags = doc.querySelectorAll('script');
                    gtmScriptTags.forEach(scriptTag => {
                        const srcMatch = scriptTag.src && scriptTag.src.match(
                            /googletagmanager\.com\/gtm.js?id=([A-Z0-9-]+)/);
                        const inlineMatch = scriptTag.textContent && scriptTag.textContent.match(/GTM-[A-Z0-9]+/);

                        let tagId = null;

                        if (srcMatch) {
                            tagId = srcMatch[1];
                        } else if (inlineMatch) {
                            tagId = inlineMatch[0];
                        }

                        if (tagId && tagId.length >= 8 && !googleTags.includes(tagId)) {
                            googleTags.push(tagId);
                        }
                    });

                    // Find tags configured directly using gtag('config', 'TAG_ID');
                    const configTags = Array.from(doc.querySelectorAll('script'))
                        .map(script => script.textContent)
                        .join('\n'); //Combine all scripts content into 1 string
                    const configMatches = [...configTags.matchAll(
                        /gtag\(\'config\',\s*\'([A-Z0-9-]+)\'\)/g)];
                    configMatches.forEach(match => {
                        const tagId = match[1];
                        if (tagId.length >= 8 && !googleTags.includes(tagId)) { // Check the length and prevent duplicates
                            googleTags.push(tagId);
                        }
                    });

                    // Find Google Ads Conversion ID
                    const googleAdwordsConversionTags = Array.from(doc.querySelectorAll('script'))
                        .map(script => script.textContent)
                        .join('\n');
                    const googleAdwordsConversionMatches = [...googleAdwordsConversionTags.matchAll(/AW-[0-9]+/g)];
                    googleAdwordsConversionMatches.forEach(match => {
                        const tagId = match[0];
                        if (tagId.length >= 8 && !googleTags.includes(tagId)) { // Check the length and prevent duplicates
                            googleTags.push(tagId);
                        }
                    });



                    if (googleTags.length > 0) {
                        let tagListHTML = '<ul>';
                        googleTags.forEach(tag => {
                            tagListHTML += `<li style="word-break: break-all;">${tag}</li>`; // Apply word-break here
                        });
                        tagListHTML += '</ul>';
                        googleTagsDiv.innerHTML = `<p>Found Google Tags:</p>${tagListHTML}`;
                    } else {
                        googleTagsDiv.innerHTML = "<p>No Google Tags found.</p>";
                    }


                    // Wait for all status code fetches to complete.
                    Promise.all(linkPromises)
                        .then(() => resolve())
                        .catch(error => {
                            console.error("Error in displayResults", error);
                            reject(error);
                        });


                } catch (error) {
                    console.error("Error in displayResults", error);
                    reject(error);
                }
            });
        }

        function clearTables() {
            // Clear all tables
            document.getElementById('headers-body').innerHTML = '';
            document.getElementById('links-body').innerHTML = '';
            document.getElementById('image-alt-body').innerHTML = '';
            document.getElementById('meta-title').innerText = '';
            document.getElementById('meta-description').innerText = '';
            document.getElementById('canonical-tag').innerText = '';
            document.getElementById('visible-text').innerText = '';
            document.getElementById('ssl-info').innerText = '';
            document.getElementById('desktop-score').innerText = '';
            document.getElementById('mobile-score').innerText = '';
            document.getElementById('desktop-screenshot').innerHTML = '';
            document.getElementById('mobile-screenshot').innerHTML = '';
            document.getElementById('gtmetrix-grade').innerText = '';
            document.getElementById('gtmetrix-report').innerHTML = '';
            document.getElementById('google-tags').innerHTML = ''; //Clear google tags
            document.getElementById('website-crawler-body').innerHTML = ''; // Clear the website crawler table
            document.getElementById('webpage-formatting').innerHTML = ''; // Clear the webpage formatting section
        }

        async function exportToPdf() {
            window.jsPDF = window.jspdf.jsPDF;
            const {
                jsPDF
            } = window.jspdf;
            const pdf = new jsPDF();
            const elementIds = ['gtmetrix-results', 'google-tags', 'page-speed-table', 'meta-table', 'visible-text',
                'ssl-info',
                'headers-table', 'links-table', 'image-alt-table', 'website-crawler-table', 'webpage-formatting'
            ];

            let yOffset = 10;
            const xOffset = 10;
            const pageWidth = pdf.internal.pageSize.getWidth() - 20;

            for (const elementId of elementIds) {
                const element = document.getElementById(elementId);
                if (element) {
                    if (elementId === 'headers-table' || elementId === 'links-table' || elementId ===
                        'website-crawler-table') {
                        pdf.addPage();
                        yOffset = 10;
                    }

                    try {
                        const canvas = await html2canvas(element, {
                            scale: 2,
                            useCORS: true
                        });
                        const imgWidth = pageWidth;
                        const imgHeight = canvas.height * imgWidth / canvas.width;
                        if (yOffset + imgHeight > pdf.internal.pageSize.getHeight() - 10) {
                            pdf.addPage();
                            yOffset = 10;
                        }

                        const imgData = canvas.toDataURL('image/png');
                        pdf.addImage(imgData, 'PNG', xOffset, yOffset, imgWidth, imgHeight);
                        yOffset += imgHeight + 10;
                    } catch (error) {
                        console.error(`Error rendering element ${elementId}:`, error);
                    }
                }
            }

            pdf.save('uat.pdf');
            console.log('download function completed');
        }
    </script>
</body>

</html>