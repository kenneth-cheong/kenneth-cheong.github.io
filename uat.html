<!DOCTYPE html>
<html>

<head>
    <title>HTML Analyzer</title>
    <style>
        body {
            font-family: sans-serif;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            word-break: break-word;
        }

        th {
            background-color: #f2f2f2;
        }

        #loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        #error {
            color: red;
            margin-top: 10px;
            display: none;
        }

        .header-text {
            white-space: nowrap;
            /* Prevent wrapping */
            overflow: hidden;
            /* Hide overflowing text */
            text-overflow: ellipsis;
            /* Add ellipsis (...) for overflow */
            max-width: 300px;
        }

        .thumbnail {
            max-width: 100px;
            max-height: 100px;
            cursor: pointer;
        }

        .expanded-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .expanded-image img {
            max-width: 90%;
            max-height: 90%;
        }

        .hidden {
            display: none;
        }

        #google-tags ul {
            list-style-type: none;
            padding: 0;
        }

        #google-tags li {
            margin-bottom: 5px;
            /* Add some space between list items */
        }

        .page-break {
            page-break-before: always;
        }
    </style>
    <!-- jsPDF and html2pdf libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas library (required by jsPDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


</head>

<body>

    <h1>User Acceptance Test</h1>

    <label for="url">Enter URL:</label>
    <input type="url" id="url" name="url" size="50">
    <button onclick="analyzeURL()">Analyse</button>
    <button onclick="exportToPdf()">Export to PDF</button>

    <div id="loading">Loading...</div>
    <div id="error"></div>


    <h2>Results</h2>

    <h3>GTmetrix</h3>
    <div id="gtmetrix-results">
        <div id="gtmetrix-grade"></div>
        <div id="gtmetrix-report"></div>
    </div>

    <h3>Google Tags</h3>
    <div id="google-tags"></div>


    <h3>Page Speed Performance</h3>
    <table id="page-speed-table">
        <thead>
            <tr>
                <th>Strategy</th>
                <th>Performance Score</th>
                <th>Final Screenshot</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Desktop</td>
                <td id="desktop-score"></td>
                <td id="desktop-screenshot"></td>
            </tr>
            <tr>
                <td>Mobile</td>
                <td id="mobile-score"></td>
                <td id="mobile-screenshot"></td>
            </tr>
        </tbody>
    </table>

    <div id="expanded-image-container" class="expanded-image hidden">
        <img id="expanded-image" src="" alt="Expanded Screenshot">
    </div>

    <h3>Meta Information</h3>
    <table id="meta-table">
        <thead>
            <tr>
                <th>Property</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Meta Title</td>
                <td id="meta-title"></td>
            </tr>
            <tr>
                <td>Meta Description</td>
                <td id="meta-description"></td>
            </tr>
            <tr>
                <td>Canonical Tag</td>
                <td id="canonical-tag"></td>
            </tr>
        </tbody>
    </table>

    <h3>robots.txt</h3>
    <div id="visible-text"></div>

    <h3>SSL</h3>
    <div id="ssl-info"></div>

    <div class="page-break"></div> <!-- Page break before Headers -->
    <h3>Headers</h3>
    <table id="headers-table">
        <thead>
            <tr>
                <th>Header</th>
            </tr>
        </thead>
        <tbody id="headers-body">
        </tbody>
    </table>

    <div class="page-break"></div> <!-- Page break before Links -->
    <h3>Links</h3>
    <table id="links-table">
        <thead>
            <tr>
                <th>Link Type</th>
                <th>URL</th>
                <th>Link Text</th>
                <th>Status Code</th>
            </tr>
        </thead>
        <tbody id="links-body">
        </tbody>
    </table>


    <h3>Image Alt Text</h3>
    <table id="image-alt-table">
        <thead>
            <tr>
                <th>Thumbnail</th>
                <th>Image URL</th>
                <th>Alt Text</th>
            </tr>
        </thead>
        <tbody id="image-alt-body">
        </tbody>
    </table>

    <script>
        function showExpandedImage(base64Data) {
            const expandedImageContainer = document.getElementById('expanded-image-container');
            const expandedImage = document.getElementById('expanded-image');

            expandedImage.src = base64Data;
            expandedImageContainer.classList.remove('hidden');

            expandedImageContainer.onclick = function() {
                expandedImageContainer.classList.add('hidden');
                expandedImage.src = "";
            };
        }

        async function analyzeURL() {
            const url = document.getElementById('url').value;
            if (!url) {
                alert("Please enter a URL.");
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';

            let robotsPromise = null;

            try {
                // Extract domain
                let domain;
                try {
                    const urlObj = new URL(url);
                    domain = urlObj.origin;
                } catch (e) {
                    console.error("Invalid URL:", url, e);
                    document.getElementById('error').innerText = "Invalid URL.  Please enter a valid URL.";
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                    return;
                }

                // Start fetchRobots asynchronously
                robotsPromise = fetchRobots(domain);

                // Start checkSsl asynchronously
                const sslPromise = checkSsl(domain);


                // Fetch HTML content
                const htmlResponse = await fetch('https://abrhhnjp4m.execute-api.ap-southeast-1.amazonaws.com/getHtml', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url })
                });

                if (!htmlResponse.ok) {
                    throw new Error(`HTTP error fetching HTML! status: ${htmlResponse.status}`);
                }

                const htmlData = await htmlResponse.json();
                await displayResults(htmlData.body);

                // Await robotsPromise and update visible text
                try {
                    const visibleText = await robotsPromise;
                    document.getElementById('visible-text').innerText = visibleText;
                } catch (e) {
                    console.error("Error in fetchRobots:", e);
                    document.getElementById('error').innerText = "Error fetching robots.txt: " + e;
                    document.getElementById('error').style.display = 'block';
                }

                // Await sslPromise and update SSL info
                try {
                    const sslResult = await sslPromise;
                    document.getElementById('ssl-info').innerText = sslResult;
                } catch (e) {
                    console.error("Error in checkSsl:", e);
                    document.getElementById('error').innerText = "Error checking SSL: " + e;
                    document.getElementById('error').style.display = 'block';
                }

                // Check Page Speed
                await checkPageSpeed(url);

                // Check GTmetrix
                await checkGTmetrix(url);



            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').innerText = "An error occurred: " + error;
                document.getElementById('error').style.display = 'block';
                clearTables();
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }


        async function checkGTmetrix(url) {
            try {
                const response = await fetch('https://y5830908vh.execute-api.ap-southeast-1.amazonaws.com/gtmetrix', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error fetching GTmetrix data! Status: ${response.status}`);
                }

                const data = await response.json();
                const grade = data.body.data.attributes.gtmetrix_grade;
                const reportUrl = data.body.data.links.report_url;

                document.getElementById('gtmetrix-grade').innerText = `GTmetrix Grade: ${grade}`;
                document.getElementById('gtmetrix-report').innerHTML = `<a href="${reportUrl}" target="_blank">View GTmetrix Report</a>`;

            } catch (error) {
                console.error("Error checking GTmetrix:", error);
                document.getElementById('error').innerText = "Error checking GTmetrix: " + error;
                document.getElementById('error').style.display = 'block';
                document.getElementById('gtmetrix-grade').innerText = "Error fetching GTmetrix grade.";
                document.getElementById('gtmetrix-report').innerText = "";
            }
        }

        async function checkPageSpeed(url) {
            try {
                const desktopResponse = await fetch('https://olcgoflh75.execute-api.ap-southeast-1.amazonaws.com/pageSpeed', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url, strategy: 'desktop' })
                });

                const mobileResponse = await fetch('https://olcgoflh75.execute-api.ap-southeast-1.amazonaws.com/pageSpeed', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url, strategy: 'mobile' })
                });

                if (!desktopResponse.ok || !mobileResponse.ok) {
                    throw new Error(`HTTP error fetching PageSpeed Insights! Desktop Status: ${desktopResponse.status}, Mobile Status: ${mobileResponse.status}`);
                }

                const desktopData = await desktopResponse.json();
                const mobileData = await mobileResponse.json();

                const desktopScore = desktopData.lighthouseResult.categories.performance.score;
                const mobileScore = mobileData.lighthouseResult.categories.performance.score;
                const desktopScreenshotData = desktopData.lighthouseResult.audits['final-screenshot'].details.data;
                const mobileScreenshotData = mobileData.lighthouseResult.audits['final-screenshot'].details.data;

                document.getElementById('desktop-score').innerText = desktopScore;
                document.getElementById('mobile-score').innerText = mobileScore;

                // Display Thumbnails, making them clickable
                document.getElementById('desktop-screenshot').innerHTML = `<img src="${desktopScreenshotData}" alt="Desktop Screenshot" class="thumbnail" onclick="showExpandedImage('${desktopScreenshotData}')">`;
                document.getElementById('mobile-screenshot').innerHTML = `<img src="${mobileScreenshotData}" alt="Mobile Screenshot" class="thumbnail" onclick="showExpandedImage('${mobileScreenshotData}')">`;


            } catch (error) {
                console.error("Error checking Page Speed:", error);
                document.getElementById('error').innerText = "Error checking Page Speed: " + error;
                document.getElementById('error').style.display = 'block';
                document.getElementById('desktop-score').innerText = "Error";
                document.getElementById('mobile-score').innerText = "Error";
                document.getElementById('desktop-screenshot').innerText = "Error";
                document.getElementById('mobile-screenshot').innerText = "Error";

            }
        }


        async function checkSsl(url) {
            try {
                const response = await fetch('https://2kxt49bwp1.execute-api.ap-southeast-1.amazonaws.com/checkSsl', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url }
                    )
                });

                if (!response.ok) {
                    throw new Error(`HTTP error checking SSL! status: ${response.status}`);
                }

                const data = await response.json();
                return data.message;
            } catch (error) {
                console.error("Error checking SSL:", error);
                throw error;
            }
        }


        async function fetchRobots(domain) {
            const robotsUrl = domain + "/robots.txt";
            console.log(robotsUrl);
            try {
                const urlLibResponse = await fetch('https://1pfsx12au9.execute-api.ap-southeast-1.amazonaws.com/url_lib_lite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: robotsUrl })
                });

                if (!urlLibResponse.ok) {
                    throw new Error(`HTTP error fetching URL + robots.txt! status: ${urlLibResponse.status}`);
                }

                const urlLibData = await urlLibResponse.json();

                return urlLibData.body.visible_text;
            } catch (e) {
                console.error("Error in fetchRobots:", e);
                throw e;
            }

        }


        async function fetchStatusCode(url) {
            try {
                const response = await fetch('https://n0ge4xdang.execute-api.ap-southeast-1.amazonaws.com/getStatusCode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url })
                });

                if (!response.ok) {
                    return `Error: ${response.status}`;
                }

                const data = await response.json();
                return data.body;
            } catch (error) {
                console.error("Error fetching status code:", error);
                return "Error";
            }
        }

        async function displayResults(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Clear existing results
            clearTables();

            // Meta Information
            document.getElementById('meta-title').innerText = doc.querySelector('meta[name="title"]') ? doc.querySelector('meta[name="title"]').content : doc.title;
            document.getElementById('meta-description').innerText = doc.querySelector('meta[name="description"]') ? doc.querySelector('meta[name="description"]').content : "";
            document.getElementById('canonical-tag').innerText = doc.querySelector('link[rel="canonical"]') ? doc.querySelector('link[rel="canonical"]').href : "";


            // Headers (H1-H6)
            const headers = doc.querySelectorAll('h1, h2, h3, h4, h5, h6');
            const headersBody = document.getElementById('headers-body');
            headers.forEach(header => {
                let row = headersBody.insertRow();
                let cell = row.insertCell();
                // Remove whitespace and newlines
                const headerText = header.innerText.trim().replace(/\s+/g, ' ');
                cell.innerHTML = `<span class="header-text">${header.tagName}: ${headerText}</span>`;
            });


            // Links (Internal and External)
            const links = doc.querySelectorAll('a[href]');
            const linksBody = document.getElementById('links-body');
            const existingLinks = new Set();

            const linkPromises = [];

            links.forEach(async link => {
                const href = link.href;
                const linkText = link.innerText.trim(); // Extract link text and trim whitespace

                if (existingLinks.has(href)) {
                    return;
                }

                existingLinks.add(href);

                let linkType = 'External';
                try {
                    const url = new URL(href);
                    const currentUrl = new URL(document.getElementById('url').value);
                    if (url.hostname === currentUrl.hostname) {
                        linkType = 'Internal';
                    }
                } catch (e) {
                    linkType = 'Internal';
                }

                let row = linksBody.insertRow();
                let typeCell = row.insertCell();
                let urlCell = row.insertCell();
                let linkTextCell = row.insertCell(); // Add cell for link text
                let statusCell = row.insertCell();

                typeCell.innerText = linkType;
                urlCell.innerText = href;
                linkTextCell.innerText = linkText; // Set the link text
                statusCell.innerText = "Loading...";


                if (href.startsWith('mailto:') || href.startsWith('wa.me/') || href.startsWith('tel:')) {
                    statusCell.innerText = "N/A";
                } else {

                    linkPromises.push(
                        fetchStatusCode(href)
                            .then(statusCode => {
                                statusCell.innerText = statusCode;
                            })
                            .catch(error => {
                                statusCell.innerText = "Error";
                                console.error(`Failed to fetch status for ${href}:`, error);
                            })
                    );
                }
            });

            // Image Alt Text
            const images = doc.querySelectorAll('img');
            const imageAltBody = document.getElementById('image-alt-body');
            images.forEach(image => {
                let row = imageAltBody.insertRow();
                let thumbCell = row.insertCell();
                let urlCell = row.insertCell();
                let altCell = row.insertCell();

                thumbCell.innerHTML = `<img src="${image.src}" alt="Thumbnail" class="thumbnail">`;
                urlCell.innerText = image.src;
                altCell.innerText = image.alt;
            });

            // Google Tags
            const googleTagsDiv = document.getElementById('google-tags');
            let googleTags = [];

            // Find gtag script tags
            const gtagScriptTags = doc.querySelectorAll('script[src*="googletagmanager.com/gtag/js?id="]');
            gtagScriptTags.forEach(scriptTag => {
                const src = scriptTag.src;
                const match = src.match(/id=([^&]*)/);  // Extract the ID from the URL

                if (match) {
                    const tagId = match[1];
                    if (tagId.length >= 8) {  // Check the length
                        googleTags.push(tagId);
                    }
                }
            });

            //Enhanced GTM Tag Detection
            const gtmScriptTags = doc.querySelectorAll('script');
            gtmScriptTags.forEach(scriptTag => {
                const srcMatch = scriptTag.src && scriptTag.src.match(/googletagmanager\.com\/gtm\.js\?id=([A-Z0-9-]+)/);
                const inlineMatch = scriptTag.textContent && scriptTag.textContent.match(/GTM-[A-Z0-9]+/);

                let tagId = null;

                if (srcMatch) {
                    tagId = srcMatch[1];
                } else if (inlineMatch) {
                    tagId = inlineMatch[0];
                }

                if (tagId && tagId.length >= 8 && !googleTags.includes(tagId)) {
                    googleTags.push(tagId);
                }
            });

            // Find tags configured directly using gtag('config', 'TAG_ID');
            const configTags = Array.from(doc.querySelectorAll('script'))
                .map(script => script.textContent)
                .join('\n'); //Combine all scripts content into 1 string
            const configMatches = [...configTags.matchAll(/gtag\(\'config\',\s*\'([A-Z0-9-]+)\'\)/g)];
            configMatches.forEach(match => {
                const tagId = match[1];
                if (tagId.length >= 8 && !googleTags.includes(tagId)) {  // Check the length and prevent duplicates
                    googleTags.push(tagId);
                }
            });

            // Find Google Ads Conversion ID
            const googleAdwordsConversionTags = Array.from(doc.querySelectorAll('script'))
                .map(script => script.textContent)
                .join('\n');
            const googleAdwordsConversionMatches = [...googleAdwordsConversionTags.matchAll(/AW-[0-9]+/g)];
            googleAdwordsConversionMatches.forEach(match => {
                const tagId = match[0];
                if (tagId.length >= 8 && !googleTags.includes(tagId)) {  // Check the length and prevent duplicates
                    googleTags.push(tagId);
                }
            });



            if (googleTags.length > 0) {
                let tagListHTML = '<ul>';
                googleTags.forEach(tag => {
                    tagListHTML += `<li style="word-break: break-all;">${tag}</li>`; // Apply word-break here
                });
                tagListHTML += '</ul>';
                googleTagsDiv.innerHTML = `<p>Found Google Tags:</p>${tagListHTML}`;
            } else {
                googleTagsDiv.innerHTML = "<p>No Google Tags found.</p>";
            }


            // Wait for all status code fetches to complete.
            await Promise.all(linkPromises);

        }

        function clearTables() {
            // Clear all tables
            document.getElementById('headers-body').innerHTML = '';
            document.getElementById('links-body').innerHTML = '';
            document.getElementById('image-alt-body').innerHTML = '';
            document.getElementById('meta-title').innerText = '';
            document.getElementById('meta-description').innerText = '';
            document.getElementById('canonical-tag').innerText = '';
            document.getElementById('visible-text').innerText = '';
            document.getElementById('ssl-info').innerText = '';
            document.getElementById('desktop-score').innerText = '';
            document.getElementById('mobile-score').innerText = '';
            document.getElementById('desktop-screenshot').innerHTML = '';
            document.getElementById('mobile-screenshot').innerHTML = '';
            document.getElementById('gtmetrix-grade').innerText = '';
            document.getElementById('gtmetrix-report').innerHTML = '';
            document.getElementById('google-tags').innerHTML = ''; //Clear google tags
        }

        async function exportToPdf() {
            window.jsPDF = window.jspdf.jsPDF;
            // Import jsPDF library
            const { jsPDF } = window.jspdf;

            // Create a new jsPDF instance
            const pdf = new jsPDF();

            // Array of element IDs to include in the PDF
            const elementIds = [
                'page-speed-table', 'meta-table', 'visible-text', 'ssl-info',
                'headers-table', 'links-table', 'image-alt-table', 'gtmetrix-results', 'google-tags'
            ];

            let yOffset = 10; // Initial Y offset
            const xOffset = 10; // X offset for all elements
            const pageWidth = pdf.internal.pageSize.getWidth() - 20; // Page width minus margins

            for (const elementId of elementIds) {
                const element = document.getElementById(elementId);
                if (element) {
                    // Check if new page needed
                    if (elementId === 'headers-table' || elementId === 'links-table') {
                        pdf.addPage();  // Add a new page for headers and links
                        yOffset = 10; // Reset yOffset for the new page
                    }

                    try {
                        // Use html2canvas to render the element
                        const canvas = await html2canvas(element, {
                            scale: 2, // Increase scale for better resolution
                            useCORS: true
                        });

                        // Calculate image height to fit within the page
                        const imgWidth = pageWidth;
                        const imgHeight = canvas.height * imgWidth / canvas.width;

                        // Add the image to the PDF
                        if (yOffset + imgHeight > pdf.internal.pageSize.getHeight() - 10) {
                            pdf.addPage(); // Add new page if it overflows
                            yOffset = 10;  // Reset yOffset for the new page
                        }

                        const imgData = canvas.toDataURL('image/png');
                        pdf.addImage(imgData, 'PNG', xOffset, yOffset, imgWidth, imgHeight);
                        yOffset += imgHeight + 10; // Increase Y offset for the next element
                    } catch (error) {
                        console.error(`Error rendering element ${elementId}:`, error);
                    }
                }
            }

            // Save the PDF
            pdf.save('uat.pdf');
            console.log('download function completed');
        }

    </script>

</body>

</html>