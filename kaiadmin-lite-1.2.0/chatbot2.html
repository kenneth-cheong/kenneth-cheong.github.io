<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Digimetrics - New Look</title>
  <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />
  <link rel="icon"
    href="https://mediaonemarketing.com.sg/wp-content/uploads/2023/11/cropped-MediaOne-M-favicon-logo-32x32.png"
    type="image/x-icon" />

  <!-- Fonts and icons -->
  <script src="assets/js/plugin/webfont/webfont.min.js"></script>
  <script>
    WebFont.load({
      google: { families: ["Public Sans:300,400,500,600,700"] },
      custom: {
        families: [
          "Font Awesome 5 Solid",
          "Font Awesome 5 Regular",
          "Font Awesome 5 Brands",
          "simple-line-icons",
        ],
        urls: ["assets/css/fonts.min.css"],
      },
      active: function () {
        sessionStorage.fonts = true;
      },
    });
  </script>

  <!-- CSS Files -->
  <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/css/plugins.min.css" />
  <link rel="stylesheet" href="assets/css/kaiadmin.min.css" />

  <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
  <script src="assets/js/driver.js.iife.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@latest/dist/driver.css" />
</head>

<body>
  <div class="wrapper">
    <!-- Sidebar -->
    <div class="sidebar sidebar-style-2" data-background-color="dark">
      <div class="sidebar-logo">
        <!-- Logo Header -->
        <div class="logo-header" data-background-color="dark">
          <a href="#" class="logo">
            <img src="assets/img/kaiadmin/Digimetrics Logo-02.png" alt="navbar brand" class="navbar-brand"
              height="20" />
          </a>
          <div id="leftNav" class="nav-toggle">
            <button id="leftNavMinimise" class="btn btn-toggle toggle-sidebar">
              <i class="gg-menu-right"></i>
            </button>
            <button class="btn btn-toggle sidenav-toggler">
              <i class="gg-menu-left"></i>
            </button>
          </div>
          <button class="topbar-toggler more">
            <i class="gg-more-vertical-alt"></i>
          </button>
        </div>
        <!-- End Logo Header -->
      </div>
      <div class="sidebar-wrapper scrollbar scrollbar-inner">
        <div class="sidebar-content">
          <ul class="nav nav-secondary">
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#dashboard" class="collapsed" aria-expanded="false">
                <i class="fas fa-home"></i>
                <p>Dashboard</p>
                <span class="caret"></span>
              </a>
              <div class="collapse" id="dashboard">
                <ul class="nav nav-collapse">
                  <li>
                    <a href="">
                      <span class="sub-item">Dashboard 1</span>
                    </a>
                  </li>
                </ul>
              </div>
            </li>
            <li class="nav-section">
              <span class="sidebar-mini-icon">
                <i class="fa fa-ellipsis-h"></i>
              </span>
              <h4 class="text-section">Components</h4>
            </li>
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#base">
                <i class="fas fa-layer-group"></i>
                <p>SEO</p>
                <span class="caret"></span>
              </a>
              <div class="collapse" id="base">
                <ul class="nav nav-collapse">
                  <li>
                    <a href="">
                      <span class="sub-item">Keyword Analysis</span>
                    </a>
                  </li>
                  <li>
                    <a href="">
                      <span class="sub-item">Google Crawler Simulator</span>
                    </a>
                  </li>
                  <li>
                    <a href="">
                      <span class="sub-item">Website Technical Audit</span>
                    </a>
                  </li>
                  <li>
                    <a href="">
                      <span class="sub-item">Content Comparison</span>
                    </a>
                  </li>
                  <li>
                    <a href="">
                      <span class="sub-item">On-Page Recommendations</span>
                    </a>
                  </li>
                  <li>
                    <a href="#queriedKeywordsCard">
                      <span class="sub-item">Rank Checker</span>
                    </a>
                  </li>
                  <li>
                    <a href="#schemaGeneratorCard">
                      <span class="sub-item">Schema Generator</span>
                    </a>
                  </li>
                </ul>
              </div>
            </li>
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#maps">
                <i class="fas fa-audio-description"></i>
                <p>SEM</p>
                <span class="caret"></span>
              </a>
              <div class="collapse" id="maps">
                <ul class="nav nav-collapse">
                  <li>
                    <a href="#landingPageAuditCard">
                      <span class="sub-item">Landing Page Audit</span>
                    </a>
                  </li>
                  <li>
                    <a href="">
                      <span class="sub-item">Competitors' Ads</span>
                    </a>
                  </li>
                  <li>
                    <a href="#adsGeneratorCard">
                      <span class="sub-item">Ads Generator</span>
                    </a>
                  </li>
                  <li>
                    <a href="">
                      <span class="sub-item">Ads Research</span>
                    </a>
                  </li>
                </ul>
              </div>
            </li>
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#charts">
                <i class="fas fa-podcast"></i>
                <p>Social Media</p>
                <span class="caret"></span>
              </a>
              <div class="collapse" id="charts">
                <ul class="nav nav-collapse">
                  <li>
                    <a href="#personaGeneratorCard">
                      <span class="sub-item">Persona Generator</span>
                    </a>
                  </li>
                  <li>
                    <a href="#socialMediaGeneratorCard">
                      <span class="sub-item">Copy Generator</span>
                    </a>
                  </li>
                  <li>
                    <a href="#contentCheckerCard">
                      <span class="sub-item">Content Checker</span>
                    </a>
                  </li>
                </ul>
              </div>
            </li>
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#bd">
                <i class="fas fa-dollar-sign"></i>
                <p>BD</p>
                <span class="caret"></span>
              </a>
              <div class="collapse" id="bd">
                <ul class="nav nav-collapse">
                  <li>
                    <a href="#competitorsIdentifierCard">
                      <span class="sub-item">Competitors Identifier</span>
                    </a>
                  </li>
                  <li>
                    <a href="#mediaPlanCard">
                      <span class="sub-item">Media Plan Generator</span>
                    </a>
                  </li>
            </li>
          </ul>
        </div>
        </li>
        </ul>
      </div>
    </div>
  </div>
  <!-- End Sidebar -->

  <div class="main-panel">
    <div class="main-header">
      <div class="main-header-logo">
        <!-- Logo Header -->
        <div class="logo-header" data-background-color="dark">
          <a href="index.html" class="logo">
            <img src="assets/img/kaiadmin/logo_light.svg" alt="navbar brand" class="navbar-brand" height="20" />
          </a>
          <div class="nav-toggle">
            <button class="btn btn-toggle toggle-sidebar">
              <i class="gg-menu-right"></i>
            </button>
            <button class="btn btn-toggle sidenav-toggler">
              <i class="gg-menu-left"></i>
            </button>
          </div>
          <button class="topbar-toggler more">
            <i class="gg-more-vertical-alt"></i>
          </button>
        </div>
        <!-- End Logo Header -->
      </div>
      <!-- Navbar Header -->
      <nav class="navbar navbar-header navbar-header-transparent navbar-expand-lg border-bottom">
        <div class="container-fluid">

          <div class="collapse navbar-collapse" id="navbarNav">
            <div>
              <div style="margin: 10px" id="seoRow">
                <ul class="breadcrumbs mb-3" onclick="hideOtherLines('seoRow')">
                  <li class="nav-item">
                    <a href="#"> SEO</a>
                  </li>
                  <li class="separator">
                    <i class="icon-arrow-right"></i>
                  </li>
                  <li class="nav-item" id="keywordAnalysisFunctionExecuted">
                    <a href="#" style="font-weight:1000;"> Keyword Analysis</a>
                  </li>
                  <li class="separator">
                    <i class="icon-arrow-right"></i>
                  </li>
                  <li class="nav-item" id="rankCheckerFunctionExecuted">
                    <a href="#queriedKeywordsCard"> Rank Checker</a>
                  </li>
                  <li class="separator">
                    <i class="icon-arrow-right"></i>
                  </li>
                  <li class="nav-item">
                    <a href="#"> Content Comparison</a>
                  </li>
                  <li class="separator">
                    <i class="icon-arrow-right"></i>
                  </li>
                  <li class="nav-item">
                    <a href="#"> On-Page Recommendations</a>
                  </li>
                  <li class="separator">
                    <i class="icon-arrow-right"></i>
                  </li>
                  <li class="nav-item">
                    <a href="#schemaGeneratorCard"> Schema Generator</a>
                  </li>
                  <li class="separator">
                    <i class="icon-arrow-right"></i>
                  </li>
                  <li class="nav-item">
                    <a href="#"> Technical Audit</a>
                  </li>
                </ul>
              </div>
              <div style="margin: 10px" id="semRow">
                <ul class="breadcrumbs mb-3" onclick="hideOtherLines('semRow')">
                  <li class="nav-item">
                    <a href="#"> SEM</a>
                  </li>
                  <li class="separator">
                    <i class="icon-arrow-right"></i>
                  </li>
                  <li class="nav-item">
                    <a href="#landingPageAuditCard"> Landing Page Audit</a>
                  </li>
                  <li class="separator">
                    <i class="icon-arrow-right"></i>
                  </li>
                  <li class="nav-item">
                    <a href="#"> Competitors' Ads</a>
                  </li>
                  <li class="separator">
                    <i class="icon-arrow-right"></i>
                  </li>
                  <li class="nav-item">
                    <a href="#"> Ads Research</a>
                  </li>
                  <li class="separator">
                    <i class="icon-arrow-right"></i>
                  </li>
                  <li class="nav-item">
                    <a href="#adsGeneratorCard"> Ads Generator</a>
                  </li>
                </ul>
              </div>

              <div style="margin: 10px" id="smmRow">
                <ul class="breadcrumbs mb-3" onclick="hideOtherLines('smmRow')">
                  <li class="nav-item">
                    <a href="#"> Social Media</a>
                  </li>
                  <li class="separator">
                    <i class="icon-arrow-right"></i>
                  </li>
                  <li class="nav-item">
                    <a href="#personaGeneratorCard"> Persona Generator</a>
                  </li>
                  <li class="separator">
                    <i class="icon-arrow-right"></i>
                  </li>
                  <li class="nav-item">
                    <a href="#socialMediaGeneratorCard"> Content Generator</a>
                  </li>
                  <li class="separator">
                    <i class="icon-arrow-right"></i>
                  </li>
                  <li class="nav-item">
                    <a href="#contentCheckerCard"> Content Checker</a>
                  </li>
                </ul>
              </div>

              <div style="margin: 10px" id="bdRow">
                <ul class="breadcrumbs mb-3" onclick="hideOtherLines('bdRow')">
                  <li class="nav-item">
                    <a href="#"> BD</a>
                  </li>
                  <li class="separator">
                    <i class="icon-arrow-right"></i>
                  </li>
                  <li class="nav-item">
                    <a href="#competitorsIdentifierCard"> Competitors Identifier</a>
                  </li>
                  <li class="separator">
                    <i class="icon-arrow-right"></i>
                  </li>
                  <li class="nav-item">
                    <a href="#mediaPlanCard"> Media Plan</a>
                  </li>
                </ul>
              </div>
            </div>
            <!-- Collapse Button -->
          </div>
          <div class="timeline-badge info" style="border-radius: 5px 0 0 5px">
            <button type="button" class="btn btn-icon btn-round btn-info" id="mascotBtn"
              style="border:none; background-color: transparent;" onclick="launchDriver(navigation_steps)">
              <i class="fas fa-question"></i>
              <!--  <img src="assets/img/mascot.png" style="width:50px;" alt="Button Image"> -->
            </button>
          </div>
          <button id="topNavToggler" class="navbar-toggler" style="display:block; border-radius: 0 5px 5px 0;"
            type="button" onclick="toggleRows()">
            <span class="navbar-toggler-icon"></span>
          </button>
        </div>
      </nav>
      <!-- End Navbar -->
    </div>



    <style>
      .containerForMapping {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
      }

      .list-container {
        width: 300px;
        margin: 10px;
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .keyword-list {
        list-style: none;
        padding: 0;
        margin: 0;
        min-height: 200px;
        /* Starting height */
      }

      .keyword-list li {
        background-color: #eee;
        border: 1px solid #ddd;
        padding: 8px 12px;
        margin: 10px;
        cursor: grab;
        border-radius: 20px;
        user-select: none;
      }

      .keyword-list li:hover {
        background-color: #ddd;
      }

      .keyword-list.drag-over {
        background-color: #f9f9f9;
        border: 2px dashed #aaa;
      }

      .rotate {
        animation: rotate-clockwise-animation 2s linear infinite;
        display: inline-block;
        /* Important for transform to work */
      }

      .collapsible50 {
        border-radius: 20px;
        background: rgba(222, 222, 222, .4);
        color: #585c5d;
        margin-top: 5px;
        margin-bottom: 5px;
        padding: 10px 20px;
        border: none;
        margin: 5px;
      }

      .collapsible50:active {
        background: #6861ce;
        color: white;
      }

      .time-to-rank-0-3 {
        background-color: #c6efc6;
        /* Example: Light green */
      }

      .time-to-rank-3-6 {
        background-color: #9bd3ae;
        /* Example: Medium green */
      }

      .time-to-rank-6-9 {
        background-color: #ffda66;
        /* Example: Yellow */
      }

      .time-to-rank-9-12 {
        background-color: #fbb668;
        /* Example: Orange */
      }

      .time-to-rank-more-than-12 {
        background-color: #f4746b;
        /* Example: Red */
      }

      #schema-output {
        white-space: pre-wrap;
        border: 1px solid #ccc;
        padding: 10px;
        font-family: monospace;
      }

      .gauge {
        width: 100%;
        max-width: 250px;
        font-family: "Roboto", sans-serif;
        font-size: 18px;
        font-weight: bolder;
        color: #686868;
      }

      .gauge__body {
        width: 100%;
        height: 0;
        padding-bottom: 50%;
        background: linear-gradient(90deg, rgba(253, 29, 29, 1) 0%, rgb(245, 229, 0) 50%, rgba(33, 255, 68, 1) 100%);
        position: relative;
        border-top-left-radius: 100% 200%;
        border-top-right-radius: 100% 200%;
        overflow: hidden;
      }

      .gauge__fill {
        position: absolute;
        top: 100%;
        left: 0;
        width: inherit;
        height: 100%;
        transform-origin: center top;
        transform: rotate(0.25turn);
        transition: transform 0.2s ease-out;
        border: 2.5px solid #5d5d5d;
        /* Solid border for a more defined outline */
      }

      .gauge__cover {
        width: 75%;
        height: 150%;
        background: white;
        border-radius: 50%;
        position: absolute;
        top: 25%;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding-bottom: 25%;
        box-sizing: border-box;
        text-align: center;
      }

      .funnel-container {
        width: 90%;
        margin: 20px auto;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .funnel-collapsible-before {
        color: white;
        cursor: pointer;
        padding: 20px;
        width: 100%;
        border: none;
        text-align: center;
        outline: none;
        transition: background-color 0.8s ease;
        border-radius: 10px;
        font-size: 1em;
        box-sizing: border-box;
        margin-bottom: 10px;
      }

      .funnel-collapsible {
        color: white;
        cursor: pointer;
        padding: 20px;
        width: 100%;
        border: none;
        text-align: center;
        outline: none;
        transition: background-color 0.8s ease;
        border-radius: 10px;
        font-size: 1em;
        box-sizing: border-box;
        margin: 0px;
      }

      .funnel-content {
        width: 100%;
        display: block;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 10px;
        box-sizing: border-box;
      }

      .diagonal-table {
        border-collapse: collapse;
        width: auto;
      }

      .diagonal-table th,
      .diagonal-table td {
        border: 1px solid black;
        text-align: center;
      }

      .diagonal-table th {
        position: relative;
        height: 100px;
      }

      .diagonal-table th span {
        left: 0px;
        bottom: 0px;
        position: absolute;
        width: 300px;
        height: 20px;
        line-height: 20px;
        text-align: left;
        transform-origin: 0 0;
        transform: rotate(-85deg) translate(0px, 0px);
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        font-size: 0.8em;
      }

      .tooltip {
        position: relative;
        display: inline-block;
        z-index: 1;
      }

      .tooltip span {
        position: absolute;
        transform: translateX(-50%);
        transform: translateY(20%);
        min-width: 200px;
        max-width: 500px;
        padding: 10px;
        background-color: rgba(0, 0, 0, 0.796);
        color: #fff;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
        border-radius: 15px;
        font-size: 0.9em;
      }

      .tooltip:hover span {
        opacity: 1;
        visibility: visible;
      }

      #serpTable {
        width: 100%;
        table-layout: fixed;
      }

      #serpTable th:nth-child(1),
      #serrpTable td:nth-child(1) {
        width: 15%;
      }

      #serpTable th:nth-child(2),
      #serrpTable td:nth-child(2) {
        width: 30%;
      }

      #serpTable th:nth-child(3),
      #serrpTable td:nth-child(3) {
        width: 20%;
      }

      #serpTable th:nth-child(4),
      #serrpTable td:nth-child(4) {
        width: 20%;
      }

      #chatbot-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1001;
        /* Lower z-index than feedback modal */
        width: 60%;
        border: 5px solid #bababa;
        height: 80%;
      }

      #chat-messages {
        overflow-y: scroll;
        margin-bottom: 10px;
        padding: 10px;
        height: 80%;
      }

      .message {
        padding: 8px 12px;
        border-radius: 20px;
        margin-bottom: 8px;
        clear: both;
        /* Prevents floating issues */
        max-width: 70%;
        /* Limits bubble width */
        word-wrap: break-word;
        /* Long words don't break the layout */
      }

      .user {
        background-color: #DCF8C6;
        /* Light green for user */
        float: right;
        /* Align user messages to the right */
      }

      .chatbot {
        background-color: #ECE5DD;
        /* Light gray for chatbot */
        float: left;
        /* Align chatbot messages to the left */
      }

      #question-input {
        flex-grow: 1;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ccc;
        min-width: 70%;
      }

      .collapsible-icon {
        margin-right: 5px;
        /* Changed from margin-left to margin-right */
        cursor: pointer;
        /*  Change cursor on hover */
        font-size: larger;
        /* Adjust size of the icon as needed */
        transition: transform 0.2s ease-in-out;
        /* Smooth animation when changing */
      }

      .collapsible-icon.open {
        transform: rotate(45deg);
        /* Rotate to become a "x" sign when open */
      }

      .feedback-modal {
        display: none;
        /* Hidden by default */
        position: fixed;
        /* Stay in place */
        z-index: 1001;
        /* Sit on top */
        left: 0;
        top: 0;
        width: 100%;
        /* Full width */
        height: 100%;
        /* Full height */
        overflow: auto;
        /* Enable scroll if needed */
        background-color: rgb(0, 0, 0);
        /* Fallback color */
        background-color: rgba(0, 0, 0, 0.4);
        /* Black w/ opacity */
      }

       body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .chat-container {
            width: 95%;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 700px;
            margin: 0 auto;
            resize: both;
            /* Allow resizing both horizontally and vertically */
            overflow: auto;
            /* Ensures content doesn't overflow when resized */
            cursor: se-resize;
            /* Cursor shows as a resize handle */
        }

        .chat-header {
            background-color: #007bff;
            color: #fff;
            padding: 20px;
            text-align: center;
        }

        .chat-messages {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .chat-input {
            padding: 10px;
            background-color: #f9f9f9;
            border-top: 1px solid #eee;
            display: flex;
        }

        @media (max-width: 768px) {
            .chat-container {
                width: 95%;
                /* Make container take 95% of the screen width on smaller screens */
                height: auto;
                /* Allow height to adjust based on content */
            }

            .chat-header {
                padding: 15px;
                /* Adjust header padding for smaller screens */
            }

            .chat-input {
                padding: 8px;
                /* Reduce padding for chat input on smaller screens */
            }

            .chat-input input[type="text"] {
                padding: 8px;
                /* Reduce padding for text input */
            }

            .chat-input button {
                padding: 8px 12px;
                /* Adjust padding for button */
            }

            .message {
                padding: 8px;
                /* Reduce padding in messages */
                font-size: 14px;
                /* Smaller font size for messages */
            }
        }




        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            clear: both;
        }

        .message.user {
            background-color: #dcdefc;
            float: right;
        }

        .message.bot {
            background-color: #f0f0f0;
            float: left;
        }

        .chat-input input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
        }

        .chat-input button {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Style for the typing indicator */
        .typing-indicator {
            text-align: left;
            padding: 5px 10px;
            font-style: italic;
            color: #888;
            animation: fadeInOut 2s infinite;
            /* Apply fade in/out animation */
        }

        /* Create the fade-in and fade-out animation */
        @keyframes fadeInOut {

            0%,
            100% {
                opacity: 0;
                /* Start and end as invisible */
            }

            50% {
                opacity: 1;
                /* Make it fully visible at the middle of the cycle */
            }
        }

        .typing-indicator {
            text-align: left;
            padding: 5px 10px;
            font-style: italic;
            color: #888;
            animation: blink 2s infinite step-end;
            /* Apply blinking effect */
        }

        /* Create the blinking animation */
        @keyframes blink {

            0%,
            100% {
                opacity: 0;
                /* Make it invisible at the start and end */
            }

            50% {
                opacity: 1;
                /* Make it visible at the middle of the cycle */
            }
        }

        .chat-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 10px;
        }

        .chat-options button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .chat-options button:hover {
            background-color: #0056b3;
        }

        /* Adjust button container within the message bubble */
        .button-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding: 10px;
        }


      @keyframes rotate-clockwise-animation {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }
    </style>

    <div class="container">
      <div class="page-inner">
        
         <div class="chat-container">
        <div class="chat-header">
            <h2>Chatbot</h2>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="chat-options" id="chat-options" style="display: none;"></div>
        </div>
        <div class="typing-indicator" id="typing-indicator"></div>
        <div class="chat-input">
            <input type="text" id="message-input" placeholder="Type your message...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>


        </div>
      </div>

    </div>
  </div>
  <script id="local-business-template" type="text/x-handlebars-template">
      <label for="name">Name:</label><input type="text"  class="form-control" id="name" oninput="updateSchema()"><br>
      <label for="address">Address:</label><input type="text" class="form-control"  id="address" oninput="updateSchema()"><br>
      <label for="telephone">Telephone:</label><input type="text" class="form-control" id="telephone" oninput="updateSchema()"><br>
    </script>

  <script id="product-template" type="text/x-handlebars-template">
        <label for="name">Name:</label><input type="text"  class="form-control" id="name" oninput="updateSchema()"><br>
        <label for="description">Description:</label><input type="text" class="form-control"  id="description" oninput="updateSchema()"><br>
        <label for="brand">Brand:</label><input type="text" class="form-control"  id="brand" oninput="updateSchema()"><br>
    </script>

  <script id="event-template" type="text/x-handlebars-template">
        <label for="name">Name:</label><input type="text" class="form-control"  id="name" oninput="updateSchema()"><br>
        <label for="startDate">Start Date:</label><input type="date" class="form-control"  id="startDate" oninput="updateSchema()"><br>
        <label for="location">Location:</label><input type="text" class="form-control"  id="location" oninput="updateSchema()"><br>
        <label for="description">Description:</label><textarea  class="form-control" id="description" oninput="updateSchema()"></textarea><br>
    </script>

  <script id="article-template" type="text/x-handlebars-template">
        <label for="headline">Headline:</label><input type="text" class="form-control"  id="headline" oninput="updateSchema()"><br>
        <label for="author">Author:</label><input type="text" class="form-control"  id="author" oninput="updateSchema()"><br>
        <label for="datePublished">Date Published:</label><input type="date" class="form-control"  id="datePublished" oninput="updateSchema()"><br>
        <label for="articleBody">Article Body:</label><textarea class="form-control"  id="articleBody" oninput="updateSchema()"></textarea><br>
    </script>

  <script id="breadcrumblist-template" type="text/x-handlebars-template">
      <div id="breadcrumb-items">
          <div class="breadcrumb-item">
              <input type="text" class="form-control" id="name1" placeholder="Page #1's name" oninput="updateSchema()">
              <input type="url" class="form-control" id="url1" placeholder="URL #1" oninput="updateSchema()">
              <button class="btn btn-icon btn-round btn-danger"  style="margin: 5px 0 20px 0;" onclick="removeItem(this)">x</button>
          </div>
          <div class="breadcrumb-item">
              <input type="text" class="form-control" id="name2" placeholder="Page #2's name" oninput="updateSchema()">
              <input type="url" class="form-control" id="url2" placeholder="URL #2" oninput="updateSchema()">
               <button class="btn btn-icon btn-round btn-danger" style="margin: 5px 0 20px 0;"  onclick="removeItem(this)">x</button>
          </div>
      </div>
      <button class="btn btn-primary"  style="margin: 5px 0 20px 0;" onclick="addItem()"> + ADD URL </button>
  
    </script>

  <script id="faqpage-template" type="text/x-handlebars-template">
        <div id="faq-items">
            <div class="faq-item">
                <input type="text"  class="form-control" id="question1" placeholder="Question #1" oninput="updateSchema()">
                <textarea class="form-control"  id="answer1" placeholder="Answer" oninput="updateSchema()"></textarea>
                <button class="btn btn-icon btn-round btn-danger" onclick="removeFaqItem(this)">x</button> <br>
            </div>
        </div>
        <button class="btn btn-secondary" style="margin: 5px 0 20px 0;" onclick="addFaqItem()">+ ADD QUESTION</button>
    </script>
  <script id="howto-template" type="text/x-handlebars-template">
        <label for="name">Name:</label><input type="text"  class="form-control" id="name" oninput="updateSchema()"><br>
        <label for="description">Description:</label><textarea  class="form-control" id="description" oninput="updateSchema()"></textarea><br>
        <label for="supply">Supply (JSON-LD array of HowToSupply objects):</label><textarea class="form-control"  id="supply" class="json-ld" oninput="updateSchema()"></textarea><br>
        <label for="step">Steps (JSON-LD array of HowToStep objects):</label><textarea class="form-control"  id="step" class="json-ld" oninput="updateSchema()"></textarea><br>
        * See schema.org/HowTo for details on HowToSupply and HowToStep structure.
      </script>

  <script id="jobposting-template" type="text/x-handlebars-template">
        <label for="title">Job Title:</label><input type="text"  class="form-control" id="title" oninput="updateSchema()"><br>
        <label for="description">Job Description:</label><textarea class="form-control"  id="description" oninput="updateSchema()"></textarea><br>
        <label for="datePosted">Date Posted:</label><input type="date"  class="form-control" id="datePosted" oninput="updateSchema()"><br>
        <label for="employmentType">Employment Type:</label><input type="text" class="form-control"  id="employmentType" oninput="updateSchema()"><br>
        <label for="hiringOrganization">Hiring Organization (Name):</label><input type="text" class="form-control"  id="hiringOrganization_name" oninput="updateSchema()"><br>
       <label for="hiringOrganization">Hiring Organization (Website):</label><input type="url"  class="form-control" id="hiringOrganization_sameAs" oninput="updateSchema()"><br>
      </script>


  <script id="organization-template" type="text/x-handlebars-template">
        <label for="name">Name:</label><input type="text"  class="form-control" id="name" oninput="updateSchema()"><br>
        <label for="url">URL:</label><input type="url"  class="form-control" id="url" oninput="updateSchema()"><br>
        <label for="logo">Logo URL:</label><input type="url" id="logo" oninput="updateSchema()"><br>
      </script>

  <script id="person-template" type="text/x-handlebars-template">
        <label for="name">Name:</label><input type="text" class="form-control"  id="name" oninput="updateSchema()"><br>
        <label for="jobTitle">Job Title:</label><input type="text"  class="form-control" id="jobTitle" oninput="updateSchema()"><br>
      
      </script>


  <script id="video-object-template" type="text/x-handlebars-template">
          <label for="name">Name:</label><input type="text"  class="form-control" id="name" oninput="updateSchema()"><br>
          <label for="description">Description:</label><input type="text"  class="form-control" id="description" oninput="updateSchema()"><br>
          <label for="uploadDate">Upload Date:</label><input type="date" class="form-control"  id="uploadDate" oninput="updateSchema()"><br>
          <label for="thumbnailUrl">Thumbnail URL:</label><input type="url"  class="form-control" id="thumbnailUrl" oninput="updateSchema()"><br>
      </script>

  <script id="website-template" type="text/x-handlebars-template">
          <label for="name">Name:</label><input type="text"  class="form-control" id="name" oninput="updateSchema()"><br>
          <label for="url">URL:</label><input type="url" class="form-control" id="url" oninput="updateSchema()"><br>
      </script>

  <script>
    let keywordMetrics = {};
    let keywordMapping = {};
    //let rowsHidden = false; 

    function launchDriver(steps) {
      const driverObj = driver({
        showProgress: false,
        steps: steps,
        onDestroyStarted: () => {
          removeMockData();
          driverObj.destroy();
        }
      });

      driverObj.drive();
    }

    localStorage.setItem('input_messages',[]);
    questionInput = document.getElementById('question-input').value.trim();
    localStorage.setItem('question',questionInput);

    const chatMessages = document.getElementById('chat-messages');

    async function sendBackToGpt() {
      input_messages = localStorage.getItem('input_messages')
      question = localStorage.getItem('question');
      if (question !== '') {
        addMessage('user', question);
        +                    addMessage('chatbot', 'getting an answer...'); // Display "getting an answer..."
        question = '';
        try {
          const response = await fetch('https://8q9qwp4ytd.execute-api.ap-southeast-1.amazonaws.com/gptResponses2', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              'question': localStorage.getItem('question'),
              'previous_response_id': document.getElementById('previous-response-id').innerText || "",
              'input_messages': localStorage.getItem('input_messages')
            })
          });
          + chatMessages.lastChild.remove(); // Remove "getting an answer..."
          const data = await response.json();
          console.log(data);

          if (Array.isArray(data['functions'])) {
            processData(data);
            //addMessage('chatbot', function_result);
          } else {
            addMessage('chatbot', data.answer);
            document.getElementById('previous-response-id').innerText = data.response_id;
            //logConversation(question, data.answer, "-", "-", document.getElementById('threadId').innerText);
          }
        } catch (error) {
          console.error('Error:', error);
          addMessage('chatbot', 'Sorry, I could not process your request.');
        }
      }
    }

    function addMessage(sender, message, question = null) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', sender);
      messageDiv.innerHTML = message;

      // Add the "Give Feedback" button *only* to chatbot messages
      if (sender === 'chatbot') {
        const feedbackButton = document.createElement('button');
        feedbackButton.textContent = 'Feedback';
        feedbackButton.classList.add('btn-secondary');
        feedbackButton.classList.add('btn'); // Add a class for styling
        feedbackButton.addEventListener('click', () => {
          // Get the current message element
          const currentMessageDiv = feedbackButton.parentNode; // The parent is the messageDiv

          // Find the previous element (if it exists)
          let previousElement = currentMessageDiv.previousElementSibling;

          let questionText = "";

          if (previousElement) {
            questionText = previousElement.textContent;

          } else {
            console.warn("No previous element found.  Using empty string for questionText.");
          }

          openFeedbackModal(questionText, message);
        });

        //console.log(document.getElementById('chat-messages').textContent);
        messageDiv.innerHTML = messageDiv.innerHTML + "<br>";
        if (message != 'Hello ' + JSON.parse(localStorage.getItem('googleUser')).name.split(' ')[0] + ', how can I help you today?') {
          messageDiv.appendChild(feedbackButton);
        }
      }

      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function processData(data) {
      input_messages = data['input_messages'];
      console.log(data['output']);
      data['output'].forEach(func => {
        console.log(func);
        if (func['type'] == "function_call") {
          input_messages.push(func);
        }
      });

      for (const item in data['functions']) {
        try {
          function_result = await call_function(data['functions'][item][0], data['functions'][item][1]);
          console.log(`Result for ${data['functions'][item][0]}:`, function_result); // Added a label to the output
          addMessage('chatbot', JSON.stringify(function_result.body));
          input_messages.push({
            "type": "function_call_output",
            "call_id": data['functions'][item][2],
            "output": JSON.stringify(function_result)
          });
        } catch (error) {
          console.error(`Error processing ${data['functions'][item][0]}:`, error); // More informative error message
        }
      }

      final_output = await sendBackToGpt(input_messages);

      addMessage('chatbot', final_output, '');

    }

     async function call_function(name, args) {
        switch (name) {
          case "get_serps":
            return await get_serps(args.keyword, args.language, args.location);
          case "rank_checker":
            return await rank_checker(args.keyword, args.language, args.location, args.target);
          case "moz":
            return await moz(args.domain);
          case "keyword_metrics":
            return await keyword_metrics(args.keywords, args.location, args.language);
          case "scrape_webpage":
            return await scrape_webpage(args.url);
          case "ranking_keywords":
            return await ranking_keywords(args.target, args.location);
          case "similar_keywords":
            return await similar_keywords(args.keywords, args.language, args.location);
          case "keywords_for_site":
            return await keywords_for_site(args.target, args.language, args.location);
          default:
            throw new Error(`Function ${name} not found`);
        }
      }
    
    async function get_serps(keyword, language, location) {
        const url = "https://8k6r15rg4m.execute-api.ap-southeast-1.amazonaws.com/serpLite";
        const payload = {
          'keyword': keyword,
          'language': language,
          'location': location
        };
        const headers = {
          'Content-Type': 'application/json'
        };

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error in get_serps:", error);
          throw error; // Re-throw to allow handling further up the call stack
        }
      }


      async function rank_checker(keyword, language, location, target) {
        const url = "https://v5bizygr4m.execute-api.ap-southeast-1.amazonaws.com/rankChecker";
        const payload = {
          'keyword': keyword,
          'language': language,
          'location': location,
          'target': target
        };
        const headers = {
          'Content-Type': 'application/json'
        };

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error in rank_checker:", error);
          throw error;
        }
      }

      async function moz(domain) {
        const url = "https://a7hptjtc8e.execute-api.ap-southeast-1.amazonaws.com/new";
        const payload = {
          'domain': domain
        };
        const headers = {
          'Content-Type': 'application/json'
        };

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error in moz:", error);
          throw error;
        }
      }

      async function keyword_metrics(keywords, location, language) {
        const url = "https://eo2ckwvxmf.execute-api.ap-southeast-1.amazonaws.com/keywordMetrics";
        const payload = {
          'keywords': keywords,
          'language': language,
          'location': location
        };
        const headers = {
          'Content-Type': 'application/json'
        };

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error in keyword_metrics:", error);
          throw error;
        }
      }

      async function scrape_webpage(target_url) {
        const url = "https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing";
        const payload = {
          'url': target_url
        };
        const headers = {
          'Content-Type': 'application/json'
        };

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error in scrape_webpage:", error);
          throw error;
        }
      }

      async function ranking_keywords(target, location) {
        const url = "https://0dqny7l5y9.execute-api.ap-southeast-1.amazonaws.com/rankingKeywords";
        const payload = {
          'target': target,
          'location': location
        };
        const headers = {
          'Content-Type': 'application/json'
        };

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error in ranking_keywords:", error);
          throw error;
        }
      }

      async function similar_keywords(keywords, language, location) {
        const url = "https://lgvdhcs4t2.execute-api.ap-southeast-1.amazonaws.com/similarKeywords";
        const payload = {
          'keywords': keywords,
          'location': location,
          'language': language
        };
        const headers = {
          'Content-Type': 'application/json'
        };

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error in similar_keywords:", error);
          throw error;
        }
      }

      async function keywords_for_site(target_url, language, location) {
        const url = "https://ei6xj9x2rd.execute-api.ap-southeast-1.amazonaws.com/keywordsForSite";
        const payload = {
          'target': target_url,
          'location': location,
          'language': language
        };
        const headers = {
          'Content-Type': 'application/json'
        };

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error in keywords_for_site:", error);
          throw error;
        }
      }

    function toggleRows() {
      const seoRow = document.getElementById('seoRow');
      const semRow = document.getElementById('semRow');
      const smmRow = document.getElementById('smmRow');
      const bdRow = document.getElementById('bdRow');

      //console.log(window.getComputedStyle(seoRow).getPropertyValue("display"));

      if (window.getComputedStyle(seoRow).getPropertyValue("display") === "block" && window.getComputedStyle(semRow).getPropertyValue("display") === "block" && window.getComputedStyle(smmRow).getPropertyValue("display") === "block" && window.getComputedStyle(bdRow).getPropertyValue("display") === "block") {
        target = localStorage.getItem('targetRow');
        seoRow.style.display = "none";
        semRow.style.display = "none";
        smmRow.style.display = "none";
        bdRow.style.display = "none";
        document.getElementById(target).style.display = "block";
      } else {
        if (window.getComputedStyle(seoRow).getPropertyValue("display") === "block" && window.getComputedStyle(semRow).getPropertyValue("display") === "none") {
          target = "seoRow";
          seoRow.style.display = "block";
          semRow.style.display = "block";
          smmRow.style.display = "block";
          bdRow.style.display = "block";
        } else if (window.getComputedStyle(semRow).getPropertyValue("display") === "block" && window.getComputedStyle(seoRow).getPropertyValue("display") === "none") {
          target = "semRow";
          seoRow.style.display = "block";
          semRow.style.display = "block";
          smmRow.style.display = "block";
          bdRow.style.display = "block";
        } else if (window.getComputedStyle(smmRow).getPropertyValue("display") === "block" && window.getComputedStyle(bdRow).getPropertyValue("display") === "none") {
          target = "smmRow";
          seoRow.style.display = "block";
          semRow.style.display = "block";
          smmRow.style.display = "block";
          bdRow.style.display = "block";
        } else if (window.getComputedStyle(bdRow).getPropertyValue("display") === "block" && window.getComputedStyle(smmRow).getPropertyValue("display") === "none") {
          target = "bdRow";
          seoRow.style.display = "block";
          semRow.style.display = "block";
          smmRow.style.display = "block";
          bdRow.style.display = "block";
        }
        localStorage.setItem('targetRow', target);
      }
    }


    document.addEventListener('DOMContentLoaded', function () {
      toggleRows();
      localStorage.setItem('targetRow', "seoRow");
      const textarea = document.getElementById('keyword_analysis_keywords');
      if (textarea) {
        textarea.addEventListener('input', updateKeywordCount);
        updateKeywordCount(); // Initial count
      } else {
        console.warn('Textarea with ID "keyword_analysis_keywords" not found.');
      }
    });

    function clearKeywordAnalysis() {

    }

    async function serpModal(keyword) {
      const country = document.getElementById('keywordAnalysisCountry').value;
      const language = document.getElementById('keywordAnalysisLanguage').value;
      user = "kenneth@mediaone.co";
      const response = await fetch('https://8k6r15rg4m.execute-api.ap-southeast-1.amazonaws.com/serpLite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ keyword, language, location: country }),
      });
      const serpData = await response.json();

      document.getElementById('serpHeader').textContent = 'SERP for ' + keyword;

      if (!keywordMetrics[keyword]) {
        keywordMetrics[keyword] = {};
      }
      keywordMetrics[keyword]['serp'] = serpData.body;

      await populateSerpTable(serpData.body); // Added await here
    }

    async function populateSerpTable(keywords) {
      const tableBody = document.querySelector("#serpTable tbody");

      //Clear existing table rows
      tableBody.innerHTML = "";

      const serpArray = Object.entries(keywords).map(([rank, data]) => ({
        rank: rank,
        url: data.url,
        title: data.title,
        description: data.description
      }));

      //Iterate through the keywords and create table rows
      for (const rank of serpArray) { // Changed forEach to a for...of loop to use await
        const row = tableBody.insertRow();
        const rankCell = row.insertCell();
        const urlCell = row.insertCell();
        const titleCell = row.insertCell();
        const descriptionCell = row.insertCell();
        const daCell = row.insertCell(); // added DA cell

        rankCell.textContent = rank.rank;
        urlCell.textContent = rank.url;
        titleCell.textContent = rank.title;
        descriptionCell.textContent = rank.description;

        try {
          const daData = await fetchDA(rank.url);
          daCell.textContent = daData.DA || "Error"; // Added DA value or "Error" if there's an error

        } catch (error) {
          console.error("Error fetching DA for", rank.url, error);
          daCell.textContent = "Error"; // Display "Error" in DA cell if fetchDA fails
        }
      }

      makeTableSortable('serpTable');
      document.getElementById('serpCard').style.display = "block";
    }

    async function fetchDA(domain) { // for moz
      try {
        // Extract the domain name from the URL
        const urlObject = new URL(domain);
        const hostname = urlObject.hostname;

        const response = await fetch('https://a7hptjtc8e.execute-api.ap-southeast-1.amazonaws.com/new', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ domain: hostname }) // Send hostname
        });

        if (!response.ok) {
          throw new Error(`Metrics API Error: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();

        console.log(data);

        return { "DA": data.domain_authority };


      } catch (error) {
        console.error("Error fetching metrics:", error);
        return { DA: null, error: error.message }; // Return error object, better for handling
      }
    }

    async function keywordAnalysis() {
      document.getElementById('keywordAnalysisUrlHelp').style.display = "none";
      document.getElementById('keywordAnalysisKeywordsHelp').style.display = "none";
      document.getElementById('keywordAnalysisUrlDiv').classList.remove('has-error', 'has-feedback');
      document.getElementById('keywordAnalysisKeywordsDiv').classList.remove('has-error', 'has-feedback');

      if (!document.getElementById('keyword_analysis_url').value && !document.getElementById('keyword_analysis_keywords').value) {
        document.getElementById('keywordAnalysisUrlHelp').style.display = "block";
        document.getElementById('keywordAnalysisUrlDiv').classList.add('has-error', 'has-feedback');
        document.getElementById('keywordAnalysisKeywordsHelp').style.display = "block";
        document.getElementById('keywordAnalysisKeywordsDiv').classList.add('has-error', 'has-feedback');
      } else {
        document.getElementById('keywordAnalysisSubmit').innerHTML = '<div class="custom-toggle rotate"><i class="icon-settings"></i></div>';
        document.querySelector("#serpTable tbody").innerHTML = "";

        const urlValue = document.getElementById('keyword_analysis_url').value;
        const keywordsValue = document.getElementById('keyword_analysis_keywords').value;
        const domain = document.getElementById('keyword_analysis_url').value;
        const location = document.getElementById('keywordAnalysisCountry').value;
        const language = document.getElementById('keywordAnalysisLanguage').value;
        const keywords = document.getElementById('keyword_analysis_keywords').value.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);

        const promises = [];

        if (urlValue && keywordsValue) {
          promises.push(getKeywordRankings());
          promises.push(checkKeywordsRelevancy());
        }

        if (urlValue) {
          promises.push(getRankingKeywords());
          promises.push(getWebpageKeywords());
        }

        try {
          await Promise.all(promises);

          // Run getTimeToRank concurrently for each keyword
          //const timeToRankPromises = keywords.map(keyword => getTimeToRank(keyword, language, location, domain)); // Assuming language, location, urlValue are defined elsewhere.  Important: pass target URL here.
          //await Promise.all(timeToRankPromises);

        } catch (error) {
          console.error("One or more keyword analysis tasks failed:", error);
        } finally {
        }
        document.getElementById('keywordAnalysisSubmit').innerHTML = 'Submit';
      }
    }

    async function proceedKeywordAnalysis() {
      const urlValue = document.getElementById('keyword_analysis_url').value;
      const keywordsValue = document.getElementById('keyword_analysis_keywords').value;
      const domain = document.getElementById('keyword_analysis_url').value;
      const location = document.getElementById('keywordAnalysisCountry').value;
      const language = document.getElementById('keywordAnalysisLanguage').value;
      const keywords = document.getElementById('keyword_analysis_keywords').value.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);

      keywordAnalysisSubmit
      document.getElementById('proceedKeywordAnalysisBtn').innerHTML = '<div class="custom-toggle rotate"><i class="icon-settings"></i></div>';

      getSimilarKeywords();

      try {
        // Run getTimeToRank concurrently for each keyword
        const timeToRankPromises = keywords.map(keyword => getTimeToRank(keyword, language, location, domain)); // Assuming language, location, urlValue are defined elsewhere.  Important: pass target URL here.
        await Promise.all(timeToRankPromises);
      } catch (error) {
        console.error("One or more keyword analysis tasks failed:", error);
      } finally {
      }
      document.getElementById('keywordAnalysisSubmit').innerHTML = 'Submit';
      document.getElementById('proceedKeywordAnalysisBtn').innerHTML = 'Proceed with the keywords.';
    }

    async function getTimeToRank(keyword, language, location, target) {
      const resultsContainerId = `serp-results-container-${keyword.replace(/\s+/g, '-')}`;
      try {
        // Create a unique container for each keyword's results
        const resultsContainer = document.createElement('div');
        resultsContainer.id = resultsContainerId;
        // Optionally, add a heading or some initial content to the container
        //resultsContainer.innerHTML = `<h4>SERP Results for: ${keyword}</h4>`;
        document.getElementById('serpTable').after(resultsContainer); // Append container to the result table


        const serpEndpoint = 'https://8k6r15rg4m.execute-api.ap-southeast-1.amazonaws.com/serpLite';
        const serpResponse = await fetch(serpEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': { merge: true, value: 'application/json' }
          },
          body: JSON.stringify({
            keyword: keyword,
            language: language,
            location: location
          })
        });

        if (!serpResponse.ok) {
          throw new Error(`SERP API Error: ${serpResponse.status} ${serpResponse.statusText}`);
        }

        const serpData = await serpResponse.json();

        if (!keywordMetrics[keyword]) {
          keywordMetrics[keyword] = {};
        }
        keywordMetrics[keyword]['serp'] = serpData.body;

        if (!serpData || !serpData.body) {
          throw new Error(`Invalid SERP API response format for ${keyword}. Expected 'body' property.`);
        }

        const serp_dict = serpData.body;

        // Fetch domain metrics for SERP results and then display them
        const serpResultsWithMetrics = await Promise.all(
          Object.entries(serp_dict).map(async ([rank, result]) => {
            const domainMetrics = await getDomainMetrics(result.url, keyword);
            return {
              rank: rank,
              ...result,
              ...domainMetrics?.body // Add domain metrics to the result object
            };
          })
        );


        // Ensure displaySerpResults receives the container ID
        //displaySerpResults(serpResultsWithMetrics, resultsContainerId);


        const keywordRecommendations = await getKeywordRecommendations(keyword, language, location, target, serp_dict)

        // Await the keyword recommendations
        const timeToRank = keywordRecommendations[0];

        if (!keywordMetrics[keyword]) {
          keywordMetrics[keyword] = {};
        }

        keywordMetrics[keyword]['timeToRank'] = timeToRank;
        keywordMetrics[keyword]['mapping'] = keywordRecommendations[1];

        if (!keywordMapping[keywordRecommendations[1]]) {
          keywordMapping[keywordRecommendations[1]] = [];
          keywordMapping[keywordRecommendations[1]].push(keyword);
        }

        await displayOverallSummaryTable(location, language, target);

      } catch (error) {
        console.error(`An error occurred for ${keyword}:`, error);
        const container = document.getElementById(resultsContainerId);
        if (container) {
          container.innerHTML = `<p class="error">Error: ${error.message}</p>`;
        } else {
          console.warn(`Results container not found: ${resultsContainerId}`);
        }
      }
    }

    async function displayOverallSummaryTable(location, language, target) {
      keywordsInput = document.getElementById('keyword_analysis_keywords').value;
      keywords = keywordsInput.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);
      const summaryContainer = document.getElementById('overall-summary');
      if (!summaryContainer) {
        console.error("Summary container not found");
        return;
      }

      // Prepare the data for the summary table, using keywordMetrics
      summaryData = keywords.map((keyword, index) => {
        const metrics = keywordMetrics[keyword] || {
          cpc: 'N/A',
          search_volume: 'N/A',
          timeToRank: 'N/A',
          //mapping: '-'
        }; // Provide default values

        return {
          No: index + 1,
          keyword: keyword,
          search_volume: metrics.search_volume || 'N/A',
          cpc: metrics.cpc || 'N/A',
          timeToRank: metrics.timeToRank || 'N/A',
          reason: '', // Initialize the 'Reason' field
          //mapping: metrics.mapping || '',
        };
      });


      let tableHTML = `
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th onclick="sortSummaryTable('keyword')">Keyword</th>
                            <th onclick="sortSummaryTable('search_volume')">Search Volume</th>
                            <th onclick="sortSummaryTable('cpc')">CPC</th>
                            <th onclick="sortSummaryTable('timeToRank')">Time to Rank</th>
                            <th>Reason</th>
                            
                        </tr>
                    </thead>
                    <tbody>
            `;

      for (let index = 0; index < summaryData.length; index++) {
        const item = summaryData[index];
        const timeToRankClass = getTimeToRankClass(item.timeToRank);

        // Fetch initial reason from API
        const reason = await fetchReasonFromAPI(item.keyword, location, language, target);
        summaryData[index].reason = reason; // Update summaryData with initial reason

        tableHTML += `
              <tr>
                <td>${item.No}</td>
                <td>${item.keyword}</td>
                <td>${item.search_volume}</td>
                <td>${item.cpc}</td>
                <td class="${timeToRankClass}">${item.timeToRank}</td>
                <td><textarea class="multiline-input" id="reason-${index}" onchange="updateReason(${index}, this.value)">${reason}</textarea></td>
                </tr>
            `;
      }

      tableHTML += `
                  </tbody>
              </table>
          </div>
          `;

      //tableHTML += '<button id="downloadCsvBtn" onclick="downloadOverallSummaryTableAsCSV()">Download Keyword Summary as CSV</button><br><br>';

      summaryContainer.innerHTML = tableHTML

      document.getElementById('keywordsSummaryCard').style.display = 'block';
    }

    function getTimeToRankClass(timeToRank) {
      if (timeToRank === 'more than 12 months') {
        return 'time-to-rank-more-than-12';
      } else if (timeToRank === '9-12 months') {
        return 'time-to-rank-9-12';
      } else if (timeToRank === '6-9 months') {
        return 'time-to-rank-6-9';
      } else if (timeToRank === '3-6 months') {
        return 'time-to-rank-3-6';
      } else if (timeToRank === '0-3 months') {
        return 'time-to-rank-0-3';
      } else {
        return ''; // Default class or no class
      }
    }

    async function fetchReasonFromAPI(keyword, location, language, target) {
      const reasonApiEndpoint = "https://cdahvw5qi7.execute-api.ap-southeast-1.amazonaws.com/reasonForKwSelection";

      try {
        const response = await fetch(reasonApiEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            location: location,
            language: language,
            target: target,
            keyword: keyword
          })
        });

        if (response.ok) {
          const data = await response.json();
          return data.body;
        } else {
          console.error("Error fetching reason from API:", response.status);
          return ''; // Return empty string in case of error
        }
      } catch (error) {
        console.error("Error fetching reason from API:", error);
        return ''; // Return empty string in case of error
      }
    }

    async function getRankForUrl(url, keyword, language, location) {
      try {
        const rankCheckerResponse = await fetch('https://v5bizygr4m.execute-api.ap-southeast-1.amazonaws.com/rankChecker', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            keyword: keyword,
            language: language,
            location: location,
            target: url // Set target to the current URL
          })
        });

        if (rankCheckerResponse.ok) {
          const rankCheckerData = await rankCheckerResponse.json();
          try {
            keywordMetrics[keyword]['rank'] = rankCheckerData;
          } catch (error) {
            keywordMetrics[keyword] = {};
            keywordMetrics[keyword]['rank'] = rankCheckerData;
          }
          return rankCheckerData; // Returns rank number.
        } else {
          console.error(`Rank Checker API error for ${url}:`, rankCheckerResponse.status);
          return 'N/A';
        }
      } catch (error) {
        console.error(`Error fetching rank for ${url}:`, error);
        return 'N/A';
      }
    }

    async function getKeywordRecommendations(keyword, language, location, target_url, serp_dict) { //keep target_url here.  It's being passed into this function, which is what we want.
      const keywordMappingEndpoint = 'https://c0bkxhc1s3.execute-api.ap-southeast-1.amazonaws.com/keywordMapping';
      const kwRecommendationsEndpoint = 'https://pkbguam62a.execute-api.ap-southeast-1.amazonaws.com/kwRecommendationsStructured';
      const recommendationsContainerId = `recommendations-container-${keyword.replace(/\s+/g, '-')}`;  // Unique container for recommendations
      const targetContentTableContainerId = `target-content-table-container-${keyword.replace(/\s+/g, '-')}`;

      try {
        // 1. Keyword Mapping API
        const keywordMappingResponse = await fetch(keywordMappingEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': { merge: true, value: 'application/json' }
          },
          body: JSON.stringify({
            location: location,
            keyword: keyword,
            language: language,
            target: target_url //use target_url instead of target.
          })
        });

        if (!keywordMappingResponse.ok) {
          throw new Error(`Keyword Mapping API Error for ${keyword}: ${keywordMappingResponse.status} ${keywordMappingResponse.statusText}`);
        }

        const keywordMappingData = await keywordMappingResponse.json();

        if (keywordMappingData && keywordMappingData.body && Array.isArray(keywordMappingData.body)) {
          const targetUrls = keywordMappingData.body;

          // 2. Get Domain Metrics for Target URLs & Rank Checking
          const targetDataPromises = targetUrls.map(async (url) => {
            const domainMetrics = await getDomainMetrics(url, keyword);

            return {
              url: url,
              ...domainMetrics?.body,
              title: keywordMappingData.dict[url]?.title || 'N/A',
              description: keywordMappingData.dict[url]?.description || 'N/A'
            };
          });

          const targetData = await Promise.all(targetDataPromises);

          if (!keywordMetrics[keyword]) {
            keywordMetrics[keyword] = {};
          }
          keywordMetrics[keyword]['ranked'] = targetData;


          //Get the rank from the targetData table
          const targetDataWithRank = await Promise.all(
            targetData.map(async (item) => {
              const rankData = await getRankForUrl(item.url, keyword, language, location);
              return {
                ...item,
                rank: rankData
              };
            })
          );

          // 3. Call Keyword Recommendations API
          if (serp_dict) {
            const kwRecommendationsResponse = await fetch(kwRecommendationsEndpoint, {
              method: 'POST',
              headers: {
                'Content-Type': { merge: true, value: 'application/json' }
              },
              body: JSON.stringify({
                keyword: keyword,
                target_content: targetDataWithRank.map(item => ({ url: item.url, domain_metrics: item, rank: item.rank })), // Pass all data as domain_metrics
                serps_dict: serp_dict
              })
            });

            if (!kwRecommendationsResponse.ok) {
              throw new Error(`Keyword Recommendations API Error for ${keyword}: ${kwRecommendationsResponse.status} ${kwRecommendationsResponse.statusText}`);
            }

            const kwRecommendationsData = await kwRecommendationsResponse.json();

            if (!keywordMetrics[keyword]) {
              keywordMetrics[keyword] = {};
            }
            keywordMetrics[keyword]['recommendations'] = kwRecommendationsData.body;


            //Modified here to pass the recommendation container ID
            //displayKeywordRecommendations(kwRecommendationsData.body, recommendationsContainerId);

            // Extract URL
            let mapped_url = null;

            // Make sure the recommendation data is not null
            if (kwRecommendationsData.body) {
              try {
                const urlMatch = kwRecommendationsData.body.match(/(https?:\/\/|www\.)([a-zA-Z0-9.-]+(\.[a-zA-Z]{2,})+[a-zA-Z0-9_/\-\?=\&%\#\.]*)/gi);
                if (urlMatch && urlMatch.length > 0) {
                  mapped_url = urlMatch[0];
                } else {
                  console.warn(`No URL found in recommendations for ${keyword}`);
                  mapped_url = 'N/A'; // Set to N/A if no URL is found
                }
              } catch (urlExtractionError) {
                console.error(`Error extracting URL from recommendations for ${keyword}:`, urlExtractionError);
                mapped_url = 'N/A';  // Set to N/A in case of an error during extraction
              }
            } else {
              console.warn(`Empty keyword recommendations for ${keyword}`);
              mapped_url = 'N/A';  // Set to N/A if the recommendations are empty
            }


            // Extract Time to Rank using regex
            const timeToRankMatch = kwRecommendationsData.body.match(/(0-3 months|3-6 months|6-9 months|9-12 months|more than 12 months|More than 12 months)/);
            const timeToRank = timeToRankMatch ? timeToRankMatch[0] : 'N/A';
            return [timeToRank, mapped_url];
          } else {
            console.warn(`Skipping Keyword Recommendations for ${keyword} due to missing serp_dict.`);
            return ['N/A', 'N/A'];
          }
        } else {
          console.warn(`Invalid Keyword Mapping API response format for ${keyword}. Expected 'body' as array.`);
          return ['N/A', 'N/A'];
        }

      } catch (error) {
        console.error(`Error during Keyword Mapping, Target Content Processing, or Keyword Recommendations for ${keyword}:`, error);
        return ['N/A', 'N/A'];
      }
    }

    async function getDomainMetrics(url, keyword) {
      const domainMetricsEndpoint = 'https://5zdbpwaia5.execute-api.ap-southeast-1.amazonaws.com/pageDomainMetrics';

      try {
        const response = await fetch(domainMetricsEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            url: url,
            keyword: keyword
          })
        });

        if (!response.ok) {
          console.warn(`Domain Metrics API Error for URL ${url}: ${response.status} ${response.statusText}`);
          return null;
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error(`Error fetching domain metrics for URL ${url}:`, error);
        return null;
      }
    }

    async function getKeywordRankings() {
      document.getElementById('queriedKeywordsCard').style.display = "none";
      document.getElementById('rankCheckerFunctionExecuted').innerHTML = '<a href="#queriedKeywordsCard"> Rank Checker</a>';
      const country = document.getElementById('keywordAnalysisCountry').value;
      const language = document.getElementById('keywordAnalysisLanguage').value;
      const keywords = document.getElementById('keyword_analysis_keywords').value.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);
      const domain = document.getElementById('keyword_analysis_url').value;
      const table = document.getElementById('queriedKeywordsTable').getElementsByTagName('tbody')[0];
      table.innerHTML = ''; // Clear existing table data

      let rowNumber = 1; // Initialize the row number counter

      for (const keyword of keywords) { //Iterate keywords sequentially
        const data = await fetchRank(domain, country, language, keyword); //Fetch rank for each keyword

        if (data && Object.keys(data).length > 0) {
          for (const rank in data) {
            if (data.hasOwnProperty(rank)) {
              const url = data[rank].url;
              const newRow = table.insertRow();
              const cell1 = newRow.insertCell(0);
              const cell2 = newRow.insertCell(1);
              const cell3 = newRow.insertCell(2);
              const cell4 = newRow.insertCell(3);

              cell1.innerHTML = rowNumber;
              cell2.innerHTML = keyword;
              cell3.innerHTML = rank;
              cell4.innerHTML = `<a href="${url}" target="_blank">${url}</a>`;
            }
          }
          rowNumber++; // Increment the row number after displaying all entries for a keyword
        } else {
          // Handle case where no results are found for a keyword
          const newRow = table.insertRow();
          const cell1 = newRow.insertCell(0);
          const cell2 = newRow.insertCell(1);
          const cell3 = newRow.insertCell(2);
          const cell4 = newRow.insertCell(3);

          cell1.innerHTML = rowNumber;
          cell2.innerHTML = keyword;
          cell3.innerHTML = 'Not Found';
          cell4.innerHTML = 'Not Found';
          rowNumber++; // Increment the row number even when no results are found
        }
      }
      document.getElementById('rankCheckerFunctionExecuted').innerHTML = '<a href="#"><i class="fas fa-check-circle" style="color: green; margin-right: 5px;"aria-hidden="true"></i> Rank Checker</a>';
      document.getElementById('queriedKeywordsCard').style.display = "block";
    }

    async function getSimilarKeywords() {
      const country = document.getElementById('keywordAnalysisCountry').value;
      const language = document.getElementById('keywordAnalysisLanguage').value;
      const keywords = document.getElementById('keyword_analysis_keywords').value.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);


      var url = "https://lgvdhcs4t2.execute-api.ap-southeast-1.amazonaws.com/similarKeywords";
      var queryString = {
        "keywords": keywords,
        "location": country,
        "language": language
        ,//"user": JSON.parse(localStorage.getItem('googleUser')).email
      };

      var headers = {
        "Content-Type": "application/json",
      };

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(queryString)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        populateSimilarKeywordsTable(data.body);
      } catch (error) {
        console.error("Error fetching data:", error);
        // Re-throw the error to signal failure to the caller (keywordAnalysis)
        throw error;
      }
    }

    async function getRankingKeywords() {
      const domain = document.getElementById('keyword_analysis_url').value;
      const country = document.getElementById('keywordAnalysisCountry').value;
      let targetDomain = domain;

      if (document.getElementById('keywordAnalysisTypeDomain').checked) {
        if (targetDomain.includes('http')) {
          targetDomain = (targetDomain.replace('http://', '').replace('https://', '')).split('/')[0];
        }
      } else {
        if (!targetDomain.includes('http')) {
          targetDomain = 'https://' + targetDomain;
        }
      }

      const url = "https://0dqny7l5y9.execute-api.ap-southeast-1.amazonaws.com/rankingKeywords";

      const headers = {
        "Content-Type": "application/json",
      };

      const queryString = {
        "target": targetDomain,
        "location": country
      };

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(queryString)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        populateRankingKeywordsTable(data.body);
        addTableEventListeners();
      } catch (error) {
        console.error("Error fetching data:", error);
        // Re-throw the error to signal failure to the caller (keywordAnalysis)
        throw error;
      }
    }

    async function getWebpageKeywords() {
      const domain = document.getElementById('keyword_analysis_url').value;
      const country = document.getElementById('keywordAnalysisCountry').value;
      const language = document.getElementById('keywordAnalysisLanguage').value;

      const endpoint = "https://ei6xj9x2rd.execute-api.ap-southeast-1.amazonaws.com/keywordsForSite";
      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            location: country,
            language: language,
            target: domain
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        if (typeof data !== 'object' || data === null) {
          console.error("Data is not an object:", data);
          return; // Exit function if data is not an object.
        }
        const allKeywords = Object.entries(data).map(([keyword, values]) => ({
          keyword,
          search_volume: values.search_volume,
          competition: values.competition,
          search_intent: values.search_intent,
          reason_for_choosing: values.reason_for_choosing
        }));

        populateWebpageKeywordsTable(allKeywords);
      } catch (error) {
        console.error("Error fetching data:", error);
        // Re-throw the error to signal failure to the caller (keywordAnalysis)
        throw error;
      }
    }

    function populateWebpageKeywordsTable(keywords) {
      const tableBody = document.querySelector("#webpageKeywordsTable tbody");

      //Clear existing table rows
      tableBody.innerHTML = "";

      //Iterate through the keywords and create table rows
      keywords.forEach(keyword => {
        const row = tableBody.insertRow();
        const keywordCell = row.insertCell();
        const searchVolCell = row.insertCell();
        const competitionCell = row.insertCell();
        const searchIntentCell = row.insertCell();
        const reasonCell = row.insertCell();
        const addCell = row.insertCell();

        keywordCell.textContent = keyword.keyword;
        searchVolCell.textContent = keyword.search_volume;
        competitionCell.textContent = keyword.competition;
        searchIntentCell.textContent = keyword.search_intent;
        reasonCell.textContent = keyword.reason_for_choosing;

        // Create the + icon with a class for styling and a click handler
        const plusIcon = document.createElement("i");
        plusIcon.classList.add("fas", "fa-plus-circle", "clickable-plus");
        plusIcon.addEventListener("click", () => {
          addKeywordToTextarea(keyword.keyword);
          addCell.textContent = "added";
        });
        addCell.appendChild(plusIcon);
      });
      makeTableSortable('webpageKeywordsTable');
    }

    function populateSimilarKeywordsTable(keywords) {
      const tableBody = document.querySelector("#similarKeywordsTable tbody");

      //Clear existing table rows
      tableBody.innerHTML = "";

      const similarKeywordsArray = Object.entries(keywords).map(([keyword, data]) => ({
        keyword: keyword,
        search_volume: data.search_volume,
        cpc: data.cpc,
        competition: data.competition
      }));

      //Iterate through the keywords and create table rows
      similarKeywordsArray.forEach(keyword => {
        const row = tableBody.insertRow();
        const keywordCell = row.insertCell();
        const searchVolCell = row.insertCell();
        const competitionCell = row.insertCell();
        const cpcCell = row.insertCell();
        const addCell = row.insertCell();

        keywordCell.textContent = keyword.keyword;
        searchVolCell.textContent = keyword.search_volume;
        competitionCell.textContent = keyword.competition;
        cpcCell.textContent = keyword.cpc;


        if (!keywordMetrics[keyword.keyword]) {
          keywordMetrics[keyword.keyword] = {};
        }

        keywordMetrics[keyword.keyword]['search_volume'] = keyword.search_volume;
        keywordMetrics[keyword.keyword]['competition'] = keyword.competition;
        keywordMetrics[keyword.keyword]['cpc'] = keyword.cpc;

        // Create the + icon with a class for styling and a click handler
        const plusIcon = document.createElement("i");
        plusIcon.classList.add("fas", "fa-plus-circle", "clickable-plus");
        plusIcon.addEventListener("click", () => {
          addKeywordToTextarea(keyword.keyword);
          addCell.textContent = "added";
        });
        addCell.appendChild(plusIcon);
      });
      makeTableSortable('similarKeywordsTable');
    }

    function populateRankingKeywordsTable(keywords) {
      document.getElementById('combinedCards').style.display = "none";
      document.getElementById('serpCard').style.display = "none";
      const tableBody = document.querySelector("#rankingKeywordsTable tbody");

      //Clear existing table rows
      tableBody.innerHTML = "";

      const rankedKeywordsArray = Object.entries(keywords).map(([keyword, data]) => ({
        keyword: keyword,
        search_volume: data.search_volume,
        rank: data.rank,
        difficulty: data.difficulty,
        cpc: data.cpc
      }));

      //Iterate through the keywords and create table rows
      rankedKeywordsArray.forEach(keyword => {
        const row = tableBody.insertRow();
        const keywordCell = row.insertCell();
        const searchVolCell = row.insertCell();
        const rankCell = row.insertCell();
        const cpcCell = row.insertCell();
        const addCell = row.insertCell();

        keywordCell.textContent = keyword.keyword;
        searchVolCell.textContent = keyword.search_volume;
        rankCell.textContent = keyword.rank;
        cpcCell.textContent = keyword.cpc;

        if (!keywordMetrics[keyword]) {
          keywordMetrics[keyword] = {}
        }

        keywordMetrics[keyword]['search_volume'] = keyword.search_volume;
        keywordMetrics[keyword]['competition'] = keyword.competition;
        keywordMetrics[keyword]['cpc'] = keyword.cpc;
        keywordMetrics[keyword]['rank'] = keyword.rank;

        // Create the + icon with a class for styling and a click handler
        const plusIcon = document.createElement("i");
        plusIcon.classList.add("fas", "fa-plus-circle", "clickable-plus");
        plusIcon.addEventListener("click", () => {
          addKeywordToTextarea(keyword.keyword);
          addCell.textContent = "added";
        });
        addCell.appendChild(plusIcon);
      });
      makeTableSortable('rankingKeywordsTable');
      document.getElementById('combinedCards').style.display = "block";
      document.getElementById('serpCard').style.display = "block";
    }



    function addKeywordToTextarea(keyword) {
      const textarea = document.getElementById('keyword_analysis_keywords');
      const existingKeywords = textarea.value.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);

      if (!existingKeywords.includes(keyword)) {
        if (existingKeywords.length > 0) {
          textarea.value += "\n";
        }
        textarea.value += keyword + "\n";
        updateKeywordCount();
      } else {
        console.log(`Keyword "${keyword}" already exists in textarea. Skipping.`);
      }
    }

    function updateKeywordCount() {
      const textarea = document.getElementById('keyword_analysis_keywords');
      const keywords = textarea.value.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);
      const keywordCount = keywords.length;
      const countDisplayElement = document.getElementById('keywordCountDisplay');

      if (keywordCount == 0) {
        countDisplayElement.textContent = 'Keywords';
      } else {
        countDisplayElement.textContent = `Keyword Count: ${keywordCount}`;
      }
    }

    function sortTable(tableId, columnIndex, isNumeric = false) {
      const table = document.getElementById(tableId);
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));

      // Get the current sort direction from the table's dataset
      const currentSortDirection = table.dataset.sortDirection === 'asc' ? 'asc' : 'desc';

      const comparer = (row1, row2) => {
        const cell1 = row1.querySelectorAll('td')[columnIndex].textContent.trim();
        const cell2 = row2.querySelectorAll('td')[columnIndex].textContent.trim();

        let comparison = 0; // Default comparison value

        if (isNumeric) {
          const num1 = parseFloat(cell1);
          const num2 = parseFloat(cell2);

          if (isNaN(num1) && isNaN(num2)) comparison = 0;
          else if (isNaN(num1)) comparison = 1;
          else if (isNaN(num2)) comparison = -1;
          else comparison = num1 - num2;
        } else {
          comparison = cell1.localeCompare(cell2);
        }

        // Reverse the comparison based on the current sort direction
        return currentSortDirection === 'asc' ? comparison : -comparison;
      };

      rows.sort(comparer);

      // Remove existing rows from the table
      while (tbody.firstChild) {
        tbody.removeChild(tbody.firstChild);
      }

      // Append sorted rows to the table
      rows.forEach(row => tbody.appendChild(row));

      // Update the sort direction for the next click
      table.dataset.sortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    }


    function makeTableSortable(tableId) {
      const table = document.getElementById(tableId);
      const thead = table.querySelector('thead');
      const headers = thead.querySelectorAll('th');

      headers.forEach((header, columnIndex) => {
        const isNumericColumn = (header.textContent.toLowerCase().includes("search vol") || header.textContent.toLowerCase().includes("cpc") || header.textContent.toLowerCase().includes("rank"));

        header.addEventListener('click', () => {
          sortTable(tableId, columnIndex, isNumericColumn);
        });
        header.style.cursor = 'pointer';
      });

      // Initialize sort direction for the table (ascending by default)
      table.dataset.sortDirection = 'asc';
    }

    function attachKeywordTableListeners(tableId) {
      const table = document.getElementById(tableId);
      if (!table) {
        console.warn(`Table with ID "${tableId}" not found.`);
        return;
      }

      const tableBody = table.querySelector('tbody');
      if (!tableBody) {
        console.warn(`Table with ID "${tableId}" has no tbody.`);
        return;
      }

      tableBody.addEventListener('click', function (event) {
        // Find the closest row element (<tr>) to the clicked element
        const targetRow = event.target.closest('tr');

        if (targetRow) {
          // Get the keyword from the first cell (<td>) of the row
          const keywordCell = targetRow.querySelector('td:first-child');

          if (keywordCell) {
            const keyword = keywordCell.textContent;
            console.log(`Clicked keyword: ${keyword}`); // For debugging
            showSerps(keyword); // Call your showSerps function
          }
        }
      });
    }

    function addTableEventListeners() {
      const rakedKeywordsTable = document.getElementById('rankingKeywordsTable');
      const similarKeywordsTable = document.getElementById('similarKeywordsTable');
      const webpageKeywordsTable = document.getElementById('webpageKeywordsTable');

      if (rakedKeywordsTable) {
        rakedKeywordsTable.addEventListener('click', function (event) {
          if (event.target.tagName === 'TD') {
            const keyword = event.target.parentElement.cells[0].textContent;
            serpModal(keyword);
          }
        });
      }

      if (similarKeywordsTable) {
        similarKeywordsTable.addEventListener('click', function (event) {
          if (event.target.tagName === 'TD') {
            const keyword = event.target.parentElement.cells[0].textContent;
            serpModal(keyword);
          }
        });
      }

      if (webpageKeywordsTable) {
        webpageKeywordsTable.addEventListener('click', function (event) {
          if (event.target.tagName === 'TD') {
            const keyword = event.target.parentElement.cells[0].textContent;
            serpModal(keyword);
          }
        });
      }
    }

    async function mapKeywords() {
      if (!document.getElementById('keyword_analysis_keywords').value || !document.getElementById('keyword_analysis_url').value) {
        document.getElementById('keywordAnalysisUrlHelp').style.display = "block";
        document.getElementById('keywordAnalysisUrlDiv').classList.add('has-error', 'has-feedback');
        document.getElementById('keywordAnalysisKeywordsHelp').style.display = "block";
        document.getElementById('keywordAnalysisKeywordsDiv').classList.add('has-error', 'has-feedback');
        return
      }

      document.getElementById('keywordMappingCard').style.display = "none";
      //document.getElementById('mapKeywordsBtn').innerHTML = '<div class="custom-toggle rotate"><i class="icon-settings"></i></div>';
      const promises = [];

      promises.push(getKeywordRankings());
      await Promise.all(promises);

      const domain = document.getElementById('keyword_analysis_url').value;
      const country = document.getElementById('keywordAnalysisCountry').value;
      const language = document.getElementById('keywordAnalysisLanguage').value;
      const keywords = document.getElementById('keyword_analysis_keywords').value.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);

      clearAllLists();
      listCounter = 1;

      // Create an array to hold the promises for each fetch request
      const fetchPromises = keywords.map(keyword => {

        for (key in keywordMapping) {
          value = keywordMapping[key];
          if (value.includes(keyword)) {
          } else {
            return fetch('https://6s7ijwwsa8.execute-api.ap-southeast-1.amazonaws.com/dragDrop', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                domain: domain,
                keyword: keyword,
                language: language,
                location: country,
              })
            }).then(response => {
              if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
              }
              return response.json();
            }).then(data => {
              data = data.replace(domain, '').replace('http://', '').replace('www.', '').replace('https://', '');
              if (data) {
                if (!keywordMapping[data]) {
                  keywordMapping[data] = [];
                }
                keywordMapping[data].push(keyword);
              } else {
                console.warn(`API response missing URL for keyword: ${keyword}`);
              }
            })
              .catch(error => {
                console.error(`Error for keyword "${keyword}":`, error);
              });
          }
        }
      }
      );

      try {
        // Wait for all promises to resolve before populating the lists
        await Promise.all(fetchPromises);

        // Now populate the lists based on the built-up keywordMapping
        populateListsFromMapping();
      } catch (error) {
        console.error("An error occurred during the fetch requests:", error);
      } finally {
        //document.getElementById('mapKeywordsBtn').innerHTML = 'Map Keywords';
        document.getElementById('keywordMappingCard').style.display = "block";
        document.getElementById('rankCheckerFunctionExecuted').innerHTML = '<a href="#"><i class="fas fa-check-circle" style="color: green; margin-right: 5px;"aria-hidden="true"></i> Rank Checker</a>';

      }
    }

    function populateListsFromMapping() {
      for (const url in keywordMapping) {
        if (keywordMapping.hasOwnProperty(url)) {
          const { listContainer, list, renameInput } = createListContainer(url);

          keywordMapping[url].forEach(keyword => {
            const listItem = createKeywordListItem(keyword);
            list.appendChild(listItem);
          });

          listsContainer.appendChild(listContainer);
          listCounter++;
        }
      }
    }

    function createKeywordListItem(keyword) {
      const listItem = document.createElement('li');
      listItem.draggable = true;
      listItem.addEventListener('dragstart', drag);
      listItem.id = keyword;
      listItem.textContent = keyword; // Display keyword
      return listItem;
    }

    function createListContainer(url) {
      const listContainer = document.createElement('div');
      listContainer.classList.add('list-container');

      const renameInput = document.createElement('input');
      renameInput.type = 'text';
      renameInput.classList.add('border', 'rounded', 'p-2', 'flex-grow-1', 'me-2');
      renameInput.style.width = "80%";
      renameInput.value = url;

      const deleteButton = document.createElement('button');
      deleteButton.classList.add('btn', 'btn-sm', 'btn-outline-danger');
      deleteButton.innerHTML = '<i class="fas fa-times"</i>';
      deleteButton.addEventListener('click', function () {
        deleteList(this);
      });


      const listId = 'list' + listCounter;
      const list = document.createElement('ul');
      list.id = listId;
      list.classList.add('keyword-list');
      list.addEventListener('drop', drop);
      list.addEventListener('dragover', allowDrop);

      listContainer.appendChild(renameInput);
      listContainer.appendChild(deleteButton);
      listContainer.appendChild(list);

      // Add the "Page Recommendations" button
      const recommendationsButton = document.createElement('button');
      recommendationsButton.classList.add("btn", "btn-primary", "w-100");
      recommendationsButton.style.display = "block";
      domain = document.getElementById('keyword_analysis_url').value;
      recommendationsButton.innerHTML += '<i class="fas fa-magic me-1"></i> ';
      recommendationsButton.textContent = 'AI Prompt for Content Writing';
      recommendationsButton.addEventListener('click', function () {
        // Disable the button
        this.disabled = true;
        this.classList.add('disabled');

        // Get the URL from the input field *inside* this function
        const currentURL = renameInput.value;

        // Get the list items and put them into an array
        const listItems = Array.from(list.children).map(item => item.textContent.trim());

        getPageRecommendations(currentURL, listItems, this); // Pass the button element
      });
      listContainer.appendChild(recommendationsButton);
      return { listContainer, list, renameInput };
    }

    async function getPageRecommendations(url, listElement, button) {
      button.innerHTML = '<div class="custom-toggle rotate"><i class="icon-settings"></i></div>';
      const recommendationEndpoint = 'https://pkkz2e02ch.execute-api.ap-southeast-1.amazonaws.com/onPageContentRecommendations';

      try {
        const recommendationResponse = await fetch(recommendationEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            url,
            "keywords": listElement
          })
        });

        recommendationData = await recommendationResponse.json();

        // Create collapsible structure
        const collapsibleButton = document.createElement('button');
        collapsibleButton.classList.add('collapsible50');
        collapsibleButton.textContent = `${url}`;

        const contentDiv = document.createElement('div');
        contentDiv.classList.add('content');

        // Check if the response is a list of dictionaries
        if (Array.isArray(recommendationData) && recommendationData.length > 0 && typeof recommendationData[0] === 'object') {
          // Create a table
          const table = document.createElement('table');
          table.classList.add("table", "table-striped", "mt-3");

          // Create table header
          const thead = document.createElement('thead');
          const headerRow = document.createElement('tr');
          const headers = Object.keys(recommendationData[0]);

          headers.forEach(headerText => {
            const th = document.createElement('th');
            th.textContent = headerText;
            th.style.border = '1px solid #ddd';
            th.style.padding = '8px';
            th.style.textAlign = 'left';
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          table.appendChild(thead);


          // Create table body
          const tbody = document.createElement('tbody');
          recommendationData.forEach(item => {
            const row = document.createElement('tr');
            headers.forEach(header => {
              const cell = document.createElement('td');
              cell.textContent = item[header];
              cell.style.border = '1px solid #ddd';
              cell.style.padding = '8px';
              row.appendChild(cell);
            });
            tbody.appendChild(row);
          });
          table.appendChild(tbody);

          contentDiv.innerHTML += '<h3>Content Optimisation</h3>';

          contentDiv.appendChild(table); // Append the table to the content div

          endpoint = 'https://udjdc333m9.execute-api.ap-southeast-1.amazonaws.com/getImages';

          response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              url: url,
              keywords: listElement // Send keywords to the backend
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          data = await response.json();

          console.log(data);

          const recommendationEndpoint = 'https://vwmqqj251d.execute-api.ap-southeast-1.amazonaws.com/onPageRecommendations';

          const recommendationResponse = await fetch(recommendationEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              "data": data,
              "keywords": listElement
            })
          });

          if (!recommendationResponse.ok) {
            throw new Error(`HTTP error! status: ${recommendationResponse.status}`);
          }

          recommendationData = await recommendationResponse.json();

          data = recommendationData;
          let resultsHTML = '';

          let metaTableHTML = `<h3>Meta and Headings</h3>
      <table id="metaTable" class="table table-striped mt-3">
          <thead>
              <tr>
                  <th>Item</th>
                  <th>Current Value</th>
                  <th>Suggested Change</th>
                  <th>Rationale</th>
              </tr>
          </thead>
          <tbody>
              <tr>
                  <td>Meta Title</td>
                  <td>${data.meta_title.current_value}</td>
                  <td><textarea class="form-control">${data.meta_title.suggested_value}</textarea></td>
                  <td>${data.meta_title.rationale}</td>
              </tr>
              <tr>
                  <td>Meta Description</td>
                  <td>${data.meta_description.current_value}</td>
                  <td><textarea class="form-control">${data.meta_description.suggested_value}</textarea></td>
                  <td>${data.meta_description.rationale}</td>
              </tr>
              <tr>
                  <td>Canonical URL</td>
                  <td>${data.canonical_url.current_value}</td>
                  <td><textarea class="form-control">${data.canonical_url.suggested_value}</textarea></td>
                  <td>${data.canonical_url.rationale}</td>
              </tr>`;

          // Function to add heading rows
          function addHeadingRows(headingType, headings) {
            headings.forEach(heading => {
              metaTableHTML += `
              <tr>
                  <td>${headingType}</td>
                  <td>${heading.current_value}</td>
                  <td><textarea class="form-control">${heading.suggested_value}</textarea></td>
                  <td>${heading.rationale}</td>
              </tr>
          `;
            });
          }

          addHeadingRows("H1 Heading", data.headings.h1);
          addHeadingRows("H2 Heading", data.headings.h2);
          addHeadingRows("H3 Heading", data.headings.h3);
          addHeadingRows("H4 Heading", data.headings.h4);

          metaTableHTML += `

          </tbody>
      </table>
  `;

          let imageTableHTML = `<h3>Image Title and Alt Text</h3>
          <table id="imageTable" class="table table-striped mt-3">
              <thead>
                  <tr>
                      <th>No.</th>
                      <th>Image URL</th>
                      <th>Image Preview</th>
                      <th>Alt Text</th>
                      <th>Suggested Alt Text</th>
                      <th>Rationale</th>
                  </tr>
              </thead>
              <tbody>
      `;

          let i = 0;
          for (const imageData of data.image_data) {
            const imageUrl = Object.keys(imageData)[0];
            const imageDetails = imageData[imageUrl];

            imageTableHTML += `
              <tr>
                  <td>${i + 1}</td>
                  <td><a href="${imageUrl}" target="_blank">${imageUrl}</a></td>
                  <td><img style="width:200px;" src="${imageUrl}" alt="${imageDetails.current_value}"></td>
                  <td>${imageDetails.current_value}</td>
                  <td><textarea class="form-control">${imageDetails.suggested_value}</textarea></td>
                  <td>${imageDetails.rationale}</td>
              </tr>
          `;
            i++;
          }


          imageTableHTML += `
              </tbody>
          </table>
      `;

          resultsHTML += metaTableHTML;

          // Add export button after image table
          resultsHTML += '<button class="btn btn-black" onclick="exportOnPageToCSV()">Export to CSV</button>';

          contentDiv.innerHTML += resultsHTML;
          contentDiv.innerHTML += imageTableHTML;

        } else {
          // If it's not a list of dictionaries, just set the innerHTML
          contentDiv.innerHTML = recommendationData;
        }


        // Append elements to the recommendations div
        const recommendationsDiv = document.getElementById('onPageRecommendations');
        recommendationsDiv.appendChild(collapsibleButton);
        recommendationsDiv.appendChild(contentDiv);

        // Add event listener for collapsible functionality
        collapsibleButton.addEventListener('click', function () {
          this.classList.toggle('active');
          const content = this.nextElementSibling;
          if (content.style.display === 'block') {
            content.style.display = 'none';
          } else {
            content.style.display = 'block';
          }
        });

        console.log(recommendationData); // Now logs the parsed JSON data


      } catch (error) {
        console.error("Error fetching recommendations:", error);
      } finally {
        // Re-enable the button in the finally block to ensure it always happens
        button.disabled = false;
        button.classList.remove('disabled');
        button.innerHTML = "AI Prompt for Content Writing";
      }
    }

    function exportOnPageToCSV() {
      // Collect data from both tables
      const metaTable = document.getElementById('metaTable');
      const imageTable = document.getElementById('imageTable');
      const contentTable = document.getElementById('contentTable');


      if (!metaTable || !imageTable) {
        alert('Tables not found. Please extract data first.');
        return;
      }

      const metaData = tableToCSV(metaTable);
      const imageData = tableToCSV(imageTable);
      const contentData = tableToCSV(contentTable);

      // Combine the data with a separator
      const csvData = "Meta Table Data:\n" + metaData + "\n\nImage Table Data:\n" + imageData + "\n\nContent Recommendations:\n" + contentData;

      // Create a download link
      const filename = 'on_page_recommendations.csv';
      const csvFile = new Blob([csvData], {
        type: 'text/csv'
      });
      const downloadLink = document.createElement('a');
      downloadLink.download = filename;
      downloadLink.href = window.URL.createObjectURL(csvFile);
      downloadLink.style.display = 'none';
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }

    function allowDrop(ev) {
      ev.preventDefault();
      const target = ev.target;

      if (target.classList.contains('keyword-list')) {
        // Check if the list is full
        if (target.children.length < MAX_ITEMS_PER_LIST) {
          target.classList.add('drag-over');
        } else {
          // Optional: Provide visual feedback that the list is full
          target.classList.add('list-full'); // Add a class for styling, e.g., red border
        }
      }
    }

    function clearAllLists() {
      while (listsContainer.firstChild) {
        listsContainer.removeChild(listsContainer.firstChild);
      }
    }

    function drop(ev) {
      ev.preventDefault();
      const target = ev.target;

      if (target.classList.contains('keyword-list')) {
        target.classList.remove('drag-over'); // Always remove the drag-over class

        // Check if the list is full again before dropping (safety check)
        if (target.children.length < MAX_ITEMS_PER_LIST) {
          var data = ev.dataTransfer.getData("text");
          var draggedElement = document.getElementById(data);
          target.appendChild(draggedElement);

          // Increase the height of the list
          const currentHeight = parseInt(window.getComputedStyle(target).minHeight);
          const numberOfKeywords = target.children.length;
          const heightIncrease = (numberOfKeywords * HEIGHT_PER_KEYWORD);
          target.style.minHeight = (currentHeight + heightIncrease) + 'px';

          target.classList.remove('list-full'); // remove the list-full class if there are items to drop
        } else {
          //Optional: Prevent the drop from occurring
          //You can optionally add additional error handling here
          target.classList.remove('list-full');
          return;
        }

      } else {
        target.classList.remove('drag-over');
        target.classList.remove('list-full'); //also, prevent adding css if element does not have the correct class
      }
    }

    function drag(ev) {
      ev.dataTransfer.setData("text", ev.target.id);
    }

    const MAX_ITEMS_PER_LIST = 20; // Set the maximum limit
    const HEIGHT_PER_KEYWORD = 6; // Additional increase per keyword.

    function deleteList(deleteButton) {
      const listContainer = deleteButton.parentNode;
      const listsContainer = document.getElementById('listsContainer');

      // Store the deleted list details for undo
      deletedLists.push({
        element: listContainer,
        nextSibling: listContainer.nextSibling,
        listsContainer: listsContainer
      });

      listsContainer.removeChild(listContainer);
    }

    function addNewList() {
      const listsContainer = document.getElementById('listsContainer');

      const listContainer = document.createElement('div');
      listContainer.classList.add('list-container');

      const listId = 'list' + listCounter;
      const defaultName = '/url-' + listCounter;

      const renameInput = document.createElement('input');
      renameInput.type = 'text';
      renameInput.classList.add('border', 'rounded', 'p-2', 'flex-grow-1', 'me-2');
      renameInput.value = defaultName;

      const deleteButton = document.createElement('button');
      deleteButton.classList.add('btn', 'btn-sm', 'btn-outline-danger');
      deleteButton.innerHTML = '<i class="fas fa-times"</i>';
      deleteButton.addEventListener('click', function () {
        deleteList(this);
      });

      const list = document.createElement('ul');
      list.id = listId;
      list.classList.add('keyword-list');
      list.addEventListener('drop', drop);
      list.addEventListener('dragover', allowDrop);

      listContainer.appendChild(renameInput);
      listContainer.appendChild(deleteButton);
      listContainer.appendChild(list);

      // Add the "Page Recommendations" button
      const recommendationsButton = document.createElement('button');
      recommendationsButton.classList.add("btn", "btn-primary", "w-100");
      recommendationsButton.style.display = "block";
      recommendationsButton.innerHTML += '<i class="fas fa-magic me-1"></i> ';
      recommendationsButton.textContent = 'AI Prompt for Content Writing';
      recommendationsButton.addEventListener('click', function () {
        // Disable the button
        this.disabled = true;
        this.classList.add('disabled');

        const url = renameInput.value; //get the url value

        // Get the list items and put them into an array
        const listItems = Array.from(list.children).map(item => item.textContent.trim());

        getPageRecommendations(url, listItems, this); // Pass both URL and the array of list items and the button element
      });
      listContainer.appendChild(recommendationsButton);

      listsContainer.appendChild(listContainer);

      listCounter++;
    }

    let listCounter = 1;
    let deletedLists = []; // Store an array of deleted lists for multiple undo

    function deleteList(deleteButton) {
      const listContainer = deleteButton.parentNode;
      const listsContainer = document.getElementById('listsContainer');

      // Store the deleted list details for undo
      deletedLists.push({
        element: listContainer,
        nextSibling: listContainer.nextSibling,
        listsContainer: listsContainer
      });

      listsContainer.removeChild(listContainer);
    }

    function undoDelete() {
      if (deletedLists.length > 0) {
        const lastDeleted = deletedLists.pop(); // Get the last deleted list

        // Re-insert the deleted list
        if (lastDeleted.nextSibling) {
          lastDeleted.listsContainer.insertBefore(lastDeleted.element, lastDeleted.nextSibling);
        } else {
          lastDeleted.listsContainer.appendChild(lastDeleted.element);
        }
      }
    }

    async function fetchRank(domain, country, language, keyword) {
      try {
        const response = await fetch('https://w9opnioy78.execute-api.ap-southeast-1.amazonaws.com/checkRankingUrl', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            "keyword": keyword,
            "language": language,
            "location": country,
            "target": domain
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error ${response.status}`);
        }

        data = await response.json();

        return data
      } catch (error) {
        console.error("Error fetching rank:", error);
        return ('not available');
      }
    }


    async function contentComparisonAnalysis(keyword) {
      const domain = document.getElementById('keyword_analysis_url').value;
      const country = document.getElementById('keywordAnalysisCountry').value;
      const language = document.getElementById('keywordAnalysisLanguage').value;

      serpUrls = [];

      for ([key, value] of Object.entries(keywordMetrics[keyword]['serp'])) {
        for ([key2, value2] of Object.entries(value)) {
          if (key2 === 'url') {
            serpUrls.push(value2);
          }
        }
      }

      try {
        target = document.getElementById('keyword_analysis_url').value;
        if ('https://')
          serpUrls.push(target);

        // 2. Fetch content analysis for each URL *concurrently*
        const analysisPromises = serpUrls.map(url =>
          fetch('https://u24f9208q0.execute-api.ap-southeast-1.amazonaws.com/gptTopicsPerUrl', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url, keyword }),
          })
            .then(res => {
              if (!res.ok) {  // Check for errors
                console.warn(`Content analysis API error for ${url}: ${res.status} ${res.statusText}.  Skipping.`);
                return null; // Signal that this URL failed
              }
              return res.json();
            })
            .catch(error => {
              console.warn(`Content analysis API error for ${url}: ${error.message}.  Skipping.`);
              return null; // Signal that this URL failed
            })
        );

        // Wait for *all* content analysis calls to complete
        analysisDataArray = await Promise.all(analysisPromises);

        // Combine analysis data, handling potential errors from individual API calls
        analysisData = {};
        analysisDataArray.forEach(item => {
          try {
            url = Object.keys(item['body'])[0];
            analysisData[url] = item['body'][url];
          } catch (error) {

          }
        }
        );

        // Check if analysisData is empty after combining results.
        if (Object.keys(analysisData).length === 0) {
          throw new Error("Content analysis failed for all URLs. Please check the URLs and try again.");
        }

        // 3. Create and display the table (modified createAnalysisTable function below)
        comparisonTableHTML = createAnalysisTable(analysisData, keyword, serpUrls);  // Pass keyword and target URLs
        document.getElementById('initial-table').innerHTML = `<div id="tableContainer">${comparisonTableHTML}</div>`;

        // 4. Apply gradients (no change needed)
        applyGradientsToRows();

        pageTypes = ['all'];

        // 5. Submit table data to comparisonRecommender API
        const comparisonResponse = await fetch('https://33v5mhjt47.execute-api.ap-southeast-1.amazonaws.com/comparisonRecommender', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ output: analysisData, keyword, location, pageTypes, domain: document.getElementById('keyword_analysis_url').value }), // Send analysisData directly
        });
        const comparisonData = await comparisonResponse.json();

        console.log(comparisonData);

        // Display recommendations and output table from comparison API
        const recommendation = comparisonData.body.recommendation;

        urls = serpUrls;

        try {
          resultsDiv = document.getElementById('contentComparisonRecommendation');
          //const outputTableHTML = createHTMLTableFromJSON(comparisonData.body.output); // Parse JSON string to object
          const outputTableHTML = createAnalysisTable(comparisonData.body.output, keyword, urls)
          document.getElementById('initial-table').innerHTML = "";
          document.getElementById('initial-table').innerHTML = `<div id="tableContainer">${outputTableHTML}</div>`;
          resultsDiv.innerHTML += `${recommendation}`;
          console.log('refresh succesful');

          // 4. Apply gradients (no change needed)
          applyGradientsToRows();

        } catch (error) {
          console.log(error)
          resultsDiv.innerHTML += `${recommendation}`;
        }
        //await contentComparisonToDatabase();

      } catch (error) {
        console.log(error);
        try {
        } catch (error) {
        }
      }
    }

    function createAnalysisTable(data, keyword, targetUrls) {
      let tableHTML = '<table id="analysisTable" class="display table table-striped table-hover">';
      tableHTML += '<tr><th>URL</th>';

      const urls = Object.keys(data);
      urls.forEach(url => {
        tableHTML += `<th ${targetUrls.includes(url) && keyword ? 'class="targetUrl"' : ''}>
                      <a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a></th>`;
      });
      tableHTML += '</tr>';


      // Add Word Count row
      tableHTML += '<tr><td>Word Count</td>';
      urls.forEach(url => {
        try {
          tableHTML += `<td data-value="${data[url].word_count}">${data[url].word_count}</td>`;
        } catch (error) {
          tableHTML += `<td data-value="0">0</td>`;
        }
      });
      tableHTML += '</tr>';

      // Add Page Type row
      tableHTML += '<tr><td>Page Type</td>';
      urls.forEach(url => {
        try {
          tableHTML += `<td>${data[url].page_type}</td>`;
        } catch (error) {
          tableHTML += `<td>-</td>`;
        }
      });
      tableHTML += '</tr>';

      // Add headings rows
      tableHTML += '<tr><td>h1</td>';
      urls.forEach(url => {
        try {
          tableHTML += `<td> • ${data[url].h1.join('<br> • ')}</td>`;
        } catch (error) {
          tableHTML += `<td>-</td>`;
        }
      });
      tableHTML += '</tr>';

      tableHTML += '<tr><td>h2</td>';
      urls.forEach(url => {
        try {
          tableHTML += `<td> • ${data[url].h2.join('<br> • ')}</td>`;
        } catch (error) {
          tableHTML += `<td>-</td>`;
        }
      });
      tableHTML += '</tr>';

      tableHTML += '<tr><td>h3</td>';
      urls.forEach(url => {
        try {
          tableHTML += `<td> • ${data[url].h3.join('<br> • ')}</td>`;
        } catch (error) {
          tableHTML += `<td>-</td>`;
        }
      });
      tableHTML += '</tr>';

      // Get all unique topics, handling missing topics
      let allTopics = [];
      urls.forEach(url => {
        if (data[url] && data[url].topics) {
          allTopics = [...allTopics, ...Object.keys(data[url].topics)];
        }
      });
      const uniqueTopics = [...new Set(allTopics)];

      // Add Topic rows (handling missing topic data)
      uniqueTopics.forEach(topic => {
        tableHTML += `<tr><td>${topic.replaceAll('_', ' ')}</td>`;
        urls.forEach(url => {
          const value = (data[url] && data[url].topics && data[url].topics[topic]) ? data[url].topics[topic] : 0;
          tableHTML += `<td data-value="${value}">${value}</td>`;
        });
        tableHTML += '</tr>';
      });

      tableHTML += '</table>';
      return tableHTML;
    }

    function applyGradientsToRows() {
      const table = document.getElementById('analysisTable');
      for (let i = 1; i < table.rows.length; i++) { // Start from row 1 to skip header
        applyGradientToRow(table.rows[i]);
      }
    }

    function applyGradientToRow(row) {
      const values = Array.from(row.cells)
        .slice(1) // Skip the first cell (topic name)
        .map(cell => {
          const value = parseFloat(cell.dataset.value);
          return isNaN(value) ? -1 : value; // Assign -1 for non-numeric values
        });

      const max = Math.max(...values);
      const min = Math.min(...values);

      values.forEach((value, index) => {
        const cell = row.cells[index + 1]; // +1 to account for the first cell
        if (!isNaN(value) && value !== -1) { // Apply gradient only to numeric values
          const percent = (value - min) / (max - min);
          const red = Math.round(255 * (1 - percent));
          const green = Math.round(255 * percent);
          cell.style.backgroundColor = `rgb(${red}, ${green}, 0)`;
        }
      });
    }

    function removeFaqItem(button) {
      const item = button.parentNode;
      item.remove();
      updateSchema(); // Update the schema after removing an item
    }

    let breadcrumbItemCount = 2; // Start with 2 items

    function addItem() {
      breadcrumbItemCount++;
      const breadcrumbItemsDiv = document.getElementById('breadcrumb-items');
      const newItem = document.createElement('div');
      newItem.className = "breadcrumb-item";
      newItem.innerHTML = `
          <input type="text" class="form-control" id="name${breadcrumbItemCount}" placeholder="Page #${breadcrumbItemCount}'s name" oninput="updateSchema()">
          <input type="url" class="form-control" id="url${breadcrumbItemCount}" placeholder="URL #${breadcrumbItemCount}" oninput="updateSchema()">
          <button class="btn btn-icon btn-round btn-danger"  style="margin: 5px 0 20px 0;" onclick="removeItem(this)">x</button>
      `;
      breadcrumbItemsDiv.appendChild(newItem);

      // Attach event listeners to new elements
      newItem.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', updateSchema);
      });

      updateSchema();
    }


    function removeItem(button) {
      const item = button.parentNode;
      item.remove();
      updateSchema();
    }

    const schemaTypeSelect = document.getElementById('schema-type');
    const inputFieldsDiv = document.getElementById('input-fields');
    const schemaOutputDiv = document.getElementById('schema-output');

    const templates = {
      "LocalBusiness": Handlebars.compile(document.getElementById('local-business-template').innerHTML),
      "Product": Handlebars.compile(document.getElementById('product-template').innerHTML),
      "Event": Handlebars.compile(document.getElementById('event-template').innerHTML),
      "Article": Handlebars.compile(document.getElementById('article-template').innerHTML),
      "BreadcrumbList": Handlebars.compile(document.getElementById('breadcrumblist-template').innerHTML),
      "FAQPage": Handlebars.compile(document.getElementById('faqpage-template').innerHTML),
      "HowTo": Handlebars.compile(document.getElementById('howto-template').innerHTML),
      "JobPosting": Handlebars.compile(document.getElementById('jobposting-template').innerHTML),
      "Organization": Handlebars.compile(document.getElementById('organization-template').innerHTML),
      "Person": Handlebars.compile(document.getElementById('person-template').innerHTML),
      "VideoObject": Handlebars.compile(document.getElementById('video-object-template').innerHTML),
      "Website": Handlebars.compile(document.getElementById('website-template').innerHTML),
    }

    let faqItemCount = 1;

    schemaTypeSelect.addEventListener('change', () => {
      const selectedType = schemaTypeSelect.value;
      const template = templates[selectedType];

      if (template) {
        inputFieldsDiv.innerHTML = template();
        updateSchema(); // Initial update after template render
      } else {
        inputFieldsDiv.innerHTML = ''; // Clear if no template exists
        schemaOutputDiv.textContent = '';
      }


      // Add event listeners after rendering the template
      inputFieldsDiv.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', updateSchema);
      });
    });

    // Initial setup (trigger the change event once to populate fields for default type)
    schemaTypeSelect.dispatchEvent(new Event('change'));

    function updateSchema() {
      const selectedType = schemaTypeSelect.value;
      const data = {};

      // Gather input values based on the selected schema type
      for (const input of inputFieldsDiv.querySelectorAll('input')) {
        data[input.id] = input.value;
      }

      try {

        const schema = {
          "@context": "https://schema.org",
          "@type": selectedType,
          ...data // Spread the input data into the schema object
        };

        // Special handling for fields that require JSON-LD structures:
        if (selectedType === "FAQPage" && data.mainEntity) {
          schema.mainEntity = JSON.parse(data.mainEntity);
        }
        if (selectedType === "BreadcrumbList" && data.itemListElement) {
          schema.itemListElement = JSON.parse(data.itemListElement);
        }

        if (selectedType === "BreadcrumbList") {
          const itemListElement = [];

          for (let i = 1; i <= breadcrumbItemCount; i++) {
            const name = document.getElementById(`name${i}`);
            const url = document.getElementById(`url${i}`);

            if (name && url && name.value && url.value) {
              itemListElement.push({
                "@type": "ListItem",
                "position": i,
                "name": name.value,
                "item": url.value
              });
            }

          }
          if (itemListElement.length > 0) {
            schema.itemListElement = itemListElement;
          }

        }


        if (selectedType === "FAQPage") {
          const mainEntity = [];


          for (let i = 1; document.getElementById(`question${i}`); i++) {
            const question = document.getElementById(`question${i}`).value;
            const answer = document.getElementById(`answer${i}`).value;

            if (question && answer) {  // Make sure both question and answer are filled
              mainEntity.push({
                "@type": "Question",
                "name": question,
                "acceptedAnswer": {
                  "@type": "Answer",
                  "text": answer
                }
              });
            }

          }

          if (mainEntity.length > 0) { // Only add mainEntity if there are FAQ items
            schema.mainEntity = mainEntity;
          }

        }

        schemaOutputDiv.textContent = '<script type="application/ld+json">\n' + JSON.stringify(schema, null, 2) + '\n<\/script>';

      } catch (error) {
        schemaOutputDiv.textContent = "Invalid JSON-LD input in one of the fields.";
        console.error("JSON Parsing Error:", error);
      }
    }

    function addFaqItem() {
      faqItemCount++;
      const faqItemsDiv = document.getElementById('faq-items');
      const newItem = document.createElement('div');
      newItem.className = "faq-item";
      newItem.innerHTML = `
        <input type="text"  class="form-control" id="question${faqItemCount}" placeholder="Question #${faqItemCount}" oninput="updateSchema()">
        <textarea  class="form-control" id="answer${faqItemCount}" placeholder="Answer" oninput="updateSchema()"></textarea>
        <button class="btn btn-icon btn-round btn-danger" style="margin: 5px 0 20px 0;" onclick="removeFaqItem(this)">x</button>
    `;
      faqItemsDiv.appendChild(newItem);

      // Attach event listeners to new elements
      newItem.querySelectorAll('input, textarea').forEach(input => {
        input.addEventListener('input', updateSchema);
      });

      updateSchema();
    }

    async function checkKeywordsRelevancy() {
      document.getElementById('removeKeywordsCard').style.display = 'none';
      const domain = document.getElementById('keyword_analysis_url').value;
      const keywordsTextarea = document.getElementById('keyword_analysis_keywords');
      const keywords = keywordsTextarea.value.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);
      const language = document.getElementById('keywordAnalysisLanguage').value;
      const country = document.getElementById('keywordAnalysisCountry').value;

      try {
        const dataResponse = await fetch("https://s340antute.execute-api.ap-southeast-1.amazonaws.com/checkKeywordRelevance", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            keywords: keywords,
            domain: domain
          })
        });

        if (!dataResponse.ok) {
          throw new Error(`HTTP error! status: ${dataResponse.status}`);
        }

        const data = await dataResponse.json();

        // Extract non-related keywords

        nonRelatedKeywords = "";

        nonRelatedKeywords = data.keywords.filter(keyword => !keyword.related).map(keyword => keyword.keyword);

        // Populate the table with non-related keywords
        if (nonRelatedKeywords.length > 0) {
          populateIrrelevantKeywordsTable(nonRelatedKeywords, keywordsTextarea); // Pass the textarea element
        } else {
          getSimilarKeywords();
          // Run getTimeToRank concurrently for each keyword
          const timeToRankPromises = keywords.map(keyword => getTimeToRank(keyword, language, country, domain)); // Assuming language, location, urlValue are defined elsewhere.  Important: pass target URL here.
          await Promise.all(timeToRankPromises);
        }

      } catch (error) {
        console.error("Error during keyword relevancy check:", error);
      } finally {
        mapKeywords();
        keywords.forEach(keyword => {
          //contentComparisonAnalysis(keyword);
        });
        document.getElementById('keywordAnalysisSubmit').innerHTML = 'Submit';
      }
    }

    function populateIrrelevantKeywordsTable(keywords, keywordsTextarea) {
      const tableBody = document.getElementById('removeKeywordsTable').querySelector('tbody');
      tableBody.innerHTML = ''; // Clear existing table content

      keywords.forEach(keyword => {
        const row = tableBody.insertRow();
        const keywordCell = row.insertCell();
        const removeCell = row.insertCell();

        keywordCell.textContent = keyword;

        const removeButton = document.createElement('button');
        removeButton.textContent = 'Remove';
        removeButton.classList.add('btn', 'btn-danger', 'btn-sm'); // Add Bootstrap button classes

        removeButton.addEventListener('click', () => {
          // Remove the row from the table when the button is clicked
          tableBody.removeChild(row);

          // Remove the keyword from the textarea
          removeKeywordFromTextarea(keyword, keywordsTextarea);

        });

        removeCell.appendChild(removeButton);
      });
      document.getElementById('removeKeywordsCard').style.display = 'block';
    }

    function removeKeywordFromTextarea(keywordToRemove, keywordsTextarea) {
      const currentKeywords = keywordsTextarea.value.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);
      const updatedKeywords = currentKeywords.filter(keyword => keyword !== keywordToRemove);
      keywordsTextarea.value = updatedKeywords.join('\n'); // Update the textarea with newline-separated keywords
    }

    function removeMockData() {
      document.getElementById("queriedKeywordsCard").innerHTML = `
              <div class="card-header">
                <h4 id="queriedKeywordsHeader" class="card-title">Rank Checker</h4>
              </div>
              <div class="card-body">
                <div class="table-responsive" style="height: auto;">
                  <table id="queriedKeywordsTable" class="display table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>No.</th>
                        <th>Keyword</th>
                        <th>Current Rank</th>
                        <th>URL</th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                </div>
              </div>`;
      document.getElementById("queriedKeywordsCard").style.display = "none";

      document.getElementById("combinedCards").innerHTML = `
                <div class="card-body">
                  <ul class="nav nav-pills nav-secondary" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                      <a class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" href="#pills-home" role="tab" aria-controls="pills-home" aria-selected="true">Ranked Keywords</a>
                    </li>
                    <li class="nav-item" role="presentation">
                      <a class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" href="#pills-profile" role="tab" aria-controls="pills-profile" aria-selected="false" tabindex="-1">Similar Keywords</a>
                    </li>
                    <li class="nav-item" role="presentation">
                      <a class="nav-link" id="pills-contact-tab" data-bs-toggle="pill" href="#pills-contact" role="tab" aria-controls="pills-contact" aria-selected="false" tabindex="-1">Based on Content</a>
                    </li>
                  </ul>
                  <div class="tab-content mt-2 mb-3" id="pills-tabContent">
                    <div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="pills-ranking-tab">
                      <div class="table-responsive" style="height: 487px;">
                        <table id="rankingKeywordsTable" class="display table table-striped table-hover">
                          <thead>
                            <tr>
                              <th>Keyword</th>
                              <th>Search Vol</th>
                              <th>Rank</th>
                              <th>CPC</th>
                              <th>Add</th>
                            </tr>
                          </thead>
                          <tbody>
                          </tbody>
                        </table>
                      </div>
                    </div>
                    <div class="tab-pane fade show" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab">
                      <div class="table-responsive">
                        <table id="similarKeywordsTable" class="display table table-striped table-hover">
                          <thead>
                            <tr>
                              <th>Keyword</th>
                              <th>Search Vol</th>
                              <th>Difficulty</th>
                              <th>CPC</th>
                              <th>Add</th>
                            </tr>
                          </thead>
                          <tbody>
                          </tbody>
                        </table>
                      </div>
                    </div>
                    <div class="tab-pane fade show" id="pills-contact" role="tabpanel" aria-labelledby="pills-contact-tab">
                      <div class="table-responsive">
                        <table id="webpageKeywordsTable" class="display table table-striped table-hover">
                          <thead>
                            <tr>
                              <th>Keyword</th>
                              <th>Search Vol</th>
                              <th>Competition</th>
                              <th>Search Intent</th>
                              <th>Reason</th>
                              <th>Add</th>
                            </tr>
                          </thead>
                          <tbody>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
            `;

      document.getElementById("combinedCards").style.display = "none";

      document.getElementById("keywordMappingCard").innerHTML = `
              <div class="card-header">
                <div class="card-title">Keyword Mapping</div>
              </div>
              <div class="card-body">
                <div class="d-flex justify-content-start mb-3">
                  <button class="btn btn-success me-2" onclick="addNewList()"><i class="fas fa-plus me-1"></i> Add New
                    URL</button>
                  <button class="btn btn-secondary" onclick="undoDelete()"><i class="fas fa-undo me-1"></i> Undo
                    Delete</button>
                </div>
                <div class="containerForMapping" id="listsContainer"></div>
                <div class="d-flex justify-content-around flex-wrap">
                  <div class="card shadow-sm mb-3" style="width: 280px;"></div>
                </div>
                <div id="onPageRecommendations"></div>
              </div>`;
      document.getElementById("keywordMappingCard").style.display = "none";

      document.getElementById('serpCard').innerHTML = `
                <div class="card-header">
                  <h4 id="serpHeader" class="card-title">SERP</h4>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table id="serpTable" class="display table table-striped table-hover" data-sort-direction="asc>
                      <thead>
                        <tr>
                          <th>Rank</th>
                          <th>URL</th>
                          <th>Title</th>
                          <th>Description</th>
                          <th>DA</th>
                        </tr>
                      </thead>
                      <tbody>
                      </tbody>
                    </table>
                  </div>
                </div>`;
      document.getElementById("serpCard").style.display = "none";

      document.getElementById('keywordsSummaryCard').innerHTML = `
              <div class="card-header">
                <h4 id="keywordsSummaryHeader" class="card-title">Keywords Summary</h4>
              </div>
              <div class="card-body">
                <div class="table-responsive" style="height: auto;">
                  <table id="overall-summary" class="display table table-striped table-hover">
                  </table>
                </div>
              </div>`;
      document.getElementById('keywordsSummaryCard').style.display = "none";
    }

    function mockDataDemo() {
      document.getElementById("queriedKeywordsCard").innerHTML = `
              <div class="card-header">
                <h4 id="queriedKeywordsHeader" class="card-title">Rank Checker</h4>
              </div>
              <div class="card-body">
                <div class="table-responsive" style="height: auto;">
                  <table id="queriedKeywordsTable" class="display table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>No.</th>
                        <th>Keyword</th>
                        <th>Current Rank</th>
                        <th>URL</th>
                      </tr>
                    </thead>
                    <tbody><tr><td>1</td><td>digital marketing singapore</td><td>21</td><td><a href="https://mediaonemarketing.com.sg/" target="_blank">https://mediaonemarketing.com.sg/</a></td></tr><tr><td>1</td><td>digital marketing singapore</td><td>81</td><td><a href="https://mediaonemarketing.com.sg/top-digital-marketing-agencies-singapore/" target="_blank">https://mediaonemarketing.com.sg/top-digital-marketing-agencies-singapore/</a></td></tr></tbody>
                  </table>
                </div>
              </div>`;

      document.getElementById("queriedKeywordsCard").style.display = "block";


      document.getElementById("keywordMappingCard").innerHTML = `
              <div class="card-header">
                <div class="card-title">Keyword Mapping</div>
              </div>
              <div class="card-body">
                <div class="d-flex justify-content-start mb-3">
                  <button class="btn btn-success me-2" onclick="addNewList()"><i class="fas fa-plus me-1"></i> Add New
                    URL</button>
                  <button class="btn btn-secondary" onclick="undoDelete()"><i class="fas fa-undo me-1"></i> Undo
                    Delete</button>
                </div>
                <div class="containerForMapping" id="listsContainer"></div>
                <div class="d-flex justify-content-around flex-wrap">
                  <div class="card shadow-sm mb-3" style="width: 280px;"></div>
                </div>
                <div id="onPageRecommendations"></div>
              </div>`;
      document.getElementById("keywordMappingCard").style.display = "none";

      document.getElementById("combinedCards").innerHTML = `
                <div class="card-body">
                  <ul class="nav nav-pills nav-secondary" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                      <a class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" href="#pills-home" role="tab" aria-controls="pills-home" aria-selected="true">Ranked Keywords</a>
                    </li>
                    <li class="nav-item" role="presentation">
                      <a class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" href="#pills-profile" role="tab" aria-controls="pills-profile" aria-selected="false" tabindex="-1">Similar Keywords</a>
                    </li>
                    <li class="nav-item" role="presentation">
                      <a class="nav-link" id="pills-contact-tab" data-bs-toggle="pill" href="#pills-contact" role="tab" aria-controls="pills-contact" aria-selected="false" tabindex="-1">Based on Content</a>
                    </li>
                  </ul>
                  <div class="tab-content mt-2 mb-3" id="pills-tabContent">
                    <div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="pills-ranking-tab">
                      <div class="table-responsive" style="height: 487px;">
                        <table id="rankingKeywordsTable" class="display table table-striped table-hover" data-sort-direction="asc">
                          <thead>
                            <tr>
                              <th style="cursor: pointer;">Keyword</th>
                              <th style="cursor: pointer;">Search Vol</th>
                              <th style="cursor: pointer;">Rank</th>
                              <th style="cursor: pointer;">CPC</th>
                              <th style="cursor: pointer;">Add</th>
                            </tr>
                          </thead>
                          <tbody><tr><td>mycareersfuture</td><td>74000</td><td>23</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>google images</td><td>33100</td><td>8</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>my careers future</td><td>27100</td><td>21</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>singapore linkedin</td><td>18100</td><td>15</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>advertise with google ads</td><td>18100</td><td>22</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>marketing agencies</td><td>9900</td><td>12</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>marketing agency</td><td>9900</td><td>23</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>agency ads</td><td>9900</td><td>15</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>agency marketing</td><td>9900</td><td>17</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>meta business suite</td><td>8100</td><td>20</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>sg website design</td><td>5400</td><td>19</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>website design service singapore</td><td>5400</td><td>19</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>website design companies singapore</td><td>5400</td><td>21</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>singapore website design</td><td>5400</td><td>22</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>website design company singapore</td><td>5400</td><td>22</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>website design services singapore</td><td>5400</td><td>22</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>website design sg</td><td>5400</td><td>22</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>mycareersfuture sg</td><td>4400</td><td>14</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>internsg</td><td>4400</td><td>17</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>social medias</td><td>3600</td><td>7</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>etsy singapore</td><td>3600</td><td>19</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>google gmb</td><td>2900</td><td>14</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>adsense</td><td>2900</td><td>15</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>google tag manager</td><td>2900</td><td>15</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>business grant portal</td><td>2900</td><td>21</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>google adsense</td><td>2900</td><td>17</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>google my business</td><td>2900</td><td>19</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>mycareersfuture singapore</td><td>2400</td><td>17</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>affiliate marketing</td><td>2400</td><td>20</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>camping sites singapore</td><td>2400</td><td>22</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>sg influencer</td><td>1900</td><td>3</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>influencer sg</td><td>1900</td><td>4</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>influencers singapore</td><td>1900</td><td>4</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>singapore influencers</td><td>1900</td><td>4</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>influencer singapore</td><td>1900</td><td>5</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>singapore influencer</td><td>1900</td><td>5</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>marketing agency near me</td><td>1900</td><td>7</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>influencer</td><td>1900</td><td>9</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>marketing agencies near me</td><td>1900</td><td>10</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>blogshops in sg</td><td>1900</td><td>13</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>singapore digital marketing agency</td><td>1900</td><td>13</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>blogshops sg</td><td>1900</td><td>15</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>online marketing agency singapore</td><td>1900</td><td>15</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>sg blogshops</td><td>1900</td><td>17</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>blogshop singapore</td><td>1900</td><td>18</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing companies in singapore</td><td>1900</td><td>18</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>gumtree in singapore</td><td>1900</td><td>18</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>singapore blogshops</td><td>1900</td><td>18</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>google keyword planner</td><td>1900</td><td>19</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing agency singapore</td><td>1900</td><td>22</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>gumtree singapore</td><td>1900</td><td>20</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>business suite</td><td>1600</td><td>12</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>emcee</td><td>1600</td><td>12</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>singapore branding</td><td>1600</td><td>13</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>online shopping</td><td>1600</td><td>19</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>singapore directories</td><td>1600</td><td>14</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>online shopping online</td><td>1600</td><td>16</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>online shopping sites sg</td><td>1600</td><td>16</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>sg online shopping sites</td><td>1600</td><td>16</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>shoppers shop online</td><td>1600</td><td>20</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>online shopping in singapore</td><td>1600</td><td>21</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>online shopping online shopping</td><td>1600</td><td>21</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>shopping shop online</td><td>1600</td><td>21</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>franchises</td><td>1600</td><td>22</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>singapore online sales</td><td>1600</td><td>22</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>emcee singapore</td><td>1300</td><td>1</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>emcees in singapore</td><td>1300</td><td>1</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>emcees singapore</td><td>1300</td><td>1</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>singapore emcee</td><td>1300</td><td>2</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>singapore emcees</td><td>1300</td><td>1</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>reviews glassdoor</td><td>1300</td><td>4</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>franchises in singapore</td><td>1300</td><td>10</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>little red book</td><td>1300</td><td>13</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>bgp portal</td><td>1300</td><td>22</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>franchise singapore</td><td>1300</td><td>21</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>seo agencies in singapore</td><td>1300</td><td>20</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>singapore franchise</td><td>1300</td><td>20</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>seo agencies singapore</td><td>1300</td><td>21</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>seo agency singapore</td><td>1300</td><td>22</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>social media agency singapore</td><td>1000</td><td>2</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>social media marketing agency in singapore</td><td>1000</td><td>3</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>how online earning money</td><td>1000</td><td>4</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>how to earn income online</td><td>1000</td><td>4</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>social media marketing agency singapore</td><td>1000</td><td>4</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>singapore social media marketing agency</td><td>1000</td><td>5</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketers jobs</td><td>1000</td><td>16</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing jobs</td><td>1000</td><td>20</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing vacancies</td><td>1000</td><td>20</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing vacancy</td><td>1000</td><td>20</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>jobs with digital marketing</td><td>1000</td><td>20</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>ppc</td><td>1000</td><td>22</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>seo agencies</td><td>880</td><td>6</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>wordpress and websites</td><td>880</td><td>6</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing agency</td><td>880</td><td>19</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>blogshops singapore</td><td>880</td><td>11</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>how how to make money online</td><td>880</td><td>9</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing advertising agency</td><td>880</td><td>10</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>making money online how</td><td>880</td><td>10</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>business directories singapore</td><td>880</td><td>11</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing ads agency</td><td>880</td><td>11</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>seo optimization services</td><td>880</td><td>11</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>agency digital marketing</td><td>880</td><td>12</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>craigslist singapore</td><td>880</td><td>12</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>business directory singapore</td><td>880</td><td>15</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing and advertising company</td><td>880</td><td>14</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing agencies</td><td>880</td><td>16</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>meta business</td><td>880</td><td>16</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>seo services</td><td>880</td><td>16</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>seo agency</td><td>880</td><td>22</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>agency for digital marketing</td><td>880</td><td>18</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr></tbody>
                        </table>
                      </div>
                    </div>
                    <div class="tab-pane fade show" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab">
                      <div class="table-responsive">
                        <table id="similarKeywordsTable" class="display table table-striped table-hover" data-sort-direction="asc">
                          <thead>
                            <tr>
                              <th style="cursor: pointer;">Keyword</th>
                              <th style="cursor: pointer;">Search Vol</th>
                              <th style="cursor: pointer;">Difficulty</th>
                              <th style="cursor: pointer;">CPC</th>
                              <th style="cursor: pointer;">Add</th>
                            </tr>
                          </thead>
                          <tbody><tr><td>digital marketing singapore</td><td>700</td><td>30</td><td>10.74</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing agency singapore</td><td>1900</td><td>35</td><td>11.99</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital agency singapore</td><td>260</td><td>29</td><td>8.289999961853027</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing company singapore</td><td>1900</td><td>32</td><td>15.649999618530273</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>marketing agencies singapore</td><td>880</td><td>31</td><td>15.15999984741211</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>social media marketing agency singapore</td><td>1000</td><td>27</td><td>9.05</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>best digital marketing agency singapore</td><td>140</td><td>25</td><td>16.790000915527344</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>content marketing agency singapore</td><td>100</td><td>30</td><td>5.86</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>top digital marketing agency singapore</td><td>170</td><td>31</td><td>16.6200008392334</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>top marketing agency singapore</td><td>270</td><td>21</td><td>9.28</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital advertising singapore</td><td>30</td><td>25</td><td>6.95</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>singapore social media agency</td><td>1000</td><td>39</td><td>9.05</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>boutique social media agency singapore</td><td>40</td><td>15</td><td>7.31</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>boutique digital marketing agency singapore</td><td>20</td><td>28</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>best marketing agency singapore</td><td>260</td><td></td><td>14.520000457763672</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>advertising agencies in singapore</td><td>720</td><td>22</td><td>5.08</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>marketing firms singapore</td><td>320</td><td></td><td>12.779999732971191</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>social media marketing agency in singapore</td><td>1000</td><td>30</td><td>9.05</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>online marketing singapore</td><td>210</td><td>36</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>ooh advertising singapore</td><td>60</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing service singapore</td><td>260</td><td>27</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>best digital marketing agency in singapore</td><td>10</td><td>30</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>top digital marketing companies in singapore</td><td>170</td><td>25</td><td>16.6200008392334</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>social media marketing company singapore</td><td>50</td><td>31</td><td>8.37</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing sg</td><td>700</td><td>28</td><td>10.74</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>social media advertising cost singapore</td><td>10</td><td></td><td>2.42</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing cost singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing agency sg</td><td>1900</td><td>33</td><td>11.99</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>social media advertising singapore</td><td>410</td><td>26</td><td>8.61</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>online advertising singapore</td><td>30</td><td>18</td><td>12.16</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>top advertising agency in singapore</td><td>20</td><td></td><td>8.06</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>internet marketing singapore</td><td>210</td><td>33</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>b2b digital marketing agency singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>sem marketing singapore</td><td>50</td><td>31</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>singapore social media marketing agency</td><td>1000</td><td>24</td><td>9.05</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>seo marketing in singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital media agency singapore</td><td>1900</td><td>31</td><td>11.99</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>ecommerce marketing agency singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>best digital marketing company in singapore</td><td>10</td><td>30</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digimarcon singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital media companies in singapore</td><td>10</td><td></td><td>7.34</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>social media marketing cost singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital advertising agency singapore</td><td>1900</td><td>21</td><td>11.99</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>programmatic advertising singapore</td><td>20</td><td>14</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>amobee singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>anjels media digital signage &amp; digital advertising expert singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>best digital agencies singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>best digital agency singapore</td><td>10</td><td>28</td><td>6.92</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital creative agency singapore</td><td>10</td><td>35</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing asia singapore</td><td>90</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing firm singapore</td><td>40</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing solutions singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital squad singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>dstnct singapore</td><td>10</td><td></td><td>6.76</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>equinet academy singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>fenzo digital singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>first page digital singapore 1 digital marketing &amp; seo agency</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>happy marketer singapore</td><td>10</td><td></td><td>11.13</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>ice cube marketing singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>internet marketing agency singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>internet marketing company singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>internet marketing in singapore</td><td>210</td><td>33</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>metia singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>online marketing agency singapore</td><td>1900</td><td>29</td><td>15.649999618530273</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>online marketing company singapore</td><td>20</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>online marketing seo singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>outrankco sg</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>reprise digital singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>search marketing agency singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>sem agency in singapore</td><td>480</td><td>14</td><td>38.369998931884766</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>seo digital marketing agency singapore</td><td>10</td><td>42</td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>seo marketing company in singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>seo sem singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>singapore seo firm</td><td>1400</td><td>30</td><td>17.9</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>smarlling singapore web design &amp; digital marketing agency</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>top digital agencies in singapore</td><td>10</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>web marketing singapore</td><td>210</td><td></td><td></td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr></tbody>
                        </table>
                      </div>
                    </div>
                    <div class="tab-pane fade show" id="pills-contact" role="tabpanel" aria-labelledby="pills-contact-tab">
                      <div class="table-responsive">
                        <table id="webpageKeywordsTable" class="display table table-striped table-hover" data-sort-direction="asc">
                          <thead>
                            <tr>
                              <th style="cursor: pointer;">Keyword</th>
                              <th style="cursor: pointer;">Search Vol</th>
                              <th style="cursor: pointer;">Competition</th>
                              <th style="cursor: pointer;">Search Intent</th>
                              <th style="cursor: pointer;">Reason</th>
                              <th style="cursor: pointer;">Add</th>
                            </tr>
                          </thead>
                          <tbody><tr><td>marketing agency</td><td>9900</td><td>0.29</td><td>commercial</td><td>High search volume and low competition indicate potential for conversions.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing</td><td>3600</td><td>0.44</td><td>commercial</td><td>Widely searched term relevant to industry growth and services offered.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing agency</td><td>880</td><td>0.19</td><td>commercial</td><td>Search volume is substantial, suggesting a viable market.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>agency for marketing</td><td>9900</td><td>0.29</td><td>commercial</td><td>High volume and moderate competition make it attractive for SEO efforts.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>social media marketing agency</td><td>480</td><td>0.11</td><td>commercial</td><td>Low competition indicates a higher chance for rank success.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing agency singapore</td><td>1900</td><td>0.13</td><td>commercial</td><td>Location-specific keyword with good volume and low competition.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>best marketing agency</td><td>140</td><td>0.06</td><td>informational</td><td>Targets users looking for top services, ideal for building authority.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>content marketing</td><td>590</td><td>0.19</td><td>informational</td><td>Relevant for driving traffic in the content space with low competition.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>best digital marketing agency</td><td>140</td><td>0.06</td><td>commercial</td><td>Focuses on high-conversion searches for agency services.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>performance marketing</td><td>390</td><td>0.34</td><td>commercial</td><td>It addresses a critical area in marketing with a growing interest.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>advertising agency singapore</td><td>720</td><td>0.29</td><td>commercial</td><td>Local relevance and appropriate search volume for targeted marketing.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>marketing strategies</td><td>880</td><td>0.3</td><td>informational</td><td>Focuses on users seeking insights, helpful for content marketing.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing services</td><td>320</td><td>0.06</td><td>commercial</td><td>Low competition and high search intent indicate a positive opportunity.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>google ads agency singapore</td><td>140</td><td>0.07</td><td>commercial</td><td>Specific to a location and service, low competition.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>marketing digital marketing</td><td>3600</td><td>0.44</td><td>commercial</td><td>Combines two high-interest keywords for targeted SEO.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing course singapore</td><td>880</td><td>0.46</td><td>informational</td><td>Focuses on education and training for growing digital marketing skills.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>why digital marketing</td><td>10</td><td>0</td><td>informational</td><td>Addresses the curiosity of new marketers, high traffic potential.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>sem agency singapore</td><td>480</td><td>0.07</td><td>commercial</td><td>Niche keyword with low competition, targeting specific services.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>social media marketing agency singapore</td><td>1000</td><td>0.14</td><td>commercial</td><td>Threshold of high volume for commercial potential with local focus.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>top digital marketing agency</td><td>140</td><td>0.06</td><td>commercial</td><td>Focused on competitive agency services providing significant visibility.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital advertising agency singapore</td><td>10</td><td>0</td><td>commercial</td><td>Specific to location with minimal competition, suggesting higher rankings.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>internet marketing companies</td><td>10</td><td>0</td><td>commercial</td><td>Categorical keyword relevant to numerous small firms in the agency space.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>freelance digital marketing agency</td><td>10</td><td>0</td><td>commercial</td><td>Addresses the growing gig economy in marketing services.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>social media management agency</td><td>10</td><td>0</td><td>commercial</td><td>Captures a niche service area with high local demand.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>search engine marketing services</td><td>10</td><td>0</td><td>commercial</td><td>Focused on essential services many businesses wish to engage with.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>agency marketing</td><td>9900</td><td>0.29</td><td>commercial</td><td>Engages an audience seeking marketing solutions with high intent.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>agency marketing solutions</td><td>10</td><td>0</td><td>commercial</td><td>Keywords target agency practices for clients looking for innovative solutions.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>performance digital marketing</td><td>10</td><td>0</td><td>commercial</td><td>Captures a growing trend focusing on measurable outcomes in marketing.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>top digital marketing companies</td><td>10</td><td>0</td><td>commercial</td><td>Useful for comparative rankings, which appeals to many businesses.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>international digital marketing agency</td><td>10</td><td>0</td><td>commercial</td><td>Focuses on global outreach strategies, appealing to diverse markets.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>effective marketing services</td><td>10</td><td>0</td><td>commercial</td><td>Targets businesses needing impactful marketing strategies.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>results oriented marketing</td><td>10</td><td>0</td><td>commercial</td><td>Appeals to clients focused on results and ROI from marketing.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing assistant</td><td>10</td><td>0</td><td>commercial</td><td>Attracts freelancers and assistants in the digital agency ecosystem.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>local marketing experts</td><td>10</td><td>0</td><td>commercial</td><td>Niche expert focus for tailored services in local markets.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>agency for digital marketing</td><td>10</td><td>0</td><td>commercial</td><td>Specific search for agencies underlines relevance and niche targeting.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>affordable digital marketing</td><td>10</td><td>0</td><td>commercial</td><td>Captures price-sensitive clients seeking effective marketing solutions.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>online marketing services</td><td>10</td><td>0</td><td>commercial</td><td>Broad applicability and relevance to current marketing needs.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>local agency marketing</td><td>10</td><td>0</td><td>commercial</td><td>Focus on locality for tailored agency marketing strategies.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>local advertising solutions</td><td>10</td><td>0</td><td>commercial</td><td>Targets businesses seeking local level engagement strategies.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>promotional agency</td><td>10</td><td>0</td><td>commercial</td><td>Concentrates on a service that is evergreen and sought after by brands.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>ideal marketing agency</td><td>10</td><td>0</td><td>informational</td><td>Helpful for users seeking guidance on specific marketing agency qualifications.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>performance marketing agency</td><td>10</td><td>0</td><td>commercial</td><td>Targets those interested in outcomes-driven marketing services.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>effective internet marketing</td><td>10</td><td>0</td><td>informational</td><td>A highly relevant question in the current marketing climate.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>marketing agency news</td><td>10</td><td>0</td><td>informational</td><td>Keeps industry participants informed about changes, trends, and updates.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing research</td><td>10</td><td>0</td><td>informational</td><td>Vital for professionals looking for the latest data and analyses in the field.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing opportunities</td><td>10</td><td>0</td><td>informational</td><td>Focuses on career and business prospects in the growing digital landscape.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>marketing agency costs</td><td>10</td><td>0</td><td>informational</td><td>Informs clients on budgeting and price trends in agency services.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>best online marketing tools</td><td>10</td><td>0</td><td>informational</td><td>Captures interest for quality tools aiding digital marketing efforts.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>social media advertising agency</td><td>10</td><td>0</td><td>commercial</td><td>Vital service for brands wanting to leverage social media visibility.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>successful marketing tools</td><td>10</td><td>0</td><td>informational</td><td>Promotes understanding of effective software and tools in agencies.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>site marketing agency</td><td>10</td><td>0</td><td>commercial</td><td>Highlights marketing potential of agency services that help structure site visibility.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital marketing campaigns</td><td>10</td><td>0</td><td>informational</td><td>Focuses on the effectiveness of various campaigns in digital spaces.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>best digital marketing tools</td><td>10</td><td>0</td><td>informational</td><td>A comprehensive search for the most effective tools to use in marketing.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>sg digital marketing agencies</td><td>10</td><td>0</td><td>commercial</td><td>Targets a specific market with tailored, location-specific agencies.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>market research agency</td><td>10</td><td>0</td><td>informational</td><td>Addresses a critical need for businesses to understand their market landscape.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>advertising platforms</td><td>10</td><td>0</td><td>informational</td><td>Help brands find platforms for effective advertising.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>branding agency services</td><td>10</td><td>0</td><td>commercial</td><td>Focuses on important elements of branding within marketing.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>b marketing agency</td><td>10</td><td>0</td><td>commercial</td><td>Simplicity allows easy understanding and searchability.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>award winning advertising agency</td><td>10</td><td>0</td><td>informational</td><td>Appeals to businesses looking for the best in award-winning services.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>global marketing agency</td><td>10</td><td>0</td><td>commercial</td><td>Essential for brands looking to expand marketing outreach globally.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>growth digital marketing</td><td>10</td><td>0</td><td>commercial</td><td>Signals rising trends in marketing related to growth strategies.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>digital design agency</td><td>10</td><td>0</td><td>commercial</td><td>Combining design and digital marketing appeals to many clients.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>marketing strategy company</td><td>10</td><td>0</td><td>commercial</td><td>Targets agencies offering strategic marketing solutions.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr><tr><td>how to choose marketing agency</td><td>10</td><td>0</td><td>informational</td><td>Helps clients navigate the often complex agency selection process.</td><td><i class="fas fa-plus-circle clickable-plus"></i></td></tr></tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              `;
      document.getElementById("combinedCards").style.display = "block";

      document.getElementById("keywordMappingCard").innerHTML = `
              <div class="card-header">
                <div class="card-title">Keyword Mapping</div>
              </div>
              <div class="card-body">
                <div class="d-flex justify-content-start mb-3">
                  <button class="btn btn-success me-2" onclick="addNewList()"><i class="fas fa-plus me-1"></i> Add New
                    URL</button>
                  <button class="btn btn-secondary" onclick="undoDelete()"><i class="fas fa-undo me-1"></i> Undo
                    Delete</button>
                </div>
                <div class="containerForMapping" id="listsContainer"><div class="list-container"><input type="text" class="border rounded p-2 flex-grow-1 me-2" style = "width:80%;"value="targeted-domain/url"><button class="btn btn-sm btn-outline-danger"><i class="fas fa-times" <="" i=""></i></button><ul id="list1" class="keyword-list"><li draggable="true" id="digital marketing singapore">digital marketing singapore</li></ul><button class="btn btn-primary w-100" style="display: block;">AI Prompt for Content Writing</button></div></div>
                <div class="d-flex justify-content-around flex-wrap">
                  <div class="card shadow-sm mb-3" style="width: 280px;"></div>
                </div>
                <div id="onPageRecommendations"></div>
              </div>`;
      document.getElementById("keywordMappingCard").style.display = "block";

      document.getElementById('serpCard').innerHTML = `
                <div class="card-header">
                  <h4 id="serpHeader" class="card-title">SERP for flyers in singapore</h4>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table id="serpTable" class="display table table-striped table-hover" data-sort-direction="asc">
                      <thead>
                        <tr>
                          <th>Rank</th>
                          <th>URL</th>
                          <th>Title</th>
                          <th>Description</th>
                          <th>DA</th>
                        </tr>
                      </thead>
                      <tbody><tr><td>1</td><td>https://www.singaporeflyer.com/?srsltid=AfmBOorfxv-XaM4gLHTLCtiGzjJEUrxvNi0nKFcO_MAQjDaydK3I3Viv</td><td>Singapore Flyer: Home</td><td>Singapore Flyer, one of the largest observation wheels in the world. Marvel at the breathtaking views of Marina Bay from the Singapore Flyer's capsules.</td><td></tr><tr><td>2</td><td>https://www.gogoprint.sg/flyers.html?srsltid=AfmBOoqpyXwW0S5tLaKwR19BWCuiXw4NspO6wwHWvwewkvw0jDQypXwi</td><td>Economy Flyer Printing Singapore</td><td>Affordable economy flyer printing options starting at S$5.45. Choose from art &amp; simili paper options (min 100 pcs). Same-day delivery in Singapore&nbsp;...</td></tr><tr><td>3</td><td>https://www.alibabaprinting.sg/flyer-distribution-laws-in-singapore-2025-guidelines/?srsltid=AfmBOoorPa9hpuEeonDDatgSKFXEzs2tVMAAtQuuwjjJski_gcs6zZam</td><td>Flyer Distribution Laws in Singapore 2025 | Guidelines</td><td>Where are businesses allowed to distribute flyers in Singapore? Businesses can hand out flyers in public spots like flyer zones, walkways, and&nbsp;...</td></tr><tr><td>4</td><td>https://www.vistaprint.sg/marketing-materials/flyers?srsltid=AfmBOoo641qrWHY-bAMs-MbBtRtlDqbILxlA8mjrVYXM9JD-4qTSSQtm</td><td>Flyer Printing: Make a pamphlet in DL or A3-A7</td><td>Flyers and pamphlets printed by Vistaprint Singapore are a great way to tell your customers a complete story about your business.</td></tr><tr><td>5</td><td>http://www.flyer.com.sg/</td><td>24 Hours Printing Services, Cheapest Flyer Printing Singapore</td><td>We specialize primarily in the printing and distribution of flyers into HBD units, Commercial offices, Street, landed Properties and Cars.</td></tr><tr><td>6</td><td>https://flyerdistributionsg.com.sg/</td><td>Flyer Distribution SG</td><td>Flyer Distribution SG provides a one stop solution offering Printing, Flyer Design and seeks to help you to reach out to your target audience effectively&nbsp;...</td></tr><tr><td>7</td><td>https://www.gogoprint.sg/printing/flyers.html?srsltid=AfmBOoqd32BoiWxfJoY0k4M_KUHbsFIXL6WL923q4AzgSroUkdZ9hOs9</td><td>Affordable Flyer Printing Singapore</td><td>Starting from S$5.45, print quality leaflets &amp; brochures with a variety of paper, refinement &amp; size options. Same-day delivery in Singapore available!</td></tr><tr><td>8</td><td>https://www.singaporeflyer.com/en/ticket/singapore-flyer-ticket?srsltid=AfmBOoryc-uOD5O5dSdcYCogyPMIqQzVUU7ER371TR1rEm4490fOUsoD</td><td>Singapore Flyer Ticket</td><td>Step into a whole new perspective aboard the iconic Singapore Flyer, one of the world's largest observation wheels. Soar 165 metres above ground.</td></tr><tr><td>9</td><td>https://www.eight.sg/</td><td>Flyer Printing | Cheapest 24 Hour Services | Express | Fast ...</td><td>Discover top-notch flyer printing services in Singapore. At our renowned printing company, we provide affordable options for high-quality print flyers.</td></tr><tr><td>10</td><td>https://www.flyerdistributionsingapore.com/flyer-distribution-singapore/</td><td>FLYER DISTRIBUTION Singapore</td><td>Flyer Distribution in Singapore, Car Park Flyer Distribution, Flyer Distribution Landed, Commercial Flyer Distribution, Condo Flyer Distribution, Door To Door&nbsp;...</td></tr></tbody>
                    </table>
                  </div>
                </div>`;
      document.getElementById("serpCard").style.display = "block";

      document.getElementById('keywordsSummaryCard').innerHTML = `
              <div class="card-header">
                <h4 id="keywordsSummaryHeader" class="card-title">Keywords Summary</h4>
              </div>
              <div class="card-body">
                <div class="table-responsive" style="height: auto;">
                  <table id="overall-summary" class="display table table-striped table-hover">
              <div class="table-container">
                  
                      </div><thead>
                          <tr>
                              <th>No.</th>
                              <th onclick="sortSummaryTable('keyword')">Keyword</th>
                              <th onclick="sortSummaryTable('search_volume')">Search Volume</th>
                              <th onclick="sortSummaryTable('cpc')">CPC</th>
                              <th onclick="sortSummaryTable('timeToRank')">Time to Rank</th>
                              <th>Reason</th>
                              
                          </tr>
                      </thead>
                      <tbody>
              
                <tr>
                  <td>1</td>
                  <td>digital marketing singapore</td>
                  <td>700</td>
                  <td>10.74</td>
                  <td class="time-to-rank-0-3">0-3 months</td>
                  <td><textarea class="multiline-input" id="reason-0" onchange="updateReason(0, this.value)">This keyword targets a specific, high-demand market, enhancing local visibility and driving relevant traffic to a leading digital marketing agency in Singapore.</textarea></td>
                  </tr>
              
                    </tbody>
                
            
            </table>
                </div>
              </div>`;
      document.getElementById('keywordsSummaryCard').style.display = "block";
    }

    function copySchemaOutput() {
      const schemaOutput = document.getElementById('schema-output');

      if (!schemaOutput) {
        console.error('Schema output element not found.');
        return;
      }

      const schemaText = schemaOutput.textContent;

      if (!schemaText) {
        console.warn('Schema output is empty.');
        return;
      }

      navigator.clipboard.writeText(schemaText)
        .then(() => {
          alert('Schema copied to clipboard!');
        })
        .catch(err => {
          console.error('Failed to copy schema: ', err);
          alert('Failed to copy schema to clipboard.  Please copy manually.');
        });
    }

    function copySocialGeneratedContent() {
      const schemaOutput = document.getElementById('generatedSocialContent');

      if (!schemaOutput) {
        console.error('Generated Social Content not found.');
        return;
      }

      const schemaText = schemaOutput.textContent;

      if (!schemaText) {
        console.warn('Generated Social Content is empty.');
        return;
      }

      navigator.clipboard.writeText(schemaText)
        .then(() => {
          alert('Generated Social Content copied to clipboard!');
        })
        .catch(err => {
          console.error('Failed to copy Generated Social Content: ', err);
          alert('Failed to copy Generated Social Content clipboard.  Please copy manually.');
        });
    }


    // Help prompts
    const driver = window.driver.js.driver;
    navigation_steps = [
      { element: '#mascotBtn', popover: { title: 'Digimetrics Helper', description: 'Click on me for a guided walkthrough. Click anywhere outside the box at anytime to leave the walkthrough.', side: "left", align: 'center' } },
      { element: '#topNavToggler', popover: { title: 'Top Navigation Toggler', description: 'Click here to expand / hide the listing of functions.', side: "left", align: 'center' } },
      { element: '#navbarNav', popover: { title: 'Top Navigation Toggler', description: 'The green tick shows which functions have been done and the one in bold is the current function that you are on.', side: "left", align: 'center' } },
      { element: '#leftNav', popover: { title: 'Left Navigation Toggler', description: 'You can also expand / collapse the navigational menu here.', side: "left", align: 'center' } },
    ]

    keyword_analysis_steps = [
      { element: '#keywordAnalysisUrlDiv', popover: { title: 'Keyword Analysis', description: 'Start by entering the URL of your target domain or URL Entering this field would allow you to find ranking keywords for the domain/webpage.', side: "bottom", align: 'center' } },
      { element: '#domainOrWebpage', popover: { title: 'Keyword Analysis', description: 'Choose whether you are analysing the whole domain or just one specific URL.', side: "bottom", align: 'center' } },
      { element: '#countryAndLanguage', popover: { title: 'Keyword Analysis', description: 'Choose the Country and Language accordingly.', side: "bottom", align: 'center' } },
      { element: '#keywordAnalysisKeywordsDiv', popover: { title: 'Keyword Analysis', description: 'Enter any targeted keywords here. This is required for the generation of related keywords and also to check the ranking, search volume, CPC, etc. for each keyword.', side: "right", align: 'center' } },
      { element: '#keywordAnalysisSubmit', popover: { title: 'Keyword Analysis', description: 'Click Submit to get Ranking Keywords, Related Keywords, Current Rankings, Keywords based on Page Content and Estimated Time To Rank', onNextClick: () => { mockDataDemo(); driverObj.moveNext(); }, side: "bottom", align: 'center' } },
      { element: '#queriedKeywordsCard', popover: { title: 'Keyword Analysis', description: 'If your queried keywords are ranking for your target, they will appear here. The No. column value will be repeated if the keyword appears in the SERPs more than once.', side: "bottom", align: 'center' } },
      { element: '#pills-tab', popover: { title: 'Keyword Analysis', description: 'There are three tabs on this card.', side: "right", align: 'center' } },
      { element: '#pills-home-tab', popover: { title: 'Keyword Analysis', description: 'Ranked Keywords shows the keywords that your domain or page is ranking for.', side: "right", align: 'center' } },
      { element: '#pills-profile-tab', popover: { title: 'Keyword Analysis', description: 'Similar Keywords shows the keywords that you have entered and more variations of those keywords.', side: "right", align: 'center' } },
      { element: '#pills-contact-tab', popover: { title: 'Keyword Analysis', description: 'Based on content shows the keywords that have been extracted based on your webpage\'s content.', side: "right", align: 'center' } },
      { element: '#rankingKeywordsTable thead', popover: { title: 'Keyword Analysis', description: 'Clicking on the headers will sort the rows by that column.', side: "right", align: 'center' } },
      { element: '#rankingKeywordsTable tr:first-child td:first-child', popover: { title: 'Keyword Analysis', description: 'Clicking on the keyword will load the top 10 SERP results for the keyword', side: "right", align: 'center' } },
      { element: '#serpCard', popover: { title: 'Keyword Analysis', description: 'You can see the top 10 results for the selected keyword in this table including their Domain Authority.', side: "right", align: 'center' } },

      { popover: { title: 'Happy Keywording', description: 'And that is all, go ahead and make magic.' } }
    ]

    const driverObj = driver({
      showProgress: false,
      steps: navigation_steps
    });

    driverObj.drive();

    async function generateSocialContent() {
      const generatedContentDiv = document.getElementById('generatedSocialContent');
      const generateButton = document.getElementById('generateSocialContentBtn');


      // Disable the button and change text
      generateButton.disabled = true;
      generateButton.textContent = 'Generating Content...';


      // Helper function to process URLs
      async function processUrls(urlsText, apiUrl) {
        if (!urlsText) {
          return []; // Return an empty array if the input is blank
        }

        const urls = urlsText.split(/[, \n]+/).filter(url => url.trim() !== "");
        const promises = urls.map(async url => {
          try {
            const response = await fetch(apiUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ "url": url.trim() })
            });
            if (!response.ok) {
              console.error(`Error fetching data from ${url}: ${response.status} - ${response.statusText}`);
              return null;
            }
            return await response.json();
          } catch (error) {
            console.error(`Error fetching data from ${url}:`, error);
            return null;
          }
        });
        return (await Promise.all(promises)).filter(data => data !== null);
      }

      try {
        // Process Brand Guide URLs
        const brandGuideUrlsText = document.getElementById('generator_brand_guide_urls').value;
        const brandGuideData = await processUrls(brandGuideUrlsText, 'https://i3oxhgicub.execute-api.ap-southeast-1.amazonaws.com/pdfParser');

        // Process Reference URLs
        const referenceUrlsText = document.getElementById('reference-url').value;
        const webpageData = await processUrls(referenceUrlsText, 'https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing');

        const contentData = {
          "reference_post": document.getElementById('sample-text').value || "", // Use empty string as default
          "content_type": document.getElementById('content-type').value || "blog-post", //added default
          "post_info": document.getElementById('post-info').value || "",
          "gender": document.getElementById('gender').value || "",
          "age-range": document.getElementById('age-range').value || "",
          "occupation": document.getElementById('occupation').value || "",
          "income": document.getElementById('income').value || "",
          "subgroups": document.getElementById('subgroups').value || "",
          "painpoints": document.getElementById('painpoints').value || "",
          "audience_goal": document.getElementById('audience_goal').value || "",
          "product_service": document.getElementById('product_service').value || "",
          "desired_action": document.getElementById('desired_action').value || "",
          "post_objectives": document.getElementById('post_objectives').value || "",
          "word_count": document.getElementById('word_count').value || "",
          "tone": document.getElementById('tone').value || "",
          "usp": document.getElementById('usp').value || "",
          "pov": document.getElementById('pov').value || "",
          "emojis": document.getElementById('emojis').value || "no", //added default
          "hashtags": document.getElementById('hashtags').value || "no", //added default
          "brand_guide": brandGuideData,
          "webpage_data": webpageData
        };

        const response = await fetch('https://panc0eazwj.execute-api.ap-southeast-1.amazonaws.com/content-generator', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(contentData)
        });

        const data = await response.json();

        // Display the API response or error
        if (response.ok) {
          generatedContentDiv.innerHTML = `<p>${data}</p>`;
        } else {
          generatedContentDiv.innerHTML = `<p class="error">Error: ${data.error || response.statusText}</p>`;
        }
      } catch (error) {
        console.error('Error fetching data:', error);
        generatedContentDiv.innerHTML = '<p class="error">An error occurred while fetching data.</p>';
      } finally {
        // Re-enable the button and reset text
        generateButton.disabled = false;
        generateButton.textContent = 'Generate Content';
      }
      ;
    }

    async function generatePersona() {
      document.getElementById("generatePersonaBtn").innerText = "Generating...";
      const webpagesInput = document.getElementById("persona_webpages").value;
      const manualInput = document.getElementById("persona_manual").value;
      const webpages = webpagesInput.split(/[\s,]+/).filter(url => url.trim() !== "");
      const personaContentDiv = document.getElementById("persona-results");
      let combinedResponses = "";

      try {
        // Fetch data from all URLs concurrently using Promise.all
        const responses = await Promise.all(
          webpages.map(async url => {
            try {
              const response = await fetch("https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({ url: url })
              });

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status} for URL: ${url}`);
              }

              return await response.json(); // Return the parsed JSON data
            } catch (error) {
              console.error(`Error fetching data from ${url}:`, error);
              return null; // Return null in case of an error
            }
          })
        );

        // Combine the responses
        combinedResponses = responses.filter(response => response !== null).map(response => JSON.stringify(response)).join("\n");

        console.log(combinedResponses);

        // Send combined responses to the second API
        try {
          const personaResponse = await fetch("https://tyqj3fni7h.execute-api.ap-southeast-1.amazonaws.com/personaGenerator", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ data: combinedResponses, manual: manualInput })
          });

          if (!personaResponse.ok) {
            throw new Error(`HTTP error! status: ${personaResponse.status} for persona API`);
          }

          const personaData = await personaResponse.json();
          personaContentDiv.innerHTML += personaData.body;

        } catch (error) {
          personaContentDiv.innerHTML = `<p style="color: red;">Error sending data to persona API: ${error.message}</p>`;
          console.error("Error sending data to persona API:", error);
        }

      } catch (error) {
        personaContentDiv.innerHTML = `<p style="color: red;">An error occurred: ${error.message}</p>`;
        console.error("An error occurred:", error);
      } finally {
        document.getElementById("generatePersonaBtn").innerText = "Generate Personas";
      }
    }

    async function checkContent() {
      const brandGuideUrlsText = document.getElementById('brand_guide_urls').value || "";
      const otherUrlsText = document.getElementById('content_check_other_urls').value || "";
      const instructions = document.getElementById('content_check_instructions').value || "";
      const content = document.getElementById('content_to_check').value;

      document.getElementById("contentCheckBtn").innerText = "Checking...";
      document.getElementById("checkContentResults").innerHTML = "";

      // **Check if the content field is blank**
      if (!content || content.trim() === "") {
        alert("Please enter content to check.");
        document.getElementById("contentCheckBtn").innerText = "Check Content"; // Reset button text
        return;
      }


      // Split URLs by commas or newlines, and trim whitespace
      const brandGuideUrls = brandGuideUrlsText.split(/[, \n]+/).filter(url => url.trim() !== "");  //filter is important to remove empty strings
      const otherUrls = otherUrlsText.split(/[, \n]+/).filter(url => url.trim() !== ""); //filter is important to remove empty strings

      const allUrls = [...brandGuideUrls, ...otherUrls];  // Combine the arrays

      if (allUrls.length === 0) {
        console.warn("No URLs provided.");
        alert("Please enter at least one URL."); // Optional: provide user feedback
        document.getElementById("contentCheckBtn").innerText = "Check Content"; // Reset button text
        return;
      }

      // API endpoints
      const pdfParserApiUrl = "https://i3oxhgicub.execute-api.ap-southeast-1.amazonaws.com/pdfParser";
      const checkContentApiUrl = "https://mmyvj7yj11.execute-api.ap-southeast-1.amazonaws.com/checkContent";
      const contentParsingApiUrl = "https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing"; // Added content parsing API URL

      try {
        // Create an array of promises for the brand guide URLs API calls
        const brandGuideFetchPromises = brandGuideUrls.map(async url => {
          try {
            const response = await fetch(pdfParserApiUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ url: url })
            });

            if (!response.ok) {
              const errorText = await response.text();
              console.error(`Error fetching URL ${url}: ${response.status} - ${errorText}`);
              alert("The brand guide(s) failed to load successfully.");
              throw new Error(`Failed to fetch ${url}: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            return data;
          } catch (error) {
            console.error(`Error processing URL ${url}:`, error);
            alert("The brand guide(s) failed to load successfully.");
            return { url: url, error: error.message };
          }
        });

        // Create an array of promises for the other URLs API calls to contentParsing endpoint
        const otherUrlsFetchPromises = otherUrls.map(async url => {
          try {
            const response = await fetch(contentParsingApiUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ url: url })
            });

            if (!response.ok) {
              const errorText = await response.text();
              console.error(`Error fetching URL ${url}: ${response.status} - ${errorText}`);
              alert("The URL(s) failed to load successfully.");
              throw new Error(`Failed to fetch ${url}: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            return data;
          } catch (error) {
            console.error(`Error processing URL ${url}:`, error);
            alert("The URL(s) failed to load successfully.");
            return { url: url, error: error.message };
          }
        });


        // Use Promise.all to wait for all API calls to complete
        const brandGuideResults = await Promise.all(brandGuideFetchPromises);
        const otherUrlsResults = await Promise.all(otherUrlsFetchPromises);

        // Combine the responses from pdfParser API calls
        let combinedResponseFromBrandGuide = {};
        brandGuideResults.forEach((result, index) => {
          combinedResponseFromBrandGuide[brandGuideUrls[index]] = result;  // Use the URL as the key for each response.  Important that allUrls[index] is used instead of result.url because result might be an error object without a .url field.
        });

        // Combine the responses from contentParsing API calls, extracting 'body'
        let combinedResponseFromOtherSources = {};
        otherUrlsResults.forEach((result, index) => {
          if (result && result.body) {
            combinedResponseFromOtherSources[otherUrls[index]] = result.body;
          } else {
            // Handle the case where 'body' is missing or result is an error object
            combinedResponseFromOtherSources[otherUrls[index]] = result && result.error ? result.error : "No content"; //Store the error message in the combined response, so the user sees the error message on the UI
            console.warn(`No 'body' found in the response from ${otherUrls[index]}`);
          }
        });

        console.log("Combined Responses from brandGuideParser:", combinedResponseFromBrandGuide);
        console.log("Combined Responses from otherSources:", combinedResponseFromOtherSources);


        // Now, send the combined response to the checkContent API
        try {
          const checkContentResponse = await fetch(checkContentApiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              "brand_guide": combinedResponseFromBrandGuide,
              "instructions": instructions,
              "content": content,
              "other_sources": combinedResponseFromOtherSources  // Changed to the combined other sources response
            })
          });

          if (!checkContentResponse.ok) {
            const errorText = await checkContentResponse.text();
            console.error(`Error calling checkContent API: ${checkContentResponse.status} - ${errorText}`);
            throw new Error(`Failed to call checkContent API: ${checkContentResponse.status} - ${errorText}`);
          }

          const checkContentData = await checkContentResponse.json();
          console.log("Response from checkContent API:", checkContentData);
          // Display the response body to the user (e.g., in a div)
          displayCheckContentResults(checkContentData['body']); // Implement this function to show the results
        } catch (checkContentError) {
          console.error("Error calling checkContent API:", checkContentError);
          alert("Error occurred while calling the checkContent API. See console for details.");
        }

      } catch (error) {
        console.error("An error occurred during the API calls:", error);
        alert("An error occurred while checking the content. See console for details."); // Provide user feedback
      }
      document.getElementById("contentCheckBtn").innerText = "Check Content"
    }

    function displayCheckContentResults(data) {
      // This function assumes you have an element with id "checkContentResults" to display the data.
      const resultsDiv = document.getElementById("checkContentResults");
      if (!resultsDiv) {
        console.warn("No element with id 'checkContentRsdfsdfsfesults' found to display the results.");
        return;
      }

      // Convert the data to a readable string (you might want to format it better)
      const formattedData = JSON.stringify(data, null, 2); // Pretty print JSON

      // Set the content of the results div
      resultsDiv.innerHTML = formattedData.replaceAll('"', '');
    }

    async function auditLandingPageDirectWeb() {
      document.getElementById("gauge").style.display = "none";
      document.getElementById("auditLandingPageBtn").innerText = "Evaluating landing page...";
      landingPageAuditResultDiv = document.getElementById("landingPageAuditResults");

      const urlInput = document.getElementById("landingPageUrl").value;
      const auditKeyword = document.getElementById("landingPageAuditKeyword")?.value || null;

      // Check if the URL input is empty
      if (!urlInput || urlInput.trim() === "") {
        alert("Please enter a landing page URL.");
        document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
        return;
      }
      const finalAuditResponse = await fetch("https://7eehmzk9e0.execute-api.ap-southeast-1.amazonaws.com/auditLandingPageDirectWeb", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          keyword: auditKeyword, // Pass the keyword for main audit
          url: urlInput
        })
      });

      const finalAuditData = await finalAuditResponse.json();

      // Display the results
      document.getElementById("landingPageAuditResults").innerHTML = finalAuditData.body;
      const gaugeElement = document.querySelector(".gauge");
      quality_score = finalAuditData.quality_score;
      setGaugeValue(gaugeElement, quality_score / 10);
      document.getElementById("gauge").style.display = "block";

      document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
    }

    function setGaugeValue(gauge, value) {
      if (value < 0 || value > 1) {
        return;
      }

      const fillElement = gauge.querySelector(".gauge__fill");
      fillElement.style.transform = `rotate(${value / 2}turn)`;
      gauge.querySelector(".gauge__cover").innerHTML = `Quality Score<br>${Math.round(value * 10)}/10`;
    }

    brandCheckbox = document.getElementById('brand-checkbox');
    productCheckbox = document.getElementById('product-checkbox');

    brandCheckbox.addEventListener('change', () => {
      if (brandCheckbox.checked) {
      } else {
        if (productCheckbox.checked) {

        } else {
          productCheckbox.checked = true;
        }
      }
    });

    productCheckbox.addEventListener('change', () => {
      if (productCheckbox.checked) {
      } else {
        if (brandCheckbox.checked) {

        } else {
          brandCheckbox.checked = true;
        }
      }
    });

    selectedItems = {};
    generatedData = {};

    async function semWebpageProducts() {
      console.log(document.getElementById("product-checkbox").checked);
      const getProducts = document.getElementById("getProducts");
      if (!document.getElementById('sem_webpages').value && !document.getElementById('sem_additional').value) {
        alert("Please enter webpage URLs or additional information.");
        return;
      } else {
        getProducts.innerText = "Analysing...";
        if (document.getElementById("product-checkbox").checked) {
          productFocus = true;
        } else {
          productFocus = false;
        }
        if (document.getElementById("brand-checkbox").checked) {
          brandFocus = true;
        } else {
          brandFocus = false;
        }

        urls = document.getElementById("sem_webpages").value.split(/[\s,]+/).filter(url => url.trim() !== "");

        try {
          const response = await fetch("https://13kntbziug.execute-api.ap-southeast-1.amazonaws.com/webpageProducts", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              pages: urls,
              brand: brandFocus,
              product: productFocus,
              language: document.getElementById("sem_language").value,
              additional: document.getElementById("sem_additional").value,
            })
          });
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const responseData = await response.json();
          console.log(responseData);
          const body = JSON.parse(responseData.body);

          formattedString = "";

          if (body['product/service'].length > 0) {
            formattedString += "Product/Service: ";
            if (Object.prototype.toString.call(body['product/service']) === '[object Array]') {
              for (value in body['product/service']) {
                formattedString += body['product/service'][value] + ", ";
              }
              formattedString = formattedString.slice(0, -2)
            } else {
              formattedString += body['product/service']
            }
          }

          if (formattedString != "") {
            formattedString += "\n\n";
          }

          if (body['brand/company'].length > 0) {
            formattedString += "Brand/Company: ";
            if (Object.prototype.toString.call(body['brand/company']) === '[object Array]') {
              for (value in body['brand/company']) {
                formattedString += body['brand/company'][value] + ", ";
              }
              formattedString = formattedString.slice(0, -2)
            } else {
              formattedString += body['brand/company']
            }
          }

          document.getElementById("products").innerHTML = '<label for="identifiedProducts">Identfied Products/Services/Brand/Company:</label><br><textarea class="form-control" rows="6" id="identifiedProducts">' + formattedString + '</textarea>';
          getProducts.innerText = "Step 1: Identify products/services/brand/company";
        } catch (error) {
          console.error("Error:", error);
          document.getElementById("output").innerText = "An error occurred with semWebpageProducts. Please check the console for details.";
          getProducts.innerText = "Step 1: Identify products/services/brand/company";
        }
      }
    }

    async function semAnalyseWebsite() {
      const semButton = document.getElementById("semAnalyse");
      semButton.innerText = "Analysing...";
      try {
        const response = await fetch("https://sk7akfiy89.execute-api.ap-southeast-1.amazonaws.com/semWebsiteAnalyser", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            country: document.getElementById("sem_country").value,
            additional: document.getElementById("sem_additional").value,
            products: document.getElementById("identifiedProducts").value,
            language: document.getElementById("sem_language").value,
          })
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const responseData = await response.json();
        const body = responseData.body;
        selectedItems = {}; // Clear selections

        //document.getElementById("selectedText").value = ""; // Clear textarea
        console.log(body);
        document.getElementById("output").innerHTML = await createSemTables(body);

        semButton.innerText = "Step 2: Generate KWs, USPs & Audience";
      } catch (error) {
        console.error("Error:", error);
        document.getElementById("output").innerText = "An error occurred with semWebsiteAnalyser. Please check the console for details.";
        semButton.innerText = "Step 2: Generate KWs, USPs & Audience";
      } finally {
        document.getElementById('selected').style.display = 'block';
      }
    }

    async function createSemTables(data) {
      let tablesHTML = "";
      const categories = ["short_keywords", "long_keywords", "usp", "target_audience_name"];
      const titles = ["Short-tail Keywords", "Long-tail Keywords", "USPs", "Target Audience"];

      for (let i = 0; i < categories.length; i++) {
        const category = categories[i];
        const title = titles[i];
        const items = data[category];


        // Fetch keyword metrics for short and long tail keywords
        let keywordMetrics = {};
        if (category === "short_keywords" || category === "long_keywords") {
          const keywords = items.map(item => typeof item === 'object' ? Object.values(item)[0] : item);
          keywordMetrics = await fetchKeywordMetricsSem(keywords);
        }

        let tableHTML = `<h2>${title}</h2><table class="display table table-striped table-hover"><tr><th>Select</th><th>Value</th>`;
        if (category === "short_keywords" || category === "long_keywords") {
          tableHTML += `<th>CPC</th><th>Search Volume</th>`; // Add CPC and Search Volume headers
        }
        tableHTML += `</tr>`;

        for (const item of items) {
          const value = typeof item === 'object' ? Object.values(item)[0] : item;
          tableHTML += `<tr><td><input type="checkbox" onchange="updateSemSelected('${value}', '${title}')"></td><td>${value}</td>`;

          if (category === "short_keywords" || category === "long_keywords") {
            const metrics = keywordMetrics[value] || { cpc: 'N/A', search_volume: 'N/A' };
            tableHTML += `<td>${metrics.cpc}</td><td>${metrics.search_volume}</td>`; // Add CPC and Search Volume data
          }

          tableHTML += `</tr>`;
        }
        tableHTML += '</table>';
        tablesHTML += tableHTML;
      }
      return tablesHTML;
    }

    async function fetchKeywordMetricsSem(keywords) {
      console.log(keywords);
      const location = document.getElementById("sem_country").value;
      const language = document.getElementById("sem_language").value;

      try {
        const response = await fetch("https://gr8ar6zc4e.execute-api.ap-southeast-1.amazonaws.com/mangoolsKeywords", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ keywords: keywords, location: location, language: language })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        const metrics = data.body;

        console.log(data);

        // Convert the returned keyword metrics to a format that is easily accessible when populating the table
        const formattedMetrics = {};
        for (const keyword in metrics) {
          formattedMetrics[keyword] = {
            cpc: metrics[keyword].cpc,
            search_volume: metrics[keyword].search_volume
          };
        }
        return formattedMetrics;

      } catch (error) {
        console.error("Error fetching keyword metrics:", error);
        return {}; // Return an empty object in case of an error
      }
    }
    function updateSemSelected(value, category) {
      if (!selectedItems[category]) {
        selectedItems[category] = [];
      }
      const index = selectedItems[category].indexOf(value);
      if (index > -1) {
        selectedItems[category].splice(index, 1);
      } else {
        selectedItems[category].push(value);
      }
      displaySemSelectedItems();
    }
    function displaySemSelectedItems() {
      let selectedText = "";
      for (const category in selectedItems) {
        if (selectedItems[category].length > 0) {
          selectedText += `${category}\n`;
          selectedItems[category].forEach(item => {
            selectedText += `${item}\n`;
          });
          selectedText += "\n"; // Add extra newline between categories
        }
      }
      document.getElementById("selectedText").value = selectedText;  // Update textarea value
    }

    async function generateGoogle() {
      document.getElementById("generateSem").innerText = "Generating...";
      try {
        const response = await fetch("https://bztsly2z89.execute-api.ap-southeast-1.amazonaws.com/generateSemGoogle", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            country: document.getElementById("sem_country").value,
            input: document.getElementById("selectedText").value,
            tone: document.getElementById("sem_tone").value,
            language: document.getElementById("sem_language").value,
            type: document.getElementById("ad_format").value
          })
        });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const responseData = await response.json();
        const body = responseData.body;
        for (const key in body) {
          if (!generatedData[key]) {
            generatedData[key] = [];
          }
          generatedData[key] = generatedData[key].concat(body[key]); // Concatenate new data
        }
        displaySemGeneratedData(); // Call function to update HTML
        document.getElementById("generateSem").innerText = "Step 3: Select checkboxes then click here";
      } catch (error) {
        console.error("Error:", error);
        document.getElementById("generated").innerText = "An error occurred. Please check the console for details.";
        document.getElementById("generateSem").innerText = "Step 3: Select checkboxes then click here";
      }
    }
    function displaySemGeneratedData() {
      let generatedHTML = "";
      for (const category in generatedData) {
        if (generatedData[category].length > 0) {
          if (category == "sitelinks") {
            generatedHTML += `<h3>${category.replace(/_/g, ' ').toUpperCase()}</h3>`; // Nicer titles
            generatedHTML += `<table class="display table table-striped table-hover">`;
            generatedHTML += `<tr><th>Value</th><th>Remove</th></tr>`; // Add remove column header
            generatedData[category].forEach((item, index) => { // Add index for row removal
              sitelink = "";
              for ([key, value] of Object.entries(item)) {
                sitelink += `${value}<br>`;
              }
              generatedHTML += `<tr>
                            <td>${sitelink}</td>
                            <td><span class="remove-row" onclick="removeSemGeneratedRow('${category}', ${index})" onmouseover="" style="cursor: pointer;">X</span></td>
                         </tr>`;
            });
          } else {
            generatedHTML += `<h3>${category.replace(/_/g, ' ').toUpperCase()}</h3>`; // Nicer titles
            generatedHTML += `<table class="display table table-striped table-hover">`;
            generatedHTML += `<tr><th>Value</th><th>Remove</th></tr>`; // Add remove column header
            generatedData[category].forEach((item, index) => { // Add index for row removal
              generatedHTML += `<tr>
                            <td>${item}</td>
                            <td><span class="remove-row" onclick="removeSemGeneratedRow('${category}', ${index})" onmouseover="" style="cursor: pointer;">X</span></td>
                         </tr>`;
            });
          }
          generatedHTML += `</table>`;
        }
      }
      document.getElementById("generated").innerHTML = generatedHTML;
      document.getElementById("generated").innerHTML = document.getElementById("generated").innerHTML + '<br><button class = "btn btn-secondary" id="downloadSem" onclick="downloadSemCSV()">Download .csv</button>'
      document.getElementById("downloadSem").addEventListener("click", downloadSemCSV);
    }
    function removeSemGeneratedRow(category, index) {
      generatedData[category].splice(index, 1);
      displaySemGeneratedData(); // Redraw the table
    }

    function downloadSemCSV() {
      let csvContent = "data:text/csv;charset=utf-8,";

      const generatedDiv = document.getElementById('generated');
      const tablesAndHeadings = Array.from(generatedDiv.querySelectorAll('h3, table')); // Select both h3 and table

      tablesAndHeadings.forEach((element, index) => {
        if (element.tagName === 'H3') {  // Check if it's a heading
          const headingText = element.textContent.trim().replace(/_/g, ' ').toUpperCase(); //Add same formatting
          const nextElement = tablesAndHeadings[index + 1]; // Check if next element exists

          if (nextElement && nextElement.tagName === 'TABLE') {
            const rows = Array.from(nextElement.querySelectorAll("tr"));

            rows.forEach(row => {
              const cells = Array.from(row.querySelectorAll("th, td"));

              if (cells.length >= 2) { //Check if remove cell exists
                cells.splice(1, 1); //Remove remove cell
              }
              //Replace 'Value' with headingText
              if (cells.length > 0 && cells[0].textContent.trim() === 'Value') {
                cells[0].textContent = headingText;
              }

              const rowText = cells.map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`).join(",");
              csvContent += rowText + "\n";

            });

            csvContent += "\n"; // Add an empty row after each table's data
          }


        }
      });

      // Create a hidden link element and trigger a click to download
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "generated_sem.csv");
      document.body.appendChild(link); // Required for Firefox
      link.click(); // This will download the data file
      document.body.removeChild(link); // Cleanup 
    }

    async function generateMediaPlan() {
      document.getElementById("generateMediaPlanBtn").innerText = "Generating...";
      const mediaplanContentDiv = document.getElementById("mediaPlanResults");
      const webpages = document.getElementById("MediaPlanWebpages").value.split(/[\s,]+/).filter(url => url.trim() !== "");

      const responses = await Promise.all(
        webpages.map(async url => {
          try {
            const response = await fetch("https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ url: url })
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status} for URL: ${url}`);
            }

            return await response.json(); // Return the parsed JSON data
          } catch (error) {
            console.error(`Error fetching data from ${url}:`, error);
            return null; // Return null in case of an error
          }
        })
      );

      word_count = 0;
      responses.forEach((page) => {
        word_count += (page.body.other_text.split(" ")).length;
      });

      if (word_count < 500) {
        alert("Please consider adding more webpage URLs for the tool to generate better results. The tool will continue generating the media plan.");
      }


      personaData = document.getElementById("MediaPlanCustomerPersonas").value;
      manualInput = document.getElementById("persona_manual").value;

      if (personaData == "") {
        try {
          const personaResponse = await fetch("https://tyqj3fni7h.execute-api.ap-southeast-1.amazonaws.com/personaGenerator", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ data: responses, manual: manualInput })
          });

          if (!personaResponse.ok) {
            throw new Error(`HTTP error! status: ${personaResponse.status} for persona API`);
          }

          personaData = await personaResponse.json();
          document.getElementById("mediaPlanPersonaResults").innerHTML = "<h2>Generated Personas</h2>" + personaData.body;
          document.getElementById("mediaPlanPersonaResults").style.display = "block"

        } catch (error) {
          alert(`Error sending data to persona API: ${error.message}`);
          console.error("Error sending data to persona API:", error);
        }
      }

      // Gather all the data from the form fields
      const data = {
        webpagesInput: responses,
        budget: document.getElementById("MediaPlanBudget").value,
        manualInput: document.getElementById("MediaPlanManual").value,
        organisationalObjectives: document.getElementById("MediaPlanOrganisationalObjectives").value,
        mediaPlanLocation: document.getElementById("MediaPlanLocation").value,
        mediaPlanTargetAudience: document.getElementById("MediaPlanTargetAudience").value,
        mediaPlanCustomerPersonas: personaData,
        mediaPlanTouchpoints: document.getElementById("MediaPlanTouchpoints").value,
        mediaPlanContentStrategy: document.getElementById("MediaPlanContentStrategy").value,
        mediaPlanLandingPages: document.getElementById("MediaPlanLandingPages").value,
        mediaPlanCta: document.getElementById("MediaPlanCta").value,
        mediaPlanProductService: document.getElementById("MediaPlanProductService").value,
        mediaPlanKpis: document.getElementById("MediaPlanKpis").value,
        mediaPlanCompetitiveAnalysis: document.getElementById("MediaPlanCompetitiveAnalysis").value,
        mediaPlanCompliance: document.getElementById("MediaPlanCompliance").value,
        mediaPlanTechnologyPlan: document.getElementById("MediaPlanTechnologyPlan").value,
        mediaPlanAnalyticsReporting: document.getElementById("MediaPlanAnalyticsReporting").value,

        adFormats: {
          googleDisplay: document.getElementById("MediaPlanAdFormatsGoogleDisplay").checked,
          googleSearch: document.getElementById("MediaPlanAdFormatsGoogleSearch").checked,
          fbIg: document.getElementById("MediaPlanAdFormatsFBIG").checked,
          linkedIn: document.getElementById("MediaPlanAdFormatsLinkedIn").checked,
          tikTok: document.getElementById("MediaPlanAdFormatsTikTok").checked
        }
      };

      try {
        // Combine the responses - the original implementation was parsing webpage
        // content, but now we skip that step and pass the data directly

        // Send the combined data to the media plan API
        const mediaPlanResponse = await fetch("https://h8ih2vc2xi.execute-api.ap-southeast-1.amazonaws.com/mediaPlanGenerator", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(data) // Send all the data gathered from the form
        });

        if (!mediaPlanResponse.ok) {
          throw new Error(`HTTP error! status: ${mediaPlanResponse.status} for media plan API`);
        }

        const mediaPlanData = await mediaPlanResponse.json();
        mediaplanContentDiv.innerHTML += "<br>" + mediaPlanData.body.replace('<table', '<table class="display table table-striped table-hover" ');

        // Funnel
        funnelResponse = await fetch("https://dpjtg2sr30.execute-api.ap-southeast-1.amazonaws.com/generateFunnel", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(Object.assign({}, personaData, mediaPlanData)) // Send all the data gathered from the form
        });

        if (!funnelResponse.ok) {
          throw new Error(`HTTP error! status: ${funnelResponse.status} for media plan API`);
        }
        funnelData = await funnelResponse.json();

        funnelData = JSON.parse(funnelData.body);

        try {
          document.getElementById("awareness-details").innerHTML = funnelData.Awareness.join('\n');
        } catch (error) {
          document.getElementById("awareness-details").innerHTML = "N.A.";
        }
        try {
          document.getElementById("discovery-details").innerHTML = funnelData.Discovery.join('\n');
        } catch (error) {
          document.getElementById("discovery-details").innerHTML = "N.A.";
        }
        try {
          document.getElementById("consideration-details").innerHTML = funnelData.Consideration.join('\n');
        } catch (error) {
          document.getElementById("consideration-details").innerHTML = "N.A.";
        }
        try {
          document.getElementById("conversion-details").innerHTML = funnelData.Conversion.join('\n');
        } catch (error) {
          document.getElementById("conversion-details").innerHTML = "N.A.";
        }
        try {
          document.getElementById("retention-details").innerHTML = funnelData.Retention.join('\n');
        } catch (error) {
          document.getElementById("retention-details").innerHTML = "N.A.";
        }

        document.getElementById("funnel-container").style.display = "flex";

      } catch (error) {
        mediaplanContentDiv.innerHTML = `<p style="color: red;">Error sending data to media plan API: ${error.message}</p>`;
        console.error("Error sending data to media plan API:", error);
      } finally {
        document.getElementById("generateMediaPlanBtn").innerText = "Generate Media Plan";
      }
    }

    function getCompetitors() {
      document.getElementById("getCompetitorsBtn").innerText = "Getting Competitors...";
      const keywords = document.getElementById('competitor_keywords').value.split(/[\n,]+/).map(k => k.trim());
      console.log(keywords);
      const competitorsLanguage = document.getElementById("competitors-language").value;
      const competitorsLocation = document.getElementById("competitors-location").value;

      fetch("https://itzj193chl.execute-api.ap-southeast-1.amazonaws.com/serpCompetitors", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          keywords: keywords,
          location: competitorsLocation,
          language: competitorsLanguage
        })
      })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          displayCompetitorResults(data.body);
          document.getElementById("competitorsOutput").style.display = "block";
        })
        .catch(error => {
          console.error("Error fetching competitors:", error);
          document.getElementById("competitorsOutput").innerHTML = "Error fetching competitors.  See console for details.";
        })
        .finally(() => {
          document.getElementById("getCompetitorsBtn").innerText = "Step 1: Get Competitors";
        });
    }

    function displayCompetitorResults(results) {
      const outputDiv = document.getElementById("competitorsOutput");
      if (results === undefined) {
        alert("There are no results found for the keyword(s). Please try other keyword(s).")
      }
      if (!outputDiv) {
        console.error("Competitors output div not found!");
        return;
      }

      let tableHTML = `
        <table class="display table table-striped table-hover">
            <thead>
                <tr>
                    <th>Domain</th>
                    <th>Keyword and Rank</th>
                    <th>Select</th>
                </tr>
            </thead>
            <tbody>
    `;

      for (const domain in results) {
        if (results.hasOwnProperty(domain)) {
          const keywordRanks = results[domain];
          let keywordRankText = "";
          for (const keyword in keywordRanks) {
            if (keywordRanks.hasOwnProperty(keyword)) {
              keywordRankText += `${keyword}: ${keywordRanks[keyword]}<br>`;
            }
          }

          // Make the domain a hyperlink
          const linkedDomain = `<a href="http://${domain}" target="_blank" rel="noopener noreferrer">${domain}</a>`;  //IMPORTANT:  Added http:// to the domain so if a naked domain is returned it will open.  Also add noreferrer to protect user privacy

          tableHTML += `
                <tr>
                    <td>${linkedDomain}</td>
                    <td>${keywordRankText}</td>
                    <td><input type="checkbox" class="domain-checkbox" value="${domain}" onchange="updateCompetitorDomainsField()"></td>

                </tr>
            `;
        }
      }

      tableHTML += `
            </tbody>
        </table>
    `;

      outputDiv.innerHTML = tableHTML;

      // Add event listener after the table is rendered
      const checkboxes = document.querySelectorAll('.domain-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateCompetitorDomainsField);
      });
      // Show the button
      document.getElementById('getIntersectionResults').style.display = 'block';
    }

    async function getIntersectionResults() {
      document.getElementById('competitorsRanking').style.display = 'none';
      const checkedDomains = Array.from(document.querySelectorAll('.domain-checkbox:checked'))
        .map(checkbox => checkbox.value);

      if (checkedDomains.length === 0) {
        alert('Please select at least one domain.');
        return;
      }

      const target1Value = document.getElementById('competitors-target1').value;

      const apiCalls = checkedDomains.map(domain => {
        const requestBody = {
          "language": "English",
          "location": "Singapore",
          "target1": target1Value,
          "target2": domain
        };

        return fetch('https://8llvcx7m6e.execute-api.ap-southeast-1.amazonaws.com/domainIntersection', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            return { domain: domain, data: data }; // Return domain along with the data
          })
          .catch(error => {
            console.error(`Error fetching intersection results for ${domain}:`, error);
            return { domain: domain, error: error }; // Return domain and the error
          });
      });

      // Execute all API calls in parallel
      const results = await Promise.all(apiCalls);
      displayIntersectionResults(results);

    }

    async function getIntersectionResults2() {
      client_url = document.getElementById('competitors-target1').value;
      if (!client_url) {
        alert("Please enter a Target Domain.");
        return;
      }
      document.getElementById('getIntersectionResults2').innerText = "Getting Results..";
      var domains = document.getElementById('competitor_domains').value;
      domainsArray = domains.split(/[,\n]+/).map(domain => domain.trim()).filter(domain => domain !== "");

      var location = document.getElementById('competitors-location').value;

      var url = "https://0dqny7l5y9.execute-api.ap-southeast-1.amazonaws.com/rankingKeywords";

      var headers = {
        "Accept": "application/json",
        "Content-Type": "application/json",
      };

      const target1Value = document.getElementById('competitors-target1').value;

      const apiCalls = domainsArray.map(domain => {
        const requestBody = {
          "language": document.getElementById('competitors-language').value,
          "location": document.getElementById('competitors-location').value,
          "target1": target1Value,
          "target2": domain
        };

        return fetch('https://8llvcx7m6e.execute-api.ap-southeast-1.amazonaws.com/domainIntersection', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            return { domain: domain, data: data }; // Return domain along with the data
          })
          .catch(error => {
            console.error(`Error fetching intersection results for ${domain}:`, error);
            return { domain: domain, error: error }; // Return domain and the error
          });
      });

      // Execute all API calls in parallel
      const results = await Promise.all(apiCalls);
      displayIntersectionResults(results);
      document.getElementById('getIntersectionResults').style.display = 'block';
      document.getElementById('getIntersectionResults2').innerText = "Get Intersection Results";
    }
    function displayIntersectionResults(results) {
      const outputDiv = document.getElementById("competitorsRanking");
      if (!outputDiv) {
        console.error("Competitors output div not found!");
        return;
      }

      let tableHTML = `
    <table class = "display table table-striped table-hover" id="intersectionResultsTable">
      <thead>
        <tr>
          <th onclick="sortIntersectionTable('keyword')">Keyword</th>
          <th onclick="sortIntersectionTable('${document.getElementById("competitors-target1").value}')">${document.getElementById("competitors-target1").value}</th>
          ${results.map(result => `<th onclick="sortIntersectionTable('${result.domain}')">${result.domain}</th>`).join('')}
        </tr>
      </thead>
      <tbody>
  `;

      // Collect all unique keywords from the results
      const allKeywords = new Set();
      results.forEach(result => {
        if (result.data) {
          Object.keys(result.data).forEach(keyword => allKeywords.add(keyword));
        }
      });

      // Iterate over each unique keyword and create a row
      allKeywords.forEach(keyword => {
        tableHTML += `
      <tr>
        <td>${keyword}</td>
    `;

        console.log(results);

        // Get target1 data
        tableHTML += `
      <td>${(results[0].data && results[0].data[keyword]) ? `<a href="${results[0].data[keyword][Object.keys(results[0].data[keyword])[3]][1]}"  target="_blank">${results[0].data[keyword][Object.keys(results[0].data[keyword])[3]][0]}</a>` : '999'}</td>
    `;

        //Add rankings for the rest of the selected domains
        results.forEach(result => {
          if (result.data && result.data[keyword]) {

            // Find first domain and retrieve rankings and URLs
            const firstDomain = Object.keys(result.data[keyword])[4]
            const domainData = result.data[keyword][firstDomain]

            //Set ranks and URLs into the rows
            tableHTML += `<td><a href="${domainData[1]}" target="_blank">${domainData[0]}</a></td>`;

          } else if (result.error) {
            tableHTML += `<td>Error</td>`;
          } else {
            tableHTML += `<td>999</td>`;
          }
        });

        tableHTML += `</tr>`;
      });

      tableHTML += `
      </tbody>
    </table>
  `;

      outputDiv.innerHTML = tableHTML;
      outputDiv.innerHTML += '<br><button style = "margin-right:10px;"class="btn btn-icon btn-round btn-primary" type="button" onclick="copyInteractionResultsTable()"><i class="fa fa-copy"></i></button>';
      outputDiv.innerHTML += '<button type="button" class= "btn btn-primary" onclick="exportInteractionResultsTableToCSV()">Export as .csv</button>';
      document.getElementById('competitorsRanking').style.display = 'block';
    }

    function updateCompetitorDomainsField() {
      const domainsTextArea = document.getElementById('competitor_domains');
      const checkedDomains = new Set(); // Use a Set to store unique values

      // Get checked keywords from both tables
      try {
        const domainsCheckboxes = document.querySelectorAll('#competitorsOutput input[type="checkbox"]:checked');
        domainsCheckboxes.forEach(checkbox => checkedDomains.add(checkbox.value));
      } catch (error) {
        console.log(error);
      }

      domainsTextArea.value = Array.from(checkedDomains).join(', '); // Convert Set back to array before joining
    }

    function sortIntersectionTable(columnName) {
      const table = document.getElementById('intersectionResultsTable');
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));

      // Determine sort direction
      let isAscending = true; // Default to ascending

      if (table.dataset.sortColumn === columnName) {
        // Same column clicked again, toggle sort direction
        isAscending = table.dataset.sortDirection === 'desc'; // Reverse
      }

      table.dataset.sortColumn = columnName;
      table.dataset.sortDirection = isAscending ? 'asc' : 'desc'; //Update direction

      // Sort rows
      const sortedRows = rows.sort((rowA, rowB) => {
        const cellA = rowA.querySelector(`td:nth-child(${getColumnIndex(table, columnName) + 1})`);
        const cellB = rowB.querySelector(`td:nth-child(${getColumnIndex(table, columnName) + 1})`);

        const valueA = cellA ? cellA.textContent.trim() : '';
        const valueB = cellB ? cellB.textContent.trim() : '';

        let comparison;
        if (isFinite(valueA) && isFinite(valueB)) {
          comparison = Number(valueA) - Number(valueB); // Numeric comparison
        } else {
          comparison = valueA.localeCompare(valueB);  // Text comparison
        }

        return isAscending ? comparison : -comparison; // Apply sort direction
      });

      // Append sorted rows to the tbody
      sortedRows.forEach(row => tbody.appendChild(row));
    }

    function getColumnIndex(table, columnName) {
      const headers = Array.from(table.querySelectorAll('th'));
      for (let i = 0; i < headers.length; i++) {
        if (headers[i].textContent.trim() === columnName) {
          return i;
        }
      }
      return -1; // Column not found
    }

    function copyInteractionResultsTable() {
      const table = document.getElementById('intersectionResultsTable'); // Get the table element
      if (!table) {
        console.error("Interaction Results Table not found");
        return;
      }

      // Extract table data
      const rows = Array.from(table.querySelectorAll('tr'));
      const tableData = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('th, td'));
        return cells.map(cell => cell.textContent.trim()).join('\t'); // Tab-separated values
      }).join('\n'); // Newline for each row

      // Copy to clipboard
      navigator.clipboard.writeText(tableData)
        .then(() => {
          alert('Interaction Results Table copied to clipboard! You can now paste it into a spreadsheet.');
        })
        .catch(err => {
          console.error('Failed to copy: ', err);
          alert('Failed to copy the table. Please try again.');
        });
    }

    // Function to export the interactionResultsTable as a CSV file
    function exportInteractionResultsTableToCSV() {
      const table = document.getElementById('intersectionResultsTable'); // Get the table element
      if (!table) {
        console.error("Interaction Results Table not found");
        return;
      }

      // Extract table data
      const rows = Array.from(table.querySelectorAll('tr'));
      const csvData = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('th, td'));
        return cells.map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`).join(','); // Comma-separated values, escape double quotes
      }).join('\n'); // Newline for each row

      // Add BOM (Byte Order Mark) for UTF-8 encoding, crucial for international characters
      const bom = "\uFEFF";
      const csvString = bom + csvData;

      // Create a download link
      const blob = new Blob([csvString], {
        type: 'text/csv;charset=utf-8'
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.setAttribute('href', url);
      a.setAttribute('download', 'interaction_results.csv');
      a.style.display = 'none';

      // Programmatically trigger the download
      document.body.appendChild(a);
      a.click();

      // Clean up
      URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }

    function hideOtherLines(clickedRowId) {
      const rows = ['semRow', 'smmRow', 'seoRow', 'bdRow'];

      rows.forEach(rowId => {
        const row = document.getElementById(rowId);
        if (row) {
          if (rowId === clickedRowId) {
            row.style.display = 'block';
          } else {
            row.style.display = 'none';
          }
        }
      });
    }

    async function populateHeatmapTable() {
      document.getElementById("heatmapBtn").innerText = "Processing";
      const target_urls = [
        'https://ninjapromo.io/digital-marketing-agencies-singapore',
        'https://www.oom.com.sg/',
        'https://digitalmarketingagency.sg/',
        'https://agencies.semrush.com/list/singapore/',
        'https://brewinteractive.com/'
      ];
      const target_keywords = ["Digital Marketing Services", "SEO Services", "Social Media Marketing", "Content Marketing", "PPC Advertising", "Digital Marketing Strategy", "Online Branding"]
      const apiUrl = 'https://5m1vrccqdl.execute-api.ap-southeast-1.amazonaws.com/topicsHeatmap';
      const table = document.getElementById('heatmap');

      if (!table) {
        console.error('Heatmap table element not found.');
        return;
      }

      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ urls: target_urls, keywords: target_keywords }),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        console.log(data);

        // Clear existing table body
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';

        // Get the URLs from the first topic to create the header
        const firstTopic = Object.keys(data)[0];
        const urls = Object.keys(data[firstTopic]);

        // Create table header row
        const thead = table.querySelector('thead');
        thead.innerHTML = ''; // Clear existing header
        const headerRow = document.createElement('tr');
        const urlHeader = document.createElement('th');
        urlHeader.textContent = 'Topic';
        headerRow.appendChild(urlHeader);

        urls.forEach(url => {
          const header = document.createElement('th');
          const span = document.createElement('span');
          span.textContent = url;
          header.appendChild(span);
          headerRow.appendChild(header);
        });
        thead.appendChild(headerRow);

        // Create table rows for each topic
        for (const topic in data) {
          if (data.hasOwnProperty(topic)) {
            const row = document.createElement('tr');
            const topicCell = document.createElement('td');
            topicCell.textContent = topic;
            row.appendChild(topicCell);

            urls.forEach(url => {
              const value = data[topic][url] || 0; // Default to 0 if no value
              const cell = document.createElement('td');
              cell.textContent = value;
              // Apply color gradient
              const color = getColorForValue(value);
              cell.style.backgroundColor = color;
              row.appendChild(cell);
            });
            tbody.appendChild(row);
          }
        }

      } catch (error) {
        console.error('Error fetching or processing data:', error);
        // Handle errors, display a message in the table, etc.
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = `<tr><td colspan="${urls.length + 1}">Error: ${error.message}</td></tr>`;
      }
      document.getElementById("heatmapBtn").innerText = "Populate Table";
    }

    function getColorForValue(value) {
      // Scale value from 0-10 to 0-1
      const scaledValue = value / 10;

      // Red to green color gradient
      const red = Math.round(255 * (1 - scaledValue));
      const green = Math.round(255 * scaledValue);

      return `rgb(${red}, ${green}, 0)`;
    }

    function showTooltip(event, text) {
      const tooltip = document.getElementById('tooltip');
      tooltip.innerHTML = text;
      tooltip.style.display = 'block';
      //tooltip.style.left = (event.pageX + 10) + 'px';  // Position it next to the mouse
      //tooltip.style.top = (event.pageY + 10) + 'px';
    }

    function hideTooltip() {
      document.getElementById('tooltip').style.display = 'none';
    }

    function logConversation(question, generated_answer, feedback, suggested_answer, conversation_id) {
      let user;
      try {
        user = JSON.parse(localStorage.getItem('googleUser')).email;
      } catch (error) {
        console.error("Error parsing user from local storage", error);
        return; // Early exit if user cannot be determined
      }

      fetch('https://7spo2afb9i.execute-api.ap-southeast-1.amazonaws.com/chatbotLogger', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          question: question,
          generated_answer: generated_answer,
          feedback: feedback || "",
          suggested_answer: suggested_answer || "",
          conversation_id: conversation_id,
          user: user,
          is_feedback: "no"
        })
      })
        .then(response => {
          if (!response.ok) {
            // Handle HTTP errors (4xx, 5xx status codes)
            console.error("HTTP error!", response.status, response.statusText);
            throw new Error(`HTTP error! ${response.status} ${response.statusText}`); //Re-throw to be caught in the .catch block

          }
          return response.json(); // Parse JSON body if the request is successful
        })
        .then(data => {
          console.log("Conversation logged successfully:", data); //Log successful response
        })
        .catch(error => {
          console.error("Fetch error:", error);
          // Log the error message to the console, and potentially display it to the user

        });
    }


    //chatbot2
    document.addEventListener('DOMContentLoaded', () => {
      const chatbotButton = document.getElementById('chatbot-button');
      const chatbotModal = document.getElementById('chatbot-modal');
      const closeChatbotButton = document.getElementById('close-chatbot');

      const questionInput = document.getElementById('question-input');
      const sendButton = document.getElementById('send-button-2');

      let isChatbotOpen = false; // Track chatbot state

      chatbotButton.addEventListener('click', () => {
        isChatbotOpen = !isChatbotOpen;
        chatbotModal.style.display = isChatbotOpen ? 'block' : 'none';

        if (chatMessages.textContent == "") {
          addMessage('chatbot', 'Hello ' + JSON.parse(localStorage.getItem('googleUser')).name.split(' ')[0] + ', how can I help you today?');
        }
      });

      closeChatbotButton.addEventListener('click', () => {
        chatbotModal.style.display = 'none';
        isChatbotOpen = false;
      });

      questionInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          sendButton.click();
        }
      });

      // Function to create and open the feedback modal
      function openFeedbackModal(question, answer) {
        // 1. Create the Modal Structure
        const modal = document.createElement('div');
        modal.id = 'feedbackModal';
        modal.classList.add('feedback-modal');
        modal.innerHTML = `
                    <div class="feedback-modal-content">
                    <span class="feedback-close">×</span>
                    <h2>Give Feedback</h2>
                    <p><b>Question:</b></p>
                    <p>${question}</p>
                    <p><b>Generated Answer:</b></p>
                    <p>${answer}</p>
                    <label for="userFeedback"><b>Your Feedback:</b></label>
                    <textarea id="userFeedback" style="width: 100%; height: 100px;"></textarea><br>
                    <label for="suggestedAnswer"><b>Suggested Answer:</b></label><br>
                    <textarea id="suggestedAnswer" style="width: 100%; height: 100px;"></textarea>
                    <button id="submitFeedbackBtn">Submit Feedback</button>
                    </div>
                `;

        // 2. Add Event Listeners
        document.body.appendChild(modal); // Append to the document

        // Close Modal Button
        const closeBtn = modal.querySelector('.feedback-close');
        closeBtn.addEventListener('click', () => {
          modal.style.display = 'none';
          modal.remove()
        });

        // Submit Feedback Button
        const submitBtn = modal.querySelector('#submitFeedbackBtn');
        submitBtn.addEventListener('click', () => {
          const feedback = modal.querySelector('#userFeedback').value;
          const suggestedAnswer = modal.querySelector('#suggestedAnswer').value;
          const conversationId = document.getElementById('threadId').innerText; // Or however you get it

          submitFeedback(question, answer, feedback, suggestedAnswer, conversationId); // Call the submission function
          modal.style.display = 'none'; // Hide the modal after submission
          modal.remove()//remove the modal after submission
        });

        // Click outside the modal to close
        window.addEventListener('click', (event) => {
          if (event.target === modal) {
            modal.style.display = 'none';
            modal.remove()
          }
        });

        // 3. Display the Modal
        modal.style.display = 'block';
      }

      // Function to submit the feedback to your API
      async function submitFeedback(question, generatedAnswer, feedback, suggestedAnswer, conversationId) {
        user = JSON.parse(localStorage.getItem('googleUser')).email
        try {
          const response = await fetch('https://7spo2afb9i.execute-api.ap-southeast-1.amazonaws.com/chatbotLogger', { // Replace with your API endpoint
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              question: question,
              generated_answer: generatedAnswer,
              feedback: feedback,
              suggested_answer: suggestedAnswer,
              conversation_id: conversationId,
              user: user,
              is_feedback: "yes"
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log('Feedback submitted:', data);
          alert('Thank you for your feedback!');

        } catch (error) {
          console.error('Error submitting feedback:', error);
          alert('Failed to submit feedback. Please try again.');
        }
      }
     

      // Close chatbot on Esc key press
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && isChatbotOpen) {
          chatbotModal.style.display = 'none';
          isChatbotOpen = false;
        }
      });
    });

    window.addEventListener('load', function () {
      const leftNav = document.querySelector('#leftNavMinimise');
      if (leftNav) {
        leftNav.click();
      } else {
        console.error('leftNavMinimise element not found');
      }
    });

  </script>
  <!--   Core JS Files   -->
  <script src="assets/js/core/jquery-3.7.1.min.js"></script>
  <script src="assets/js/core/popper.min.js"></script>
  <script src="assets/js/core/bootstrap.min.js"></script>

  <!-- jQuery Scrollbar -->
  <script src="assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>

  <!-- Chart JS -->
  <script src="assets/js/plugin/chart.js/chart.min.js"></script>

  <!-- jQuery Sparkline -->
  <script src="assets/js/plugin/jquery.sparkline/jquery.sparkline.min.js"></script>

  <!-- Chart Circle -->
  <script src="assets/js/plugin/chart-circle/circles.min.js"></script>

  <!-- Datatables -->
  <script src="assets/js/plugin/datatables/datatables.min.js"></script>

  <!-- Bootstrap Notify -->
  <script src="assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>

  <!-- jQuery Vector Maps -->
  <script src="assets/js/plugin/jsvectormap/jsvectormap.min.js"></script>
  <script src="assets/js/plugin/jsvectormap/world.js"></script>

  <!-- Sweet Alert -->
  <script src="assets/js/plugin/sweetalert/sweetalert.min.js"></script>

  <!-- Kaiadmin JS -->
  <script src="assets/js/kaiadmin.min.js"></script>
</body>

</html>