<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sitemap Force-Directed Graph for Digital Marketing Blog</title>
  <style>
    :root {
      --bg1: #0f1020;
      --bg2: #1b1e3a;
      --fg: #e8eaf6;
      --card: rgba(255,255,255,0.08);
      --shadow: 0 10px 25px rgba(0,0,0,0.25);
      --tooltip: rgba(0,0,0,0.8);
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color: #e9eaf6;
      background: radial-gradient(circle at 20% -10%, rgba(120, 60, 200, 0.25), transparent 40%),
                  radial-gradient(circle at 100% 0%, rgba(0, 180, 200, 0.25), transparent 40%),
                  linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      overflow: hidden;
    }

    .header {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      padding: 14px 20px;
      border-radius: 14px;
      background: rgba(14, 18, 36, 0.75);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 12px;
      backdrop-filter: saturate(1.3) blur(2px);
    }
    .header h1 {
      font-size: 16px;
      margin: 0;
      white-space: nowrap;
    }
    .header .hint {
      font-size: 12px;
      opacity: 0.85;
    }
    .btn {
      appearance: none;
      border: 0;
      border-radius: 8px;
      padding: 8px 12px;
      background: #6a8cff;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s ease, background 0.2s ease;
    }
    .btn:hover { transform: translateY(-1px); background: #7a95ff; }
    .btn.secondary {
      background: rgba(255,255,255,0.12);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.15);
    }

    #graph-wrap {
      position: fixed;
      top: 76px;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 18px;
      overflow: hidden;
    }

    svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    .node {
      cursor: pointer;
      stroke: #fff;
      stroke-width: 1.5px;
    }

    .node.root { fill: #4e6cff; }
    .node.category { fill: #1ee3a1; }
    .node.article { fill: #ffd166; }

    .link {
      stroke: rgba(255,255,255,0.6);
      stroke-width: 1.25px;
    }

    .label {
      font-size: 11px;
      fill: #e7eaf6;
      pointer-events: none;
      text-shadow: 0 1px 2px rgba(0,0,0,0.4);
    }

    /* Tooltip styling */
    #tooltip {
      position: fixed;
      padding: 8px 10px;
      border-radius: 8px;
      background: var(--tooltip);
      color: #fff;
      font-size: 12px;
      max-width: 320px;
      pointer-events: none;
      opacity: 0;
      transform: translate(-50%, -120%);
      transition: opacity 0.15s ease;
      white-space: nowrap;
      z-index: 20;
      border: 1px solid rgba(255,255,255,0.25);
    }
    #tooltip .t-url { color: #d6e7ff; word-break: break-all; }
    #tooltip .t-cat { font-weight: 600; margin-right: 6px; }

    @media (max-width: 800px) {
      .header { padding: 10px 12px; }
      .header h1 { font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="header" aria-label="Sitemap visualization header">
    <button id="load-live" class="btn" title="Attempt to load live sitemap">Load Live Sitemap</button>
    <h1>Digital Marketing Blog Sitemap â€” Force-Directed Graph</h1>
    <span class="hint">Nodes linked from root to categories to articles. Hover to explore.</span>
  </div>

  <div id="graph-wrap" aria-label="Graph container">
    <svg id="graph"></svg>
  </div>

  <div id="tooltip" role="tooltip" aria-hidden="true"></div>

  <!-- D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    // Utility helpers
    const svg = d3.select("#graph");
    const tooltip = document.getElementById('tooltip');
    let width = window.innerWidth;
    let height = window.innerHeight * 0.78; // leave space for header

    svg.attr("viewBox", [0, 0, width, height]);
    const g = svg.append("g");

    // Zoom and pan
    const zoom = d3.zoom()
      .scaleExtent([0.3, 2.5])
      .on("zoom", (e) => {
        g.attr("transform", e.transform);
      });
    svg.call(zoom);

    // Color scale for categories (dynamic)
    const color = d3.scaleOrdinal(d3.schemeCategory10);

    // Data containers
    let nodes = [];
    let links = [];

    // Root node
    const ROOT_ID = 'root';
    const ROOT_NAME = 'Digital Marketing Blog';
    const rootNode = { id: ROOT_ID, name: ROOT_NAME, type: 'root' };

    // Graph rendering helpers
    const nodeRadius = d3.scaleOrdinal()
      .domain(['root', 'category', 'article'])
      .range([18, 12, 7]);

    const nodeById = new Map();

    // Initialize with root
    function initGraphFromItems(items) {
      // Reset
      nodes = [];
      links = [];
      nodeById.clear();

      // Add root
      nodes.push(rootNode);
      nodeById.set(ROOT_ID, rootNode);

      // Collect categories
      const categorySet = new Set();
      items.forEach(it => categorySet.add(it.category));

      const categoryNodes = Array.from(categorySet).map((cat, idx) => {
        const id = 'cat-' + slugify(cat);
        const node = { id, name: cat, type: 'category' };
        return node;
      });

      // Add category nodes
      categoryNodes.forEach(n => {
        nodes.push(n);
        nodeById.set(n.id, n);
        // edge root -> category
        links.push({ source: ROOT_ID, target: n.id });
      });

      // Add article nodes
      items.forEach((it, idx) => {
        const id = 'post-' + idx;
        const categoryId = 'cat-' + slugify(it.category);
        const articleNode = {
          id,
          name: extractTitleFromURL(it.url),
          url: it.url,
          type: 'article',
          category: it.category,
          categoryId
        };
        nodes.push(articleNode);
        nodeById.set(id, articleNode);

        // edge category -> article
        // ensure categoryId exists
        if (!nodeById.has(categoryId)) {
          // fallback: create category if missing (shouldn't happen)
          const fallbackCat = { id: categoryId, name: it.category, type: 'category' };
          nodes.push(fallbackCat);
          nodeById.set(categoryId, fallbackCat);
          links.push({ source: ROOT_ID, target: categoryId });
        }
        links.push({ source: categoryId, target: id });
      });

      // Render with updated data
      renderGraph();
    }

    function slugify(s) {
      return s.toString().toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    }

    function extractTitleFromURL(url) {
      try {
        const u = new URL(url);
        const p = u.pathname;
        const parts = p.split('/').filter(Boolean);
        const last = parts[parts.length - 1] || '';
        // Remove category-like segments if present
        const withNoExt = last.replace(/\.[^/.]+$/, '');
        const t = withNoExt.replace(/[-_]+/g, ' ').trim();
        return t.charAt(0).toUpperCase() + t.slice(1);
      } catch {
        return url;
      }
    }

    // Render the graph
    function renderGraph() {
      // Clear previous graph
      g.selectAll("*").remove();

      const link = g.append("g")
        .attr("class", "links")
        .selectAll("line")
        .data(links)
        .enter().append("line")
        .attr("class", "link");

      const node = g.append("g")
        .attr("class", "nodes")
        .selectAll("circle")
        .data(nodes)
        .enter().append("circle")
        .attr("class", d => `node ${d.type}`)
        .attr("r", d => {
          // Root slightly larger
          if (d.type === 'root') return 22;
          if (d.type === 'category') return 12;
          return 7;
        })
        .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended))
        .on("mouseover", (event, d) => showTooltip(event, d))
        .on("mousemove", (event) => moveTooltip(event))
        .on("mouseout", hideTooltip)
        .on("click", (event, d) => {
          // quick highlight
          highlightNode(d);
        });

      const label = g.append("g")
        .attr("class", "labels")
        .selectAll("text")
        .data(nodes)
        .enter().append("text")
        .attr("class", "label")
        .text(d => d.name);

      // Simulation
      const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(d => {
          if (d.source && d.target) {
            const s = typeof d.source === 'string' ? d.source : d.source.type;
            const t = typeof d.target === 'string' ? d.target : d.target.type;
            // Distances tuned by type
            if (d.source === ROOT_ID || d.target === ROOT_ID) return 140;
            if (s === 'category' || t === 'category') return 60;
            return 22;
          }
          return 60;
        }))
        .force("charge", d3.forceManyBody().strength(-260))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collision", d3.forceCollide().radius(d => {
          if (d.type === 'root') return 26;
          if (d.type === 'category') return 14;
          return 8;
        }))
        .on("tick", ticked);

      function ticked() {
        link
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);

        node
          .attr("cx", d => d.x)
          .attr("cy", d => d.y);

        label
          .attr("x", d => (d.x ?? 0) + ((d.type === 'root') ? 0 : 0))
          .attr("y", d => (d.y ?? 0) - 14);
      }

      function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
      }

      function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }

      // Initial glow by color
      node.style("fill", d => {
        if (d.type === 'root') return '#4e6cff';
        if (d.type === 'category') return color(d.name);
        return '#ffd166';
      });

      // Center root
      const centerX = width / 2;
      const centerY = height / 2;
      rootNode.x = centerX;
      rootNode.y = centerY;
      // Let physics settle
      simulation.alpha(0.9).restart();
    }

    // Tooltip helpers
    function showTooltip(event, d) {
      const html = [];
      html.push(`<span class="t-cat" style="color:#ffd166">Category: ${escapeHtml(d.category ?? d.name)}</span>`);
      if (d.url) html.push(`<div class="t-url">${escapeHtml(d.url)}</div>`);
      tooltip.innerHTML = html.join('<br/>');
      tooltip.style.opacity = '1';
      tooltip.setAttribute('data-id', d.id);
      positionTooltip(event);
    }
    function positionTooltip(event) {
      const x = event.clientX;
      const y = event.clientY;
      tooltip.style.left = x + 'px';
      tooltip.style.top = y + 'px';
      tooltip.style.transform = 'translate(-50%, -120%)';
    }
    function moveTooltip(event) { positionTooltip(event); }
    function hideTooltip() {
      tooltip.style.opacity = '0';
      tooltip.setAttribute('data-id', '');
    }
    function escapeHtml(s) {
      return (s ?? '').toString().replace(/[&<>"']/g, m => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[m]));
    }
    function highlightNode(d) {
      // Temporarily enlarge targeted node and dim others
      svg.selectAll('.node')
        .attr('opacity', n => (n.id === d.id ? 1 : 0.25));
      // Smooth jump to focus
      if (d.x != null && d.y != null) {
        // no explicit camera; could implement mini-pan
      }
    }

    // Live sitemap loader (attempt)
    document.getElementById('load-live').addEventListener('click', () => {
      loadLiveSitemap();
    });

    async function loadLiveSitemap() {
      const candidates = [
        'https://mediaonemarketing.com.sg/sitemap.xml',
        'https://mediaonemarketing.com.sg/sitemap_index.xml'
      ];
      for (const url of candidates) {
        try {
          const items = await fetchSitemapItems(url);
          if (items && items.length > 0) {
            initGraphFromItems(items);
            return;
          }
        } catch (e) {
          // try next
          console.warn('Sitemap fetch failed for', url, e);
        }
      }
      alert('Could not load live sitemap. Falling back to sample data.');
      useSampleData();
    }

    async function fetchSitemapItems(url) {
      const resp = await fetch(url, { mode: 'cors' });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const text = await resp.text();

      // Try parsing sitemap XML
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'application/xml');

      // If <url><loc> entries exist
      const locs = Array.from(doc.querySelectorAll('url > loc')).map(n => n.textContent.trim()).filter(Boolean);

      // If sitemapindex, fetch nested sitemaps
      if (locs.length === 0) {
        const nested = Array.from(doc.querySelectorAll('sitemap > loc')).map(n => n.textContent.trim());
        const results = [];
        for (const nl of nested) {
          try {
            const r = await fetchSitemapItems(nl);
            results.push(...r);
          } catch {
            // skip
          }
        }
        return results;
      }

      // Build approximate article list from URLs
      // We'll derive categories heuristically using the path
      const items = locs
        .filter(u => /digital-marketing-blogs|digital-marketing|blog/.test(u) ) // focus on blog URLs
        .slice(0, 150)
        .map(u => ({
          url: u,
          category: heuristicCategoryFromURL(u)
        }));

      // If too few items, still proceed
      return items;
    }

    function heuristicCategoryFromURL(url) {
      try {
        const u = new URL(url);
        const segs = u.pathname.split('/').filter(Boolean);
        // Look for a category-like segment after known blog root
        const idx = segs.findIndex(s => s.toLowerCase().includes('digital-marketing-blogs') || s.toLowerCase().includes('blog'));
        if (idx !== -1 && segs.length > idx + 1) {
          const cat = segs[idx + 1];
          // Normalize
          const clean = cat.replace(/[-_]+/g, ' ').trim();
          // Capitalize
          return clean.charAt(0).toUpperCase() + clean.slice(1);
        }
      } catch {
        // ignore
      }
      // Fallback: generic category
      return 'General';
    }

    // Fallback dataset (sample data)
    function useSampleData() {
      const sampleItems = [
        { url: 'https://mediaonemarketing.com.sg/digital-marketing-blogs/branding/how-to-build-a-strong-brand/', category: 'Branding' },
        { url: 'https://mediaonemarketing.com.sg/digital-marketing-blogs/branding/brand-positioning-101/', category: 'Branding' },
        { url: 'https://mediaonemarketing.com.sg/digital-marketing-blogs/content-marketing/creating-effective-content/', category: 'Content Marketing' },
        { url: 'https://mediaonemarketing.com.sg/digital-marketing-blogs/content-marketing/content-calendar/', category: 'Content Marketing' },
        { url: 'https://mediaonemarketing.com.sg/digital-marketing-blogs/seo/keyword-research-guide/', category: 'SEO' },
        { url: 'https://mediaonemarketing.com.sg/digital-marketing-blogs/seo/on-page-seo/', category: 'SEO' },
        { url: 'https://mediaonemarketing.com.sg/digital-marketing-blogs/social-media/instagram-marketing-tips/', category: 'Social Media' },
        { url: 'https://mediaonemarketing.com.sg/digital-marketing-blogs/social-media/facebook-ads-strategy/', category: 'Social Media' },
        { url: 'https://mediaonemarketing.com.sg/digital-marketing-blogs/paid-media/ppc-bidding-strategies/', category: 'Paid Media' },
        { url: 'https://mediaonemarketing.com.sg/digital-marketing-blogs/email-marketing/how-to-write-better-emails/', category: 'Email Marketing' },
        { url: 'https://mediaonemarketing.com.sg/digital-marketing-blogs/analytics/analytics-dashboard-setup/', category: 'Analytics' },
        { url: 'https://mediaonemarketing.com.sg/digital-marketing-blogs/influencer/working-with-influencers/', category: 'Influencer Marketing' }
      ];
      initGraphFromItems(sampleItems);
    }

    // On load, try live sitemap; otherwise fallback
    window.addEventListener('load', () => {
      // Start with sample data to render quickly
      useSampleData();

      // Then asynchronously attempt live fetch
      //loadLiveSitemap();
    });

    // Resize handling
    window.addEventListener('resize', () => {
      width = window.innerWidth;
      height = window.innerHeight * 0.78;
      svg.attr("viewBox", [0, 0, width, height]);
      // If graph already rendered, we could re-center; easiest is re-layout by re-running layout
    });
  </script>
</body>
</html>