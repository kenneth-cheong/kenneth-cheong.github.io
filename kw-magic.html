<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digimetrics</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon"
        href="https://mediaonemarketing.com.sg/wp-content/uploads/2023/11/cropped-MediaOne-M-favicon-logo-32x32.png"
        sizes="32x32">
    <style>
        #navbar a i {
            margin-right: 5%;
            /* Adjust spacing as needed */
        }

        #navbar {
            width: 15%;
            background-color: #004c9d;
            color: white;
            padding: 10px;
            position: fixed;
            height: 100%;
            overflow-y: auto;
            border-radius: 10px;
            transition: width 0.3s;
        }

        /* Styles for smaller screens (e.g., mobile) */
        @media screen and (max-width: 768px) {
            #navbar {
                width: 60px;
                /* Reduced width for smaller screens */
            }

            #navbar img {
                width: 100%;
                /* Smaller logo */
            }

            #navbar span {
                display: none;
                /* Hide text labels */
            }

            #main-content {
                margin-left: 80px;
                /* Adjusted margin for smaller navbar */
            }
        }

        #navbar img {
            display: block;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 10%;
            margin-top: 10%;
        }

        #navbar a {
            display: block;
            padding: 10px 15px;
            color: white;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        #navbar a:hover {
            background-color: #0056b3;
        }

        /* Adjust main content area to accommodate the navbar */
        #main-content {
            flex: 1;
            /* Allow main content to take up remaining space */
            margin-left: 17%;
            /* Adjust margin to create space for navbar */
            padding: 20px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 10px;
            background-color: #fbf7f5;
            color: #333;
            text-wrap: wrap;
        }

        input,
        select,
        button,
        textarea {
            padding: 10px;
            margin: 10px;
            border-radius: 10px;
            border: 1px solid #c8c8c8;
            font-family: inherit;
            font-size: 16px;
        }

        button {
            transition: background-color 0.3s, transform 0.1s;
            /* Add transform for a subtle lift effect */
            background-color: #c8c9ca;
        }

        button:hover {
            background-color: #004c9d;
            /* Darker blue on hover */
            transform: translateY(-2px);
            /* Move up slightly on hover */
            cursor: pointer;
            /* Change cursor to a pointer on hover */
            color: white;
        }

        input {
            min-width: 90%;
        }

        .input-short {
            min-width: 30%;
        }

        textarea {
            min-width: 90%;
            min-height: 50px;
            max-width: 90%;
        }

        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            background-color: #fffef7;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            table-layout: auto;
            display: block;
            table-layout: fixed;
            overflow-y: scroll;
        }

        #crawlerReport table {
            height: 600px;
        }

        .hidden-table {
            display: none;
        }

        th {
            resize: horizontal;
        }

        #crawlerReport th,
        #crawlerReport td {
            width: 10%;
            /* Adjust as needed for column distribution */
            overflow-x: auto;
            /* white-space: nowrap; Prevent text from wrapping */
            max-width: 200px;
            /* Adjust as needed */
            overflow-x: auto;
            vertical-align: top;
        }

        th,
        td {
            padding: 12px 8px;
            border: 1px solid #ddd;
            font-size: 14px;
            background-color: white;
            overflow: hidden;
        }

        th {
            background-color: #004c9d;
            position: sticky;
            color: white;
            top: 0;
        }

        .error {
            color: red;
            margin-left: 10px;
        }

        .collapsible {
            background-color: #004c9d;
            font-weight: bold;
            color: white;
            cursor: pointer;
            padding: 20px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 18px;
            transition: background-color 0.3s ease;
        }

        .collapsible:hover {
            background-color: #0056b3;
        }

        .collapsible-loading {
            background-color: #ffad33;
        }

        .content {
            display: none;
            padding: 20px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 10px;
        }

        button.sort-button {
            padding: 3px 6px;
            font-size: 12px;
            margin-left: 5px;
            background-color: #286b37;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }

        button.sort-button:hover {
            background-color: #218838;
        }

        hr {
            border-top: 4px solid rgb(95, 103, 154);
            border-radius: 7px;
            width: 100%;
        }

        .header-container {
            display: flex;
            align-items: center;
            /* Vertically center the items in the container */
            margin: 20px 0;
            /* Add some margin for spacing around the header */
            background-color: black;
            height: 70px;
            border-radius: 10px;
        }

        .header-container img {
            margin-right: 15px;
            /* Space between the image and the text */
            width: 75px;
            /* Adjust the width as needed */
            height: auto;
            /* Maintain aspect ratio */
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 4px solid #f3f3f3;
            /* Light grey */
            border-top: 4px solid #3498db;
            /* Blue */
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }

        p,
        h1,
        h2,
        h3 {
            text-wrap: wrap;
            font-family: 'Roboto', sans-serif;
        }

        h2 {
            margin-top: 20px;
        }

        h1 {
            margin: 0;
            /* Removes default margin */
            font-size: 36px;
            /* Optional: Adjust font size as needed */
        }

        #keywordListContainer {
            display: flex;
            /* Enable Flexbox layout for columns */
            flex-direction: column;
            /* Stack columns vertically */
            max-width: 100%;
            padding: 2px;
        }

        #keywordListContainer h3 {
            font-size: 1em;
            margin-top: 0;
            /* Reduce default margin */
        }

        .keyword-row {
            /* Style each row */
            display: flex;
            /* Use Flexbox for each row */
            align-items: center;
            /* Vertically center content in each row */
            margin-bottom: 5px;
            max-width: 65%;
        }

        .keyword-column {
            /* Style for each column */
            flex: 1;
            /* Each column takes equal width */
            margin-right: 5px;
            /* Space between columns */
            min-width: 50px;
        }

        .keyword-column:hover {
            font-size: 1.1em;
            cursor: pointer;
        }

        .keyword-column:nth-child(1) {
            /* Keyword column */
            flex: 0 0 60%;
        }

        .keyword-column:nth-child(2) {
            /* Search Volume column */
            flex: 0 0 30%;
        }

        .keyword-column:nth-child(3) {
            /* Difficulty column */
            flex: 0 0 22%;
        }

        input[type="checkbox"] {
            width: 3em;
        }


        .checkbox-column {
            flex: 0 0 5%;
            margin-right: 0;
        }

        .column {
            float: left;
            width: 50%;
        }

        ul {
            max-height: 350px;
            overflow: auto;
            width: 100%;
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: Window;
        }

        li {
            margin: 5px;
            padding: 0px;
            align-items: left;
        }

        label,
        label-fixed {
            color: WindowText;
            margin: 0;
            padding: 0;
            width: 100%;
        }

        .label-short {
            width: 100%;
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #auditSummary table {
            width: 50%;
            float: right;
            padding: 20px;
            height: 600px;
        }

        /* Table styling */
        #analysisTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            /* Remove display: block and table-layout: fixed  */
            max-height: 700px;
            /* Or whatever max height you want */
            overflow: auto;
            /* Scrollbars appear only when needed */
        }

        #analysisTable a {
            color: white;
        }

        #analysisTable th,
        #analysisTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            word-wrap: break-word;
            vertical-align: top;
            /* Align content to the top of each cell */
        }

        /* Make the table scrollable if it's too wide */
        #tableContainer {
            width: 100%;
            overflow-x: auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #SEM .column {
            width: 48%;
            /* Adjust as needed */
            float: left;
            /* Float columns side by side */
            margin-right: 2%;
            /* Add spacing between columns */
            box-sizing: border-box;
            /* Include padding and border in width calculation */
        }

        #SEM .column:last-child {
            margin-right: 0;
            /* No margin on the last column */
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 3em;
            height: 1.5em;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 1em;
            width: 1em;
            left: 3px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #004c9d;
        }

        input:focus+.slider {
            box-shadow: 0 0 1px #004c9d;
        }

        input:checked+.slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }


        .toggle-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .toggle-label {
            margin-right: 10px;
        }

        .toggle-label-right {
            margin-left: 10px;
        }

        .header-container img {
            margin-left: 20px;
            width: 400px;
            height: auto;
        }
    </style>
</head>

<body>
    <nav id="navbar">
        <img src="https://static.mycareersfuture.gov.sg/images/company/logos/a42a0e5029fd642119584ecdc6218b3a/MEDIAONE%20BUSINESS%20GROUP%20PTE.%20LTD..png"
            alt="MediaOne SEO Agency Logo">
        <a href="#keywordAnalysis"><i class="fas fa-chart-bar"></i> <span>Keyword Analysis</span></a>
        <a href="#technicalSeo"><i class="fas fa-tools"></i> <span>Technical SEO</span></a>
        <a href="#socialAudit"><i class="fas fa-share-alt"></i> <span>Social Media Audit</span></a>
        <a href="#SEM"><i class="fas fa-ad"></i> <span>SEM</span></a>
        <a href="#contentComparison"><i class="fa fa-search"></i> <span>Content Comparison</span></a>
        <a href="#contentGenerator"><i class="fas fa-pen"></i> <span>Content Generator</span></a>
        <a href=""><i class="fas fa-user"></i> <span>Account</span></a>
    </nav>
    <div id="main-content">
        <div class="header-container">
            <img src="Digimetrics Logo-02.png">
        </div>
        <hr>

        <!-- Input Form for User Data -->
        <div class="column">
            <form id="seoForm">
                <div>
                    <label-fixed for="domain">Targeted Domain / URL:</label-fixed>
                    <input type="url" id="domain" name="domain" required
                        placeholder="Domain: example.com | Webpage: https://www.example.com/">
                    <span class="error" id="domainError"></span>
                </div>
                <div>
                    <label-fixed for="location">Targeted Location or Country (required):</label-fixed>
                    <select id="location" name="location" required>
                        <option value="">Select a location</option>
                        <option value="Singapore">Singapore</option>
                        <option value="Malaysia">Malaysia</option>
                        <option value="Thailand">Thailand</option>
                        <option value="India">India</option>
                        <option value="Indonesia">Indonesia</option>
                        <option value="Japan">Japan</option>
                        <option value="South Korea">South Korea</option>
                        <option value="United States">United States</option>
                        <option value="Vietnam">Vietnam</option>

                    </select>
                </div>

                <div>
                    <label-fixed for="location">Language (required):</label-fixed>
                    <select id="language" name="language" required>
                        <option value="">Select a language</option>
                        <option value="English">English</option>
                        <option value="Chinese (Simplified)">Chinese (Simplified)</option>
                        <option value="Chinese (Traditional)">Chinese (Traditional)</option>
                        <option value="Indonesian">Indonesian</option>
                        <option value="Japanese">Japanese</option>
                        <option value="Korean">Korean</option>
                        <option value="Malay">Malay</option>
                        <option value="Tamil">Tamil</option>
                        <option value="Thai">Thai</option>
                        <option value="Vietnamnese">Vietnamnese</option>
                    </select>
                </div><br>
                <div>
                    <label-fixed for="keywords">Keyword(s) of Interest (comma or newline separated):</label-fixed><br>
                    <textarea id="keywords" name="keywords" required placeholder="keyword1, keyword2"></textarea>
                    <span class="error" id="keywordsError"></span>
                </div>

                <button type="button" id="keyword-research-analysis-button"
                    onclick="validateAndSubmit()">Analyse</button>
                <button type="button" id="similar" onclick="similarKeywords()">Generate Similar
                    Keywords</button>
                <button type="button" id="ranking" onclick="rankingKeywords()">Get Ranking Keywords</button>
            </form>
            <div id="rankingError"></div>
        </div>

        <div class="column">
            <button class="collapsible" id="keyword_suggestions">Keyword Suggestions</button>
            <div class="content" id="keywordSuggestions">
                <div id="keywordListContainer">
                    <h3>Keyword Suggestions:</h3>
                    <div class="keyword-row" id="keywordHeaderRow">
                        <div class="keyword-column" onclick="sortKeywordSuggestions(0)">
                            <strong>Keyword</strong>
                        </div>
                        <div class="keyword-column" onclick="sortKeywordSuggestions(1)">
                            <strong>Search Vol</strong>
                        </div>
                        <div class="keyword-column" onclick="sortKeywordSuggestions(2)">
                            <strong>Difficulty</strong>
                        </div>
                        <div class="checkbox-column"></div><strong>Choose</strong>
                    </div>
                    <ul id="keywordList">
                    </ul>
                </div>
            </div>

            <br>

            <button class="collapsible" id="ranking_keywords">Ranking Keywords</button>
            <div class="content" id="rankingKeywords">
                <div id="keywordListContainer">
                    <h3>Ranked Keywords:</h3>
                    <div class="keyword-row" id="rankedKeywordHeaderRow">
                        <div class="keyword-column" onclick="sortRankedKeywords(0)">
                            <strong>Keyword</strong>
                        </div>
                        <div class="keyword-column" onclick="sortRankedKeywords(1)">
                            <strong>Search Vol</strong>
                        </div>
                        <div class="keyword-column" onclick="sortRankedKeywords(2)">
                            <strong>Rank</strong>
                        </div>
                        <div class="keyword-column" onclick="sortRankedKeywords(3)">
                            <strong>Difficulty</strong>
                        </div>
                        <div class="checkbox-column"></div><strong>Choose</strong>
                    </div>
                    <ul id="rankedKeywordList"></ul>
                </div>
            </div>
        </div>


        <hr>
        <button class="collapsible" id="meta_data">Meta Data</button>
        <div class="content" id="metaData">
            <p><b>Meta Title: </b><span id="targetTitle">-</span></p>
            <p><b>Meta Description: </b><span id="targetDescription">-</span></p>
            <p><b>h1 Header: </b><span id="targetH1">-</span></p>

        </div>

        <button class="collapsible" id="domain_metrics">Domain Metrics (DA, PA, PageSpeed)</button>
        <div class="content" id="domainMetrics">
            <div class="column">
                <p><b>Domain Authority (DA): </b><span id="da">-</span></p>
                <p><b>Page Authority (PA): </b><span id="pa">-</span></p>
                <p><b>Google PageSpeed: </b><span id="targetPagespeed">-</span></p>
                <p><b>Backlinks Spam Score: </b><span id="targetSpamScore">-</span></p>
                <p><b>Backlinks: </b><span id="targetBacklinks">-</span></p>
                <p><b>Referring Domains: </b><span id="targetRefDomains">-</span></p>
                <p><b>Domain Rank: </b><span id="targetDomainRank">-</span></p>
                <p><b>Page Word Count: </b><span id="targetWordCount">-</span></p>
            </div>
            <div class="column">
                <p><b>Internal Links: </b><span id="targetInternalLinks">-</span></p>
                <p><b>External Links: </b><span id="targetExternalLinks">-</span></p>
                <p><b>Flesch Readability: </b><span id="targetReadability">-</span></p>
                <p><b>Images: </b><span id="targetImages">-</span></p>
                <p><b>CLS: </b><span id="targetCls">-</span></p>
                <p><b>LCP: </b><span id="targetLcp">-</span></p>
                <p><b>FID: </b><span id="targetFid">-</span></p>
                <p><b>Schema: </b><span id="targetSchema">-</span></p>
            </div>
            <div style="clear: both;"></div>
            <div> </div> <!-- Clearfix -->
        </div>
        <hr>
        <button class="collapsible" id="keywordAnalysis">Keyword Analysis</button>
        <div class="content" id="keywordAnalysis">
            <div id="keywordAnalysisResults"></div>
            <button id="downloadKeywordAnalysisCSVButton" onclick="downloadKeywordAnalysisTableAsCSV()"
                style="display:none;">Download .csv</button>
        </div>
        <hr>
        <button class="collapsible" id="technicalButton">Technical SEO</button>
        <div class="content" id="technicalSeo">
            <label for="urlInput">Enter URL:</label>
            <input type="text" id="urlInput">
            <br>
            <label for="maxPagesInput">Max Pages to Crawl:</label>
            <input type="number" id="maxPagesInput" value="10">

            <button id="submitBtn">Analyse Website</button>

            <br><br>

            <div id="auditSummary"></div>

            <button class="collapsible" id="gtButton">GTmetrix Results</button>
            <div class="content" id="gtMetrix">
                <div id="gtmetrixReport" style="display:none;">
                    <table>
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Report URL</td>
                                <td id="reportUrl"></td>
                            </tr>
                            <tr>
                                <td>Cumulative Layout Shift</td>
                                <td id="cls"></td>
                            </tr>
                            <tr>
                                <td>Largest Contentful Paint</td>
                                <td id="lcp"></td>
                            </tr>
                            <tr>
                                <td>Total Blocking Time</td>
                                <td id="tbt"></td>
                            </tr>
                            <tr>
                                <td>GTmetrix Grade</td>
                                <td id="grade"></td>
                            </tr>
                            <tr>
                                <td>GTmetrix Performance Score</td>
                                <td id="performance"></td>
                            </tr>
                        </tbody>
                    </table>
                    <br><br>
                </div>
            </div>

            <button class="collapsible" id="pageButton">Page Analysis Results</button>
            <div class="content" id="pageAnalysis">
                <div id="pageAuditReport" style="display:none;">
                    <table>
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>PageSpeed (Desktop)</td>
                                <td id="pagespeed_audit"></td>
                            </tr>
                            <tr>
                                <td>Malware</td>
                                <td id="malware"></td>
                            </tr>
                            <tr>
                                <td>robots.txt</td>
                                <td id="robots"></td>
                            </tr>
                            <tr>
                                <td>Sitemap</td>
                                <td id="sitemap"></td>
                            </tr>
                        </tbody>
                    </table>
                    <br><br>
                </div>
            </div>

            <button class="collapsible" id="crawlerButton">Crawler Report</button>
            <div class="content" id="crawlerSection">
                <div id="crawlerReport" style="display:none;">
                    <table>
                        <thead>
                            <tr>
                                <th>URL</th>
                                <th>Code</th>
                                <th>Title</th>
                                <th>Description</th>
                                <th>Canonical</th>
                                <th>Hreflang</th>
                                <th>Alt Text</th>
                                <th>H1</th>
                                <th>H2</th>
                                <th>Word Count</th>
                                <th>UI/UX</th>
                            </tr>
                        </thead>
                        <tbody id="crawlerTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
        <hr>
        <button class="collapsible" disabled>Social Media Audit</button>
        <div class="content" id="socialAudit">
        </div>

        <hr>
        <button class="collapsible">SEM</button>
        <div class="content" id="SEM">
            <label for="sem_webpages">Webpages (seperated by commas or new lines):</label><br>
            <textarea id="sem_webpages" placeholder="e.g., https://example.com, https://another-example.com"></textarea>
            <br>
            <div class="column">
                <label for="sem_country">Country:</label><br>
                <input type="text" id="sem_country" value="Singapore"><br>
            </div>
            <div class="column">
                <label for="sem_tone">Tone of Voice:</label><br>
                <input type="text" id="sem_tone" value="Salesy"><br>
            </div>
            <div class="column">
                <label for="sem_language">Language:</label><br>
                <input type="text" id="sem_language" value="English"><br>
            </div>
            <div style="clear: both;"></div><br>
            <div class="toggle-container" id="semBrandFocus">
                <span class="toggle-label">Don't Focus on Brand/Company</span>
                <label class="switch">
                    <input type="checkbox" id="brand-checkbox"> <span class="slider round"></span>
                </label>
                <span class="toggle-label-right">Focus on Brand/Company</span>
            </div><br>
            <div class="toggle-container" id="semProductFocus">
                <span class="toggle-label">Don't Focus on Products/Services</span>
                <label class="switch">
                    <input type="checkbox" id="product-checkbox" checked> <span class="slider round"></span>
                </label>
                <span class="toggle-label-right">Focus on Products/Services</span>
            </div>
            <div style="clear: both;"></div>
            <br>
            <label for="sem_additional">Addtional Information (optional):</label><br>
            <textarea id="sem_additional"
                placeholder="You can input information that is not found in the webpage(s) content or focus area(s) here"></textarea></textarea>

            <br>
            <button id="getProducts" onclick="semWebpageProducts()">Step 1: Identify
                products/services/brand/company</button>
            <br>
            <div id="products"></div>
            <br>
            <button id="semAnalyse" onclick="semAnalyseWebsite()">Step 2: Generate KWs, USPs & Audience</button>
            <br>

            <div class="column" id="output"></div>
            <div class="column" id="selected" style="display:none;">
                <h2>Selected</h2>
                <textarea id="selectedText" rows="20"></textarea><br>
                <button id="generateSem" onclick="generateGoogle()">Step 3: Select checkboxes then click here</button>
                <h2>Generated</h2>
                <div id="generated"></div>
            </div>
            <div style="clear: both;"></div>
            <div> </div> <!-- Clearfix -->
        </div>

        <hr>
        <button class="collapsible">Content Comparison</button>
        <div class="content" id="contentComparison">
            <label for="comparison-keyword">Keyword:</label>
            <input type="text" id="comparison-keyword" placeholder="e.g., digital marketing">
            <br>
            <label for="comparison-urls">or URLs (separate by new line or comma):</label>
            <textarea id="comparison-urls"
                placeholder="e.g., https://example.com, https://another-example.com"></textarea>
            <br>
            <div class="column">
                <label for="comparison-language">Language:</label>
                <input type="text" id="comparison-language" value="English" placeholder="e.g., English">
            </div>
            <div class="column">
                <label for="comparison-location">Location:</label>
                <input type="text" id="comparison-location" value="Singapore" placeholder="e.g., Singapore">
            </div>
            <br>
            <button id="analyzeBtn">Analyse (up to 3 mins)</button>

            <div id="loading-messages">
                <p class="message"></p>
            </div>
            <div id="initial-table"></div>
            <div id="comparison-results"></div>
        </div>

        <hr>
        <button class="collapsible">Content Generator</button>
        <div class="content" id="contentGenerator">
            <form id="content-form">
                <div class="column">
                    <div class="column">
                        <label for="gender">Gender:</label><br>
                        <select id="gender" name="gender">
                            <option value=""></option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="non-specfic-gender">Non-Specific</option>
                        </select>
                    </div>
                    <div class="column">
                        <label for="age-range">Age e.g. Students, 30-40 years old:</label>
                        <input class="input-short" type="text" id="age-range" name="age-range">
                    </div>

                    <div style="clear: both;"></div>

                    <label for="occupation">Occupation e.g. Homemakers, Professionals:</label><br>
                    <input type="text" id="occupation" name="occupation">

                    <label for="income">Income (e.g. Mid Income):</label>
                    <input type="text" id="income" name="income">

                    <label for="reference-url">Reference Webpage URL (Optional):</label>
                    <input type="url" id="reference-url" name="reference-url">

                </div>

                <div class="column">

                    <label for="subgroups">Sub-Groups (e.g. Badminton Players):</label>
                    <input type="text" id="subgroups" name="subgroups">

                    <label for="painpoints">Pain Points (e.g. not enough time):</label>
                    <input type="text" id="painpoints" name="painpoints">

                    <label for="audience_goal">Audience Goals (e.g. Convenience):</label>
                    <input type="text" id="audience_goal" name="audience_goal">

                </div>


                <br>

                <label for="reference-files">Reference Files/Brand Guide (Optional - Up to 5):</label>
                <input class="input-short" type="file" id="reference-files" name="reference-files" multiple disabled>
                <br><br>

                <label for="sample-text">Sample Text/Post (Optional):</label><br>
                <textarea id="sample-text" name="sample-text"></textarea><br><br>

                <label for="post-info">Content of Post:</label><br>
                <textarea id="post-info" name="post-info"></textarea><br><br>

                <div class="column">

                    <label for="product_service">Product / Service:</label>
                    <input type="text" id="product_service" name="product_service">

                    <label for="desired_action">Desired Action e.g. Contact us:</label>
                    <input type="text" id="desired_action" name="desired_action">
                    <br>

                    <label for="post_objectives">Post Objectives e.g. Branding, Lifestyle, Seasonal Greetings:</label>
                    <input type="text" id="post_objectives" name="post_objectives">

                    <div class="column">
                        <label for="content-type">Type of Content:</label><br>
                        <select id="content-type" name="content-type">
                            <option value="blog-post">Blog Post</option>
                            <option value="instagram-caption">Instagram Caption</option>
                            <option value="facebook-post">Facebook Post</option>
                            <option value="linkedin-post">LinkedIn Post</option>
                        </select>
                    </div>

                    <br>
                    <div class="column">

                        <label for="word_count">Word Count e.g. Long, 100 words:</label>
                        <input class="input-short" type="text" id="word_count" name="word_count">
                    </div>


                </div>

                <div class="column">

                    <label for="tone">Tone of Voice e.g. Luxury, Professional, Casual:</label>
                    <input type="text" id="tone" name="tone">
                    <br>

                    <label for="usp">Unique Selling Point e.g. Available 24/7, Budget friendly:</label>
                    <input type="text" id="usp" name="usp">

                    <label for="pov">POV e.g. 1st person, 3rd person:</label>
                    <input type="text" id="pov" name="pov">
                    <br>

                    <div class="column">
                        <label for="emojis">Emojis:</label><br>
                        <select id="emojis" name="emojis">
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                    <div class="column">
                        <label for="hashtags">Hashtags:</label><br>
                        <select id="hashtags" name="hashtags">
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    </div>
                </div>
                <div style="clear: both;"></div>

                <button type="submit" id="generate-button">Generate Content</button>
            </form>

            <div id="generated-content"></div>
        </div>
    </div>

    <script>
        const submitBtn = document.getElementById('submitBtn');
        const gtmetrixReportDiv = document.getElementById('gtmetrixReport');
        const crawlerReportDiv = document.getElementById('crawlerReport');
        const crawlerTableBody = document.getElementById('crawlerTableBody');
        const pageAuditReportDiv = document.getElementById('pageAuditReport');

        const analyzeBtn = document.getElementById('analyzeBtn');
        const resultsDiv = document.getElementById('comparison-results');
        const loadingMessagesDiv = document.getElementById('loading-messages');
        const messageElement = document.querySelector('.message');
        const messages = [
            'Getting SERP results...',
            'Analysing Page Content...',
            'Formulating Content Topics...',
            'Comparing Topics Across Results...',
            'Collating Findings...'
        ];
        let currentMessageIndex = 0;

        brandCheckbox = document.getElementById('brand-checkbox');
        productCheckbox = document.getElementById('product-checkbox');

        brandCheckbox.addEventListener('change', () => {
            if (brandCheckbox.checked) {
            } else {
                if (productCheckbox.checked) {

                } else {
                    productCheckbox.checked = true;
                }
            }
        });

        productCheckbox.addEventListener('change', () => {
            if (productCheckbox.checked) {
            } else {
                if (brandCheckbox.checked) {

                } else {
                    brandCheckbox.checked = true;
                }
            }
        });

        submitBtn.addEventListener('click', () => {
            const url = document.getElementById('urlInput').value;
            const maxPages = document.getElementById('maxPagesInput').value;

            submitBtn.innerHTML = 'Analysing...';
            document.getElementById("technicalButton").style.backgroundColor = "#004c9d";
            document.getElementById("gtButton").style.backgroundColor = "#004c9d";
            document.getElementById("pageButton").style.backgroundColor = "#004c9d";
            document.getElementById("crawlerButton").style.backgroundColor = "#004c9d";

            document.getElementById('auditSummary').innerHTML = "";

            // GTMetrix API call
            fetch("https://y5830908vh.execute-api.ap-southeast-1.amazonaws.com/gtmetrix", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            })
                .then(response => response.json())
                .then(gt_data => {
                    document.getElementById('reportUrl').innerHTML = '<a href="' + gt_data.body.data.links.report_url + '" target="_blank" rel="noopener noreferrer">' + gt_data.body.data.links.report_url + '</a>';
                    document.getElementById('cls').textContent = gt_data.body.data.attributes.cumulative_layout_shift;
                    document.getElementById('lcp').textContent = gt_data.body.data.attributes.largest_contentful_paint;
                    document.getElementById('tbt').textContent = gt_data.body.data.attributes.total_blocking_time;
                    document.getElementById('grade').textContent = gt_data.body.data.attributes.gtmetrix_grade;
                    document.getElementById('performance').textContent = gt_data.body.data.attributes.performance_score;

                    gtmetrixReportDiv.style.display = 'block';
                    document.getElementById("gtButton").style.backgroundColor = "green";

                })
                .catch(error => console.error('Error fetching GTMetrix data:', error));


            // Webpage Audit
            fetch("https://7vkudwlzhh.execute-api.ap-southeast-1.amazonaws.com/webpageAudit", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            })
                .then(response => response.json())
                .then(webpage_audit_data => {
                    document.getElementById('malware').textContent = webpage_audit_data.body.malware;
                    document.getElementById('sitemap').textContent = webpage_audit_data.body.sitemap;
                    document.getElementById('robots').innerHTML = webpage_audit_data.body.robots;
                    document.getElementById('pagespeed_audit').textContent = webpage_audit_data.body.pagespeed;

                    pageAuditReportDiv.style.display = 'block';
                    document.getElementById("pageButton").style.backgroundColor = "green";
                    document.getElementById("technicalButton").style.backgroundColor = "green";
                })
                .catch(error => console.error('Error fetching Webpage Audit data:', error));


            // Crawler API call
            fetch("https://464q7iox7h.execute-api.ap-southeast-1.amazonaws.com/crawler", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url, max_pages: parseInt(maxPages) })
            })
                .then(response => response.json())
                .then(data => {
                    crawlerTableBody.innerHTML = ''; // Clear previous data

                    for (const pageUrl in data.body) {
                        const pageData = data.body[pageUrl];
                        const row = document.createElement('tr');
                        row.innerHTML = `   
                        <td>${pageUrl}</td>
                        <td>${pageData.code}</td>
                        <td>${pageData.title}</td>
                        <td>${pageData.description}</td>
                        <td>${pageData.canonical}</td>
                        <td>${pageData.hreflang}</td>
                        <td>${pageData.alt_text}</td>
                        <td>${pageData.h1}</td>
                        <td>${pageData.h2}</td>
                        <td>${pageData.word_count}</td>
                        <td>${pageData.uiux}</td>
                    `;
                        crawlerTableBody.appendChild(row);
                    }
                    crawlerReportDiv.style.display = 'block';
                    submitBtn.innerHTML = 'Analyse Website';


                    // Audit Summary
                    gt_data = { "cumulative_layout_shift": document.getElementById('cls').textContent, "largest_contentful_paint": document.getElementById('lcp').textContent, "total_blocking_time": document.getElementById('tbt').textContent };
                    webpage_audit_data = { 'google_safe_site': document.getElementById('malware').textContent, 'sitemap': document.getElementById('sitemap').textContent, 'robots_txt': document.getElementById('robots').innerHTML, 'pagespeed': document.getElementById('pagespeed_audit').textContent };

                    fetch("https://ccgdpp7dna.execute-api.ap-southeast-1.amazonaws.com/techAuditSummary", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ crawl: data, gtmetrix: gt_data, webpage_audit: webpage_audit_data })
                    })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('auditSummary').innerHTML = data.body;
                            document.getElementById("crawlerButton").style.backgroundColor = "green";
                        })
                        .catch(error => console.error('Error fetching Audt Summary API:', error));

                })
                .catch(error => {
                    console.error('Error fetching crawler data:', error);
                    submitBtn.innerHTML = 'Analyse Website';
                })

        });

        analyzeBtn.addEventListener('click', async () => {
            // Show loading messages, hide previous results
            resultsDiv.innerHTML = '';
            analyzeBtn.innerHTML = 'Analysing...';
            loadingMessagesDiv.classList.add('active');

            keyword = document.getElementById('comparison-keyword').value;
            const urlsInput = document.getElementById('comparison-urls').value;
            const language = document.getElementById('comparison-language').value;
            const location = document.getElementById('comparison-location').value;
            urls = urlsInput.split(/[\s,]+/).filter(url => url.trim() !== "");

            try {
                // Function to cycle through loading messages
                function updateLoadingMessage() {
                    messageElement.textContent = messages[currentMessageIndex];
                    currentMessageIndex = (currentMessageIndex + 1) % messages.length;
                }

                // Start cycling loading messages
                const loadingMessageInterval = setInterval(updateLoadingMessage, 4000);

                let serpUrls = [];
                try {
                    if (keyword != "") {
                        // 1. Fetch URLs from SERP API
                        const serpResponse = await fetch('https://u22k9g2y8c.execute-api.ap-southeast-1.amazonaws.com/new', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ keyword, language, location }),
                        });
                        const serpData = await serpResponse.json();
                        if (serpData.statusCode !== 200) {
                            throw new Error(`SERP API Error: ${serpData.body || serpData.errorMessage}`);
                        }
                        serpUrls = Object.values(serpData.body).map(result => result.url);

                        if (urls != "") {
                            serpUrls = [...new Set([...serpUrls, ...urls])]; // Combine and deduplicate
                        }

                    } else {
                        serpUrls = urls;
                    }
                } catch (error) {
                    serpUrls = urls;
                }

                // 2. Fetch content analysis for each URL *concurrently*
                const analysisPromises = serpUrls.map(url =>
                    fetch('https://u24f9208q0.execute-api.ap-southeast-1.amazonaws.com/gptTopicsPerUrl', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, keyword }),
                    }).then(res => {
                        if (!res.ok) {  // Check for errors
                            throw new Error(`Content analysis API error for ${url}: ${res.status} ${res.statusText}`);
                        }
                        return res.json();
                    })
                );

                // Wait for *all* content analysis calls to complete
                analysisDataArray = await Promise.all(analysisPromises);

                // Combine analysis data, handling potential errors from individual API calls
                analysisData = {};
                analysisDataArray.forEach(item => {
                    url = Object.keys(item['body'])[0];
                    analysisData[url] = item['body'][url];
                }
                );

                // Check if analysisData is empty after combining results.
                if (Object.keys(analysisData).length === 0) {
                    throw new Error("Content analysis failed for all URLs. Please check the URLs and try again.");
                }

                // 3. Create and display the table (modified createAnalysisTable function below)
                comparisonTableHTML = createAnalysisTable(analysisData, keyword, urls);  // Pass keyword and target URLs
                document.getElementById('initial-table').innerHTML = `<div id="tableContainer">${comparisonTableHTML}</div>`;

                // 4. Apply gradients (no change needed)
                applyGradientsToRows();

                // 5. Submit table data to comparisonRecommender API
                const comparisonResponse = await fetch('https://33v5mhjt47.execute-api.ap-southeast-1.amazonaws.com/comparisonRecommender', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ output: analysisData, keyword }), // Send analysisData directly
                });
                const comparisonData = await comparisonResponse.json();

                // Display recommendations and output table from comparison API
                const recommendation = comparisonData.body.recommendation;

                try {
                    //const outputTableHTML = createHTMLTableFromJSON(comparisonData.body.output); // Parse JSON string to object
                    const outputTableHTML = createAnalysisTable(comparisonData.body.output, keyword, urls)
                    document.getElementById('initial-table').innerHTML = "";
                    document.getElementById('initial-table').innerHTML = `<div id="tableContainer">${outputTableHTML}</div>`;
                    resultsDiv.innerHTML += `<pre>${recommendation}</pre>`;
                    console.log('refresh succesful');

                    // 4. Apply gradients (no change needed)
                    applyGradientsToRows();

                } catch (error) {
                    console.log(error)
                    resultsDiv.innerHTML += `<pre>${recommendation}</pre>`;
                }

                // --- Data is ready, stop loading messages ---
                clearInterval(loadingMessageInterval);
                loadingMessagesDiv.classList.remove('active');

                analyzeBtn.innerHTML = 'Analyse (up to 3 mins)';

            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                try {
                    clearInterval(loadingMessageInterval);
                } catch (error) {
                }
                loadingMessagesDiv.classList.remove('active');
                analyzeBtn.innerHTML = 'Analyse (up to 3 mins)';
            }
        });

        // Function to create the HTML table from the analysis data
        function createAnalysisTable(data, keyword, targetUrls) {
            let tableHTML = '<table id="analysisTable">';
            tableHTML += '<tr><th>URL</th>';

            const urls = Object.keys(data);
            urls.forEach(url => {
                tableHTML += `<th ${targetUrls.includes(url) && keyword ? 'class="targetUrl"' : ''}>
                        <a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a></th>`;
            });
            tableHTML += '</tr>';


            // Add Word Count row
            tableHTML += '<tr><td>Word Count</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td data-value="${data[url].word_count}">${data[url].word_count}</td>`;
                } catch (error) {
                    tableHTML += `<td data-value="0">0</td>`;
                }
            });
            tableHTML += '</tr>';

            // Add Page Type row
            tableHTML += '<tr><td>Page Type</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td>${data[url].page_type}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            // Add headings rows
            tableHTML += '<tr><td>h1</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td> • ${data[url].h1.join('<br> • ')}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            tableHTML += '<tr><td>h2</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td> • ${data[url].h2.join('<br> • ')}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            tableHTML += '<tr><td>h3</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td> • ${data[url].h3.join('<br> • ')}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            // Get all unique topics, handling missing topics
            let allTopics = [];
            urls.forEach(url => {
                if (data[url] && data[url].topics) {
                    allTopics = [...allTopics, ...Object.keys(data[url].topics)];
                }
            });
            const uniqueTopics = [...new Set(allTopics)];

            // Add Topic rows (handling missing topic data)
            uniqueTopics.forEach(topic => {
                tableHTML += `<tr><td>${topic.replaceAll('_', ' ')}</td>`;
                urls.forEach(url => {
                    const value = (data[url] && data[url].topics && data[url].topics[topic]) ? data[url].topics[topic] : 0;
                    tableHTML += `<td data-value="${value}">${value}</td>`;
                });
                tableHTML += '</tr>';
            });

            tableHTML += '</table>';
            return tableHTML;
        }

        function applyGradientsToRows() {
            const table = document.getElementById('analysisTable');
            for (let i = 1; i < table.rows.length; i++) { // Start from row 1 to skip header
                applyGradientToRow(table.rows[i]);
            }
        }

        function applyGradientToRow(row) {
            const values = Array.from(row.cells)
                .slice(1) // Skip the first cell (topic name)
                .map(cell => {
                    const value = parseFloat(cell.dataset.value);
                    return isNaN(value) ? -1 : value; // Assign -1 for non-numeric values
                });

            const max = Math.max(...values);
            const min = Math.min(...values);

            values.forEach((value, index) => {
                const cell = row.cells[index + 1]; // +1 to account for the first cell
                if (!isNaN(value) && value !== -1) { // Apply gradient only to numeric values
                    const percent = (value - min) / (max - min);
                    const red = Math.round(255 * (1 - percent));
                    const green = Math.round(255 * percent);
                    cell.style.backgroundColor = `rgb(${red}, ${green}, 0)`;
                }
            });
        }

        const form = document.getElementById('content-form');
        const generatedContentDiv = document.getElementById('generated-content');
        const generateButton = document.getElementById('generate-button');

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            // Disable the button and change text
            generateButton.disabled = true;
            generateButton.textContent = 'Generating Content...';

            const formData = new FormData(form);
            const contentData = {
                "url": formData.get('reference-url'),
                "reference_post": formData.get('sample-text'),
                "content_type": formData.get('content-type'),
                "post_info": formData.get('post-info'),
                "gender": formData.get('gender'),
                "age-range": formData.get('age-range'),
                "occupation": formData.get('occupation'),
                "income": formData.get('income'),
                "subgroups": formData.get('subgroups'),
                "painpoints": formData.get('painpoints'),
                "audience_goal": formData.get('audience_goal'),
                "product_service": formData.get('product_service'),
                "desired_action": formData.get('desired_action'),
                "post_objectives": formData.get('post_objectives'),
                "word_count": formData.get('word_count'),
                "tone": formData.get('tone'),
                "usp": formData.get('usp'),
                "pov": formData.get('pov'),
                "emojis": formData.get('emojis'),
                "hashtags": formData.get('hashtags')
            };

            try {
                const response = await fetch('https://panc0eazwj.execute-api.ap-southeast-1.amazonaws.com/content-generator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(contentData)
                });

                const data = await response.json();

                // Display the API response or error
                if (response.ok) {
                    generatedContentDiv.innerHTML = `<p>${data}</p>`;
                } else {
                    generatedContentDiv.innerHTML = `<p class="error">Error: ${data.error || response.statusText}</p>`;
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                generatedContentDiv.innerHTML = '<p class="error">An error occurred while fetching data.</p>';
            } finally {
                // Re-enable the button and reset text
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Content';
            }
        });

        function similarKeywords() {
            const keywordsInput = document.getElementById('keywords').value.split(/[\n,]+/).map(k => k.trim());
            const location = document.getElementById('location').value;

            if (keywordsInput[0] == "") {
                document.getElementById('rankingError').textContent = 'Please enter keyword(s).';
                return;
            }
            if (!location) {
                document.getElementById('rankingError').textContent = 'Please select a location.';
                return;
            }

            document.getElementById("keyword_suggestions").style.backgroundColor = "#004c9d";
            document.getElementById('similar').innerText = "Generating...";

            var url = "https://lgvdhcs4t2.execute-api.ap-southeast-1.amazonaws.com/similarKeywords";
            var queryString = [{
                "keywords": keywordsInput,
                "location": location,
            }];
            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json",
            };
            fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(queryString)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    //console.log("Similar Keywords:", data);
                    displaySimilarKeywords(data);
                    document.getElementById('similar').innerText = "Generate Similar Keywords";
                    document.getElementById("keyword_suggestions").style.backgroundColor = "green";
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                    document.getElementById('similar').innerText = "Generate Similar Keywords";
                    document.getElementById("keyword_suggestions").style.backgroundColor = "#004c9d";
                });
        }

        function rankingKeywords() {
            var domain = document.getElementById('domain').value;
            var location = document.getElementById('location').value;

            document.getElementById('rankingError').textContent = '';
            document.getElementById("ranking_keywords").style.backgroundColor = "#004c9d";

            if (!domain) {
                document.getElementById('rankingError').textContent = 'Please enter a URL or domain.';
                return;
            }
            if (!location) {
                document.getElementById('rankingError').textContent = 'Please select a location.';
                return;
            }

            document.getElementById('ranking').innerText = "Generating...";

            var url = "https://0dqny7l5y9.execute-api.ap-southeast-1.amazonaws.com/rankingKeywords";

            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json",
            };

            var queryString = {
                "target": domain,
                "location": location,
            };

            fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(queryString)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Ranking Keywords:", data.body);
                    displayRankedKeywords(data.body);
                    document.getElementById('ranking').innerText = "Get Ranking Keywords";
                    document.getElementById("ranking_keywords").style.backgroundColor = "green";
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                    document.getElementById('ranking').innerText = "Get Ranking Keywords";
                    document.getElementById("ranking_keywords").style.backgroundColor = "#004c9d";
                });
        }

        function displayRankedKeywords(rankedKeywordsData) {
            const rankedKeywordList = document.getElementById('rankedKeywordList');
            rankedKeywordList.innerHTML = ''; // Clear previous keywords

            const headerCells = Array.from(document.querySelectorAll('#rankedKeywordHeaderRow .keyword-column'));

            // Convert the object to an array of objects, suitable for sorting
            const rankedKeywordsArray = Object.entries(rankedKeywordsData).map(([keyword, data]) => ({
                keyword: keyword,
                search_volume: data.search_volume,
                rank: data.rank,
                difficulty: data.difficulty // Add difficulty here later if available
            }));



            rankedKeywordsArray.forEach((item, index) => {

                const listItem = document.createElement('li');
                listItem.classList.add('keyword-row');

                // Keyword column
                const keywordDiv = document.createElement('div');
                keywordDiv.classList.add('keyword-column');
                keywordDiv.style.width = `${headerCells[0].offsetWidth}px`;
                keywordDiv.textContent = item.keyword;
                listItem.appendChild(keywordDiv);

                // Search Volume column
                const searchVolumeDiv = document.createElement('div');
                searchVolumeDiv.classList.add('keyword-column');
                searchVolumeDiv.style.width = `${headerCells[1].offsetWidth}px`;
                searchVolumeDiv.textContent = item.search_volume || '-';
                listItem.appendChild(searchVolumeDiv);


                // Rank column
                const rankDiv = document.createElement('div');
                rankDiv.classList.add('keyword-column');
                rankDiv.style.width = `${headerCells[2].offsetWidth}px`;
                rankDiv.textContent = item.rank || '-';
                listItem.appendChild(rankDiv);


                // Difficulty column (placeholder for now)
                const difficultyDiv = document.createElement('div');
                difficultyDiv.classList.add('keyword-column');
                difficultyDiv.style.width = `${headerCells[3].offsetWidth}px`;
                difficultyDiv.textContent = item.difficulty || '-'; // Display '-' or the actual value if you get it later
                listItem.appendChild(difficultyDiv);


                // Checkbox column (keep existing style)
                const checkboxDiv = document.createElement('div');
                checkboxDiv.classList.add('checkbox-column');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = `chk${index + 1}`; // Use index for unique names
                checkbox.id = `chk${index + 1}`;
                checkbox.value = item.keyword;
                checkbox.checked = false;
                checkboxDiv.appendChild(checkbox);
                listItem.appendChild(checkboxDiv);

                checkbox.addEventListener('change', updateKeywordsField);

                rankedKeywordList.appendChild(listItem);
            });
        }

        function displaySimilarKeywords(keywordsData) {
            const keywordList = document.getElementById('keywordList');
            keywordList.innerHTML = ''; // Clear previous keywords

            const headerCells = Array.from(document.querySelectorAll('#keywordHeaderRow .keyword-column'));

            // 1. Transform the data:
            const keywordsArray = Object.entries(keywordsData.body).map(([keyword, data]) => ({
                keyword,
                search_volume: data.search_volume,
                competition: data.competition
            }));

            keywordsArray.forEach((keywordObj, index) => {
                const listItem = document.createElement('li');
                listItem.classList.add('keyword-row');

                // Keyword column
                const keywordDiv = document.createElement('div');
                keywordDiv.classList.add('keyword-column');
                keywordDiv.style.width = `${headerCells[0].offsetWidth}px`;
                keywordDiv.textContent = keywordObj.keyword;
                listItem.appendChild(keywordDiv);

                // Search Volume column
                const searchVolumeDiv = document.createElement('div');
                searchVolumeDiv.classList.add('keyword-column');
                searchVolumeDiv.style.width = `${headerCells[1].offsetWidth}px`;
                searchVolumeDiv.textContent = keywordObj.search_volume != null ? keywordObj.search_volume.toLocaleString() : '-'; // Handle null search volume
                listItem.appendChild(searchVolumeDiv);

                // Difficulty column
                const difficultyDiv = document.createElement('div');
                difficultyDiv.classList.add('keyword-column');
                difficultyDiv.style.width = `${headerCells[2].offsetWidth}px`;
                difficultyDiv.textContent = keywordObj.competition || '-';
                listItem.appendChild(difficultyDiv);

                // Checkbox column
                const checkboxDiv = document.createElement('div');
                checkboxDiv.classList.add('checkbox-column');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = `chk${index + 1}`;
                checkbox.id = `chk${index + 1}`;
                checkbox.value = keywordObj.keyword;
                checkbox.checked = false;
                checkboxDiv.appendChild(checkbox);
                listItem.appendChild(checkboxDiv);

                checkbox.addEventListener('change', updateKeywordsField);

                keywordList.appendChild(listItem);
            });
        }

        function updateKeywordsField() {
            const keywordsTextArea = document.getElementById('keywords');
            const checkedKeywords = [];

            // Get checked keywords from both tables
            const similarKeywordsCheckboxes = document.querySelectorAll('#keywordList input[type="checkbox"]:checked');
            const rankedKeywordsCheckboxes = document.querySelectorAll('#rankedKeywordList input[type="checkbox"]:checked');

            similarKeywordsCheckboxes.forEach(checkbox => checkedKeywords.push(checkbox.value));
            rankedKeywordsCheckboxes.forEach(checkbox => checkedKeywords.push(checkbox.value));

            keywordsTextArea.value = checkedKeywords.join(', '); // Update the textarea

        }

        function validateAndSubmit() {
            const domain = document.getElementById('domain').value;
            const keywordsInput = document.getElementById('keywords').value;
            const location = document.getElementById('location').value;

            document.getElementById('domainError').textContent = '';
            document.getElementById('keywordsError').textContent = '';

            if (!domain) {
                document.getElementById('domainError').textContent = 'Please enter a valid URL.';
                return;
            }
            if (!keywordsInput) {
                document.getElementById('keywordsError').textContent = 'Please enter one or more keywords.';
                return;
            }
            if (!location) {
                alert("Please select a location.");
                return;
            }

            const keywords = keywordsInput.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);

            document.getElementById('targetTitle').innerText = "";
            document.getElementById('targetDescription').innerText = "";
            document.getElementById('targetDomainRank').innerText = "";
            document.getElementById('targetBacklinks').innerText = "";
            document.getElementById('targetSpamScore').innerText = "";
            document.getElementById('targetPagespeed').innerText = '-/100';
            document.getElementById('targetRefDomains').innerText = "";
            document.getElementById('targetInternalLinks').innerText = "";
            document.getElementById('targetExternalLinks').innerText = "";
            document.getElementById('targetH1').innerText = "";
            document.getElementById('targetImages').innerText = "";
            document.getElementById('targetCls').innerText = "";
            document.getElementById('targetLcp').innerText = "";
            document.getElementById('targetFid').innerText = "";
            document.getElementById('targetSchema').innerText = "";
            document.getElementById('targetReadability').innerText = "";
            document.getElementById('targetWordCount').innerText = "";
            document.getElementById('da').innerText = "";
            document.getElementById('pa').innerText = "";

            document.getElementById("meta_data").style.backgroundColor = "#004c9d";
            document.getElementById("domain_metrics").style.backgroundColor = "#004c9d";
            document.getElementById("keywordAnalysis").style.backgroundColor = "#004c9d";

            fetchDomainMetrics(domain);
            keywordAnalysis();
        }

        async function keywordAnalysis() {
            document.getElementById("keyword-research-analysis-button").innerHTML = "Analysing...";
            const domain = document.getElementById("domain").value;
            const keywords = document.getElementById("keywords").value.split(/[\n,]+/).map(s => s.trim()).filter(s => s !== "");
            const location = document.getElementById("location").value;
            const language = document.getElementById("language").value;

            const keywordAnalysisResults = document.getElementById("keywordAnalysisResults");
            keywordAnalysisResults.innerHTML = ""; // Clear previous results


            const keywordMetrics = await Promise.all(keywords.map(keyword =>
                fetch('https://785lzorod8.execute-api.ap-southeast-1.amazonaws.com/kwMetrics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword, location, language, target_url: domain })
                }).then(res => res.json())
            ));


            let keywordTableHtml = "<table><tr><th>No.</th><th>Keyword</th><th>Search Volume</th><th>KW Difficulty</th><th>Current Rank</th><th>Time To Rank</th><th>Comments</th></tr>";
            keywordMetrics.forEach((data, index) => {
                keywordTableHtml += `<tr onclick="showSERPs(${index})"><td>${index + 1}</td><td id="keyword-${index}" class="keyword-cell" onmouseover="" style="cursor: pointer;">${data.body.keyword}       <div class="loading-spinner" id="spinner-${index}"></div></td><td>${data.body.search_volume}</td><td>${data.body.competition}</td><td>${data.body.rank}</td><td><div class="loading-spinner" id="kw-${index}-time-to-rank"></div></td><td><div class="loading-spinner" id="kw-${index}-time-to-rank-reason"></div></td></tr>`; // Spinner for Time to Rank and keyword
            });
            keywordTableHtml += "</table>";
            keywordAnalysisResults.innerHTML = keywordTableHtml;
            document.getElementById("downloadKeywordAnalysisCSVButton").style.display = "block";
            document.getElementById("keywordAnalysis").style.backgroundColor = "green";

            const serpData = {};
            const pageMetrics = {};

            await Promise.all(keywords.map(async (keyword, index) => {
                const serpResponse = await fetch('https://u22k9g2y8c.execute-api.ap-southeast-1.amazonaws.com/new', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ location, keyword, language })
                }).then(res => res.json());
                serpData[index] = serpResponse.body;

                await Promise.all(Object.values(serpResponse.body).map(async result => {
                    const metricsResponse = await fetch('https://5zdbpwaia5.execute-api.ap-southeast-1.amazonaws.com/pageDomainMetrics', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: result.url, keyword })
                    }).then(res => res.json());
                    pageMetrics[result.url] = metricsResponse.body; // Store by URL
                }));

                await createSERPTable(index, serpData[index], pageMetrics, keyword); // create and initially hide the tables
                await getTimeTakenToRank(index, keyword);

                const spinner = document.getElementById(`spinner-${index}`);
                spinner.remove(); // Remove spinner element completely
            }));
        }

        async function getTimeTakenToRank(index, keyword) {
            const serpTable = document.getElementById(`serp-table-${index}`);
            try {
                const res = await fetch('https://6qyc0fatt2.execute-api.ap-southeast-1.amazonaws.com/timeTakenToRank', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: serpTable.innerHTML, url: domain, keyword, location, language })
                });

                const timeTakenToRankData = await res.json();
                console.log(timeTakenToRankData);
                console.log(`Time to Rank for ${keyword}:`, timeTakenToRankData.body.choice);


                // Update the correct row in the first table (keywordMetrics table)
                document.getElementById(`kw-${index}-time-to-rank`).classList.remove('loading-spinner');
                document.getElementById(`kw-${index}-time-to-rank`).innerHTML = timeTakenToRankData.body.choice.replaceAll('"', '').replace('choice: ', '').replace('{', '');

                document.getElementById(`kw-${index}-time-to-rank-reason`).classList.remove('loading-spinner');
                document.getElementById(`kw-${index}-time-to-rank-reason`).innerHTML = timeTakenToRankData.body.reason.replaceAll('"', '').replace('reason: ', '').replace('}', '');

            } catch (error) {
                console.error(`Error getting Time To Rank for ${keyword}:`, error);
                // Handle the error appropriately (e.g., display an error message in the table)
                document.getElementById(`kw-${index}-time-to-rank`).classList.remove('loading-spinner');
                document.getElementById(`kw-${index}-time-to-rank`).innerHTML = "Error"; // Or some error message

                document.getElementById(`kw-${index}-time-to-rank-reason`).classList.remove('loading-spinner');
                document.getElementById(`kw-${index}-time-to-rank-reason`).innerHTML = "Error"; // Or some error message

            }
        }

        function createSERPTable(index, serpResults, pageMetrics, keyword) {
            let serpTableHtml = `<br><table class="hidden-table" id="serp-table-${index}">`;
            serpTableHtml += `<tr><th>Rank</th><th>URL</th><th>Title</th><th>Description</th><th>Domain Rank</th><th>Backlinks</th><th>Spam Score</th><th>Referring Domains</th><th>KW in URL</th><th>KW in Title</th><th>KW in Desc</th><th>KW in H1</th><th>KW in H2</th><th>KW in Alt</th><th>KW in Text</th><th>Word Count</th></tr>`;

            rowsPopulated = 0;

            for (const rank in serpResults) {
                const result = serpResults[rank];
                const metrics = pageMetrics[result.url] || {};
                const evalMetrics = metrics.eval || {};

                serpTableHtml += `<tr><td>${parseInt(rank)}</td><td>${result.url}</td><td>${result.title}</td><td>${result.description}</td>
                             <td><div class="loading-spinner"></div></td><td><div class="loading-spinner"></div></td><td><div class="loading-spinner"></div></td>
                              <td><div class="loading-spinner"></div></td><td><div class="loading-spinner"></div></td><td><div class="loading-spinner"></div></td>
                              <td><div class="loading-spinner"></div></td><td><div class="loading-spinner"></div></td><td><div class="loading-spinner"></div></td>
                              <td><div class="loading-spinner"></div></td><td><div class="loading-spinner"></div></td><td><div class="loading-spinner"></div></td></tr>`;

                setTimeout(() => { // Use setTimeout to ensure elements are created
                    const domainRankCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(5)`);
                    domainRankCell.innerHTML = metrics.domain_rank || '-';

                    const backlinksCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(6)`);
                    backlinksCell.innerHTML = metrics.backlinks || '-';

                    const spamCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(7)`);
                    spamCell.innerHTML = metrics.backlinks_spam_score || '-';

                    const referringhDomainsCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(8)`);
                    referringhDomainsCell.innerHTML = metrics.referring_domains || '-';

                    // ... similarly update other cells (spam score, referring domains, etc.) ...
                    const kwInUrlCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(9)`);
                    kwInUrlCell.innerHTML = evalMetrics.kw_in_url || '-';

                    const kwInTitleCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(10)`);
                    kwInTitleCell.innerHTML = evalMetrics.kw_in_title || '-';

                    const kwInDescCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(11)`);
                    kwInDescCell.innerHTML = evalMetrics.kw_in_desc || '-';

                    const kwInH1Cell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(12)`);
                    kwInH1Cell.innerHTML = evalMetrics.kw_in_h1 || '-';

                    const kwInH2Cell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(13)`);
                    kwInH2Cell.innerHTML = evalMetrics.kw_in_h2 || '-';

                    const kwInAltCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(14)`);
                    kwInAltCell.innerHTML = evalMetrics.kw_in_alt || '-';

                    const kwInTextCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(15)`);
                    kwInTextCell.innerHTML = evalMetrics.kw_in_text || '-';

                    const wordCountCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(16)`);
                    wordCountCell.innerHTML = metrics.word_count || '-';

                    rowsPopulated++;

                    if (rowsPopulated === Object.keys(serpResults).length) {
                        const serpTable = document.getElementById(`serp-table-${index}`);
                        //console.log(`SERP Table ${index + 1} innerHTML:`, serpTable.innerHTML);
                    }

                }, 15000); // Keep the timeout
                document.getElementById("keyword-research-analysis-button").innerHTML = "Analyse";
            }
            serpTableHtml += "</table>";
            document.getElementById("keywordAnalysisResults").innerHTML += serpTableHtml;
        }

        function showSERPs(index) {
            const serpTable = document.getElementById(`serp-table-${index}`);
            serpTable.style.display = (serpTable.style.display === "none" || serpTable.style.display === "") ? "table" : "none";

            // Hide other SERP tables:
            const allSERPTables = document.querySelectorAll('.hidden-table');
            allSERPTables.forEach(table => {
                if (table.id !== `serp-table-${index}`) {
                    table.style.display = "none";
                }
            });
        }

        function fetchDomainMetrics(domain) {
            document.getElementById('keyword-research-analysis-button').innerText = "Analysing...";

            //moz 
            var url = "https://a7hptjtc8e.execute-api.ap-southeast-1.amazonaws.com/new";
            var queryString = {
                "domain": domain
            };
            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json"
            };
            fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(queryString)
            })
                .then(response => {
                    // Check if the response is successful
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('da').innerText = data.body.results[0].domain_authority;
                    document.getElementById('pa').innerText = data.body.results[0].page_authority;
                })
                .catch(error => {
                    console.error("Error fetching data:", error); // Log any errors
                    // Handle the error gracefully, perhaps display an error message to the user
                });

            api_url = "https://9px7sjbyyb.execute-api.ap-southeast-1.amazonaws.com/new";
            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json"
            };
            fetch(api_url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ url: domain })
            }).then(response => {
                // Check if the response is successful
                if (!response.ok) {
                    throw new Error(`Error obtaining domain metrics Status: ${response.status}`);
                }
                return response.json();
            })
                .then(data => {
                    document.getElementById('targetTitle').innerText = data.body.title;
                    document.getElementById('targetDescription').innerText = data.body.description;
                    document.getElementById('targetDomainRank').innerText = data.body.domain_rank;
                    document.getElementById('targetBacklinks').innerText = data.body.backlinks;
                    document.getElementById('targetSpamScore').innerText = data.body.backlinks_spam_score;
                    document.getElementById('targetPagespeed').innerText = '-/100';
                    document.getElementById('targetRefDomains').innerText = data.body.referring_domains;
                    document.getElementById('targetInternalLinks').innerText = data.body.internal_links_count;
                    document.getElementById('targetExternalLinks').innerText = data.body.external_links_count;
                    document.getElementById('targetH1').innerText = data.body.h1;
                    document.getElementById('targetImages').innerText = data.body.image;
                    document.getElementById('targetCls').innerText = data.body.cls;
                    document.getElementById('targetLcp').innerText = data.body.lcp;
                    document.getElementById('targetFid').innerText = data.body.fid;
                    document.getElementById('targetSchema').innerText = data.body.schema;
                    document.getElementById('targetReadability').innerText = data.body.readability;
                    document.getElementById('targetWordCount').innerText = data.body.word_count;

                    document.getElementById("meta_data").style.backgroundColor = "green";
                    document.getElementById("domain_metrics").style.backgroundColor = "green";
                })
                .catch(error => {
                    console.error("Error fetching targeted domain data:", error); // Log any errors
                    // Handle the error gracefully, perhaps display an error message to the user
                });
        }

        async function fetchSerpResults(keyword, location, domain) {
            const apiEndpoint = "https://u22k9g2y8c.execute-api.ap-southeast-1.amazonaws.com/new";
            const requestBody = {
                location: location,
                keyword: keyword,
                targeted_url: domain,
                language: document.getElementById("location").value
            };

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching SERP data:', error);
                return null;
            }
        }

        async function fetchContentAnalysisData(url) {
            const apiEndpoint = "https://v21e9kd3h1.execute-api.ap-southeast-1.amazonaws.com/timetoRank3";
            const requestBody = { url: url };

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching content analysis data:', error);
                return null;
            }
        }

        async function fetchOnPageAnalysisData(url) {
            const apiEndpoint = "https://tpl2mrhmc0.execute-api.ap-southeast-1.amazonaws.com/new";
            const requestBody = { url: url };

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching on-page analysis data:', error);
                return null;
            }
        }

        // --- Helper functions to show and hide the loading indicator ---
        function showLoadingIndicator(parent) {
            const loadingIndicator = document.getElementById("loadingIndicator");
            parent.parentNode.insertBefore(loadingIndicator, parent); // Insert before the table
            parent.classList.add("loading");
            loadingIndicator.style.display = "block";
        }

        function hideLoadingIndicator(parent) {
            const loadingIndicator = document.getElementById("loadingIndicator");
            loadingIndicator.style.display = "none";
            parent.classList.remove("loading");
        }

        function removeRow(button) {
            let row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
        }

        document.addEventListener('DOMContentLoaded', function () {
            const coll = document.getElementsByClassName("collapsible");
            for (let i = 0; i < coll.length; i++) {
                coll[i].addEventListener("click", function () {
                    this.classList.toggle("active");
                    const content = this.nextElementSibling;
                    content.style.display = content.style.display === "block" ? "none" : "block";
                });
            }
        });

        function sortTable(column) {
            const table = document.getElementById("keywordResults");
            const rows = Array.from(table.rows);
            const dir = this.asc ? 'asc' : 'desc';

            rows.sort((a, b) => {
                // **Convert cell content to numbers before comparison:**
                const ax = parseFloat(a.cells[column].textContent) || 0; // Use parseFloat for numbers, 0 for non-numeric
                const bx = parseFloat(b.cells[column].textContent) || 0;

                return (ax > bx) ? (dir === 'asc' ? 1 : -1) : (ax < bx ? (dir === 'asc' ? -1 : 1) : 0);
            });

            rows.forEach(row => table.appendChild(row));
            this.asc = !this.asc;
        }

        function downloadSemCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";

            const generatedDiv = document.getElementById('generated');
            const tablesAndHeadings = Array.from(generatedDiv.querySelectorAll('h3, table')); // Select both h3 and table

            tablesAndHeadings.forEach((element, index) => {
                if (element.tagName === 'H3') {  // Check if it's a heading
                    const headingText = element.textContent.trim().replace(/_/g, ' ').toUpperCase(); //Add same formatting
                    const nextElement = tablesAndHeadings[index + 1]; // Check if next element exists

                    if (nextElement && nextElement.tagName === 'TABLE') {
                        const rows = Array.from(nextElement.querySelectorAll("tr"));

                        rows.forEach(row => {
                            const cells = Array.from(row.querySelectorAll("th, td"));

                            if (cells.length >= 2) { //Check if remove cell exists
                                cells.splice(1, 1); //Remove remove cell
                            }
                            //Replace 'Value' with headingText
                            if (cells.length > 0 && cells[0].textContent.trim() === 'Value') {
                                cells[0].textContent = headingText;
                            }

                            const rowText = cells.map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`).join(",");
                            csvContent += rowText + "\n";

                        });

                        csvContent += "\n"; // Add an empty row after each table's data
                    }


                }
            });


            // Create a hidden link element and trigger a click to download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "generated_sem.csv");
            document.body.appendChild(link); // Required for Firefox
            link.click(); // This will download the data file
            document.body.removeChild(link); // Cleanup 
        }

        function downloadKeywordAnalysisTableAsCSV() {
            const table = document.getElementById("keywordAnalysisResults").querySelector('table');
            const rows = Array.from(table.querySelectorAll("tr")); // Select all rows

            // Construct the CSV content
            let csvContent = "data:text/csv;charset=utf-8,";
            rows.forEach(row => {
                // Select *all* cells in the row (including th and td)
                const cells = Array.from(row.querySelectorAll("th, td"));
                csvContent += cells.map(cell => {
                    let cellText = cell.textContent.trim();

                    // Handle innerHTML (for loading spinners) gracefully
                    if (!cellText && cell.innerHTML) {  // Check if textContent is empty but innerHTML exists
                        cellText = cell.innerHTML.replace(/<[^>]*>/g, "").trim(); // Remove HTML tags
                    }
                    return `"${cellText.replace(/"/g, '""')}"` // Escape double quotes
                }).join(",") + "\n";
            });

            // Create a hidden link element and trigger a click to download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "keyword_analysis.csv");
            document.body.appendChild(link); // Required for Firefox
            link.click(); // This will download the data file
            document.body.removeChild(link); // Cleanup 
        }

        // Attach the download function to the button
        document.getElementById("downloadKeywordAnalysisCSVButton").addEventListener("click", downloadKeywordAnalysisTableAsCSV);

        let currentKeywordSortColumn = null;
        let keywordSortAscending = true;

        let currentRankedKeywordSortColumn = null;
        let rankedKeywordSortAscending = true;

        function sortKeywordSuggestions(column) {
            const keywordList = document.getElementById('keywordList');
            const listItems = Array.from(keywordList.children);

            if (column === currentKeywordSortColumn) {
                keywordSortAscending = !keywordSortAscending;
            } else {
                keywordSortAscending = true;
                currentKeywordSortColumn = column;
            }

            listItems.sort((a, b) => {
                const aValue = a.children[column].textContent;
                const bValue = b.children[column].textContent;

                // Convert to number for sorting if possible
                const aNum = parseFloat(aValue.replace(/,/g, ''));
                const bNum = parseFloat(bValue.replace(/,/g, ''));

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return keywordSortAscending ? aNum - bNum : bNum - aNum;
                } else {
                    return keywordSortAscending
                        ? aValue.localeCompare(bValue)
                        : bValue.localeCompare(aValue);
                }
            });

            listItems.forEach(item => keywordList.appendChild(item));
        }


        function sortRankedKeywords(column) {
            const keywordList = document.getElementById('rankedKeywordList');
            const listItems = Array.from(keywordList.children);

            if (column === currentRankedKeywordSortColumn) {
                rankedKeywordSortAscending = !rankedKeywordSortAscending; // Toggle sort direction
            } else {
                rankedKeywordSortAscending = true; // Start in ascending order
                currentRankedKeywordSortColumn = column;
            }

            listItems.sort((a, b) => {
                const aValue = a.children[column].textContent;
                const bValue = b.children[column].textContent;

                // Convert to number for sorting if possible
                const aNum = parseFloat(aValue.replace(/,/g, ''));
                const bNum = parseFloat(bValue.replace(/,/g, ''));

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return rankedKeywordSortAscending ? aNum - bNum : bNum - aNum;
                } else {
                    return rankedKeywordSortAscending
                        ? aValue.localeCompare(bValue)
                        : bValue.localeCompare(aValue);
                }
            });

            listItems.forEach(item => keywordList.appendChild(item));
        }

        selectedItems = {};
        generatedData = {};

        async function semWebpageProducts() {
            const getProducts = document.getElementById("getProducts");
            if (!document.getElementById('sem_webpages').value && !document.getElementById('sem_additional').value) {
                alert("Please enter webpage URLs or additional information.");
                return;
            } else {
                getProducts.innerText = "Analysing...";
                if (document.getElementById("semProductFocus").checked) {
                    productFocus = true;
                } else {
                    productFocus = false;
                }
                if (document.getElementById("semBrandFocus").checked) {
                    brandFocus = true;
                } else {
                    brandFocus = false;
                }

                urls = document.getElementById("sem_webpages").value.split(/[\s,]+/).filter(url => url.trim() !== "");

                try {
                    const response = await fetch("https://13kntbziug.execute-api.ap-southeast-1.amazonaws.com/webpageProducts", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            pages: urls,
                            brand: brandFocus,
                            product: productFocus,
                            language: document.getElementById("sem_language").value,
                            additional: document.getElementById("sem_additional").value,
                        })
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const responseData = await response.json();
                    const body = JSON.parse(responseData.body);

                    formattedString = "";

                    if (body['product/service'].length > 0) {
                        formattedString += "Product/Service: ";
                        if (Object.prototype.toString.call(body['product/service']) === '[object Array]') {
                            for (value in body['product/service']) {
                                formattedString += body['product/service'][value] + ", ";
                            }
                            formattedString = formattedString.slice(0, -2)
                        } else {
                            formattedString += body['product/service']
                        }
                    }

                    if (formattedString != "") {
                        formattedString += "\n\n";
                    }

                    if (body['brand/company'].length > 0) {
                        formattedString += "Brand/Company: ";
                        if (Object.prototype.toString.call(body['brand/company']) === '[object Array]') {
                            for (value in body['brand/company']) {
                                formattedString += body['brand/company'][value] + ", ";
                            }
                            formattedString = formattedString.slice(0, -2)
                        } else {
                            formattedString += body['brand/company']
                        }
                    }

                    document.getElementById("products").innerHTML = '<label for="identifiedProducts">Identfied Products/Services/Brand/Company:</label><br><textarea rows="6" id="identifiedProducts">' + formattedString + '</textarea>';
                    getProducts.innerText = "Step 1: Identify products/services/brand/company";
                } catch (error) {
                    console.error("Error:", error);
                    document.getElementById("output").innerText = "An error occurred with semWebpageProducts. Please check the console for details.";
                    getProducts.innerText = "Step 1: Identify products/services/brand/company";
                }
            }
        }

        async function semAnalyseWebsite() {
            const semButton = document.getElementById("semAnalyse");
            semButton.innerText = "Analysing...";
            try {
                const response = await fetch("https://sk7akfiy89.execute-api.ap-southeast-1.amazonaws.com/semWebsiteAnalyser", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        country: document.getElementById("sem_country").value,
                        additional: document.getElementById("sem_additional").value,
                        products: document.getElementById("identifiedProducts").value,
                        language: document.getElementById("sem_language").value,
                    })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const responseData = await response.json();
                const body = responseData.body;
                selectedItems = {}; // Clear selections
                document.getElementById('selected').style.display = 'block';
                document.getElementById("selectedText").value = ""; // Clear textarea
                document.getElementById("output").innerHTML = createSemTables(body);
                semButton.innerText = "Step 2: Generate KWs, USPs & Audience";
            } catch (error) {
                console.error("Error:", error);
                document.getElementById("output").innerText = "An error occurred with semWebsiteAnalyser. Please check the console for details.";
                semButton.innerText = "Step 2: Generate KWs, USPs & Audience";
            }
        }
        function createSemTables(data) {
            let tablesHTML = "";
            const categories = ["short_keywords", "long_keywords", "usp", "target_audience_name"];
            const titles = ["Short-tail Keywords", "Long-tail Keywords", "USPs", "Target Audience"];
            for (let i = 0; i < categories.length; i++) {
                const category = categories[i];
                const title = titles[i];
                const items = data[category];
                let tableHTML = `<h2>${title}</h2><table><tr><th>Select</th><th>Value</th></tr>`;
                for (const item of items) {
                    const value = typeof item === 'object' ? Object.values(item)[0] : item;
                    tableHTML += `<tr><td><input type="checkbox" onchange="updateSemSelected('${value}', '${title}')"></td><td>${value}</td></tr>`;
                }
                tableHTML += '</table>';
                tablesHTML += tableHTML;
            }
            return tablesHTML;
        }
        function updateSemSelected(value, category) {
            if (!selectedItems[category]) {
                selectedItems[category] = [];
            }
            const index = selectedItems[category].indexOf(value);
            if (index > -1) {
                selectedItems[category].splice(index, 1);
            } else {
                selectedItems[category].push(value);
            }
            displaySemSelectedItems();
        }
        function displaySemSelectedItems() {
            let selectedText = "";
            for (const category in selectedItems) {
                if (selectedItems[category].length > 0) {
                    selectedText += `${category}\n`;
                    selectedItems[category].forEach(item => {
                        selectedText += `${item}\n`;
                    });
                    selectedText += "\n"; // Add extra newline between categories
                }
            }
            document.getElementById("selectedText").value = selectedText;  // Update textarea value
        }
        async function generateGoogle() {
            document.getElementById("generateSem").innerText = "Generating...";
            try {
                const response = await fetch("https://bztsly2z89.execute-api.ap-southeast-1.amazonaws.com/generateSemGoogle", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        country: document.getElementById("sem_country").value,
                        input: document.getElementById("selectedText").value,
                        tone: document.getElementById("sem_tone").value,
                        language: document.getElementById("sem_language").value
                    })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const responseData = await response.json();
                const body = responseData.body;
                for (const key in body) {
                    if (!generatedData[key]) {
                        generatedData[key] = [];
                    }
                    generatedData[key] = generatedData[key].concat(body[key]); // Concatenate new data
                }
                displaySemGeneratedData(); // Call function to update HTML
                document.getElementById("generateSem").innerText = "Step 3: Select checkboxes then click here";
            } catch (error) {
                console.error("Error:", error);
                document.getElementById("generated").innerText = "An error occurred. Please check the console for details.";
                document.getElementById("generateSem").innerText = "Step 3: Select checkboxes then click here";
            }
        }
        function displaySemGeneratedData() {
            let generatedHTML = "";
            for (const category in generatedData) {
                if (generatedData[category].length > 0) {
                    if (category == "sitelinks") {
                        generatedHTML += `<h3>${category.replace(/_/g, ' ').toUpperCase()}</h3>`; // Nicer titles
                        generatedHTML += `<table>`;
                        generatedHTML += `<tr><th>Value</th><th>Remove</th></tr>`; // Add remove column header
                        generatedData[category].forEach((item, index) => { // Add index for row removal
                            sitelink = "";
                            for ([key, value] of Object.entries(item)) {
                                sitelink += `${value}<br>`;
                            }
                            generatedHTML += `<tr>
                            <td>${sitelink}</td>
                            <td><span class="remove-row" onclick="removeSemGeneratedRow('${category}', ${index})" onmouseover="" style="cursor: pointer;">X</span></td>
                         </tr>`;
                        });
                    } else {
                        generatedHTML += `<h3>${category.replace(/_/g, ' ').toUpperCase()}</h3>`; // Nicer titles
                        generatedHTML += `<table>`;
                        generatedHTML += `<tr><th>Value</th><th>Remove</th></tr>`; // Add remove column header
                        generatedData[category].forEach((item, index) => { // Add index for row removal
                            generatedHTML += `<tr>
                            <td>${item}</td>
                            <td><span class="remove-row" onclick="removeSemGeneratedRow('${category}', ${index})" onmouseover="" style="cursor: pointer;">X</span></td>
                         </tr>`;
                        });
                    }
                    generatedHTML += `</table>`;
                }
            }
            document.getElementById("generated").innerHTML = generatedHTML;
            document.getElementById("generated").innerHTML = document.getElementById("generated").innerHTML + '<br><button id="downloadSem" onclick="downloadSemCSV()">Download .csv</button>'
            document.getElementById("downloadSem").addEventListener("click", downloadSemCSV);
        }
        function removeSemGeneratedRow(category, index) {
            generatedData[category].splice(index, 1);
            displaySemGeneratedData(); // Redraw the table
        }
    </script>

</body>

</html>