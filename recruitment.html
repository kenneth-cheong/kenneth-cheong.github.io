<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Recruitment CV Screening & Shortlisting App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --secondary: #06b6d4;
            --accent: #f43f5e;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --border: #334155;
            --glass: rgba(255, 255, 255, 0.03);
            --gradient: linear-gradient(135deg, #6366f1 0%, #06b6d4 100%);
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        aside {
            width: 280px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px;
            z-index: 100;
            transition: width 0.3s ease, padding 0.3s ease;
            position: relative;
        }

        aside.collapsed {
            width: 80px;
            padding: 24px 12px;
        }

        aside.collapsed .logo,
        aside.collapsed .nav-label,
        aside.collapsed .nav-item span:not(.nav-icon) {
            opacity: 0;
            visibility: hidden;
            width: 0;
            margin: 0;
            white-space: nowrap;
        }

        aside.collapsed .nav-item {
            justify-content: center;
            padding: 12px;
            margin-left: 0;
            margin-right: 0;
        }

        aside.collapsed .nav-item {
            justify-content: center;
            padding: 12px;
        }

        .nav-icon {
            margin-right: 12px;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            color: var(--text-dim);
            transition: all 0.3s ease;
        }

        .nav-item:hover .nav-icon,
        .nav-item.active .nav-icon {
            color: var(--primary-light);
        }

        aside.collapsed .nav-icon {
            margin-right: 0;
            font-size: 1.3rem;
            width: auto;
        }

        aside .logo,
        aside .nav-label,
        aside .nav-item span {
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .toggle-sidebar {
            position: absolute;
            right: -12px;
            top: 30px;
            width: 24px;
            height: 24px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 101;
            color: white;
            border: 2px solid var(--bg-dark);
            transform: translateX(50%);
        }

        .logo {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 40px;
        }

        .nav-section {
            margin-bottom: 32px;
        }

        .nav-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-dim);
            letter-spacing: 0.05em;
            margin-bottom: 12px;
            display: block;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 12px;
            color: var(--text-dim);
            text-decoration: none;
            transition: all 0.3s ease;
            margin-bottom: 4px;
        }

        .nav-item:hover,
        .nav-item.active {
            background: var(--glass);
            color: var(--text-main);
        }

        .nav-item.active {
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--primary-light);
        }


        /* Sidebar Profile */
        .sidebar-profile {
            margin-top: auto;
            padding-top: 24px;
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        aside.collapsed .sidebar-profile {
            justify-content: center;
            gap: 0;
        }

        .profile-avatar {
            width: 40px;
            height: 40px;
            background: var(--gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .profile-info {
            flex: 1;
            min-width: 0;
            transition: opacity 0.3s ease;
        }

        aside.collapsed .profile-info {
            display: none;
        }

        .profile-name {
            font-size: 0.875rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .logout-btn {
            font-size: 0.75rem;
            color: var(--accent);
            cursor: pointer;
            display: block;
            margin-top: 4px;
            background: none;
            border: none;
            padding: 0;
            transition: opacity 0.2s;
        }

        .logout-btn:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        /* Main Content */
        main {
            flex: 1;
            padding: 40px 60px;
            overflow-y: auto;
            position: relative;
            height: 100vh;
        }

        section {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            /* CENTER the content */
            padding: 20px 0;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 2rem;
            font-weight: 700;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 40px;
            width: 100%;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 24px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-dim);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title i {
            font-size: 1.1rem;
            color: var(--primary-light);
            opacity: 0.7;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'Outfit', sans-serif;
        }

        /* Action Panel */
        .action-panel {
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 40px;
            backdrop-filter: blur(8px);
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 16px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gradient);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }

        /* Table */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            /* overflow: hidden; Removed as it breaks position: sticky */
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            position: sticky;
            top: 0;
            background: var(--bg-card);
            /* Opaque background for sticky header */
            text-align: left;
            padding: 16px 24px;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }

        td {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
        }

        .badge-warning {
            background: rgba(234, 179, 8, 0.15);
            color: #fbbf24;
        }

        .badge-error {
            background: rgba(244, 63, 94, 0.15);
            color: #fb7185;
        }

        /* Configuration Modal/Form */
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        textarea,
        input {
            width: 100%;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            color: white;
            font-size: 0.875rem;
            outline: none;
        }

        textarea:focus,
        input:focus {
            border-color: var(--primary);
        }

        /* Overlay/Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            width: 95%;
            max-width: 1400px;
            border-radius: 32px;
            padding: 40px;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Shortlist Highlights */
        .top-shortlist {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 40px;
        }

        .shortlist-card {
            background: var(--glass);
            border: 1px solid var(--primary);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .shortlist-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient);
        }

        .rank-number {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary-light);
            margin-bottom: 8px;
            display: block;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-dim);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card,
        .action-panel,
        .table-container,
        .shortlist-card {
            animation: fadeIn 0.5s ease forwards;
        }

        .nav-item {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Progress Bar Animation */
        #statusProgress {
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* CV Viewer Modal */
        #cvViewerModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(8px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .cv-viewer-container {
            width: 100%;
            max-width: 1000px;
            height: 100%;
            background: var(--bg-card);
            border-radius: 24px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .cv-viewer-header {
            padding: 20px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.02);
        }

        .cv-viewer-content {
            flex: 1;
            padding: 0;
            overflow: hidden;
            background: white;
            /* Good for contrast when viewing documents */
        }

        .cv-viewer-content iframe,
        .cv-viewer-content img {
            width: 100%;
            height: 100%;
            border: none;
            object-fit: contain;
        }

        /* Interview Guide Styling */
        .interview-guide {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            margin-top: 32px;
        }

        .rating-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .rating-stars {
            display: flex;
            gap: 8px;
        }

        .star {
            font-size: 1.5rem;
            color: var(--text-dim);
            cursor: pointer;
            transition: color 0.1s;
        }

        .star.active {
            color: #fbbf24;
        }

        .star:hover,
        .star:hover~.star {
            color: #d1d5db;
        }

        .quick-prompts {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .prompt-chip {
            padding: 6px 12px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 100px;
            font-size: 0.75rem;
            cursor: pointer;
            color: var(--text-dim);
            transition: all 0.2s;
        }

        .prompt-chip:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Login Screen Overlay */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 50%, rgba(99, 102, 241, 0.1) 0%, transparent 50%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            padding: 20px;
        }

        .login-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 32px;
            padding: 48px;
            width: 100%;
            max-width: 480px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.6s ease-out forwards;
        }

        .login-logo {
            font-family: 'Outfit', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
        }

        .login-subtitle {
            color: var(--text-dim);
            margin-bottom: 40px;
            font-size: 1rem;
        }

        #googleBtnContainer {
            display: flex;
            justify-content: center;
            margin-top: 24px;
        }

        .login-error {
            color: var(--accent);
            background: rgba(244, 63, 94, 0.1);
            padding: 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            margin-top: 24px;
            display: none;
        }

        /* App visibility after login */
        #recruitmentApp {
            display: none;
            /* Changed to flex in JS via completeLogin if needed, but flex is safer here */
            width: 100%;
            height: 100vh;
            display: none;
            /* Initially hidden */
        }

        #recruitmentApp.active {
            display: flex;
        }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(99, 102, 241, 0.1);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 32px;
            right: 32px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }

        .toast {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid var(--border);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            pointer-events: auto;
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast i {
            font-size: 1.1rem;
        }

        .toast-success i {
            color: #10b981;
        }

        .toast-error i {
            color: #f43f5e;
        }

        .toast-info i {
            color: #818cf8;
        }
    </style>
</head>

<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
    <div id="loginScreen">
        <div class="login-card">
            <div class="login-logo">MediaOne Recruitment</div>
            <div class="login-subtitle">Sign in with your Google account to access the screening platform.</div>
            <div id="googleBtnContainer"></div>
            <div id="loginError" class="login-error">Unauthorized account. Please contact your administrator.</div>
        </div>
    </div>

    <div id="recruitmentApp">
        <aside id="sidebar" class="collapsed" onmouseenter="expandSidebar()" onmouseleave="collapseSidebar()">
            <div class="logo">MediaOne Recruitment</div>

            <nav class="nav-section">
                <span class="nav-label">Main Menu</span>
                <a href="#" class="nav-item active" onclick="showDashboard()" id="nav-dashboard">
                    <span class="nav-icon"><i class="fas fa-chart-pie"></i></span> <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item" onclick="showJobs()" id="nav-jobs">
                    <span class="nav-icon"><i class="fas fa-briefcase"></i></span> <span>Jobs Management</span>
                </a>
                <a href="#" class="nav-item" onclick="showCandidates()" id="nav-candidates">
                    <span class="nav-icon"><i class="fas fa-user-tie"></i></span><span>Candidates</span>
                </a>
            </nav>

            <nav class="nav-section">
                <span class="nav-label">Settings</span>
                <a href="#" class="nav-item" onclick="showUsers()" id="nav-users">
                    <span class="nav-icon"><i class="fas fa-user-shield"></i></span> <span>Users Management</span>
                </a>
                <a href="#" class="nav-item" onclick="showAuditLogs()" id="nav-audit">
                    <span class="nav-icon"><i class="fas fa-clipboard-list"></i></span> <span>Activity Log</span>
                </a>
            </nav>

            <!-- User Profile Section -->
            <div class="sidebar-profile">
                <div class="profile-avatar" id="sidebar-avatar">U</div>
                <div class="profile-info">
                    <div class="profile-name" id="sidebar-user-name">User Name</div>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </aside>

        <main id="mainContent">
            <section id="dashboardSection">
                <header class="header">
                    <div>
                        <h1>Recruitment Overview</h1>
                        <p style="color: var(--text-dim);">Your recruitment performance at a glance.</p>
                    </div>
                </header>

                <div class="dashboard-grid">
                    <div class="card" onclick="showJobs()" style="cursor: pointer;">
                        <div class="card-title">Total Active Jobs <i class="fas fa-briefcase"></i></div>
                        <div class="stat-value" id="stat-jobs">0</div>
                        <p style="font-size: 0.8rem; color: var(--text-dim); margin-top: 8px;">View all listings ‚Üí</p>
                    </div>
                    <div class="card" onclick="showCandidates()" style="cursor: pointer;">
                        <div class="card-title">Total Applicants <i class="fas fa-users"></i></div>
                        <div class="stat-value" id="stat-total">0</div>
                        <p style="font-size: 0.8rem; color: var(--text-dim); margin-top: 8px;">Manage candidates ‚Üí</p>
                    </div>
                    <div class="card">
                        <div class="card-title">High Quality Leads <i class="fas fa-fire"
                                style="color: var(--secondary); opacity: 0.9;"></i></div>
                        <div class="stat-value" id="stat-leads" style="color: var(--secondary);">0</div>
                        <p style="font-size: 0.8rem; color: var(--text-dim); margin-top: 8px;">Top tier scoring
                            candidates</p>
                    </div>
                </div>
            </section>

            <section id="jobsSection" style="display: none;">
                <header class="header">
                    <div>
                        <h1>Jobs Management</h1>
                        <p style="color: var(--text-dim);">Create and manage your specific job descriptions and scoring
                            criteria.</p>
                    </div>
                    <button id="createJobBtn" class="btn btn-primary" onclick="createNewJob()">+ Create New Job</button>
                </header>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Job Title</th>
                                <th>Created At</th>
                                <th>Applicants</th>
                                <th>Shortlisted</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="jobListBody">
                            <!-- Jobs will be injected here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <div class="action-panel" id="uploadPanel" style="display: none;">
                <div
                    style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
                    <div>
                        <h2 id="jobTitleDisplay">Job Title</h2>
                        <p style="color: var(--text-dim);">Upload CVs for this specific job ad.</p>
                    </div>
                    <button class="btn" style="background: var(--glass); color: white;" onclick="closeUpload()">Back to
                        List</button>
                </div>

                <div class="upload-area" id="dropZone">
                    <div class="upload-icon">üìÅ</div>
                    <h3>Drop your ZIP file or multiple CVs here</h3>
                    <p style="color: var(--text-dim);">Supported formats: PDF, DOCX, Images, ZIP</p>
                    <input type="file" id="fileInput" multiple accept=".zip,.pdf,.docx,.jpg,.png"
                        style="display: none;">
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary"
                            onclick="event.stopPropagation(); document.getElementById('fileInput').click()">Browse
                            Files</button>
                    </div>
                </div>

                <div id="stagingArea"
                    style="margin-top: 24px; display: none; background: rgba(255,255,255,0.02); border-radius: 16px; padding: 20px; border: 1px solid var(--border);">
                    <h4 style="margin-bottom: 16px; color: var(--text-dim);">Items waiting to be processed</h4>
                    <div id="stagedFilesList"
                        style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px;">
                        <!-- Staged files here -->
                    </div>
                    <div style="display: flex; gap: 16px;">
                        <button class="btn btn-primary" onclick="processAllStaged()">Analyze All Files</button>
                        <button class="btn" style="background: var(--glass); color: white;"
                            onclick="clearStaged()">Clear
                            All</button>
                    </div>
                </div>

                <div id="processingStatus" style="margin-top: 24px; display: none;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span id="statusText">Processing 3 CVs...</span>
                        <span id="statusPercent">45%</span>
                    </div>
                    <div style="height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                        <div id="statusProgress"
                            style="width: 45%; height: 100%; background: var(--gradient); transition: width 0.3s ease;">
                        </div>
                    </div>
                </div>

                <div id="statusPanel" style="margin-top: 24px; display: none;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span id="progressText"
                            style="color: var(--text-dim); font-size: 0.875rem;">Initializing...</span>
                        <span id="progressPercent"
                            style="color: var(--accent); font-weight: 600; font-size: 0.875rem;">0%</span>
                    </div>
                    <div style="height: 6px; background: rgba(255,255,255,0.05); border-radius: 3px; overflow: hidden;">
                        <div id="progressBar"
                            style="width: 0%; height: 100%; background: var(--gradient); transition: width 0.3s ease;">
                        </div>
                    </div>
                </div>
            </div>

            <section id="resultsSection" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="margin: 0;">Top 5 Shortlist</h2>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <div id="bulkAssignContainer" style="display: none; align-items: center; gap: 8px;">
                            <select id="bulkAssignSelect"
                                style="padding: 10px; font-size: 0.875rem; border-radius: 12px; background: var(--bg-card); color: white; border: 1px solid var(--border); outline: none;">
                                <!-- Populate via JS -->
                            </select>
                            <button class="btn btn-primary" style="padding: 10px 16px; font-size: 0.875rem;"
                                onclick="bulkAssign('candidateTable')">Assign Selected</button>
                        </div>
                        <button id="bulkReEvaluateBtn" class="btn"
                            style="display: none; background: var(--secondary); color: white;"
                            onclick="bulkReEvaluate(event, 'candidateTable')">
                            <i class="fas fa-sync-alt"></i> AI Re-evaluate Selected
                        </button>
                        <button id="bulkCopyBtn" class="btn"
                            style="display: none; background: var(--glass); color: var(--secondary); border: 1px solid var(--secondary);"
                            onclick="bulkCopyUrls('candidateTable')">
                            <i class="fas fa-copy"></i> Copy Links
                        </button>
                        <button id="bulkDeleteBtn" class="btn"
                            style="display: none; background: var(--accent); color: white;"
                            onclick="bulkDelete()">Delete Selected</button>
                    </div>
                </div>
                <div class="top-shortlist" id="top5List">
                    <!-- Shortlist cards will be injected here -->
                </div>

                <div class="table-container">
                    <table id="candidateTable">
                        <thead>
                            <tr>
                                <th style="width: 40px; text-align: center;">
                                    <input type="checkbox" id="selectAllCandidates"
                                        onclick="toggleSelectAll('candidateTable')">
                                </th>
                                <th onclick="sortJobCandidates('name')" style="cursor: pointer;">Name <i
                                        class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortJobCandidates('date')" style="cursor: pointer;">Date Applied <i
                                        class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortJobCandidates('score')" style="cursor: pointer;">AI Score <i
                                        class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortJobCandidates('interviewerScore')" style="cursor: pointer;">Interviewer
                                    Score <i class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortJobCandidates('hopper')" style="cursor: pointer;">Job Hopper <i
                                        class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortJobCandidates('pendingBy')" style="cursor: pointer;">Pending action by
                                    <i class="fas fa-sort ms-1"></i>
                                </th>
                                <th onclick="sortJobCandidates('status')" style="cursor: pointer;">Status <i
                                        class="fas fa-sort ms-1"></i></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="candidateBody">
                            <!-- Candidate rows will be injected here -->
                        </tbody>
                    </table>
                </div>
                <div id="resultsPagination"></div>
            </section>

            <section id="candidatesSection" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="margin: 0;">Candidates Repository</h2>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <div id="bulkAssignRepoContainer" style="display: none; align-items: center; gap: 8px;">
                            <select id="bulkAssignRepoSelect"
                                style="padding: 10px; font-size: 0.875rem; border-radius: 12px; background: var(--bg-card); color: white; border: 1px solid var(--border); outline: none;">
                                <!-- Populate via JS -->
                            </select>
                            <button class="btn btn-primary" style="padding: 10px 16px; font-size: 0.875rem;"
                                onclick="bulkAssign('repoTable')">Assign Selected</button>
                        </div>
                        <button id="bulkReEvaluateRepoBtn" class="btn"
                            style="display: none; background: var(--secondary); color: white;"
                            onclick="bulkReEvaluate(event, 'repoTable')">
                            <i class="fas fa-sync-alt"></i> AI Re-evaluate Selected
                        </button>
                        <button id="bulkCopyRepoBtn" class="btn"
                            style="display: none; background: var(--glass); color: var(--secondary); border: 1px solid var(--secondary);"
                            onclick="bulkCopyUrls('repoTable')">
                            <i class="fas fa-copy"></i> Copy Links
                        </button>
                        <button id="bulkDeleteRepoBtn" class="btn"
                            style="display: none; background: var(--accent); color: white;"
                            onclick="bulkDeleteRepo()">Delete Selected</button>
                        <button id="bulkRestoreRepoBtn" class="btn"
                            style="display: none; background: var(--secondary); color: white;"
                            onclick="bulkRestoreRepo()">Restore Selected</button>
                        <div class="form-group" style="margin: 0; display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="showDeletedRepo" onchange="filterCandidatesRepo()"
                                style="width: 20px; height: 20px;">
                            <label style="margin: 0; white-space: nowrap;">View Trash</label>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 24px;">
                    <div class="config-grid" style="margin-top: 0; grid-template-columns: repeat(4, 1fr);">
                        <div class="form-group">
                            <label>Search Name</label>
                            <input type="text" id="searchCand" placeholder="Filter by name..."
                                oninput="filterCandidatesRepo()">
                        </div>
                        <div class="form-group">
                            <label>Position Applied</label>
                            <select id="filterPosition" onchange="filterCandidatesRepo()"
                                style="width: 100%; background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border); border-radius: 12px; padding: 12px; color: white; outline: none;">
                                <option value="">All Positions</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="filterStatus" onchange="filterCandidatesRepo()"
                                style="width: 100%; background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border); border-radius: 12px; padding: 12px; color: white; outline: none;">
                                <option value="">All Statuses</option>
                                <option value="No Action">No Action</option>
                                <option value="Invited">Invited</option>
                                <option value="Scheduled">Scheduled</option>
                                <option value="Interviewed">Interviewed</option>
                                <option value="Shortlisted">Shortlisted</option>
                                <option value="Offered">Offered</option>
                                <option value="Rejected">Rejected</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date Range</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="date" id="dateStart" onchange="filterCandidatesRepo()"
                                    style="padding: 10px;">
                                <input type="date" id="dateEnd" onchange="filterCandidatesRepo()"
                                    style="padding: 10px;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table id="repoTable">
                        <thead>
                            <tr>
                                <th style="width: 40px; text-align: center;">
                                    <input type="checkbox" id="selectAllRepo" onclick="toggleSelectAll('repoTable')">
                                </th>
                                <th onclick="sortRepoTable('name')" style="cursor: pointer;">Name <i
                                        class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortRepoTable('job')" style="cursor: pointer;">Position <i
                                        class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortRepoTable('date')" style="cursor: pointer;">Date Applied <i
                                        class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortRepoTable('score')" style="cursor: pointer;">AI Score <i
                                        class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortRepoTable('interviewerScore')" style="cursor: pointer;">Interviewer
                                    Score <i class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortRepoTable('pendingBy')" style="cursor: pointer;">Pending action by <i
                                        class="fas fa-sort ms-1"></i></th>
                                <th onclick="sortRepoTable('status')" style="cursor: pointer;">Status <i
                                        class="fas fa-sort ms-1"></i></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="repoBody">
                            <!-- Full list of candidates will be injected here -->
                        </tbody>
                    </table>
                </div>
                <div id="repoPagination"></div>
            </section>

            <section id="usersSection" style="display: none;">
                <div class="header">
                    <h2>User Management</h2>
                    <button class="btn btn-primary" onclick="openUserModal()">+ Add New User</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>User Name</th>
                                <th>Email</th>
                                <th>Access Level</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userListBody">
                            <!-- Users will be injected here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="activityLogSection" style="display: none;">
                <div class="header">
                    <div>
                        <h1>Activity Log</h1>
                        <p style="color: var(--text-dim);">Track all system activities and record changes.</p>
                    </div>
                    <button class="btn btn-primary" onclick="showDashboard()">Back to Dashboard</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Description</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogBody"></tbody>
                    </table>
                </div>
            </section>
        </main>

        <!-- Create/Edit Job Modal -->
        <div id="jobModal" class="modal">
            <div class="modal-content">
                <h2 id="modalTitle">Create New Job Advertisement</h2>
                <div class="config-grid">
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Job Title</label>
                        <input type="text" id="jobTitle" placeholder="e.g. Senior Frontend Developer">
                    </div>
                    <div class="form-group">
                        <label>Job Description</label>
                        <textarea id="jobDesc" rows="8" placeholder="Paste full job description here..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Key Responsibilities & KPIs</label>
                        <textarea id="jobKpi" rows="8"
                            placeholder="List specific responsibilities and KPIs..."></textarea>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; margin: 24px 0 16px;">
                    <h3 style="margin: 0;">Evaluation Criteria & Weights (%)</h3>
                    <button class="btn btn-primary" onclick="addJobCriteria()"
                        style="padding: 8px 16px; font-size: 0.85rem;">
                        <i class="fas fa-plus"></i> Add Criteria
                    </button>
                </div>
                <div class="table-container" style="margin-bottom: 24px;">
                    <table style="width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem;">
                        <thead>
                            <tr style="background: rgba(15, 23, 42, 0.3);">
                                <th
                                    style="text-align: left; padding: 12px 24px; color: var(--text-dim); border-bottom: 1px solid var(--border); width: 70%;">
                                    Criterion</th>
                                <th
                                    style="text-align: left; padding: 12px; color: var(--text-dim); border-bottom: 1px solid var(--border); width: 20%;">
                                    Weight (%)</th>
                                <th
                                    style="text-align: center; padding: 12px; color: var(--accent); border-bottom: 1px solid var(--border); width: 50px;">
                                </th>
                            </tr>
                        </thead>
                        <tbody id="jobCriteriaBody">
                            <!-- Job criteria will be injected here -->
                        </tbody>
                        <tfoot id="jobCriteriaFoot">
                            <tr style="background: rgba(15, 23, 42, 0.5);">
                                <td style="padding: 12px 24px; color: white; font-weight: 700; text-align: right;">Total
                                    Weight</td>
                                <td id="totalCriteriaWeight"
                                    style="padding: 12px; color: var(--secondary); font-weight: 700;">0%</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 32px 0 16px;">
                    <h3 style="margin: 0;">Standard Interview Questions</h3>
                    <button class="btn btn-primary" onclick="addJobQuestion()"
                        style="padding: 8px 16px; font-size: 0.85rem;">
                        <i class="fas fa-plus"></i> Add Question
                    </button>
                </div>
                <div class="table-container" style="margin-bottom: 24px;">
                    <table style="width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem;">
                        <thead>
                            <tr style="background: rgba(15, 23, 42, 0.3);">
                                <th
                                    style="text-align: center; padding: 12px; color: var(--accent); border-bottom: 1px solid var(--border); width: 30px;">
                                </th>
                                <th
                                    style="text-align: left; padding: 12px 24px; color: var(--text-dim); border-bottom: 1px solid var(--border); width: 15%;">
                                    Metric</th>
                                <th
                                    style="text-align: left; padding: 12px; color: var(--text-dim); border-bottom: 1px solid var(--border); width: 25%;">
                                    Question</th>
                                <th
                                    style="text-align: left; padding: 12px; color: var(--secondary); border-bottom: 1px solid var(--border); width: 25%;">
                                    Good Answer</th>
                                <th
                                    style="text-align: left; padding: 12px; color: var(--accent); border-bottom: 1px solid var(--border); width: 25%;">
                                    Red Flags</th>
                                <th
                                    style="text-align: center; padding: 12px; color: var(--accent); border-bottom: 1px solid var(--border); width: 50px;">
                                </th>
                            </tr>
                        </thead>
                        <tbody id="jobQuestionsBody">
                            <!-- Job questions will be injected here -->
                        </tbody>
                    </table>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 16px; margin-top: 32px;">
                    <button class="btn" onclick="closeJobModal()"
                        style="background: var(--glass); color: white;">Cancel</button>
                    <button class="btn btn-primary" id="saveJobBtn" onclick="saveJob()">Create Job</button>
                </div>
            </div>
        </div>

        <!-- User Management Modal -->
        <div id="userModal" class="modal">
            <div class="modal-content">
                <h2 id="userModalTitle">Add New User</h2>
                <div class="config-grid">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="userName" placeholder="e.g. John Smith">
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="userEmail" placeholder="e.g. john@company.com">
                    </div>
                    <div class="form-group">
                        <label>Access Role</label>
                        <select id="userRole"
                            style="width: 100%; background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border); border-radius: 12px; padding: 12px; color: white; outline: none;">
                            <option value="Admin">Admin</option>
                            <option value="Team Lead">Team Lead</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="userStatus"
                            style="width: 100%; background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border); border-radius: 12px; padding: 12px; color: white; outline: none;">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 16px; margin-top: 32px;">
                    <button class="btn" onclick="closeUserModal()"
                        style="background: var(--glass); color: white;">Cancel</button>
                    <button class="btn btn-primary" onclick="saveUser()">Save User</button>
                </div>
            </div>
        </div>

        <!-- Candidate Detail Modal -->
        <div id="detailModal" class="modal">
            <div class="modal-content">
                <div
                    style="position: sticky; top: -40px; background: var(--bg-card); z-index: 100; margin: -40px -40px 32px -40px; padding: 40px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: flex-start;">
                    <div id="detailNameSection">
                        <h2 id="detailName" contenteditable="true" onblur="updateCandidateName(this.innerText)"
                            style="outline: none; border-radius: 8px; padding: 4px 8px; transition: background 0.2s;"
                            onmouseover="this.style.background='rgba(255,255,255,0.05)'"
                            onmouseout="this.style.background='transparent'">John Doe</h2>
                        <div style="display: flex; gap: 12px; align-items: center; margin-top: 8px;">
                            <span class="badge badge-success" id="detailScore">AI Score: 92/100</span>
                            <button class="btn"
                                style="background: var(--glass); color: var(--secondary); border: 1px solid var(--secondary); padding: 4px 12px; font-size: 0.75rem; border-radius: 12px;"
                                onclick="reEvaluateCurrentCandidate(event)">
                                <i class="fas fa-sync-alt"></i> AI Re-evaluate Candidate
                            </button>
                            <div id="detailContactInfo"
                                style="display: flex; gap: 12px; align-items: center; color: var(--text-dim); font-size: 0.8rem;">
                                <span id="detailEmail" contenteditable="true"
                                    onblur="updateCandidateEmail(this.innerText)"
                                    style="outline: none; border-radius: 4px; padding: 2px 4px; border: 1px solid transparent;"
                                    onmouseover="this.style.borderColor='var(--border)'"
                                    onmouseout="this.style.borderColor='transparent'">candidate@email.com</span>
                            </div>
                            <div
                                style="display: flex; align-items: center; gap: 8px; background: var(--glass); padding: 4px 12px; border-radius: 12px; border: 1px solid var(--border);">
                                <label style="font-size: 0.75rem; color: var(--text-dim); font-weight: 600;">Interviewer
                                    Score:</label>
                                <input type="number" id="detailInterviewerScore" min="0" max="100" readonly
                                    style="width: 60px; background: transparent; border: none; color: var(--secondary); font-weight: 800; font-size: 1.2rem; outline: none; padding: 0;">
                                <span style="font-weight: 800; color: var(--text-dim); margin-left: -5px;">%</span>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 12px;">
                        <div style="display: flex; gap: 8px;">
                            <button class="btn"
                                style="background: var(--glass); color: var(--secondary); border: 1px solid var(--secondary);"
                                onclick="sendCandidateEmail()">
                                <i class="fas fa-envelope"></i> Email
                            </button>
                            <button class="btn"
                                style="background: var(--glass); color: var(--secondary); border: 1px solid var(--secondary);"
                                onclick="copyShareLink(editingCandId)">
                                <i class="fas fa-share-alt"></i> Share
                            </button>
                            <button class="btn" style="background: var(--glass); color: white;"
                                onclick="closeDetailModal()">Close</button>
                        </div>
                        <div
                            style="display: flex; align-items: center; gap: 8px; background: var(--glass); padding: 4px 12px; border-radius: 12px; border: 1px solid var(--border);">
                            <label style="font-size: 0.75rem; color: var(--text-dim); font-weight: 600;">Assign
                                to:</label>
                            <select id="modalAssignee"
                                style="background: transparent; border: none; color: white; font-size: 0.875rem; outline: none; padding: 0;"
                                onchange="updateCandidatePending(editingCandId, this.value)">
                                <!-- Options injected by JS -->
                            </select>
                        </div>
                    </div>
                </div>

                <div class="config-grid">
                    <div class="card">
                        <h4 style="margin-bottom: 12px; color: var(--secondary);">Why Shortlisted?</h4>
                        <ul id="detailReasons" style="padding-left: 20px; color: var(--text-dim); line-height: 1.6;">
                            <!-- AI Reasons -->
                        </ul>
                    </div>
                    <div class="card">
                        <h4 style="margin-bottom: 12px; color: var(--accent);">Analysis Summary</h4>
                        <p id="detailSummary" style="color: var(--text-dim); font-size: 0.875rem; line-height: 1.6;">
                        </p>
                    </div>
                </div>

                <div style="margin-top: 32px;">
                    <h4 style="margin-bottom: 16px;">Detailed AI Score Breakdown</h4>
                    <div style="height: 250px; position: relative;">
                        <canvas id="scoreChart"></canvas>
                    </div>
                </div>

                <div id="hopperSection"
                    style="margin-top: 24px; padding: 16px; border-radius: 12px; background: rgba(244, 63, 94, 0.05); border: 1px solid rgba(244, 63, 94, 0.2); display: none;">
                    <h4 style="color: var(--accent); margin-bottom: 8px;">‚ö†Ô∏è Job Hopper Alert</h4>
                    <p id="hopperDetail" style="font-size: 0.875rem; color: var(--text-dim);"></p>
                </div>

                <div class="interview-guide">
                    <h3 style="margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.5rem;">üìã</span> Interviewer Guide & Evaluation
                    </h3>

                    <div style="display: grid; grid-template-columns: 3.5fr 1fr; gap: 32px; align-items: start;">
                        <div class="card"
                            style="background: rgba(99, 102, 241, 0.05); border-color: rgba(99, 102, 241, 0.1); padding: 0; overflow: hidden;">
                            <div
                                style="padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4
                                        style="color: var(--primary-light); display: flex; align-items: center; gap: 10px; margin: 0;">
                                        <span style="font-size: 1.2rem;">üí°</span> Interviewer Cheat Sheet & Ratings
                                    </h4>
                                    <p style="font-size: 0.75rem; color: var(--text-dim); margin-top: 8px;">
                                        Click on <b>Metric</b> or <b>Question</b> text to edit. Changes auto-save.
                                    </p>
                                </div>
                                <button class="btn btn-primary" style="padding: 8px 16px; font-size: 0.85rem;"
                                    onclick="addGuideQuestion()">
                                    <i class="fas fa-plus"></i> Add Question
                                </button>
                            </div>
                            <div style="max-height: 600px; overflow-y: auto;">
                                <table
                                    style="width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem;">
                                    <thead>
                                        <tr style="background: rgba(15, 23, 42, 0.3);">
                                            <th
                                                style="text-align: center; padding: 12px; color: var(--accent); border-bottom: 1px solid var(--border); width: 30px;">
                                            </th>
                                            <th
                                                style="text-align: left; padding: 12px 24px; color: var(--text-dim); border-bottom: 1px solid var(--border); width: 15%;">
                                                Metric</th>
                                            <th
                                                style="text-align: left; padding: 12px; color: var(--text-dim); border-bottom: 1px solid var(--border); width: 25%;">
                                                Question</th>
                                            <th
                                                style="text-align: left; padding: 12px; color: var(--secondary); border-bottom: 1px solid var(--border); width: 25%;">
                                                Good Answer</th>
                                            <th
                                                style="text-align: left; padding: 12px; color: var(--accent); border-bottom: 1px solid var(--border); width: 20%;">
                                                Red Flags</th>
                                            <th
                                                style="text-align: center; padding: 12px; color: var(--primary-light); border-bottom: 1px solid var(--border); width: 15%;">
                                                Rating</th>
                                            <th
                                                style="text-align: center; padding: 12px; color: var(--accent); border-bottom: 1px solid var(--border); width: 50px;">
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="cheatSheetBody">
                                        <!-- Unified persistable rows injected by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 24px;">
                            <div class="card" style="background: rgba(15, 23, 42, 0.4); border-color: var(--border);">
                                <h4 style="margin-bottom: 12px; font-size: 0.875rem; color: var(--text-dim);">Quick
                                    Prompts
                                </h4>
                                <div class="quick-prompts">
                                    <span class="prompt-chip"
                                        onclick="addQuickComment('Highly recommended for next stage')">Next Stage</span>
                                    <span class="prompt-chip" onclick="addQuickComment('Strong technical depth')">Strong
                                        Tech</span>
                                    <span class="prompt-chip" onclick="addQuickComment('Good Comm Skills')">Good
                                        Comm</span>
                                    <span class="prompt-chip" onclick="addQuickComment('Tech Gaps observed')">Tech
                                        Gaps</span>
                                    <span class="prompt-chip" onclick="addQuickComment('Cultural Fit')">Culture
                                        Fit</span>
                                </div>
                            </div>

                            <div class="card" style="background: rgba(15, 23, 42, 0.4); border-color: var(--border);">
                                <h4 style="margin-bottom: 12px; font-size: 0.875rem; color: var(--text-dim);">Actions
                                </h4>
                                <button class="btn btn-primary" style="width: 100%; justify-content: center;"
                                    onclick="viewCV()">
                                    <i class="fas fa-eye"></i> View CV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>


                <div style="margin-top: 32px; border-top: 1px solid var(--border); padding-top: 24px;">
                    <h4 style="margin-bottom: 16px;">Comments</h4>
                    <div id="commentsList"
                        style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; max-height: 200px; overflow-y: auto;">
                        <!-- Comments here -->
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <input type="text" id="newCommentInput" placeholder="Add a comment..."
                            style="flex: 1; padding: 12px; background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border); border-radius: 12px; color: white; outline: none;">
                        <button class="btn btn-primary" onclick="submitComment()">Post</button>
                    </div>
                </div>

                <div style="margin-top: 32px; display: flex; gap: 16px;">
                    <button class="btn btn-primary" onclick="viewCV()">View Original CV</button>
                    <button class="btn" style="background: rgba(244, 63, 94, 0.1); color: var(--accent);"
                        onclick="rejectCurrentCandidate()">Reject Candidate</button>
                </div>
            </div>
        </div>

        <!-- CV Viewer Modal -->
        <div id="cvViewerModal">
            <div class="cv-viewer-container">
                <div class="cv-viewer-header">
                    <h3 id="cvViewerTitle">CV Viewer</h3>
                    <button class="btn" style="background: var(--glass); color: white;"
                        onclick="closeCVViewer()">Close</button>
                </div>
                <div class="cv-viewer-content" id="cvViewerContent">
                    <!-- Content injected by JS -->
                </div>
            </div>
        </div>

    </div> <!-- End recruitmentApp -->

    <script>
        // --- Authentication & Session Management ---
        const GOOGLE_CLIENT_ID = '365369983219-12iqvk3v35kf03p3ts1gikglddtkofvq.apps.googleusercontent.com';
        const VERIFY_ENDPOINT = 'https://ts9k398yn8.execute-api.ap-southeast-1.amazonaws.com/googleLogin';

        let state = {
            jobs: [],
            activeJobId: null,
            viewingCandidateId: null,
            candidates: [], // linked to jobId
            users: [],
            stagedFiles: [],
            currentUser: null,
            currentUserRole: null, // 'Admin' or 'Team Lead'
            effectiveRole: null,   // same as above, can be toggled by Kenneth
            loggedUserId: null,
            editingUserId: null,
            apiKey: localStorage.getItem('ai_recruitment_api_key') || '',
            editingJobId: null,
            pagination: {
                page: 1,
                limit: 100,
                total: 0
            },
            isFetchingCandidates: false
        };

        async function handleCredentialResponse(response) {
            const errorEl = document.getElementById('loginError');
            errorEl.style.display = 'none';

            try {
                // 1. Verify Google Token with Backend
                const verifyRes = await fetch(VERIFY_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ credential: response.credential })
                });
                const verifyData = await verifyRes.json();

                // Lambda returns body as a string in some configurations
                const payload = typeof verifyData.body === 'string' ? JSON.parse(verifyData.body) : verifyData.body;

                if (!payload.success) {
                    throw new Error(payload.message || "Google verification failed.");
                }

                const googleProfile = payload.user;

                // 2. Cross-check with Recruitment Registered Users
                const registeredUsers = await persistenceApiCall('get_users');
                if (!Array.isArray(registeredUsers)) {
                    throw new Error("Unable to verify user list. Please try again.");
                }

                const matchedUser = registeredUsers.find(u =>
                    u.email.toLowerCase() === googleProfile.email.toLowerCase() &&
                    u.status === 'Active'
                );

                if (!matchedUser) {
                    throw new Error("Your account is not registered or is inactive. Access denied.");
                }

                // 3. Success - Set Session
                state.currentUser = matchedUser.name;
                state.currentUserRole = matchedUser.role;
                state.effectiveRole = matchedUser.role;
                state.loggedUserId = matchedUser.id;
                state.users = registeredUsers;

                localStorage.setItem('recruitment_user', JSON.stringify({
                    name: matchedUser.name,
                    email: matchedUser.email,
                    id: matchedUser.id,
                    role: matchedUser.role
                }));

                completeLogin();

            } catch (err) {
                console.error("Login Error:", err);
                errorEl.textContent = err.message;
                errorEl.style.display = 'block';
            }
        }

        function checkAuth() {
            const stored = localStorage.getItem('recruitment_user');
            if (stored) {
                const user = JSON.parse(stored);
                state.currentUser = user.name;
                state.currentUserRole = user.role;
                state.effectiveRole = user.role;
                state.loggedUserId = user.id;
                completeLogin();
                return true;
            }

            google.accounts.id.initialize({
                client_id: GOOGLE_CLIENT_ID,
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.getElementById('googleBtnContainer'),
                { theme: "outline", size: "large", shape: "pill" }
            );
            return false;
        }

        function completeLogin() {
            document.getElementById('loginScreen').style.display = 'none';
            const app = document.getElementById('recruitmentApp');
            app.style.display = 'flex';
            app.classList.add('active'); // Supporting the new CSS class too
            updateUserUI();
            initApp();
        }

        function logout() {
            localStorage.removeItem('recruitment_user');
            location.reload();
        }

        function updateUserUI() {
            if (!state.currentUser) return;

            // Update all placeholders with actual user name
            const nameEls = document.querySelectorAll('.user-name-display');
            nameEls.forEach(el => el.textContent = state.currentUser);

            // Update Sidebar Profile
            const profileName = document.getElementById('sidebar-user-name');
            if (profileName) {
                profileName.textContent = state.currentUser;

                // Kenneth's Dev Toggle
                if (state.currentUser === 'Kenneth Cheong') {
                    const toggleHtml = `
                        <div style="font-size: 0.7rem; color: var(--secondary); margin-top: 4px; cursor: pointer; text-decoration: underline;" 
                             onclick="toggleEffectiveRole()">
                            Mode: ${state.effectiveRole} (Switch)
                        </div>
                    `;
                    // Check if toggle already exists to avoid duplication
                    if (!document.getElementById('kenneth-role-toggle')) {
                        const toggleDiv = document.createElement('div');
                        toggleDiv.id = 'kenneth-role-toggle';
                        toggleDiv.innerHTML = toggleHtml;
                        profileName.after(toggleDiv);
                    } else {
                        document.getElementById('kenneth-role-toggle').innerHTML = toggleHtml;
                    }
                } else {
                    // Non-Kenneth: Show actual role but smaller
                    const roleDisplay = document.getElementById('user-role-display');
                    if (!roleDisplay) {
                        const rDiv = document.createElement('div');
                        rDiv.id = 'user-role-display';
                        rDiv.style.fontSize = '0.7rem';
                        rDiv.style.color = 'var(--text-dim)';
                        rDiv.innerText = state.effectiveRole;
                        profileName.after(rDiv);
                    } else {
                        roleDisplay.innerText = state.effectiveRole;
                    }
                }
            }

            // Update Avatar (first initial)
            const avatar = document.getElementById('sidebar-avatar');
            if (avatar) avatar.textContent = state.currentUser.charAt(0).toUpperCase();

            // Hide/Show navigation items based on role
            const navUsers = document.getElementById('nav-users');
            const navAudit = document.getElementById('nav-audit');
            if (navUsers) navUsers.style.display = state.effectiveRole === 'Admin' ? 'flex' : 'none';
            if (navAudit) navAudit.style.display = state.effectiveRole === 'Admin' ? 'flex' : 'none';

            const createJobBtn = document.getElementById('createJobBtn');
            if (createJobBtn) createJobBtn.style.display = state.effectiveRole === 'Admin' ? 'block' : 'none';
        }

        // --- Date & Time Helpers (UTC+8) ---
        function ensureUTC(date) {
            if (typeof date === 'string' && date.includes('T') && !date.includes('Z') && !date.includes('+')) {
                return date + 'Z';
            }
            return date;
        }

        function formatDate8(date) {
            if (!date) return '';
            const d = new Date(ensureUTC(date));
            return d.toLocaleDateString('en-SG', { timeZone: 'Asia/Singapore' });
        }

        function formatDateTime8(date) {
            if (!date) return '';
            const d = new Date(ensureUTC(date));
            return d.toLocaleString('en-SG', {
                timeZone: 'Asia/Singapore',
                hour12: true,
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
        }

        window.addEventListener('load', () => {
            checkAuth();
        });

        let jobDetailsSort = { field: 'score', direction: 'desc' };
        let repoSort = { field: 'date', direction: 'desc' };

        // --- RBAC Helpers ---
        function getAccessibleCandidates() {
            if (state.effectiveRole === 'Admin') return state.candidates;
            // Team Lead: only candidates assigned to them
            return state.candidates.filter(c => c.pendingBy === state.currentUser);
        }

        function getAccessibleJobs() {
            if (state.effectiveRole === 'Admin') return state.jobs;
            // Team Lead: only jobs that have at least one candidate assigned to them
            const assignedCandIds = getAccessibleCandidates().map(c => String(c.jobId));
            return state.jobs.filter(j => assignedCandIds.includes(String(j.id)));
        }

        function toggleEffectiveRole() {
            if (state.currentUser !== 'Kenneth Cheong') return;
            state.effectiveRole = state.effectiveRole === 'Admin' ? 'Team Lead' : 'Admin';
            updateUserUI();

            // Re-render everything to apply filters
            renderJobs();
            renderCandidates();
            filterCandidatesRepo();
            updateStats();

            // If in users section, go back to dashboard if no longer admin
            if (state.effectiveRole !== 'Admin') {
                const navUsers = document.getElementById('nav-users');
                if (navUsers && navUsers.classList.contains('active')) {
                    showDashboard();
                }
            }
        }

        const PERSISTENCE_LAMBDA_URL = 'https://hntb9oehu6.execute-api.ap-southeast-1.amazonaws.com/recruitementDatabase';

        async function persistenceApiCall(action, data = {}, skipOverlay = false) {
            if (!skipOverlay) toggleLoading(true);
            console.log({
                body: {
                    action: action,
                    data: data,
                    currentUser: state.currentUser
                }
            })
            try {
                const response = await fetch(PERSISTENCE_LAMBDA_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: action,
                        data: data,
                        currentUser: state.currentUser
                    })
                });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);

                let result = await response.json();
                console.log(result)

                // If the Lambda returns a structured response object (statusCode, body, headers),
                // we need to extract and parse the nested body.
                if (result && typeof result === 'object' && result.body !== undefined) {
                    try {
                        return JSON.parse(result.body);
                    } catch (e) {
                        return result.body; // Body might already be an object
                    }
                }

                return result;
            } catch (error) {
                console.error(`Error in ${action}:`, error);
                return null;
            } finally {
                if (!skipOverlay) toggleLoading(false);
            }
        }

        function toggleLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = show ? 'flex' : 'none';
        }

        function bulkCopyUrls(tableId) {
            const selector = tableId === 'candidateTable' ? '.cand-checkbox:checked' : '.repo-checkbox:checked';
            const checked = document.querySelectorAll(selector);
            if (checked.length === 0) return;

            const url = new URL(window.location.href);
            const urls = Array.from(checked).map(cb => {
                const candUrl = new URL(url);
                candUrl.searchParams.set('candidateId', cb.value);
                return candUrl.toString();
            }).join('\n');

            navigator.clipboard.writeText(urls).then(() => {
                showToast(`${checked.length} links copied to clipboard!`);
            }).catch(err => {
                console.error('Failed to copy links: ', err);
                const input = document.createElement('textarea');
                input.value = urls;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                showToast(`${checked.length} links copied to clipboard!`);
            });
        }

        async function initApp() {
            toggleLoading(true);
            try {
                // Fetch basic data in parallel
                const [jobs, candidates, users] = await Promise.all([
                    persistenceApiCall('get_jobs', {}, true),
                    persistenceApiCall('get_candidates', {}, true),
                    persistenceApiCall('get_users', {}, true)
                ]);

                if (Array.isArray(jobs)) state.jobs = jobs;
                if (Array.isArray(candidates)) state.candidates = candidates;
                if (Array.isArray(users)) state.users = users;

                renderJobs();
                await updateStats();

                // Check for shared candidate link
                const urlParams = new URLSearchParams(window.location.search);
                const sharedCandId = urlParams.get('candidateId');
                if (sharedCandId) {
                    console.log("Shared candidate ID found in URL:", sharedCandId);
                    // Slight delay to ensure UI is ready
                    setTimeout(() => viewCandidate(sharedCandId), 500);
                }
            } catch (err) {
                console.error("Initialization error:", err);
                showToast("Error during initialization", "error");
            } finally {
                toggleLoading(false);
            }
        }

        function showToast(message, type = 'success', duration = 3000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const icon = type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;

            container.appendChild(toast);

            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 10);

            // Auto-hide
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);

            toast.onclick = () => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            };
        }

        function copyShareLink(id) {
            const url = new URL(window.location.href);
            url.searchParams.set('candidateId', id);
            const shareUrl = url.toString();

            navigator.clipboard.writeText(shareUrl).then(() => {
                showToast("Share link copied to clipboard!");
            }).catch(err => {
                console.error('Failed to copy link: ', err);
                const input = document.createElement('input');
                input.value = shareUrl;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                showToast("Share link copied to clipboard!");
            });
        }

        // Initialize on load
        window.onload = initApp;

        function saveApiKey(key) {
            state.apiKey = key;
            localStorage.setItem('ai_recruitment_api_key', key);
        }

        // Navigation
        function showDashboard() {
            hideAllSections();
            document.getElementById('dashboardSection').style.display = 'block';
            setActiveNavItem('nav-dashboard');
            updateStats();
        }

        function showJobs() {
            hideAllSections();
            document.getElementById('jobsSection').style.display = 'block';
            setActiveNavItem('nav-jobs');
            renderJobs();
        }

        let isFetchingBackground = false;

        async function loadCandidatesPage(jobId = null) {
            console.log("loadCandidatesPage triggered. JobId:", jobId, "ActiveJobId:", state.activeJobId);
            const requestJobId = jobId || state.activeJobId;

            // If it's a new view (page 1), clear current data
            if (state.pagination.page === 1) {
                state.candidates = [];
            }

            // Initial fetch (Page 1)
            state.isFetchingCandidates = true;
            if (requestJobId) renderCandidates();
            else filterCandidatesRepo();

            const includeDeleted = document.getElementById('showDeletedRepo')?.checked || false;
            const data = await persistenceApiCall('get_candidates', {
                jobId: requestJobId,
                page: state.pagination.page,
                limit: state.pagination.limit,
                includeDeleted: includeDeleted
            }, true);
            state.isFetchingCandidates = false;

            console.log("Initial page data received:", data);

            if (data && Array.isArray(data.candidates)) {
                // Merge into state, avoiding duplicates
                data.candidates.forEach(cand => {
                    if (!state.candidates.find(ex => String(ex.id) === String(cand.id))) {
                        state.candidates.push(cand);
                    }
                });
                state.pagination.total = data.total;

                console.log(`Loaded ${state.candidates.length} candidates. Total possible: ${state.pagination.total}`);

                if (requestJobId) {
                    renderCandidates();
                } else {
                    filterCandidatesRepo();
                }
                renderPagination(jobId);

                // Start background fetch for the rest if needed
                if (state.pagination.total > state.candidates.length) {
                    backgroundFetchAll(requestJobId);
                }
            } else {
                console.warn("No candidates data returned or invalid format", data);
                state.candidates = [];
                if (requestJobId) renderCandidates();
                else filterCandidatesRepo();
            }
        }

        async function backgroundFetchAll(jobId) {
            if (isFetchingBackground) return;
            isFetchingBackground = true;

            let currentPage = 2; // Start from page 2
            const limit = state.pagination.limit;

            while (state.candidates.length < state.pagination.total) {
                // Check if the user has navigated away while fetching
                if (String(jobId) !== String(state.activeJobId)) {
                    console.log("Job context changed, stopping background fetch for:", jobId);
                    break;
                }

                console.log(`Background fetching page ${currentPage} for ${jobId || 'Global Repo'}...`);
                const includeDeleted = document.getElementById('showDeletedRepo')?.checked || false;
                const data = await persistenceApiCall('get_candidates', {
                    jobId: jobId,
                    page: currentPage,
                    limit: limit,
                    includeDeleted: includeDeleted
                }, true);

                if (data && Array.isArray(data.candidates)) {
                    // Merge avoiding duplicates
                    data.candidates.forEach(cand => {
                        if (!state.candidates.find(ex => String(ex.id) === String(cand.id))) {
                            state.candidates.push(cand);
                        }
                    });
                    console.log(`Background progress: ${state.candidates.length}/${state.pagination.total}`);

                    // Re-render current view to reflect new data (enables sorting on more data)
                    if (jobId || state.activeJobId) {
                        renderCandidates();
                    } else {
                        filterCandidatesRepo();
                    }
                    renderPagination(jobId);
                    currentPage++;
                } else {
                    console.error("Background fetch failed for page:", currentPage);
                    break;
                }
            }
            isFetchingBackground = false;
        }

        async function changePage(delta, jobId = null) {
            const newPage = state.pagination.page + delta;
            const requiredCount = newPage * state.pagination.limit;

            state.pagination.page = newPage;

            // If we already have the data in memory (from background fetch), just re-render
            if (state.candidates.length >= requiredCount || state.candidates.length >= state.pagination.total) {
                console.log("Page data already in memory, rendering locally.");
                if (jobId || state.activeJobId) renderCandidates();
                else filterCandidatesRepo();
                renderPagination(jobId);
            } else {
                // Otherwise fetch explicitly
                await loadCandidatesPage(jobId);
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderPagination(jobId = null) {
            console.log("renderPagination triggered. JobId:", jobId, "ActiveJobId:", state.activeJobId, "Total:", state.pagination.total);
            const totalPages = Math.ceil(state.pagination.total / state.pagination.limit);
            const containerId = jobId || state.activeJobId ? 'resultsPagination' : 'repoPagination';
            const container = document.getElementById(containerId);

            console.log("Pagination container found:", containerId, !!container, "Total pages:", totalPages);

            if (!container) {
                console.error("Pagination container not found:", containerId);
                return;
            }

            if (totalPages <= 1) {
                console.log("Only one page or less, skipping pagination render");
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 15px; background: var(--glass); border-radius: 12px; border: 1px solid var(--border);">
                    <div style="color: var(--text-dim); font-size: 0.85rem;">
                        Showing page ${state.pagination.page} of ${totalPages} (${state.pagination.total} total)
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" ${state.pagination.page === 1 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''} 
                            onclick="changePage(-1, ${jobId ? `'${jobId}'` : 'null'})">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <button class="btn" ${state.pagination.page >= totalPages ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''} 
                            onclick="changePage(1, ${jobId ? `'${jobId}'` : 'null'})">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        async function showCandidates() {
            hideAllSections();
            document.getElementById('candidatesSection').style.display = 'block';
            setActiveNavItem('nav-candidates');

            // Reset job context and pagination when viewing global repository
            state.activeJobId = null;
            state.pagination.page = 1;

            await loadCandidatesPage();

            updatePositionFilter();
        }

        function showUsers() {
            hideAllSections();
            document.getElementById('usersSection').style.display = 'block';
            setActiveNavItem('nav-users');
            renderUsers();
        }

        function hideAllSections() {
            const sections = ['dashboardSection', 'jobsSection', 'resultsSection', 'uploadPanel', 'candidatesSection', 'usersSection', 'activityLogSection'];
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
        }

        function setActiveNavItem(id) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const active = document.getElementById(id);
            if (active) active.classList.add('active');
        }

        function createNewJob() {
            state.editingJobId = null;
            document.getElementById('modalTitle').innerText = 'Create New Job Advertisement';
            document.getElementById('saveJobBtn').innerText = 'Create Job';

            // Reset fields
            document.getElementById('jobTitle').value = '';
            document.getElementById('jobDesc').value = '';
            document.getElementById('jobKpi').value = '';
            state.jobCriteria = [
                { text: "Sales experience of at least 1 year", weight: 20 },
                { text: "Sales experience in tech or digital marketing or media", weight: 20 },
                { text: "Has worked in an agency or publishing company", weight: 20 },
                { text: "Has done cold calls and cold outreach", weight: 20 },
                { text: "Indicated has hit/exceeded sales targets consistently", weight: 20 }
            ];
            state.jobQuestions = [];
            renderJobQuestions();
            renderJobCriteria();

            document.getElementById('jobModal').style.display = 'flex';
        }

        function openEditJobModal(id) {
            const job = state.jobs.find(j => String(j.id) === String(id));
            if (!job) {
                console.error("Job not found for editing:", id);
                return;
            }

            state.editingJobId = id;
            document.getElementById('modalTitle').innerText = 'Edit Job Advertisement';
            document.getElementById('saveJobBtn').innerText = 'Update Job';

            document.getElementById('jobTitle').value = job.title;
            document.getElementById('jobDesc').value = job.desc || '';
            document.getElementById('jobKpi').value = job.kpi || '';
            state.jobCriteria = job.evaluationCriteria || [];
            if (state.jobCriteria.length === 0 && job.weights) {
                // Fallback for old data
                state.jobCriteria = [
                    { text: "Experience Match", weight: job.weights.exp || 30 },
                    { text: "Skills Match", weight: job.weights.skills || 30 },
                    { text: "Responsibilities Alignment", weight: job.weights.resp || 20 },
                    { text: "KPI Evidence Match", weight: job.weights.kpi || 20 }
                ];
            }
            renderJobCriteria();
            state.jobQuestions = job.interviewQuestions || [];
            renderJobQuestions();

            document.getElementById('jobModal').style.display = 'flex';
        }

        function closeJobModal() {
            document.getElementById('jobModal').style.display = 'none';
            state.editingJobId = null;
        }

        async function saveJob() {
            const title = document.getElementById('jobTitle').value;
            const desc = document.getElementById('jobDesc').value;
            const kpi = document.getElementById('jobKpi').value;

            if (!title || !desc) {
                alert('Please fill in title and description');
                return;
            }

            const totalWeight = state.jobCriteria.reduce((sum, c) => sum + (c.weight || 0), 0);
            if (totalWeight > 100) {
                alert(`Total weightage cannot exceed 100%. Current total: ${totalWeight}%`);
                return;
            }
            if (totalWeight < 100) {
                if (!confirm(`Total weightage is ${totalWeight}%, which is less than 100%. Are you sure you want to proceed?`)) {
                    return;
                }
            }

            const jobData = {
                title, desc, kpi,
                evaluationCriteria: state.jobCriteria,
                interviewQuestions: state.jobQuestions,
                status: 'Open',
                applicants: 0,
                shortlisted: 0
            };

            if (state.editingJobId) {
                jobData.id = state.editingJobId;
            }

            const result = await persistenceApiCall('upsert_job', jobData);
            if (result && result.success) {
                // Refresh local list from server to ensure sync
                const jobs = await persistenceApiCall('get_jobs');
                if (Array.isArray(jobs)) state.jobs = jobs;

                renderJobs();
                closeJobModal();

                // Auto reset form
                document.getElementById('jobTitle').value = '';
                document.getElementById('jobDesc').value = '';
                document.getElementById('jobKpi').value = '';
            } else {
                alert("Failed to save job to database. Check console for details.");
            }
        }
        function addJobQuestion() {
            if (!state.jobQuestions) state.jobQuestions = [];
            state.jobQuestions.push({
                id: 'q_' + Math.random().toString(36).substr(2, 9),
                metric: "New Metric",
                q: "New Question",
                good: "Good answer indicators",
                bad: "Red flag indicators"
            });
            renderJobQuestions();
        }

        function deleteJobQuestion(idx) {
            state.jobQuestions.splice(idx, 1);
            renderJobQuestions();
        }

        function updateJobQuestionContent(idx, field, value) {
            if (state.jobQuestions[idx][field] === value) return;
            state.jobQuestions[idx][field] = value;
        }

        function renderJobQuestions() {
            const body = document.getElementById('jobQuestionsBody');
            if (!body) return;
            if (!state.jobQuestions || state.jobQuestions.length === 0) {
                body.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: var(--text-dim);">No standard questions defined.</td></tr>';
                return;
            }
            body.innerHTML = state.jobQuestions.map((row, idx) => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.03);" data-id="${idx}">
                    <td style="padding: 12px; vertical-align: top; text-align: center; color: var(--primary-light); cursor: grab;" class="drag-handle">
                        <i class="fas fa-grip-vertical"></i>
                    </td>
                    <td style="padding: 12px 24px; vertical-align: top;">
                        <div contenteditable="true" onblur="updateJobQuestionContent(${idx}, 'metric', this.innerText)"
                             style="color: var(--text-main); font-weight: 600; outline: none; border: 1px solid transparent; padding: 2px 4px; border-radius: 4px;"
                             onmouseover="this.style.borderColor='rgba(99, 102, 241, 0.3)'" onmouseout="this.style.borderColor='transparent'">
                             ${row.metric}
                        </div>
                    </td>
                    <td style="padding: 12px; vertical-align: top;">
                        <div contenteditable="true" onblur="updateJobQuestionContent(${idx}, 'q', this.innerText)"
                             style="color: var(--text-main); outline: none; border: 1px solid transparent; padding: 2px 4px; border-radius: 4px;"
                             onmouseover="this.style.borderColor='rgba(99, 102, 241, 0.3)'" onmouseout="this.style.borderColor='transparent'">
                             ${row.q}
                        </div>
                    </td>
                    <td style="padding: 12px; vertical-align: top;">
                        <div contenteditable="true" onblur="updateJobQuestionContent(${idx}, 'good', this.innerText)"
                             style="color: var(--text-dim); font-size: 0.8rem; outline: none; border: 1px solid transparent; padding: 2px 4px; border-radius: 4px;"
                             onmouseover="this.style.borderColor='rgba(99, 102, 241, 0.3)'" onmouseout="this.style.borderColor='transparent'">
                             ${row.good}
                        </div>
                    </td>
                    <td style="padding: 12px; vertical-align: top;">
                        <div contenteditable="true" onblur="updateJobQuestionContent(${idx}, 'bad', this.innerText)"
                             style="color: var(--text-dim); font-size: 0.8rem; outline: none; border: 1px solid transparent; padding: 2px 4px; border-radius: 4px;"
                             onmouseover="this.style.borderColor='rgba(99, 102, 241, 0.3)'" onmouseout="this.style.borderColor='transparent'">
                             ${row.bad}
                        </div>
                    </td>
                    <td style="padding: 12px; vertical-align: top; text-align: center;">
                        <button class="btn" style="background: var(--accent); color: white; padding: 6px 12px; font-size: 0.9rem;" onclick="deleteJobQuestion(${idx})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            initJobQuestionsSortable();
        }

        let jobQuestionsSortable = null;
        function initJobQuestionsSortable() {
            const el = document.getElementById('jobQuestionsBody');
            if (!el) return;
            if (jobQuestionsSortable) jobQuestionsSortable.destroy();
            jobQuestionsSortable = new Sortable(el, {
                handle: '.drag-handle',
                animation: 150,
                onEnd: function () {
                    const rows = Array.from(el.querySelectorAll('tr[data-id]'));
                    const newQuestions = rows.map(row => {
                        const originalIdx = parseInt(row.getAttribute('data-id'));
                        return state.jobQuestions[originalIdx];
                    });
                    state.jobQuestions = newQuestions;
                    renderJobQuestions();
                }
            });
        }
        function addJobCriteria() {
            if (!state.jobCriteria) state.jobCriteria = [];
            state.jobCriteria.push({
                text: "New Criterion",
                weight: 0
            });
            renderJobCriteria();
        }

        function deleteJobCriteria(idx) {
            state.jobCriteria.splice(idx, 1);
            renderJobCriteria();
        }

        function updateJobCriteriaContent(idx, field, value) {
            if (field === 'weight') value = parseInt(value) || 0;
            if (state.jobCriteria[idx][field] === value) return;
            state.jobCriteria[idx][field] = value;
            if (field === 'weight') updateCriteriaTotal();
        }

        function updateCriteriaTotal() {
            const total = state.jobCriteria.reduce((sum, c) => sum + (c.weight || 0), 0);
            const display = document.getElementById('totalCriteriaWeight');
            if (display) {
                display.innerText = `${total}%`;
                display.style.color = total > 100 ? 'var(--accent)' : 'var(--secondary)';
            }
        }

        function renderJobCriteria() {
            const body = document.getElementById('jobCriteriaBody');
            if (!body) return;
            if (!state.jobCriteria || state.jobCriteria.length === 0) {
                body.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--text-dim);">No evaluation criteria defined.</td></tr>';
                return;
            }
            body.innerHTML = state.jobCriteria.map((row, idx) => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.03);">
                    <td style="padding: 12px 24px; vertical-align: top;">
                        <div contenteditable="true" onblur="updateJobCriteriaContent(${idx}, 'text', this.innerText)"
                             style="color: var(--text-main); outline: none; border: 1px solid transparent; padding: 2px 4px; border-radius: 4px;"
                             onmouseover="this.style.borderColor='rgba(99, 102, 241, 0.3)'" onmouseout="this.style.borderColor='transparent'">
                             ${row.text}
                        </div>
                    </td>
                    <td style="padding: 12px; vertical-align: top;">
                        <input type="number" value="${row.weight}" onblur="updateJobCriteriaContent(${idx}, 'weight', this.value)"
                               style="width: 100%; height: 32px; background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border); border-radius: 8px; color: white; padding: 0 8px; outline: none;">
                    </td>
                    <td style="padding: 12px; vertical-align: top; text-align: center;">
                        <button class="btn" style="background: var(--accent); color: white; padding: 6px 12px; font-size: 0.9rem;" onclick="deleteJobCriteria(${idx})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            updateCriteriaTotal();
        }



        function expandSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.remove('collapsed');
        }

        function collapseSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.add('collapsed');
        }

        function getStatusOptions(currentStatus) {
            const statuses = ['No Action', 'Invited', 'Scheduled', 'Interviewed', 'Shortlisted', 'Offered', 'Rejected'];
            return statuses.map(s => `<option value="${s}" ${s === currentStatus ? 'selected' : ''}>${s}</option>`).join('');
        }

        function updateJobStatus(jobId, newStatus) {
            const job = state.jobs.find(j => String(j.id) === String(jobId));
            if (job) job.status = newStatus;
        }

        async function updateCandidateStatus(candId, newStatus) {
            const cand = state.candidates.find(c => String(c.id) === String(candId));
            if (cand) {
                cand.status = newStatus;
                await persistenceApiCall('upsert_candidate', { id: candId, status: newStatus });
                renderCandidates();
            }
        }

        async function updateCandidatePending(candId, pendingBy) {
            const cand = state.candidates.find(c => String(c.id) === String(candId));
            if (cand) {
                cand.pendingBy = pendingBy;
                await persistenceApiCall('upsert_candidate', { id: candId, pendingBy: pendingBy });
                filterCandidatesRepo();
            }
        }

        function renderJobs() {
            const container = document.getElementById('jobListBody');
            const accessibleJobs = getAccessibleJobs();
            if (!accessibleJobs || accessibleJobs.length === 0) {
                container.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-dim);">No jobs found.</td></tr>';
                return;
            }
            container.innerHTML = accessibleJobs.map(job => `
                <tr style="cursor: pointer; transition: background 0.2s ease;">
                    <td style="font-weight: 600;">${job.title}</td>
                    <td style="font-size: 0.75rem; color: var(--text-dim);">${formatDateTime8(job.createdAt)}</td>
                    <td>${job.applicants || 0}</td>
                    <td>${job.shortlisted || 0}</td>
                    <td>
                        <span class="badge ${job.status === 'Open' ? 'badge-success' : 'badge-error'}" 
                             style="cursor: pointer;" onclick="toggleJobStatus('${job.id}')">${job.status}</span>
                    </td>
                    <td style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.75rem;" onclick="openJobDetails('${job.id}')">Manage</button>
                        <button class="btn" style="padding: 6px 12px; font-size: 0.75rem; background: var(--glass); color: white; border: 1px solid var(--border);" onclick="openEditJobModal('${job.id}')">Edit</button>
                        <button class="btn" style="padding: 6px 12px; font-size: 0.75rem; background: var(--glass); color: var(--secondary); border: 1px solid var(--secondary);" onclick="confirmDuplicateJob('${job.id}')"><i class="fas fa-clone"></i> Clone</button>
                        <button class="btn" style="padding: 6px 12px; font-size: 0.75rem; background: rgba(244, 63, 94, 0.1); color: #fb7185; border: 1px solid rgba(244, 63, 94, 0.2);" onclick="deleteJob('${job.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');

            updateStats();
        }

        async function deleteJob(jobId) {
            if (!confirm("Are you sure you want to delete this job? You can undo this later from the Activity Log.")) return;
            const result = await persistenceApiCall('delete_job', { id: jobId });
            if (result && result.success) {
                state.jobs = state.jobs.filter(j => String(j.id) !== String(jobId));
                renderJobs();
            } else {
                alert("Failed to delete job.");
            }
        }

        async function restoreJob(jobId) {
            const result = await persistenceApiCall('restore_job', { id: jobId });
            if (result && result.success) {
                const jobs = await persistenceApiCall('get_jobs');
                if (Array.isArray(jobs)) state.jobs = jobs;
                showAuditLogs(); // Refresh log view
                alert("Job restored successfully!");
            } else {
                alert("Failed to restore job.");
            }
        }

        function confirmDuplicateJob(jobId) {
            const job = state.jobs.find(j => String(j.id) === String(jobId));
            if (!job) return;

            const newTitle = prompt("Duplicate job: " + job.title + "\nEnter new job title:", job.title + " (Copy)");
            if (newTitle === null || newTitle.trim() === "") return;

            duplicateJob(jobId, newTitle.trim());
        }

        async function duplicateJob(jobId, newTitle) {
            const originalJob = state.jobs.find(j => String(j.id) === String(jobId));
            if (!originalJob) return;

            // Clone job data but reset ID and candidate related fields
            const newJobData = {
                title: newTitle,
                desc: originalJob.desc || '',
                kpi: originalJob.kpi || '',
                evaluationCriteria: JSON.parse(JSON.stringify(originalJob.evaluationCriteria || [])),
                interviewQuestions: JSON.parse(JSON.stringify(originalJob.interviewQuestions || [])),
                status: 'Open',
                applicants: 0,
                shortlisted: 0
            };

            const result = await persistenceApiCall('upsert_job', newJobData);
            if (result && result.success) {
                // Refresh local jobs list
                const jobs = await persistenceApiCall('get_jobs');
                if (Array.isArray(jobs)) state.jobs = jobs;
                renderJobs();
                alert("Job duplicated successfully!");
            } else {
                alert("Failed to duplicate job.");
            }
        }

        async function toggleJobStatus(jobId) {
            const job = state.jobs.find(j => String(j.id) === String(jobId));
            if (!job) return;
            const newStatus = job.status === 'Open' ? 'Closed' : 'Open';
            const result = await persistenceApiCall('upsert_job', { ...job, status: newStatus });
            if (result && result.success) {
                job.status = newStatus;
                renderJobs();
            }
        }

        async function updateStats() {
            const accessibleJobs = getAccessibleJobs();
            const accessibleCandidates = getAccessibleCandidates();

            const totalApplicants = accessibleJobs.reduce((sum, j) => sum + (parseInt(j.applicants) || 0), 0);
            const highQuality = accessibleCandidates.filter(c => c.aiScore > 80).length;

            if (document.getElementById('stat-jobs')) document.getElementById('stat-jobs').innerText = accessibleJobs.length;
            if (document.getElementById('stat-total')) document.getElementById('stat-total').innerText = totalApplicants;
            if (document.getElementById('stat-leads')) document.getElementById('stat-leads').innerText = highQuality;
        }

        async function openJobDetails(id) {
            state.activeJobId = id;
            const job = state.jobs.find(j => String(j.id) === String(id));
            if (!job) return;

            document.getElementById('jobTitleDisplay').innerText = job.title;

            // Reset pagination for new job context
            state.pagination.page = 1;

            hideAllSections();
            document.getElementById('uploadPanel').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'block';

            await loadCandidatesPage(id);
        }

        // User Management Logic
        function renderUsers() {
            const body = document.getElementById('userListBody');
            body.innerHTML = state.users.map(user => `
                <tr>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="badge ${user.role === 'Admin' ? 'badge-success' : 'badge-warning'}">
                        ${user.name === 'Kenneth Cheong' ? 'Team Lead' : user.role}
                    </span></td>
                    <td><span class="badge ${user.status === 'Active' ? 'badge-success' : 'badge-error'}">${user.status}</span></td>
                    <td>
                        <button class="btn" style="padding: 4px 8px; font-size: 0.75rem; background: var(--glass); color: white;" onclick="openEditUserModal('${user.id}')">Edit</button>
                        <button class="btn" style="padding: 4px 8px; font-size: 0.75rem; background: rgba(244, 63, 94, 0.1); color: var(--accent);" onclick="deleteUser('${user.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }


        function openUserModal() {
            state.editingUserId = null;
            document.getElementById('userModalTitle').innerText = 'Add New User';
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userModal').style.display = 'flex';
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        async function saveUser() {
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const role = document.getElementById('userRole').value;
            const status = document.getElementById('userStatus').value;

            if (!name || !email) return alert('Please fill in name and email');

            const userData = {
                id: state.editingUserId || null,
                name,
                email,
                role,
                status
            };

            const result = await persistenceApiCall('upsert_user', userData);
            if (result && result.success) {
                // Refresh local list
                const users = await persistenceApiCall('get_users');
                if (Array.isArray(users)) state.users = users;

                renderUsers();
                closeUserModal();
                alert("User saved successfully!");
            } else {
                alert("Failed to save user to database.");
            }
        }

        function openEditUserModal(id) {
            const user = state.users.find(u => String(u.id) === String(id));
            if (!user) return;

            state.editingUserId = id;
            document.getElementById('userModalTitle').innerText = 'Edit User';
            document.getElementById('userName').value = user.name;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userStatus').value = user.status;
            document.getElementById('userModal').style.display = 'flex';
        }

        async function deleteUser(id) {
            if (confirm('Are you sure you want to delete this user?')) {
                const result = await persistenceApiCall('delete_user', { id });
                if (result && result.success) {
                    state.users = state.users.filter(u => String(u.id) !== String(id));
                    renderUsers();
                } else {
                    alert("Failed to delete user.");
                }
            }
        }

        // Candidates Repository Logic
        function updatePositionFilter() {
            const select = document.getElementById('filterPosition');
            const positions = [...new Set(state.jobs.map(j => j.title))];
            select.innerHTML = '<option value="">All Positions</option>' +
                positions.map(p => `<option value="${p}">${p}</option>`).join('');
        }

        function filterCandidatesRepo() {
            const showDeleted = document.getElementById('showDeletedRepo')?.checked || false;

            // Show/Hide bulk action buttons based on mode
            document.getElementById('bulkRestoreRepoBtn').style.display = showDeleted ? 'inline-flex' : 'none';
            document.getElementById('bulkDeleteRepoBtn').style.display = showDeleted ? 'none' : 'inline-flex';

            const search = document.getElementById('searchCand')?.value.toLowerCase() || "";
            const pos = document.getElementById('filterPosition')?.value || "";
            const status = document.getElementById('filterStatus')?.value || "";
            const startStr = document.getElementById('dateStart')?.value || "";
            const endStr = document.getElementById('dateEnd')?.value || "";

            const accessibleCandidates = getAccessibleCandidates();
            let filtered = accessibleCandidates.map(c => {
                const job = state.jobs.find(j => String(j.id) == String(c.jobId));
                return { ...c, jobTitle: job ? job.title : 'Unknown' };
            });

            if (search) filtered = filtered.filter(c => c.name.toLowerCase().includes(search));
            if (pos) filtered = filtered.filter(c => c.jobTitle === pos);
            if (status) filtered = filtered.filter(c => c.status === status);

            // Handle Deleted Logic
            if (showDeleted) {
                filtered = filtered.filter(c => c.deleted === true);
            } else {
                filtered = filtered.filter(c => !c.deleted);
            }
            if (startStr) filtered = filtered.filter(c => new Date(ensureUTC(c.date)) >= new Date(startStr));
            if (endStr) filtered = filtered.filter(c => new Date(ensureUTC(c.date)) <= new Date(endStr));

            // Sorting
            filtered.sort((a, b) => {
                let valA, valB;
                if (repoSort.field === 'name') { valA = a.name; valB = b.name; }
                else if (repoSort.field === 'job') { valA = a.jobTitle; valB = b.jobTitle; }
                else if (repoSort.field === 'date') { valA = new Date(ensureUTC(a.date)); valB = new Date(ensureUTC(b.date)); }
                else if (repoSort.field === 'score') { valA = a.aiScore; valB = b.aiScore; }
                else if (repoSort.field === 'interviewerScore') { valA = a.interviewerScore || 0; valB = b.interviewerScore || 0; }
                else if (repoSort.field === 'pendingBy') { valA = a.pendingBy; valB = b.pendingBy; }
                else if (repoSort.field === 'status') { valA = a.status; valB = b.status; }

                if (valA < valB) return repoSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return repoSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Pagination Slicing
            const start = (state.pagination.page - 1) * state.pagination.limit;
            const sliced = filtered.slice(start, start + state.pagination.limit);

            renderCandidatesRepoUI(sliced);
        }

        function sortRepoTable(field) {
            if (repoSort.field === field) {
                repoSort.direction = repoSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                repoSort.field = field;
                repoSort.direction = 'asc';
            }
            filterCandidatesRepo();
        }

        function renderCandidatesRepoUI(displayData) {
            const body = document.getElementById('repoBody');
            if (!body) return;

            if (state.isFetchingCandidates && displayData.length === 0) {
                body.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: var(--text-dim);"><i class="fas fa-spinner fa-spin me-2"></i> Loading candidates...</td></tr>';
                return;
            }

            if (displayData.length === 0) {
                body.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: var(--text-dim);">No candidates found.</td></tr>';
                return;
            }

            body.innerHTML = displayData.map(c => `
                <tr data-id="${c.id}" style="animation: fadeIn 0.3s ease forwards; ${c.isReEvaluating ? 'opacity: 0.7; pointer-events: none;' : ''}" onclick="toggleRowSelection(this)">
                    <td style="text-align: center;" onclick="event.stopPropagation()">
                        <input type="checkbox" class="repo-checkbox" value="${c.id}" onchange="updateBulkDeleteVisibility('repoTable')">
                    </td>
                    <td style="font-weight: 600;">${c.name}</td>
                    <td>${c.jobTitle}</td>
                    <td>${formatDate8(c.date)}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${c.isReEvaluating ?
                    `<span style="font-size: 0.8rem; color: var(--accent);"><i class="fas fa-spinner fa-spin me-1"></i> Analyzing...</span>` :
                    `<span style="font-weight: 700; color: var(--secondary);">${c.aiScore}%</span>`
                }
                        </div>
                    </td>
                    <td><span style="font-weight: 700; color: var(--secondary);">${c.interviewerScore || 0}%</span></td>
                    <td>
                        <select style="padding: 4px 8px; font-size: 0.75rem; background: var(--glass); color: white; border: 1px solid var(--border); border-radius: 8px; outline: none; width: 100%; max-width: 140px;" 
                            onclick="event.stopPropagation()" onchange="updateCandidatePending('${c.id}', this.value)">
                            ${getAssigneeOptions(c.pendingBy)}
                        </select>
                    </td>
                    <td>
                        <select style="padding: 4px 8px; font-size: 0.75rem; background: var(--glass); color: white; border: 1px solid var(--border); border-radius: 8px; outline: none;" 
                            onclick="event.stopPropagation()" onchange="updateCandidateStatus('${c.id}', this.value)">
                            ${getStatusOptions(c.status)}
                        </select>
                    </td>
                    <td>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn" style="padding: 4px 8px; font-size: 0.75rem; background: var(--glass); color: white;" onclick="event.stopPropagation(); viewCandidate('${c.id}')">Review</button>
                            <button class="btn" style="padding: 4px 8px; font-size: 0.75rem; background: var(--glass); color: var(--secondary); border: 1px solid var(--secondary);" 
                                onclick="event.stopPropagation(); copyShareLink('${c.id}')">
                                <i class="fas fa-share-alt"></i>
                            </button>
                            <button class="btn" style="padding: 4px 8px; font-size: 0.75rem; background: var(--accent); color: white;" onclick="event.stopPropagation(); deleteCandidate('${c.id}')">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function closeUpload() {
            document.getElementById('uploadPanel').style.display = 'none';
            document.getElementById('jobsSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
        }

        // File Handling Logic
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.onclick = () => fileInput.click();

        dropZone.ondragover = (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--primary)';
            dropZone.style.background = 'rgba(99, 102, 241, 0.05)';
        };

        dropZone.ondragleave = () => {
            dropZone.style.borderColor = 'var(--border)';
            dropZone.style.background = 'transparent';
        };

        dropZone.ondrop = (e) => {
            e.preventDefault();
            handleFiles(e.dataTransfer.files);
        };

        fileInput.onchange = (e) => {
            handleFiles(e.target.files);
        };

        async function handleFiles(files) {
            for (const file of files) {
                if (file.type === 'application/zip' || file.name.endsWith('.zip')) {
                    const zip = await JSZip.loadAsync(file);
                    for (const [name, zipEntry] of Object.entries(zip.files)) {
                        if (!zipEntry.dir && isSupported(name)) {
                            const blob = await zipEntry.async('blob');
                            state.stagedFiles.push({ name, blob, id: Math.random().toString(36).substr(2, 9) });
                        }
                    }
                } else if (isSupported(file.name)) {
                    state.stagedFiles.push({ name: file.name, blob: file, id: Math.random().toString(36).substr(2, 9) });
                }
            }
            renderStagedFiles();
        }

        function renderStagedFiles() {
            const container = document.getElementById('stagedFilesList');
            const area = document.getElementById('stagingArea');

            if (state.stagedFiles.length === 0) {
                area.style.display = 'none';
                return;
            }

            area.style.display = 'block';
            container.innerHTML = state.stagedFiles.map(f => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: rgba(15, 23, 42, 0.4); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.2rem;">üìÑ</span>
                        <div>
                            <div style="font-weight: 600; font-size: 0.9rem;">${f.name}</div>
                            <div style="font-size: 0.7rem; color: var(--text-dim);">${(f.blob.size / 1024).toFixed(0)} KB</div>
                        </div>
                    </div>
                    <button onclick="removeStagedFile('${f.id}')" style="background: none; border: none; color: var(--accent); cursor: pointer; padding: 4px;">‚úï</button>
                </div>
                `).join('');
        }

        function removeStagedFile(id) {
            state.stagedFiles = state.stagedFiles.filter(f => f.id !== id);
            renderStagedFiles();
        }

        function clearStaged() {
            state.stagedFiles = [];
            renderStagedFiles();
        }

        async function processAllStaged() {
            if (state.stagedFiles.length === 0) return;
            const toProcess = [...state.stagedFiles];
            state.stagedFiles = [];
            renderStagedFiles();
            processBatch(toProcess);
        }

        function isSupported(name) {
            const ext = name.split('.').pop().toLowerCase();
            return ['pdf', 'docx', 'txt', 'jpg', 'png', 'jpeg'].includes(ext);
        }

        async function processBatch(list) {
            const statusPanel = document.getElementById('processingStatus');
            const pgBar = document.getElementById('statusProgress');
            const pgText = document.getElementById('statusText');
            const pgPercent = document.getElementById('statusPercent');

            statusPanel.style.display = 'block';
            pgText.innerText = `Analyzing ${list.length} files simultaneously...`;
            pgBar.style.width = '10%';
            pgPercent.innerText = '10%';

            let completed = 0;
            const promises = list.map(async (item) => {
                console.log(`[Batch] Starting processing for: ${item.name} `);
                try {
                    const text = await extractText(item);
                    console.log(`[Batch] Extracted text for ${item.name}(${text.length} chars)`);

                    const analysis = await callAIAnalysis(item, text);
                    console.log(`[Batch] Received AI Analysis for ${item.name}: `, analysis);

                    if (!analysis || typeof analysis !== 'object') {
                        throw new Error(`Invalid analysis result for ${item.name}`);
                    }

                    const cvDataBase64 = await toBase64(item.blob);
                    addCandidate(item.name, analysis, cvDataBase64, text);
                    console.log(`[Batch] Successfully added candidate: ${item.name} `);
                } catch (err) {
                    console.error(`[Batch] ERROR processing ${item.name}: `, err);
                    alert(`Error processing ${item.name}: ${err.message} `);
                } finally {
                    completed++;
                    const progress = (completed / list.length) * 100;
                    console.log(`[Batch] Progress: ${completed}/${list.length} (${progress}%)`);
                    pgBar.style.width = `${progress}%`;
                    pgPercent.innerText = `${Math.round(progress)}%`;
                }
            });

            await Promise.all(promises);
            console.log('[Batch] All promises settled');

            pgBar.style.width = '100%';
            pgPercent.innerText = '100%';
            pgText.innerText = 'Processing complete!';

            setTimeout(() => {
                statusPanel.style.display = 'none';
            }, 2000);
        }

        // Selection and Deletion Helpers
        async function bulkRestoreRepo() {
            const checked = document.querySelectorAll('.repo-checkbox:checked');
            if (checked.length === 0) {
                alert("Please select candidates to restore.");
                return;
            }

            if (!confirm(`Are you sure you want to restore ${checked.length} candidates?`)) return;

            const ids = Array.from(checked).map(cb => cb.value);
            const result = await persistenceApiCall('bulk_restore_candidates', { ids });

            if (result && result.success) {
                // Update local stats
                ids.forEach(id => {
                    const cand = state.candidates.find(c => String(c.id) === String(id));
                    if (cand) {
                        cand.deleted = false;
                        const job = state.jobs.find(j => String(j.id) === String(cand.jobId));
                        if (job) {
                            job.applicants++;
                            if (cand.status === 'Shortlisted') job.shortlisted++;
                        }
                    }
                });

                // Full re-fetch to ensure consistency (handles items not currently in state)
                const includeDeleted = document.getElementById('showDeletedRepo')?.checked || false;
                const data = await persistenceApiCall('get_candidates', {
                    includeDeleted: includeDeleted
                }, true);
                if (data && Array.isArray(data.candidates)) {
                    // Update state with new data
                    data.candidates.forEach(cand => {
                        const idx = state.candidates.findIndex(ex => String(ex.id) === String(cand.id));
                        if (idx !== -1) state.candidates[idx] = cand;
                        else state.candidates.push(cand);
                    });
                }

                filterCandidatesRepo();
                updateStats();
                renderJobs();

                const selectAll = document.getElementById('selectAllRepo');
                if (selectAll) selectAll.checked = false;
                updateBulkDeleteVisibility('repoTable');

                if (result.count > 0) {
                    alert(`Successfully restored ${result.count} candidates.`);
                } else if (result.matched > 0) {
                    alert(`Selected candidate(s) were already active (already restored).`);
                } else {
                    alert("No candidates were found matching the selection. They may have been permanently deleted or moved.");
                }
            } else {
                alert("Failed to restore candidates.");
            }
        }

        function toggleSelectAll(tableId) {
            const isChecked = tableId === 'candidateTable' ?
                document.getElementById('selectAllCandidates').checked :
                document.getElementById('selectAllRepo').checked;

            const selector = tableId === 'candidateTable' ? '.cand-checkbox' : '.repo-checkbox';
            document.querySelectorAll(selector).forEach(cb => cb.checked = isChecked);
            updateBulkDeleteVisibility(tableId);
        }

        function updateBulkDeleteVisibility(tableId) {
            const selector = tableId === 'candidateTable' ? '.cand-checkbox:checked' : '.repo-checkbox:checked';
            const deleteBtnId = tableId === 'candidateTable' ? 'bulkDeleteBtn' : 'bulkDeleteRepoBtn';
            const copyBtnId = tableId === 'candidateTable' ? 'bulkCopyBtn' : 'bulkCopyRepoBtn';
            const reEvalBtnId = tableId === 'candidateTable' ? 'bulkReEvaluateBtn' : 'bulkReEvaluateRepoBtn';
            const assignContainerId = tableId === 'candidateTable' ? 'bulkAssignContainer' : 'bulkAssignRepoContainer';

            const checkedCount = document.querySelectorAll(selector).length;
            const isAdmin = state.effectiveRole === 'Admin';

            document.getElementById(deleteBtnId).style.display = (checkedCount > 0) ? 'block' : 'none';
            document.getElementById(copyBtnId).style.display = (checkedCount > 0) ? 'block' : 'none';
            document.getElementById(reEvalBtnId).style.display = (checkedCount > 0) ? 'block' : 'none';

            const assignContainer = document.getElementById(assignContainerId);
            if (assignContainer) {
                assignContainer.style.display = (checkedCount > 0 && isAdmin) ? 'flex' : 'none';
                if (checkedCount > 0 && isAdmin) {
                    populateBulkAssignSelects();
                }
            }
        }

        function populateBulkAssignSelects() {
            const options = getAssigneeOptions('');
            const s1 = document.getElementById('bulkAssignSelect');
            const s2 = document.getElementById('bulkAssignRepoSelect');
            if (s1) s1.innerHTML = options;
            if (s2) s2.innerHTML = options;
        }

        async function bulkAssign(tableId) {
            const selector = tableId === 'candidateTable' ? '.cand-checkbox:checked' : '.repo-checkbox:checked';
            const selectId = tableId === 'candidateTable' ? 'bulkAssignSelect' : 'bulkAssignRepoSelect';
            const selectedIds = Array.from(document.querySelectorAll(selector)).map(cb => cb.value);
            const assignee = document.getElementById(selectId).value;

            if (selectedIds.length === 0) return;
            if (!assignee) {
                alert("Please select a user to assign to.");
                return;
            }

            if (!confirm(`Are you sure you want to assign ${selectedIds.length} candidates to ${assignee}?`)) return;

            showLoading(true);
            try {
                // Batch updates
                await Promise.all(selectedIds.map(id =>
                    persistenceApiCall('update_candidate_assignee', { id: id, pendingBy: assignee })
                ));

                // Update local state
                selectedIds.forEach(id => {
                    const cand = state.candidates.find(c => c.id.toString() === id.toString());
                    if (cand) cand.pendingBy = assignee;
                });

                alert(`Successfully assigned ${selectedIds.length} candidates to ${assignee}.`);
                renderCandidates();
                filterCandidatesRepo();
            } catch (error) {
                console.error("Bulk assign error:", error);
                alert("An error occurred during bulk assignment. Some updates may not have completed.");
            } finally {
                showLoading(false);
            }
        }

        function toggleRowSelection(row) {
            const cb = row.querySelector('input[type=\"checkbox\"]');
            if (cb) {
                cb.checked = !cb.checked;
                const tableId = row.closest('table').id;
                updateBulkDeleteVisibility(tableId);
            }
        }

        async function deleteCandidate(id) {
            const result = await persistenceApiCall('delete_candidate', { id });
            if (result && result.success) {
                const cand = state.candidates.find(c => c.id.toString() === id.toString());
                if (cand) {
                    const job = state.jobs.find(j => j.id.toString() === cand.jobId.toString());
                    if (job) {
                        job.applicants--;
                        if (cand.status === 'Shortlisted') job.shortlisted--;
                    }
                    state.candidates = state.candidates.filter(c => c.id.toString() !== id.toString());
                }

                renderCandidates();
                filterCandidatesRepo();
                updateStats();
                renderJobs();
            } else {
                alert("Failed to delete candidate.");
            }
        }

        async function restoreCandidate(id) {
            const result = await persistenceApiCall('restore_candidate', { id });
            if (result && result.success) {
                // Refresh candidates for active job
                const candidates = await persistenceApiCall('get_candidates', { jobId: state.activeJobId });
                if (Array.isArray(candidates)) state.candidates = candidates;

                showAuditLogs(); // Refresh Activity Log
                alert("Candidate restored successfully!");
            }
        }
        async function restoreBulkCandidates(idsString) {
            if (idsString === 'batch') {
                alert("This is an older log entry that does not contain specific candidate IDs. Please go to the 'Candidates Repository' section and use the 'View Trash' checkbox to restore these candidates manually.");
                return;
            }

            const ids = idsString.split(',').filter(id => id.trim() !== '');
            if (ids.length === 0) {
                alert("No IDs found for restoration.");
                return;
            }

            if (!confirm(`Are you sure you want to restore these ${ids.length} candidates?`)) return;

            const res = await persistenceApiCall('bulk_restore_candidates', { ids });
            if (res && res.success) {
                // Update local state for immediate feedback
                ids.forEach(id => {
                    const cand = state.candidates.find(c => String(c.id) === String(id));
                    if (cand) {
                        cand.deleted = false;
                        const job = state.jobs.find(j => String(j.id) === String(cand.jobId));
                        if (job) {
                            job.applicants++;
                            if (cand.status === 'Shortlisted') job.shortlisted++;
                        }
                    }
                });

                // Full re-fetch to ensure consistency (handles items not currently in state)
                const fetchParams = state.activeJobId ? { jobId: state.activeJobId } : {};
                const includeDeleted = document.getElementById('showDeletedRepo')?.checked || false;
                if (includeDeleted) fetchParams.includeDeleted = true;

                const data = await persistenceApiCall('get_candidates', fetchParams, true);
                if (data && Array.isArray(data.candidates)) {
                    // Update state with new data
                    data.candidates.forEach(cand => {
                        const idx = state.candidates.findIndex(ex => String(ex.id) === String(cand.id));
                        if (idx !== -1) state.candidates[idx] = cand;
                        else state.candidates.push(cand);
                    });
                }

                showAuditLogs(); // Refresh log view
                renderCandidates();
                filterCandidatesRepo();
                updateStats();
                renderJobs();

                if (res.count > 0) {
                    alert(`Successfully restored ${res.count} candidates.`);
                } else if (res.matched > 0) {
                    alert(`Candidate(s) were already active (already restored).`);
                } else {
                    alert("No candidates were found matching the log entry IDs. They may have been permanently deleted or moved.");
                }
            }
        }

        async function bulkDelete() {
            const checked = document.querySelectorAll('.cand-checkbox:checked');
            if (checked.length === 0) return;

            if (!confirm(`Are you sure you want to delete ${checked.length} candidates?`)) return;

            const ids = Array.from(checked).map(cb => cb.value);

            // Single API call handles loading state automatically
            const result = await persistenceApiCall('bulk_delete_candidates', { ids });

            if (result && result.success) {
                // Update local stats first
                ids.forEach(id => {
                    const cand = state.candidates.find(c => String(c.id) === String(id));
                    if (cand) {
                        const job = state.jobs.find(j => String(j.id) === String(cand.jobId));
                        if (job) {
                            if (job.applicants > 0) job.applicants--;
                            if (cand.status === 'Shortlisted' && job.shortlisted > 0) job.shortlisted--;
                        }
                    }
                });

                // Remove from state
                const idsSet = new Set(ids.map(String));
                state.candidates.forEach(c => {
                    if (idsSet.has(String(c.id))) c.deleted = true;
                });

                renderCandidates();
                updateStats(); // Update dashboard/sidebar stats
                renderJobs();  // Update job list counts

                document.getElementById('selectAllCandidates').checked = false;
                updateBulkDeleteVisibility('candidateTable');
            } else {
                alert("Failed to delete candidates.");
            }
        }

        async function bulkDeleteRepo() {
            const checked = document.querySelectorAll('.repo-checkbox:checked');
            if (checked.length === 0) return;

            if (!confirm(`Are you sure you want to delete ${checked.length} candidates from the repository?`)) return;

            const ids = Array.from(checked).map(cb => cb.value);

            const result = await persistenceApiCall('bulk_delete_candidates', { ids });

            if (result && result.success) {
                // Update local stats
                ids.forEach(id => {
                    const cand = state.candidates.find(c => String(c.id) === String(id));
                    if (cand) {
                        const job = state.jobs.find(j => String(j.id) === String(cand.jobId));
                        if (job) {
                            if (job.applicants > 0) job.applicants--;
                            if (cand.status === 'Shortlisted' && job.shortlisted > 0) job.shortlisted--;
                        }
                    }
                });

                // Remove from state
                state.candidates.forEach(c => {
                    if (idsSet.has(String(c.id))) c.deleted = true;
                });

                filterCandidatesRepo();
                updateStats();
                renderJobs();

                document.getElementById('selectAllRepo').checked = false;
                updateBulkDeleteVisibility('repoTable');
            } else {
                alert("Failed to delete candidates.");
            }
        }

        async function extractText(item) {
            const ext = item.name.split('.').pop().toLowerCase();
            const arrayBuffer = await item.blob.arrayBuffer();

            if (ext === 'pdf') {
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    fullText += content.items.map(s => s.str).join(' ') + '\n';
                }
                return fullText;
            } else if (ext === 'docx') {
                const result = await mammoth.extractRawText({ arrayBuffer });
                return result.value;
            } else {
                return await item.blob.text();
            }
        }

        async function callAIAnalysis(item, text) {
            const job = state.jobs.find(j => j.id === state.activeJobId);
            const ext = item.name.split('.').pop().toLowerCase();
            const isImage = ['jpg', 'png', 'jpeg'].includes(ext);

            const lambdaUrl = 'https://1sv1emfmnl.execute-api.ap-southeast-1.amazonaws.com/recruitmentAnalysis';

            const payload = {
                cv_text: isImage ? '' : text,
                image_base64: isImage ? await toBase64(item.blob) : '',
                image_ext: ext,
                job_desc: job.desc,
                job_kpi: job.kpi,
                evaluation_criteria: job.evaluationCriteria || [],
                api_key: state.apiKey // Pass API key to Lambda
            };

            const response = await fetch(lambdaUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Lambda processing failed');
            }

            return await response.json();
        }

        async function runAIReEvaluation(candidate) {
            const job = state.jobs.find(j => String(j.id) === String(candidate.jobId));
            if (!job) throw new Error("Job not found for candidate: " + candidate.id);

            const ext = candidate.fileName.split('.').pop().toLowerCase();
            const isImage = ['jpg', 'png', 'jpeg'].includes(ext);

            const lambdaUrl = 'https://1sv1emfmnl.execute-api.ap-southeast-1.amazonaws.com/recruitmentAnalysis';
            const payload = {
                cv_text: isImage ? '' : candidate.fullText,
                image_base64: isImage ? candidate.cvData : '',
                image_ext: ext,
                job_desc: job.desc,
                job_kpi: job.kpi,
                evaluation_criteria: job.evaluationCriteria || [],
                api_key: state.apiKey
            };

            const response = await fetch(lambdaUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'AI Analysis failed');
            }

            const analysis = await response.json();

            // Update candidate object
            candidate.aiScore = analysis.score;
            candidate.email = analysis.email || candidate.email;
            candidate.phone = analysis.phone || candidate.phone;
            candidate.breakdown = analysis.breakdown;
            candidate.summary = analysis.summary;
            candidate.reasons = analysis.reasons;
            candidate.isHopper = analysis.job_hopper;
            candidate.hopperDetails = analysis.hopper_details;

            // Save to DB
            await persistenceApiCall('upsert_candidate', candidate);

            // Update local state
            const localIdx = state.candidates.findIndex(c => String(c.id) === String(candidate.id));
            if (localIdx !== -1) {
                state.candidates[localIdx] = { ...state.candidates[localIdx], ...candidate };
            }

            return candidate;
        }

        async function reEvaluateCurrentCandidate(event) {
            if (!state.viewingCandidateId) return;
            const btn = event.currentTarget || event.target.closest('button');
            const originalBtnText = btn.innerHTML;

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AI Re-evaluating...';

                // Fetch full detail if needed
                const candidate = await persistenceApiCall('get_candidate_detail', { id: state.viewingCandidateId });
                if (!candidate) throw new Error("Candidate not found");

                await runAIReEvaluation(candidate);

                // Refresh modal content
                await viewCandidate(state.viewingCandidateId);
                alert("Candidate re-evaluated successfully!");
            } catch (err) {
                console.error("Re-evaluation error:", err);
                alert("Error during re-evaluation: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
            }
        }

        async function bulkReEvaluate(event, tableId) {
            const selector = tableId === 'candidateTable' ? '.cand-checkbox:checked' : '.repo-checkbox:checked';
            const selectedBoxes = document.querySelectorAll(selector);
            const ids = Array.from(selectedBoxes).map(cb => cb.value);

            if (ids.length === 0) return;
            if (!confirm(`Are you sure you want to re-evaluate ${ids.length} candidates using the latest job criteria? This may take some time.`)) return;

            const statusPanel = document.getElementById('statusPanel');
            const pgBar = document.getElementById('progressBar');
            const pgText = document.getElementById('progressText');
            const pgPercent = document.getElementById('progressPercent');

            statusPanel.style.display = 'block';
            pgText.innerText = 'Initializing bulk AI re-evaluation...';
            pgBar.style.width = '0%';
            pgPercent.innerText = '0%';

            let completed = 0;
            const errors = [];

            // Process all selected candidates in parallel
            const tasks = ids.map(async (id) => {
                const candidate = state.candidates.find(c => String(c.id) === String(id));
                if (candidate) {
                    candidate.isReEvaluating = true;
                    if (tableId === 'candidateTable') renderCandidates();
                    else filterCandidatesRepo();
                }

                try {
                    pgText.innerText = `Busy analyzing candidates...`;

                    // Fetch full detail for each
                    const fullCandidate = await persistenceApiCall('get_candidate_detail', { id: id }, true);
                    if (!fullCandidate) throw new Error("Candidate not found: " + id);

                    await runAIReEvaluation(fullCandidate);
                } catch (err) {
                    console.error(`Error re-evaluating candidate ${id}:`, err);
                    errors.push(id);
                } finally {
                    const finalCand = state.candidates.find(c => String(c.id) === String(id));
                    if (finalCand) finalCand.isReEvaluating = false;
                    completed++;
                    const progress = (completed / ids.length) * 100;
                    pgBar.style.width = `${progress}%`;
                    pgPercent.innerText = `${Math.round(progress)}%`;

                    if (tableId === 'candidateTable') renderCandidates();
                    else filterCandidatesRepo();
                }
            });

            await Promise.all(tasks);

            pgText.innerText = 'Bulk re-evaluation complete!';
            if (errors.length > 0) {
                pgText.innerText += ` (${errors.length} errors)`;
            }

            updateStats();
            renderJobs();

            setTimeout(() => {
                const sp = document.getElementById('statusPanel');
                if (sp) sp.style.display = 'none';
                if (errors.length > 0) {
                    alert(`Re-evaluation completed with ${errors.length} errors. Checks logs for details.`);
                } else {
                    alert(`Successfully re-evaluated ${ids.length} candidates.`);
                }
            }, 2000);
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function addCandidate(fileName, analysis, cvData, fullText) {
            const rawName = (analysis.name && !analysis.name.includes('HOLDER')) ? analysis.name : fileName.split('.')[0];
            const candidate = {
                jobId: state.activeJobId,
                name: rawName.toUpperCase(),
                fileName: fileName,
                date: new Date().toISOString(),
                aiScore: analysis.score,
                interviewerScore: 0,
                comments: [],
                isHopper: analysis.job_hopper,
                hopperDetails: analysis.hopper_details,
                status: 'No Action',
                pendingBy: '',
                breakdown: analysis.breakdown,
                summary: analysis.summary,
                reasons: analysis.reasons,
                cvData: cvData,
                fullText: fullText
            };

            const result = await persistenceApiCall('add_candidate', candidate);
            if (result && result.success) {
                state.candidates.push(result.candidate || candidate);

                // Update job applicant count
                const job = state.jobs.find(j => j.id.toString() === state.activeJobId.toString());
                if (job) {
                    job.applicants++;
                    if (candidate.status === 'Shortlisted') job.shortlisted++;
                    // We should also persist this increment back to the job object in DB
                    await persistenceApiCall('upsert_job', job);
                }

                renderCandidates();
                updateStats();
                renderJobs();
            } else {
                console.error("Failed to persist candidate to database.");
            }
        }

        function getAssigneeOptions(currentVal) {
            const users = state.users.filter(u => u.status === 'Active');
            return '<option value="">Unassigned</option>' +
                users.map(u => `<option value="${u.name}" ${currentVal === u.name ? 'selected' : ''}>${u.name}</option>`).join('');
        }

        function renderCandidates() {
            console.log("renderCandidates called. ActiveJobId:", state.activeJobId, "Candidates count:", state.candidates.length);
            // If we have an active job, filter by it. Otherwise show all accessible in state.
            let filtered = getAccessibleCandidates();
            if (state.activeJobId) {
                filtered = filtered.filter(c => String(c.jobId) == String(state.activeJobId));
            }
            console.log("Filtered candidates count:", filtered.length);
            const body = document.getElementById('candidateBody');

            // Sorting
            filtered.sort((a, b) => {
                let valA, valB;
                if (jobDetailsSort.field === 'name') { valA = a.name; valB = b.name; }
                else if (jobDetailsSort.field === 'date') { valA = new Date(ensureUTC(a.date)); valB = new Date(ensureUTC(b.date)); }
                else if (jobDetailsSort.field === 'score') { valA = a.aiScore; valB = b.aiScore; }
                else if (jobDetailsSort.field === 'interviewerScore') { valA = a.interviewerScore || 0; valB = b.interviewerScore || 0; }
                else if (jobDetailsSort.field === 'status') { valA = a.status; valB = b.status; }
                else if (jobDetailsSort.field === 'hopper') { valA = a.isHopper; valB = b.isHopper; }
                else if (jobDetailsSort.field === 'pendingBy') { valA = a.pendingBy; valB = b.pendingBy; }

                if (valA < valB) return jobDetailsSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return jobDetailsSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Pagination Slicing
            const start = (state.pagination.page - 1) * state.pagination.limit;
            const sliced = filtered.slice(start, start + state.pagination.limit);

            if (state.isFetchingCandidates && sliced.length === 0) {
                body.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: var(--text-dim);"><i class="fas fa-spinner fa-spin me-2"></i> Loading candidates...</td></tr>';
                return;
            }

            body.innerHTML = sliced.map(c => `
                <tr data-id="${c.id}" style="animation: fadeIn 0.3s ease forwards; ${c.isReEvaluating ? 'opacity: 0.7; pointer-events: none;' : ''}" onclick="toggleRowSelection(this)">
                    <td style="text-align: center;" onclick="event.stopPropagation()">
                        <input type="checkbox" class="cand-checkbox" value="${c.id}" onchange="updateBulkDeleteVisibility('candidateTable')">
                    </td>
                    <td>
                        <div style="font-weight: 600;">${c.name}</div>
                        <div style="font-size: 0.7rem; color: var(--text-dim);">${c.fileName}</div>
                    </td>
                    <td>${formatDate8(c.date)}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            ${c.isReEvaluating ?
                    `<span style="font-size: 0.8rem; color: var(--accent);"><i class="fas fa-spinner fa-spin me-1"></i> Analyzing...</span>` :
                    `
                                <span style="font-weight: 700; color: ${c.aiScore > 75 ? 'var(--secondary)' : 'white'}">${c.aiScore}</span>
                                <div style="width: 60px; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden;">
                                    <div style="width: ${c.aiScore}%; height: 100%; background: var(--gradient);"></div>
                                </div>
                                `
                }
                        </div>
                    </td>
                    <td><span style="font-weight: 700; color: var(--secondary);">${c.interviewerScore || 0}%</span></td>
                    <td>
                        <span class="badge ${c.isHopper ? 'badge-error' : 'badge-success'}">
                            ${c.isHopper ? 'Yes' : 'No'}
                        </span>
                    </td>
                    <td>
                        <select style="padding: 4px 8px; font-size: 0.75rem; background: var(--glass); color: white; border: 1px solid var(--border); border-radius: 8px; outline: none; width: 100%; max-width: 140px;" 
                            onclick="event.stopPropagation()" onchange="updateCandidatePending('${c.id}', this.value)">
                            ${getAssigneeOptions(c.pendingBy)}
                        </select>
                    </td>
                    <td>
                        <select style="padding: 4px 8px; font-size: 0.75rem; background: var(--glass); color: white; border: 1px solid var(--border); border-radius: 8px; outline: none;" 
                            onclick="event.stopPropagation()" onchange="updateCandidateStatus('${c.id}', this.value)">
                            ${getStatusOptions(c.status)}
                        </select>
                    </td>
                    <td>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" style="padding: 6px 12px; font-size: 0.75rem;" onclick="event.stopPropagation(); viewCandidate('${c.id}')">Details</button>
                            <button class="btn" style="padding: 6px 12px; font-size: 0.75rem; background: var(--glass); color: var(--secondary); border: 1px solid var(--secondary);" 
                                onclick="event.stopPropagation(); copyShareLink('${c.id}')">
                                <i class="fas fa-share-alt"></i>
                            </button>
                            <button class="btn" style="padding: 6px 12px; font-size: 0.75rem; background: var(--accent); color: white;" onclick="event.stopPropagation(); deleteCandidate('${c.id}')">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            renderTop5(filtered);
        }

        function sortJobCandidates(field) {
            if (jobDetailsSort.field === field) {
                jobDetailsSort.direction = jobDetailsSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                jobDetailsSort.field = field;
                jobDetailsSort.direction = 'asc';
            }
            renderCandidates();
        }

        function renderTop5(candidates) {
            const top5 = [...candidates].sort((a, b) => b.aiScore - a.aiScore).slice(0, 5);
            const container = document.getElementById('top5List');

            if (top5.length === 0) {
                container.innerHTML = '<p style="color: var(--text-dim); grid-column: span 5; text-align: center; padding: 20px;">No candidates processed yet.</p>';
                return;
            }

            container.innerHTML = top5.map((c, i) => `
                <div class="shortlist-card">
                    <span class="rank-number">RANK #${i + 1}</span>
                    <div style="font-weight: 700; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${c.name}</div>
                    <div style="font-size: 1.25rem; font-weight: 800; color: var(--secondary); margin-bottom: 8px;">${c.aiScore}%</div>
                    <button class="btn" style="background: var(--glass); color: var(--text-main); padding: 4px 8px; font-size: 0.7rem; width: 100%; border: 1px solid var(--border);" 
                        onmouseover="this.style.background='rgba(255,255,255,0.1)'" 
                        onmouseout="this.style.background='var(--glass)'"
                        onclick="viewCandidate('${c.id}')">View Analysis</button>
                </div>
            `).join('');
        }

        // Candidate Detail Modal
        let currentChart = null;

        async function viewCandidate(id) {
            console.log('Viewing candidate ID:', id);
            state.viewingCandidateId = id;

            document.getElementById('detailName').innerText = 'Loading...';
            document.getElementById('detailSummary').innerText = 'Loading summary...';
            document.getElementById('detailReasons').innerHTML = '<li>Loading...</li>';
            document.getElementById('cheatSheetBody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading interview guide...</td></tr>';
            document.getElementById('detailModal').style.display = 'flex';

            // Optimization: Fetch full details from the server to get excluded fields
            const c = await persistenceApiCall('get_candidate_detail', { id: id }, true);

            if (!c) {
                console.error('Candidate not found for ID:', id);
                alert("Failed to load candidate details. Please try again.");
                document.getElementById('detailModal').style.display = 'none';
                return;
            }

            // Sync with local state if needed (optional, but keeps state consistent)
            const localIdx = state.candidates.findIndex(cand => String(cand.id) === String(id));
            if (localIdx !== -1) {
                state.candidates[localIdx] = { ...state.candidates[localIdx], ...c };
            }

            document.getElementById('detailName').innerText = c.name;
            document.getElementById('detailEmail').innerText = c.email || 'Click to add email';
            document.getElementById('detailEmail').style.color = c.email ? 'var(--text-main)' : 'var(--text-dim)';
            document.getElementById('detailScore').innerText = `AI Score: ${c.aiScore}/100`;
            document.getElementById('detailInterviewerScore').value = c.interviewerScore || 0;
            document.getElementById('detailSummary').innerText = c.summary;


            // Populating Assignee options in Modal
            const assigneeSelect = document.getElementById('modalAssignee');
            if (assigneeSelect) {
                assigneeSelect.innerHTML = getAssigneeOptions(c.pendingBy);
            }

            renderComments(c);

            editingCandId = c.id;

            document.getElementById('detailReasons').innerHTML = (c.reasons || []).map(r => `<li>${r}</li>`).join('');

            // Render Interview Guide
            const job = state.jobs.find(j => String(j.id) === String(c.jobId));

            // Initialization for new candidates or migration logic
            if (!c.jobRatings) c.jobRatings = {};
            if (!c.customInterviewGuide) {
                // Migrate old interviewGuide if it exists, otherwise generate fallback
                if (c.interviewGuide && c.interviewGuide.length > 0) {
                    c.customInterviewGuide = c.interviewGuide;
                    c.interviewGuide = []; // Clear old field
                } else if (!job || !job.interviewQuestions || job.interviewQuestions.length === 0) {
                    c.customInterviewGuide = generateSuggestedQuestions(c.reasons);
                } else {
                    c.customInterviewGuide = [];
                }

                // Persist initialization
                persistenceApiCall('upsert_candidate', {
                    id: c.id,
                    jobRatings: c.jobRatings,
                    customInterviewGuide: c.customInterviewGuide
                });
            }

            document.getElementById('cheatSheetBody').innerHTML = renderCheatSheet(job, c);
            initCheatSheetSortable(c);

            const hopperBox = document.getElementById('hopperSection');
            if (c.isHopper) {
                hopperBox.style.display = 'block';
                document.getElementById('hopperDetail').innerText = c.hopperDetails || 'AI detected frequent job changes.';
            } else {
                hopperBox.style.display = 'none';
            }

            // Chart
            const canvas = document.getElementById('scoreChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (currentChart) currentChart.destroy();

            // Dynamic Chart based on AI breakdown keys
            const labels = Object.keys(c.breakdown || {});
            const data = Object.values(c.breakdown || {});

            // Pool of colors to cycle through
            const colors = ['#6366f1', '#06b6d4', '#818cf8', '#22c55e', '#a855f7', '#f59e0b', '#ec4899'];
            const bgColors = labels.map((_, i) => colors[i % colors.length]);

            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.length > 0 ? labels : ['Experience', 'Skills', 'Responsibilities', 'KPI Fit'],
                    datasets: [{
                        label: 'Match Score',
                        data: data.length > 0 ? data : [0, 0, 0, 0],
                        backgroundColor: bgColors,
                        borderRadius: 8,
                        barThickness: labels.length > 5 ? 12 : 20
                    }]
                },
                options: {
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            min: 0,
                            max: 100,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            border: { display: false },
                            ticks: { color: '#94a3b8', font: { size: 10 } }
                        },
                        y: {
                            grid: { display: false },
                            ticks: {
                                color: '#e2e8f0',
                                font: { weight: '600', size: 11 },
                                autoSkip: false
                            }
                        }
                    },
                    animation: { duration: 1000 }
                }
            });
        }

        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        async function updateCandidateName(newName) {
            if (!editingCandId || !newName) return;
            newName = newName.trim().toUpperCase();

            const cand = state.candidates.find(c => String(c.id) === String(editingCandId));
            if (!cand || cand.name === newName) return;

            cand.name = newName;
            const result = await persistenceApiCall('upsert_candidate', { id: editingCandId, name: newName });

            if (result && result.success) {
                showToast("Candidate name updated successfully!");
                renderCandidates();
                filterCandidatesRepo();
            } else {
                showToast("Failed to update candidate name", "error");
                renderCandidates(); // Reset UI
            }
        }

        async function updateCandidateEmail(newEmail) {
            if (!editingCandId) return;
            const emailValue = (newEmail === 'Click to add email') ? '' : newEmail.trim();

            const cand = state.candidates.find(c => String(c.id) === String(editingCandId));
            if (!cand || cand.email === emailValue) return;

            cand.email = emailValue;
            const result = await persistenceApiCall('upsert_candidate', { id: editingCandId, email: emailValue });

            if (result && result.success) {
                showToast("Email updated successfully!");
                document.getElementById('detailEmail').style.color = emailValue ? 'var(--text-main)' : 'var(--text-dim)';
                renderCandidates();
                filterCandidatesRepo();
            } else {
                showToast("Failed to update email", "error");
            }
        }

        function sendCandidateEmail() {
            const c = state.candidates.find(cand => String(cand.id) === String(editingCandId));
            if (!c || !c.email) {
                alert("No email address found for this candidate. Please add one first.");
                return;
            }
            const job = state.jobs.find(j => String(j.id) === String(c.jobId));
            const subject = encodeURIComponent(`Application Update: ${job ? job.title : 'Position'} - ${c.name}`);
            const body = encodeURIComponent(`Hi ${c.name},\n\nI hope this email finds you well.\n\n[Add your message here regarding their application for ${job ? job.title : 'the position'}]\n\nBest regards,\n${state.currentUser}`);

            window.location.href = `mailto:${c.email}?subject=${subject}&body=${body}`;
        }

        function rejectCurrentCandidate() {
            if (editingCandId && confirm('Are you sure you want to reject this candidate?')) {
                updateCandidateStatus(editingCandId, 'Rejected');
                closeDetailModal();
                renderCandidates();
                filterCandidatesRepo();
            }
        }

        function viewCV() {
            const cand = state.candidates.find(c => c.id.toString() === editingCandId.toString());
            if (!cand || !cand.cvData) return alert('No file data available to view.');

            const ext = cand.fileName.split('.').pop().toLowerCase();
            const viewerModal = document.getElementById('cvViewerModal');
            const viewerContent = document.getElementById('cvViewerContent');
            const viewerTitle = document.getElementById('cvViewerTitle');

            viewerTitle.innerText = `Viewing: ${cand.fileName}`;
            viewerModal.style.display = 'flex';
            viewerContent.innerHTML = ''; // Clear previous content

            // Use Blob for better PDF rendering/stability
            try {
                const byteCharacters = atob(cand.cvData);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);

                let mimeType = 'application/octet-stream';
                if (ext === 'pdf') mimeType = 'application/pdf';
                else if (['jpg', 'jpeg', 'png'].includes(ext)) mimeType = `image/${ext === 'jpg' ? 'jpeg' : ext}`;

                const blob = new Blob([byteArray], { type: mimeType });
                const url = URL.createObjectURL(blob);

                // Store URL for cleanup
                viewerModal.dataset.blobUrl = url;

                if (ext === 'pdf' || ['jpg', 'jpeg', 'png'].includes(ext)) {
                    if (ext === 'pdf') {
                        const iframe = document.createElement('iframe');
                        iframe.src = url;
                        viewerContent.appendChild(iframe);
                    } else {
                        const img = document.createElement('img');
                        img.src = url;
                        viewerContent.appendChild(img);
                    }
                } else {
                    // Fallback for docx or other formats
                    viewerContent.innerHTML = `
                        <div style="height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--bg-dark); padding: 20px; text-align: center;">
                            <i class="fas fa-file-word" style="font-size: 4rem; color: #2b579a; margin-bottom: 20px;"></i>
                            <h3>Viewing not supported for .${ext} files</h3>
                            <p style="margin-top: 10px;">Please download the file to view it.</p>
                            <button class="btn btn-primary" style="margin-top: 20px;" onclick="downloadOriginalCV()">
                                <i class="fas fa-download"></i> Download ${cand.fileName}
                            </button>
                        </div>
                    `;
                }
            } catch (e) {
                console.error("Error creating viewer blob:", e);
                alert("Error processing file data for viewing.");
            }
        }

        function closeCVViewer() {
            const viewerModal = document.getElementById('cvViewerModal');
            const url = viewerModal.dataset.blobUrl;
            if (url) {
                URL.revokeObjectURL(url);
                delete viewerModal.dataset.blobUrl;
            }
            viewerModal.style.display = 'none';
            document.getElementById('cvViewerContent').innerHTML = '';
        }

        function downloadOriginalCV() {
            const cand = state.candidates.find(c => c.id.toString() === editingCandId.toString());
            if (!cand || !cand.cvData) return alert('No file data available for download.');

            const ext = cand.fileName.split('.').pop().toLowerCase();
            let mimeType = 'application/octet-stream';
            if (ext === 'pdf') mimeType = 'application/pdf';
            else if (['jpg', 'jpeg', 'png'].includes(ext)) mimeType = `image/${ext === 'jpg' ? 'jpeg' : ext}`;
            else if (ext === 'docx') mimeType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';

            const link = document.createElement('a');
            link.href = `data:${mimeType};base64,${cand.cvData}`;
            link.download = cand.fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Interview Evaluation Functions

        async function addQuickComment(text) {
            const input = document.getElementById('newCommentInput');
            input.value = text;
            await submitComment();
        }

        function generateSuggestedQuestions(reasons) {
            const defaultRows = [
                {
                    metric: "Role Interest",
                    q: "What specifically interests you about this role and our company's mission?",
                    good: "Demonstrates research into our specific industry position and technical challenges.",
                    bad: "Generic answer; focus only on salary/benefits.",
                    rating: 0
                },
                {
                    metric: "Technical Depth",
                    q: "Tell me about the most complex technical challenge you've solved recently.",
                    good: "Explains the 'why', specific techs, and measurable outcomes.",
                    bad: "Vague; unable to explain technical details.",
                    rating: 0
                },
                {
                    metric: "Stakeholder Mgmt",
                    q: "How do you handle disagreements with stakeholders when you're confident in your solution?",
                    good: "Objective data, active listening, collaborative middle ground.",
                    bad: "Combative or passive-aggressive.",
                    rating: 0
                },
                {
                    metric: "Growth Mindset",
                    q: "Where do you see your technical skills evolving in the next 2-3 years?",
                    good: "Identifies emerging technologies or leadership goals.",
                    bad: "No plan for self-improvement.",
                    rating: 0
                }
            ];

            const analysisRows = (reasons || []).map(r => {
                const lowR = r.toLowerCase();
                let metric = "Skill Match";
                let q = `I noticed your strength in "${r}". Can you provide a concrete example?`;
                let good = "Quantitative results and clear methodology.";
                let bad = "Qualitative claims without evidence.";

                if (lowR.includes('experience')) {
                    metric = "Experience";
                    const skill = r.replace(/strong |experience with |skills in /gi, '').trim();
                    q = `Walk me through a complex scenario where you leveraged ${skill}.`;
                    good = "Deep architectural understanding and practical problem-solving.";
                    bad = "Surface level use; lacks depth.";
                } else if (lowR.includes('skill')) {
                    metric = "Technical Skill";
                    const skill = r.replace(/strong |skills in /gi, '').trim();
                    q = `How do you stay updated with changes in ${skill}?`;
                    good = "Active learning; names specific resources.";
                    bad = "Outdated methods; lack of curiosity.";
                } else if (lowR.includes('leader') || lowR.includes('manage')) {
                    metric = "Leadership";
                    q = "Describe a time you managed conflict within a technical team.";
                    good = "Balanced approach; objective resolution.";
                    bad: "Blames others; avoids accountability.";
                }

                return { metric, q, good, bad, rating: 0 };
            });

            // Combine and ensure at least 10
            let finalRows = [...analysisRows];
            defaultRows.forEach(row => {
                if (finalRows.length < 12) finalRows.push(row);
            });

            if (finalRows.length < 10) {
                const extra = [
                    { metric: "Accountability", q: "Tell me about a time you failed. What did you learn?", good: "Accountability and clear learning.", bad: "Blaming others.", rating: 0 },
                    { metric: "Prioritization", q: "How do you prioritize tasks under tight deadlines?", good: "Using frameworks, clear communication.", bad: "Panic or low-impact focus.", rating: 0 },
                    { metric: "Coachability", q: "What's the best piece of feedback you've ever received?", good: "Ability to internalize advice.", bad: "Takes feedback personally.", rating: 0 }
                ];
                extra.forEach(row => {
                    if (finalRows.length < 12) finalRows.push(row);
                });
            }

            return finalRows;
        }

        function renderCheatSheet(job, cand) {
            let html = '';

            // 1. Render Job-Level Questions (ReadOnly text)
            if (job && job.interviewQuestions && job.interviewQuestions.length > 0) {
                html += `
                    <tr style="background: rgba(99, 102, 241, 0.15);">
                        <td colspan="6" style="padding: 10px 24px; font-weight: 700; color: var(--primary-light); font-size: 0.8rem; letter-spacing: 0.05em;">
                            <i class="fas fa-briefcase me-2"></i> JOB STANDARD QUESTIONS (Read-Only Templates)
                        </td>
                    </tr>
                `;
                // Determine display order: candidate override > job default
                let orderedQuestions = job.interviewQuestions;
                if (cand.jobQuestionOrder && Array.isArray(cand.jobQuestionOrder) && cand.jobQuestionOrder.length > 0) {
                    // Reorder based on candidate's saved order (by question ID)
                    const ordered = [];
                    cand.jobQuestionOrder.forEach(qId => {
                        const found = job.interviewQuestions.find(q => String(q.id) === String(qId));
                        if (found) ordered.push(found);
                    });
                    // Append any new questions not in the saved order
                    job.interviewQuestions.forEach(q => {
                        if (!ordered.find(o => String(o.id) === String(q.id))) ordered.push(q);
                    });
                    orderedQuestions = ordered;
                }

                html += orderedQuestions.map((row, jIdx) => {
                    const rating = (cand.jobRatings && cand.jobRatings[row.id]) || 0;
                    return `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.03); opacity: 0.9;" data-type="job" data-id="${jIdx}" data-qid="${row.id}">
                        <td style="padding: 12px; vertical-align: top; text-align: center; color: var(--primary-light); cursor: grab;" class="drag-handle">
                            <i class="fas fa-grip-vertical"></i>
                        </td>
                        <td style="padding: 12px 24px; vertical-align: top;">
                            <div style="color: var(--text-main); font-weight: 600; padding: 2px 4px;">${row.metric}</div>
                        </td>
                        <td style="padding: 12px; vertical-align: top;">
                            <div style="color: var(--text-main); padding: 2px 4px;">${row.q}</div>
                        </td>
                        <td style="padding: 12px; vertical-align: top;">
                            <div style="color: var(--text-dim); font-size: 0.8rem; padding: 2px 4px;">${row.good}</div>
                        </td>
                        <td style="padding: 12px; vertical-align: top;">
                            <div style="color: var(--text-dim); font-size: 0.8rem; padding: 2px 4px;">${row.bad}</div>
                        </td>
                        <td style="padding: 12px; vertical-align: top; text-align: center;">
                            <div class="rating-stars" style="justify-content: center;">
                                ${[1, 2, 3, 4, 5].map(v => `
                                    <span class="star ${v <= rating ? 'active' : ''}" 
                                          onclick="setJobQuestionRating('${row.id}', ${v})">‚òÖ</span>
                                `).join('')}
                            </div>
                        </td>
                        <td></td>
                    </tr>
                    `;
                }).join('');
            }

            // 2. Render Custom Candidate Questions (Fully Editable)
            html += `
                <tr style="background: rgba(6, 182, 212, 0.15);">
                    <td colspan="6" style="padding: 10px 24px; font-weight: 700; color: var(--secondary); font-size: 0.8rem; letter-spacing: 0.05em;">
                        <i class="fas fa-user-edit me-2"></i> CUSTOM CANDIDATE QUESTIONS (Editable)
                    </td>
                </tr>
            `;

            if (!cand.customInterviewGuide || cand.customInterviewGuide.length === 0) {
                html += `<tr><td colspan="6" style="padding: 20px 24px; text-align: center; color: var(--text-dim);">No custom questions.</td></tr>`;
            } else {
                html += cand.customInterviewGuide.map((row, idx) => `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.03);" data-type="custom" data-id="${idx}">
                        <td style="padding: 12px; vertical-align: top; text-align: center; color: var(--primary-light); cursor: grab;" class="drag-handle">
                            <i class="fas fa-grip-vertical"></i>
                        </td>
                        <td style="padding: 12px 24px; vertical-align: top;">
                            <div contenteditable="true" onblur="updateCustomGuideContent(${idx}, 'metric', this.innerText)"
                                 style="color: var(--text-main); font-weight: 600; outline: none; border: 1px solid transparent; padding: 2px 4px; border-radius: 4px;"
                                 onmouseover="this.style.borderColor='rgba(99, 102, 241, 0.3)'" onmouseout="this.style.borderColor='transparent'">
                                 ${row.metric}
                            </div>
                        </td>
                        <td style="padding: 12px; vertical-align: top;">
                            <div contenteditable="true" onblur="updateCustomGuideContent(${idx}, 'q', this.innerText)"
                                 style="color: var(--text-main); outline: none; border: 1px solid transparent; padding: 2px 4px; border-radius: 4px;"
                                 onmouseover="this.style.borderColor='rgba(99, 102, 241, 0.3)'" onmouseout="this.style.borderColor='transparent'">
                                 ${row.q}
                            </div>
                        </td>
                        <td style="padding: 12px; vertical-align: top;">
                            <div contenteditable="true" onblur="updateCustomGuideContent(${idx}, 'good', this.innerText)"
                                 style="color: var(--text-dim); font-size: 0.8rem; outline: none; border: 1px solid transparent; padding: 2px 4px; border-radius: 4px;"
                                 onmouseover="this.style.borderColor='rgba(99, 102, 241, 0.3)'" onmouseout="this.style.borderColor='transparent'">
                                 ${row.good}
                            </div>
                        </td>
                        <td style="padding: 12px; vertical-align: top;">
                            <div contenteditable="true" onblur="updateCustomGuideContent(${idx}, 'bad', this.innerText)"
                                 style="color: var(--text-dim); font-size: 0.8rem; outline: none; border: 1px solid transparent; padding: 2px 4px; border-radius: 4px;"
                                 onmouseover="this.style.borderColor='rgba(99, 102, 241, 0.3)'" onmouseout="this.style.borderColor='transparent'">
                                 ${row.bad}
                            </div>
                        </td>
                        <td style="padding: 12px; vertical-align: top; text-align: center;">
                            <div class="rating-stars" style="justify-content: center;">
                                ${[1, 2, 3, 4, 5].map(v => `
                                    <span class="star ${v <= (row.rating || 0) ? 'active' : ''}" 
                                          onclick="setCustomQuestionRating(${idx}, ${v})">‚òÖ</span>
                                `).join('')}
                            </div>
                        </td>
                        <td style="padding: 12px; vertical-align: top; text-align: center;">
                            <button class="btn" style="background: var(--accent); color: white; padding: 6px 12px; font-size: 0.9rem;" onclick="deleteCustomQuestion(${idx})">
                                <i class="fas fa-ban"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            return html;
        }

        let cheatSheetSortable = null;
        function initCheatSheetSortable(cand) {
            const el = document.getElementById('cheatSheetBody');
            if (!el) return;

            if (cheatSheetSortable) {
                cheatSheetSortable.destroy();
            }

            cheatSheetSortable = new Sortable(el, {
                handle: '.drag-handle',
                animation: 150,
                filter: 'tr[style*="background: rgba"]', // Exclude section header rows
                onEnd: async function () {
                    const job = state.jobs.find(j => String(j.id) === String(cand.jobId));

                    // Rebuild job questions order
                    const jobRows = Array.from(el.querySelectorAll('tr[data-type="job"]'));
                    if (job && job.interviewQuestions && jobRows.length > 0) {
                        // Get the new order by question ID
                        const newJobQuestionOrder = jobRows.map(row => row.getAttribute('data-qid'));

                        // Update the job's default order
                        const newJobQuestions = newJobQuestionOrder.map(qid =>
                            job.interviewQuestions.find(q => String(q.id) === String(qid))
                        ).filter(Boolean);
                        job.interviewQuestions = newJobQuestions;

                        // Save candidate-level override
                        cand.jobQuestionOrder = newJobQuestionOrder;

                        // Persist both
                        await persistenceApiCall('upsert_job', {
                            id: job.id,
                            interviewQuestions: job.interviewQuestions
                        });
                        await persistenceApiCall('upsert_candidate', {
                            id: cand.id,
                            jobQuestionOrder: cand.jobQuestionOrder
                        });
                    }

                    // Rebuild custom questions order
                    const customRows = Array.from(el.querySelectorAll('tr[data-type="custom"]'));
                    if (cand.customInterviewGuide && customRows.length > 0) {
                        const newGuide = customRows.map(row => {
                            const origIdx = parseInt(row.getAttribute('data-id'));
                            return cand.customInterviewGuide[origIdx];
                        });
                        cand.customInterviewGuide = newGuide;

                        // Persist custom question order
                        await persistenceApiCall('upsert_candidate', {
                            id: cand.id,
                            customInterviewGuide: cand.customInterviewGuide
                        });
                    }

                    // Re-render to refresh data-id attributes
                    el.innerHTML = renderCheatSheet(job, cand);
                    initCheatSheetSortable(cand);
                }
            });
        }

        async function addGuideQuestion() {
            if (!editingCandId) return;
            const cand = state.candidates.find(c => String(c.id) === String(editingCandId));
            if (!cand) return;
            const job = state.jobs.find(j => String(j.id) === String(cand.jobId));

            if (!cand.customInterviewGuide) cand.customInterviewGuide = [];
            cand.customInterviewGuide.push({
                metric: "New Metric",
                q: "New Question",
                good: "Good answer indicators",
                bad: "Red flag indicators",
                rating: 0
            });

            document.getElementById('cheatSheetBody').innerHTML = renderCheatSheet(job, cand);
            await persistenceApiCall('upsert_candidate', { id: cand.id, customInterviewGuide: cand.customInterviewGuide });
        }

        async function deleteCustomQuestion(idx) {
            if (!editingCandId || !confirm('Delete this custom question?')) return;
            const cand = state.candidates.find(c => String(c.id) === String(editingCandId));
            const job = state.jobs.find(j => String(j.id) === String(cand.jobId));

            cand.customInterviewGuide.splice(idx, 1);
            document.getElementById('cheatSheetBody').innerHTML = renderCheatSheet(job, cand);
            await persistenceApiCall('upsert_candidate', { id: cand.id, customInterviewGuide: cand.customInterviewGuide });
        }

        function calculateTallyScore(cand, job) {
            let totalStars = 0;
            let totalMax = 0;

            if (job && job.interviewQuestions) {
                job.interviewQuestions.forEach(q => {
                    totalStars += (cand.jobRatings && cand.jobRatings[q.id]) || 0;
                    totalMax += 5;
                });
            }
            if (cand.customInterviewGuide) {
                cand.customInterviewGuide.forEach(q => {
                    totalStars += (q.rating || 0);
                    totalMax += 5;
                });
            }
            return totalMax > 0 ? Math.round((totalStars / totalMax) * 100) : 0;
        }

        async function updateCustomGuideContent(idx, field, value) {
            const cand = state.candidates.find(c => String(c.id) === String(editingCandId));
            if (!cand || !cand.customInterviewGuide) return;
            if (cand.customInterviewGuide[idx][field] === value) return;

            cand.customInterviewGuide[idx][field] = value;
            await persistenceApiCall('upsert_candidate', { id: cand.id, customInterviewGuide: cand.customInterviewGuide });
        }

        async function setCustomQuestionRating(idx, value) {
            const cand = state.candidates.find(c => String(c.id) === String(editingCandId));
            const job = state.jobs.find(j => String(j.id) === String(cand.jobId));
            if (!cand || !cand.customInterviewGuide) return;

            cand.customInterviewGuide[idx].rating = value;

            const newScore = calculateTallyScore(cand, job);
            cand.interviewerScore = newScore;
            const scoreDisplay = document.getElementById('detailInterviewerScore');
            if (scoreDisplay) scoreDisplay.value = newScore;

            document.getElementById('cheatSheetBody').innerHTML = renderCheatSheet(job, cand);
            await persistenceApiCall('upsert_candidate', {
                id: cand.id,
                customInterviewGuide: cand.customInterviewGuide,
                interviewerScore: newScore
            });
            renderCandidates();
            filterCandidatesRepo();
        }

        async function setJobQuestionRating(qId, value) {
            const cand = state.candidates.find(c => String(c.id) === String(editingCandId));
            const job = state.jobs.find(j => String(j.id) === String(cand.jobId));
            if (!cand) return;

            if (!cand.jobRatings) cand.jobRatings = {};
            cand.jobRatings[qId] = value;

            const newScore = calculateTallyScore(cand, job);
            cand.interviewerScore = newScore;
            const scoreDisplay = document.getElementById('detailInterviewerScore');
            if (scoreDisplay) scoreDisplay.value = newScore;

            document.getElementById('cheatSheetBody').innerHTML = renderCheatSheet(job, cand);
            await persistenceApiCall('upsert_candidate', {
                id: cand.id,
                jobRatings: cand.jobRatings,
                interviewerScore: newScore
            });
            renderCandidates();
            filterCandidatesRepo();
        }

        async function updateInterviewerScore(candId, score) {
            const cand = state.candidates.find(c => c.id.toString() === candId.toString());
            if (cand) {
                cand.interviewerScore = parseInt(score) || 0;
                await persistenceApiCall('upsert_candidate', { id: candId, interviewerScore: cand.interviewerScore });
                renderCandidates();
                filterCandidatesRepo();
            }
        }

        function updateInterviewerScoreFromModal(score) {
            if (editingCandId) {
                updateInterviewerScore(editingCandId, score);
            }
        }

        let editingCandId = null;

        function renderComments(c) {
            const container = document.getElementById('commentsList');
            if (!c.comments || c.comments.length === 0) {
                container.innerHTML = '<p style="color: var(--text-dim); font-style: italic; font-size: 0.875rem;">No comments yet.</p>';
                return;
            }
            container.innerHTML = c.comments.map(com => `
                <div style="padding: 12px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <span style="font-weight: 700; font-size: 0.8rem; color: var(--primary-light);">${com.user}</span>
                        <span style="font-size: 0.7rem; color: var(--text-dim);">${com.date}</span>
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-main);">${com.text}</div>
                </div>
            `).join('');
        }

        async function submitComment() {
            const input = document.getElementById('newCommentInput');
            const text = input.value.trim();
            if (!text || !editingCandId) return;

            const cand = state.candidates.find(c => c.id.toString() === editingCandId.toString());
            if (cand) {
                if (!cand.comments) cand.comments = [];
                const newComment = {
                    user: state.currentUser,
                    text: text,
                    date: formatDateTime8(new Date())
                };
                cand.comments.push(newComment);
                input.value = '';
                renderComments(cand);

                // Persist comments
                await persistenceApiCall('upsert_candidate', {
                    id: cand.id,
                    comments: cand.comments
                });
            }
        }

        async function showAuditLogs() {
            hideAllSections();
            setActiveNavItem('nav-audit');
            document.getElementById('activityLogSection').style.display = 'block';

            const logs = await persistenceApiCall('get_audit_logs');
            const body = document.getElementById('auditLogBody');

            if (logs && Array.isArray(logs) && logs.length > 0) {
                body.innerHTML = logs.map(l => {
                    let undoBtn = '';
                    if (l.action === 'soft_delete') {
                        if (l.targetType === 'job') {
                            undoBtn = `<button class="btn" style="padding: 4px 8px; font-size: 0.7rem; background: var(--primary); color: white;" onclick="restoreJob('${l.targetId}')">Restore</button>`;
                        } else if (l.targetType === 'candidate') {
                            undoBtn = `<button class="btn" style="padding: 4px 8px; font-size: 0.7rem; background: var(--primary); color: white;" onclick="restoreCandidate('${l.targetId}')">Restore</button>`;
                        }
                    } else if (l.action === 'bulk_soft_delete') {
                        undoBtn = `<button class="btn" style="padding: 4px 8px; font-size: 0.7rem; background: var(--primary); color: white;" onclick="restoreBulkCandidates('${l.targetId}')">Restore</button>`;
                    }

                    return `
                        <tr>
                            <td style="color: var(--text-dim); font-size: 0.8rem;">${formatDateTime8(l.timestamp)}</td>
                            <td style="font-weight: 600;">${l.user}</td>
                            <td><span class="badge" style="background: var(--glass);">${l.action}</span></td>
                            <td>${l.details}</td>
                            <td>${undoBtn}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                body.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-dim);">No logs found.</td></tr>';
            }
        }
    </script>
</body>

</html>