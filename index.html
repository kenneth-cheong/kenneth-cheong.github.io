<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digimetrics</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon"
        href="https://mediaonemarketing.com.sg/wp-content/uploads/2023/11/cropped-MediaOne-M-favicon-logo-32x32.png"
        sizes="32x32">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Google Sign-In variables (global scope)
        let googleUser = null; // Store the Google user object
        let codeReceiverURI = 'https://ts9k398yn8.execute-api.ap-southeast-1.amazonaws.com/googleLogin'; // Update with your actual URI

        // Function called after successful Google Sign-In
        function handleCredentialResponse(response) {
            fetch(codeReceiverURI, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ credential: response.credential })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.body.success) {
                        googleUser = data.body.user;
                        localStorage.setItem('googleUser', JSON.stringify(googleUser));
                        updateUI(true); // User logged in
                        console.log(data.body);
                        document.getElementById('logoutLink').querySelector('span') = "Logout " + data.body.user.name;
                    } else {
                        console.error("Backend verification failed:", data.message);
                        document.getElementById('loginError').textContent = data.message || "Google login failed.";
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loginError').textContent = "An error occurred.";
                });
        }

        function checkGoogleLogin() {
            const storedUser = localStorage.getItem('googleUser');
            if (storedUser) {
                googleUser = JSON.parse(storedUser);
                updateUI(true); // Already logged in via Google
                return true; // Indicate Google login success
            }

            google.accounts.id.initialize({
                client_id: '365369983219-12iqvk3v35kf03p3ts1gikglddtkofvq.apps.googleusercontent.com',
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.getElementById('googleSignInButton'),
                { theme: "outline", size: "large" }
            );
            return false; // Google login not yet completed
        }

        // Function to update UI based on login status (modified)
        function updateUI(isLoggedIn) {
            document.getElementById('loginForm').style.display = isLoggedIn ? 'none' : 'flex';
            document.getElementById('main-content').style.display = isLoggedIn ? 'block' : 'none';
            document.getElementById('navbar').style.display = isLoggedIn ? 'block' : 'none';

            //Optionally: Display user info after Google login
            if (isLoggedIn && googleUser) {
                // Example: Show username after successful login
                const welcomeMessage = document.createElement('p');
                welcomeMessage.textContent = `Welcome, ${googleUser.name}!`;
                document.getElementById('main-content').prepend(welcomeMessage);  // or wherever you want to display it.
            }
        }

        window.onload = async () => {
            const isLoggedIn = checkGoogleLogin();
            if (!isLoggedIn) {
                // Show the regular login form only if neither Google nor cookie login are active.
                document.getElementById('loginForm').style.display = 'flex';
            }

            try {
                const response = await fetch('https://nud0xqa1h4.execute-api.ap-southeast-1.amazonaws.com/createThreadId', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                const threadElem = document.getElementById('threadId');
                if (threadElem) threadElem.innerText = data;
                console.log(data);
                processURL();
                initializeJourneyCollapsibles();
                //loadFromLocalStorage();

            } catch (error) {
                console.error('Error fetching or parsing thread ID:', error);
                const threadElem = document.getElementById('threadId');
                if (threadElem) threadElem.innerText = "Error retrieving thread ID";
            }

        };

    </script>



    <style>
        #loginForm {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }

        #loginForm input {
            margin: 10px 0;
            padding: 8px;
            min-width: 40%;
        }

        label {
            font-weight: normal;
        }

        #loginForm button {
            background-color: #004c9d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        #navbar a.active-menu {
            background-color: #0056b3;
            font-weight: bold;
            border-radius: 10px;
        }

        #analysisTable td:first-child {
            left: 0;
            position: sticky;
            background-color: #4c82bc;
            color: white;
            border: 1px solid white;
        }

        #analysisTable th:first-child {
            left: 0;
            background-color: #004c9d;
            position: sticky;
            color: white;
            border: 1px solid white;
            z-index: 1;
        }

        thead th,
        th {
            background-color: #004c9d;
            color: white;
            white-space: nowrap;
            padding: 10px 15px;
        }

        thead th {
            position: sticky;
            top: 0;
            z-index: 1;
        }


        #main-content {
            display: none;
        }

        #schema-output {
            white-space: pre-wrap;
            border: 1px solid #ccc;
            padding: 10px;
            font-family: monospace;
        }

        #navbar a i {
            margin-right: 2%;
        }

        #navbar {
            width: 15%;
            background-color: #004c9d;
            color: white;
            padding: 10px;
            position: fixed;
            height: 100%;
            overflow-y: auto;
            border-radius: 10px;
            transition: width 0.3s;
            z-index: 1000;
            /* Ensure navbar stays on top of sticky table elements */
        }

        #navbar img {
            display: block;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 10%;
            margin-top: 10%;
        }

        #navbar a {
            display: block;
            padding: 5px 2px;
            color: white;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        #navbar a:hover {
            background-color: #0056b3;
            border-radius: 10px;
        }

        #main-content {
            flex: 1;
            padding: 10px;
        }

        body,
        pre {
            font-family: 'Roboto', sans-serif;
            margin: 10px;
            background-color: #fbf7f5;
            color: #333;
            text-wrap: wrap;
            font-size: 0.9em;
        }

        input,
        select,
        button,
        textarea {
            padding: 5px 8px;
            margin: 5px;
            border-radius: 8px;
            border: 1px solid #c8c8c8;
            font-family: inherit;
        }

        input {
            width: 90%;
        }

        button {
            margin: 5px;
            transition: background-color 0.3s, transform 0.1s;
            background-color: #c8c9ca;
        }

        button:hover {
            background-color: #004c9d;
            transform: translateY(-2px);
            cursor: pointer;
            color: white;
        }

        .input-short {
            min-width: 30%;
        }

        textarea {
            min-width: 90%;
            min-height: 50px;
            max-width: 90%;
        }

        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            table-layout: auto;
            word-break: break-word;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .wide-table {
            min-width: 3000px;
            /* Force expansion for tables with many columns */
        }

        .loading-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .loading-modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 30%;
            text-align: center;
        }

        /* Loader animation */
        .loader {
            border: 16px solid #f3f3f3;
            border-top: 16px solid #3498db;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }

        .highlight {
            background-color: yellow;
            font-weight: bold;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #crawlerReport {
            max-height: 600px;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 15px;
        }

        #crawlerReport table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        #crawlerReport thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #004c9d;
            color: white;
            padding: 10px;
            white-space: nowrap;
            border: 1px solid #ddd;
        }

        /* Sticky first and second columns */
        #crawlerReport th:nth-child(1),
        #crawlerReport td:nth-child(1) {
            position: sticky;
            left: 0;
            z-index: 5;
            background-color: #f8f9fa;
            border-right: 2px solid #ddd;
        }

        #crawlerReport th:nth-child(2),
        #crawlerReport td:nth-child(2) {
            position: sticky;
            left: 50px;
            /* Adjusted based on 'No.' column width */
            z-index: 5;
            background-color: #f8f9fa;
            border-right: 2px solid #ddd;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #crawlerReport th:nth-child(1),
        #crawlerReport th:nth-child(2) {
            z-index: 20;
            /* High enough to stay above sticky column content */
            background-color: #004c9d;
        }

        #crawlerReport td {
            padding: 8px;
            border: 1px solid #ddd;
            vertical-align: top;
            max-width: 400px;
            min-width: 100px;
        }

        .see-more-btn {
            color: #1a73e8;
            cursor: pointer;
            font-size: 0.8em;
            display: block;
            margin-top: 5px;
            font-weight: bold;
        }

        .see-more-btn:hover {
            text-decoration: underline;
        }

        .cell-content-wrapped {
            max-height: 4.5em;
            /* approx 3 lines */
            overflow: hidden;
            position: relative;
        }

        .cell-content-expanded {
            max-height: none;
        }

        /* Column Selector Styles */
        .column-selector-container {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .column-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .column-selector-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .column-search-input {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            margin: 0 !important;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .column-selector-btn {
            padding: 8px 15px;
            font-size: 0.9em;
            margin: 0 !important;
            white-space: nowrap;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .column-checkbox-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
            max-height: 250px;
            overflow-y: auto;
            padding: 10px;
            background: white;
            border: 1px solid #eee;
        }

        /* Documentation Link Banner */
        .doc-link-banner {
            background-color: #eef6ff;
            border-left: 4px solid #004c9d;
            padding: 12px 16px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95em;
        }

        .doc-link-banner i {
            color: #004c9d;
            font-size: 1.2em;
        }

        .doc-link-banner a {
            color: #004c9d;
            text-decoration: none;
            font-weight: 500;
        }

        .doc-link-banner a:hover {
            text-decoration: underline;
        }

        /* Technical SEO Form Styles */
        .tech-seo-form {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #eee;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-end;
        }

        .tech-seo-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tech-seo-field label {
            font-weight: 600;
            color: #444;
            font-size: 0.9em;
            margin: 0;
        }

        .tech-seo-field input {
            margin: 0 !important;
            width: auto !important;
            min-width: 250px;
        }

        .tech-seo-field input[type="number"] {
            min-width: 100px;
        }

        .tech-seo-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            width: 100%;
        }

        #dataForSeoCost {
            background-color: #fff4f2;
            color: #d93025;
            padding: 10px 15px;
            border-radius: 6px;
            border-left: 4px solid #d93025;
            font-weight: 600;
            margin-top: 15px;
            font-size: 0.95em;
        }

        /* Summary Table Styles (for GTmetrix, etc.) */
        .summary-table {
            width: 50%;
            max-width: 900px;
            margin-top: 15px;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            table-layout: fixed !important;
            border-radius: 8px;
            overflow: hidden;
        }

        .summary-table th {
            background-color: #004c9d;
            color: white;
            text-align: left;
            padding: 14px 20px;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-table td {
            padding: 14px 20px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
            font-size: 0.95em;
            vertical-align: middle;
            word-wrap: break-word;
        }

        .summary-table th:first-child,
        .summary-table td:first-child {
            width: 30%;
            border-right: 1px solid #f0f0f0;
            background-color: #fcfcfc;
            font-weight: 500;
        }

        .summary-table tr:last-child td {
            border-bottom: none;
        }

        .summary-table tr:hover td {
            background-color: #f8faff;
        }

        /* Flexible Variant for Multi-column Keyword Tables */
        .keywords-table {
            width: 100% !important;
            margin-top: 15px;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            table-layout: fixed !important;
            /* Force fixed widths */
            border-radius: 8px;
            min-width: 750px;
            /* Reduced to help it fit in narrower containers */
        }

        .keywords-table th {
            background-color: #004c9d;
            color: white;
            text-align: left;
            padding: 12px 10px;
            /* Tighter padding */
            font-weight: 600;
            font-size: 0.75em;
            /* Slightly smaller headers */
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .keywords-table td {
            padding: 12px 10px;
            /* Tighter padding */
            border-bottom: 1px solid #f0f0f0;
            color: #333;
            font-size: 0.85em;
            vertical-align: top;
            word-wrap: break-word;
            overflow: hidden;
        }

        /* Column specific widths */
        .kw-col-keyword {
            width: 30%;
        }

        .kw-col-volume {
            width: 13%;
        }

        .kw-col-comp {
            width: 13%;
        }

        .kw-col-intent {
            width: 15%;
        }

        .kw-col-reason {
            width: 21%;
            /* User requested half of previous (~42%) */
        }

        .kw-col-choose {
            width: 8%;
            text-align: center;
        }

        .keywords-table tr:hover td {
            background-color: #f8faff;
        }

        /* Unified style for all keyword tables */
        .uniform-kw-table {
            width: auto !important;
            min-width: unset !important;
            max-width: 100%;
            margin-top: 15px;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            font-size: 0.85em;
        }

        .uniform-kw-table th {
            background-color: #004c9d;
            color: white;
            text-align: left;
            padding: 10px 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        .uniform-kw-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
            vertical-align: top;
            word-wrap: break-word;
        }

        .uniform-kw-table tr:hover td {
            background-color: #f8faff;
        }

        .uniform-kw-table input[type="checkbox"] {
            width: 1.2em !important;
            height: 1.2em !important;
            margin: 0 !important;
            cursor: pointer;
        }

        /* Column specific widths for uniform tables */
        .uniform-kw-table .col-kw {
            width: 22%;
        }

        .uniform-kw-table .col-vol {
            width: 12%;
        }

        .uniform-kw-table .col-comp {
            width: 12%;
        }

        .uniform-kw-table .col-rank {
            width: 12%;
        }

        .uniform-kw-table .col-intent {
            width: 12%;
        }

        .uniform-kw-table .col-reason {
            width: 34%;
        }

        .uniform-kw-table .col-cpc {
            width: 12%;
        }

        .uniform-kw-table .col-choose {
            width: 10%;
            text-align: center;
        }

        .uniform-kw-table.fixed-layout {
            table-layout: fixed !important;
            width: 100% !important;
        }

        /* SERP Table Styles */
        #serp-section table {
            border-collapse: collapse;
            margin-top: 10px;
        }

        #serp-section table th {
            background-color: #004c9d;
            color: white;
            padding: 12px 15px;
            text-align: left;
            border: 1px solid #ddd;
        }

        #serp-section table td {
            padding: 10px 15px;
            border: 1px solid #ddd;
            vertical-align: top;
        }

        /* Optimization: Strictly constrain columns to fit DA without scrolling */
        #serp-section table {
            width: 100%;
            table-layout: fixed;
            /* Force column widths */
            font-size: 0.85em;
            /* Smaller font to save space */
        }

        #serp-section table th:nth-child(1),
        #serp-section table td:nth-child(1) {
            width: 30px;
        }

        /* Rank */

        #serp-section table th:nth-child(2),
        #serp-section table td:nth-child(2) {
            width: 130px;
        }

        /* URL */

        #serp-section table th:nth-child(3),
        #serp-section table td:nth-child(3) {
            width: 120px;
        }

        /* Title */

        #serp-section table th:nth-child(4),
        #serp-section table td:nth-child(4) {
            width: 140px;
        }

        /* Description */

        /* Metric columns (DA, etc.) will take the remaining space or be equally distributed */
        #serp-section table th:nth-child(n+5),
        #serp-section table td:nth-child(n+5) {
            width: 50px;
            text-align: center;
        }

        #serp-section table td {
            white-space: normal;
            word-wrap: break-word;
            word-break: break-all;
            overflow-wrap: anywhere;
        }

        /* SEM Workflow Styles */
        .sem-step-card {
            background: #fff;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #e0e6ed;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
            position: relative;
        }

        .sem-step-badge {
            background: #004c9d;
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.95em;
            font-weight: 700;
            position: absolute;
            top: -16px;
            left: 20px;
            box-shadow: 0 3px 6px rgba(0, 76, 157, 0.25);
            z-index: 1;
            letter-spacing: 0.5px;
        }

        .sem-card-title {
            font-size: 1.25em;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sem-card-title i {
            color: #004c9d;
            font-size: 1.1em;
        }

        .sem-input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
        }

        .sem-input-item {
            flex: 1;
            min-width: 220px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 5px;
        }

        .sem-input-item label {
            font-size: 0.95em;
            font-weight: 700;
            color: #444;
            margin: 0;
            letter-spacing: 0.2px;
        }

        .sem-input-item textarea {
            margin: 0 !important;
            width: 100% !important;
            min-height: 100px !important;
            padding: 12px !important;
            box-sizing: border-box !important;
            font-size: 0.95em !important;
            border-radius: 8px;
            border: 1px solid #c8c8c8;
            background-color: #fff;
            font-family: inherit;
            resize: vertical;
        }

        #SEM textarea {
            min-height: 80px;
            width: 100%;
            border-radius: 8px;
            border: 1px solid #dce4f2;
            padding: 12px;
            font-family: inherit;
            resize: vertical;
        }

        .summary-table td:first-child {
            font-weight: 500;
            color: #333;
            background-color: #f8f9fa;
            width: 200px;
            position: static !important;
            /* Ensure it doesn't try to be sticky like the main analysis table */
        }

        .column-checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            cursor: pointer;
            line-height: 1.4;
            min-height: 24px;
        }

        .column-checkbox-item input[type="checkbox"] {
            width: 16px !important;
            height: 16px !important;
            margin: 0 !important;
            flex-shrink: 0;
        }

        .column-checkbox-item input {
            cursor: pointer;
        }

        .error {
            color: red;
            margin-left: 10px;
        }

        .collapsible {
            background-color: #004c9d;
            color: white;
            cursor: pointer;
            padding: 10px;
            width: 99%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .collapsible.running {
            background-color: #ffc107 !important;
            color: #212529 !important;
        }

        .collapsible.success {
            background-color: #28a745 !important;
            color: white !important;
        }

        .collapsible.error {
            background-color: #dc3545 !important;
            color: white !important;
        }

        .html-output table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: #fff;
            border: 1px solid #e0e6ed;
            font-size: 0.95em;
        }

        .html-output thead th {
            background-color: #3da9d6 !important;
            color: white !important;
            font-weight: 700;
            text-align: center;
            padding: 15px 12px;
            border: 1px solid #e0e6ed;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .html-output td {
            padding: 12px 15px;
            border: 1px solid #e0e6ed;
            color: #333;
            vertical-align: top;
            line-height: 1.5;
        }

        /* First column styling (labels) */
        .html-output td:first-child {
            font-weight: 700;
            color: #1a1a1a;
            background-color: #ffffff;
            width: 120px;
        }

        /* Support for secondary tables (Matrix) which might not have the same header style */
        .html-output table:not(:first-of-type) thead th {
            background-color: #f8f9fa !important;
            color: #333 !important;
            text-transform: none;
        }

        .html-output h3 {
            margin-top: 30px;
            margin-bottom: 15px;
            color: #004c9d;
            font-size: 1.2em;
            border-bottom: 2px solid #e0e6ed;
            padding-bottom: 8px;
        }

        .html-output ul {
            padding-left: 20px;
            margin: 0;
            list-style-type: square;
        }

        .html-output li {
            margin-bottom: 6px;
        }

        /* Strategy House Styling */
        .strategy-house {
            position: relative;
            margin: 30px auto;
            text-align: center;
        }

        .house-roof {
            background-color: #803058;
            color: white;
            padding: 50px 80px;
            clip-path: polygon(15% 0%, 85% 0%, 100% 100%, 0% 100%);
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 1.2em;
            line-height: 1.5;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .house-objectives {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }

        .objective-bar {
            background-color: #a3c9d9;
            color: #333;
            padding: 15px;
            font-weight: 600;
            border-radius: 4px;
        }

        .house-methods {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .method-pillar {
            background-color: #f2e6c2;
            padding: 25px 10px;
            font-weight: 700;
            border-radius: 4px;
            color: #444;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Strategy Grid Styling */
        .strategy-grid {
            width: 100%;
            border-collapse: separate;
            border-spacing: 10px;
            margin-top: 30px;
            font-size: 0.9em;
        }

        .strategy-grid th,
        .strategy-grid td {
            padding: 15px;
            border-radius: 4px;
            color: white;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
        }

        .grid-primary-goal {
            background-color: #5da0c4;
        }

        .grid-method {
            background-color: #f2e6c2;
            color: #444 !important;
        }

        .grid-strategy {
            background-color: #3e6d5e;
        }

        .grid-audience {
            background-color: #b35d2d;
        }

        .grid-pillars {
            background-color: #2e2e5e;
        }

        .strategy-grid td {
            line-height: 1.4;
        }

        .collapsible50 {
            background-color: #4c9d00;
            color: white;
            cursor: pointer;
            padding: 10px;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1em;
            transition: background-color 0.3s ease;
            margin-left: 2%;
        }

        .collapsible90 {
            background-color: #004c9d;
            color: white;
            cursor: pointer;
            padding: 10px;
            width: 85%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .collapsible90.running {
            background-color: #ffc107 !important;
            color: #212529 !important;
        }

        .collapsible90.success {
            background-color: #28a745 !important;
            color: white !important;
        }

        .collapsible90.error {
            background-color: #dc3545 !important;
            color: white !important;
        }

        .collapsible50.running {
            background-color: #ffc107 !important;
            color: #212529 !important;
        }

        .collapsible50.success {
            background-color: #28a745 !important;
            color: white !important;
        }

        .collapsible50.error {
            background-color: #dc3545 !important;
            color: white !important;
        }

        .collapsible-plus {
            background-color: #004c9d;
            color: white;
            cursor: pointer;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .collapsible:hover {
            background-color: #0056b3;
        }

        .content {
            display: none;
            overflow: hidden;
            padding-top: 15px;
            padding-bottom: 15px;
        }

        /* AI Optimiser Flow Styles */
        .optimiser-flow-container {
            margin-bottom: 25px;
        }

        .decision-panel {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }

        .big-decision-btn {
            flex: 1;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
        }

        .big-decision-btn i {
            font-size: 2.5em;
            color: #004c9d;
            transition: transform 0.3s ease;
        }

        .big-decision-btn span {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .big-decision-btn p {
            font-size: 0.9em;
            color: #666;
            margin: 0;
            line-height: 1.4;
        }

        .big-decision-btn:hover {
            border-color: #004c9d;
            background: #f8fbff;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 76, 157, 0.1);
        }

        .big-decision-btn:hover i {
            transform: scale(1.1);
        }

        .big-decision-btn.active {
            border-color: #004c9d;
            background: #004c9d;
        }

        .big-decision-btn.active i,
        .big-decision-btn.active span,
        .big-decision-btn.active p {
            color: white;
        }

        .flow-panel {
            display: none;
            animation: fadeIn 0.4s ease;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #eee;
        }

        .flow-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ref-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .ref-label {
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #444;
        }

        .config-btn-highlight {
            background: #1a73e8;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.1em;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(26, 115, 232, 0.2);
        }

        .config-btn-highlight:hover {
            background: #1557b0;
            transform: scale(1.02);
        }

        /* Standardized Action Button */
        .btn-action {
            background: #1a73e8;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.1em;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(26, 115, 232, 0.2);
            min-width: 250px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }

        .btn-action:hover {
            background: #1557b0;
            transform: scale(1.02);
            color: white;
        }

        .btn-action:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .compliance-dropzone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.2s;
        }

        .compliance-dropzone:hover {
            border-color: #004c9d;
            background: #f0f7ff;
        }

        #backToDecision {
            background: none;
            border: none;
            color: #004c9d;
            padding: 0;
            margin: 0 0 15px 0;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #backToDecision:hover {
            text-decoration: underline;
        }

        .optimiser-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            margin-top: 15px;
        }

        .editor-main {
            flex: 1;
            min-width: 0;
            /* Prevent flex overflow */
        }

        .optimiser-layout {
            display: none;
            /* Hidden by default */
        }

        .sidebar-right {
            width: 320px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Editor Container Styles */
        .editor-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
            color: #333;
            text-align: left;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #dce4f2;
            background-color: #fff;
        }

        .editor-title-container {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        .editor-title-container label {
            font-weight: normal;
            margin-right: 15px;
            color: #444;
            font-size: 1.1em;
        }

        .editor-title-input {
            border: none;
            font-size: 1.25em;
            width: 100%;
            outline: none;
            color: #333;
            font-weight: 600;
        }

        .editor-metrics {
            font-size: 0.9em;
            color: #666;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .editor-toolbar {
            display: flex;
            flex-direction: column;
            padding: 0px;
            background-color: #f8fafd;
            border-bottom: 1px solid #dce4f2;
            gap: 0px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #editorContent a:hover {
            position: relative;
            text-decoration: underline;
        }

        #editorContent a:hover::after {
            content: " [" attr(href) "]";
            position: absolute;
            left: 0;
            top: 100%;
            background: #333;
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            pointer-events: none;
        }

        /* SEO Action Plan Styles */
        .seo-action-plan {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #dce4f2;
        }

        .action-plan-header {
            font-size: 14px;
            font-weight: 700;
            color: #1a73e8;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .action-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 13px;
            color: #444;
            margin-bottom: 8px;
            padding: 8px;
            background: #f8fafd;
            border-radius: 6px;
            border-left: 3px solid #1a73e8;
            line-height: 1.4;
        }

        .action-item i {
            color: #1a73e8;
            margin-top: 3px;
            font-size: 12px;
        }

        .toolbar-row {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            border-right: 1px solid #dce4f2;
            padding: 0 10px;
            margin-right: 4px;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-btn {
            background: none;
            border: 1px solid transparent;
            border-radius: 8px;
            padding: 6px;
            cursor: pointer;
            color: #444;
            font-size: 15px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
        }

        .toolbar-btn:hover {
            background-color: #e8effa;
            color: #004c9d;
            border-color: #c8d6f0;
        }

        .toolbar-btn.active {
            background-color: #dce6f5;
            color: #004c9d;
            border-color: #b8cced;
        }

        .editor-content {
            padding: 25px 30px;
            height: 700px;
            outline: none;
            overflow-y: auto;
            line-height: 1.7;
            font-size: 16px;
            background-color: #fdfdff;
            border: 1px solid transparent;
            margin: 0;
            transition: background-color 0.2s;
        }

        .editor-content:focus {
            background-color: #fff;
            box-shadow: inset 0 0 10px rgba(0, 76, 157, 0.03);
        }

        /* Diff Highlights */
        .diff-original {
            background-color: #ffe6e6;
            color: #cc0000;
            text-decoration: line-through;
            padding: 2px 4px;
            border-radius: 3px;
            margin: 0 2px;
        }

        .diff-new {
            background-color: #fff9db;
            color: #333;
            padding: 2px 4px;
            border-radius: 3px;
            margin: 0 2px;
            border-bottom: 1px dashed #f08c00;
        }

        .diff-preview-wrapper {
            display: inline;
            position: relative;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fafafa;
            margin: 5px 0;
        }

        .diff-controls {
            display: inline-flex;
            gap: 5px;
            margin-left: 10px;
            vertical-align: middle;
        }

        .diff-controls button {
            padding: 2px 8px;
            font-size: 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-diff-accept {
            background: #4caf50;
            color: white;
        }

        .btn-diff-undo {
            background: #f44336;
            color: white;
        }

        .btn-gradient:disabled {
            background: #e0e0e0 !important;
            color: #999 !important;
            cursor: not-allowed;
            box-shadow: none !important;
            opacity: 1;
        }

        /* Generated Content Preview */
        .generated-content-block {
            background-color: #fff9db;
            border: 1px dashed #f08c00;
            border-radius: 6px;
            padding: 12px;
            margin: 15px 0;
            position: relative;
            transition: all 0.3s ease;
        }

        .generated-badge {
            display: inline-block;
            background: #f08c00;
            color: white;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .generated-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            border-top: 1px solid rgba(240, 140, 0, 0.2);
            padding-top: 8px;
        }

        .generated-actions button {
            padding: 6px 12px;
            font-size: 11px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-accept-content {
            background: #4caf50;
            color: white;
        }

        .btn-accept-content:hover {
            background: #43a047;
        }

        .btn-remove-content {
            background: #f44336;
            color: white;
        }

        .btn-remove-content:hover {
            background: #e53935;
        }

        /* HTML & Table Styles */
        .html-output table.generated-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .html-output table.generated-table td,
        .html-output table.generated-table th {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #edf2f7;
            font-size: 14px;
        }

        .html-output table.generated-table tr:last-child td {
            border-bottom: none;
        }

        .html-output table.generated-table tr:first-child {
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
        }

        .html-output h3 {
            font-size: 1.1em;
            color: #004c9d;
            margin-top: 25px;
            margin-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 5px;
        }

        /* Sidebar Card Styles */
        .sidebar-card {
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 10px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        }

        /* Gauge Styles */
        .gauge-container {
            position: relative;
            width: 180px;
            height: 180px;
            margin: 0 auto 20px;
        }

        .gauge-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .gauge-bg {
            fill: none;
            stroke: #f0f0f0;
            stroke-width: 12;
        }

        .gauge-fill {
            fill: none;
            stroke: #ff9800;
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 440;
            stroke-dashoffset: 132;
            /* (1 - score/100) * 440 */
            transition: stroke-dashoffset 1s ease-out;
        }

        .gauge-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .gauge-score {
            display: block;
            font-size: 42px;
            font-weight: 800;
            color: #333;
            line-height: 1;
        }

        .gauge-label {
            display: block;
            font-size: 14px;
            color: #888;
            margin-top: 5px;
        }

        /* Metric Bar Styles */
        .metric-item {
            margin-bottom: 18px;
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 700;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-bar-bg {
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: #4caf50;
            border-radius: 4px;
            transition: width 0.8s ease-out;
        }

        /* Stats Row */
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            font-size: 14px;
            color: #555;
            font-weight: 500;
        }

        .stats-item i {
            margin-right: 5px;
            color: #888;
        }

        /* Action Buttons */
        .btn-gradient {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-seo {
            background: #004c9d;
            box-shadow: 0 4px 10px rgba(0, 76, 157, 0.2);
        }

        .btn-keywords {
            background: #004c9d;
            margin-bottom: 15px;
        }

        .btn-gradient:hover {
            background: #003a7a;
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(0, 76, 157, 0.3);
        }

        /* Tabs Interface */
        .sidebar-tabs {
            padding: 0;
            margin: -24px -24px 20px -24px;
            border-bottom: 1px solid #eee;
            display: flex;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 5px;
            border: none;
            background: none;
            font-size: 13px;
            font-weight: 600;
            color: #888;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn i {
            font-size: 16px;
        }

        .tab-btn.active {
            color: #004c9d;
            border-bottom-color: #004c9d;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Keyword List */
        .keyword-freq-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .keyword-freq-item {
            background: #fcfcfc;
            border: 1px solid #f0f0f0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .keyword-freq-header {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        /* AI Tab Styles */
        .ai-prompt-area {
            width: 100%;
            height: 100px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            resize: none;
            outline: none;
        }

        .ai-prompt-area:focus {
            border-color: #2575fc;
        }

        .ai-actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .ai-action-btn {
            padding: 10px;
            background: white;
            border: 1px solid #eee;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #555;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .ai-action-btn:hover {
            background: #f8fbff;
            border-color: #d0d7ff;
            color: #004c9d;
        }

        /* Multi-keyword Textarea */
        .keyword-input-textarea {
            width: 100%;
            height: 80px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            margin-top: 8px;
            outline: none;
        }

        .keyword-input-textarea:focus {
            border-color: #004c9d;
        }

        /* Status Box */
        .status-box {
            background: #ebfbee;
            color: #2b8a3e;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
            font-size: 14px;
            margin-top: 15px;
        }

        .status-box i {
            font-size: 20px;
        }

        /* Image Resizing */
        .img-resize-handle {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 12px;
            height: 12px;
            background: #004c9d;
            border: 2px solid white;
            border-radius: 50%;
            cursor: nwse-resize;
            display: none;
            z-index: 15;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .img-optimiser-wrapper:hover .img-resize-handle {
            display: block;
        }

        /* Floating Selection Toolbar */
        .selection-toolbar {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            display: none;
            flex-direction: column;
            z-index: 2000;
            padding: 8px;
            gap: 8px;
            border: 1px solid #eee;
            pointer-events: auto;
            min-width: 250px;
        }

        .st-buttons-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #stCustomInstructions {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 11px;
            font-family: inherit;
            resize: vertical;
            min-height: 35px;
            outline: none;
            box-sizing: border-box;
        }

        #stCustomInstructions:focus {
            border-color: #004c9d;
            box-shadow: 0 0 0 2px rgba(0, 76, 157, 0.1);
        }

        .selection-toolbar button {
            background: none;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #333;
            transition: all 0.2s;
        }

        .selection-toolbar button:hover {
            background: #f5f8ff;
            color: #004c9d;
        }

        .selection-toolbar button i {
            font-size: 14px;
        }

        .st-custom-label {
            font-size: 10px;
            color: #666;
            font-weight: 600;
            margin-bottom: 2px;
            display: block;
        }

        /* Granular Review Mode Stats */
        .review-block-container {
            position: relative;
            background: #f8fbff;
            border: 1px solid #d0e3ff;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 0;
            overflow: hidden;
            transition: all 0.2s;
        }

        .review-block-container:hover {
            border-color: #004c9d;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .review-side-by-side {
            display: flex;
            gap: 2px;
            background: #eee;
        }

        .review-column {
            flex: 1;
            padding: 15px;
            background: white;
            min-height: 100px;
        }

        .review-column-header {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .col-original {
            border-right: 1px solid #eee;
        }

        .col-original .review-column-header {
            color: #ea4335;
        }

        .col-suggested .review-column-header {
            color: #28a745;
        }

        .review-original-body {
            font-size: 0.95em;
            color: #777;
            text-decoration: line-through;
            line-height: 1.6;
        }

        .review-suggestion-body {
            font-size: 1em;
            color: #333;
            line-height: 1.6;
            outline: none;
            padding: 5px;
            border-radius: 4px;
            border: 1px dashed transparent;
            transition: all 0.2s;
        }

        .review-suggestion-body[contenteditable="true"]:hover {
            border-color: #28a745;
            background: #fafffa;
        }

        .review-suggestion-body[contenteditable="true"]:focus {
            border-color: #28a745;
            background: #fafffa;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .review-block-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 10px 15px;
            background: #fcfdfe;
            border-top: 1px solid #eee;
        }

        .btn-review-accept {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-review-reject {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-review-accept:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .btn-review-reject:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .review-unchanged {
            opacity: 0.6;
            margin-bottom: 15px;
            padding: 0 10px;
            border-left: 2px solid #ddd;
        }

        /* Gap Analysis Rich Text Result Area */
        .gap-analysis-results-area {
            width: 100%;
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #b8daff;
            background: white;
            font-size: 0.95em;
            line-height: 1.6;
            box-sizing: border-box;
            outline: none;
            transition: all 0.2s;
        }

        .gap-analysis-results-area:focus {
            border-color: #004c9d;
            box-shadow: 0 0 0 3px rgba(0, 76, 157, 0.1);
        }

        .gap-analysis-results-area table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .gap-analysis-results-area th,
        .gap-analysis-results-area td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        .gap-analysis-results-area th {
            background: #f5f8ff;
            color: #004c9d;
        }

        .gap-analysis-results-area:empty::before {
            content: attr(data-placeholder);
            color: #999;
            font-style: italic;
        }


        .st-separator {
            width: 1px;
            height: 20px;
            background: #eee;
            margin: 0 5px;
        }

        .st-settings {
            padding: 8px !important;
            color: #888 !important;
        }

        .st-settings:hover {
            color: #333 !important;
            background: #f5f5f5 !important;
        }

        /* Custom Tooltips */
        .tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 2500;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.15s ease-in-out;
            font-size: 11px;
            font-weight: normal;
            line-height: 1.4;
            pointer-events: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            white-space: normal;
        }

        /* GSC Tabs */
        .gsc-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 0;
        }

        .gsc-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            background: #f8f9fa;
            color: #5f6368;
            font-weight: 500;
            font-size: 13px;
            border: 1px solid #eee;
            border-bottom: none;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .gsc-tab.active {
            background: #fff;
            color: #1a73e8;
            border-color: #eee;
            border-bottom: 2px solid #fff;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
        }

        .gsc-tab-panel {
            display: none;
            transition: opacity 0.3s;
        }

        .gsc-tab-panel.active {
            display: block;
            opacity: 1;
        }

        .insight-card {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .insight-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            border-bottom: 1px solid #f8f9fa;
            padding-bottom: 8px;
        }

        .insight-score-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-win {
            background: #e6f4ea;
            color: #1e8e3e;
        }

        .badge-warning {
            background: #fef7e0;
            color: #f29900;
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .editor-content h1 {
            font-size: 2.2em;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .editor-content h2 {
            font-size: 1.8em;
            margin-bottom: 12px;
        }

        .editor-content h3 {
            font-size: 1.4em;
            margin-bottom: 10px;
        }

        .editor-content blockquote {
            border-left: 5px solid #004c9d;
            margin: 15px 0;
            padding: 10px 20px;
            background-color: #f8fbff;
            color: #555;
            font-style: italic;
        }

        .editor-content ul,
        .editor-content ol {
            padding-left: 30px;
            margin-bottom: 15px;
        }

        .editor-content img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin: 10px 0;
        }

        .editor-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }

        .editor-content td {
            border: 1px solid #ddd;
            padding: 10px;
        }

        button.sort-button {
            padding: 3px 6px;
            font-size: 1em;
            margin-left: 5px;
            background-color: #286b37;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }

        button.sort-button:hover {
            background-color: #218838;
        }

        hr {
            border-top: 4px solid rgb(95, 103, 154);
            border-radius: 7px;
            width: 100%;
        }

        .header-container {
            display: flex;
            align-items: center;
            margin: 20px 0;
            background-color: black;
            height: 70px;
            border-radius: 10px;
        }

        .header-container img {
            margin-right: 15px;
            width: auto;
            height: 70%;
        }

        p,
        h1,
        h2,
        h3 {
            text-wrap: wrap;
            font-family: 'Roboto', sans-serif;
        }

        h2 {
            margin-top: 20px;
        }

        h1 {
            margin: 0;
            font-size: 1.5em;
        }

        #keywordListContainer {
            display: flex;
            flex-direction: column;
            max-width: 100%;
            padding: 2px;
        }

        #keywordListContainer h3 {
            font-size: 1em;
            margin-top: 0;
        }

        .keyword-row {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            max-width: 65%;
        }

        .keyword-column {
            flex: 1;
            margin-right: 5px;
            min-width: 50px;
        }

        .keyword-column:hover {
            font-size: 1em;
            cursor: pointer;
        }

        .keyword-column:nth-child(1) {
            flex: 0 0 60%;
        }

        .keyword-column:nth-child(2) {
            flex: 0 0 30%;
        }

        .keyword-column:nth-child(3) {
            flex: 0 0 22%;
        }

        input[type="checkbox"] {
            width: 3em;
        }


        .checkbox-column {
            flex: 0 0 5%;
            margin-right: 0;
        }

        .column {
            float: left;
            width: 50%;
        }

        .column60 {
            float: left;
            width: 60%;
        }

        .column40 {
            float: left;
            width: 40%;
        }

        .column50 {
            float: left;
            width: 48%;
            padding: 1%;
        }

        ul {
            max-height: 350px;
            overflow: auto;
            width: 100%;
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: Window;
        }

        li {
            margin: 5px;
            padding: 0px;
            align-items: left;
        }

        label,
        label-fixed {
            color: WindowText;
            margin: 0;
            padding: 0;
            width: 100%;
        }

        .label-short {
            width: 100%;
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 2em;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #auditSummary table {
            width: 50%;
            float: right;
            padding: 10px;
            height: 560px;
        }

        #analysisTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            max-height: 700px;
            overflow: auto;
        }

        #analysisTable a {
            color: white;
        }

        #analysisTable th,
        #analysisTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            word-wrap: break-word;
            vertical-align: top;
        }

        #tableContainer {
            width: 100%;
            overflow-x: auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 3em;
            height: 1.5em;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 1em;
            width: 1em;
            left: 4%;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #004c9d;
        }

        input:focus+.slider {
            box-shadow: 0 0 1px #004c9d;
        }

        input:checked+.slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }


        .toggle-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .toggle-label {
            margin-right: 10px;
        }

        .toggle-label-right {
            margin-left: 10px;
        }

        .header-container img {
            margin-left: 20px;
            width: 400px;
            height: auto;
        }

        .faq-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .faq-item input,
        .faq-item textarea {
            flex-grow: 1;
            margin-right: 10px;
            min-width: 0;
        }

        .faq-item textarea {
            min-height: 80px;
        }

        #navbar ul {
            list-style: none;
            padding: 0;
            margin: 0;
            background-color: #004c9d;
            max-height: None;
        }

        #navbar li {
            padding-left: 10px;
        }

        #navbar li ul li {
            padding-left: 20px;
        }

        #navbar li ul li ul li {
            padding-left: 30px;
        }

        .keyword-count {
            margin-left: 10px;
            color: #004c9d;
        }

        #downloadResultsBtn {
            display: none;
            margin-top: 20px;
        }

        #navbar li a#logoutLink {
            display: block;
            color: white;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        #navbar li a#logoutLink:hover {
            background-color: #0056b3;
            border-radius: 10px;
        }

        #navbar li a#logoutLink i {
            margin-right: 2%;
        }

        #navbar .submenu {
            display: none;
        }


        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip span {
            position: absolute;
            z-index: 10;
            left: 50%;
            transform: translateX(-50%);
            bottom: calc(100% + 5px);
            min-width: 200px;
            max-width: 500px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            border-radius: 15px;
            font-size: 0.9em;
        }

        .tooltip:hover span {
            opacity: 1;
            visibility: visible;
        }

        #overall-summary .table-container table {
            width: 100%;
            table-layout: auto;
            min-width: 1000px;
            /* Force minimum width to prevent squashing */
        }

        #overall-summary .table-container th,
        #overall-summary .table-container td {
            white-space: normal;
            word-break: break-word;
            max-width: none;
            padding: 10px;
            vertical-align: top;
            border: 1px solid #ddd;
        }

        /* Specific min-widths for key columns */
        .table-container th:nth-child(2),
        .table-container td:nth-child(2) {
            min-width: 200px;
            /* Keyword/URL column */
        }

        .table-container th:nth-child(3),
        .table-container td:nth-child(3),
        .table-container th:nth-child(4),
        .table-container td:nth-child(4) {
            min-width: 150px;
            /* Title/Description/Search Volume */
        }

        #overall-summary .table-container th:nth-child(6),
        #overall-summary .table-container td:nth-child(6) {
            min-width: 350px;
            /* Reason column */
        }

        #overall-summary .table-container textarea {
            width: 100%;
            /* Make textareas fill the column width */
            box-sizing: border-box;
            /* Include padding and border in the width */
            height: 80px;
            /* Set an initial height for the textareas */
            resize: vertical;
            /* Allow vertical resizing */
            font-family: inherit;
        }

        .keywords-collapsible {
            min-width: 100%;
            text-align: left;
            margin: 1px;
        }

        .time-to-rank-0-3 {
            background-color: #c6efc6;
            /* Example: Light green */
        }

        .time-to-rank-3-6 {
            background-color: #9bd3ae;
            /* Example: Medium green */
        }

        .time-to-rank-6-9 {
            background-color: #ffda66;
            /* Example: Yellow */
        }

        .time-to-rank-9-12 {
            background-color: #fbb668;
            /* Example: Orange */
        }

        .time-to-rank-more-than-12 {
            background-color: #f4746b;
            /* Example: Red */
        }

        .media-plan-checkbox {
            min-width: 0%;
        }

        /* The Modal (background) */
        .feedback-modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 1001;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
        }

        .modal-content {
            display: block;
            position: fixed;
            /* Stay in place */
            z-index: 1;
            /* Sit on top */
            left: 5%;
            top: 5%;
            width: 90%;
            /* Full width */
            height: auto;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: #fefefe;
            border-radius: 10px;
            padding: 1%;
            border: 3px solid #ccc;
        }

        /* Modal Content/Box */
        .feedback-modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 60%;
            /* Could be more or less, depending on screen size */
            border-radius: 10px;
        }

        /* The Close Button */
        .feedback-close,
        .journey-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .feedback-close:hover,
        .feedback-close:focus,
        .journey-close:hover,
        .journey-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* AI Settings Modal Styles */
        .ai-settings-modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 0;
            width: 90%;
            max-width: 600px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            border: none;
        }

        .ai-settings-modal-content .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-settings-modal-content .modal-header h2 {
            margin: 0;
            color: #004c9d;
            font-size: 1.5rem;
        }

        .ai-settings-modal-content .close-modal {
            font-size: 24px;
            color: #999;
            cursor: pointer;
            transition: color 0.2s;
        }

        .ai-settings-modal-content .close-modal:hover {
            color: #333;
        }

        .settings-sections-container {
            padding: 20px 25px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section h3 {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-header h3 {
            margin-bottom: 0;
            border: none;
            padding: 0;
        }

        .advanced-toggle {
            background: #2b67f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: 500;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .form-group.half {
            flex: 1;
        }

        .form-group.full {
            width: 100%;
        }

        .form-group label {
            font-size: 0.9rem;
            color: #555 !important;
            margin-bottom: 6px;
            font-weight: 600 !important;
        }

        .form-group .required {
            color: #f44336;
        }

        .form-group input[type="text"],
        .form-group select {
            padding: 10px 12px;
            border: 1px solid #dce4f2;
            border-radius: 8px;
            font-size: 0.95rem;
            color: #333;
            background: #fff;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #004c9d;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 76, 157, 0.1);
        }

        .help-text {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
            font-style: italic;
        }

        .checkbox-group {
            flex-direction: row;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group label {
            margin-bottom: 0 !important;
            cursor: pointer;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .btn-reset {
            background: #ff7e1d;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .footer-right {
            display: flex;
            gap: 10px;
        }

        .btn-close {
            background: white;
            color: #333;
            border: 1px solid #ddd;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-apply {
            background: #2b67f6;
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .funnel-container {
            width: 90%;
            margin: 20px auto;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .funnel-collapsible-before {
            color: white;
            cursor: pointer;
            padding: 20px;
            width: 100%;
            border: none;
            text-align: center;
            outline: none;
            transition: background-color 0.8s ease;
            border-radius: 50px;
            font-size: 1em;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        .funnel-collapsible {
            color: white;
            cursor: pointer;
            padding: 20px;
            width: 100%;
            border: none;
            text-align: center;
            outline: none;
            transition: background-color 0.8s ease;
            border-radius: 50px 50px 0px 0px;
            font-size: 1em;
            box-sizing: border-box;
            margin: 0px;
        }

        .funnel-content {
            width: 100%;
            display: none;
            padding: 20px;
            border-radius: 0px 0px 50px 50px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .gauge {
            width: 100%;
            max-width: 250px;
            font-family: "Roboto", sans-serif;
            font-size: 18px;
            font-weight: bolder;
            color: #686868;
        }

        .gauge__body {
            width: 100%;
            height: 0;
            padding-bottom: 50%;
            background: linear-gradient(90deg, rgba(253, 29, 29, 1) 0%, rgb(245, 229, 0) 50%, rgba(33, 255, 68, 1) 100%);
            position: relative;
            border-top-left-radius: 100% 200%;
            border-top-right-radius: 100% 200%;
            overflow: hidden;
        }

        .gauge__fill {
            position: absolute;
            top: 100%;
            left: 0;
            width: inherit;
            height: 100%;
            transform-origin: center top;
            transform: rotate(0.25turn);
            transition: transform 0.2s ease-out;
            border: 2.5px solid #5d5d5d;
            /* Solid border for a more defined outline */
        }

        .gauge__cover {
            width: 75%;
            height: 150%;
            background: #f0f0f0;
            border-radius: 50%;
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-bottom: 25%;
            box-sizing: border-box;
            text-align: center;
        }

        .collapsible i {
            margin-right: 1em;
        }


        .checkbox-wrapper-25 input[type="checkbox"] {
            background-image: -webkit-linear-gradient(hsla(0, 0%, 0%, .1), hsla(0, 0%, 100%, .1)),
                -webkit-linear-gradient(left, #f66 50%, rgb(0, 164, 90) 50%);
            background-size: 100% 100%, 200% 100%;
            background-position: 0 0, 15px 0;
            border-radius: 25px;
            box-shadow: inset 0 1px 4px hsla(0, 0%, 0%, .5),
                inset 0 0 10px hsla(0, 0%, 0%, .5),
                0 0 0 1px hsla(0, 0%, 0%, .1),
                0 -1px 2px 2px hsla(0, 0%, 0%, .25),
                0 2px 2px 2px hsla(0, 0%, 100%, .75);
            cursor: pointer;
            height: 25px;
            padding: 0px 25px 0px 0px;
            -webkit-appearance: none;
            -webkit-transition: .25s;
            min-width: 50px;
        }

        .checkbox-wrapper-25 input[type="checkbox"]:after {
            background-color: #eee;
            background-image: -webkit-linear-gradient(hsla(0, 0%, 100%, .1), hsla(0, 0%, 0%, .1));
            border-radius: 25px;
            box-shadow: inset 0 1px 1px 1px hsla(0, 0%, 100%, 1),
                inset 0 -1px 1px 1px hsla(0, 0%, 0%, .25),
                0 1px 3px 1px hsla(0, 0%, 0%, .5),
                0 0 2px hsla(0, 0%, 0%, .25);
            content: '';
            display: block;
            height: 25px;
            width: 25px;
        }

        .checkbox-wrapper-25 input[type="checkbox"]:checked {
            background-position: 0 0, 35px 0;
            padding-left: 25px;
            padding-right: 0;
        }

        .mediaPlanPersonaResults {
            max-height: 500px;
            overflow: auto;
            display: none;
        }

        /* The Modal (background) */
        .feedback-modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 1002;
            /* Ensure it's on top of chatbot-modal */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
        }

        /* Modal Content/Box */
        .feedback-modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            /* Could be more or less, depending on screen size */
            border-radius: 10px;
            position: relative;
            /* Add this */
            z-index: 1002;
            /* Ensure it's on top */
        }

        :root {
            --primary-navy: #21468B;
            --secondary-navy: #31569B;
            --accent-blue: #3b82f6;
            --accent-light: #dbeafe;
            --bg-gradient: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.3);
            --text-main: #1e293b;
            --text-muted: #64748b;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        #chatbot-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            z-index: 1001;
            width: 90%;
            max-width: 1200px;
            height: 85vh;
            padding: 0;
            /* Override old padding */
        }

        /* Conversation Picker Styles */
        .conversation-picker {
            flex: 0 0 300px;
            width: 300px;
            min-width: 300px;
            max-width: 300px;
            background: rgba(255, 255, 255, 0.5);
            border-right: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .chat-header {
            height: 60px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--primary-navy);
            color: #fff;
            flex-shrink: 0;
        }

        .chat-header h2 {
            margin: 0;
            font-size: 1rem;
            font-weight: 700;
            color: white !important;
        }

        .search-bar {
            padding: 12px;
        }

        .search-container {
            position: relative;
        }

        .search-container i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .search-bar input {
            width: 100%;
            padding: 8px 10px 8px 32px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            font-size: 0.85rem;
            outline: none;
            box-sizing: border-box;
        }

        .conversation-list {
            overflow-y: auto;
            flex-grow: 1;
            padding: 8px;
        }

        .conversation-item {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            background: transparent;
        }

        .conversation-item:hover {
            background: rgba(255, 255, 255, 0.8);
        }

        .conversation-item.active {
            background: #fff;
            border: 1px solid var(--accent-blue);
            box-shadow: var(--shadow-sm);
        }

        .conversation-details {
            min-width: 0;
        }

        .conversation-item .name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-item .latest-message {
            font-size: 0.8rem;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Chat Main Area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: #f8fafc;
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .message {
            padding: 12px 16px;
            border-radius: 15px;
            max-width: 80%;
            line-height: 1.5;
            font-size: 0.9rem;
            position: relative;
            word-wrap: break-word;
        }

        .message.user {
            background: var(--accent-blue);
            color: #fff;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.bot {
            background: #fff;
            color: var(--text-main);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            margin-left: 40px;
        }

        .message.user {
            margin-right: 40px;
        }

        .message-wrapper.bot {
            align-items: flex-start;
        }

        .message-wrapper.user {
            align-items: flex-end;
        }

        .avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            position: absolute;
            bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            z-index: 5;
        }

        .message.bot .avatar {
            left: -40px;
            background: var(--secondary-navy);
            color: #fff;
        }

        .message.user .avatar {
            right: -40px;
            background: var(--accent-light);
            color: var(--accent-blue);
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-input-container {
            padding: 15px 20px;
            background: #fff;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #question-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            outline: none;
            font-size: 0.9rem;
        }

        /* Attachment Preview Styles */
        .attachment-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 12px;
            padding: 0 4px;
        }

        .attachment-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 12px;
            background: #f1f5f9;
            border: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: visible;
            transition: all 0.2s ease;
        }

        .attachment-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 11px;
        }

        .attachment-remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: #ef4444;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 10;
            line-height: 1;
        }

        /* Image Modal Styles */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            padding-top: 50px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
        }

        .modal-content {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 900px;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 5px;
            animation: chatZoom 0.3s;
        }

        @keyframes chatZoom {
            from {
                transform: scale(0)
            }

            to {
                transform: scale(1)
            }
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }

        .message img {
            max-width: 250px;
            max-height: 250px;
            object-fit: contain;
            border-radius: 12px;
            margin: 8px 0;
            display: block;
            cursor: zoom-in;
            transition: transform 0.2s ease;
        }

        .message img:hover {
            transform: scale(1.02);
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            #chatbot-modal {
                width: 100%;
                height: 100%;
                max-width: none;
                max-height: none;
                border-radius: 0;
                top: 0;
                left: 0;
                transform: none;
                flex-direction: column;
            }

            .conversation-picker {
                display: none;
                /* Hide sidebar on mobile to save space */
            }

            .chat-main {
                height: 100%;
            }

            .message {
                max-width: 90%;
            }

            .message.bot {
                margin-left: 35px;
            }

            .message.user {
                margin-right: 35px;
            }

            .avatar {
                width: 25px;
                height: 25px;
            }

            .message.bot .avatar {
                left: -35px;
            }

            .message.user .avatar {
                right: -35px;
            }
        }

        .collapsible-icon {
            margin-right: 5px;
            /* Changed from margin-left to margin-right */
            cursor: pointer;
            /*  Change cursor on hover */
            font-size: larger;
            /* Adjust size of the icon as needed */
            transition: transform 0.2s ease-in-out;
            /* Smooth animation when changing */
        }

        .collapsible-icon.open {
            transform: rotate(45deg);
            /* Rotate to become a "x" sign when open */
        }

        #seo-submenu.submenu.show,
        #smm-submenu.submenu.show {
            display: block;
        }

        #seo-submenu.submenu,
        #smm-submenu.submenu {
            display: none;
        }


        #metaTable td:nth-child(1) {
            width: 15%;
            /* Adjust this value as needed */
            word-break: break-word;
            /* Prevent overflow by breaking long words */
        }

        /* Persona Card Styles */
        #persona-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .persona-card {
            background: #ffffff;
            border: 1px solid #e0e6ed;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            gap: 18px;
            border-top: 6px solid #004c9d;
            position: relative;
            overflow: hidden;
        }

        .persona-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, rgba(0, 76, 157, 0.02) 0%, rgba(255, 255, 255, 0) 100%);
            pointer-events: none;
        }

        .persona-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }

        .persona-header {
            margin-bottom: 5px;
            padding-left: 40px;
            /* Space for top-left delete button */
        }

        .persona-header h3 {
            margin: 0;
            color: #004c9d;
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .persona-age {
            margin: 6px 0 0 0;
            color: #64748b;
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }


        .persona-body {
            display: flex;
            flex-direction: column;
            gap: 16px;
            flex-grow: 1;
        }

        .persona-section {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .persona-section strong {
            display: block;
            color: #475569;
            margin-bottom: 6px;
            text-transform: uppercase;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.08em;
        }

        .persona-section p,
        .persona-section ul {
            margin: 0;
            color: #1e293b;
        }

        .persona-section ul {
            padding-left: 20px;
            list-style-type: none;
        }

        .persona-section ul li {
            position: relative;
            margin-bottom: 4px;
        }

        .persona-section ul li::before {
            content: '';
            color: #004c9d;
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
        }

        /* Card Deletion & Undo Styles */
        .card-delete-btn {
            position: absolute;
            top: -10px;
            right: 18px;
            width: 24px;
            height: 24px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 10;
            font-size: 11px;
        }

        .card-delete-btn:hover {
            background: #dc2626;
            color: white;
            transform: scale(1.1) translateY(-1px);
        }

        .undo-bar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px dashed #e2e8f0;
        }

        .btn-undo {
            background: #1e293b;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 0.9em;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .btn-undo:hover:not(:disabled) {
            background: #0f172a;
            transform: translateY(-1px);
        }

        .btn-undo:disabled {
            background: #f1f5f9;
            color: #cbd5e1;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-undo i {
            font-size: 1em;
        }

        .persona-rationale {
            background: #f1f5f9;
            padding: 16px;
            border-radius: 12px;
            border-left: 5px solid #10b981;
            font-size: 0.9rem;
            color: #334155;
            line-height: 1.5;
        }

        .persona-rationale strong {
            display: block;
            color: #059669;
            font-size: 0.75rem;
            text-transform: uppercase;
            margin-bottom: 4px;
            letter-spacing: 0.05em;
        }

        #metaTable td:nth-child(2) {
            width: 20%;
            /* Adjust this value as needed */
            word-break: break-word;
            /* Prevent overflow by breaking long words */
        }

        #metaTable td:nth-child(3) {
            width: 30%;
            /* Adjust this value as needed */
            word-break: break-word;
            /* Prevent overflow by breaking long words */
        }

        #imageTable img {
            max-width: 80px;
            max-height: 80px;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
            /* Center the images */
        }


        #imageTable td:nth-child(2) {
            width: 20%;
            /* Adjust this value as needed */
            word-break: break-word;
        }

        #imageTable td:nth-child(4) {
            width: 30%;
            /* Adjust this value as needed */
            word-break: break-word;
        }

        #imageTable td:nth-child(5) {
            width: 30%;
            /* Adjust this value as needed */
            word-break: break-word;
        }

        #contentTable td:nth-child(1) {
            text-align: center;
            padding: 10px;
        }

        #contentTable td:nth-child(2) {
            width: 30%;
            /* Adjust this value as needed */
            word-break: break-word;
            padding: 10px;
        }

        #contentTable td:nth-child(3) {
            width: 36%;
            /* Adjust this value as needed */
            word-break: break-word;
        }

        #contentTable td:nth-child(4) {
            width: 32%;
            /* Adjust this value as needed */
            word-break: break-word;
            padding: 10px;
        }

        .queries-modal {
            display: none;
            position: fixed;
            z-index: 20;
            left: 5%;
            top: 5%;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            overflow: auto;
        }

        .queries-modal-content {
            background-color: #fefefe;
            padding: 24px;
            border: 1px solid #ddd;
            width: fit-content;
            min-width: 80%;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        /* Prevent global table[display:block] from breaking modal tables */
        .queries-modal-content table {
            display: table !important;
            width: 100% !important;
            table-layout: auto !important;
            margin-bottom: 20px;
        }

        .queries-modal-content th,
        .queries-modal-content td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            word-break: normal !important;
            /* Allow natural wrapping, not character level */
        }

        .queries-modal-content thead th {
            background-color: #004c9d;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .queries-modal-content tbody tr:hover {
            background-color: #f5f8ff;
            cursor: pointer;
        }

        /* Specific column widths for Time To Rank Table */
        #timeToRankQueriesTable th:nth-child(1),
        #timeToRankQueriesTable td:nth-child(1) {
            width: 40px;
            text-align: center;
        }

        /* No. */
        #timeToRankQueriesTable th:nth-child(2),
        #timeToRankQueriesTable td:nth-child(2) {
            width: 140px;
        }

        /* Date */
        #timeToRankQueriesTable th:nth-child(3),
        #timeToRankQueriesTable td:nth-child(3) {
            width: 220px;
            word-break: break-all !important;
        }

        /* URL */
        #timeToRankQueriesTable th:nth-child(4),
        #timeToRankQueriesTable td:nth-child(4) {
            min-width: 300px;
        }

        /* Keywords */
        #timeToRankQueriesTable th:nth-child(5),
        #timeToRankQueriesTable td:nth-child(5) {
            width: 180px;
        }

        /* User */

        #modalContent table tr {
            height: 10px;
        }

        #modalContent th:nth-child(1),
        #modalContent td:nth-child(1) {
            width: 10%;

        }

        #modalContent th:nth-child(2),
        #modalContent td:nth-child(2) {
            max-width: 20%;
        }

        #modalContent th:nth-child(3),
        #modalContent td:nth-child(3) {
            max-width: 20%;
        }

        #modalContent th:nth-child(4),
        #modalContent td:nth-child(4) {
            max-width: 30%;
        }

        #modalContent th:nth-child(5),
        #modalContent td:nth-child(5) {
            width: 10%;
        }

        /* Add this rule to your existing CSS */
        #logoutNavItem {
            margin-left: auto;
        }

        #mangoolsQuota {
            margin-left: 40px;
        }

        .process {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 1%;
            margin-bottom: 0%;
            margin-left: 5%;
            margin-right: 5%;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: auto;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, transform 0.2s ease-in-out;

        }

        .step-number.completed {
            background-color: green;
            color: #fff;
            border-color: green;
        }

        .step-number.completed i {
            display: inline-block;
        }

        .step-number i {
            display: none;
        }

        .line {
            flex-grow: 1;
            height: 1px;
            background-color: #ddd;
            margin: 0 20px;
        }

        .step-card-container {
            width: calc(100% / 7);
            /* Each container takes up 1/7 of the total width */
            display: flex;
            justify-content: center;
            /* Center the content horizontally */
        }

        .step-card {
            background-color: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin: 10px;
            text-align: center;
            width: 100%;
            /* Step card takes the full width of its container */
            box-sizing: border-box;
            /* Ensures padding doesn't affect width */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            /*Smooth transitions for hover*/
        }

        .step-card:hover {
            transform: translateY(-5px);
            /* Move card up slightly on hover */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            /* Increase shadow on hover */
            cursor: pointer;
        }

        .step-card i {
            font-size: 24px;
            margin-bottom: 8px;
            color: #004c9d;
            transition: color 0.3s ease;
            /*Smooth transition for color*/
        }

        .step-card:hover i {
            color: #003366;
            /* Darker color on hover */
        }

        .step-title {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .step-description {
            font-size: 14px;
            color: #555;
        }

        .step-card-row {
            display: flex;
            justify-content: space-between;
        }

        .progress-bar-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 10px;
            overflow: hidden;
            /* Hide the overflowing progress */
        }

        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            /* Green color for the progress */
            width: 0;
            /* Initial width is 0 */
            transition: width 0.3s ease;
            /* Smooth transition for the width */
        }

        /* Collapsible styles */
        .journey-collapsible {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 8px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: background-color 0.3s ease;
            /*Smooth transition for background color */
            position: relative;
            /* Required for absolute positioning of the progress bar */
        }

        .journey-collapsible-text {
            position: relative;
            z-index: 2;
            /* Ensure text stays on top of the progress bar */
        }

        .journey-collapsible:hover {
            background-color: #ddd;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }

        .list-container {
            width: 300px;
            margin: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .keyword-list {
            list-style: none;
            padding: 0;
            margin: 0;
            min-height: 200px;
            /* Starting height */
        }

        .keyword-list li {
            background-color: #eee;
            border: 1px solid #ddd;
            padding: 8px 12px;
            margin-bottom: 5px;
            cursor: grab;
            border-radius: 20px;
            user-select: none;
        }

        .keyword-list li:hover {
            background-color: #ddd;
        }

        .keyword-list.drag-over {
            background-color: #f9f9f9;
            border: 2px dashed #aaa;
        }

        .rename-input {
            width: 80%;
            margin-bottom: 5px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 1.2em;
            background-color: #bee1ff;
        }

        .delete-list-btn {
            position: absolute;
            top: 15px;
            right: 4px;
            background-color: transparent;
            border: none;
            cursor: pointer;
            color: #888;
        }

        .delete-list-btn:hover {
            color: #333;
        }

        .disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @media screen and (max-width: 1081px) {

            .column,
            .column40,
            .column60 {
                width: 100%;
            }

            #SEM .column {
                width: 100%;
            }
        }

        @media screen and (max-width: 900px) {

            .content {
                width: 100%;
            }


            .header-container img {
                margin-right: 5%;
                /* Space between the image and the text */
                width: 80%;
                /* Adjust the width as needed */
                height: auto;
            }

            .collapsible-icon {
                display: none;
            }

            #navbar {
                width: 60px;
                /* Reduced width for smaller screens */
            }

            #navbar img {
                width: 100%;
                /* Smaller logo */
            }

            #navbar span {
                display: none;
                /* Hide text labels */
            }

            .column,
            .column40,
            .column60,
            .column50 {
                width: 100%;
            }

            .toggle-label {
                margin-right: 10px;
            }

            .toggle-label-right {
                margin-left: 10px;
            }

            #SEM .column {
                width: 100%;
            }

            .sliderMobile {
                min-width: 20px;
            }

            input:checked+.slider:before {
                -webkit-transform: translateX(18px);
                -ms-transform: translateX(18px);
                transform: translateX(18px);
            }

            #navbar li ul li {
                padding-left: 0px;
                /* Increased indentation for sub-items */
            }

            .toggle-label,
            .toggle-label-right {
                font-size: 0.75em;
            }
        }

        /* Style the navbar */
        .navbar {
            background-color: #004c9d;
            display: flex;
            align-items: center;
            padding: 10px 20px;
            color: white;
            z-index: 1000;
            border-radius: 12px;
            top: 10px;
            position: sticky;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: 60px;
            box-sizing: border-box;
        }

        /* Logo Container */
        .logo-container {
            display: flex;
            align-items: center;
            margin-right: 30px;
        }

        .logo-container img {
            height: 24px;
            filter: brightness(0) invert(1);
            /* Ensure logo is visible on dark bg */
        }

        .nav-item {
            position: relative;
            height: 100%;
            display: flex;
            align-items: center;
        }

        .nav-item>a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-size: 15px;
            font-weight: 500;
            padding: 0 20px;
            height: 100%;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            border-radius: 8px;
            letter-spacing: 0.3px;
        }

        /* Change color on hover */
        .nav-item:hover>a {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #ffffff;
            min-width: 240px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            top: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            border-radius: 12px;
            overflow: visible;
            /* Changed from hidden to allow pseudo-element bridge */
            border: 1px solid #eef2f6;
            padding: 8px 0;
            animation: navFadeIn 0.2s ease-out;
        }

        /* Hover bridge to prevent menu closing over the gap */
        .dropdown-content::before {
            content: "";
            position: absolute;
            top: -15px;
            left: 0;
            width: 100%;
            height: 15px;
            background: transparent;
        }

        @keyframes navFadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .dropdown-content a {
            color: #333;
            padding: 12px 20px;
            text-decoration: none;
            display: block;
            text-align: left;
            font-size: 14px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .dropdown-content a:hover {
            background-color: #f4f7fa;
            color: #21468B;
            padding-left: 25px;
        }

        .nav-item:hover .dropdown-content {
            display: block;
        }

        /* Mobile adjustments (example) */
        @media screen and (max-width: 600px) {
            .navbar {
                flex-direction: column;
                align-items: left;
            }

            .nav-item {
                width: 100%;
            }

            .nav-item>a {
                text-align: left;
            }

            .dropdown-content {
                position: relative;
                left: 0;
                transform: none;
                width: 100%;
                box-shadow: none;
            }

            .nav-item:hover .dropdown-content {
                display: none;
            }

            .nav-item.show .dropdown-content {
                display: block;
            }

            .nav-item.show {
                background-color: #ddd;
                color: black;
            }

            .nav-item.show>a {
                color: black;
                background-color: #ddd;
            }
        }

        @media print {
            body {
                font-size: 12pt;
                /* Adjust font size for printing */
                line-height: 1.5;
            }

            /* Hide elements not needed for printing */
            .no-print {
                display: none;
            }

            #competitors-ranking,
            #competitorsOutput {
                height: auto;
            }

            /* Add margins for each page (important for printing) */
            @page {
                margin: 1cm;
                /* Adjust margins as needed */
            }

            /* Force page breaks where needed */
            .page-break {
                page-break-before: always;
            }

            .navbar {
                position: static;
                width: 100%;
            }

            .column,
            .column40,
            .column50,
            .column60 {
                width: 100%;
            }

            #SEM .column {
                width: 100%;
            }
        }

        .competitor-insights-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #1a73e8;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .competitor-insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .competitor-card {
            background: #f8fafd;
            border: 1px solid #e1e8f5;
            border-radius: 8px;
            padding: 15px;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: visible;
        }

        .competitor-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 76, 157, 0.08);
        }

        .competitor-card-url {
            font-size: 0.85em;
            color: #004c9d;
            text-decoration: none;
            word-break: break-all;
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .competitor-card-url:hover {
            text-decoration: underline;
        }

        .competitor-table tr {
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .competitor-table tr:hover {
            background-color: #f8f9fa;
        }

        .competitor-table tr.selected {
            background-color: #e3f2fd !important;
            border-left: 4px solid #1a73e8;
        }

        .competitor-table tr.selected td {
            font-weight: 600;
            color: #1a73e8;
        }

        .competitor-table tr.ai-picked {
            background-color: #f3e5f5 !important;
            border-left: 4px solid #9c27b0;
        }

        .competitor-table tr.ai-picked td {
            font-weight: 600;
            color: #7b1fa2;
        }

        .topic-legend {
            display: flex;
            gap: 15px;
            font-size: 0.8em;
            margin-top: 10px;
            justify-content: flex-end;
            color: #666;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .competitor-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
            background: #fff;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #e1e8f5;
        }

        .competitor-table th {
            background: #004c9d;
            color: white;
            text-align: left;
            padding: 6px 8px;
            border-bottom: 1px solid #003a7a;
            font-weight: 600;
            font-size: 11px;
        }

        .competitor-table td {
            padding: 4px 8px;
            border-bottom: 1px dotted #eee;
            color: #444;
        }

        .competitor-table tr:last-child td {
            border-bottom: none;
        }

        .competitor-table .word-count-cell {
            text-align: right;
            color: #888;
            font-family: monospace;
        }

        .gap-analysis-container {
            background: #f0f7ff;
            border: 1px solid #c2e0ff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            font-size: 0.95em;
            color: #333;
            line-height: 1.6;
        }

        .gap-analysis-header {
            font-weight: 600;
            color: #004c9d;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1em;
        }

        .gap-analysis-results {
            white-space: pre-wrap;
            margin-bottom: 15px;
        }

        .gap-analysis-textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            border: 1px solid #c2e0ff;
            border-radius: 6px;
            font-size: 0.9em;
            line-height: 1.5;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 15px;
            background: #fff;
            color: #333;
        }

        .btn-rewrite-suggestions {
            background: linear-gradient(135deg, #34a853, #2d8e47);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(52, 168, 83, 0.2);
        }

        .btn-rewrite-suggestions:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(52, 168, 83, 0.3);
        }

        .btn-rewrite-suggestions:disabled {
            background: #ccc;
            box-shadow: none;
            cursor: not-allowed;
        }

        /* Review Mode / Diff Styles */
        .review-bar {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-radius: 8px 8px 0 0;
        }

        .review-bar-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-review {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: opacity 0.2s;
        }

        .btn-accept-rewrite {
            background: #34a853;
            color: white;
        }

        .btn-reject-rewrite {
            background: #ea4335;
            color: white;
        }

        .btn-review:hover {
            opacity: 0.9;
        }

        .diff-added {
            background-color: #fff9c4;
            /* Soft yellow for additions */
            padding: 2px 0;
        }

        .diff-removed {
            background-color: #ffcdd2;
            /* Soft red for removals */
            color: #b71c1c;
            text-decoration: line-through;
            padding: 2px 0;
        }

        #editorContent.review-mode {
            background-color: #fafafa;
        }

        /* GSC Masterclass Styles */
        .gsc-masterclass-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .masterclass-section {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .masterclass-section h3 {
            margin-top: 0;
            color: #1967d2;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #e8f0fe;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .step-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .step-item {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .step-item:hover {
            background: #f8f9fa;
        }

        .step-number {
            background: #1a73e8;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
            color: white;
        }

        .step-content strong {
            display: block;
            color: #3c4043;
            margin-bottom: 3px;
        }

        .step-content p {
            margin: 0;
            font-size: 13.5px;
            color: #5f6368;
            line-height: 1.5;
        }

        .masterclass-table-container {
            margin-top: 15px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #eee;
        }

        /* Actionables Enhancements */
        .actionable-collapsible-content {
            display: none;
            padding-top: 5px;
        }

        .actionable-collapsible-content.active {
            display: block;
        }

        .masterclass-section h3 {
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: color 0.2s;
        }

        .masterclass-section h3:hover {
            color: #1a73e8;
        }

        .masterclass-section h3::after {
            content: '\f107';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            margin-left: auto;
            transition: transform 0.3s;
            font-size: 14px;
            color: #5f6368;
        }

        .masterclass-section h3.active::after {
            transform: rotate(180deg);
        }

        .actionable-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            padding: 10px;
            border-top: 1px solid #eee;
            background: #fafafa;
        }

        .actionable-page-btn {
            background: #fff;
            border: 1px solid #dadce0;
            color: #3c4043;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .actionable-page-btn:hover:not(:disabled) {
            background: #f1f3f4;
            border-color: #bdc1c6;
        }

        .actionable-page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .action-tooltip-trigger {
            border-bottom: 1px dotted #1a73e8;
            cursor: help;
            color: #1a73e8;
        }

        .masterclass-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .masterclass-table th {
            background: #1a73e8;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            color: #ffffff;
            border-bottom: 1px solid #1557b0;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .masterclass-table th:hover {
            background: #1557b0;
        }

        .masterclass-table th i {
            margin-left: 5px;
            font-size: 11px;
            opacity: 0.8;
        }

        .masterclass-table td {
            padding: 10px;
            border-bottom: 1px solid #f1f3f4;
            color: #5f6368;
            vertical-align: top;
        }

        .badge-striking {
            background: #e6f4ea;
            color: #1e8e3e;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 11px;
        }

        .badge-opportunity {
            background: #e8f0fe;
            color: #1967d2;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 11px;
        }

        .badge-action {
            background: #feeef3;
            color: #c5221f;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 11px;
        }

        .competitor-card-rank {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #1a73e8;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 2;
        }

        .competitor-card-toggle {
            display: flex;
            background: #f1f3f4;
            border-radius: 4px;
            margin-bottom: 12px;
            padding: 2px;
        }

        .competitor-card-toggle button {
            flex: 1;
            border: none;
            background: none;
            padding: 5px;
            font-size: 10px;
            cursor: pointer;
            border-radius: 3px;
            color: #666;
            transition: all 0.2s;
        }

        .competitor-card-toggle button.active {
            background: #fff;
            color: #1a73e8;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            font-weight: bold;
        }

        .design-insights-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
        }

        .design-insights-table th,
        .design-insights-table td {
            padding: 4px;
            border-bottom: 1px solid #f1f3f4;
            text-align: left;
        }

        .design-insights-table th {
            background: #004c9d;
            color: white;
            text-align: left;
            padding: 6px 8px;
            border-bottom: 1px solid #003a7a;
            font-weight: 600;
            font-size: 11px;
        }

        .design-insights-table td {
            padding: 4px 8px;
            border-bottom: 1px solid #f1f3f4;
            text-align: left;
            font-size: 11px;
        }

        .btn-design-audit-toggle {
            background: #f1f3f4;
            border: 1px solid #ddd;
            color: #444;
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 10px;
            width: 100%;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-design-audit-toggle:hover {
            background: #e8eaed;
        }

        .btn-design-audit-toggle.active {
            background: #004c9d;
            color: white;
            border-color: #004c9d;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 1px 5px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: bold;
        }

        .status-present {
            background: #e6f4ea;
            color: #1e8e3e;
        }

        .status-absent {
            background: #fce8e6;
            color: #d93025;
        }

        .competitor-card {
            position: relative;
            /* Ensure rank badge is positioned correctly */
            min-height: 120px;
            display: flex;
            flex-direction: column;
        }

        .competitor-card-retry-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            text-align: center;
        }

        .competitor-card-retry-btn {
            background: linear-gradient(135deg, #1a73e8, #004c9d);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: opacity 0.2s;
        }

        .competitor-card-retry-btn:hover {
            opacity: 0.9;
        }

        .competitor-card-retry-btn i {
            font-size: 0.8em;
        }
    </style>
</head>

<body>

    <div id="loginForm">
        <div id="googleSignInButton"></div>
        <p id="loginError" style="color: red;"></p>
    </div>

    <div class="navbar">
        <div class="logo-container" id="logo" style="cursor: pointer;" onclick="window.location.reload()">
            <img src="Digimetrics Logo-02.png" alt="MediaOne Logo">
        </div>

        <div class="nav-item" id="seoNavItem">
            <a href="#" onclick="showSeoOnly(event)">SEO</a>
            <div class="dropdown-content">
                <a href="#keywordAnalysis" onclick="openKeywordAnalysis(event)">Keyword Analysis</a>
                <a href="#crawlerSimulator" onclick="openCrawlerSimulator(event)">Google Crawler Simulator</a>
                <a href="#technicalSeo" onclick="openTechnicalSeo(event)">Technical SEO</a>
                <a href="#contentComparison" onclick="openContentComparison(event)">Competitor Content Comparison &
                    Recommendations</a>
                <a href="#schemaGeneratorButton" onclick="openSchemaGenerator(event)">Schema Generator</a>
                <a href="#onPageSection" onclick="openOnPage(event)"> On-Page Optimisation</a>
                <a href="#rankCheckerSection" onclick="openRankChecker(event)">Rank Checker</a>
            </div>
        </div>

        <div class="nav-item" id="smmNavItem">
            <a href="#" onclick="showSmmOnly(event)">SMM</a>
            <div class="dropdown-content">
                <a href="#socialMediaStrategy" onclick="openSocialMediaStrategy(event)">Social Media Strategy House</a>
                <a href="#pillarFrameworkContent" onclick="openPillarFramework(event)">Content Pillar Framework</a>
                <a href="#contentGenerator" onclick="openContentGenerator(event)">Social Media Content Generator</a>
                <a href="#responseGenerator" onclick="openResponseGenerator(event)">Social Media Response Generator</a>
            </div>
        </div>

        <div class="nav-item">
            <a href="#" onclick="showSemOnly(event)">SEM</a>
        </div>

        <div class="nav-item">
            <a href="#" onclick="openGeoUtilities(event)">GEO</a>
        </div>

        <div class="nav-item" id="othersNavItem">
            <a href="#" onclick="showOthersOnly(event)">Others</a>
            <div class="dropdown-content">
                <a href="#" onclick="openCompetitors(event)">Competitors Identifier</a>
                <a href="#personaContent" onclick="openPersona(event)">Persona Generator</a>
                <a href="#mediaplan" onclick="openMediaPlan(event)">Media Plan</a>
                <a href="#" onclick="openContentCheck(event)">Content Check</a>
                <a href="#" onclick="openLandingPageAudit(event)">Landing Page Audit</a>
                <a href="#" onclick="openAiContentOptimiser(event)">AI Content Optimiser</a>
                <a href="#" onclick="openGscIntegration(event)">Google Search Console</a>
            </div>
        </div>

        <div class="nav-item" id="uat">
            <a href="/uat.html" target="_blank">UAT</a>
        </div>

        <div class="nav-item" id="exporPdf">
            <a href="#" onclick="exportToPdf(event)">PDF</a>
        </div>

        <div class="nav-item" id="mangoolsQuota">
            <a href="#" onclick="checkMangoolsQuota(event)">Credits</a>
        </div>

        <div class="nav-item" id="logoutNavItem">
            <a href="#" onclick="logout(event)">Logout</a>
        </div>


    </div>

    <div id="loadingModal" class="loading-modal">
        <div class="loading-modal-content">
            <div class="loader"></div>
            <p>Loading, please wait...</p>
        </div>
    </div>

    <div id="main-content">

        <div id="chatbot-modal">
            <div class="conversation-picker">
                <div class="chat-header">
                    <h2>History</h2>
                    <button id="new-chat-btn" style="background:none; border:none; color:white; cursor:pointer;"
                        onclick="startNewConversation()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="search-bar">
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search chats..."
                            onkeyup="filterConversations()">
                    </div>
                </div>
                <div class="conversation-list" id="conversation-list">
                    <!-- Conversations populated here -->
                </div>
            </div>
            <div class="chat-main">
                <div class="chat-header">
                    <h2 id="current-chat-title">New Conversation</h2>
                    <button id="close-chatbot"
                        style="background:none; border:none; color:white; font-size:24px; cursor:pointer;"></button>
                </div>
                <div id="chat-messages"></div>
                <!-- Typing Indicator Container -->
                <div id="typingIndicator" class="typing-indicator"
                    style="padding: 10px 20px; font-size: 0.8rem; color: #666; display: none;">
                    <span></span><span></span><span></span>
                </div>
                <div class="chat-input-container" style="flex-direction: column; align-items: stretch;">
                    <div id="attachment-preview-chat" class="attachment-preview"></div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="question-input" placeholder="Ask me anything!">
                        <button id="send-button-2"
                            style="background: var(--accent-blue); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Modal -->
        <div id="image-modal-chat" class="image-modal">
            <span class="close-modal" id="close-modal-chat">&times;</span>
            <img class="modal-content" id="modal-img-chat">
        </div>

        <div id="journey-modal" class="feedback-modal">
            <div class="feedback-modal-content">
                <span class="journey-close" onclick="closeJourneyModal()"></span>
                <h2>Digimetrics Journey</h2>
                <button type="button" class="journey-collapsible" data-total-steps="7" data-completed-steps="0">
                    <div class="progress-bar-container">
                        <div class="progress-bar"></div>
                    </div>
                    <span class="journey-collapsible-text">Steps 1 - 7</span>
                </button>
                <div class="content">
                    <div class="process">
                        <div class="step">
                            <div class="step-number">01</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">02</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">03</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">04</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">05</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">06</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">07</div>
                        </div>
                    </div>

                    <div class="step-card-row">
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-search"></i>
                                <div class="step-title" onclick="openKeywordAnalysis(event)">Generate Keywords From Seed
                                    Keywords</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-globe"></i>
                                <div class="step-title" onclick="openKeywordAnalysis(event)">Get Ranking Keywords /
                                    Keywords Based on Webpage Content</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-clock"></i>
                                <div class="step-title" onclick="openKeywordAnalysis(event)">Get Keywords' Time To Rank
                                </div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-tools"></i>
                                <div class="step-title" onclick="openTechnicalSeo(event)">Technical SEO Audit</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-balance-scale"></i>
                                <div class="step-title" onclick="openContentComparison(event)">Competitor Content
                                    Comparison & Recommendations</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-file-code"></i>
                                <div class="step-title" onclick="openOnPage(event)">On-Page SEO</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-signal"></i>
                                <div class="step-title" onclick="openRankChecker(event)">Rank Checker</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- journey-collapsible Section 2: Steps 8-14 -->
                <button type="button" class="journey-collapsible" data-total-steps="7" data-completed-steps="0">
                    <div class="progress-bar-container">
                        <div class="progress-bar"></div>
                    </div>
                    <span class="journey-collapsible-text">Steps 8 - 14</span>
                </button>
                <div class="content">
                    <div class="process">
                        <div class="step">
                            <div class="step-number">08</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">09</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">10</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">11</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">12</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">13</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">14</div>
                        </div>
                    </div>

                    <div class="step-card-row">
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-sitemap"></i>
                                <div class="step-title" onclick="openSchemaGenerator(event)">Schema Generator</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-user-friends"></i>
                                <div class="step-title" onclick="openCompetitors(event)">Competitors Identifier</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-id-card"></i>
                                <div class="step-title" onclick="openPersona(event)">Persona Generator</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-bullhorn"></i>
                                <div class="step-title" onclick="openMediaPlan(event)">Media Plan</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-edit"></i>
                                <div class="step-title" onclick="openContentGenerator(event)">Content Generator</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-clipboard-check"></i>
                                <div class="step-title" onclick="openContentCheck(event)">Content Checker</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-home"></i>
                                <div class="step-title" onclick="openLandingPageAudit(event)">Landing Page Audit</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- journey-collapsible Section 2: Steps 15- -->
                <button type="button" class="journey-collapsible" data-total-steps="7" data-completed-steps="0">
                    <div class="progress-bar-container">
                        <div class="progress-bar"></div>
                    </div>
                    <span class="journey-collapsible-text">Steps 15 -</span>
                </button>
                <div class="content">
                    <div class="process">
                        <div class="step">
                            <div class="step-number">15</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">16</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">17</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">18</div>
                        </div>
                    </div>

                    <div class="step-card-row">
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-ad"></i>
                                <div class="step-title" onclick="openSem(event)">SEM Ad Generator</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-magic"></i>
                                <div class="step-title" onclick="openAiContentOptimiser(event)">AI Content Optimiser
                                </div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-flask"></i>
                                <div class="step-title">Step 17</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-map-signs"></i>
                                <div class="step-title">Step 18</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="seoSection">
            <button class="collapsible" id="seo"><i class="fas fa-plus-square"></i><i class="fab fa-google"></i>Search
                Engine Optimisation (SEO)</button>
            <div class="content">

                <!-- Modal for Content Comparison Queries -->
                <div id="contentComparisonkModal" class="queries-modal" style="display:none">
                    <div class="queries-modal-content">
                        <span class="close" onclick="closeContentComparisonQueriesModal()"></span>
                        <h2>Previous Content Comparison Queries</h2>
                        <div id="content_comparison_loading"
                            style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; /* Adjust height as needed */">
                            <img src="https://usagif.com/wp-content/uploads/loading-73.gif" alt="Loading..."
                                style="width: 100px; height: 100px;">
                            <p style="text-align: center;">Loading queries...</p>
                        </div>

                        <table id="contentComparisonQueriesTable">
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>Date</th>
                                    <th>URL</th>
                                    <th>Keywords</th>
                                    <th>User</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Queries will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Modal for Previous Time To Rank Queries -->
                <div id="timeToRankModal" class="queries-modal" style="display:none">
                    <div class="queries-modal-content">
                        <span class="close" onclick="closeTimeToRankQueriesModal()"></span>
                        <h2>Previous Time To Rank Queries</h2>
                        <div id="time_to_rank_loading"
                            style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; /* Adjust height as needed */">
                            <img src="https://usagif.com/wp-content/uploads/loading-73.gif" alt="Loading..."
                                style="width: 100px; height: 100px;">
                            <p style="text-align: center;">Loading queries...</p>
                        </div>

                        <table id="timeToRankQueriesTable">
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>Date</th>
                                    <th>URL</th>
                                    <th>Keywords</th>
                                    <th>User</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Queries will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Modal for Previous On-Page Queries -->
                <div id="queriesModal" class="queries-modal" style="display:none">
                    <div class="queries-modal-content">
                        <span class="close" onclick="closeQueriesModal()"></span>
                        <h2>Previous On-Page Queries</h2>

                        <div id="on_page_loading"
                            style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; /* Adjust height as needed */">
                            <img src="https://usagif.com/wp-content/uploads/loading-73.gif" alt="Loading..."
                                style="width: 100px; height: 100px;">
                            <p style="text-align: center;">Loading queries...</p>
                        </div>

                        <table id="queriesTable">
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>Date</th>
                                    <th>URL</th>
                                    <th>Keywords</th>
                                    <th>User</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Queries will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="feedbackModal" class="feedback-modal">
                    <div class="feedback-modal-content">
                        <span class="feedback-close"></span>
                        <h2>Feedback</h2>

                        <label for="userFeedback">Your Feedback:</label>
                        <textarea id="userFeedback"
                            style="width: 100%; height: 100px; background-color:#eef5fe;"></textarea><br>

                        <label for="checkResults">Check Results:</label>
                        <textarea id="checkResults" readonly style="width: 100%; height: 100px;"></textarea><br>

                        <label for="guidelinesURLs">URLs of Guidelines PDFs:</label>
                        <textarea id="guidelinesURLs" readonly style="width: 100%; height: 20px;"></textarea><br>

                        <label for="websiteURLs">Any other website/guidelines URLs:</label>
                        <textarea id="websiteURLs" readonly style="width: 100%; height: 20px;"></textarea><br>

                        <label for="otherInstructions">Any other instructions:</label>
                        <textarea id="otherInstructions" readonly style="width: 100%; height: 20px;"></textarea><br>

                        <label for="contentToCheck">Content to Check:</label>
                        <textarea id="contentToCheck" readonly style="width: 100%; height: 30px;"></textarea><br>

                        <button id="submitFeedbackBtn">Submit Feedback</button>
                    </div>
                </div>

                <!-- Input Form for User Data -->
                <div class="column50">
                    <div class="sem-step-card">
                        <div class="sem-card-title"><i class="fab fa-google"></i> Search Engine Optimisation</div>
                        <form id="seoForm">
                            <div class="sem-input-item">
                                <label for="domain">Domain / URL:</label>
                                <input type="url" id="domain" name="domain"
                                    placeholder="Site Audit: https://www.abc.com | Page Audit: www.abc.com"
                                    onmouseover="showTooltip(event, 'E.g.<br>https:\/\/www.example.com will target one webpage<br>www.example.com will target the entire website')"
                                    onmouseout="hideTooltip()">
                                <span class="error" id="domainError"></span>
                            </div>

                            <div class="sem-input-group" style="margin-top: 15px;">
                                <div class="sem-input-item">
                                    <label for="location">Targeted Location (required):</label>
                                    <select id="location" name="location" required>
                                        <option value="Singapore">Singapore</option>
                                        <option value="None">Global</option>
                                        <option value="Australia">Australia</option>
                                        <option value="Bhutan">Bhutan</option>
                                        <option value="Brazil">Brazil</option>
                                        <option value="Canada">Canada</option>
                                        <option value="China">China</option>
                                        <option value="France">France</option>
                                        <option value="Germany">Germany</option>
                                        <option value="Hong Kong">Hong Kong</option>
                                        <option value="India">India</option>
                                        <option value="Indonesia">Indonesia</option>
                                        <option value="Italy">Italy</option>
                                        <option value="Japan">Japan</option>
                                        <option value="Malaysia">Malaysia</option>
                                        <option value="Mexico">Mexico</option>
                                        <option value="Netherlands">Netherlands</option>
                                        <option value="Philippines">Philippines</option>
                                        <option value="South Korea">South Korea</option>
                                        <option value="Spain">Spain</option>
                                        <option value="Taiwan">Taiwan</option>
                                        <option value="Thailand">Thailand</option>
                                        <option value="United Kingdom">United Kingdom</option>
                                        <option value="United States">United States</option>
                                        <option value="Vietnam">Vietnam</option>
                                    </select>
                                </div>
                                <div class="sem-input-item">
                                    <label for="language">Language (required):</label>
                                    <select id="language" name="language" required>
                                        <option value="English">English</option>
                                        <option value="Arabic">Arabic</option>
                                        <option value="Chinese (Simplified)">Chinese (Simplified)</option>
                                        <option value="Chinese (Traditional)">Chinese (Traditional)</option>
                                        <option value="Dutch">Dutch</option>
                                        <option value="French">French</option>
                                        <option value="German">German</option>
                                        <option value="Hindi">Hindi</option>
                                        <option value="Indonesian">Indonesian</option>
                                        <option value="Italian">Italian</option>
                                        <option value="Japanese">Japanese</option>
                                        <option value="Korean">Korean</option>
                                        <option value="Malay">Malay</option>
                                        <option value="Portuguese">Portuguese</option>
                                        <option value="Russian">Russian</option>
                                        <option value="Spanish">Spanish</option>
                                        <option value="Tagalog">Tagalog</option>
                                        <option value="Tamil">Tamil</option>
                                        <option value="Thai">Thai</option>
                                        <option value="Vietnamese">Vietnamese</option>
                                    </select>
                                </div>
                            </div>

                            <div class="sem-input-item" style="margin-top: 5px;">
                                <label for="keywords">Keyword(s) of Interest (comma or newline separated):</label>
                                <textarea id="keywords" name="keywords" required placeholder="keyword1, keyword2"
                                    oninput="updateKeywordCount()" style="min-height: 120px;"></textarea>
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                                    <span id="keywordCount"
                                        style="font-size: 0.85em; color: #004c9d; font-weight: 600;"></span>
                                    <span class="error" id="keywordsError"></span>
                                </div>
                            </div>

                            <div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                                <button type="button" id="keyword-research-analysis-button" class="config-btn-highlight"
                                    style="margin: 0;" onclick="validateAndSubmit(event)">Get Time To Rank</button>
                                <button type="button" id="mapKeywordsBtn" class="config-btn-highlight"
                                    style="background: #34a853; margin: 0;" onclick="mapKeywords()">Map
                                    Keywords</button>
                                <button type="button" class="config-btn-highlight" style="background: #666; margin: 0;"
                                    onclick="openTimeToRankQueriesModal()" id="loadTimeToRankQueriesBtn">Load
                                    Previous</button>
                            </div>
                        </form>
                    </div>
                    <div id="rankingError"></div>
                    <table id="keywordTable" style="display: none;">
                        <tr>
                            <th>Keyword</th>
                            <th>Search Volume</th>
                            <th>Competition</th>
                            <th>Rank</th>
                        </tr>
                    </table>

                    <table id="top100Table" style="display: none;">
                        <tr>
                            <th>Keyword</th>
                            <th>Search Volume</th>
                            <th>Competition</th>
                            <th>Rank</th>
                        </tr>
                    </table>
                    <button class="collapsible-plus" id="expandSimilarKeywords"><i
                            class="fas fa-plus-square"></i></button>
                    <button class="collapsible90" id="keyword_suggestions" onclick="similarKeywords(event)">Keyword
                        Suggestions (Similar Keywords / SERPs)
                    </button>
                    <div class="content" id="keywordSuggestions">
                        <div id="keywordListContainer">
                            <div class="table-container"
                                style="max-height: 250px; overflow-y: auto; overflow-x: hidden;">
                                <table id="keywordListTable" class="uniform-kw-table fixed-layout">
                                    <thead id="keywordHeaderRow">
                                        <tr>
                                            <th class="col-kw" onclick="sortKeywordSuggestions(0)"
                                                title="Click on the keyword to see it's SERPs.">Keyword</th>
                                            <th class="col-vol" onclick="sortKeywordSuggestions(1)">Search Vol</th>
                                            <th class="col-comp" onclick="sortKeywordSuggestions(2)">Difficulty</th>
                                            <th class="col-cpc" onclick="sortKeywordSuggestions(3)">CPC</th>
                                            <th class="col-choose">Choose</th>
                                        </tr>
                                    </thead>
                                    <tbody id="keywordList"></tbody>
                                </table>
                            </div>
                            <div id="keywordSuggestionsExport" style="display:none">
                                <button type="button"
                                    onclick="exportSelectedKeywordSuggestionsToCSV(document.getElementById('keywordHeaderRow'), document.getElementById('keywordList'))">Export
                                    selected as
                                    .csv</button>
                                <button type="button"
                                    onclick="exportKeywordSuggestionsToCSV(document.getElementById('keywordHeaderRow'), document.getElementById('keywordList'))">Export
                                    all as
                                    .csv</button>
                            </div>
                        </div>
                    </div>

                    <br>
                    <button class="collapsible-plus" id="expandRankingKeywords"><i
                            class="fas fa-plus-square"></i></button>
                    <button class="collapsible90" id="ranking_keywords" onclick="rankingKeywords(event)">Ranking
                        Keywords</button>
                    <div class="content" id="rankingKeywords">
                        <div id="rankedKeywordsCount"></div>
                        <div id="keywordListContainer">
                            <div class="table-container"
                                style="max-height: 250px; overflow-y: auto; overflow-x: hidden;">
                                <table id="rankedKeywordListTable" class="uniform-kw-table fixed-layout">
                                    <thead id="rankedKeywordHeaderRow">
                                        <tr>
                                            <th class="col-kw" onclick="sortRankedKeywords(0)">Keyword</th>
                                            <th class="col-vol" onclick="sortRankedKeywords(1)">Search Vol</th>
                                            <th class="col-rank" onclick="sortRankedKeywords(2)">Rank</th>
                                            <th class="col-comp" onclick="sortRankedKeywords(3)">Difficulty</th>
                                            <th class="col-choose">Choose</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rankedKeywordList"></tbody>
                                </table>
                            </div>
                            <div id="rankingKeywordsExport" style="display:none">
                                <button type="button"
                                    onclick="exportSelectedRankedKeywordsToCSV(document.getElementById('rankedKeywordHeaderRow'), document.getElementById('rankedKeywordList'))">Export
                                    selected as
                                    .csv</button>
                                <button type="button"
                                    onclick="exportRankedKeywordsToCSV(document.getElementById('rankedKeywordHeaderRow'), document.getElementById('rankedKeywordList'))">Export
                                    all as
                                    .csv</button>
                            </div>
                        </div>
                    </div>
                    <br>
                    <button class="collapsible-plus" id="expandWebpageKeywords"><i
                            class="fas fa-plus-square"></i></button>
                    <button class="collapsible90" id="keywords_for_site" onclick="getWebpageKeywords(event)">Keywords
                        Based
                        on Webpage Content</button>
                    <div class="content" id="siteKeywords" style="padding:10px">
                    </div>
                </div>

                <div class="column50">
                    <div class="sem-step-card" id="serp-section"></div>
                </div>

                <div id="keywordMappingSection">
                    <hr>
                    <button class="collapsible" id="keyword_mapping"><i class="fas fa-plus-square"></i>Keyword
                        Mapping</button>
                    <div class="content" id="keywordMapping">
                        <button id="addListBtn">Add New URL</button>
                        <button id="undoBtn" disabled>Undo Delete</button>
                        <div class="container" id="listsContainer"></div>
                        <div id="recommendations"></div>
                    </div>
                    <hr>
                </div>
                <div id="metaDataSection">
                    <button class="collapsible" id="meta_data"><i class="fas fa-plus-square"></i>Meta Data</button>
                    <div class="content" id="metaData">
                        <p><b>Meta Title: </b><span id="targetTitle">-</span></p>
                        <p><b>Meta Description: </b><span id="targetDescription">-</span></p>
                        <p><b>h1 Header: </b><span id="targetH1">-</span></p>
                    </div>
                    <hr>
                </div>

                <div id="domainMetricsSection">
                    <button class="collapsible" id="domain_metrics"><i class="fas fa-plus-square"></i>Domain Metrics
                        (DA,
                        PA,
                        PageSpeed)</button>
                    <div class="content" id="domainMetrics">
                        <div class="column">
                            <p><b>Domain Authority (DA): </b><span id="da">-</span></p>
                            <p><b>Page Authority (PA): </b><span id="pa">-</span></p>
                            <p><b>Backlinks Spam Score: </b><span id="targetSpamScore">-</span></p>
                            <p><b>Backlinks: </b><span id="targetBacklinks">-</span></p>
                            <p><b>Referring Domains: </b><span id="targetRefDomains">-</span></p>
                            <p><b>Page Word Count: </b><span id="targetWordCount">-</span></p>
                        </div>
                        <div class="column">
                            <p><b>Internal Links: </b><span id="targetInternalLinks">-</span></p>
                            <p><b>External Links: </b><span id="targetExternalLinks">-</span></p>
                            <p><b>Flesch Readability: </b><span id="targetReadability">-</span></p>
                            <p><b>Images: </b><span id="targetImages">-</span></p>
                            <p><b>CLS: </b><span id="targetCls">-</span></p>
                            <p><b>LCP: </b><span id="targetLcp">-</span></p>
                            <p><b>FID: </b><span id="targetFid">-</span></p>
                            <p><b>Schema: </b><span id="targetSchema">-</span></p>
                        </div>
                        <div style="clear: both;"></div>
                        <div> </div> <!-- Clearfix -->
                    </div>
                    <hr>
                </div>
                <div id="keywordAnalysisSection">
                    <div class="page-break"></div>
                    <button class="collapsible" id="keywordAnalysisBtn"><i class="fas fa-plus-square"></i>Keyword
                        Analysis</button>
                    <div class="content" id="keywordAnalysis">
                        <div id="overall-summary" style="display:none;"></div>
                        <div id="keyword-analysis-results">
                            <!-- Collapsible sections for each keyword analysis will be added here -->
                        </div>
                    </div>
                    <hr>
                </div>
                <div id="crawlerSimulatorSection">
                    <div class="page-break"></div>
                    <div class="content" id="crawlerSimulator">
                        <div class="sem-step-card">
                            <div class="sem-card-title"><i class="fas fa-spider"></i> Crawler Configuration</div>
                            <div class="sem-input-group">
                                <div class="sem-input-item">
                                    <label for="google-simulator-url">Enter URL:</label>
                                    <input type="url" id="google-simulator-url" placeholder="https://example.com">
                                </div>
                            </div>
                            <button id="simulatorBtn" class="config-btn-highlight" style="margin: 0;"
                                onclick="googleCrawlerSimulator()">Analyse</button>
                        </div>
                        <div id="simulatorError" style="color: red;"></div>
                        <div id="crawler-simulator-results" style="display: none;">
                            <h3>Meta Information</h3>
                            <table id="meta-table">
                                <thead>
                                    <tr>
                                        <th>Property</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Meta Title</td>
                                        <td id="simulator-meta-title"></td>
                                    </tr>
                                    <tr>
                                        <td>Meta Description</td>
                                        <td id="simulator-meta-description"></td>
                                    </tr>
                                    <tr>
                                        <td>Canonical Tag</td>
                                        <td id="simulator-canonical-tag"></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="column40" id="keyword-density-section">
                                <h3>Keyword Density</h3>
                                <div id="keyword-density"
                                    style="max-height: 1000px; overflow-y: scroll; text-align: center;">
                                </div>
                            </div>
                            <div></div>
                            <div class="column60">
                                <h3>Page Text</h3>
                                <div id="simulatorPageText"
                                    style="max-height: 1000px; overflow-y: scroll; padding:10px">
                                </div>
                            </div>
                            <div class="page-break"></div>
                            <div style="clear: both;"></div>
                            <div> </div> <!-- Clearfix -->
                            <h3>Headers</h3>
                            <table id="headers-table">
                                <thead>
                                    <tr>
                                        <th>Header</th>
                                    </tr>
                                </thead>
                                <tbody id="simulator-headers-body">
                                </tbody>
                            </table>

                            <div class="page-break"></div>
                            <!-- Page break before Links -->
                            <h3>Links</h3>
                            <table id="links-table">
                                <thead>
                                    <tr>
                                        <th>Link Type</th>
                                        <th>URL</th>
                                        <th>Link Text</th>
                                    </tr>
                                </thead>
                                <tbody id="simulator-links-body">
                                </tbody>
                            </table>


                            <h3>Image Alt Text</h3>
                            <table id="image-alt-table">
                                <thead>
                                    <tr>
                                        <th>Thumbnail</th>
                                        <th>Image URL</th>
                                        <th>Title</th>
                                        <th>Alt Text</th>
                                        <th>Size</th>
                                    </tr>
                                </thead>
                                <tbody id="simulator-image-alt-body">
                                </tbody>
                            </table>

                        </div>
                    </div>
                    <hr>
                </div>
                <div id="technicalSeoSection">
                    <div class="page-break"></div>
                    <button class="collapsible" id="technicalButton"><i class="fas fa-plus-square"></i>Technical
                        SEO</button>
                    <div class="content" id="technicalSeo">
                        <div class="sem-step-card">
                            <div class="sem-card-title"><i class="fas fa-tools"></i> Technical Audit Configuration</div>
                            <div class="sem-input-group">
                                <div class="sem-input-item">
                                    <label for="urlInput">Enter URL:</label>
                                    <input type="url" id="urlInput" placeholder="https://example.com">
                                </div>
                                <div class="sem-input-item">
                                    <label for="maxPagesInput">Max Pages to Crawl:</label>
                                    <input type="number" id="maxPagesInput" value="10" min="1">
                                    <small id="maxPagesEstimate"
                                        style="color: #666; font-size: 0.85em; margin-top: -4px;">Estimated Cost:
                                        $0.0126</small>
                                </div>
                                <div class="sem-input-item">
                                    <label for="maxDepthInput">Max Crawl Depth:</label>
                                    <input type="number" id="maxDepthInput" value="1" min="1" max="10">
                                </div>
                            </div>

                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <button id="submitBtn" class="config-btn-highlight" style="margin:0;">Analyse
                                    Website</button>
                            </div>

                            <div id="dataForSeoCost" style="display: none; width: 100%; margin-top: 15px;"></div>
                        </div>

                        <div id="auditSummary"></div>

                        <button class="collapsible" id="gtButton"><i class="fas fa-plus-square"></i>GTmetrix
                            Results</button>
                        <div class="content" id="gtMetrix">
                            <div id="gtmetrixReport" style="display:none;">
                                <table class="summary-table">
                                    <thead>
                                        <tr>
                                            <th>Metric</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Report URL</td>
                                            <td id="reportUrl"></td>
                                        </tr>
                                        <tr>
                                            <td>Cumulative Layout Shift</td>
                                            <td id="cls"></td>
                                        </tr>
                                        <tr>
                                            <td>Largest Contentful Paint</td>
                                            <td id="lcp"></td>
                                        </tr>
                                        <tr>
                                            <td>Total Blocking Time</td>
                                            <td id="tbt"></td>
                                        </tr>
                                        <tr>
                                            <td>GTmetrix Grade</td>
                                            <td id="grade"></td>
                                        </tr>
                                        <tr>
                                            <td>GTmetrix Performance Score</td>
                                            <td id="performance"></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <br><br>
                            </div>
                        </div>

                        <button class="collapsible" id="pageButton"><i class="fas fa-plus-square"></i>Page Analysis
                            Results</button>
                        <div class="content" id="pageAnalysis">
                            <div id="pageAuditReport" style="display:none;">
                                <table class="summary-table">
                                    <thead>
                                        <tr>
                                            <th>Metric</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>PageSpeed (Mobile)</td>
                                            <td id="pagespeed_audit"></td>
                                        </tr>
                                        <tr>
                                            <td>Malware</td>
                                            <td id="malware"></td>
                                        </tr>
                                        <tr>
                                            <td>robots.txt</td>
                                            <td id="robots"></td>
                                        </tr>
                                        <tr>
                                            <td>Sitemap</td>
                                            <td id="sitemap"></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <br><br>
                            </div>
                        </div>

                        <button class="collapsible" id="crawlerButton"><i class="fas fa-plus-square"></i>Crawler
                            Report</button>
                        <div class="content" id="crawlerSection">
                            <!-- Column Selector -->
                            <div id="columnSelector" class="column-selector-container" style="display:none;">
                                <div class="column-selector-header">
                                    <strong><i class="fas fa-columns"></i> Display Columns</strong>
                                </div>
                                <div class="column-selector-actions">
                                    <input type="text" class="column-search-input"
                                        placeholder="Search columns... (spaces and _ are interchangeable)"
                                        onkeyup="filterColumnList(this.value)">
                                    <button class="config-btn-highlight column-selector-btn"
                                        onclick="toggleAllColumns(true)">Select All</button>
                                    <button class="config-btn-highlight column-selector-btn" style="background: #666;"
                                        onclick="toggleAllColumns(false)">Deselect All</button>
                                </div>
                                <div id="columnCheckboxList" class="column-checkbox-list">
                                    <!-- Checkboxes will be generated dynamically -->
                                </div>
                            </div>

                            <div id="crawlerReport" style="display:none;">
                                <div class="doc-link-banner">
                                    <i class="fas fa-info-circle"></i>
                                    <span>
                                        <a href="https://docs.dataforseo.com/v3/on_page/pages/" target="_blank"
                                            rel="noopener noreferrer">
                                            Click here to see what each column means in the report
                                        </a>
                                    </span>
                                </div>
                                <table>
                                    <thead id="crawlerTableHeader">
                                        <!-- Headers will be generated dynamically -->
                                    </thead>
                                    <tbody id="crawlerTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <button id="downloadResultsBtn" onclick="downloadResultsAsXlsx()">Download results as
                            xlsx</button>
                    </div>
                    <hr>
                </div>
                <div id="contentComparisonSection">
                    <div class="page-break"></div>
                    <button class="collapsible" id="contentComparisonButton"><i class="fas fa-plus-square"></i>Content
                        Comparison</button>
                    <div class="content" id="contentComparison">
                        <div class="sem-step-card">
                            <div class="sem-card-title"><i class="fas fa-balance-scale"></i> Content Comparison Settings
                            </div>
                            <div class="sem-input-group">
                                <div class="sem-input-item">
                                    <label for="comparison-keyword">Keyword:</label>
                                    <input type="text" id="comparison-keyword" placeholder="e.g., digital marketing">
                                </div>
                                <div class="sem-input-item">
                                    <label for="comparison-domain">Target Domain or URL:</label>
                                    <input type="url" id="comparison-domain"
                                        onmouseover="showTooltip(event, 'Using this field will add this URL to the top 10 SERPs comparison.')"
                                        onmouseout="hideTooltip()" placeholder="e.g., example.com">
                                </div>
                            </div>

                            <div class="sem-input-item">
                                <label for="comparison-urls">Other Specific URLs (comma or newline separated):</label>
                                <textarea id="comparison-urls"
                                    onmouseover="showTooltip(event, 'Using this field will run the analysis based on the URLs in this field only.')"
                                    onmouseout="hideTooltip()"
                                    placeholder="https://example.com, https://another-example.com"></textarea>
                            </div>

                            <div class="sem-input-item" style="margin-top: 15px;">
                                <label>Page Types to Target:</label>
                                <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
                                    <label class="column-checkbox-item"><input type="checkbox" id="target-blogs"
                                            name="target-page-type" value="blog article"> Blog Article</label>
                                    <label class="column-checkbox-item"><input type="checkbox" id="target-product"
                                            name="target-page-type" value="product/service-page"> Product/Service
                                        Page</label>
                                    <label class="column-checkbox-item"><input type="checkbox" id="target-landing"
                                            name="target-page-type" value="landing page"> Landing Page</label>
                                    <label class="column-checkbox-item"><input type="checkbox" id="target-any"
                                            name="target-page-type" value="any" checked> Any</label>
                                </div>
                            </div>

                            <div class="sem-input-group" style="margin-top: 20px;">
                                <div class="sem-input-item">
                                    <label for="comparison-language">Language:</label>
                                    <input type="text" id="comparison-language" value="English"
                                        placeholder="e.g., English">
                                </div>
                                <div class="sem-input-item">
                                    <label for="comparison-location">Location:</label>
                                    <input type="text" id="comparison-location" value="Singapore"
                                        placeholder="e.g., Singapore">
                                </div>
                            </div>

                            <div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                                <button id="contentComparisonAnalyzeBtn" class="config-btn-highlight" style="margin: 0;"
                                    onclick="contentComparisonAnalysis()">Analyse (up to 3 mins)</button>
                                <button type="button" class="config-btn-highlight" style="background: #666; margin: 0;"
                                    onclick="openContentComparisonQueriesModal()"
                                    id="loadContentComparisonQueriesBtn">Load
                                    Previous Queries</button>
                            </div>
                        </div>
                        <div id="initial-table"></div>
                        <div id="comparison-results"></div>
                        <div id="keyword-density-content-comparison"></div>
                    </div>
                    <hr>
                </div>
                <div id="schemaGeneratorSection">
                    <div class="page-break"></div>
                    <button class="collapsible" id="schemaGeneratorButton"><i class="fas fa-plus-square"></i>Schema
                        Generator</button>
                    <div class="content" id="schema">
                        <div class="sem-step-card">
                            <div class="sem-card-title"><i class="fas fa-code"></i> Schema Configuration</div>
                            <div class="sem-input-group">
                                <div class="sem-input-item">
                                    <label for="schema-type">Schema Type:</label>
                                    <select id="schema-type">
                                        <option value="LocalBusiness">Local Business</option>
                                        <option value="Product">Product</option>
                                        <option value="Event">Event</option>
                                        <option value="Article">Article</option>
                                        <option value="BreadcrumbList">Breadcrumb</option>
                                        <option value="FAQPage">FAQ Page</option>
                                        <option value="HowTo">How-to</option>
                                        <option value="JobPosting">Job Posting</option>
                                        <option value="Organization">Organisation</option>
                                        <option value="Person">Person</option>
                                        <option value="VideoObject">Video</option>
                                        <option value="Website">Website</option>
                                        <option value="Review">Review</option>
                                        <option value="SoftwareApplication">Software Application</option>
                                        <option value="Recipe">Recipe</option>
                                        <option value="Course">Course</option>
                                        <option value="Service">Service</option>
                                    </select>
                                </div>
                            </div>

                            <div id="input-fields" class="sem-input-group" style="margin-top: 10px;"></div>
                            <div id="schema-output" style="margin-top: 20px; border-radius: 8px;"></div>
                        </div>
                    </div>
                </div>
                <div id="onPageOptimisationSection">
                    <div class="page-break"></div>
                    <button class="collapsible" id="onPageButton"><i class="fas fa-plus-square"></i>On-Page
                        Optimisation</button>
                    <div id="onPageSection" class="content">
                        <div class="sem-step-card">
                            <div class="sem-card-title"><i class="fas fa-search-dollar"></i> On-Page Audit Configuration
                            </div>
                            <div class="sem-input-group">
                                <div class="sem-input-item">
                                    <label for="on-page-url">Enter URL:</label>
                                    <input type="url" id="on-page-url" placeholder="https://example.com" required>
                                </div>
                            </div>

                            <div class="sem-input-item" style="margin-top: 15px;">
                                <label for="on-page-keywords">Enter Keywords (comma or newline separated):</label>
                                <textarea id="on-page-keywords" rows="4"
                                    placeholder="keyword1, keyword2, keyword3"></textarea>
                            </div>

                            <div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                                <button onclick="getImages()" id="getImagesBtn" class="config-btn-highlight"
                                    style="margin: 0;">Extract & Recommend</button>
                                <button type="button" onclick="openQueriesModal()" id="loadQueriesBtn"
                                    class="config-btn-highlight" style="background: #666; margin: 0;">Load
                                    Previous</button>
                                <button onclick="clearOnPageData()" class="config-btn-highlight"
                                    style="background: #dc3545; margin: 0;">Clear Data</button>
                            </div>
                        </div>
                        <button class="collapsible" id="onPageResultsCollapsible" style="display: none;">Meta Data and
                            Headings</button>
                        <div class="content" id="onPageResults"></div>
                        <button class="collapsible" id="imageCollapsible" style="display: none;">Image Alt Text</button>
                        <div class="content" id="imageRecommendations"></div>
                        <button class="collapsible" id="contentCollapsible" style="display: none;">Content</button>
                        <div class="content" id="contentRecommendations"></div>
                    </div>
                    <hr>
                </div>
                <div id="rankCheckerSection">
                    <div class="page-break"></div>
                    <button class="collapsible" id="rankCheckerButton"><i class="fas fa-plus-square"></i>Rank
                        Checker</button>
                    <div class="content" id="rankChecker">
                        <div class="sem-step-card">
                            <div class="sem-card-title"><i class="fas fa-list-ol"></i> Rank Checker Configuration</div>
                            <div class="sem-input-item">
                                <label for="rankCheckerKeywords">Keywords (one per line, up to 1,200):</label>
                                <textarea id="rankCheckerKeywords" rows="10" placeholder="Enter keywords..."></textarea>
                            </div>

                            <div class="sem-input-group" style="margin-top: 20px;">
                                <div class="sem-input-item">
                                    <label for="rankCheckerDomain">Targeted Domain / URL:</label>
                                    <input type="url" id="rankCheckerDomain" value="https://mediaonemarketing.com.sg">
                                </div>
                            </div>

                            <div class="sem-input-group">
                                <div class="sem-input-item">
                                    <label for="rankCheckerLanguage">Language:</label>
                                    <input type="text" id="rankCheckerLanguage" value="English">
                                </div>
                                <div class="sem-input-item">
                                    <label for="rankCheckerLocation">Location:</label>
                                    <input type="text" id="rankCheckerLocation" value="Singapore">
                                </div>
                            </div>

                            <div style="display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap;">
                                <button id="rankCheckerBtn" class="config-btn-highlight" style="margin: 0;"
                                    onclick="rankChecker()">Check Individual Rank</button>
                                <button id="rankCheckerBulkBtn" class="config-btn-highlight" style="margin: 0;"
                                    onclick="rankCheckerBulk()">Bulk Rank Checker</button>
                                <button type="button" class="config-btn-highlight"
                                    style="background: #34c759; margin:0;" onclick="openTimeToRankQueriesModal()">Load
                                    Previous Results</button>
                            </div>
                        </div>

                        <div id="rankCheckerResults"></div>
                        <table id="rankCheckerResultsTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Keyword</th>
                                    <th>Rank</th>
                                    <th>URL</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="page-break"></div>
            </div>
            <hr>
        </div>

        <div id="smmSection">
            <button class="collapsible" id="smm"><i class="fas fa-plus-square"></i><i
                    class="fas fa-share-alt"></i>Social
                Media (SMM)</button>
            <div class="content" id="socialMedia" style="display: none;">
                <!-- Social Media Strategy Section -->
                <section id="socialMediaStrategy">
                    <button class="collapsible" id="smsButton">
                        <i class="fas fa-plus-square"></i><i class="fas fa-chess"></i> Social Media Strategy House
                    </button>
                    <div class="content" id="socialMediaStrategyContent" style="display: none;">
                        <div class="sem-step-card">
                            <div class="sem-card-title"><i class="fas fa-chess"></i> Strategic Foundation</div>
                            <div class="sem-input-group">
                                <div class="sem-input-item">
                                    <label for="brand_context">Brand Context:</label>
                                    <textarea id="brand_context"
                                        placeholder="Who is the brand, what does it do..."></textarea>
                                </div>
                                <div class="sem-input-item">
                                    <label for="strategic_ambition">Strategic Ambition:</label>
                                    <textarea id="strategic_ambition"
                                        placeholder="What does the brand want to be known for..."></textarea>
                                </div>
                            </div>

                            <div class="sem-input-item" style="margin-top: 15px;">
                                <label for="strategic_challenge">Core Strategic Challenge:</label>
                                <textarea id="strategic_challenge"
                                    placeholder="What is currently limiting the brand..."></textarea>
                            </div>

                            <div class="sem-input-group" style="margin-top: 20px;">
                                <div class="sem-input-item">
                                    <label for="priority_audiences">Priority Audiences (Max 3):</label>
                                    <input type="text" id="priority_audiences"
                                        placeholder="e.g. CMOs, Content Managers, SME Owners">
                                </div>
                            </div>

                            <div class="sem-input-item" style="margin-top: 15px;">
                                <label for="sms_files">Supporting Documents (PDF/DOCX):</label>
                                <input type="file" id="sms_files" multiple accept=".pdf,.docx"
                                    style="margin-top: 10px;">
                                <div id="sms_file_list" style="font-size: 11px; margin-top: 5px; color: #666;">
                                </div>
                            </div>

                            <div class="sem-input-item" style="margin-top: 15px;">
                                <label for="proof_points">Proof Points & Constraints:</label>
                                <textarea id="proof_points"
                                    placeholder="What can the brand credibly prove..."></textarea>
                            </div>

                            <button id="generateSmsBtn" class="config-btn-highlight" style="margin-top: 30px;"
                                onclick="generateSocialMediaStrategy()">
                                <i class="fas fa-magic"></i> Generate Strategy House
                            </button>
                        </div>

                        <div id="sms-results-display" style="display: none; margin-top: 40px;">
                            <hr>
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="color: #004c9d; margin: 0;"><i class="fas fa-home"></i> Strategic
                                    Framework
                                    Output</h3>
                                <button class="btn-gradient btn-seo" onclick="copyToClipboard('sms-output-text', event)"
                                    style="max-width: 120px; font-size: 13px; padding: 8px;">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <div id="sms-output-text" class="html-output">
                                <!-- Strategy House Template -->
                                <div id="sms-house-container" class="strategy-house" style="display: none;">
                                    <div class="house-roof" id="house-positioning"></div>
                                    <div class="house-objectives" id="house-objectives">
                                        <div class="objective-bar"></div>
                                        <div class="objective-bar"></div>
                                        <div class="objective-bar"></div>
                                    </div>
                                    <div class="house-methods">
                                        <div class="method-pillar">Inspire</div>
                                        <div class="method-pillar">Cultivate</div>
                                        <div class="method-pillar">Connect</div>
                                        <div class="method-pillar">Amplify</div>
                                    </div>
                                </div>

                                <!-- Strategy Grid Template -->
                                <table id="sms-grid-container" class="strategy-grid" style="display: none;">
                                    <thead>
                                        <tr>
                                            <th colspan="4" class="grid-primary-goal" id="grid-primary-goal"></th>
                                        </tr>
                                        <tr>
                                            <th class="grid-method">Inspire</th>
                                            <th class="grid-method">Cultivate</th>
                                            <th class="grid-method">Connect</th>
                                            <th class="grid-method">Amplify</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr id="grid-strategies">
                                            <td class="grid-strategy"></td>
                                            <td class="grid-strategy"></td>
                                            <td class="grid-strategy"></td>
                                            <td class="grid-strategy"></td>
                                        </tr>
                                        <tr id="grid-audiences">
                                            <td class="grid-audience"></td>
                                            <td class="grid-audience"></td>
                                            <td class="grid-audience"></td>
                                            <td class="grid-audience"></td>
                                        </tr>
                                        <tr id="grid-pillars">
                                            <td class="grid-pillars"></td>
                                            <td class="grid-pillars"></td>
                                            <td class="grid-pillars"></td>
                                            <td class="grid-pillars"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <hr id="pillar_hr" style="display: none;">
                <!-- Strategic Content Pillar Framework -->
                <button class="collapsible" id="pillarFrameworkButton">
                    <i class="fas fa-plus-square"></i><i class="fas fa-layer-group"></i> Content Pillar Framework
                </button>
                <div class="content" id="pillarFrameworkContent">
                    <div class="sem-step-card">
                        <div class="sem-card-title"><i class="fas fa-briefcase"></i> Business & Commercial Context
                        </div>

                        <div class="sem-input-group">
                            <div class="sem-input-item">
                                <label for="pillar_business_model"><i class="fas fa-industry"></i> Business
                                    Model:</label>
                                <select id="pillar_business_model">
                                    <option value="B2B">B2B</option>
                                    <option value="B2C">B2C</option>
                                    <option value="B2G">B2G</option>
                                    <option value="Hybrid">Hybrid</option>
                                </select>
                            </div>
                        </div>

                        <div class="sem-input-item">
                            <label><i class="fas fa-bullseye"></i> Primary Business Objectives (Select max
                                2):</label>
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-top: 10px;">
                                <label class="column-checkbox-item"><input type="checkbox" name="pillar_objective"
                                        value="Lead generation"> Lead generation</label>
                                <label class="column-checkbox-item"><input type="checkbox" name="pillar_objective"
                                        value="Direct sales"> Direct sales</label>
                                <label class="column-checkbox-item"><input type="checkbox" name="pillar_objective"
                                        value="Brand authority"> Brand authority</label>
                                <label class="column-checkbox-item"><input type="checkbox" name="pillar_objective"
                                        value="Trust & credibility"> Trust & credibility</label>
                                <label class="column-checkbox-item"><input type="checkbox" name="pillar_objective"
                                        value="Retention"> Retention / repeat purchase</label>
                                <label class="column-checkbox-item"><input type="checkbox" name="pillar_objective"
                                        value="Recruitment"> Recruitment / employer branding</label>
                            </div>
                        </div>
                    </div>

                    <div class="sem-step-card">
                        <div class="sem-card-title"><i class="fas fa-users"></i> Audience & Decision Context</div>
                        <div class="sem-input-group">
                            <div class="sem-input-item">
                                <label for="pillar_audience_type"><i class="fas fa-user-friends"></i> Primary
                                    Audience:</label>
                                <select id="pillar_audience_type">
                                    <option value="Individual consumers">Individual consumers</option>
                                    <option value="SME decision-makers">SME decision-makers</option>
                                    <option value="Enterprise stakeholders">Enterprise / senior stakeholders
                                    </option>
                                    <option value="Mixed audiences">Mixed audiences</option>
                                </select>
                            </div>
                            <div class="sem-input-item">
                                <label for="pillar_complexity"><i class="fas fa-brain"></i> Decision
                                    Complexity:</label>
                                <select id="pillar_complexity">
                                    <option value="Low (impulse)">Low (impulse / low consideration)</option>
                                    <option value="Medium (comparison)">Medium (comparison-based)</option>
                                    <option value="High (trust-heavy)">High (trust-heavy / multi-touch)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="sem-step-card">
                        <div class="sem-card-title"><i class="fas fa-hashtag"></i> Platform Strategy & Risk</div>
                        <div class="sem-input-item">
                            <label><i class="fas fa-share-alt"></i> Active Platforms:</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
                                <label class="column-checkbox-item"><input type="checkbox" name="pillar_platform"
                                        value="LinkedIn"> LinkedIn</label>
                                <label class="column-checkbox-item"><input type="checkbox" name="pillar_platform"
                                        value="Instagram"> Instagram</label>
                                <label class="column-checkbox-item"><input type="checkbox" name="pillar_platform"
                                        value="TikTok"> TikTok</label>
                                <label class="column-checkbox-item"><input type="checkbox" name="pillar_platform"
                                        value="Facebook"> Facebook</label>
                                <label class="column-checkbox-item"><input type="checkbox" name="pillar_platform"
                                        value="YouTube"> YouTube / Shorts</label>
                            </div>
                        </div>
                        <div class="sem-input-group" style="margin-top: 20px;">
                            <div class="sem-input-item">
                                <label for="pillar_sensitivity"><i class="fas fa-shield-alt"></i> Brand Risk
                                    Sensitivity:</label>
                                <select id="pillar_sensitivity">
                                    <option value="Low (playful)">Low (playful, trend-led)</option>
                                    <option value="Medium (balanced)">Medium (balanced)</option>
                                    <option value="High (conservative)">High (regulated, reputation-heavy)</option>
                                </select>
                            </div>
                            <div class="sem-input-item">
                                <label for="pillar_promo_tolerance"><i class="fas fa-ad"></i> Promotional
                                    Tolerance:</label>
                                <select id="pillar_promo_tolerance">
                                    <option value="Low (soft sell)">Low (soft sell only)</option>
                                    <option value="Medium (occasional CTA)">Medium (occasional CTA)</option>
                                    <option value="High (sales-focused)">High (offer-led, sales-focused)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="sem-step-card">
                        <div class="sem-card-title"><i class="fas fa-info-circle"></i> References & Data</div>
                        <div class="sem-input-group">
                            <div class="sem-input-item">
                                <label for="pillar_website"><i class="fas fa-globe"></i> Website URLs:</label>
                                <textarea id="pillar_website"
                                    placeholder="Enter URLs, separated by commas or new lines..."></textarea>
                            </div>
                            <div class="sem-input-item">
                                <label for="pillar_brand_guide"><i class="fas fa-book"></i> Brand Guidelines
                                    URL:</label>
                                <input type="url" id="pillar_brand_guide" placeholder="https://example.com/guide.pdf">
                            </div>
                        </div>
                        <div class="sem-input-item">
                            <label for="pillar_competitors"><i class="fas fa-users-slash"></i> Key
                                Competitors:</label>
                            <textarea id="pillar_competitors" placeholder="List competitors..."></textarea>
                        </div>
                        <div class="sem-input-item" style="margin-top: 15px;">
                            <label for="pillar_pdf"><i class="fas fa-file-pdf"></i> Upload Data/PDF (e.g. Needs
                                Analysis):</label>
                            <input type="file" id="pillar_pdf" multiple accept=".pdf,.docx"
                                onchange="renderPillarAttachments()">
                            <div id="pillar-attachment-preview" class="attachment-preview" style="margin-top: 10px;">
                            </div>
                        </div>

                        <button id="generatePillarBtn" class="btn-action" style="margin-top: 25px;"
                            onclick="generateContentPillarFramework()">
                            <i class="fas fa-magic"></i> Generate Strategic Framework
                        </button>
                    </div>

                    <div id="pillar-results-display"
                        style="margin-top: 25px; padding: 25px; background: #ffffff; border-radius: 12px; border: 1px solid #e0e6ed; border-left: 6px solid #004c9d; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative;">
                        <div
                            style="font-size: 0.85em; color: #64748b; margin-bottom: 15px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                            Strategic Framework Output:</div>
                        <div id="pillar-output-text" class="html-output" style="line-height: 1.6; color: #1e293b;">
                        </div>
                        <button onclick="copyToClipboard('pillar-output-text', event)"
                            style="position: absolute; top: 15px; right: 15px; background: #f1f5f9; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; color: #475569; display: flex; align-items: center; gap: 6px; transition: all 0.2s;">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>

                <button class="collapsible" id="contentGeneratorButton">
                    <i class="fas fa-plus-square"></i><i class="fas fa-magic"></i> Social Media Content Generator
                </button>
                <div class="content" id="contentGenerator">
                    <form id="content-form">
                        <!-- Step 1: Strategy -->
                        <div class="sem-step-card">
                            <div class="sem-card-title"><i class="fas fa-chess-knight"></i> Strategy & Objectives
                            </div>
                            <div class="sem-input-group">
                                <div class="sem-input-item">
                                    <label for="post-role"><i class="fas fa-user-tag"></i> Post Role:</label>
                                    <select id="post-role" name="post-role">
                                        <option value="awareness">Build awareness</option>
                                        <option value="trust">Build trust / credibility</option>
                                        <option value="educate">Educate / explain</option>
                                        <option value="consideration">Drive consideration</option>
                                        <option value="action">Prompt action</option>
                                    </select>
                                </div>
                                <div class="sem-input-item">
                                    <label for="strategy-fit"><i class="fas fa-project-diagram"></i> Strategy
                                        Context:</label>
                                    <select id="strategy-fit" name="strategy-fit">
                                        <option value="positioning">Brand positioning</option>
                                        <option value="proof">Proof / credibility</option>
                                        <option value="engagement">Community engagement</option>
                                        <option value="campaign">Campaign support</option>
                                        <option value="conversion">Conversion support</option>
                                    </select>
                                </div>
                            </div>
                            <div class="sem-input-item">
                                <label for="core-message"><i class="fas fa-bullseye"></i> Core Message:</label>
                                <input type="text" id="core-message" name="core-message"
                                    placeholder="e.g. Our tool saves 2 hours daily">
                            </div>
                        </div>

                        <!-- Step 2: Audience & Context -->
                        <div class="sem-step-card">
                            <div class="sem-card-title"><i class="fas fa-users"></i> Audience & Brand Context</div>
                            <div class="sem-input-group">
                                <div class="sem-input-item">
                                    <label for="subgroups"><i class="fas fa-user-friends"></i> Target
                                        Sub-Groups:</label>
                                    <input type="text" id="subgroups" name="subgroups"
                                        placeholder="e.g. Badminton Players">
                                </div>
                                <div class="sem-input-item">
                                    <label for="painpoints"><i class="fas fa-exclamation-circle"></i> Pain
                                        Points:</label>
                                    <input type="text" id="painpoints" name="painpoints"
                                        placeholder="e.g. not enough time">
                                </div>
                                <div class="sem-input-item">
                                    <label for="audience_goal"><i class="fas fa-flag-checkered"></i> Audience
                                        Goals:</label>
                                    <input type="text" id="audience_goal" name="audience_goal"
                                        placeholder="e.g. Convenience">
                                </div>
                            </div>
                            <div class="sem-input-item">
                                <label for="generator_brand_guide_urls"><i class="fas fa-link"></i> Brand Guide PDFs
                                    (URLs):</label>
                                <textarea id="generator_brand_guide_urls"
                                    placeholder="Enter URLs separated by commas or newlines"></textarea>
                            </div>
                        </div>

                        <!-- Step 3: Input & Format -->
                        <div class="sem-step-card">
                            <div class="sem-card-title"><i class="fas fa-pencil-alt"></i> Content Input & Formatting
                            </div>

                            <div class="sem-input-group">
                                <div class="sem-input-item">
                                    <label for="product_service"><i class="fas fa-box-open"></i>
                                        Product/Service:</label>
                                    <input type="text" id="product_service" name="product_service">
                                </div>
                                <div class="sem-input-item">
                                    <label for="desired_action"><i class="fas fa-mouse-pointer"></i> Desired
                                        CTA:</label>
                                    <input type="text" id="desired_action" name="desired_action"
                                        placeholder="e.g. Contact us">
                                </div>
                                <div class="sem-input-item">
                                    <label for="content-type"><i class="fas fa-laptop"></i> Content Type:</label>
                                    <select id="content-type" name="content-type">
                                        <option value="blog-post">Blog Post</option>
                                        <option value="instagram-caption">Instagram Caption</option>
                                        <option value="facebook-post">Facebook Post</option>
                                        <option value="linkedin-post">LinkedIn Post</option>
                                    </select>
                                </div>
                            </div>

                            <div class="sem-input-group">
                                <div class="sem-input-item">
                                    <label for="tone"><i class="fas fa-music"></i> Tone of Voice:</label>
                                    <input type="text" id="tone" name="tone" placeholder="e.g. Luxury, Professional">
                                </div>
                                <div class="sem-input-item">
                                    <label for="brand-pov"><i class="fas fa-eye"></i> Brand POV:</label>
                                    <select id="brand-pov" name="brand-pov">
                                        <option value="authority">Confident authority</option>
                                        <option value="guide">Helpful guide</option>
                                        <option value="partner">Reassuring partner</option>
                                        <option value="peer">Community peer</option>
                                    </select>
                                </div>
                                <div class="sem-input-item">
                                    <label for="language_gen"><i class="fas fa-language"></i> Language:</label>
                                    <select id="language_gen" name="language">
                                        <option value="english">English</option>
                                        <option value="chinese">Chinese</option>
                                    </select>
                                </div>
                            </div>

                            <div class="sem-input-group">
                                <div class="sem-input-item">
                                    <label for="word_count"><i class="fas fa-sort-amount-up"></i> Word
                                        Count:</label>
                                    <input type="text" id="word_count" name="word_count" placeholder="e.g. 100 words">
                                </div>
                                <div class="sem-input-item">
                                    <label for="usp"><i class="fas fa-star"></i> USP:</label>
                                    <input type="text" id="usp" name="usp" placeholder="e.g. Available 24/7">
                                </div>
                            </div>

                            <div class="sem-input-item" style="margin-bottom: 20px;">
                                <label for="post-info"><i class="fas fa-align-left"></i> Core Content/Topic:</label>
                                <textarea id="post-info" name="post-info" style="min-height: 100px;"
                                    placeholder="What is the post about?"></textarea>
                            </div>

                            <div class="sem-input-item" style="margin-bottom: 20px;">
                                <label for="constraints"><i class="fas fa-ban"></i> Constraints/Mandatories:</label>
                                <input type="text" id="constraints" name="constraints"
                                    placeholder="Compliance wording, pricing disclaimer, etc.">
                            </div>

                            <div class="sem-input-group">
                                <div class="sem-input-item">
                                    <label for="sample-text"><i class="fas fa-history"></i> Sample Text
                                        (Optional):</label>
                                    <textarea id="sample-text" name="sample-text" style="min-height: 60px;"></textarea>
                                </div>
                                <div class="sem-input-item">
                                    <label for="reference-url"><i class="fas fa-globe"></i> Reference URL
                                        (Optional):</label>
                                    <textarea id="reference-url" name="reference-url"
                                        style="min-height: 60px;"></textarea>
                                </div>
                            </div>

                            <button type="submit" id="generate-button" class="config-btn-highlight"
                                style="margin: 0; min-width: 250px;">
                                <i class="fas fa-magic"></i> Generate Professional Content
                            </button>
                        </div>
                    </form>

                    <div id="generated-content"
                        style="margin-top: 25px; padding: 25px; background: #ffffff; border-radius: 12px; border: 1px solid #e0e6ed; border-left: 6px solid #28a745; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative;">
                        <div
                            style="font-size: 0.85em; color: #64748b; margin-bottom: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                            Generated Content:</div>
                        <div id="content-output-text" style="line-height: 1.6; color: #1e293b; white-space: pre-wrap;">
                        </div>
                        <button onclick="copyToClipboard('content-output-text')"
                            style="position: absolute; top: 15px; right: 15px; background: #f1f5f9; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; color: #475569; display: flex; align-items: center; gap: 6px; transition: all 0.2s;">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
                <!-- Social Media Comment Reply Generator -->
                <button class="collapsible" id="smmReplyButton">
                    <i class="fas fa-plus-square"></i><i class="fas fa-comments"></i> Social Media Response
                    Generator
                </button>
                <div class="content" id="smmReplyContent">
                    <div class="sem-step-card">
                        <span class="sem-step-badge">Configuration</span>
                        <div class="sem-card-title"><i class="fas fa-sliders-h"></i> Reply Configuration</div>

                        <div class="sem-input-group">
                            <div class="sem-input-item">
                                <label for="response_platform"><i class="fas fa-share-alt"></i> Platform:</label>
                                <select id="response_platform" name="response_platform">
                                    <option value="meta">Meta / Facebook</option>
                                    <option value="instagram">Instagram</option>
                                    <option value="linkedin">LinkedIn</option>
                                    <option value="tiktok">TikTok</option>
                                </select>
                            </div>
                            <div class="sem-input-item">
                                <label for="sensitivity"><i class="fas fa-exclamation-triangle"></i>
                                    Sensitivity:</label>
                                <select id="sensitivity" name="sensitivity">
                                    <option value="routine">Routine (common issue)</option>
                                    <option value="heightened">Heightened (repeated complaint)</option>
                                    <option value="high_risk">High-risk (legal/viral potential)</option>
                                </select>
                            </div>
                            <div class="sem-input-item">
                                <label for="response_objective"><i class="fas fa-bullseye"></i> Objective:</label>
                                <select id="response_objective" name="response_objective">
                                    <option value="de_escalate">De-escalate situation</option>
                                    <option value="correct_misinformation">Correct misinformation</option>
                                    <option value="demonstrate_accountability">Demonstrate accountability</option>
                                    <option value="protect_brand_reputation">Protect brand reputation</option>
                                    <option value="redirect_to_private_resolution">Redirect to DM</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="sem-step-card">
                        <span class="sem-step-badge">Input</span>
                        <div class="sem-card-title"><i class="fas fa-pen-fancy"></i> Content & Instructions</div>

                        <div class="sem-input-item" style="margin-bottom: 20px;">
                            <label for="smm-comment-input"><i class="fas fa-comment-dots"></i> Client's
                                Comment:</label>
                            <textarea id="smm-comment-input" style="min-height: 100px;"
                                placeholder="Paste the comment here..."></textarea>
                        </div>

                        <div class="sem-input-item" style="margin-bottom: 20px;">
                            <label for="smm-instructions-input"><i class="fas fa-info-circle"></i> Additional
                                Context:</label>
                            <textarea id="smm-instructions-input" style="min-height: 80px;"
                                placeholder="Optional context or specific instructions..."></textarea>
                        </div>

                        <div class="sem-input-item" style="margin-bottom: 20px;">
                            <label><i class="fas fa-paperclip"></i> Attachments (Images or Documents):</label>
                            <input type="file" id="smm-response-files" multiple accept=".pdf,.docx,image/*"
                                style="margin-top: 5px; display: block;" onchange="renderSmmResponseAttachments()">
                            <div id="smm-response-attachment-preview" class="attachment-preview"
                                style="margin-top: 10px;"></div>
                        </div>

                        <button type="button" id="generateSmmReplyBtn" class="btn-action" style="margin: 0;"
                            onclick="generateHumanReply()">
                            <i class="fas fa-magic"></i> Generate Professional Reply
                        </button>
                    </div>

                    <div id="smm-reply-display"
                        style="margin-top: 15px; padding: 25px; background: #ffffff; border-radius: 12px; border: 1px solid #e0e6ed; border-left: 6px solid #004c9d; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative;">
                        <div
                            style="font-size: 0.85em; color: #64748b; margin-bottom: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                            Generated Response:</div>
                        <div id="smm-reply-text" style="line-height: 1.6; color: #1e293b; white-space: pre-wrap;">
                        </div>
                    </div>
                </div>
            </div>
            <hr>
        </div>

        <div id="semSection">
            <div class="page-break"></div>
            <button class="collapsible" id="semButton"><i class="fas fa-plus-square"></i><i class="fas fa-ad"></i>Search
                Engine Marketing (SEM)</button>
            <div class="content" id="SEM">
                <!-- Step 1: Configuration -->
                <div class="sem-step-card">
                    <span class="sem-step-badge">Step 1</span>
                    <div class="sem-card-title"><i class="fas fa-cog"></i> Analysis Configuration</div>

                    <div class="sem-input-group">
                        <div class="sem-input-item">
                            <label for="ad_format">Ad Format:</label>
                            <select id="ad_format" name="ad_format">
                                <option value="google-responsive-search-ads">Google Responsive Search Ads</option>
                                <option value="google-performance-max-ads">Google Performance Max Ads</option>
                                <option value="google-display-ads">Google Display Ads</option>
                                <option value="meta-image-ads">Meta Image Ads</option>
                                <option value="meta-video-ads">Meta Video Ads</option>
                                <option value="meta-carousel-ads">Meta Carousel Ads</option>
                                <option value="meta-collection-ads">Meta Collection Ads</option>
                                <option value="linkedin-image-ads">LinkedIn Image Ads</option>
                                <option value="linkedin-carousel-ads">LinkedIn Carousel Ads</option>
                                <option value="linkedin-video-ads">LinkedIn Video Ads</option>
                                <option value="linkedin-click-to-message-ads">LinkedIn Click To Message Ads</option>
                            </select>
                        </div>
                        <div class="sem-input-item">
                            <label for="sem_country">Country:</label>
                            <input type="text" id="sem_country" value="Singapore">
                        </div>
                        <div class="sem-input-item">
                            <label for="sem_tone">Tone of Voice:</label>
                            <input type="text" id="sem_tone" value="Salesy">
                        </div>
                        <div class="sem-input-item">
                            <label for="sem_language">Language:</label>
                            <input type="text" id="sem_language" value="English">
                        </div>
                    </div>

                    <div class="sem-input-item" style="margin-bottom: 20px;">
                        <label for="sem_webpages">Target Webpages (URLs, separated by commas):</label>
                        <textarea id="sem_webpages"
                            placeholder="e.g., https://example.com, https://another-example.com"></textarea>
                    </div>

                    <div class="toggle-container" style="margin-bottom: 10px;">
                        <span class="toggle-label">Don't Focus on Brand</span>
                        <label class="switch">
                            <input type="checkbox" id="brand-checkbox" class="sliderMobile">
                            <span class="slider round"></span>
                        </label>
                        <span class="toggle-label-right">Focus on Brand</span>
                    </div>

                    <div class="toggle-container" style="margin-bottom: 20px;">
                        <span class="toggle-label">Don't Focus on Products</span>
                        <label class="switch">
                            <input type="checkbox" id="product-checkbox" class="sliderMobile" checked>
                            <span class="slider round"></span>
                        </label>
                        <span class="toggle-label-right">Focus on Products</span>
                    </div>

                    <div class="sem-input-item" style="margin-bottom: 20px;">
                        <label for="sem_additional">Additional Information (optional):</label>
                        <textarea id="sem_additional"
                            placeholder="Input specific details not found on the webpages..."></textarea>
                    </div>

                    <button id="getProducts" class="btn-action" style="margin: 0;" onclick="semWebpageProducts()">
                        <i class="fas fa-search"></i> Step 1: Identify products/services/brand
                    </button>

                    <div id="products" style="margin-top: 20px;"></div>
                </div>
                <!-- Step 2: Generation -->
                <div class="sem-step-card">
                    <span class="sem-step-badge">Step 2</span>
                    <div class="sem-card-title"><i class="fas fa-magic"></i> Analysis & Generation</div>

                    <button id="semAnalyse" class="btn-action" style="margin: 0; background: #28a745;"
                        onclick="semAnalyseWebsite()">
                        <i class="fas fa-chart-line"></i> Step 2: Generate Keywords, USPs & Audience
                    </button>

                    <div id="output" style="margin-top: 20px;"></div>
                </div>

                <!-- Step 3: Selection -->
                <div id="selected" class="sem-step-card" style="display:none;">
                    <span class="sem-step-badge">Step 3</span>
                    <div class="sem-card-title"><i class="fas fa-check-double"></i> Selection & Final Output</div>

                    <div class="sem-input-item" style="margin-bottom: 15px;">
                        <label>Review Selected Content:</label>
                        <textarea id="selectedText" rows="10"></textarea>
                    </div>

                    <button id="generateSem" class="btn-action" style="margin: 0; background: #6f42c1;"
                        onclick="generateGoogle()">
                        <i class="fas fa-paper-plane"></i> Step 3: Generate Ads from Selection
                    </button>

                    <div id="generated" style="margin-top: 25px;"></div>
                </div>
            </div>
            <hr>
        </div>

        <div id="competitorsSection">
            <div class="page-break"></div>
            <button class="collapsible" id="competitionBtn"><i class="fas fa-plus-square"></i><i
                    class="fas fa-search"></i>Competitors Identifier</button>
            <div class="content" id="competitors_content">
                <div class="sem-step-card">
                    <div class="sem-card-title"><i class="fas fa-handshake-slash"></i> Target & Keywords</div>
                    <div class="sem-input-group">
                        <div class="sem-input-item">
                            <label for="competitors-target1">Target Domain:</label>
                            <input type="url" id="competitors-target1" placeholder="e.g. www.abc.com">
                        </div>
                    </div>
                    <div class="sem-input-item">
                        <label for="competitor_keywords">Keywords (comma or newline separated):</label>
                        <textarea id="competitor_keywords" placeholder="Enter keywords..."></textarea>
                    </div>
                    <div class="sem-input-group" style="margin-top: 15px;">
                        <div class="sem-input-item">
                            <label for="competitors-language">Language:</label>
                            <input type="text" id="competitors-language" value="English" placeholder="e.g., English">
                        </div>
                        <div class="sem-input-item">
                            <label for="competitors-location">Location:</label>
                            <input type="text" id="competitors-location" value="Singapore"
                                placeholder="e.g., Singapore">
                        </div>
                    </div>
                    <button id="getCompetitorsBtn" class="config-btn-highlight" style="margin-top: 25px;"
                        onclick="getCompetitors()">Get Competitors</button>
                </div>

                <div class="sem-step-card">
                    <div class="sem-card-title"><i class="fas fa-microchip"></i> Competitor Analysis</div>
                    <div class="sem-input-item">
                        <label for="competitor_domains">Competitor Domains (one per line):</label>
                        <textarea id="competitor_domains" placeholder="Paste domains here..."></textarea>
                    </div>
                    <button id="getIntersectionResults2" class="config-btn-highlight" style="margin-top: 25px;"
                        onclick="getIntersectionResults2()">Get Intersection Results</button>
                </div>

                <div id="competitorsOutput" style="display:none; height:400px; overflow:auto; margin-top: 20px;">
                </div>
                <div id="getIntersectionResults"></div>
                <div id="competitorsRanking" style="display:none; height:400px; overflow:auto;"></div>
            </div>
            <hr>
        </div>

        <div id="personaSection">
            <div class="page-break"></div>
            <button class="collapsible" id="persona"><i class="fas fa-plus-square"></i><i
                    class="fas fa-users"></i>Persona
                Generator</button>
            <div class="content" id="persona_content">
                <div class="sem-step-card">
                    <div class="sem-card-title"><i class="fas fa-id-card"></i> Persona Context</div>
                    <div class="sem-input-item">
                        <label for="persona_webpages">Company / Product Webpages (comma or newline
                            separated):</label>
                        <textarea id="persona_webpages"
                            placeholder="https://example.com, https://another-example.com"></textarea>
                    </div>
                    <div class="sem-input-item" style="margin-top: 15px;">
                        <label for="persona_manual">Any other information (optional):</label>
                        <textarea id="persona_manual" placeholder="Focus on this product."></textarea>
                    </div>
                    <button id="generatePersonaBtn" class="config-btn-highlight" style="margin-top: 25px;"
                        onclick="generatePersona()">Generate Personas</button>
                </div>
                <div id="undo-bar-persona" class="undo-bar" style="display: none;">
                    <button class="btn-undo" onclick="undoDeletion()">
                        <i class="fas fa-undo-alt"></i> Undo Deletion
                    </button>
                </div>
                <div id="persona-instruction"
                    style="display: none; margin: 20px 0; padding: 12px 16px; background: #f0f7ff; border-left: 4px solid #1a73e8; border-radius: 8px; font-size: 0.95em; color: #1a73e8; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                        <div>
                            <i class="fas fa-info-circle"></i> <strong>Note:</strong> You can edit the text in any
                            persona card directly. Feel free to delete any cards that are not applicable to your
                            strategy.
                        </div>
                        <button id="btnReturnToFlow" class="btn-action"
                            style="display: none; width: auto; padding: 6px 12px; font-size: 0.85em; background: #1a73e8; margin-top: 0;"
                            onclick="returnToPathway()">
                            <i class="fas fa-arrow-up"></i> Return to Content Optimiser
                        </button>
                    </div>
                </div>
                <div id="persona-results"></div>
                <button type="button" id="copy-persona-results-button" class="tooltip" style="display:none"
                    onclick="copyPersonaResults(event)">Copy to clipboard<span>Click to copy the persona results to
                        your
                        clipboard.</span>
                </button>
            </div>
            <hr>
        </div>

        <div id="mediaPlanSection">
            <div class="page-break"></div>
            <button class="collapsible" id="mediaPlanBtn"><i class="fas fa-plus-square"></i><i
                    class="fas fa-bullseye"></i>Media Plan</button>
            <div class="content" id="mediaplan">
                <div class="sem-step-card">
                    <div class="sem-card-title"><i class="fas fa-search"></i> Core Strategy</div>
                    <div class="sem-input-item">
                        <label for="MediaPlanWebpages">Company / Product Webpages (comma or newline
                            separated):</label>
                        <textarea id="MediaPlanWebpages"
                            placeholder="e.g., https://example.com, https://another-example.com"></textarea>
                    </div>
                    <div class="sem-input-group" style="margin-top: 15px;">
                        <div class="sem-input-item">
                            <label for="MediaPlanBudget">Monthly Budget:</label>
                            <input type="text" id="MediaPlanBudget" name="budget" placeholder="e.g. $5,000">
                        </div>
                    </div>
                </div>

                <div class="sem-step-card">
                    <div class="sem-card-title"><i class="fas fa-ad"></i> Preferred Ad Formats</div>
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                        <label class="column-checkbox-item">
                            <input type="checkbox" checked class="media-plan-checkbox"
                                id="MediaPlanAdFormatsGoogleDisplay" name="MediaPlanAdFormatsGoogleDisplay"
                                value="MediaPlanAdFormatsGoogleDisplay">
                            Google Display
                        </label>
                        <label class="column-checkbox-item">
                            <input type="checkbox" checked class="media-plan-checkbox"
                                id="MediaPlanAdFormatsGoogleSearch" name="MediaPlanAdFormatsGoogleSearch"
                                value="MediaPlanAdFormatsGoogleSearch">
                            Google Search
                        </label>
                        <label class="column-checkbox-item">
                            <input type="checkbox" checked class="media-plan-checkbox" id="MediaPlanAdFormatsFBIG"
                                name="MediaPlanAdFormatsFBIG" value="MediaPlanAdFormatsFBIG">
                            Facebook / Instagram
                        </label>
                        <label class="column-checkbox-item">
                            <input type="checkbox" checked class="media-plan-checkbox" id="MediaPlanAdFormatsLinkedIn"
                                name="MediaPlanAdFormatsLinkedIn" value="MediaPlanAdFormatsLinkedIn">
                            LinkedIn
                        </label>
                        <label class="column-checkbox-item">
                            <input type="checkbox" checked class="media-plan-checkbox" id="MediaPlanAdFormatsTikTok"
                                name="MediaPlanAdFormatsTikTok" value="MediaPlanAdFormatsTikTok">
                            TikTok
                        </label>
                    </div>
                </div>

                <div class="sem-step-card">
                    <div class="sem-card-title"><i class="fas fa-info-circle"></i> Additional Context</div>
                    <div class="sem-input-item">
                        <label for="MediaPlanManual">Any other information (optional):</label>
                        <textarea id="MediaPlanManual" placeholder="Focus on this product."></textarea>
                    </div>
                </div>

                <button class="collapsible" id="mediaPlanOtherFieldsBtn">Other Fields (optional)</button>
                <div class="content" id="mediaplanothers">
                    <div class="sem-step-card">
                        <div class="sem-card-title"><i class="fas fa-layer-group"></i> Detailed Planning</div>
                        <div class="sem-input-group">
                            <div class="sem-input-item">
                                <label for="MediaPlanOrganisationalObjectives">Organisational Objectives:</label>
                                <textarea id="MediaPlanOrganisationalObjectives"
                                    placeholder="e.g., Increase brand awareness by 20%"></textarea>
                            </div>
                        </div>
                        <div class="sem-input-group">
                            <div class="sem-input-item">
                                <label for="MediaPlanLocation">Target Location:</label>
                                <input type="text" id="MediaPlanLocation" name="mediaPlanLocation"
                                    placeholder="e.g., Singapore">
                            </div>
                            <div class="sem-input-item">
                                <label for="MediaPlanTargetAudience">Target Audience:</label>
                                <input type="text" id="MediaPlanTargetAudience" name="mediaPlanTargetAudience"
                                    placeholder="e.g., Millennials, Tech Enthusiasts">
                            </div>
                        </div>
                        <div class="sem-input-item">
                            <label for="MediaPlanCustomerPersonas">Customer Personas:</label>
                            <textarea id="MediaPlanCustomerPersonas"
                                placeholder="Description of your ideal customers."></textarea>
                        </div>
                        <div class="sem-input-item">
                            <label for="MediaPlanTouchpoints">Customer Touchpoints:</label>
                            <textarea id="MediaPlanTouchpoints" placeholder="List all interaction points."></textarea>
                        </div>
                        <div class="sem-input-item">
                            <label for="MediaPlanContentStrategy">Content Strategy:</label>
                            <textarea id="MediaPlanContentStrategy"
                                placeholder="e.g., Blog posts, videos, infographics"></textarea>
                        </div>
                        <div class="sem-input-item">
                            <label for="MediaPlanLandingPages">Landing Pages:</label>
                            <textarea id="MediaPlanLandingPages"
                                placeholder="URLs of relevant landing pages."></textarea>
                        </div>
                        <div class="sem-input-item">
                            <label for="MediaPlanCta">Calls-to-Action (CTAs):</label>
                            <textarea id="MediaPlanCta" placeholder="e.g., Sign up, Download, Buy Now"></textarea>
                        </div>
                        <div class="sem-input-item">
                            <label for="MediaPlanProductService">Specific Products/Services:</label>
                            <textarea id="MediaPlanProductService" placeholder="List products to promote."></textarea>
                        </div>
                        <div class="sem-input-item">
                            <label for="MediaPlanKpis">Key Performance Indicators (KPIs):</label>
                            <textarea id="MediaPlanKpis" placeholder="e.g., engagement, conversion rate"></textarea>
                        </div>
                        <div class="sem-input-item">
                            <label for="MediaPlanCompetitiveAnalysis">Competitive Analysis:</label>
                            <textarea id="MediaPlanCompetitiveAnalysis"
                                placeholder="Information about competitors."></textarea>
                        </div>
                        <div class="sem-input-item">
                            <label for="MediaPlanCompliance">Compliance and Regulations:</label>
                            <textarea id="MediaPlanCompliance" placeholder="Legal and industry regulations."></textarea>
                        </div>
                        <div class="sem-input-item">
                            <label for="MediaPlanTechnologyPlan">Technology Plan:</label>
                            <textarea id="MediaPlanTechnologyPlan" placeholder="Marketing tools to be used."></textarea>
                        </div>
                        <div class="sem-input-item">
                            <label for="MediaPlanAnalyticsReporting">Analytics and Reporting:</label>
                            <textarea id="MediaPlanAnalyticsReporting"
                                placeholder="Processes for tracking performance."></textarea>
                        </div>
                    </div>
                </div>

                <button id="generateMediaPlanBtn" class="config-btn-highlight" style="margin-top: 25px;"
                    onclick="generateMediaPlan()">Generate Media Plan</button>
                <div id="mediaPlanPersonaResults" class="mediaPlanPersonaResults">
                    <hr>
                </div>
                <div id="mediaPlanResults"></div>

                <div class="funnel-container" id="funnel-container" style="display:none;">
                    <button class="funnel-collapsible-before"
                        style="background-color: #7554ae; width:100%;"><b>AWARENESS
                            (TOFU)</b>
                        <p id="awareness-summary">Attract a wider audience. Make your brand known using tactics like
                            SEO, social media, content marketing, and paid ads. The goal is to increase visibility
                            and
                            spark
                            initial interest in your brand.</p>
                    </button>
                    <div class="funnel-content" style="background-color: #bba9d9;">
                        <p id="awareness-details">N.A.</p>
                    </div>

                    <button class="funnel-collapsible-before" style="background-color: #3a857d; width:90%;"><b>DISCOVERY
                            (MOFU)</b>
                        <p id="discovery-summary">Educate and engage your audience. Provide valuable information and
                            resources that help potential customers understand their problem and your potential
                            solution.
                            Content like ebooks, webinars, and helpful blog posts are key.</p>
                    </button>
                    <div class="funnel-content" style="background-color: #b8d1cf; width:90%;">
                        <p id="discovery-details">N.A.</p>
                    </div>

                    <button class="funnel-collapsible-before"
                        style="background-color: #e67c3a; width:80%;"><b>CONSIDERATION
                            (MOFU)</b>
                        <p id="consideration-summary">Showcase your value proposition. Demonstrate how your product
                            or
                            service specifically solves the customer's needs and stands out from the competition.
                            Use
                            case
                            studies, testimonials, product demos, and comparisons.</p>
                    </button>
                    <div class="funnel-content" style="background-color: #f0cbb4; width:80%;">
                        <p id="consideration-details">N.A.</p>
                    </div>

                    <button class="funnel-collapsible-before"
                        style="background-color: #e57373; width:70%;"><b>CONVERSION
                            (BOFU)</b>
                        <p id="conversion-summary">Drive action and close the sale. Make it easy for potential
                            customers
                            to purchase by offering trials, discounts, consultations, or clear calls to action.
                            Focus on
                            removing obstacles and building confidence in their decision.</p>
                    </button>
                    <div class="funnel-content" style="background-color: #f4c8c8; width:70%;">
                        <p id="conversion-details">N.A.</p>
                    </div>

                    <button class="funnel-collapsible-before"
                        style="background-color: #3a85c3; width:60%;"><b>RETENTION</b>
                        <p id="retention-summary">Foster loyalty. Provide ongoing value and build lasting
                            relationships
                            with
                            your customers. Offer
                            personalized communications, loyalty programs, and exclusive offers to encourage repeat
                            purchases and
                            brand advocacy. Happy customers become your best marketers.</p>
                    </button>
                    <div class="funnel-content" style="background-color: #b2cfe7; width:60%;">
                        <p id="retention-details">N.A.</p>
                    </div>
                </div>
            </div>

            <hr>
        </div>

        <div id="contentCheckerSection">
            <div class="page-break"></div>
            <button class="collapsible" id="contentcheck"><i class="fas fa-plus-square"></i><i
                    class="fas fa-book-open"></i>Content Checker</button>
            <div class="content" id="content_check_content">
                <div class="sem-step-card">
                    <div class="sem-card-title"><i class="fas fa-microscope"></i> Content Analysis Scope</div>
                    <div class="sem-input-item">
                        <label for="brand_guide_urls">Brand Guide / Guidelines PDFs (public URLs):</label>
                        <textarea id="brand_guide_urls"
                            placeholder="e.g., https://example.com/brand-guide.pdf"></textarea>
                    </div>
                    <div class="sem-input-item" style="margin-top: 15px;">
                        <label for="content_check_other_urls">Any other website/guidelines URLs: </label>
                        <textarea id="content_check_other_urls" placeholder="https://regulations.com/"></textarea>
                    </div>
                </div>

                <div class="sem-step-card">
                    <div class="sem-card-title"><i class="fas fa-keyboard"></i> Content to Validate</div>
                    <div class="sem-input-item">
                        <label for="content_to_check">Content to Check: </label>
                        <textarea id="content_to_check" style="min-height: 250px;"
                            placeholder="Paste your content here..."></textarea>
                    </div>
                    <div class="sem-input-item" style="margin-top: 15px;">
                        <label for="content_check_instructions">Additional Analysis Instructions: </label>
                        <textarea id="content_check_instructions"
                            placeholder="e.g. Do not use the word 'cheap'"></textarea>
                    </div>
                    <button id="contentCheckBtn" class="config-btn-highlight" style="margin-top: 25px;"
                        onclick="checkContent()">Check Content</button>
                </div>
                <div id="checkContentResults"></div>
                <div style="display: flex; align-items: center;">
                    <button type="button" id="copy-check-results-button" class="tooltip" style="display:none"
                        onclick="copyCheckContentResults(event)">
                        <i class="fa fa-copy"></i>
                        <span>Click to copy the check results to your clipboard.</span>
                    </button>
                    <button id="openFeedbackModalBtn" style="display:none; margin-left: 10px;">Feedback</button>
                </div>
            </div>
            <hr>
        </div>

        <div id="landingPageAuditSection">
            <div class="page-break"></div>
            <button class="collapsible" id="landingPageAuditBtn"><i class="fas fa-plus-square"></i><i
                    class="fas fa-clipboard-check"></i>Landing Page
                Audit</button>
            <div class="content" id="landingPageAudit">
                <div class="sem-step-card">
                    <div class="sem-card-title"><i class="fas fa-stethoscope"></i> Page Audit Configuration</div>
                    <div class="sem-input-group">
                        <div class="sem-input-item">
                            <label for="landingPageUrl">Landing Page URL:</label>
                            <input type="url" id="landingPageUrl" placeholder="e.g., https://example.com">
                        </div>
                        <div class="sem-input-item">
                            <label for="landingPageAuditKeyword">Target Keyword (optional):</label>
                            <input type="text" id="landingPageAuditKeyword" placeholder="e.g., digital marketing">
                        </div>
                    </div>
                    <button id="auditLandingPageBtn" class="config-btn-highlight" style="margin-top: 25px;"
                        onclick="auditLandingPageDirectWeb()">Audit Landing Page</button>
                </div>
                <div id="landingPageAuditResults"></div>
            </div>
            <hr>
        </div>

        <div id="aiContentOptimiserSection">
            <div class="page-break"></div>
            <button class="collapsible" id="geoUtilitiesBtn"><i class="fas fa-plus-square"></i><i
                    class="fas fa-globe"></i> GEO</button>
            <div class="content" id="geoUtilitiesSection">
                <div class="sem-step-card">
                    <div class="sem-card-title"><i class="fas fa-robot"></i> llms.txt Generator</div>
                    <p style="margin-bottom: 15px; font-size: 0.9em; color: #666;">Create a standard file to guide
                        LLMs
                        on how to read and index your site logic.</p>

                    <div class="sem-input-group">
                        <div
                            style="width: 100%; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                            <strong
                                style="font-size: 0.85em; color: #004c9d; text-transform: uppercase; letter-spacing: 0.5px;">1.
                                Basic Information</strong>
                        </div>
                        <div class="sem-input-item">
                            <label>Site Title</label>
                            <input type="text" id="llmSiteTitle" placeholder="e.g., DigiMetrics AI">
                        </div>
                        <div class="sem-input-item">
                            <label>Short Description (Bio)</label>
                            <textarea id="llmDescription" class="keyword-input-textarea" style="height: 80px"
                                placeholder="e.g., DigiMetrics is a leading digital marketing agency specialized in SEO and GEO optimization..."></textarea>
                        </div>
                    </div>

                    <div class="sem-input-group">
                        <div
                            style="width: 100%; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                            <strong
                                style="font-size: 0.85em; color: #004c9d; text-transform: uppercase; letter-spacing: 0.5px;">2.
                                Brand Highlights</strong>
                        </div>
                        <div class="sem-input-item">
                            <label>Highlights Heading</label>
                            <input type="text" id="llmHighlightsHeading"
                                placeholder="e.g., Why DigiMetrics is the best choice for your business:">
                        </div>
                        <div class="sem-input-item">
                            <label>Highlights List (Bullet points)</label>
                            <textarea id="llmHighlights" class="keyword-input-textarea" style="height: 120px"
                                placeholder="- Proven Success: Over 500+ successful campaigns&#10;- Expert Team: Certified SEO & GEO specialists"></textarea>
                            <div class="st-custom-label">Press 'Enter' for a new line between items</div>
                        </div>
                    </div>

                    <div class="sem-input-group">
                        <div
                            style="width: 100%; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                            <strong
                                style="font-size: 0.85em; color: #004c9d; text-transform: uppercase; letter-spacing: 0.5px;">3.
                                GEO Strategy</strong>
                        </div>
                        <div class="sem-input-item">
                            <label>GEO Target Prompts (One per line)</label>
                            <textarea id="llmGeoPrompts" class="keyword-input-textarea" style="height: 120px"
                                placeholder="What makes DigiMetrics the best SEO agency?&#10;How does GEO optimization improve visibility?"></textarea>
                            <div class="st-custom-label">Press 'Enter' for a new line between prompts</div>
                        </div>
                    </div>

                    <div class="sem-input-group">
                        <div
                            style="width: 100%; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                            <strong
                                style="font-size: 0.85em; color: #004c9d; text-transform: uppercase; letter-spacing: 0.5px;">4.
                                Site Structure</strong>
                        </div>
                        <div class="sem-input-item">
                            <label>Core Sections (Markdown format)</label>
                            <textarea id="llmCoreSections" class="keyword-input-textarea" style="height: 200px"
                                placeholder="## Services&#10;- [SEO Optimization](https://digimetrics.ai/seo): Description&#10;&#10;## Case Studies&#10;- [Retail Success](https://digimetrics.ai/case-studies/retail): Description"></textarea>
                            <div class="st-custom-label">Use ## for section titles and - [Label](URL): Description
                                for
                                links</div>
                        </div>
                        <div class="sem-input-item">
                            <label>Optional Section (Markdown format)</label>
                            <textarea id="llmOptional" class="keyword-input-textarea" style="height: 100px"
                                placeholder="## Optional&#10;- [Blog](https://digimetrics.ai/blog): Latest marketing insights"></textarea>
                        </div>
                    </div>
                    <button class="config-btn-highlight" onclick="generateLlmsTxt()"
                        style="margin-top: 10px; padding: 6px 14px; min-width: auto; font-size: 13px; display: inline-flex; height: auto; min-height: 0; align-self: flex-start;">Generate
                        llms.txt</button>
                </div>

                <div class="sem-step-card" style="margin-top: 20px;">
                    <div class="sem-card-title"><i class="fas fa-cat"></i> cats.txt Generator</div>
                    <p style="margin-bottom: 15px; font-size: 0.9em; color: #666;">Draft a 'cats.txt' (Community
                        Agreed
                        Traits Standard) to define your brand entity for AI personality alignment.</p>

                    <div class="sem-input-group">
                        <div
                            style="width: 100%; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                            <strong
                                style="font-size: 0.85em; color: #004c9d; text-transform: uppercase; letter-spacing: 0.5px;">1.
                                Basic Information</strong>
                        </div>
                        <div class="sem-input-item">
                            <label>Entity Name</label>
                            <input type="text" id="catsEntityName" placeholder="e.g., DigiMetrics AI">
                        </div>
                    </div>

                    <div class="sem-input-group">
                        <div
                            style="width: 100%; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                            <strong
                                style="font-size: 0.85em; color: #004c9d; text-transform: uppercase; letter-spacing: 0.5px;">2.
                                Brand Personality & Facts</strong>
                        </div>
                        <div class="sem-input-item">
                            <label>Personality / Traits</label>
                            <textarea id="catsTraits" class="keyword-input-textarea"
                                placeholder="e.g., Professional, data-driven, authoritative, and helpful personality..."></textarea>
                        </div>
                        <div class="sem-input-item">
                            <label>Key Facts / Values</label>
                            <textarea id="catsValues" class="keyword-input-textarea"
                                placeholder="- Founded in 2012&#10;- Expert in SEO & GEO strategy&#10;- Customer-centric approach"></textarea>
                            <div class="st-custom-label">Press 'Enter' for a new line between points</div>
                        </div>
                    </div>
                    <button class="config-btn-highlight" onclick="generateCatsTxt()"
                        style="margin-top: 10px; padding: 6px 14px; min-width: auto; font-size: 13px; display: inline-flex; height: auto; min-height: 0; align-self: flex-start;">Generate
                        cats.txt</button>
                </div>

                <!-- Preview Area -->
                <div id="geoFilePreview"
                    style="display:none; margin-top: 25px; border-top: 1px solid #eee; padding-top: 20px;">
                    <h3 id="previewTitle" style="color: #004c9d; margin-bottom: 10px;">Preview</h3>
                    <textarea id="geoPreviewText" class="keyword-input-textarea"
                        style="height: 300px; font-family: monospace;"></textarea>
                    <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                        <button class="config-btn-highlight" id="downloadGeoBtn"
                            style="background: #28a745; padding: 6px 14px; min-width: auto; font-size: 13px; display: inline-flex; margin: 0; height: auto; min-height: 0; align-self: center;"><i
                                class="fas fa-download"></i> Download File</button>
                        <button class="config-btn-highlight"
                            onclick="document.getElementById('geoFilePreview').style.display='none'"
                            style="background: #6c757d; min-width: auto; padding: 6px 14px; font-size: 13px; display: inline-flex; margin: 0; height: auto; min-height: 0; align-self: center;">Close</button>
                    </div>
                </div>

            </div>
            <hr>
            <button class="collapsible" id="aiContentOptimiserBtn"><i class="fas fa-plus-square"></i><i
                    class="fas fa-magic"></i>AI Content Optimiser</button>
            <div class="content" id="aiContentOptimiser">
                <!-- New Workflow Decision Panel -->
                <div class="optimiser-flow-container">
                    <div id="optimiserDecisionPanel">
                        <div class="decision-panel">
                            <div class="big-decision-btn" onclick="switchOptimiserFlow('new')">
                                <i class="fas fa-file-signature"></i>
                                <span>Start New Article</span>
                                <p>Generate fresh content from scratch using AI and your compliance guidelines.</p>
                            </div>
                            <div class="big-decision-btn" onclick="switchOptimiserFlow('optimise')">
                                <i class="fas fa-wand-sparkles"></i>
                                <span>Optimise Existing</span>
                                <p>Improve an existing webpage or draft for better SEO and readability.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Path 1: Start New Flow -->
                    <div id="createNewFlow" class="flow-panel">
                        <button id="backToDecision" onclick="switchOptimiserFlow('reset')"><i
                                class="fas fa-arrow-left"></i> Change Method</button>

                        <div class="sem-step-card" style="margin-top: 20px;">
                            <div class="sem-card-title"><i class="fas fa-map-marker-alt"></i> Article Context</div>
                            <div class="sem-input-group">
                                <div class="sem-input-item">
                                    <label for="locationOptimiserNew">Target Location:</label>
                                    <select id="locationOptimiserNew">
                                        <option value="Singapore">Singapore</option>
                                        <option value="None">Global</option>
                                        <option value="Australia">Australia</option>
                                        <option value="Bhutan">Bhutan</option>
                                        <option value="Brazil">Brazil</option>
                                        <option value="Canada">Canada</option>
                                        <option value="China">China</option>
                                        <option value="France">France</option>
                                        <option value="Germany">Germany</option>
                                        <option value="Hong Kong">Hong Kong</option>
                                        <option value="India">India</option>
                                        <option value="Indonesia">Indonesia</option>
                                        <option value="Italy">Italy</option>
                                        <option value="Japan">Japan</option>
                                        <option value="Malaysia">Malaysia</option>
                                        <option value="Mexico">Mexico</option>
                                        <option value="Netherlands">Netherlands</option>
                                        <option value="Philippines">Philippines</option>
                                        <option value="South Korea">South Korea</option>
                                        <option value="Spain">Spain</option>
                                        <option value="Taiwan">Taiwan</option>
                                        <option value="Thailand">Thailand</option>
                                        <option value="United Kingdom">United Kingdom</option>
                                        <option value="United States">United States</option>
                                        <option value="Vietnam">Vietnam</option>
                                    </select>
                                </div>
                                <div class="sem-input-item">
                                    <label for="languageOptimiserNew">Language:</label>
                                    <input type="text" id="languageOptimiserNew" value="English">
                                </div>
                            </div>

                            <div class="sem-input-item" style="margin-top: 15px;">
                                <label for="newArticleTopic">What is this new article about? (Topic / Headline /
                                    Specific Requirements):</label>
                                <textarea id="newArticleTopic"
                                    placeholder="Describe the topic, target audience, or specific requirements..."
                                    style="min-height: 100px;"></textarea>
                            </div>
                        </div>

                        <div class="sem-step-card" style="margin-top: 20px;">
                            <div class="sem-card-title"><i class="fas fa-search"></i> Keyword Targeting</div>
                            <div class="sem-input-item">
                                <label for="primaryKeywordNew">Primary Focus Keyword:</label>
                                <input type="text" id="primaryKeywordNew" placeholder="e.g., SEO Agency Singapore">
                            </div>
                            <div class="sem-input-item" style="margin-top: 15px;">
                                <label for="secondaryKeywordsNew">Secondary Keywords (one per line):</label>
                                <textarea id="secondaryKeywordsNew"
                                    placeholder="e.g., search engine optimization, seo services"
                                    style="min-height: 120px;"></textarea>
                            </div>
                            <button id="btnResearchPersonasNew" type="button" class="btn-action"
                                style="margin-top: 15px; padding: 10px 16px; font-size: 0.9em; width: auto; background: #6c757d; color: white;"
                                onclick="navigateToPersonas('createNewFlow')">
                                <i class="fas fa-users"></i> Research Target Personas
                            </button>
                        </div>

                        <div class="sem-step-card" style="margin-top: 20px;">
                            <div class="sem-card-title"><i class="fas fa-shield-halved"></i> AI Compliance &
                                Guidelines
                            </div>
                            <div id="complianceRecommenderWrapper"
                                style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e1e4e8; padding: 15px;">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                                    <p style="font-size: 13px; color: #666; margin: 0;">Scan for relevant
                                        regulations or
                                        guidelines:</p>
                                    <button id="btnScanCompliance" class="btn-gradient"
                                        style="background: #34a853; padding: 10px 16px; font-size: 12px; margin: 0; white-space: nowrap; width: auto; border-radius: 8px;"
                                        onclick="scanForCompliance('new')">
                                        <i class="fas fa-search"></i> Scan Guidelines
                                    </button>
                                </div>
                                <div id="complianceGuidelinesList"
                                    style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0;">
                                    <div style="font-size: 12px; color: #999; width: 100%; font-style: italic;">No
                                        guidelines scanned yet.</div>
                                </div>
                                <div class="sem-input-item">
                                    <label for="customCompliance">Custom Instructions / Compliance:</label>
                                    <textarea id="customCompliance"
                                        placeholder="e.g., Must mention risk warnings at the end"
                                        style="min-height: 60px;"></textarea>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                                <div class="ref-section" style="margin: 0; border: none; padding: 0;">
                                    <div class="ref-label"><i class="fas fa-file-pdf"></i> Reference Documents
                                        (PDF/DOCX)</div>
                                    <div class="compliance-dropzone"
                                        onclick="document.getElementById('complianceFileUpload').click()">
                                        <i class="fas fa-cloud-upload-alt"
                                            style="font-size: 1.5em; color: #999; margin-bottom: 5px; display: block;"></i>
                                        <span style="font-size: 0.9em;">Click to upload</span>
                                        <input type="file" id="complianceFileUpload" style="display: none;"
                                            accept=".pdf,.doc,.docx" multiple>
                                    </div>
                                    <div id="complianceFileList" style="margin-top: 10px; font-size: 0.85em;"></div>
                                </div>
                                <div class="ref-section" style="margin: 0; border: none; padding: 0;">
                                    <div class="ref-label"><i class="fas fa-link"></i> Reference URLs</div>
                                    <textarea id="referenceUrls" placeholder="Enter one URL per line"
                                        style="min-height: 80px; width: 100%; box-sizing: border-box;"></textarea>
                                </div>
                            </div>
                        </div>

                        <button class="config-btn-highlight" onclick="openAiSettingsModal()"
                            style="margin-top: 10px; background: #666;">
                            <i class="fas fa-sliders-h"></i> Full Optimiser Configuration
                        </button>

                        <div style="margin-top: 30px; text-align: center;">
                            <button id="btnAnalyzeAndPropose" class="btn-gradient"
                                style="background: #1a73e8; padding: 15px 40px; font-size: 1.1em; display: inline-block; width: auto; min-width: 300px; border-radius: 12px; box-shadow: 0 4px 15px rgba(26, 115, 232, 0.3);"
                                onclick="analyzeAndProposeOutline()">
                                <i class="fas fa-search-plus"></i> STEP 1: Analyse SERPs & Propose Outline
                            </button>
                        </div>
                    </div>

                    <!-- Competitor Insights Display -->
                    <div id="competitorAnalysisWrapper"
                        style="display: none; margin-top: 25px; border-top: 1px solid #eee; padding-top: 20px;">
                        <div class="competitor-insights-title">
                            <i class="fas fa-chart-line"></i> Competitor Content Insights
                        </div>
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                            We've analysed the top 10 SERP competitors for your keyword. <b>Select
                                multiple topics
                                by clicking on the rows across different cards</b>, then click the "Run
                            AI Content
                            Analysis" button below to continue.
                        </p>
                        <div
                            style="margin-bottom: 15px; display: flex; gap: 10px; justify-content: flex-end; align-items: center; flex-wrap: wrap;">
                            <button id="btnAiPick-new" onclick="aiPickTopics('new')"
                                style="background: #f3e5f5; color: #9c27b0; border: 1px solid #d1c4e9; padding: 8px 16px; border-radius: 8px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                <i class="fas fa-robot"></i> AI Choose Topics
                            </button>
                            <button onclick="selectAllTopics('new')"
                                style="background: #e7f3ff; color: #007bff; border: 1px solid #cce5ff; padding: 8px 16px; border-radius: 8px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                <i class="fas fa-check-double"></i> Select All Topics
                            </button>
                            <button onclick="deselectAllTopics('new')"
                                style="background: #fff1f0; color: #ff4d4f; border: 1px solid #ffa39e; padding: 8px 16px; border-radius: 8px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                <i class="fas fa-times-circle"></i> Deselect All
                            </button>
                            <div class="topic-legend" style="width: 100%; margin-top: 5px;">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #1a73e8;"></div>
                                    <span>User Picked</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #9c27b0;"></div>
                                    <span>AI Recommended</span>
                                </div>
                            </div>
                        </div>
                        <div id="competitorInsightsGrid" class="competitor-insights-grid">
                            <!-- Competitor cards will be injected here -->
                        </div>

                        <div id="loadMoreWrapper" style="display: none; text-align: center; margin-top: 20px;">
                            <button id="btnLoadMoreCompetitors" class="btn-action"
                                style="min-width: 200px; padding: 10px 20px; font-size: 0.9em;"
                                onclick="loadMoreCompetitors('new')">
                                <i class="fas fa-plus"></i> Load More Competitors
                            </button>
                        </div>

                        <div id="selectedTopicsWrapper"
                            style="display: none; margin-top: 25px; background: #f0f7ff; padding: 20px; border-radius: 12px; border: 1px solid #cce5ff;">
                            <label for="selectedTopicsText"
                                style="font-weight: bold; color: #004c9d; display: block; margin-bottom: 10px;">
                                <i class="fas fa-tags"></i> Selected Topics for Analysis
                            </label>
                            <p style="font-size: 0.85em; color: #555; margin-bottom: 10px;">
                                Click on rows in the competitor cards to add/remove topics. You can also
                                edit these
                                manually.
                            </p>
                            <textarea id="selectedTopicsText"
                                style="width: 100%; min-height: 100px; padding: 12px; border-radius: 8px; border: 1px solid #b8daff; box-sizing: border-box; font-size: 0.9em; line-height: 1.5;"
                                placeholder="Selected topics will appear here..."></textarea>

                            <div style="text-align: right; margin-top: 15px;">
                                <button id="btnRunAnalysisFromTopics" class="btn-gradient"
                                    style="background: #28a745; border-radius: 8px; padding: 12px 24px; font-size: 1em; width: auto; min-width: 200px;"
                                    onclick="runGapAnalysisWithTopics('new')">
                                    <i class="fas fa-magic"></i> Run AI Content Analysis
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="outlineStepWrapper"
                        style="display: none; margin-top: 30px; border-top: 2px dashed #eee; padding-top: 20px;">
                        <label for="editableOutline"
                            style="font-weight: bold; display: block; margin-bottom: 10px; font-size: 1.1em; color: #004c9d;">
                            <i class="fas fa-edit"></i> Step 2: Review & Refine Article Outline
                        </label>
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                            Based on competitive analysis, here is a suggested structure. Amend it as
                            needed.
                        </p>
                        <div id="outlineLoading-New"
                            style="display: none; padding: 20px; text-align: center; color: #004c9d; font-size: 0.9em;">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p style="margin-top: 10px;">Analyzing competitor data and generating
                                article outline...
                            </p>
                        </div>
                        <textarea id="editableOutline"
                            style="width: 100%; padding: 15px; box-sizing: border-box; border-radius: 8px; border: 1px solid #004c9d; min-height: 250px; font-family: monospace; line-height: 1.6;"></textarea>

                        <button id="btnGenerateNewArticle" class="btn-gradient"
                            style="background: #28a745; margin-top: 15px; padding: 15px 30px; font-size: 1.1em; display: inline-block; width: auto; min-width: 250px; border-radius: 8px;"
                            onclick="generateNewArticle()">
                            <i class="fas fa-magic"></i> Step 3: Generate Full Article
                        </button>
                    </div>
                </div>

                <!-- Path 2: Optimise Existing Flow -->
                <div id="optimiseExistingFlow" class="flow-panel">
                    <button id="backToDecision" onclick="switchOptimiserFlow('reset')"><i class="fas fa-arrow-left"></i>
                        Change Method</button>

                    <div class="sem-step-card" style="margin-top: 20px;">
                        <div class="sem-card-title"><i class="fas fa-globe"></i> Page Context & Targeting</div>
                        <div class="sem-input-item">
                            <label for="optimiserPageUrl">Page URL (to improve):</label>
                            <input type="url" id="optimiserPageUrl" value="https://mediaonemarketing.com.sg/seo-agency"
                                placeholder="https://example.com/target-page">
                        </div>
                        <div class="sem-input-group" style="margin-top: 15px;">
                            <div class="sem-input-item">
                                <label for="locationOptimiserOptimise">Target Location:</label>
                                <select id="locationOptimiserOptimise">
                                    <option value="Singapore">Singapore</option>
                                    <option value="None">Global</option>
                                    <option value="Australia">Australia</option>
                                    <option value="Bhutan">Bhutan</option>
                                    <option value="Brazil">Brazil</option>
                                    <option value="Canada">Canada</option>
                                    <option value="China">China</option>
                                    <option value="France">France</option>
                                    <option value="Germany">Germany</option>
                                    <option value="Hong Kong">Hong Kong</option>
                                    <option value="India">India</option>
                                    <option value="Indonesia">Indonesia</option>
                                    <option value="Italy">Italy</option>
                                    <option value="Japan">Japan</option>
                                    <option value="Malaysia">Malaysia</option>
                                    <option value="Mexico">Mexico</option>
                                    <option value="Netherlands">Netherlands</option>
                                    <option value="Philippines">Philippines</option>
                                    <option value="South Korea">South Korea</option>
                                    <option value="Spain">Spain</option>
                                    <option value="Taiwan">Taiwan</option>
                                    <option value="Thailand">Thailand</option>
                                    <option value="United Kingdom">United Kingdom</option>
                                    <option value="United States">United States</option>
                                    <option value="Vietnam">Vietnam</option>
                                </select>
                            </div>
                            <div class="sem-input-item">
                                <label for="primaryKeyword">Primary Focus Keyword:</label>
                                <input type="text" id="primaryKeyword" value="seo agency"
                                    placeholder="e.g., seo agency">
                            </div>
                        </div>
                        <div class="sem-input-item" style="margin-top: 15px;">
                            <label for="secondaryKeywords">Secondary Keywords (one per line):</label>
                            <textarea id="secondaryKeywords" placeholder="Enter secondary keywords..."
                                style="min-height: 100px;">seo marketing singapore
seo agencies in singapore</textarea>
                        </div>
                        <button id="btnResearchPersonasOptimise" type="button" class="btn-action"
                            style="margin-top: 10px; padding: 8px 16px; font-size: 0.9em; width: auto; background: #6c757d; color: white;"
                            onclick="navigateToPersonas('optimiseExistingFlow')">
                            <i class="fas fa-users"></i> Research Target Personas
                        </button>
                    </div>

                    <div class="sem-step-card" style="margin-top: 20px;">
                        <div class="sem-card-title"><i class="fas fa-shield-halved"></i> AI Compliance & Guidelines
                        </div>
                        <div id="complianceRecommenderWrapper-Optimise"
                            style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e1e4e8; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                                <p style="font-size: 13px; color: #666; margin: 0;">Scan for relevant regulations or
                                    guidelines:</p>
                                <button id="btnScanCompliance-Optimise" class="btn-gradient"
                                    style="background: #34a853; padding: 10px 16px; font-size: 12px; margin: 0; white-space: nowrap; width: auto; border-radius: 8px;"
                                    onclick="scanForCompliance('optimise')">
                                    <i class="fas fa-search"></i> Scan Guidelines
                                </button>
                            </div>
                            <div id="complianceGuidelinesList-Optimise"
                                style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0;">
                                <div style="font-size: 12px; color: #999; width: 100%; font-style: italic;">No
                                    guidelines checked yet.</div>
                            </div>
                            <div class="sem-input-item">
                                <label for="customCompliance-Optimise">Custom Instructions / Compliance:</label>
                                <textarea id="customCompliance-Optimise"
                                    placeholder="e.g., Must mention risk warnings at the end"
                                    style="min-height: 60px;"></textarea>
                            </div>
                        </div>
                    </div>

                    <button class="config-btn-highlight" onclick="openAiSettingsModal()"
                        style="margin-top: 10px; background: #666;">
                        <i class="fas fa-sliders-h"></i> Full Optimiser Configuration
                    </button>

                    <div style="margin-top: 30px; text-align: center;">
                        <button id="btnAnalyseCompetitorsOptimise" class="btn-gradient"
                            style="background: #1a73e8; padding: 15px 40px; font-size: 1.1em; display: inline-block; width: auto; min-width: 300px; border-radius: 12px; box-shadow: 0 4px 15px rgba(26, 115, 232, 0.3);"
                            onclick="analyseCompetitorsOptimise()">
                            <i class="fas fa-search-plus"></i> STEP 1: Analyse SERP Competitors & Fetch Insights
                        </button>
                    </div>


                    <!-- Competitor Insights Display (Optimise Flow) -->
                    <div id="competitorAnalysisWrapper-Optimise"
                        style="display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                        <div class="competitor-insights-title">
                            <i class="fas fa-chart-line"></i> Competitor Content Insights
                        </div>
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                            We've analysed the top 10 SERP competitors for your keywords. <b>Select multiple
                                topics
                                by clicking on the rows across different cards</b>, then click the "Run AI
                            Gap
                            Analysis" button below to continue.
                        </p>
                        <div
                            style="margin-bottom: 15px; display: flex; gap: 10px; justify-content: flex-end; align-items: center; flex-wrap: wrap;">
                            <button id="btnAiPick-optimise" onclick="aiPickTopics('optimise')"
                                style="background: #f3e5f5; color: #9c27b0; border: 1px solid #d1c4e9; padding: 8px 16px; border-radius: 8px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                <i class="fas fa-robot"></i> AI Select Topics
                            </button>
                            <button onclick="selectAllTopics('optimise')"
                                style="background: #e7f3ff; color: #007bff; border: 1px solid #cce5ff; padding: 8px 16px; border-radius: 8px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                <i class="fas fa-check-double"></i> Select All Topics
                            </button>
                            <button onclick="deselectAllTopics('optimise')"
                                style="background: #fff1f0; color: #ff4d4f; border: 1px solid #ffa39e; padding: 8px 16px; border-radius: 8px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                                <i class="fas fa-times-circle"></i> Deselect All
                            </button>
                            <div class="topic-legend" style="width: 100%; margin-top: 5px;">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #1a73e8;"></div>
                                    <span>User Picked</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background: #9c27b0;"></div>
                                    <span>AI Recommended</span>
                                </div>
                            </div>
                        </div>
                        <div id="undo-bar-competitor" class="undo-bar" style="display: none;">
                            <button class="btn-undo" onclick="undoDeletion()">
                                <i class="fas fa-undo-alt"></i> Undo Deletion
                            </button>
                        </div>
                        <div id="competitorInsightsGrid-Optimise" class="competitor-insights-grid">
                            <!-- Competitor cards will be injected here -->
                        </div>

                        <div id="loadMoreWrapper-Optimise" style="display: none; text-align: center; margin-top: 20px;">
                            <button id="btnLoadMoreCompetitors-Optimise" class="btn-action"
                                style="min-width: 200px; padding: 10px 20px; font-size: 0.9em;"
                                onclick="loadMoreCompetitors('optimise')">
                                <i class="fas fa-plus"></i> Load More Competitors
                            </button>
                        </div>

                        <div id="selectedTopicsWrapper-Optimise"
                            style="display: none; margin-top: 25px; background: #f0f7ff; padding: 20px; border-radius: 12px; border: 1px solid #cce5ff;">
                            <label for="selectedTopicsText-Optimise"
                                style="font-weight: bold; color: #004c9d; display: block; margin-bottom: 10px;">
                                <i class="fas fa-tags"></i> Picked Topics for Analysis
                            </label>
                            <p style="font-size: 0.85em; color: #555; margin-bottom: 10px;">
                                Click on rows in the competitor cards to add/remove topics. You can also
                                edit these
                                manually.
                            </p>
                            <textarea id="selectedTopicsText-Optimise"
                                style="width: 100%; min-height: 100px; padding: 12px; border-radius: 8px; border: 1px solid #b8daff; box-sizing: border-box; font-size: 0.9em; line-height: 1.5;"
                                placeholder="Selected topics will appear here..."></textarea>

                            <div style="text-align: right; margin-top: 15px;">
                                <button id="btnRunGapAnalysisFromTopics" class="btn-gradient"
                                    style="background: #28a745; border-radius: 8px; padding: 12px 24px; font-size: 1em; width: auto; min-width: 200px;"
                                    onclick="runGapAnalysisWithTopics('optimise')">
                                    <i class="fas fa-magic"></i> Run AI Gap Analysis
                                </button>
                            </div>
                        </div>

                        <!-- NEW: AI Gap Analysis Results -->
                        <div id="gapAnalysisWrapper-Optimise" class="gap-analysis-container" style="display: none;">
                            <div class="gap-analysis-header">
                                <i class="fas fa-magic"></i> AI Gap Analysis & Improvement Suggestions
                            </div>
                            <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">
                                Review and refine these suggestions. Click the button below to rewrite your
                                article
                                based on these insights.
                            </p>
                            <div id="gapAnalysisLoading-Optimise"
                                style="display: none; padding: 20px; text-align: center; color: #1a73e8; font-size: 0.9em;">
                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                <p style="margin-top: 10px;">Generating gap analysis based on competitor
                                    data...</p>
                            </div>
                            <div id="gapAnalysisResults-Optimise" class="gap-analysis-results-area"
                                contenteditable="true"
                                data-placeholder="AI-generated suggestions will appear here after analysis. You can edit these directly...">
                            </div>

                            <button id="btnApplyGapRewrite" class="btn-rewrite-suggestions"
                                onclick="applyGapAnalysisRewrite()" style="border-radius: 8px;">
                                <i class="fas fa-pen-fancy"></i> Apply Suggestions & Rewrite Article
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="optimiser-layout">
                <!-- Main Editor Column -->
                <div class="editor-main">
                    <div class="editor-container">
                        <div class="editor-header">
                            <div class="editor-title-container">
                                <label style="width:5%;">Title</label>
                                <input type="text" id="editorTitle" class="editor-title-input"
                                    value="Top-Rated SEO Agency in Singapore | MediaOne Marketing"
                                    placeholder="Enter post title...">
                            </div>
                            <div class="editor-metrics">
                                <span>Word Count: <span id="editorHeaderWordCount">0</span></span>
                            </div>
                        </div>
                        <div class="editor-toolbar">
                            <div class="toolbar-row">
                                <div class="toolbar-group">
                                    <button class="toolbar-btn" onclick="execCmd('undo')" title="Undo"><i
                                            class="fas fa-undo"></i></button>
                                    <button class="toolbar-btn" onclick="execCmd('redo')" title="Redo"><i
                                            class="fas fa-redo"></i></button>
                                </div>
                                <div class="toolbar-group">
                                    <button class="toolbar-btn" onclick="execCmd('bold')" title="Bold"><i
                                            class="fas fa-bold"></i></button>
                                    <button class="toolbar-btn" onclick="execCmd('italic')" title="Italic"><i
                                            class="fas fa-italic"></i></button>
                                    <button class="toolbar-btn" onclick="execCmd('strikeThrough')"
                                        title="Strikethrough"><i class="fas fa-strikethrough"></i></button>
                                    <button class="toolbar-btn" onclick="execCmd('formatBlock', 'pre')" title="Code"><i
                                            class="fas fa-code"></i></button>
                                    <button class="toolbar-btn" onclick="execCmd('underline')" title="Underline"><i
                                            class="fas fa-underline"></i></button>
                                </div>
                                <div class="toolbar-group">
                                    <button class="toolbar-btn" onclick="insertLink()" title="Insert Manual Link"><i
                                            class="fas fa-link"></i></button>
                                    <button class="toolbar-btn"
                                        onclick="document.getElementById('imageUploadInput').click()"
                                        title="Upload Image"><i class="fas fa-upload"></i></button>
                                    <button class="toolbar-btn" onclick="insertImage()" title="Insert Image Link"><i
                                            class="fas fa-image"></i></button>
                                    <input type="file" id="imageUploadInput" style="display: none;" accept="image/*"
                                        onchange="handleLocalImageUpload(this)">
                                </div>
                                <div class="toolbar-group">
                                    <button class="toolbar-btn" onclick="execCmd('justifyLeft')" title="Align Left"><i
                                            class="fas fa-align-left"></i></button>
                                    <button class="toolbar-btn" onclick="execCmd('justifyCenter')"
                                        title="Align Center"><i class="fas fa-align-center"></i></button>
                                    <button class="toolbar-btn" onclick="execCmd('justifyRight')" title="Align Right"><i
                                            class="fas fa-align-right"></i></button>
                                </div>
                                <div class="toolbar-group">
                                    <button class="toolbar-btn" onclick="execCmd('formatBlock', 'H1')"
                                        title="Heading 1">H1</button>
                                    <button class="toolbar-btn" onclick="execCmd('formatBlock', 'H2')"
                                        title="Heading 2">H2</button>
                                    <button class="toolbar-btn" onclick="execCmd('formatBlock', 'H3')"
                                        title="Heading 3">H3</button>
                                </div>
                                <div class="toolbar-group">
                                    <button class="toolbar-btn" onclick="execCmd('insertUnorderedList')"
                                        title="Bullet List"><i class="fas fa-list-ul"></i></button>
                                    <button class="toolbar-btn" onclick="execCmd('insertOrderedList')"
                                        title="Numbered List"><i class="fas fa-list-ol"></i></button>
                                    <button class="toolbar-btn" onclick="execCmd('formatBlock', 'blockquote')"
                                        title="Quote"><i class="fas fa-quote-right"></i></button>
                                </div>
                                <div class="toolbar-group">
                                    <button class="toolbar-btn" onclick="insertTable()" title="Insert Table"><i
                                            class="fas fa-table"></i></button>
                                    <button id="btnRunSmartLinkingToolbar" class="toolbar-btn"
                                        onclick="runSmartLinking()"
                                        style="width: auto; padding: 0 10px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 5px; background: #f0f7ff; color: #0066cc; border: 1px solid #cce5ff; border-radius: 4px; margin-left: 10px;"
                                        title="Run Smart AI Citations (Auto-Link)">
                                        <i class="fas fa-magic"></i> AI Links
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="rewriteReviewBar" class="review-bar" style="display: none;">
                            <div class="review-info">
                                <i class="fas fa-eye"></i> <strong>Reviewing AI Rewrite</strong>
                            </div>
                            <div class="review-bar-buttons">
                                <button class="btn-review btn-accept-rewrite" onclick="finalizeReview()">Done
                                    Reviewing</button>
                                <button class="btn-review btn-accept-rewrite" onclick="acceptRewrite()">Accept All
                                    Remaining</button>
                                <button class="btn-review btn-reject-rewrite" onclick="rejectRewrite()">Reject
                                    All</button>
                            </div>
                        </div>
                        <div id="editorContent" class="editor-content" contenteditable="true"
                            oninput="updateEditorMetrics()">
                            <h1>Top-Rated SEO Agency in Singapore | MediaOne Marketing</h1>
                            <p>As the leading <b>SEO agency</b> in Singapore, MediaOne Marketing is
                                dedicated to
                                helping businesses achieve unprecedented digital growth through strategic
                                search
                                engine optimisation. In today's competitive landscape, having a strong
                                online
                                presence is no longer optionalit's essential for survival and success. Our
                                <b>SEO
                                    marketing Singapore</b> team combines years of expertise with
                                cutting-edge
                                technology to deliver results that truly matter across all industries.
                            </p>
                            <h2>Why Work With One of the Best SEO Agencies in Singapore?</h2>
                            <p>Unlike other <b>seo agencies in singapore</b>, MediaOne takes a holistic
                                approach to
                                digital marketing. We understand that <b>SEO services Singapore</b> aren't
                                just
                                about rankings; they are about driving high-quality traffic that converts
                                into loyal
                                customers. Our enterprise SEO strategies are data-driven, ensuring that
                                every move
                                we make is backed by rigorous analysis and search volume insights. We don't
                                just
                                guess; we prove our value through consistent performance metrics.</p>
                            <h3>Our Specialized SEO Methodology</h3>
                            <p>Our process begins with finding high-intent keywords like <i>SEO marketing
                                    Singapore</i> and <i>best seo agency Singapore</i>. We then optimize
                                your site's
                                structure, content, and backlink profile to ensure maximum visibility on
                                Google. As
                                a full-service <b>digital marketing agency Singapore</b>, we don't just stop
                                at
                                technical SEO. We craft compelling content that speaks directly to your
                                audience's
                                needs, establishing your brand as a primary authority in your niche. By
                                bridging the
                                gap between user intent and technical excellence, we ensure long-term
                                growth.</p>
                            <p>Whether you are a local SME or a global enterprise, our <b>Search Engine
                                    Optimisation
                                    Singapore</b> services are tailored to meet your specific goals and
                                budgets. We
                                focus on long-term sustainability, helping you climb the SERPs and stay
                                there even
                                through algorithm updates. Partner with MediaOne, the <b>SEO agency
                                    Singapore</b>
                                trusts, and experience the difference that professional optimization can
                                make for
                                your bottom line. Let's transform your digital journey together into a
                                success story
                                that inspires others.</p>
                            <p>Our commitment to transparency means you get real-time reports and clear
                                communication every step of the way. Stop leaving your traffic to chance and
                                start
                                dominating the search results today.</p>
                        </div>

                        <!-- Floating Selection Toolbar -->
                        <div id="selectionToolbar" class="selection-toolbar">
                            <textarea id="stCustomInstructions"
                                placeholder="Add specific instructions or comments for the AI..."></textarea>
                            <div class="st-buttons-wrapper">
                                <button onclick="handleSelectionAction('rewrite')"><i class="fas fa-magic"></i>
                                    Rewrite</button>
                                <button onclick="handleSelectionAction('expand')"><i class="fas fa-expand-alt"></i>
                                    Expand</button>
                                <button onclick="handleSelectionAction('shorten')"><i class="fas fa-compress-alt"></i>
                                    Shorten</button>
                                <div class="st-separator"></div>
                                <button class="st-settings" onclick="openAiSettingsModal()"><i
                                        class="fas fa-cog"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar -->
                <div class="sidebar-right">
                    <!-- Panel 1: SEO Analysis -->
                    <div class="sidebar-card">
                        <div class="gauge-container">
                            <svg class="gauge-svg" viewBox="0 0 160 160">
                                <circle class="gauge-bg" cx="80" cy="80" r="70"></circle>
                                <circle id="seoScoreGauge" class="gauge-fill" cx="80" cy="80" r="70"
                                    style="stroke-dashoffset: 440;"></circle>
                            </svg>
                            <div class="gauge-text">
                                <span id="seoScoreValue" class="gauge-score">0</span>
                                <span class="gauge-label">SEO Score</span>
                            </div>
                        </div>

                        <div class="metric-item">
                            <div class="metric-header"><span>Title</span><span id="titleScore">0%</span>
                            </div>
                            <div class="progress-bar-bg">
                                <div id="titleBar" class="progress-bar-fill" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-header"><span>Headings</span><span id="headingsScore">0%</span></div>
                            <div class="progress-bar-bg">
                                <div id="headingsBar" class="progress-bar-fill" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-header"><span>Readability</span><span id="readabilityScore">0%</span>
                            </div>
                            <div class="progress-bar-bg">
                                <div id="readabilityBar" class="progress-bar-fill" style="width: 0%;"></div>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-header"><span>Intent & E-E-A-T</span><span id="intentEeatScore">0%</span>
                            </div>
                            <div class="progress-bar-bg">
                                <div id="intentEeatBar" class="progress-bar-fill" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div class="stats-row">
                            <div class="stats-item"><i class="fas fa-file-alt"></i> Words: <span id="wordCount">0</span>
                            </div>
                        </div>
                        <div class="stats-row" style="margin-top: -10px;">
                            <div class="stats-item"><i class="fas fa-coins"></i> Tokens (est): <span
                                    id="tokenCount">0</span></div>
                        </div>

                        <button id="btnRunSeoAnalysis" class="btn-gradient btn-seo" onclick="runSeoAnalysis()">
                            <i class="fas fa-search"></i> Run SEO Analysis
                        </button>

                        <div id="seoActionPlanContainer" class="seo-action-plan" style="display: none;">
                            <div class="action-plan-header">
                                <i class="fas fa-tasks"></i> Path to 100% Score
                            </div>
                            <div id="seoActionList" class="action-list">
                                <!-- Action items will be injected here -->
                            </div>
                        </div>
                    </div>

                    <!-- Panel 2: Intelligence Tabs -->
                    <div class="sidebar-card" style="padding: 15px;">
                        <div class="sidebar-tabs">
                            <button class="tab-btn active" onclick="switchOptimiserTab('keywords')"><i
                                    class="fas fa-chart-bar"></i>Keywords</button>
                            <button class="tab-btn" onclick="switchOptimiserTab('ai')"><i
                                    class="fas fa-magic"></i>AI</button>
                            <button class="tab-btn" onclick="switchOptimiserTab('check')"><i
                                    class="fas fa-check-circle"></i>Check</button>
                        </div>

                        <!-- Keywords Tab -->
                        <div id="tab-keywords" class="tab-content active">
                            <button class="btn-gradient btn-keywords" style="background: #004c9d;"
                                onclick="analyzeKeywordFrequency()">
                                <i class="fas fa-sync-alt"></i> Re-analyse Keywords
                            </button>
                            <div
                                style="font-size: 13px; color: #666; display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span>Keywords Found: <b id="kwsFound">0</b></span>
                                <span>Total Words: <b id="totalWordsStat">0</b></span>
                            </div>
                            <div id="keywordFrequencyList" class="keyword-freq-list">
                                <p style="text-align: center; color: #999; font-style: italic; margin-top:20px;">
                                    No
                                    keywords analysed yet.</p>
                            </div>
                        </div>

                        <!-- AI Tab -->
                        <div id="tab-ai" class="tab-content">
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 10px;">Generate
                                Content
                            </div>
                            <textarea id="aiPrompt" class="ai-prompt-area"
                                placeholder="e.g., Write a paragraph about benefits of SEO..."></textarea>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button id="btnAiGenerate" class="btn-gradient" style="background: #004c9d; flex: 1;"
                                    onclick="aiGenerateContent()">
                                    <i class="fas fa-magic"></i> Generate
                                </button>
                                <button id="btnAiContinue" class="btn-gradient" style="background: #004c9d; flex: 1;"
                                    onclick="aiContinueWriting()">
                                    <i class="fas fa-pen"></i> Continue
                                </button>
                            </div>
                        </div>

                        <!-- Check Tab -->
                        <div id="tab-check" class="tab-content">
                            <button class="btn-gradient" style="background: #004c9d; margin-bottom: 20px;"
                                onclick="runPlagiarismCheck()">
                                <i class="fas fa-search"></i> Check Plagiarism
                            </button>
                            <div class="sidebar-card"
                                style="border: 1px solid #eee; padding: 15px; margin-bottom: 15px;">
                                <div id="plagiarismScore"
                                    style="font-size: 32px; font-weight: 800; text-align: center; color: #2b8a3e;">
                                    100.0%</div>
                                <div style="text-align: center; font-weight: 600; color: #333;">Excellent
                                </div>
                                <div style="text-align: center; font-size: 13px; color: #888;">Originality
                                    Score
                                </div>
                                <div id="plagiarismMeta"
                                    style="text-align: center; font-size: 13px; color: #555; margin-top: 10px;">
                                    0
                                    words  0 match(es)</div>
                            </div>
                            <div id="plagiarismStatus" class="status-box">
                                <i class="fas fa-check-circle"></i>
                                <div>
                                    <div id="plagiarismTitle">No Plagiarism Detected</div>
                                    <div id="plagiarismMsg" style="font-size: 12px; font-weight: 400; opacity: 0.8;">
                                        Your content
                                        appears to be original.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <hr>
        </div>


        <div id="gscIntegrationSection">
            <div class="page-break"></div>
            <button class="collapsible" id="gscIntegrationBtn"><i class="fas fa-plus-square"></i><i
                    class="fab fa-google"></i>Google Search Console</button>
            <div class="content" id="gscContent" style="display: none; padding: 20px;">
                <!-- Auth Section -->
                <div id="gscAuthSection"
                    style="margin-bottom: 20px; padding: 15px; background: #e8f0fe; border-radius: 8px; border: 1px solid #c2d7fa;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <h4 style="margin: 0; color: #1967d2;"><i class="fab fa-google"></i> Google
                                Authentication
                            </h4>
                            <p id="gscAuthStatus" style="margin: 5px 0 0 0; font-size: 13px; color: #5f6368;">Not
                                connected.
                                Connect to your Google account to use GSC tools.</p>
                        </div>
                        <button class="btn-gradient" id="btnConnectGsc" onclick="connectGsc()"
                            style="background: #1a73e8; width: 180px;">
                            <i class="fas fa-link"></i> Connect GSC
                        </button>
                    </div>

                    <!-- Property Selector -->
                    <div id="gscPropertySelector"
                        style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #c2d7fa;">
                        <label
                            style="font-size: 13px; color: #1967d2; font-weight: bold; display: block; margin-bottom: 8px;">Select
                            Property:</label>
                        <select id="gscSiteList" onchange="updateSelectedProperty()"
                            style="width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #c2d7fa; font-family: inherit; font-size: 14px; background: #fff;">
                            <option value="">-- Loading properties... --</option>
                        </select>
                        <p id="gscPropertyHint" style="margin: 8px 0 0 0; font-size: 11px; color: #666;">
                            Only
                            properties
                            where you have full or owner permissions will appear.</p>
                    </div>
                </div>

                <!-- Tabs -->
                <div id="gscTabsSection" style="display: none; margin-top: 10px;">
                    <div class="gsc-tabs">
                        <div class="gsc-tab active" onclick="switchGscTab('indexing')">
                            <i class="fas fa-search"></i> Inspection & Indexing
                        </div>
                        <div class="gsc-tab" onclick="switchGscTab('insights')">
                            <i class="fas fa-chart-line"></i> Search Insights
                        </div>
                        <div class="gsc-tab" onclick="switchGscTab('actionables')">
                            <i class="fas fa-list-check"></i> Actionables
                        </div>
                    </div>

                    <div id="gscToolsArea" style="opacity: 0.5;">
                        <!-- Indexing Tab Panel -->
                        <div id="panel-indexing" class="gsc-tab-panel active">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <!-- Inspection Tool -->
                                <div
                                    style="background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 20px;">
                                    <h3 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-search" style="color: #4285f4;"></i> URL Inspection
                                    </h3>
                                    <p style="font-size: 13px; color: #666; margin-bottom: 15px;">Enter URLs
                                        to
                                        check
                                        index
                                        status (one per line):</p>
                                    <textarea id="gscInspectUrls" placeholder="e.g., https://example.com/page-1"
                                        style="width: 100%; min-height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; margin-bottom: 15px;"></textarea>
                                    <button class="btn-gradient" id="btnRunGscInspection"
                                        style="background: #4285f4; width: 100%;" onclick="runGscInspection()">
                                        <i class="fas fa-play"></i> Run Bulk Inspection
                                    </button>
                                </div>

                                <!-- Indexing Tool -->
                                <div
                                    style="background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 20px;">
                                    <h3 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-upload" style="color: #34a853;"></i> Indexing
                                        Submission
                                    </h3>
                                    <p style="font-size: 13px; color: #666; margin-bottom: 15px;">List URLs
                                        for
                                        indexing,
                                        re-indexing, or deletion (one per line):</p>
                                    <textarea id="gscIndexUrls" placeholder="e.g., https://example.com/new-page"
                                        style="width: 100%; min-height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; margin-bottom: 15px;"></textarea>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn-gradient" id="btnSubmitGscIndexing"
                                            style="background: #34a853; flex: 1;"
                                            onclick="submitGscIndexing('URL_UPDATED')">
                                            <i class="fas fa-check-circle"></i> Submit Indexing
                                        </button>
                                        <button class="btn-gradient" id="btnRequestGscDeletion"
                                            style="background: #ea4335; flex: 1;"
                                            onclick="submitGscIndexing('URL_DELETED')">
                                            <i class="fas fa-trash-alt"></i> Request Deletion
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Insights Tab Panel -->
                        <div id="panel-insights" class="gsc-tab-panel">
                            <div
                                style="background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                <div
                                    style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                                    <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-lightbulb" style="color: #fbbc05;"></i> Search
                                        Insights &
                                        Wins
                                    </h3>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="text" id="gscBrandName" placeholder="Brand keywords (comma split)"
                                            style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd; font-size: 14px; width: 150px;">
                                        <select id="gscInsightPeriod"
                                            style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd; font-size: 14px;">
                                            <option value="30">Last 30 Days</option>
                                            <option value="90" selected>Last 90 Days</option>
                                            <option value="180">Last 6 Months</option>
                                        </select>
                                        <button class="btn-gradient" style="background: #1a73e8; padding: 8px 15px;"
                                            onclick="fetchGscSearchInsights()">
                                            <i class="fas fa-sync-alt"></i> Refresh Insights
                                        </button>
                                    </div>
                                </div>

                                <div id="gscInsightsLoader" style="display: none; text-align: center; padding: 40px;">
                                    <i class="fas fa-spinner fa-spin fa-2x" style="color: #4285f4;"></i>
                                    <p style="margin-top: 10px; color: #666;">Analyzing search performance
                                        data...
                                    </p>
                                </div>

                                <div id="gscInsightsContent" style="display: none;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                        <!-- Striking Distance Card -->
                                        <div class="insight-card">
                                            <div class="insight-header">
                                                <i class="fas fa-rocket" style="color: #1e8e3e;"></i>
                                                <h4 style="margin: 0; flex: 1;">Striking Distance (Page 2)
                                                </h4>
                                                <span class="insight-score-badge badge-win">Easy Wins</span>
                                            </div>
                                            <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
                                                Keywords
                                                ranking #11-#20. A small boost could push these to Page 1.
                                            </p>
                                            <div id="list-striking-distance"
                                                style="max-height: 200px; overflow-y: auto;">
                                            </div>
                                        </div>

                                        <!-- Featured Snippets Card -->
                                        <div class="insight-card">
                                            <div class="insight-header">
                                                <i class="fas fa-magic" style="color: #fbbc05;"></i>
                                                <h4 style="margin: 0; flex: 1;">Featured Snippet Potential
                                                </h4>
                                                <span class="insight-score-badge"
                                                    style="background: #fff8e1; color: #f57c00;">Quick
                                                    Win</span>
                                            </div>
                                            <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
                                                Keywords
                                                in
                                                Pos 2-7 with high impressions. Optimize for featured
                                                snippets.</p>
                                            <div id="list-featured-snippets"
                                                style="max-height: 200px; overflow-y: auto;">
                                            </div>
                                        </div>

                                        <!-- Low CTR Card -->
                                        <div class="insight-card">
                                            <div class="insight-header">
                                                <i class="fas fa-mouse-pointer" style="color: #d93025;"></i>
                                                <h4 style="margin: 0; flex: 1;">Underperforming CTR</h4>
                                                <span class="insight-score-badge badge-warning">Fix
                                                    Title/Meta</span>
                                            </div>
                                            <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
                                                High
                                                impression queries in top positions with low clicks.</p>
                                            <div id="list-low-ctr" style="max-height: 200px; overflow-y: auto;">
                                            </div>
                                        </div>
                                    </div>

                                    <div
                                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                                        <!-- Cannibalization Card -->
                                        <div class="insight-card">
                                            <div class="insight-header">
                                                <i class="fas fa-exclamation-triangle" style="color: #ea4335;"></i>
                                                <h4 style="margin: 0; flex: 1;">Keyword Cannibalization</h4>
                                                <span class="insight-score-badge"
                                                    style="background: #fce8e6; color: #c5221f;">Multiple
                                                    Pages</span>
                                            </div>
                                            <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
                                                Multiple
                                                pages
                                                ranking for the same keyword. Consider merging content.</p>
                                            <div id="list-cannibalization" style="max-height: 200px; overflow-y: auto;">
                                            </div>
                                        </div>

                                        <!-- Performance Split Card -->
                                        <div class="insight-card">
                                            <div class="insight-header">
                                                <i class="fas fa-chart-pie" style="color: #1a73e8;"></i>
                                                <h4 style="margin: 0; flex: 1;">Branded vs Non-Branded</h4>
                                                <span class="insight-score-badge"
                                                    style="background: #e8f0fe; color: #1967d2;">Traffic
                                                    Mix</span>
                                            </div>
                                            <div id="stats-brand-split"
                                                style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                                                <div
                                                    style="display: flex; justify-content: space-between; font-size: 14px;">
                                                    <span>Branded:</span> <b id="val-branded-clicks">0</b>
                                                </div>
                                                <div
                                                    style="display: flex; justify-content: space-between; font-size: 14px;">
                                                    <span>Non-Branded:</span> <b id="val-nonbranded-clicks">0</b>
                                                </div>
                                                <div class="progress-bar-bg" style="height: 8px;">
                                                    <div id="bar-brand-split" class="progress-bar-fill"
                                                        style="width: 0%; background: #1a73e8;"></div>
                                                </div>
                                                <p style="font-size: 12px; color: #999; margin-top: 5px;">
                                                    *Non-branded
                                                    clicks are the true measure of SEO growth.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Top Keywords Table -->
                                    <div style="margin-top: 20px;">
                                        <h4 style="margin-bottom: 10px;">Top Ranking Queries</h4>
                                        <div style="overflow-x: auto;">
                                            <table
                                                style="width: 100%; border-collapse: collapse; font-size: 13px; border: 1px solid #eee; table-layout: fixed;">
                                                <thead>
                                                    <tr style="background: #f8f9fa;">
                                                        <th onclick="sortByGscColumn('query')"
                                                            style="padding: 8px; text-align: left; border-bottom: 2px solid #eee; cursor: pointer; width: 40%;">
                                                            Query <i id="sort-icon-query" class="fas fa-sort"></i>
                                                        </th>
                                                        <th onclick="sortByGscColumn('clicks')"
                                                            style="padding: 8px; text-align: right; border-bottom: 2px solid #eee; cursor: pointer; width: 15%;">
                                                            Clicks <i id="sort-icon-clicks"
                                                                class="fas fa-sort-down"></i>
                                                        </th>
                                                        <th onclick="sortByGscColumn('impressions')"
                                                            style="padding: 8px; text-align: right; border-bottom: 2px solid #eee; cursor: pointer; width: 15%;">
                                                            Impr. <i id="sort-icon-impressions" class="fas fa-sort"></i>
                                                        </th>
                                                        <th onclick="sortByGscColumn('ctr')"
                                                            style="padding: 8px; text-align: right; border-bottom: 2px solid #eee; cursor: pointer; width: 15%;">
                                                            CTR <i id="sort-icon-ctr" class="fas fa-sort"></i></th>
                                                        <th onclick="sortByGscColumn('position')"
                                                            style="padding: 8px; text-align: right; border-bottom: 2px solid #eee; cursor: pointer; width: 15%;">
                                                            Pos. <i id="sort-icon-position" class="fas fa-sort"></i>
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody id="table-performance-body"></tbody>
                                            </table>
                                        </div>
                                        <!-- Pagination Controls -->
                                        <div id="gscPagination"
                                            style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px; padding: 5px 10px; background: #f8f9fa; border-top: 1px solid #eee; font-size: 13px;">
                                            <button onclick="changeGscPage(-1)" id="btnGscPrevPage"
                                                style="padding: 5px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Previous</button>
                                            <span id="gscPageIndicator">Page 1 of 1</span>
                                            <button onclick="changeGscPage(1)" id="btnGscNextPage"
                                                style="padding: 5px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Next</button>
                                        </div>
                                    </div>
                                    <div id="gscInsightsEmpty" style="text-align: center; padding: 40px; color: #999;">
                                        <i class="fas fa-chart-bar fa-3x"
                                            style="margin-bottom: 10px; opacity: 0.3;"></i>
                                        <p>Click "Refresh Insights" to load SEO performance data.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Actionables Tab Panel -->
                        <div id="panel-actionables" class="gsc-tab-panel">
                            <div class="gsc-masterclass-container">

                                <!-- Section 1: Optimizing Existing Content -->
                                <section class="masterclass-section">
                                    <h3 onclick="toggleActionableSection(this)"><i class="fas fa-chart-line"></i>
                                        Section 1: Optimizing Existing Content</h3>
                                    <div class="actionable-collapsible-content">
                                        <p style="font-size: 14px; color: #5f6368; margin-bottom: 20px;">
                                            Leverage pages that already have some authority to achieve
                                            quicker wins.
                                        </p>

                                        <div class="step-list">
                                            <div class="step-item">
                                                <div class="step-number">1</div>
                                                <div class="step-content">
                                                    <strong>Access the Performance Report</strong>
                                                    <p>Navigate to the Search Insights tab and set the date
                                                        range to
                                                        "Last 3 months" or "Last 6 months" to get a
                                                        significant data
                                                        set.</p>
                                                </div>
                                            </div>
                                            <div class="step-item">
                                                <div class="step-number">2</div>
                                                <div class="step-content">
                                                    <strong>Filter by Page</strong>
                                                    <p>Identify a specific URL you suspect is
                                                        underperforming or has
                                                        high potential. Filter the data view to only that
                                                        page.</p>
                                                </div>
                                            </div>
                                            <div class="step-item">
                                                <div class="step-number">3</div>
                                                <div class="step-content">
                                                    <strong>Identify "Striking Distance" Keywords</strong>
                                                    <p>Sort by "Position" and look for keywords ranking
                                                        between
                                                        positions 6 and 20. These are your "striking
                                                        distance"
                                                        opportunities.</p>
                                                </div>
                                            </div>
                                            <div class="step-item">
                                                <div class="step-number">4</div>
                                                <div class="step-content">
                                                    <strong>Analyze High Impression / Low CTR</strong>
                                                    <p>Look for queries with high impressions but low CTR.
                                                        This
                                                        indicates relevance but poor click appeal.</p>
                                                </div>
                                            </div>
                                            <div class="step-item">
                                                <div class="step-number">5</div>
                                                <div class="step-content">
                                                    <strong>Update & Optimize</strong>
                                                    <p>Weave these keywords into H1s, H2s, and the first 100
                                                        words.
                                                        Rewrite Title Tags to be more benefit-driven.</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="masterclass-table-container" style="margin-top: 20px;">
                                            <div
                                                style="padding: 10px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                                <span style="font-weight: 600; font-size: 13px;">Identify
                                                    "Striking
                                                    Distance" Wins</span>
                                                <button class="btn-gradient" onclick="runMasterclassSection('striking')"
                                                    style="background: #1e8e3e; padding: 5px 12px; font-size: 12px;">
                                                    <i class="fas fa-search-plus"></i> Run Analysis
                                                </button>
                                            </div>
                                            <div id="masterclass-dynamic-striking">
                                                <table class="masterclass-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Query</th>
                                                            <th>Impr.</th>
                                                            <th>Pos.</th>
                                                            <th>Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td colspan="4"
                                                                style="text-align: center; padding: 20px; color: #999;">
                                                                Click "Run Analysis" to find easy wins.</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div id="pagination-striking" class="actionable-pagination"
                                                style="display:none"></div>
                                        </div>
                                    </div>
                                </section>

                                <!-- Section 2: Finding Content Ideas -->
                                <section class="masterclass-section">
                                    <h3 onclick="toggleActionableSection(this)"><i class="fas fa-lightbulb"></i>
                                        Section
                                        2: Finding Content Ideas</h3>
                                    <div class="actionable-collapsible-content">
                                        <div class="masterclass-table-container" style="margin-top: 20px;">
                                            <div
                                                style="padding: 10px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                                <span style="font-weight: 600; font-size: 13px;">Extract
                                                    Content
                                                    Ideas
                                                    from
                                                    Gaps</span>
                                                <button class="btn-gradient" onclick="runMasterclassSection('gaps')"
                                                    style="background: #fbbc05; color: #3c4043; padding: 5px 12px; font-size: 12px;">
                                                    <i class="fas fa-lightbulb"></i> Find Gaps
                                                </button>
                                            </div>
                                            <div id="masterclass-dynamic-gaps">
                                                <table class="masterclass-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Question Query</th>
                                                            <th>Impr.</th>
                                                            <th>Clicks</th>
                                                            <th>Potential</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td colspan="4"
                                                                style="text-align: center; padding: 20px; color: #999;">
                                                                Click "Find Gaps" to unlock new content
                                                                ideas.</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div id="pagination-gaps" class="actionable-pagination"
                                                style="display:none"></div>
                                        </div>
                                    </div>
                                </section>

                                <!-- Section 3: Optimizing Semantic Content -->
                                <section class="masterclass-section">
                                    <h3 onclick="toggleActionableSection(this)"><i class="fas fa-project-diagram"></i>
                                        Section 3: Optimizing Semantic Content</h3>
                                    <div class="actionable-collapsible-content">
                                        <div class="masterclass-table-container" style="margin-top: 20px;">
                                            <div
                                                style="padding: 10px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                                <span style="font-weight: 600; font-size: 13px;">Analyze
                                                    Semantic
                                                    Clusters</span>
                                                <button class="btn-gradient" onclick="runMasterclassSection('semantic')"
                                                    style="background: #1a73e8; padding: 5px 12px; font-size: 12px;">
                                                    <i class="fas fa-project-diagram"></i> Map Clusters
                                                </button>
                                            </div>
                                            <div id="masterclass-dynamic-semantic">
                                                <table class="masterclass-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Core URL</th>
                                                            <th>Query Mix</th>
                                                            <th>Recommendation</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td colspan="3"
                                                                style="text-align: center; padding: 20px; color: #999;">
                                                                Click "Map Clusters" to analyze topical
                                                                depth.</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div id="pagination-semantic" class="actionable-pagination"
                                                style="display:none"></div>
                                        </div>
                                    </div>
                                </section>

                                <!-- Section 4: Improving Low-Quality Content -->
                                <section class="masterclass-section">
                                    <h3 onclick="toggleActionableSection(this)"><i class="fas fa-trash-alt"></i>
                                        Section
                                        4: Improving Low-Quality Content</h3>
                                    <div class="actionable-collapsible-content">
                                        <div class="masterclass-table-container" style="margin-top: 20px;">
                                            <div
                                                style="padding: 10px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                                <span style="font-weight: 600; font-size: 13px;">Identify
                                                    Low-Quality
                                                    Content (Pruning)</span>
                                                <button class="btn-gradient" onclick="runMasterclassSection('pruning')"
                                                    style="background: #ea4335; padding: 5px 12px; font-size: 12px;">
                                                    <i class="fas fa-trash-alt"></i> Run Audit
                                                </button>
                                            </div>
                                            <div id="masterclass-dynamic-pruning">
                                                <table class="masterclass-table">
                                                    <thead>
                                                        <tr>
                                                            <th>URL</th>
                                                            <th>Clicks</th>
                                                            <th>Impr.</th>
                                                            <th>Decision</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td colspan="4"
                                                                style="text-align: center; padding: 20px; color: #999;">
                                                                Click "Run Audit" to identify "Zombie"
                                                                pages.</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div id="pagination-pruning" class="actionable-pagination"
                                                style="display:none"></div>
                                        </div>
                                    </div>
                                </section>

                            </div>
                        </div>

                        <!-- Result Table (Used by both tabs for logs) -->
                        <div id="gscResults"
                            style="display: none; background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 20px;">
                            <h4
                                style="margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #1967d2;">
                                <i class="fas fa-poll-h"></i> GSC Action Results
                            </h4>

                            <div style="overflow-x: auto; margin-bottom: 20px;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                    <thead>
                                        <tr style="background: #004c9d; border-bottom: 1px solid #1967d2;">
                                            <th style="padding: 12px; text-align: left; width: 50px; color: white;">
                                                No.</th>
                                            <th style="padding: 12px; text-align: left; color: white;">URL
                                            </th>
                                            <th style="padding: 12px; text-align: left; width: 180px; color: white;">
                                                Status/Result</th>
                                        </tr>
                                    </thead>
                                    <tbody id="gscLogsBody"></tbody>
                                </table>
                            </div>

                            <button class="collapsible" id="gscLogsToggle"
                                style="background: #f1f3f4; color: #3c4043; border: 1px solid #dadce0; padding: 8px 15px; border-radius: 4px; font-weight: 500; font-size: 13px; width: auto;">
                                <i class="fas fa-plus-square"></i> View System Logs
                            </button>
                            <div class="content" id="gscLogsContent" style="display: none; padding-top: 15px;">
                                <div id="gscSystemStatus"
                                    style="padding: 10px; font-size: 13px; color: #666; font-family: monospace; background: #fafafa; border-radius: 4px; border: 1px solid #eee;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <button id="goToTop-button" onclick="openJourneyModal()"
        style="position: fixed; bottom: 10px; right: 245px; background-color: #d89030; color: white; border: none; padding: 10px 20px; border-radius: 100px; cursor: pointer; z-index: 1000; font-size:1.2em;box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.7);">
        <i class="fas fa-route"></i>
    </button>

    <button id="cleanup-button" onclick="clearPageState()"
        style="position: fixed; bottom: 10px; right: 80px; background-color: hsl(0, 71%, 49%); color: white; border: none; padding: 10px 20px; border-radius: 100px; cursor: pointer; z-index: 1000; font-size:1.2em;box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.7);">
        Clear Data <i class="fas fa-trash-alt" style="margin-left: 10px;"></i>
    </button>
    <button id="chatbot-button"
        style="position: fixed; bottom: 10px; right: 10px; background-color: hsl(118, 40%, 43%); color: white; border: none; padding: 10px 20px; border-radius: 100px; cursor: pointer; z-index: 1000; font-size:1.2em;box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.7);">
        <i class="fas fa-comment-dots"></i>
    </button>

    <script id="local-business-template" type="text/x-handlebars-template">
        <div class="sem-input-item"><label for="name">Name:</label><input type="text" id="name" placeholder="Acme Corp" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="address">Address:</label><input type="text" id="address" placeholder="123 Main St, Anytown" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="telephone">Telephone:</label><input type="text" id="telephone" placeholder="+1-555-555-5555" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="image">Image URL:</label><input type="url" id="image" placeholder="https://example.com/photo.jpg" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="priceRange">Price Range:</label><input type="text" id="priceRange" placeholder="$$$" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="openingHours">Opening Hours:</label><input type="text" id="openingHours" placeholder="Mo-Fr 09:00-18:00" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="sameAs">Social URL (sameAs):</label><input type="url" id="sameAs" placeholder="https://twitter.com/acme" oninput="updateSchema()"></div>
    </script>

    <script id="product-template" type="text/x-handlebars-template">
        <div class="sem-input-item"><label for="name">Name:</label><input type="text" id="name" placeholder="Super Widget 3000" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="description">Description:</label><input type="text" id="description" placeholder="A high-quality widget for all your needs." oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="brand">Brand:</label><input type="text" id="brand" placeholder="Acme" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="image">Image URL:</label><input type="url" id="image" placeholder="https://example.com/product.jpg" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="sku">SKU:</label><input type="text" id="sku" placeholder="SW3000-B" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="mpn">MPN:</label><input type="text" id="mpn" placeholder="925872" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="category">Category:</label><input type="text" id="category" placeholder="Electronics > Gadgets" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="model">Model:</label><input type="text" id="model" placeholder="W-3000" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="color">Color:</label><input type="text" id="color" placeholder="Midnight Blue" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="material">Material:</label><input type="text" id="material" placeholder="Carbon Fiber" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="size">Size:</label><input type="text" id="size" placeholder="Medium" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="weight">Weight:</label><input type="text" id="weight" placeholder="1.2 kg" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="height">Height:</label><input type="text" id="height" placeholder="10 cm" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="width">Width:</label><input type="text" id="width" placeholder="5 cm" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="depth">Depth:</label><input type="text" id="depth" placeholder="2 cm" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="gtin8">GTIN-8:</label><input type="text" id="gtin8" placeholder="12345678" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="gtin13">GTIN-13:</label><input type="text" id="gtin13" placeholder="1234567890123" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="gtin14">GTIN-14:</label><input type="text" id="gtin14" placeholder="12345678901234" oninput="updateSchema()"></div>
        <div style="margin-top: 10px; font-weight: bold;">Offer:</div>
        <div class="sem-input-item"><label for="offers_price">Price:</label><input type="number" step="0.01" id="offers_price" placeholder="49.99" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="offers_priceCurrency">Currency:</label><input type="text" id="offers_priceCurrency" placeholder="USD" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="offers_availability">Availability:</label><input type="text" id="offers_availability" placeholder="https://schema.org/InStock" oninput="updateSchema()"></div>
        <div style="margin-top: 10px; font-weight: bold;">Rating:</div>
        <div class="sem-input-item"><label for="aggregateRating_ratingValue">Rating Value:</label><input type="number" step="0.1" id="aggregateRating_ratingValue" placeholder="4.5" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="aggregateRating_reviewCount">Review Count:</label><input type="number" id="aggregateRating_reviewCount" placeholder="128" oninput="updateSchema()"></div>
    </script>

    <script id="event-template" type="text/x-handlebars-template">
        <div class="sem-input-item"><label for="name">Name:</label><input type="text" id="name" placeholder="Grand Opening Party" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="description">Description:</label><textarea id="description" placeholder="A celebration for our new store." oninput="updateSchema()"></textarea></div>
        <div class="sem-input-item"><label for="startDate">Start Date:</label><input type="datetime-local" id="startDate" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="endDate">End Date:</label><input type="datetime-local" id="endDate" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="location">Location (Venue Name):</label><input type="text" id="location" placeholder="City Arena" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="image">Image URL:</label><input type="url" id="image" placeholder="https://example.com/event.jpg" oninput="updateSchema()"></div>
        <div style="margin-top: 10px; font-weight: bold;">Tickets/Offer:</div>
        <div class="sem-input-item"><label for="offers_url">Ticket URL:</label><input type="url" id="offers_url" placeholder="https://tickets.com" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="offers_price">Price:</label><input type="number" step="0.01" id="offers_price" placeholder="25.00" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="offers_priceCurrency">Currency:</label><input type="text" id="offers_priceCurrency" placeholder="USD" oninput="updateSchema()"></div>
    </script>

    <script id="article-template" type="text/x-handlebars-template">
        <div class="sem-input-item"><label for="headline">Headline:</label><input type="text" id="headline" placeholder="Exploring the Frontiers of AI" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="description">Description:</label><input type="text" id="description" placeholder="An in-depth look at new AI trends." oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="image">Image URL:</label><input type="url" id="image" placeholder="https://example.com/article.jpg" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="author">Author Name:</label><input type="text" id="author" placeholder="John Doe" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="publisher_name">Publisher Name:</label><input type="text" id="publisher_name" placeholder="Tech Times" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="publisher_logo">Publisher Logo URL:</label><input type="url" id="publisher_logo" placeholder="https://example.com/logo.png" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="datePublished">Date Published:</label><input type="date" id="datePublished" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="dateModified">Date Modified:</label><input type="date" id="dateModified" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="articleBody">Article Body Snippet:</label><textarea id="articleBody" placeholder="The full text or summary..." oninput="updateSchema()"></textarea></div>
    </script>

    <script id="breadcrumblist-template" type="text/x-handlebars-template">
        <div id="breadcrumb-items" style="width: 100%;">
            <div class="breadcrumb-item sem-input-group" style="margin-bottom: 10px; border-bottom: 1px dashed #ddd; padding-bottom: 15px;">
                <div class="sem-input-item"><input type="text" id="name1" placeholder="Page #1's name" oninput="updateSchema()"></div>
                <div class="sem-input-item"><input type="url" id="url1" placeholder="URL #1" oninput="updateSchema()"></div>
                <button class="remove-item config-btn-highlight" style="background: #dc3545; height: 42px; width: 42px; min-width: 42px; margin: 0; display: flex; align-items: center; justify-content: center;" onclick="removeItem(this)"></button>
            </div>
        </div>
        <button class="config-btn-highlight" style="margin: 0;" onclick="addItem()"> + ADD URL </button>
    </script>

    <script id="faqpage-template" type="text/x-handlebars-template">
        <div id="faq-items" style="width: 100%;">
            <div class="faq-item" style="margin-bottom: 15px; border-bottom: 1px dashed #ddd; padding-bottom: 15px; position: relative;">
                <div class="sem-input-item"><input type="text" id="question1" placeholder="Question #1" oninput="updateSchema()"></div>
                <div class="sem-input-item" style="margin-top: 5px;"><textarea id="answer1" placeholder="Answer" oninput="updateSchema()"></textarea></div>
                <button class="remove-item config-btn-highlight" style="background: #dc3545; position: absolute; top: 0; right: 0; height: 32px; width: 32px; min-width: 32px; margin: 0; display: flex; align-items: center; justify-content: center;" onclick="removeFaqItem(this)"></button>
            </div>
        </div>
        <button class="config-btn-highlight" style="margin: 0;" onclick="addFaqItem()">+ ADD QUESTION</button>
    </script>
    <script id="howto-template" type="text/x-handlebars-template">
        <div class="sem-input-item"><label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="description">Description:</label><textarea id="description" oninput="updateSchema()"></textarea></div>
        <div class="sem-input-item"><label for="supply">Supply (JSON-LD array):</label><textarea id="supply" class="json-ld" oninput="updateSchema()"></textarea></div>
        <div class="sem-input-item"><label for="step">Steps (JSON-LD array):</label><textarea id="step" class="json-ld" oninput="updateSchema()"></textarea></div>
        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">* See schema.org/HowTo for structure details.</div>
    </script>

    <script id="jobposting-template" type="text/x-handlebars-template">
        <div class="sem-input-item"><label for="title">Job Title:</label><input type="text" id="title" placeholder="Senior Developer" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="description">Job Description:</label><textarea id="description" placeholder="We are looking for a skilled developer..." oninput="updateSchema()"></textarea></div>
        <div class="sem-input-item"><label for="hiringOrganization_name">Hiring Organization (Name):</label><input type="text" id="hiringOrganization_name" placeholder="Acme Tech" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="hiringOrganization_sameAs">Hiring Organization (Website):</label><input type="url" id="hiringOrganization_sameAs" placeholder="https://acmetech.com" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="jobLocation_address">Job Location (Address):</label><input type="text" id="jobLocation_address" placeholder="123 Main St, City, Country" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="datePosted">Date Posted:</label><input type="date" id="datePosted" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="validThrough">Valid Through:</label><input type="date" id="validThrough" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="employmentType">Employment Type:</label><select id="employmentType" oninput="updateSchema()">
            <option value="FULL_TIME">Full Time</option>
            <option value="PART_TIME">Part Time</option>
            <option value="CONTRACTOR">Contractor</option>
            <option value="TEMPORARY">Temporary</option>
            <option value="INTERN">Intern</option>
            <option value="OTHER">Other</option>
        </select></div>
        <div style="margin-top: 10px; font-weight: bold;">Salary:</div>
        <div class="sem-input-item"><label for="baseSalary_value">Value:</label><input type="number" id="baseSalary_value" placeholder="80000" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="baseSalary_currency">Currency:</label><input type="text" id="baseSalary_currency" placeholder="USD" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="baseSalary_unitText">Unit (e.g. YEAR, MONTH):</label><input type="text" id="baseSalary_unitText" placeholder="YEAR" oninput="updateSchema()"></div>
    </script>


    <script id="organization-template" type="text/x-handlebars-template">
        <div class="sem-input-item"><label for="name">Name:</label><input type="text" id="name" placeholder="Global Trade Corp" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="legalName">Legal Name:</label><input type="text" id="legalName" placeholder="Global Trade Solutions Ltd" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="description">Description:</label><textarea id="description" placeholder="A leading provider of international trade logistics." oninput="updateSchema()"></textarea></div>
        <div class="sem-input-item"><label for="url">URL:</label><input type="url" id="url" placeholder="https://globaltrade.com" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="logo">Logo URL:</label><input type="url" id="logo" placeholder="https://globaltrade.com/logo.png" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="foundingDate">Founding Date:</label><input type="date" id="foundingDate" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="founders">Founders:</label><input type="text" id="founders" placeholder="John Doe, Jane Smith" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="address">Address:</label><input type="text" id="address" placeholder="123 Tech Avenue, Silicon Valley, CA" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="areaServed">Area Served:</label><input type="text" id="areaServed" placeholder="Worldwide" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="sameAs">Social Profiles (sameAs):</label><textarea id="sameAs" placeholder="https://fb.com/globaltrade&#10;https://linkedin.com/company/globaltrade" oninput="updateSchema()"></textarea></div>
        <div style="margin-top: 10px; font-weight: bold;">Contact:</div>
        <div class="sem-input-item"><label for="contactPoint_telephone">Telephone:</label><input type="text" id="contactPoint_telephone" placeholder="+1-800-123-4567" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="contactPoint_contactType">Contact Type:</label><input type="text" id="contactPoint_contactType" placeholder="customer service" oninput="updateSchema()"></div>
    </script>

    <script id="person-template" type="text/x-handlebars-template">
        <div class="sem-input-item"><label for="name">Name:</label><input type="text" id="name" placeholder="Jane Smith" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="jobTitle">Job Title:</label><input type="text" id="jobTitle" placeholder="Architect" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="url">Website URL:</label><input type="url" id="url" placeholder="https://janesmith.com" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="image">Image URL:</label><input type="url" id="image" placeholder="https://janesmith.com/me.jpg" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="sameAs">Social Profiles (sameAs):</label><textarea id="sameAs" placeholder="https://twitter.com/janesmith" oninput="updateSchema()"></textarea></div>
    </script>


    <script id="video-object-template" type="text/x-handlebars-template">
        <div class="sem-input-item"><label for="name">Name:</label><input type="text" id="name" placeholder="Cooking Demo" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="description">Description:</label><textarea id="description" placeholder="A short demo on how to cook pasta." oninput="updateSchema()"></textarea></div>
        <div class="sem-input-item"><label for="uploadDate">Upload Date:</label><input type="date" id="uploadDate" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="thumbnailUrl">Thumbnail URL:</label><input type="url" id="thumbnailUrl" placeholder="https://example.com/thumb.jpg" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="contentUrl">Content URL (e.g. .mp4):</label><input type="url" id="contentUrl" placeholder="https://example.com/video.mp4" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="embedUrl">Embed URL (e.g. YouTube embed):</label><input type="url" id="embedUrl" placeholder="https://youtube.com/embed/xyz" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="duration">Duration:</label><input type="text" id="duration" placeholder="PT1M33S" oninput="updateSchema()"></div>
    </script>

    <script id="website-template" type="text/x-handlebars-template">
        <div class="sem-input-item"><label for="name">Name:</label><input type="text" id="name" placeholder="My Awesome Website" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="url">URL:</label><input type="url" id="url" placeholder="https://mywebsite.com" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="description">Description:</label><input type="text" id="description" placeholder="A site about amazing things." oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="image">Logo/Image:</label><input type="url" id="image" placeholder="https://mywebsite.com/logo.png" oninput="updateSchema()"></div>
    </script>

    <script id="review-template" type="text/x-handlebars-template">
        <div class="sem-input-item"><label for="itemReviewed_name">Item Reviewed Name:</label><input type="text" id="itemReviewed_name" placeholder="Apple iPhone 15" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="author">Author Name:</label><input type="text" id="author" placeholder="Tech Critic" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="datePublished">Date Published:</label><input type="date" id="datePublished" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="reviewRating_ratingValue">Rating Value (1-5):</label><input type="number" step="0.1" id="reviewRating_ratingValue" placeholder="4.5" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="reviewRating_bestRating">Best Rating (e.g. 5):</label><input type="number" id="reviewRating_bestRating" placeholder="5" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="reviewBody">Review Body:</label><textarea id="reviewBody" placeholder="The iPhone 15 is a solid upgrade..." oninput="updateSchema()"></textarea></div>
    </script>

    <script id="software-application-template" type="text/x-handlebars-template">
        <div class="sem-input-item"><label for="name">Software Name:</label><input type="text" id="name" placeholder="PhotoEditor Pro" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="operatingSystem">Operating System:</label><input type="text" id="operatingSystem" placeholder="Windows, macOS, iOS" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="applicationCategory">Application Category:</label><input type="text" id="applicationCategory" placeholder="MultimediaApplication" oninput="updateSchema()"></div>
        <div style="margin-top: 10px; font-weight: bold;">Offer:</div>
        <div class="sem-input-item"><label for="offers_price">Price:</label><input type="number" step="0.01" id="offers_price" placeholder="19.99" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="offers_priceCurrency">Currency:</label><input type="text" id="offers_priceCurrency" placeholder="USD" oninput="updateSchema()"></div>
    </script>

    <script id="recipe-template" type="text/x-handlebars-template">
        <div class="sem-input-item"><label for="name">Recipe Name:</label><input type="text" id="name" placeholder="Chocolate Lava Cake" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="author">Author:</label><input type="text" id="author" placeholder="Chef Ramsay" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="prepTime">Prep Time:</label><input type="text" id="prepTime" placeholder="PT20M" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="cookTime">Cook Time:</label><input type="text" id="cookTime" placeholder="PT15M" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="recipeYield">Recipe Yield:</label><input type="text" id="recipeYield" placeholder="2 portions" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="recipeCategory">Category:</label><input type="text" id="recipeCategory" placeholder="Dessert" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="recipeInstructions">Instructions (JSON-LD string):</label><textarea id="recipeInstructions" placeholder='[{"@type": "HowToStep", "text": "Preheat oven..."}, ...]' oninput="updateSchema()"></textarea></div>
        <div class="sem-input-item"><label for="image">Image URL:</label><input type="url" id="image" placeholder="https://example.com/cake.jpg" oninput="updateSchema()"></div>
    </script>

    <script id="course-template" type="text/x-handlebars-template">
        <div class="sem-input-item"><label for="name">Course Name:</label><input type="text" id="name" placeholder="Intro into Python" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="description">Course Description:</label><textarea id="description" placeholder="A beginner course for Python." oninput="updateSchema()"></textarea></div>
        <div class="sem-input-item"><label for="provider_name">Provider Name:</label><input type="text" id="provider_name" placeholder="Code Academy" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="author">Author:</label><input type="text" id="author" placeholder="John Smith" oninput="updateSchema()"></div>
    </script>

    <script id="service-template" type="text/x-handlebars-template">
        <div class="sem-input-item"><label for="name">Service Name:</label><input type="text" id="name" placeholder="SEO Audit" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="description">Description:</label><textarea id="description" placeholder="A comprehensive analysis of your website's SEO health." oninput="updateSchema()"></textarea></div>
        <div class="sem-input-item"><label for="serviceType">Service Type:</label><input type="text" id="serviceType" placeholder="Consulting" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="areaServed">Area Served:</label><input type="text" id="areaServed" placeholder="New York, USA" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="image">Image URL:</label><input type="url" id="image" placeholder="https://example.com/service.jpg" oninput="updateSchema()"></div>
        <div style="margin-top: 10px; font-weight: bold;">Provider:</div>
        <div class="sem-input-item"><label for="provider_name">Provider Name:</label><input type="text" id="provider_name" placeholder="Acme SEO Agency" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="provider_url">Provider URL:</label><input type="url" id="provider_url" placeholder="https://acmeseo.com" oninput="updateSchema()"></div>
        <div style="margin-top: 10px; font-weight: bold;">Price/Offer:</div>
        <div class="sem-input-item"><label for="offers_price">Price:</label><input type="number" step="0.01" id="offers_price" placeholder="499.00" oninput="updateSchema()"></div>
        <div class="sem-input-item"><label for="offers_priceCurrency">Currency:</label><input type="text" id="offers_priceCurrency" placeholder="USD" oninput="updateSchema()"></div>
    </script>

    <script>

        document.addEventListener('DOMContentLoaded', function () {
            const collapsibles = document.querySelectorAll('.collapsible'); // Select all collapsibles
            collapsibles.forEach(collapsible => {
                collapsible.addEventListener('click', function () {
                    this.classList.toggle('active');
                    const content = this.nextElementSibling;

                    const icon = this.querySelector('i');

                    if (icon) {
                        if (icon.classList.contains('fa-plus-square')) {
                            icon.classList.remove('fa-plus-square');
                            icon.classList.add('fa-minus-square');
                        } else {
                            icon.classList.remove('fa-minus-square');
                            icon.classList.add('fa-plus-square');
                        }
                    }

                    content.style.display = content.style.display === 'block' ? 'none' : 'block';
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            const collapsibles = document.querySelectorAll('.collapsible-plus'); // Select all collapsibles
            collapsibles.forEach(collapsible => {
                collapsible.addEventListener('click', function () {
                    const icon = this.querySelector('i'); // Select the <i> element
                    const content = this.nextElementSibling.nextElementSibling; //Select the actual content

                    if (!content) {
                        console.warn("No content found after the .collapsible");
                        return;
                    }
                    icon.classList.toggle('fa-plus-square');
                    icon.classList.toggle('fa-minus-square');

                    content.style.display = content.style.display === 'block' ? 'none' : 'block';
                });
            });
        });

        function addFaqItem() {
            faqItemCount++;
            const faqItemsDiv = document.getElementById('faq-items');
            const newItem = document.createElement('div');
            newItem.className = "faq-item";
            newItem.innerHTML = `
        <input type="text" id="question${faqItemCount}" placeholder="Question #${faqItemCount}" oninput="updateSchema()">
        <textarea type="text" id="answer${faqItemCount}" placeholder="Answer" oninput="updateSchema()"></textarea>
        <button class="remove-item" onclick="removeFaqItem(this)">x</button>
    `;
            faqItemsDiv.appendChild(newItem);

            // Attach event listeners to new elements
            newItem.querySelectorAll('input, textarea').forEach(input => {
                input.addEventListener('input', updateSchema);
            });

            updateSchema();
        }

        function deactivateAllButtons() {
            const buttons = document.querySelectorAll('button.collapsible');
            buttons.forEach(button => {
                button.classList.remove('active');
                const content = button.nextElementSibling;
                if (content) {
                    content.style.display = 'none';
                }
                button.style.backgroundColor = ""; // Reset color

                // Reset icons
                const icon = button.querySelector('i.fa-minus-square');
                if (icon) {
                    icon.classList.remove('fa-minus-square');
                    icon.classList.add('fa-plus-square');
                }
            });

            // Remove active class from menu items
            const navbarLinks = document.querySelectorAll('#navbar a');
            navbarLinks.forEach(link => link.classList.remove('active-menu'));
        }

        function forceOpenCollapsible(btnId) {
            const btn = document.getElementById(btnId);
            if (!btn) return null;

            btn.classList.add('active');
            const content = btn.nextElementSibling;
            if (content) {
                content.style.display = 'block';
            }

            const icon = btn.querySelector('i.fa-plus-square');
            if (icon) {
                icon.classList.remove('fa-plus-square');
                icon.classList.add('fa-minus-square');
            }

            return btn;
        }

        function showSeoOnly(event) {
            if (event) event.preventDefault();
            document.getElementById('seoSection').style.display = "block";
            document.getElementById('smmSection').style.display = "none";
            document.getElementById('semSection').style.display = "none";
            document.getElementById('competitorsSection').style.display = "none";
            document.getElementById('personaSection').style.display = "none";
            document.getElementById('mediaPlanSection').style.display = "none";
            document.getElementById('contentCheckerSection').style.display = "none";
            document.getElementById('landingPageAuditSection').style.display = "none";
            document.getElementById('aiContentOptimiserSection').style.display = "none";
            document.getElementById('gscIntegrationSection').style.display = "none";
        }

        function showSmmOnly(event) {
            if (event) event.preventDefault();
            document.getElementById('seoSection').style.display = "none";
            document.getElementById('smmSection').style.display = "block";
            document.getElementById('semSection').style.display = "none";
            document.getElementById('competitorsSection').style.display = "none";
            document.getElementById('personaSection').style.display = "none";
            document.getElementById('mediaPlanSection').style.display = "none";
            document.getElementById('contentCheckerSection').style.display = "none";
            document.getElementById('landingPageAuditSection').style.display = "none";
            document.getElementById('aiContentOptimiserSection').style.display = "none";
            document.getElementById('gscIntegrationSection').style.display = "none";
        }

        function showSemOnly(event) {
            if (event) event.preventDefault();
            document.getElementById('seoSection').style.display = "none";
            document.getElementById('smmSection').style.display = "none";
            document.getElementById('semSection').style.display = "block";
            document.getElementById('competitorsSection').style.display = "none";
            document.getElementById('personaSection').style.display = "none";
            document.getElementById('mediaPlanSection').style.display = "none";
            document.getElementById('contentCheckerSection').style.display = "none";
            document.getElementById('landingPageAuditSection').style.display = "none";
            document.getElementById('aiContentOptimiserSection').style.display = "none";
            document.getElementById('gscIntegrationSection').style.display = "none";
        }

        function showOthersOnly(event) {
            if (event) event.preventDefault();
            document.getElementById('seoSection').style.display = "none";
            document.getElementById('smmSection').style.display = "none";
            document.getElementById('semSection').style.display = "none";
            document.getElementById('competitorsSection').style.display = "block";
            document.getElementById('personaSection').style.display = "block";
            document.getElementById('mediaPlanSection').style.display = "block";
            document.getElementById('contentCheckerSection').style.display = "block";
            document.getElementById('landingPageAuditSection').style.display = "block";
            document.getElementById('aiContentOptimiserSection').style.display = "block";
            document.getElementById('gscIntegrationSection').style.display = "block";
        }

        function openKeywordAnalysis(event) {
            showSeoOnly(event);
            deactivateAllButtons();
            forceOpenCollapsible('seo');
            const btn = forceOpenCollapsible('keywordAnalysisBtn');
            if (btn) btn.scrollIntoView({ behavior: 'smooth' });

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active-menu');
            }
            closeJourneyModal();
        }

        function openTechnicalSeo(event) {
            showSeoOnly(event);
            deactivateAllButtons();
            forceOpenCollapsible('seo');
            const btn = forceOpenCollapsible('technicalButton');
            if (btn) btn.scrollIntoView({ behavior: 'smooth' });

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active-menu');
            }
            closeJourneyModal();
        }

        function openCrawlerSimulator(event) {
            showSeoOnly(event);
            deactivateAllButtons();
            forceOpenCollapsible('seo');
            const btn = forceOpenCollapsible('crawlerButton');
            if (btn) btn.scrollIntoView({ behavior: 'smooth' });

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active-menu');
            }
            closeJourneyModal();
        }

        function openContentComparison(event) {
            showSeoOnly(event);
            deactivateAllButtons();
            forceOpenCollapsible('seo');
            const btn = forceOpenCollapsible('contentComparisonButton');
            if (btn) btn.scrollIntoView({ behavior: 'smooth' });

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active-menu');
            }
            closeJourneyModal();
        }

        function openSchemaGenerator(event) {
            showSeoOnly(event);
            deactivateAllButtons();
            forceOpenCollapsible('seo');
            const btn = forceOpenCollapsible('schemaGeneratorButton');
            if (btn) btn.scrollIntoView({ behavior: 'smooth' });

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active-menu');
            }
            closeJourneyModal();
        }

        function openOnPage(event) {
            showSeoOnly(event);
            deactivateAllButtons();
            forceOpenCollapsible('seo');
            const btn = forceOpenCollapsible('onPageButton');
            if (btn) btn.scrollIntoView({ behavior: 'smooth' });

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active-menu');
            }
            closeJourneyModal();
        }

        function openRankChecker(event) {
            showSeoOnly(event);
            deactivateAllButtons();
            forceOpenCollapsible('seo');
            const btn = forceOpenCollapsible('rankCheckerButton');
            if (btn) btn.scrollIntoView({ behavior: 'smooth' });

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active-menu');
            }
            closeJourneyModal();
        }

        function openContentGenerator(event) {
            event.preventDefault();
            deactivateAllButtons();

            // Open SMM accordion
            const smmButton = document.querySelector('button#smm');
            if (smmButton) {
                smmButton.classList.add('active');
                const content = smmButton.nextElementSibling;
                if (content) {
                    content.style.display = "block";
                }
                const icon = smmButton.querySelector('i.fa-plus-square');
                if (icon) {
                    icon.classList.remove('fa-plus-square');
                    icon.classList.add('fa-minus-square');
                }
            }

            // Show section
            const btn = document.getElementById('contentGeneratorButton');
            if (btn) {
                btn.classList.add('active');
                const content = btn.nextElementSibling;
                if (content) {
                    content.style.display = "block";
                }
                const icon = btn.querySelector('i.fa-plus-square');
                if (icon) {
                    icon.classList.remove('fa-plus-square');
                    icon.classList.add('fa-minus-square');
                }
                btn.scrollIntoView({ behavior: 'smooth' });
            }
            closeJourneyModal();
        }

        function openResponseGenerator(event) {
            event.preventDefault();
            deactivateAllButtons();

            // Open SMM accordion
            const smmButton = document.querySelector('button#smm');
            if (smmButton) {
                smmButton.classList.add('active');
                const content = smmButton.nextElementSibling;
                if (content) {
                    content.style.display = "block";
                }
                const icon = smmButton.querySelector('i.fa-plus-square');
                if (icon) {
                    icon.classList.remove('fa-plus-square');
                    icon.classList.add('fa-minus-square');
                }
            }

            // Show section
            const btn = document.getElementById('smmReplyButton');
            if (btn) {
                btn.classList.add('active');
                const content = btn.nextElementSibling;
                if (content) {
                    content.style.display = "block";
                }
                const icon = btn.querySelector('i.fa-plus-square');
                if (icon) {
                    icon.classList.remove('fa-plus-square');
                    icon.classList.add('fa-minus-square');
                }
                btn.scrollIntoView({ behavior: 'smooth' });
            }
            closeJourneyModal();
        }

        function openPillarFramework(event) {
            event.preventDefault();
            deactivateAllButtons();

            // Open SMM accordion
            const smmButton = document.querySelector('button#smm');
            if (smmButton) {
                smmButton.classList.add('active');
                const content = smmButton.nextElementSibling;
                if (content) {
                    content.style.display = "block";
                }
                const icon = smmButton.querySelector('i.fa-plus-square');
                if (icon) {
                    icon.classList.remove('fa-plus-square');
                    icon.classList.add('fa-minus-square');
                }
            }

            // Show section
            const btn = document.getElementById('pillarFrameworkButton');
            if (btn) {
                btn.classList.add('active');
                const content = btn.nextElementSibling;
                if (content) {
                    content.style.display = "block";
                }
                const icon = btn.querySelector('i.fa-plus-square');
                if (icon) {
                    icon.classList.remove('fa-plus-square');
                    icon.classList.add('fa-minus-square');
                }
                btn.scrollIntoView({ behavior: 'smooth' });
            }
            closeJourneyModal();
        }

        function openSocialMediaStrategy(event) {
            event.preventDefault();
            deactivateAllButtons();

            // Open SMM accordion
            const smmButton = document.querySelector('button#smm');
            if (smmButton) {
                smmButton.classList.add('active');
                const content = smmButton.nextElementSibling;
                if (content) {
                    content.style.display = "block";
                }
                const icon = smmButton.querySelector('i.fa-plus-square');
                if (icon) {
                    icon.classList.remove('fa-plus-square');
                    icon.classList.add('fa-minus-square');
                }
            }

            // Show current section and inner house button
            const section = document.getElementById('socialMediaStrategy');
            if (section) {
                section.style.display = "block";

                // Also open the inner "Social Media Strategy House" accordion
                const smsButton = document.getElementById('smsButton');
                if (smsButton) {
                    smsButton.classList.add('active');
                    const content = smsButton.nextElementSibling;
                    if (content) {
                        content.style.display = "block";
                    }
                    const icon = smsButton.querySelector('i.fa-plus-square');
                    if (icon) {
                        icon.classList.remove('fa-plus-square');
                        icon.classList.add('fa-minus-square');
                    }
                }

                section.scrollIntoView({ behavior: 'smooth' });
            }

            closeJourneyModal();
        }
        // Helper to update collapsible colors based on status
        function updateCollapsibleState(buttonId, state) {
            const btn = document.getElementById(buttonId);
            if (!btn) return;

            btn.classList.remove('running', 'success', 'error');
            if (state === 'running' || state === 'success' || state === 'error') {
                btn.classList.add(state);
            }
        }

        function openSem(event) {
            event.preventDefault();
            deactivateAllButtons();

            showSemOnly(event);

            const semButton = document.querySelector('button#semButton');
            if (semButton) {
                semButton.classList.toggle('active');
                const content = semButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const semLink = event.currentTarget;
                semLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const semSection = document.getElementById('semButton');
                    if (semSection) {
                        semSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        function openCompetitors(event) {
            event.preventDefault();
            deactivateAllButtons();

            showOthersOnly(event);

            const competitorsButton = document.querySelector('button#competitionBtn');
            if (competitorsButton) {
                competitorsButton.classList.toggle('active');
                const content = competitorsButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const competitorsLink = event.currentTarget;
                competitorsLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const competitorsSection = document.getElementById('competitionBtn');
                    if (competitorsSection) {
                        competitorsSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        function openPersona(event) {
            event.preventDefault();
            deactivateAllButtons();
            showOthersOnly(event);

            const personaButton = document.querySelector('button#persona');
            if (personaButton) {
                personaButton.classList.toggle('active');
                const content = personaButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const personaLink = event.currentTarget;
                personaLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const personaSection = document.getElementById('persona');
                    if (personaSection) {
                        personaSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        function openMediaPlan(event) {
            event.preventDefault();
            deactivateAllButtons();
            showOthersOnly(event);

            const mediaPlanButton = document.querySelector('button#mediaPlanBtn');
            if (mediaPlanButton) {
                mediaPlanButton.classList.toggle('active');
                const content = mediaPlanButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const mediaPlanLink = event.currentTarget;
                mediaPlanLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const mediaPlanSection = document.getElementById('mediaPlanBtn');
                    if (mediaPlanSection) {
                        mediaPlanSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        function openContentCheck(event) {
            event.preventDefault();
            deactivateAllButtons();
            showOthersOnly(event);

            const contentCheckButton = document.querySelector('button#contentcheck');
            if (contentCheckButton) {
                contentCheckButton.classList.toggle('active');
                const content = contentCheckButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const contentCheckLink = event.currentTarget;
                contentCheckLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const contentCheckSection = document.getElementById('contentcheck');
                    if (contentCheckSection) {
                        // Get the element *before* contentCheckSection
                        let previousElement = contentCheckSection.previousElementSibling;

                        // Scroll to the previous element if it exists
                        if (previousElement) {
                            previousElement.scrollIntoView({ behavior: 'smooth', block: 'start' }); // block: 'start' is important for precise positioning
                        } else {
                            // If there's no previous element (e.g., contentCheckSection is the first child),
                            // scroll to the top of the contentCheckSection instead (or handle as desired)
                            contentCheckSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                }
            }
            closeJourneyModal();
        }

        function openAiContentOptimiser(event) {
            event.preventDefault();
            deactivateAllButtons();
            showOthersOnly(event);

            const aiOptimiserButton = document.querySelector('button#aiContentOptimiserBtn');
            if (aiOptimiserButton) {
                aiOptimiserButton.classList.toggle('active');
                const content = aiOptimiserButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const aiOptimiserLink = event.currentTarget;
                aiOptimiserLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const aiOptimiserSection = document.getElementById('aiContentOptimiser');
                    if (aiOptimiserSection) {
                        aiOptimiserSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        function openGscIntegration(event) {
            event.preventDefault();
            deactivateAllButtons();
            showOthersOnly(event);

            const gscButton = document.getElementById('gscIntegrationBtn');
            if (gscButton) {
                gscButton.classList.toggle('active');
                const content = gscButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const gscLink = event.currentTarget;
                if (gscLink) gscLink.classList.toggle('active-menu');

                if (content && content.style.display === "block") {
                    gscButton.scrollIntoView({ behavior: 'smooth' });
                }
            }
            closeJourneyModal();
        }

        // GEO Utilities Logic
        function openGeoUtilities(event) {
            if (event) event.preventDefault();

            // Ensure parent container is visible
            const seoSection = document.getElementById('seoSection');
            if (seoSection) seoSection.style.display = "block";

            // Ensure section itself is visible (it's within the 'Others' block currently)
            showOthersOnly(event);
            if (seoSection) seoSection.style.display = "block"; // Re-force if showOthersOnly hides it

            const geoBtn = document.getElementById('geoUtilitiesBtn');
            const geoContent = document.getElementById('geoUtilitiesSection');

            if (geoBtn && geoContent) {
                // If not already active, trigger a click to expand and update UI state correctly
                if (!geoBtn.classList.contains('active')) {
                    geoBtn.click();
                }
                geoBtn.scrollIntoView({ behavior: 'smooth' });
            }
            closeJourneyModal();
        }

        function generateLlmsTxt() {
            const title = document.getElementById('llmSiteTitle').value || 'My Website';
            const desc = document.getElementById('llmDescription').value || '';
            const highlightsHeading = document.getElementById('llmHighlightsHeading').value || '';
            const highlights = document.getElementById('llmHighlights').value || '';
            const geoPrompts = document.getElementById('llmGeoPrompts').value || '';
            const coreSections = document.getElementById('llmCoreSections').value || '';
            const optionalSection = document.getElementById('llmOptional').value || '';

            let content = `# ${title}\n\n`;
            if (desc) content += `> ${desc}\n\n`;

            if (highlightsHeading) content += `${highlightsHeading}\n\n`;
            if (highlights) content += `${highlights}\n\n`;

            if (geoPrompts) {
                content += `GEO Target Prompts This Content Addresses:\n`;
                const promptList = geoPrompts.split('\n').filter(p => p.trim());
                promptList.forEach((p, i) => {
                    content += `${i + 1}. ${p.trim()}\n`;
                });
                content += `\n`;
            }

            if (coreSections) {
                content += `${coreSections}\n\n`;
            }

            if (optionalSection) {
                content += `${optionalSection}\n\n`;
            }

            showGeoPreview('llms.txt', content);
        }

        function generateCatsTxt() {
            const name = document.getElementById('catsEntityName').value || 'Entity Name';
            const traits = document.getElementById('catsTraits').value || '';
            const values = document.getElementById('catsValues').value || '';

            let content = `# CATS.TXT for ${name}\n\n## Personality & Voice\n${traits}\n\n## Key Facts & Verification\n${values}`;

            showGeoPreview('cats.txt', content);
        }

        function showGeoPreview(filename, content) {
            const preview = document.getElementById('geoFilePreview');
            preview.style.display = 'block';
            document.getElementById('previewTitle').textContent = 'Preview: ' + filename;
            document.getElementById('geoPreviewText').value = content;

            // Scroll to preview
            preview.scrollIntoView({ behavior: 'smooth', block: 'end' });

            const dlBtn = document.getElementById('downloadGeoBtn');
            // Clone to remove old listeners
            const newBtn = dlBtn.cloneNode(true);
            dlBtn.parentNode.replaceChild(newBtn, dlBtn);

            newBtn.onclick = function () {
                const blob = new Blob([content], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                a.click();
            };
        }

        function execCmd(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('editorContent').focus();
        }

        function insertLink() {
            const url = prompt("Enter the URL:");
            if (url) execCmd('createLink', url);
        }

        function insertImage() {
            const url = prompt("Enter the Image URL:");
            if (url) {
                const imgId = "img_" + Date.now();
                const imgHtml = `
                    <div class="img-optimiser-wrapper" id="wrap_${imgId}" style="position: relative; display: inline-block; margin: 15px 0; max-width: 100%;">
                        <img id="${imgId}" src="${url}" style="max-width: 100%; border-radius: 6px; display: block;" 
                             onmouseover="showImageTool(this)" onmouseout="hideImageTool(this)">
                        <div class="img-tool-overlay" id="overlay_${imgId}" style="display: none; position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; z-index: 10; width: 250px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div style="color: white; font-size: 12px; font-weight: bold;">Alt Text:</div>
                                <button onclick="generateAiAlt('${imgId}')" style="background: #004c9d; color: white; border: none; padding: 3px 6px; border-radius: 4px; cursor: pointer; font-size: 10px;" title="AI Generate"> AI</button>
                            </div>
                            <textarea id="alt_${imgId}" placeholder="Enter alt text..." 
                                      style="width: 100%; box-sizing: border-box; padding: 5px; font-size: 11px; border-radius: 4px; border: none; resize: none; min-height: 45px; max-height: 200px; font-family: inherit; line-height: 1.4; overflow-y: hidden;" 
                                      oninput="updateImgAlt('${imgId}', this.value); autoResizeAlt(this)"></textarea>
                            <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 8px; width: 100%; background: #f44336; color: white; border: none; padding: 5px; border-radius: 4px; cursor: pointer; font-size: 11px;">Remove Image</button>
                        </div>
                        <div class="img-resize-handle" onmousedown="startImgResize(event, '${imgId}')"></div>
                    </div>
                `;
                execCmd('insertHTML', imgHtml);
            }
        }

        function insertTable() {
            const rows = prompt("Number of rows:", 3);
            const cols = prompt("Number of columns:", 3);
            if (rows && cols) {
                let table = '<table border="1" style="width:100%; border-collapse: collapse;">';
                for (let i = 0; i < rows; i++) {
                    table += '<tr>';
                    for (let j = 0; j < cols; j++) {
                        table += '<td style="padding: 10px; border: 1px solid #ddd;">&nbsp;</td>';
                    }
                    table += '</tr>';
                }
                table += '</table><p>&nbsp;</p>';
                execCmd('insertHTML', table);
            }
        }

        // AI Content Optimiser Logic
        function switchOptimiserTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            const btn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.innerText.toLowerCase().includes(tabId));
            if (btn) btn.classList.add('active');

            const content = document.getElementById(`tab-${tabId}`);
            if (content) content.classList.add('active');
        }

        function updateEditorMetrics() {
            const editor = document.getElementById('editorContent');
            const text = editor.innerText || "";
            const charCount = text.length;
            const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
            const tokenCount = Math.ceil(wordCount * 1.3);

            if (document.getElementById('editorHeaderWordCount')) document.getElementById('editorHeaderWordCount').innerText = wordCount;
            document.getElementById('wordCount').innerText = wordCount;
            document.getElementById('tokenCount').innerText = tokenCount;
            if (document.getElementById('totalWordsStat')) document.getElementById('totalWordsStat').innerText = wordCount;
        }

        // Configuration for AI Content Optimiser Lambda Endpoints
        const OPTIMISER_ENDPOINTS = {
            SEO_ANALYSIS: 'https://diyjtwnt4l.execute-api.ap-southeast-1.amazonaws.com/seoContentAnalysisScore',
            CONTENT_AI: 'https://0oes56fj4l.execute-api.ap-southeast-1.amazonaws.com/aiOptimiser',
            KEYWORD_FREQ: 'https://qtd6t9voui.execute-api.ap-southeast-1.amazonaws.com/keywordFrequency',
            PLAGIARISM: 'https://tg6m9b7gsj.execute-api.ap-southeast-1.amazonaws.com/plagarismCheck',
            IMAGE_ALT: 'https://ty3ndlwcnk.execute-api.ap-southeast-1.amazonaws.com/altTextGenerator',
            GSC_INTEGRATION: 'https://v5gyq2sqdd.execute-api.ap-southeast-1.amazonaws.com/gscIntegration',
            COMPLIANCE_RECOMMENDER: 'https://0jincjjy14.execute-api.ap-southeast-1.amazonaws.com/complianceRecommender',
            DESIGN_ANALYSIS: 'https://bzedwsy4mb.execute-api.ap-southeast-1.amazonaws.com/pageDesignAnalysis',
            AI_TOPIC_PICKER: 'https://mv0yv43k5d.execute-api.ap-southeast-1.amazonaws.com/aiTopicPicker'
        };

        const GSC_CLIENT_ID = '365369983219-12iqvk3v35kf03p3ts1gikglddtkofvq.apps.googleusercontent.com';
        let gscAccessToken = null;
        let tokenClient = null;
        let selectedGscProperty = null;
        let gscPerformanceData = [];
        let gscSortColumn = 'clicks';
        let gscSortOrder = 'desc';
        let gscCurrentPage = 1;
        const rowsPerPage = 10;

        /**
         * Robustly parse response from Lambda.
         * Handles cases where the response is a direct object or wrapped in a 'body' string (Proxy Integration).
         */
        function parseLambdaResponse(data) {
            if (data && data.body !== undefined) {
                if (typeof data.body === 'string') {
                    try {
                        return JSON.parse(data.body);
                    } catch (e) {
                        console.error("Failed to parse Lambda body string:", e);
                        return data.body;
                    }
                }
                return data.body;
            }
            return data;
        }

        /**
         * Simple Markdown-to-HTML formatter
         */
        /**
         * Generic fetch wrapper with retry logic
         */
        async function fetchWithRetry(url, options = {}, maxRetries = 1, validator = null) {
            let lastError = null;
            for (let i = 0; i <= maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const data = await response.json();

                    // If a validator is provided, use it to determine if the data is "valid"
                    // (e.g., checking if certain fields are present and not empty)
                    if (validator && !validator(data)) {
                        throw new Error("Invalid or empty response data");
                    }

                    return data;
                } catch (e) {
                    lastError = e;
                    console.warn(`Fetch attempt ${i + 1} failed for ${url}: ${e.message}`);
                    if (i < maxRetries) {
                        // Wait briefly before retrying (exponential backoff could be added here, but simple delay for now)
                        await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                    }
                }
            }
            throw lastError;
        }

        function formatMarkdown(text) {
            if (!text) return "";

            let html = text.trim();

            // 1. Remove markdown code block wrappers if they exist
            html = html.replace(/```markdown\n?/gi, '').replace(/```\n?/gi, '').trim();

            // 2. Handle Tables
            if (html.includes('|')) {
                const lines = html.split('\n');
                let tableHtml = '';
                let inTable = false;

                const processedLines = lines.map(line => {
                    const trimmed = line.trim();
                    if (trimmed.startsWith('|')) {
                        if (!inTable) {
                            inTable = true;
                            tableHtml = '<table class="generated-table"><tbody>';
                        }

                        // Skip separator lines like |---|---|
                        if (trimmed.includes('---')) return "";

                        const cells = trimmed.split('|').filter((c, i, arr) => {
                            // Keep cells between pipes, skip leading/trailing empty ones
                            return i > 0 && i < arr.length - 1;
                        }).map(c => c.trim());

                        if (cells.length > 0) {
                            tableHtml += '<tr>' + cells.map(c => `<td>${c}</td>`).join('') + '</tr>';
                        }
                        return ""; // Consume the line
                    } else {
                        if (inTable) {
                            inTable = false;
                            const completeTable = tableHtml + '</tbody></table>';
                            return completeTable + '\n' + line;
                        }
                        return line;
                    }
                });

                if (inTable) {
                    processedLines.push('</tbody></table>');
                }
                html = processedLines.filter(l => l !== "").join('\n');
            }

            // 3. Headers
            html = html
                .replace(/^\s*######\s*(.*$)/gim, '<h6>$1</h6>')
                .replace(/^\s*#####\s*(.*$)/gim, '<h5>$1</h5>')
                .replace(/^\s*####\s*(.*$)/gim, '<h5>$1</h5>')
                .replace(/^\s*###\s*(.*$)/gim, '<h4>$1</h4>')
                .replace(/^\s*##\s*(.*$)/gim, '<h3>$1</h3>')
                .replace(/^\s*#\s*(.*$)/gim, '<h2>$1</h2>');

            // 4. Lists (Bullet & Ordered)
            // Unordered
            html = html.replace(/^\s*[\-\*]\s+(.*$)/gim, '<li>$1</li>');
            html = html.replace(/(?:<li>[\s\S]*?<\/li>\n*)+/g, (match) => `<ul>${match}</ul>`);

            // Ordered
            html = html.replace(/^\s*\d+\.\s+(.*$)/gim, '<li class="ordered">$1</li>');
            html = html.replace(/(?:<li class="ordered">[\s\S]*?<\/li>\n*)+/g, (match) => `<ol>${match.replace(/ class="ordered"/g, '')}</ol>`);

            // 5. Bold
            html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

            // 6. Newlines to <br> for remaining text
            // Skip areas already inside block elements
            const blocks = ['h2', 'h3', 'h4', 'h5', 'h6', 'table', 'ul', 'ol', 'li', 'tr', 'td'];
            const lines = html.split('\n');
            html = lines.map(line => {
                const trimmed = line.trim();
                const isBlock = blocks.some(b => trimmed.startsWith('<' + b) || trimmed.endsWith('</' + b + '>'));
                return isBlock ? line : line + '<br>';
            }).join('\n');

            return html.replace(/<br>\n*(?=<h|<table|<ul|<ol)/g, ''); // Clean up redundant breaks before blocks
        }

        function updateMetricGauge(id, percent) {
            const gauge = document.getElementById(id);
            const valueDisplay = document.getElementById('seoScoreValue');
            const offset = 440 - (percent / 100) * 440;
            gauge.style.strokeDashoffset = offset;
            valueDisplay.innerText = percent;

            if (percent > 80) gauge.style.stroke = "#4caf50";
            else if (percent > 50) gauge.style.stroke = "#ff9800";
            else gauge.style.stroke = "#f44336";
        }

        async function runSeoAnalysis() {
            const btn = document.getElementById('btnRunSeoAnalysis');
            if (!btn) return;
            const originalContent = btn.innerHTML;
            const content = document.getElementById('editorContent').innerHTML;
            const title = document.getElementById('editorTitle').value;

            if (OPTIMISER_ENDPOINTS.SEO_ANALYSIS === 'YOUR_SEO_ANALYSIS_LAMBDA_URL') {
                alert("Please configure the SEO Analysis Lambda URL in the code.");
                return;
            }

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            btn.disabled = true;

            const primaryKeyword = document.getElementById('primaryKeyword')?.value || "";
            const secondaryKeywords = document.getElementById('secondaryKeywords')?.value || "";

            try {
                const response = await fetch(OPTIMISER_ENDPOINTS.SEO_ANALYSIS, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content,
                        title,
                        primary_keyword: primaryKeyword,
                        secondary_keywords: secondaryKeywords,
                        use_ai: true
                    })
                });
                const data = await response.json();
                const result = parseLambdaResponse(data);

                console.log("SEO Analysis Parsed Result:", result);

                const score = result.overall_score || result.overallScore || 0;
                console.log("Populating score to gauge:", score);

                // Update Gauges and Bars with real data
                updateMetricGauge('seoScoreGauge', score);

                // Redundant update for safety
                const scoreVal = document.getElementById('seoScoreValue');
                if (scoreVal) scoreVal.innerText = Math.round(score);

                if (result.title_analysis) {
                    document.getElementById('titleScore').innerText = Math.round(result.title_analysis.score || 0) + '%';
                    document.getElementById('titleBar').style.width = (result.title_analysis.score || 0) + '%';
                }
                if (result.heading_analysis) {
                    document.getElementById('headingsScore').innerText = Math.round(result.heading_analysis.score || 0) + '%';
                    document.getElementById('headingsBar').style.width = (result.heading_analysis.score || 0) + '%';
                }
                if (result.readability_analysis) {
                    document.getElementById('readabilityScore').innerText = Math.round(result.readability_analysis.score || 0) + '%';
                    document.getElementById('readabilityBar').style.width = (result.readability_analysis.score || 0) + '%';
                }
                if (result.intent_eeat_analysis) {
                    document.getElementById('intentEeatScore').innerText = Math.round(result.intent_eeat_analysis.score || 0) + '%';
                    document.getElementById('intentEeatBar').style.width = (result.intent_eeat_analysis.score || 0) + '%';
                }

                const wordCountElem = document.getElementById('wordCount');
                if (wordCountElem) wordCountElem.innerText = result.word_count || 0;

                // Populate Action Plan
                const planContainer = document.getElementById('seoActionPlanContainer');
                const actionList = document.getElementById('seoActionList');
                if (planContainer && actionList && result.action_plan && result.action_plan.length > 0) {
                    actionList.innerHTML = '';
                    result.action_plan.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'action-item';
                        div.innerHTML = `<i class="fas fa-arrow-right"></i> <span>${item}</span>`;
                        actionList.appendChild(div);
                    });
                    planContainer.style.display = 'block';
                } else if (planContainer) {
                    planContainer.style.display = 'none';
                }
            } catch (error) {
                console.error("SEO Analysis Error:", error);
                alert("Failed to run SEO analysis. Check console for details.");
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        async function analyzeKeywordFrequency() {
            const content = document.getElementById('editorContent').innerHTML;
            const listContainer = document.getElementById('keywordFrequencyList');
            const btn = document.querySelector('.btn-keywords');
            const originalContent = btn.innerHTML;

            if (OPTIMISER_ENDPOINTS.KEYWORD_FREQ === 'YOUR_KEYWORD_FREQ_LAMBDA_URL') {
                // Fallback to basic local analysis if no URL provided
                runLocalKeywordAnalysis();
                return;
            }

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            btn.disabled = true;

            try {
                const response = await fetch(OPTIMISER_ENDPOINTS.KEYWORD_FREQ, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                const data = await response.json();
                const result = parseLambdaResponse(data);

                console.log("Keyword Freq Parsed Result:", result);

                listContainer.innerHTML = "";
                if (result.keywords && result.keywords.length > 0) {
                    result.keywords.forEach(kw => {
                        const item = document.createElement('div');
                        item.className = 'keyword-freq-item';
                        item.innerHTML = `
                            <div class="keyword-freq-header">
                                <span>${kw.keyword}</span>
                                <span>${kw.count}x (${kw.density}%)</span>
                            </div>
                            <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: ${Math.min(kw.density * 10, 100)}%; background: #3b5bdb;"></div></div>
                        `;
                        listContainer.appendChild(item);
                    });
                    document.getElementById('kwsFound').innerText = result.keywords.length;
                    document.getElementById('totalWordsStat').innerText = result.total_words || 0;
                } else {
                    listContainer.innerHTML = '<p style="text-align: center; color: #999; margin-top:20px;">No keywords found.</p>';
                    document.getElementById('totalWordsStat').innerText = result.total_words || 0;
                }
            } catch (error) {
                console.error("Keyword Freq Error:", error);
                runLocalKeywordAnalysis(); // Final fallback
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        function runLocalKeywordAnalysis() {
            const content = document.getElementById('editorContent').innerText.toLowerCase();
            const primaryKw = document.getElementById('primaryKeyword').value.trim();
            const secondaryKwsText = document.getElementById('secondaryKeywords').value;
            const secondaryKws = secondaryKwsText.split('\n').map(k => k.trim()).filter(k => k !== "");

            const keywords = [];
            if (primaryKw) keywords.push(primaryKw);
            keywords.push(...secondaryKws);

            const listContainer = document.getElementById('keywordFrequencyList');
            const totalWords = content.trim() ? content.trim().split(/\s+/).length : 0;

            if (keywords.length === 0) {
                alert("Please enter at least a primary focus keyword.");
                return;
            }

            listContainer.innerHTML = "";
            let foundCount = 0;

            keywords.forEach(kw => {
                if (!kw) return;
                const regex = new RegExp(`\\b${kw.toLowerCase().replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'g');
                const matches = content.match(regex) || [];
                const count = matches.length;
                const density = totalWords > 0 ? ((count / totalWords) * 100).toFixed(2) : "0.00";

                if (count > 0) foundCount++;

                const item = document.createElement('div');
                item.className = 'keyword-freq-item';
                item.innerHTML = `
                    <div class="keyword-freq-header">
                        <span>${kw}</span>
                        <span>${count}x (${density}%)</span>
                    </div>
                    <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: ${Math.min(density * 10, 100)}%; background: #3b5bdb;"></div></div>
                `;
                listContainer.appendChild(item);
            });

            document.getElementById('kwsFound').innerText = foundCount;
            document.getElementById('totalWordsStat').innerText = totalWords;
        }

        function handleLocalImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const imgId = "img_" + Date.now();
                    const imgHtml = `
                        <div class="img-optimiser-wrapper" id="wrap_${imgId}" style="position: relative; display: inline-block; margin: 15px 0; max-width: 100%;">
                            <img id="${imgId}" src="${e.target.result}" style="max-width: 100%; border-radius: 6px; display: block;"
                                 onmouseover="showImageTool(this)" onmouseout="hideImageTool(this)">
                            <div class="img-tool-overlay" id="overlay_${imgId}" style="display: none; position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; z-index: 10; width: 250px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                    <div style="color: white; font-size: 12px; font-weight: bold;">Alt Text:</div>
                                    <button onclick="generateAiAlt('${imgId}')" style="background: #004c9d; color: white; border: none; padding: 3px 6px; border-radius: 4px; cursor: pointer; font-size: 10px;" title="AI Generate"> AI</button>
                                </div>
                                <textarea id="alt_${imgId}" placeholder="Enter alt text..."
                                          style="width: 100%; box-sizing: border-box; padding: 5px; font-size: 11px; border-radius: 4px; border: none; resize: none; min-height: 45px; max-height: 200px; font-family: inherit; line-height: 1.4; overflow-y: hidden;"
                                          oninput="updateImgAlt('${imgId}', this.value); autoResizeAlt(this)"></textarea>
                                <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 8px; width: 100%; background: #f44336; color: white; border: none; padding: 5px; border-radius: 4px; cursor: pointer; font-size: 11px;">Remove Image</button>
                            </div>
                            <div class="img-resize-handle" onmousedown="startImgResize(event, '${imgId}')"></div>
                        </div>
                    `;
                    execCmd('insertHTML', imgHtml);
                    input.value = ''; // Reset the input value so the same file can be uploaded again
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function showImageTool(img) {
            const overlay = document.getElementById("overlay_" + img.id);
            if (overlay) overlay.style.display = "block";
        }

        function hideImageTool(img) {
            // We use a small timeout to allow moving mouse into the overlay
            img._hideTimeout = setTimeout(() => {
                const overlay = document.getElementById("overlay_" + img.id);
                if (overlay && !overlay.matches(':hover')) overlay.style.display = "none";
            }, 300);
        }

        // Image resizing logic
        let resizingImg = null;
        let startX, startY, startWidth, startHeight;

        function startImgResize(e, imgId) {
            e.preventDefault();
            resizingImg = document.getElementById(imgId);
            startX = e.clientX;
            startY = e.clientY;
            startWidth = resizingImg.offsetWidth;
            startHeight = resizingImg.offsetHeight;

            window.addEventListener('mousemove', handleImgResize);
            window.addEventListener('mouseup', stopImgResize);
        }

        function handleImgResize(e) {
            if (!resizingImg) return;
            const diffX = e.clientX - startX;
            const newWidth = startWidth + diffX;

            // Maintain aspect ratio by only setting width (max-width is already 100%)
            if (newWidth > 50) {
                resizingImg.style.width = newWidth + 'px';
            }
        }

        function stopImgResize() {
            window.removeEventListener('mousemove', handleImgResize);
            window.removeEventListener('mouseup', stopImgResize);
            resizingImg = null;
        }

        // Ensure overlay stays visible when hovered
        document.addEventListener('mouseover', (e) => {
            if (e.target.closest('.img-tool-overlay')) {
                const overlay = e.target.closest('.img-tool-overlay');
                const imgId = overlay.id.replace('overlay_', '');
                const img = document.getElementById(imgId);
                if (img) clearTimeout(img._hideTimeout);
            }
        });

        function updateImgAlt(imgId, val) {
            const img = document.getElementById(imgId);
            if (img) img.alt = val;
        }

        function autoResizeAlt(el) {
            el.style.height = 'auto';
            const newHeight = el.scrollHeight;
            el.style.height = newHeight + 'px';

            // Show scrollbar only if it hits max-height (200px)
            if (newHeight >= 200) {
                el.style.overflowY = 'auto';
            } else {
                el.style.overflowY = 'hidden';
            }
        }

        async function generateAiAlt(imgId) {
            const altInput = document.getElementById('alt_' + imgId);
            const img = document.getElementById(imgId);
            if (!img) return;

            const editor = document.getElementById('editorContent');
            const pageContext = document.getElementById('editorTitle')?.value || editor.innerText.substring(0, 500);
            const primaryKeyword = document.getElementById('primaryKeyword')?.value || "";
            const secondaryKeywords = document.getElementById('secondaryKeywords')?.value || "";
            const focusKeywords = (primaryKeyword + "\n" + secondaryKeywords).trim();

            // Try to find placement relative to headers
            let placement = "Within content";
            let prev = img.previousElementSibling;
            while (prev) {
                if (prev.tagName && prev.tagName.startsWith('H')) {
                    placement = `Under heading "${prev.innerText}"`;
                    break;
                }
                prev = prev.previousElementSibling;
            }

            if (OPTIMISER_ENDPOINTS.IMAGE_ALT === 'YOUR_IMAGE_ALT_LAMBDA_URL') {
                altInput.value = "Vision AI endpoint not configured.";
                return;
            }

            altInput.value = "AI analyzing image...";

            try {
                // Prepare request body
                const body = {
                    page_context: pageContext,
                    image_placement: placement,
                    primary_keyword: primaryKeyword,
                    secondary_keywords: secondaryKeywords
                };

                // Handle image source (URL or base64)
                if (img.src.startsWith('data:')) {
                    body.image_data = img.src.split(',')[1];
                } else {
                    body.image_url = img.src;
                }

                const response = await fetch(OPTIMISER_ENDPOINTS.IMAGE_ALT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                const result = parseLambdaResponse(data);

                if (result.error) {
                    altInput.value = "Error: " + result.error;
                } else {
                    altInput.value = result.result || "SEO Image Description";
                    updateImgAlt(imgId, altInput.value);
                    autoResizeAlt(altInput);
                }
            } catch (error) {
                console.error("Alt Gen Error:", error);
                altInput.value = "Failed to reach AI.";
            }
        }

        async function aiGenerateContent() {
            const prompt = document.getElementById('aiPrompt').value;
            if (!prompt) return alert("Please enter a prompt.");
            const editor = document.getElementById('editorContent');
            const btn = document.getElementById('btnAiGenerate');
            const originalBtnContent = btn.innerHTML;

            // Button loading state
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Writing...';
            btn.disabled = true;

            const loadingId = "loading_" + Date.now();
            editor.innerHTML += `<p id="${loadingId}"><i>Generating content for: ${prompt}...</i></p>`;

            const primaryKeyword = document.getElementById('primaryKeyword')?.value || "";
            const secondaryKeywords = document.getElementById('secondaryKeywords')?.value || "";
            const personaContext = getPersonaData();
            const selectedTopics = getSelectedTopicsData(currentOptimiserFlow);

            const enhancedPrompt = `
PROMPT: ${prompt}

${personaContext ? "STRICTLY ADHERE TO THESE TARGET PERSONAS:\n" + personaContext : ""}
${selectedTopics ? "PRIORITIZE ADDRESSING THESE COMPETITOR TOPICS:\n" + selectedTopics : ""}
`.trim();

            try {
                const response = await fetch(OPTIMISER_ENDPOINTS.CONTENT_AI, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generate',
                        prompt: enhancedPrompt,
                        primary_keyword: primaryKeyword,
                        secondary_keywords: secondaryKeywords,
                        compliance_guidelines: getSelectedCompliance(currentOptimiserFlow),
                        settings: aiContentSettings
                    })
                });
                const data = await response.json();
                const result = parseLambdaResponse(data);

                document.getElementById(loadingId).remove();

                const blockId = "gen_" + Date.now();
                const formattedContent = formatMarkdown(result.result);
                const generatedHtml = `
                    <div id="${blockId}" class="generated-content-block" contenteditable="false">
                        <div class="generated-badge">generated content</div>
                        <div class="generated-text-body" style="color: #333;" contenteditable="true">
                            ${formattedContent}
                        </div>
                        <div class="generated-actions">
                            <button class="btn-accept-content" onclick="acceptGeneratedContent(this); event.stopPropagation();">
                                <i class="fas fa-check"></i> Accept
                            </button>
                            <button class="btn-remove-content" onclick="removeGeneratedContent(this); event.stopPropagation();">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                    <p>&nbsp;</p>
                `;

                editor.innerHTML += generatedHtml;
                updateEditorMetrics();
            } catch (error) {
                document.getElementById(loadingId).innerHTML = "<i>Error generating content.</i>";
            } finally {
                btn.innerHTML = originalBtnContent;
                btn.disabled = false;
            }
        }

        function acceptGeneratedContent(btn) {
            const block = btn.closest('.generated-content-block');
            if (!block) return;

            // Get just the text content body
            const body = block.querySelector('.generated-text-body');
            const content = body ? body.innerHTML : "";

            // Replace the block with just its content
            const wrapper = document.createElement('div');
            wrapper.innerHTML = content;

            block.parentNode.replaceChild(wrapper, block);
            updateEditorMetrics();
        }


        // GSC Integration Functions
        function initGscAuth() {
            if (typeof google === 'undefined') return;
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GSC_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/webmasters.readonly https://www.googleapis.com/auth/indexing',
                callback: (response) => {
                    if (response.access_token) {
                        gscAccessToken = response.access_token;
                        document.getElementById('gscAuthStatus').innerHTML = '<i class="fas fa-check-circle" style="color: #34a853;"></i> Connected to Google Search Console';
                        document.getElementById('gscAuthStatus').style.color = '#34a853';
                        document.getElementById('btnConnectGsc').innerHTML = '<i class="fas fa-sync"></i> Reconnect';
                        document.getElementById('gscToolsArea').style.opacity = '1';
                        document.getElementById('gscToolsArea').style.pointer_events = 'auto';
                        document.getElementById('gscAuthSection').style.background = '#e6f4ea';
                        document.getElementById('gscAuthSection').style.border = '1px solid #34a853';
                        fetchGscProperties();
                    }
                }
            });
        }

        async function fetchGscProperties() {
            const statusEl = document.getElementById('gscAuthStatus');
            const selectEl = document.getElementById('gscSiteList');
            const selectorDiv = document.getElementById('gscPropertySelector');

            try {
                statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching site properties...';
                const response = await fetch('https://www.googleapis.com/webmasters/v3/sites', {
                    headers: { 'Authorization': `Bearer ${gscAccessToken}` }
                });
                const data = await response.json();

                if (data.siteEntry) {
                    // Filter for properties where user has sufficient permission
                    const validSites = data.siteEntry.filter(site =>
                        site.permissionLevel === 'siteFullUser' || site.permissionLevel === 'siteOwner'
                    );

                    if (validSites.length > 0) {
                        selectEl.innerHTML = '<option value="">-- Choose a property --</option>';
                        validSites.forEach(site => {
                            const option = document.createElement('option');
                            option.value = site.siteUrl;
                            option.textContent = site.siteUrl;
                            selectEl.appendChild(option);
                        });
                        selectorDiv.style.display = 'block';
                        document.getElementById('gscTabsSection').style.display = 'block';
                        statusEl.innerHTML = '<i class="fas fa-check-circle" style="color: #34a853;"></i> Connected. Please select a property below.';
                    } else {
                        statusEl.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #ea4335;"></i> Attached Google account has no verified GSC properties with Full/Owner access.';
                    }
                } else {
                    statusEl.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #ea4335;"></i> No GSC properties found for this account.';
                }
            } catch (err) {
                statusEl.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #ea4335;"></i> Error fetching properties: ' + err.message;
            }
        }

        function updateSelectedProperty() {
            selectedGscProperty = document.getElementById('gscSiteList').value;
            const toolsArea = document.getElementById('gscToolsArea');
            if (selectedGscProperty) {
                toolsArea.style.opacity = '1';
                // toolsArea.style.pointerEvents = 'auto'; // No longer needed as we'll handle validation in functions
            } else {
                // toolsArea.style.opacity = '0.5'; // Keep opacity for visual feedback
                // toolsArea.style.pointerEvents = 'none'; // REMOVED: Allow clicks to trigger prompts
            }
        }

        // Initialize on load if library ready
        window.addEventListener('load', initGscAuth);

        function connectGsc() {
            if (!tokenClient) initGscAuth();
            if (!tokenClient) return alert("Google Identity Services not loaded yet.");
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        function switchGscTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.gsc-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('onclick').includes(`'${tabName}'`)) tab.classList.add('active');
            });

            // Update panels
            document.querySelectorAll('.gsc-tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(`panel-${tabName}`).classList.add('active');
        }

        async function fetchGscSearchInsights() {
            if (!gscAccessToken) return alert("Please connect to Google Search Console first.");
            if (!selectedGscProperty || selectedGscProperty === "") {
                const selector = document.getElementById('gscSiteList');
                selector.style.border = '2px solid #ea4335';
                setTimeout(() => selector.style.border = '1px solid #ddd', 2000);
                return alert("Please select a Search Console property from the dropdown list first.");
            }

            const period = document.getElementById('gscInsightPeriod').value;
            const loader = document.getElementById('gscInsightsLoader');
            const content = document.getElementById('gscInsightsContent');
            const empty = document.getElementById('gscInsightsEmpty');

            loader.style.display = 'block';
            content.style.display = 'none';
            empty.style.display = 'none';

            console.log("Fetching GSC Insights for:", selectedGscProperty, "Period:", period);

            try {
                const today = new Date();
                const startDate = new Date(today);
                startDate.setDate(today.getDate() - parseInt(period));

                const payload = {
                    startDate: startDate.toISOString().split('T')[0],
                    endDate: today.toISOString().split('T')[0],
                    dimensions: ["query", "page"],
                    rowLimit: 5000
                };

                const response = await fetch(OPTIMISER_ENDPOINTS.GSC_INTEGRATION, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'querySearchAnalytics',
                        site_url: selectedGscProperty,
                        access_token: gscAccessToken,
                        payload: payload
                    })
                });

                const rawData = await response.json();
                console.log("GSC Insights Raw Data:", rawData);

                const data = parseLambdaResponse(rawData);
                console.log("GSC Insights Parsed Data:", data);

                if (data.error) throw new Error(data.error);

                displayGscPerformance(data.rows || []);

            } catch (err) {
                console.error("GSC Insights Error:", err);
                alert("Error fetching insights: " + err.message);
                empty.style.display = 'block';
            } finally {
                loader.style.display = 'none';
            }
        }

        function displayGscPerformance(rows) {
            const content = document.getElementById('gscInsightsContent');
            const tableBody = document.getElementById('table-performance-body');
            const listStriking = document.getElementById('list-striking-distance');
            const listLowCtr = document.getElementById('list-low-ctr');
            const listCannibal = document.getElementById('list-cannibalization');
            const listFeatured = document.getElementById('list-featured-snippets');
            const brandInput = document.getElementById('gscBrandName').value.toLowerCase().split(',').map(s => s.trim()).filter(s => s);

            tableBody.innerHTML = '';
            listStriking.innerHTML = '';
            listLowCtr.innerHTML = '';
            listCannibal.innerHTML = '';
            listFeatured.innerHTML = '';

            if (rows.length === 0) {
                document.getElementById('gscInsightsEmpty').style.display = 'block';
                return;
            }

            content.style.display = 'block';

            // SEO Metrics for Insight Detection
            const strikingDistance = [];
            const lowCtr = [];
            const featuredSnippets = [];
            const queryToPages = {}; // For Cannibalization
            let brandedClicks = 0;
            let nonBrandedClicks = 0;

            rows.forEach((row, index) => {
                const query = row.keys[0];
                const pageUrl = row.keys[1] || "";
                const clicks = row.clicks;
                const impressions = row.impressions;
                const ctr = (row.ctr * 100).toFixed(1);
                const pos = row.position.toFixed(1);

                // Branded vs Non-Branded Clicks
                let isBranded = false;
                if (brandInput.length > 0) {
                    isBranded = brandInput.some(b => query.toLowerCase().includes(b));
                }
                if (isBranded) brandedClicks += clicks;
                else nonBrandedClicks += clicks;

                // Cannibalization tracking
                if (!queryToPages[query]) queryToPages[query] = [];
                if (impressions > 10) { // Only track pages with some visibility
                    queryToPages[query].push({ url: pageUrl, clicks, impressions });
                }

                // 1. Detect Striking Distance (Pos 11-20)
                if (row.position > 10 && row.position <= 20) {
                    strikingDistance.push({ query, pageUrl, pos, impressions });
                }

                // 2. Detect Low CTR (Pos 1-5, CTR < 3%)
                if (row.position <= 5 && row.ctr < 0.03 && row.impressions > 100) {
                    lowCtr.push({ query, pageUrl, ctr, impressions });
                }

                // 3. Detect Featured Snippet Potential (Pos 2-7)
                if (row.position > 1.5 && row.position <= 7 && row.impressions > 200) {
                    featuredSnippets.push({ query, pageUrl, pos, impressions });
                }

            });

            // Store data for sorting/pagination
            gscPerformanceData = rows.map(row => ({
                query: row.keys[0],
                pageUrl: row.keys[1] || "",
                clicks: row.clicks,
                impressions: row.impressions,
                ctr: (row.ctr * 100).toFixed(1),
                position: row.position.toFixed(1),
                rawCtr: row.ctr,
                rawPosition: row.position
            }));

            // Reset to default sort and page 1
            gscSortColumn = 'clicks';
            gscSortOrder = 'desc';
            gscCurrentPage = 1;

            renderGscPerformanceTable();

            // Detect Cannibalization
            const cannibalIssues = [];
            for (const query in queryToPages) {
                if (queryToPages[query].length > 1) {
                    // Check if at least two pages have significant impressions (not just long tail noise)
                    const activePages = queryToPages[query].filter(p => p.impressions > 50);
                    if (activePages.length > 1) {
                        cannibalIssues.push({ query, pages: activePages });
                    }
                }
            }

            // Sort insights
            strikingDistance.sort((a, b) => b.impressions - a.impressions);
            lowCtr.sort((a, b) => b.impressions - a.impressions);
            featuredSnippets.sort((a, b) => b.impressions - a.impressions);
            cannibalIssues.sort((a, b) => b.pages.reduce((s, p) => s + p.impressions, 0) - a.pages.reduce((s, p) => s + p.impressions, 0));

            // Display Insights
            if (strikingDistance.length > 0) {
                strikingDistance.slice(0, 10).forEach(item => {
                    const div = document.createElement('div');
                    div.style = "padding: 8px 0; border-bottom: 1px solid #f8f9fa; font-size: 12px;";
                    div.innerHTML = `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                    <span style="font-weight: 500;">${item.query}</span> 
                                    <span style="color: #1e8e3e; font-weight: bold;">Pos ${item.pos}</span>
                                </div>
                                <div style="color: #888; font-size: 12px; word-break: break-all;">${item.pageUrl}</div>
                            `;
                    listStriking.appendChild(div);
                });
            } else {
                listStriking.innerHTML = '<p style="color: #999; font-size: 11px;">No page 2 keywords found.</p>';
            }

            if (lowCtr.length > 0) {
                lowCtr.slice(0, 10).forEach(item => {
                    const div = document.createElement('div');
                    div.style = "padding: 8px 0; border-bottom: 1px solid #f8f9fa; font-size: 12px;";
                    div.innerHTML = `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                    <span style="font-weight: 500;">${item.query}</span> 
                                    <span style="color: #d93025; font-weight: bold;">${item.ctr}% CTR</span>
                                </div>
                                <div style="color: #888; font-size: 12px; word-break: break-all;">${item.pageUrl}</div>
                            `;
                    listLowCtr.appendChild(div);
                });
            } else {
                listLowCtr.innerHTML = '<p style="color: #999; font-size: 11px;">No low CTR top-ranked keywords found.</p>';
            }

            if (featuredSnippets.length > 0) {
                featuredSnippets.slice(0, 10).forEach(item => {
                    const div = document.createElement('div');
                    div.style = "padding: 8px 0; border-bottom: 1px solid #f8f9fa; font-size: 12px;";
                    div.innerHTML = `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                                    <span style="font-weight: 500;">${item.query}</span> 
                                    <span style="color: #fbbc05; font-weight: bold;">Pos ${item.pos}</span>
                                </div>
                                <div style="color: #888; font-size: 12px; word-break: break-all;">${item.pageUrl}</div>
                            `;
                    listFeatured.appendChild(div);
                });
            } else {
                listFeatured.innerHTML = '<p style="color: #999; font-size: 11px;">No high-potency snippet keywords found.</p>';
            }

            if (cannibalIssues.length > 0) {
                cannibalIssues.slice(0, 10).forEach(item => {
                    const div = document.createElement('div');
                    div.style = "padding: 8px 0; border-bottom: 1px solid #f8f9fa; font-size: 12px;";
                    div.innerHTML = `
                                <div style="font-weight: 500; margin-bottom: 4px; color: #c5221f;"><i class="fas fa-copy"></i> ${item.query}</div>
                                ${item.pages.slice(0, 2).map(p => `<div style="color: #888; font-size: 12px; word-break: break-all; margin-bottom: 2px;"> ${p.url} (${p.clicks} clicks)</div>`).join('')}
                                ${item.pages.length > 2 ? `<div style="color: #999; font-size: 12px; padding-left: 8px;">+ ${item.pages.length - 2} more pages</div>` : ''}
                            `;
                    listCannibal.appendChild(div);
                });
            } else {
                listCannibal.innerHTML = '<p style="color: #999; font-size: 11px;">No cannibalization detected.</p>';
            }

            // Display Brand Split
            document.getElementById('val-branded-clicks').innerText = brandedClicks.toLocaleString();
            document.getElementById('val-nonbranded-clicks').innerText = nonBrandedClicks.toLocaleString();
            const totalClicks = brandedClicks + nonBrandedClicks;
            const brandPct = totalClicks > 0 ? (brandedClicks / totalClicks) * 100 : 0;
            document.getElementById('bar-brand-split').style.width = brandPct + '%';
        }

        function normalizeGscUrl(url) {
            if (!url) return url;
            try {
                // Remove whitespace
                url = url.trim();
                const urlObj = new URL(url);
                let path = urlObj.pathname;

                const excludedExtensions = ['.pdf', '.html', '.php', '.xml', '.txt', '.jpg', '.jpeg', '.png', '.gif', '.svg', '.webp', '.css', '.js', '.zip', '.rar', '.doc', '.docx', '.xls', '.xlsx'];

                if (!path.endsWith('/')) {
                    const hasExcludedExtension = excludedExtensions.some(ext => path.toLowerCase().endsWith(ext));
                    if (!hasExcludedExtension) {
                        urlObj.pathname = path + '/';
                    }
                }
                return urlObj.toString();
            } catch (e) {
                return url;
            }
        }

        async function runGscInspection() {
            const btn = document.getElementById('btnRunGscInspection');
            const originalHtml = btn.innerHTML;

            const textarea = document.getElementById('gscInspectUrls');
            const rawUrls = textarea.value.split('\n').map(u => u.trim()).filter(u => u !== "");
            const urls = rawUrls.map(u => normalizeGscUrl(u));
            const resultsArea = document.getElementById('gscResults');

            if (urls.length === 0) return alert("Please enter at least one URL to inspect.");
            if (!gscAccessToken) return alert("Please connect to Google Search Console first.");
            if (!selectedGscProperty || selectedGscProperty === "") {
                const selector = document.getElementById('gscSiteList');
                selector.style.border = '2px solid #ea4335';
                setTimeout(() => selector.style.border = '1px solid #ddd', 2000);
                return alert("Please select a Search Console property from the dropdown list first.");
            }

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            btn.disabled = true;

            resultsArea.style.display = 'block';
            const tableBody = document.getElementById('gscLogsBody');
            const systemLog = document.getElementById('gscSystemStatus');

            tableBody.innerHTML = ''; // Reset table
            systemLog.innerHTML = `<div style="color: #4285f4;">[System] Starting bulk inspection for ${urls.length} URLs...</div>`;

            const NEUTRAL_HINT = "NEUTRAL (Excluded): The URL is not in Google's index. This could be because it's discovered but not crawled, a redirect, canonicalized to another URL, or excluded by a 'noindex' tag.";

            try {
                let count = 0;
                for (const url of urls) {
                    count++;
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #f1f3f4';
                    row.innerHTML = `
                                <td style="padding: 10px;">${count}</td>
                                <td style="padding: 10px; word-break: break-all;">${url}</td>
                                <td id="gsc-res-${count}" style="padding: 10px; color: #888;"><i>Inspecting...</i></td>
                            `;
                    tableBody.appendChild(row);

                    try {
                        const response = await fetch('https://searchconsole.googleapis.com/v1/urlInspection/index:inspect', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${gscAccessToken}`
                            },
                            body: JSON.stringify({
                                inspectionUrl: url,
                                siteUrl: selectedGscProperty,
                                languageCode: "en-US"
                            })
                        });
                        const data = await response.json();
                        const statusCell = document.getElementById(`gsc-res-${count}`);

                        if (data.error) {
                            statusCell.innerHTML = `<span style="color: #ea4335;" title="${data.error.message}">Error</span>`;
                            systemLog.innerHTML += `<div style="color: #ea4335;">[Error] URL ${count}: ${data.error.message}</div>`;
                        } else {
                            const result = data.inspectionResult || {};
                            const statusResult = result.indexStatusResult || {};
                            const verdict = statusResult.verdict || "UNKNOWN";
                            const coverage = statusResult.coverageState || "";

                            let displayStatus = verdict;
                            let color = "#666";
                            let tooltipAttr = "";
                            let cursorStyle = "";

                            if (verdict === "PASS") {
                                displayStatus = "Indexed";
                                color = "#34a853";
                            } else if (verdict === "NEUTRAL") {
                                displayStatus = coverage ? coverage.replace(/_/g, " ").toLowerCase().replace(/\b\w/g, l => l.toUpperCase()) : "Not Indexed";
                                color = "#fbbc05";
                                tooltipAttr = `title="${NEUTRAL_HINT}"`;
                                cursorStyle = "cursor: help;";
                            } else if (verdict === "FAIL") {
                                displayStatus = "Error";
                                color = "#ea4335";
                            } else if (verdict === "PARTIAL") {
                                displayStatus = "Partially Indexed";
                                color = "#fbbc05";
                            }

                            statusCell.innerHTML = `<b style="color: ${color}; ${cursorStyle}" ${tooltipAttr}>${displayStatus}</b>`;
                        }
                    } catch (err) {
                        document.getElementById(`gsc-res-${count}`).innerHTML = `<span style="color: #ea4335;">Failed</span>`;
                        systemLog.innerHTML += `<div style="color: #ea4335;">[Error] URL ${count}: Fetch failed - ${err.message}</div>`;
                    }
                }
                systemLog.innerHTML += `<div style="color: #4285f4; margin-top: 5px; font-weight: bold;">[System] Inspection complete.</div>`;
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }


        async function submitGscIndexing(type) {
            const btn = type === 'URL_UPDATED' ? document.getElementById('btnSubmitGscIndexing') : document.getElementById('btnRequestGscDeletion');
            const originalHtml = btn.innerHTML;

            const textarea = document.getElementById('gscIndexUrls');
            const rawUrls = textarea.value.split('\n').map(u => u.trim()).filter(u => u !== "");
            const urls = rawUrls.map(u => normalizeGscUrl(u));
            const resultsArea = document.getElementById('gscResults');

            if (urls.length === 0) return alert("Please enter at least one URL to submit.");
            if (!gscAccessToken) return alert("Please connect to Google Search Console first.");
            if (!selectedGscProperty || selectedGscProperty === "") {
                const selector = document.getElementById('gscSiteList');
                selector.style.border = '2px solid #ea4335';
                setTimeout(() => selector.style.border = '1px solid #ddd', 2000);
                return alert("Please select a Search Console property from the dropdown list first.");
            }

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            btn.disabled = true;

            resultsArea.style.display = 'block';
            const tableBody = document.getElementById('gscLogsBody');
            const systemLog = document.getElementById('gscSystemStatus');

            const actionLabel = type === 'URL_UPDATED' ? "Indexing Submission" : "Deletion Request";
            tableBody.innerHTML = ''; // Reset table
            systemLog.innerHTML = `<div style="color: #34a853;">[System] Starting ${actionLabel} for ${urls.length} URLs...</div>`;

            try {
                let count = 0;
                for (const url of urls) {
                    count++;
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #f1f3f4';
                    row.innerHTML = `
                                <td style="padding: 10px;">${count}</td>
                                <td style="padding: 10px; word-break: break-all;">${url}</td>
                                <td id="gsc-sub-${count}" style="padding: 10px; color: #888;"><i>Submitting...</i></td>
                            `;
                    tableBody.appendChild(row);

                    try {
                        // Use Lambda Proxy to bypass CORS on Indexing API
                        const response = await fetch(OPTIMISER_ENDPOINTS.GSC_INTEGRATION, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'submitIndexing',
                                url: url,
                                type: type,
                                access_token: gscAccessToken
                            })
                        });
                        const data = await response.json();
                        const statusCell = document.getElementById(`gsc-sub-${count}`);

                        // Lambda proxy might return success but Google API might have failed
                        const result = parseLambdaResponse(data);

                        if (result.error) {
                            statusCell.innerHTML = `<span style="color: #ea4335;" title="${result.error}">Error</span>`;
                            systemLog.innerHTML += `<div style="color: #ea4335;">[Error] URL ${count}: ${result.error}</div>`;
                        } else {
                            statusCell.innerHTML = `<b style="color: #34a853;">SUCCESS</b>`;
                        }
                    } catch (err) {
                        document.getElementById(`gsc-sub-${count}`).innerHTML = `<span style="color: #ea4335;">Failed</span>`;
                        systemLog.innerHTML += `<div style="color: #ea4335;">[Error] URL ${count}: ${err.message}</div>`;
                    }
                }
                systemLog.innerHTML += `<div style="color: #34a853; margin-top: 5px; font-weight: bold;">[System] Submission process complete.</div>`;
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }


        function removeGeneratedContent(btn) {
            const block = btn.closest('.generated-content-block');
            if (!block) return;
            // Also remove the trailing &nbsp; p tag if it exists
            if (block.nextElementSibling && block.nextElementSibling.tagName === 'P' && block.nextElementSibling.innerHTML === '&nbsp;') {
                block.nextElementSibling.remove();
            }
            block.remove();
            updateEditorMetrics();
        }

        async function aiContinueWriting() {
            const editor = document.getElementById('editorContent');
            const content = editor.innerHTML;
            const btn = document.getElementById('btnAiContinue');
            const originalBtnContent = btn.innerHTML;

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Writing...';
            btn.disabled = true;

            const loadingId = "loading_" + Date.now();
            editor.innerHTML += `<p id="${loadingId}"><i>Continuing writing...</i></p>`;

            const primaryKeyword = document.getElementById('primaryKeyword')?.value || "";
            const secondaryKeywords = document.getElementById('secondaryKeywords')?.value || "";
            const personaContext = getPersonaData();
            const selectedTopics = getSelectedTopicsData(currentOptimiserFlow);

            const enhancedContent = `
${personaContext ? "TARGET PERSONAS:\n" + personaContext + "\n" : ""}
${selectedTopics ? "RELEVANT COMPETITOR TOPICS TO INCLUDE:\n" + selectedTopics + "\n" : ""}
EXISTING CONTENT:
${content}
`.trim();

            try {
                const response = await fetch(OPTIMISER_ENDPOINTS.CONTENT_AI, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'continue',
                        content: enhancedContent,
                        primary_keyword: primaryKeyword,
                        secondary_keywords: secondaryKeywords,
                        compliance_guidelines: getSelectedCompliance(currentOptimiserFlow),
                        settings: aiContentSettings
                    })
                });
                const data = await response.json();
                const result = parseLambdaResponse(data);

                document.getElementById(loadingId).remove();

                const blockId = "gen_" + Date.now();
                const formattedContent = formatMarkdown(result.result);
                const generatedHtml = `
                    <div id="${blockId}" class="generated-content-block" contenteditable="false">
                        <div class="generated-badge">generated content</div>
                        <div class="generated-text-body" style="color: #333;" contenteditable="true">
                            ${formattedContent}
                        </div>
                        <div class="generated-actions">
                            <button class="btn-accept-content" onclick="acceptGeneratedContent(this); event.stopPropagation();">
                                <i class="fas fa-check"></i> Accept
                            </button>
                            <button class="btn-remove-content" onclick="removeGeneratedContent(this); event.stopPropagation();">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                `;
                editor.innerHTML += generatedHtml;
                updateEditorMetrics();
            } catch (error) {
                document.getElementById(loadingId).innerHTML = "<i>Error continuing text.</i>";
            } finally {
                btn.innerHTML = originalBtnContent;
                btn.disabled = false;
            }
        }

        async function aiQuickAction(type) {
            const editor = document.getElementById('editorContent');
            let selection = window.getSelection();
            let selectedText = selection.toString().trim();
            let range = null;

            // Capture range if selection is within the editor
            if (selectedText && editor.contains(selection.anchorNode)) {
                range = selection.getRangeAt(0);
            }

            const content = selectedText || editor.innerHTML;

            const btn = (event && event.currentTarget) ? event.currentTarget : (event && event.target ? event.target.closest('button') : null);
            const originalContent = btn ? btn.innerHTML : null;
            if (btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;
            }

            const primaryKeyword = document.getElementById('primaryKeyword')?.value || "";
            const secondaryKeywords = document.getElementById('secondaryKeywords')?.value || "";
            const personaContext = getPersonaData();
            const selectedTopics = getSelectedTopicsData(currentOptimiserFlow);

            const enhancedContent = `
${personaContext ? "TARGET PERSONAS:\n" + personaContext + "\n" : ""}
${selectedTopics ? "COMPETITOR TOPICS CONTEXT:\n" + selectedTopics + "\n" : ""}
TEXT TO ${type.toUpperCase()}:
${content}
`.trim();

            try {
                const response = await fetch(OPTIMISER_ENDPOINTS.CONTENT_AI, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: type,
                        content: enhancedContent,
                        primary_keyword: primaryKeyword,
                        secondary_keywords: secondaryKeywords,
                        compliance_guidelines: getSelectedCompliance(currentOptimiserFlow),
                        settings: aiContentSettings
                    })
                });
                const data = await response.json();
                const result = parseLambdaResponse(data);

                const blockId = "gen_" + Date.now();
                const formattedContent = formatMarkdown(result.result);
                const generatedHtml = `
                    <div id="${blockId}" class="generated-content-block" contenteditable="false">
                        <div class="generated-badge">generated ${type}ed content</div>
                        <div class="generated-text-body" style="color: #333;" contenteditable="true">
                            ${formattedContent}
                        </div>
                        <div class="generated-actions">
                            <button class="btn-accept-content" onclick="acceptGeneratedContent(this); event.stopPropagation();">
                                <i class="fas fa-check"></i> Accept
                            </button>
                            <button class="btn-remove-content" onclick="removeGeneratedContent(this); event.stopPropagation();">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                `;

                if (range) {
                    // Replace selection with generated block
                    range.deleteContents();
                    const div = document.createElement('div');
                    div.innerHTML = generatedHtml;
                    range.insertNode(div.firstElementChild);
                } else {
                    // Replace whole editor content as fallback
                    editor.innerHTML = generatedHtml;
                }

                updateEditorMetrics();
            } catch (error) {
                alert("Error performing AI action.");
            } finally {
                if (btn) {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                }
            }
        }

        async function runPlagiarismCheck() {
            const scoreDisp = document.getElementById('plagiarismScore');
            const metaDisp = document.getElementById('plagiarismMeta');
            const statusBox = document.getElementById('plagiarismStatus');
            const content = document.getElementById('editorContent').innerText;

            if (OPTIMISER_ENDPOINTS.PLAGIARISM === 'YOUR_PLAGIARISM_LAMBDA_URL') {
                scoreDisp.innerText = "Check Disabled";
                return;
            }

            scoreDisp.innerText = "Checking...";
            metaDisp.innerText = "Connecting to Copyscape...";

            try {
                const response = await fetch(OPTIMISER_ENDPOINTS.PLAGIARISM, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: content })
                });
                const data = await response.json();
                const result = parseLambdaResponse(data);

                console.log("Plagiarism Parsed Result:", result);

                if (result.error || (result.raw_api_response && result.raw_api_response.error)) {
                    const errMsg = result.error || result.raw_api_response.error;
                    scoreDisp.innerText = "Error";
                    metaDisp.innerText = errMsg;
                    statusBox.className = "status-box error";
                    return;
                }

                const score = result.originality_score !== undefined ? result.originality_score : 100;
                scoreDisp.innerText = Math.round(score) + "%";
                metaDisp.innerText = `${result.word_count || content.split(/\s+/).length} words  ${result.total_matches || 0} match(es)`;

                let sourcesHtml = "";
                if (result.matched_sources && result.matched_sources.length > 0) {
                    sourcesHtml = '<div style="margin-top: 10px; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 10px; font-size: 12px; text-align: left;">';
                    sourcesHtml += '<b>Matched Sources:</b><ul style="margin: 5px 0; padding-left: 20px;">';
                    result.matched_sources.forEach(src => {
                        sourcesHtml += `<li style="margin-bottom: 4px;"><a href="${src.url}" target="_blank" style="color: #004c9d; word-break: break-all;">${src.title || src.url}</a> (${src.minwordsmatched || '?'}+ words)</li>`;
                    });
                    sourcesHtml += '</ul></div>';
                }

                if (score > 90) {
                    statusBox.className = "status-box success";
                    document.getElementById('plagiarismTitle').innerText = "Original Content";
                    document.getElementById('plagiarismMsg').innerText = "No significant matches found. Content appears original.";
                    statusBox.style.background = "#e6ffe6";
                    statusBox.style.color = "#008000";
                } else if (score > 70) {
                    statusBox.className = "status-box warning";
                    document.getElementById('plagiarismTitle').innerText = "Minor Matches Found";
                    document.getElementById('plagiarismMsg').innerText = "A few phrases match existing online sources.";
                    statusBox.style.background = "#fff9db";
                    statusBox.style.color = "#f08c00";
                } else {
                    statusBox.className = "status-box error";
                    document.getElementById('plagiarismTitle').innerText = "Significant Plagiarism Detected";
                    document.getElementById('plagiarismMsg').innerText = "Multiple sections match existing online sources. Review required.";
                    statusBox.style.background = "#ffe6e6";
                    statusBox.style.color = "#cc0000";
                }

                // Append sources list if it exists
                const existingList = statusBox.querySelector('.sources-list');
                if (existingList) existingList.remove();
                if (sourcesHtml) {
                    const listContainer = document.createElement('div');
                    listContainer.className = "sources-list";
                    listContainer.innerHTML = sourcesHtml;
                    statusBox.appendChild(listContainer);
                }

            } catch (error) {
                console.error("Plagiarism Check Error:", error);
                scoreDisp.innerText = "Error";
                metaDisp.innerText = "Failed to run check.";
                statusBox.className = "status-box error";
                document.getElementById('plagiarismTitle').innerText = "Check Failed";
                document.getElementById('plagiarismMsg').innerText = "Could not connect to plagiarism service.";
                statusBox.style.background = "#ffe6e6";
                statusBox.style.color = "#cc0000";
            }
        }

        // Floating Selection Toolbar Logic
        const editor = document.getElementById('editorContent');
        const selectionToolbar = document.getElementById('selectionToolbar');

        editor.addEventListener('mouseup', showSelectionToolbar);
        editor.addEventListener('keyup', showSelectionToolbar);
        document.addEventListener('mousedown', (e) => {
            if (selectionToolbar && !selectionToolbar.contains(e.target) && !editor.contains(e.target)) {
                hideSelectionToolbar();
            }
        });
        // Global AI Content Settings State
        let currentOptimiserFlow = 'new';
        let personaOriginPathway = null;
        let aiContentSettings = {
            audience: "Working professionals",
            brandTone: "Professional",
            searchIntent: "Informational",
            industry: "General",
            riskLevel: "Low",
            jurisdictions: "SG",
            locale: "en-SG",
            readingLevel: "Grade 6-8 (Easy)",
            doUseWords: "",
            doNotUseWords: "",
            focusProducts: "",
            schemaType: "Article",
            complianceDisclaimers: false,
            suggestExternalLinks: false
        };

        // Load saved settings if available
        const savedAiSettings = localStorage.getItem('aiContentSettings');
        if (savedAiSettings) {
            try {
                const parsed = JSON.parse(savedAiSettings);
                aiContentSettings = { ...aiContentSettings, ...parsed };
            } catch (e) {
                console.error("Error parsing saved AI settings", e);
            }
        }

        // Initialize external link toggle UI
        // We defer this slightly to ensure DOM is ready if script runs early, 
        // though usually in this file structure it's fine.
        setTimeout(() => {
            // updateEditorExternalLinkToggle(aiContentSettings.suggestExternalLinks);
        }, 100);

        function openAiSettingsModal() {
            const modal = document.getElementById('aiSettingsModal');
            if (!modal) return;

            // Populate modal with current settings
            document.getElementById('setAudience').value = aiContentSettings.audience;
            document.getElementById('setBrandTone').value = aiContentSettings.brandTone;
            document.getElementById('setSearchIntent').value = aiContentSettings.searchIntent;
            document.getElementById('setIndustry').value = aiContentSettings.industry;
            document.getElementById('setRiskLevel').value = aiContentSettings.riskLevel;
            document.getElementById('setJurisdictions').value = aiContentSettings.jurisdictions;
            document.getElementById('setLocale').value = aiContentSettings.locale;
            document.getElementById('setReadingLevel').value = aiContentSettings.readingLevel;
            document.getElementById('setDoUseWords').value = aiContentSettings.doUseWords;
            document.getElementById('setDoNotUseWords').value = aiContentSettings.doNotUseWords;
            document.getElementById('setFocusProducts').value = aiContentSettings.focusProducts;
            document.getElementById('setSchemaType').value = aiContentSettings.schemaType;
            document.getElementById('setSchemaType').value = aiContentSettings.schemaType;
            document.getElementById('setComplianceDisclaimers').checked = aiContentSettings.complianceDisclaimers;
            document.getElementById('setSuggestExternalLinks').checked = aiContentSettings.suggestExternalLinks || false;

            modal.style.display = 'block';
        }

        function closeAiSettingsModal() {
            const modal = document.getElementById('aiSettingsModal');
            if (modal) modal.style.display = 'none';
        }

        function resetAiSettings() {
            // Revert global state to defaults
            aiContentSettings = {
                audience: "",
                brandTone: "Professional",
                searchIntent: "Informational",
                industry: "General",
                riskLevel: "Low",
                jurisdictions: "SG",
                locale: "en-SG",
                readingLevel: "Grade 6-8 (Easy)",
                doUseWords: "",
                doNotUseWords: "",
                focusProducts: "",
                schemaType: "Article",
                complianceDisclaimers: false
            };
            openAiSettingsModal(); // Refresh UI
        }

        function applyAiSettings() {
            // Save modal values to global state
            aiContentSettings = {
                audience: document.getElementById('setAudience').value,
                brandTone: document.getElementById('setBrandTone').value,
                searchIntent: document.getElementById('setSearchIntent').value,
                industry: document.getElementById('setIndustry').value,
                riskLevel: document.getElementById('setRiskLevel').value,
                jurisdictions: document.getElementById('setJurisdictions').value,
                locale: document.getElementById('setLocale').value,
                readingLevel: document.getElementById('setReadingLevel').value,
                doUseWords: document.getElementById('setDoUseWords').value,
                doNotUseWords: document.getElementById('setDoNotUseWords').value,
                focusProducts: document.getElementById('setFocusProducts').value,
                schemaType: document.getElementById('setSchemaType').value,
                complianceDisclaimers: document.getElementById('setComplianceDisclaimers').checked,
                suggestExternalLinks: document.getElementById('setSuggestExternalLinks').checked
            };
            localStorage.setItem('aiContentSettings', JSON.stringify(aiContentSettings));
            closeAiSettingsModal();
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('aiSettingsModal');
            if (event.target == modal) {
                closeAiSettingsModal();
            }
        }

        async function runSmartLinking() {
            const btn = document.getElementById('btnRunSmartLinkingToolbar');
            if (btn) btn.disabled = true;

            // Get content
            const content = document.getElementById('editorContent').innerHTML;
            const htmlContent = document.getElementById('editorContent').innerHTML;

            const originalBtnHtml = btn ? btn.innerHTML : '';
            if (btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(OPTIMISER_ENDPOINTS.CONTENT_AI, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'add_links',
                        content: htmlContent,
                        settings: aiContentSettings,
                        primary_keyword: document.getElementById('primaryKeyword')?.value || "",
                        secondary_keywords: document.getElementById('secondaryKeywords')?.value || ""
                    })
                });
                const data = await response.json();
                const parsed = parseLambdaResponse(data);
                const result = (parsed && parsed.result) ? parsed.result : parsed;

                if (result && typeof result === 'string') {
                    // Result is now native HTML as per the new prompt
                    document.getElementById('editorContent').innerHTML = result;
                    updateEditorMetrics();
                }
            } catch (e) {
                console.error("Smart Linking Error:", e);
                alert("Failed to run Smart Linking. Please try again.");
            } finally {
                if (btn) {
                    btn.innerHTML = originalBtnHtml;
                    btn.disabled = false;
                }
            }
        }

        function showSelectionToolbar() {
            const selection = window.getSelection();
            if (selection.isCollapsed || selection.toString().trim().length === 0) {
                hideSelectionToolbar();
                return;
            }

            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();

            // Position above selection
            selectionToolbar.style.display = 'flex';
            const toolbarRect = selectionToolbar.getBoundingClientRect();

            // Calculate absolute position (accounting for window scroll)
            const top = rect.top + window.scrollY - toolbarRect.height - 10;
            const left = rect.left + window.scrollX + (rect.width / 2) - (toolbarRect.width / 2);

            selectionToolbar.style.top = `${top}px`;
            selectionToolbar.style.left = `${left}px`;
        }

        function hideSelectionToolbar() {
            if (selectionToolbar) {
                selectionToolbar.style.display = 'none';
                const customInput = document.getElementById('stCustomInstructions');
                if (customInput) customInput.value = '';
            }
        }

        async function handleSelectionAction(action) {
            const selection = window.getSelection();
            const selectedText = selection.toString();
            if (!selectedText) return;

            const customInstruction = document.getElementById('stCustomInstructions')?.value.trim();

            // Save the range before making the API call
            const range = selection.getRangeAt(0);

            // Show a temporary "processing" state in the toolbar
            const originalToolbarHtml = selectionToolbar.innerHTML;
            const actionLabel = action.charAt(0).toUpperCase() + action.slice(1);
            selectionToolbar.innerHTML = `<div style="padding: 8px 15px; font-size: 13px; color: #004c9d; display: flex; align-items: center; gap: 10px; font-weight: 500;">
                                            <i class="fas fa-spinner fa-spin"></i> AI ${actionLabel} in progress...
                                          </div>`;

            try {
                const personaContext = getPersonaData();
                const selectedTopics = getSelectedTopicsData(currentOptimiserFlow);

                const enhancedContent = `
${personaContext ? "TARGET PERSONAS:\n" + personaContext + "\n" : ""}
${selectedTopics ? "CONTEXTUAL COMPETITOR TOPICS:\n" + selectedTopics + "\n" : ""}
${customInstruction ? "USER CUSTOM INSTRUCTIONS/COMMENTS:\n" + customInstruction + "\n" : ""}
SELECTED TEXT TO ${action.toUpperCase()}:
${selectedText}
`.trim();

                const response = await fetch(OPTIMISER_ENDPOINTS.CONTENT_AI, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: action,
                        content: enhancedContent,
                        settings: aiContentSettings,
                        primary_keyword: document.getElementById('primaryKeyword')?.value || "",
                        compliance_guidelines: getSelectedCompliance(currentOptimiserFlow)
                    })
                });
                const data = await response.json();
                const result = parseLambdaResponse(data);

                const formattedContent = formatMarkdown(result.result);
                const diffId = "diff_" + Date.now();

                // Create the diff reveal structure
                // Use a span wrapper so it doesn't break paragraph flow
                const diffHtml = `
                    <span id="${diffId}" class="diff-preview-wrapper" contenteditable="false">
                        <span class="diff-original" title="Original text">${selectedText}</span>
                        <span class="diff-new" contenteditable="true" title="AI suggestion (Editable)">${formattedContent}</span>
                        <span class="diff-controls">
                            <button class="btn-diff-accept" onclick="acceptSelectionDiff(this); event.stopPropagation();">Accept</button>
                            <button class="btn-diff-undo" onclick="undoSelectionDiff(this); event.stopPropagation();">Undo</button>
                        </span>
                    </span>
                `;

                // Re-select the range
                selection.removeAllRanges();
                selection.addRange(range);

                // Replace selection with the diff structure
                document.execCommand('insertHTML', false, diffHtml);

                hideSelectionToolbar();
                updateEditorMetrics();
            } catch (error) {
                console.error("Selection Action Error:", error);
                alert("Error performing AI action on selection.");
                selectionToolbar.innerHTML = originalToolbarHtml;
            } finally {
                if (selectionToolbar.innerHTML.includes('spinner')) {
                    selectionToolbar.innerHTML = originalToolbarHtml;
                }
            }
        }

        function acceptSelectionDiff(btn) {
            const diffEl = btn.closest('.diff-preview-wrapper');
            if (!diffEl) return;

            const newTextEl = diffEl.querySelector('.diff-new');
            const acceptedContent = newTextEl ? newTextEl.innerHTML : "";

            // Replace the whole diff wrapper with just the new content
            const temp = document.createElement('span');
            temp.innerHTML = acceptedContent;
            diffEl.parentNode.replaceChild(temp, diffEl);

            updateEditorMetrics();
        }

        function undoSelectionDiff(btn) {
            const diffEl = btn.closest('.diff-preview-wrapper');
            if (!diffEl) return;

            const originalTextEl = diffEl.querySelector('.diff-original');
            const originalContent = originalTextEl ? originalTextEl.innerHTML : "";

            // Revert back to original text
            const temp = document.createElement('span');
            temp.innerHTML = originalContent;
            diffEl.parentNode.replaceChild(temp, diffEl);

            updateEditorMetrics();
        }

        async function optimiseContent() {
            const resultsDiv = document.getElementById("aiContentOptimiserResults");
            resultsDiv.innerHTML = "<p>Analyzing full structure and content for SEO health...</p>";
            setTimeout(() => {
                runSeoAnalysis();
                resultsDiv.innerHTML = "<div style='background: #e7f5ff; padding: 10px; border-radius: 4px; margin-top: 10px;'>Overall SEO Analysis Triggered. Check the sidebar for detailed score.</div>";
            }, 1000);
        }

        function openLandingPageAudit(event) {
            event.preventDefault();
            deactivateAllButtons();
            showOthersOnly(event);

            const landingPageAuditButton = document.querySelector('button#landingPageAuditBtn');
            if (landingPageAuditButton) {
                landingPageAuditButton.classList.toggle('active');
                const content = landingPageAuditButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const landingPageAuditLink = event.currentTarget;
                landingPageAuditLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const landingPageAuditSection = document.getElementById('landingPageAudit');
                    if (landingPageAuditSection) {
                        landingPageAuditSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        const urlFields = document.querySelectorAll('input[type="url"], textarea#reference-urls, textarea#sem_webpages, textarea#persona_webpages, textarea#MediaPlanWebpages');

        urlFields.forEach(input => {
            input.addEventListener('input', syncUrls);
        });

        function syncUrls(event) {
            const currentUrl = event.target.value;

            // List of IDs to exclude from being synced TO (they can still be the source)
            const excludedIds = ['pillar_website', 'pillar_brand_guide'];

            urlFields.forEach(input => {
                if (input !== event.target && !excludedIds.includes(input.id)) {
                    input.value = currentUrl;
                }
            });
        }

        let currentKeywordSortColumn = null;
        let keywordSortAscending = true;

        let currentRankedKeywordSortColumn = null;
        let rankedKeywordSortAscending = true;

        const submitBtn = document.getElementById('submitBtn');
        const gtmetrixReportDiv = document.getElementById('gtmetrixReport');
        const crawlerReportDiv = document.getElementById('crawlerReport');
        const crawlerTableBody = document.getElementById('crawlerTableBody');
        const pageAuditReportDiv = document.getElementById('pageAuditReport');

        analyzeBtn = document.getElementById('analyzeBtn');
        const resultsDiv = document.getElementById('comparison-results');
        const messageElement = document.querySelector('.message');
        const messages = [
            'Getting SERP results...',
            'Analysing Page Content...',
            'Formulating Content Topics...',
            'Comparing Topics Across Results...',
            'Collating Findings...'
        ];
        let currentMessageIndex = 0;

        brandCheckbox = document.getElementById('brand-checkbox');
        productCheckbox = document.getElementById('product-checkbox');

        brandCheckbox.addEventListener('change', () => {
            if (brandCheckbox.checked) {
            } else {
                if (productCheckbox.checked) {

                } else {
                    productCheckbox.checked = true;
                }
            }
        });

        productCheckbox.addEventListener('change', () => {
            if (productCheckbox.checked) {
            } else {
                if (brandCheckbox.checked) {

                } else {
                    brandCheckbox.checked = true;
                }
            }
        });

        const maxPagesInputElemForCost = document.getElementById('maxPagesInput');
        if (maxPagesInputElemForCost) {
            maxPagesInputElemForCost.addEventListener('input', () => {
                const pages = parseInt(maxPagesInputElemForCost.value) || 0;
                const estimate = (pages / 5) * 0.0063;
                const estimateDisplay = document.getElementById('maxPagesEstimate');
                if (estimateDisplay) {
                    estimateDisplay.innerText = `Estimated Cost: $${estimate.toFixed(4)}`;
                }
            });
        }

        submitBtn.addEventListener('click', () => {
            const url = document.getElementById('urlInput').value;
            const maxPages = document.getElementById('maxPagesInput').value;

            submitBtn.innerHTML = 'Analysing...';
            document.getElementById("technicalButton").style.backgroundColor = "#004c9d";
            document.getElementById("gtButton").style.backgroundColor = "#004c9d";
            document.getElementById("pageButton").style.backgroundColor = "#004c9d";
            document.getElementById("crawlerButton").style.backgroundColor = "#004c9d";
            updateCollapsibleState('technicalButton', 'running');
            updateCollapsibleState('gtButton', 'running');
            updateCollapsibleState('pageButton', 'running');
            updateCollapsibleState('crawlerButton', 'running');

            document.getElementById('auditSummary').innerHTML = "";

            // GTMetrix API call
            fetch("https://y5830908vh.execute-api.ap-southeast-1.amazonaws.com/gtmetrix", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            })
                .then(response => response.json())
                .then(gt_data_raw => {
                    const gt_data = parseLambdaResponse(gt_data_raw);
                    console.log("GTmetrix Parsed:", gt_data);

                    if (gt_data && gt_data.data) {
                        const links = gt_data.data.links || {};
                        const attr = gt_data.data.attributes || {};

                        document.getElementById('reportUrl').innerHTML = links.report_url ?
                            `<a href="${links.report_url}" target="_blank" rel="noopener noreferrer">${links.report_url}</a>` : 'N/A';

                        document.getElementById('cls').textContent = attr.cumulative_layout_shift || 'N/A';
                        document.getElementById('lcp').textContent = attr.largest_contentful_paint || 'N/A';
                        document.getElementById('tbt').textContent = attr.total_blocking_time || 'N/A';
                        document.getElementById('grade').textContent = attr.gtmetrix_grade || 'N/A';
                        document.getElementById('performance').textContent = attr.performance_score || 'N/A';
                    }

                    gtmetrixReportDiv.style.display = 'block';
                    document.getElementById("gtButton").style.backgroundColor = "green";
                    updateCollapsibleState('gtButton', 'success');
                })

                .catch(error => {
                    console.error('Error fetching GTMetrix data:', error);
                    updateCollapsibleState('gtButton', 'error');
                });


            // Webpage Audit
            fetch("https://7vkudwlzhh.execute-api.ap-southeast-1.amazonaws.com/webpageAudit", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            })
                .then(response => response.json())
                .then(webpage_audit_data_raw => {
                    console.log("Webpage Audit Raw:", webpage_audit_data_raw);
                    const webpage_audit_data = parseLambdaResponse(webpage_audit_data_raw);
                    console.log("Webpage Audit Parsed:", webpage_audit_data);

                    document.getElementById('malware').textContent = webpage_audit_data.malware || 'N/A';
                    document.getElementById('sitemap').innerHTML = webpage_audit_data.sitemap ? `<a href="${webpage_audit_data.sitemap}" target="_blank" style="color: #004c9d; text-decoration: underline;">${webpage_audit_data.sitemap}</a>` : 'N/A';
                    const robotsContent = webpage_audit_data.robots || 'N/A';
                    document.getElementById('robots').innerHTML = `<div style="max-height: 180px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85em; white-space: pre-wrap; background: #fafafa; padding: 12px; border: 1px solid #eef0f2; border-radius: 6px; line-height: 1.5; color: #555; box-shadow: inset 0 1px 3px rgba(0,0,0,0.03);">${robotsContent}</div>`;
                    document.getElementById('pagespeed_audit').textContent = webpage_audit_data.pagespeed || 'N/A';

                    pageAuditReportDiv.style.display = 'block';
                    document.getElementById("pageButton").style.backgroundColor = "green";
                    document.getElementById("technicalButton").style.backgroundColor = "green";
                    updateCollapsibleState('pageButton', 'success');
                    updateCollapsibleState('technicalButton', 'success');
                })
                .catch(error => {
                    console.error('Error fetching Webpage Audit data:', error);
                    updateCollapsibleState('pageButton', 'error');
                    updateCollapsibleState('technicalButton', 'error');
                });


            // Trigger DataForSEO Crawler
            initiateDataForSEOCrawl();
        });

        // DataForSEO Crawler State
        let dataForSeoTaskId = null;
        let dataForSeoCrawlItems = [];
        let dataForSeoCrawlUrls = new Set();
        let dataForSeoPollingInterval = null;
        let dataForSeoDynamicHeaders = ["No.", "url"];
        let dataForSeoActiveColumns = new Set(["No.", "url", "status_code", "meta.title", "meta.description", "onpage_score"]);
        const DATA_FOR_SEO_ENDPOINT = 'https://ak9qsl9wgi.execute-api.ap-southeast-1.amazonaws.com/dataforseoCrawler';

        async function initiateDataForSEOCrawl() {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput ? urlInput.value.trim() : '';
            const maxPagesInput = document.getElementById('maxPagesInput');
            const maxPages = maxPagesInput ? parseInt(maxPagesInput.value) : 10;
            const maxDepthInput = document.getElementById('maxDepthInput');
            const maxDepth = maxDepthInput ? parseInt(maxDepthInput.value) : 1;

            if (!url) return alert("Please specify a URL for crawling.");

            const btn = document.getElementById('submitBtn');
            const originalBtnHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Initializing Task...';
            btn.disabled = true;

            // UI setup
            document.getElementById("crawlerButton").style.backgroundColor = "#004c9d";
            document.getElementById('crawlerTableBody').innerHTML = '';
            document.getElementById('crawlerTableHeader').innerHTML = '';
            document.getElementById('crawlerReport').style.display = 'block';
            document.getElementById('columnSelector').style.display = 'block';
            dataForSeoCrawlUrls.clear();
            dataForSeoCrawlItems = [];
            dataForSeoDynamicHeaders = ["No.", "url"];
            // Reserve initial core columns as active
            dataForSeoActiveColumns = new Set(["No.", "url", "status_code", "meta.title", "meta.description", "onpage_score"]);
            updateColumnSelectorUI();

            try {
                const response = await fetch(DATA_FOR_SEO_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'initiate',
                        url: url,
                        max_pages: maxPages,
                        max_depth: maxDepth
                    })
                });

                const data = await response.json();
                const actualData = typeof data.body === 'string' ? JSON.parse(data.body) : (data.body || data);

                // Display Cost
                const costDiv = document.getElementById('dataForSeoCost');
                if (actualData.tasks && actualData.tasks[0] && actualData.tasks[0].cost !== undefined) {
                    costDiv.innerHTML = `Crawl Cost: $${actualData.tasks[0].cost.toFixed(4)}`;
                    costDiv.style.display = 'block';
                }

                const taskResult = actualData.tasks && actualData.tasks[0];

                if (taskResult && taskResult.id) {
                    dataForSeoTaskId = taskResult.id;
                    btn.innerHTML = '<i class="fas fa-spider fa-spin"></i> Crawling...';
                    pollDataForSEOResults(dataForSeoTaskId);
                } else {
                    console.error("Task initiation failed:", actualData);
                    throw new Error("Task ID not returned from DataForSEO.");
                }
            } catch (error) {
                console.error("Initiate error:", error);
                updateCollapsibleState('crawlerButton', 'error');
                alert("Error initiating DataForSEO crawl: " + error.message);
                btn.innerHTML = originalBtnHtml;
                btn.disabled = false;
            }
        }

        function pollDataForSEOResults(taskId) {
            dataForSeoPollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(DATA_FOR_SEO_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'get_results', task_id: taskId })
                    });

                    const data = await response.json();
                    const actualData = typeof data.body === 'string' ? JSON.parse(data.body) : (data.body || data);
                    const task = actualData.tasks && actualData.tasks[0];
                    if (!task || !task.result || !task.result[0]) return;

                    const result = task.result[0];
                    const items = result.items || [];

                    let newItemsFound = false;
                    items.forEach(item => {
                        if (!dataForSeoCrawlUrls.has(item.url)) {
                            const flattened = flattenObject(item);
                            dataForSeoCrawlItems.push(flattened);
                            dataForSeoCrawlUrls.add(item.url);

                            // Update dynamic headers
                            Object.keys(flattened).forEach(key => {
                                if (!dataForSeoDynamicHeaders.includes(key)) {
                                    dataForSeoDynamicHeaders.push(key);
                                    // If it's a new key we don't recognize, default it to active only if we have few columns
                                    if (dataForSeoDynamicHeaders.length < 15) {
                                        dataForSeoActiveColumns.add(key);
                                    }
                                }
                            });
                            newItemsFound = true;
                        }
                    });

                    // Update button with progress
                    const btn = document.getElementById('submitBtn');
                    if (btn) {
                        const maxPagesInput = document.getElementById('maxPagesInput');
                        const maxPages = maxPagesInput ? parseInt(maxPagesInput.value) : (dataForSeoCrawlItems.length || 10);
                        btn.innerHTML = `<i class="fas fa-spider fa-spin"></i> Crawling ${dataForSeoCrawlUrls.size}/${maxPages} pages...`;
                    }

                    if (newItemsFound) {
                        updateColumnSelectorUI();
                        rebuildCrawlerTable();
                    }

                    if (result.crawl_progress !== "in_progress") {
                        stopDataForSEOCrawl();
                    }
                } catch (error) {
                    console.error("Polling error:", error);
                }
            }, 5000);
        }

        function flattenObject(obj, prefix = '') {
            return Object.keys(obj).reduce((acc, k) => {
                const pre = prefix.length ? prefix + '.' : '';
                if (typeof obj[k] === 'object' && obj[k] !== null && !Array.isArray(obj[k])) {
                    Object.assign(acc, flattenObject(obj[k], pre + k));
                } else if (Array.isArray(obj[k])) {
                    acc[pre + k] = JSON.stringify(obj[k]);
                } else {
                    acc[pre + k] = obj[k];
                }
                return acc;
            }, {});
        }

        function rebuildCrawlerTable() {
            const headerEl = document.getElementById('crawlerTableHeader');
            const bodyEl = document.getElementById('crawlerTableBody');

            const visibleHeaders = dataForSeoDynamicHeaders.filter(h => dataForSeoActiveColumns.has(h));

            // Rebuild Header
            let headerHtml = '<tr>';
            visibleHeaders.forEach(h => {
                headerHtml += `<th>${h}</th>`;
            });
            headerHtml += '</tr>';
            headerEl.innerHTML = headerHtml;

            // Rebuild Body
            bodyEl.innerHTML = '';
            dataForSeoCrawlItems.forEach((item, index) => {
                const row = document.createElement('tr');
                let rowHtml = '';

                visibleHeaders.forEach(h => {
                    if (h === "No.") {
                        rowHtml += `<td>${index + 1}</td>`;
                    } else {
                        const val = item[h] !== undefined ? String(item[h]) : '';
                        rowHtml += `<td>${formatTableCell(val)}</td>`;
                    }
                });
                row.innerHTML = rowHtml;
                bodyEl.appendChild(row);
            });
        }

        function updateColumnSelectorUI() {
            const container = document.getElementById('columnCheckboxList');
            const currentSearch = document.querySelector('.column-search-input').value;

            // Generate list but only update if search is empty or we're adding new discovered keys
            // To keep it simple, we'll just rebuild based on current state
            renderColumnCheckboxes(currentSearch);
        }

        function renderColumnCheckboxes(filterText = '') {
            const container = document.getElementById('columnCheckboxList');
            container.innerHTML = '';

            const normalizedFilter = filterText.toLowerCase().replace(/ /g, '_');

            dataForSeoDynamicHeaders.forEach(h => {
                const normalizedKey = h.toLowerCase().replace(/_/g, ' ');
                // Fuzzy search: match space and underscore interchangeably
                if (!filterText || h.toLowerCase().includes(normalizedFilter) || normalizedKey.includes(filterText.toLowerCase())) {
                    const item = document.createElement('label');
                    item.className = 'column-checkbox-item';
                    const checked = dataForSeoActiveColumns.has(h) ? 'checked' : '';
                    item.innerHTML = `<input type="checkbox" ${checked} onchange="toggleColumn('${h}', this.checked)"> ${h}`;
                    container.appendChild(item);
                }
            });
        }

        function filterColumnList(val) {
            renderColumnCheckboxes(val);
        }

        function toggleColumn(key, isActive) {
            if (isActive) {
                dataForSeoActiveColumns.add(key);
            } else {
                dataForSeoActiveColumns.delete(key);
            }
            rebuildCrawlerTable();
        }

        function toggleAllColumns(isActive) {
            if (isActive) {
                dataForSeoDynamicHeaders.forEach(h => dataForSeoActiveColumns.add(h));
            } else {
                dataForSeoActiveColumns.clear();
                dataForSeoActiveColumns.add("No."); // Always keep No.
                dataForSeoActiveColumns.add("url"); // Always keep url
            }
            updateColumnSelectorUI();
            rebuildCrawlerTable();
        }

        function formatTableCell(val) {
            if (val.length > 150) {
                const id = 'text-' + Math.random().toString(36).substr(2, 9);
                return `
                    <div id="${id}" class="cell-content-wrapped">${val}</div>
                    <span class="see-more-btn" onclick="toggleSeeMore('${id}', this)">See more</span>
                `;
            }
            return val;
        }

        function toggleSeeMore(id, btn) {
            const el = document.getElementById(id);
            if (el.classList.contains('cell-content-wrapped')) {
                el.classList.remove('cell-content-wrapped');
                btn.innerText = 'See less';
            } else {
                el.classList.add('cell-content-wrapped');
                btn.innerText = 'See more';
            }
        }

        function stopDataForSEOCrawl() {
            clearInterval(dataForSeoPollingInterval);
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Technical Summary...';
            btn.disabled = true;

            document.getElementById("crawlerButton").style.backgroundColor = "green";
            updateCollapsibleState('crawlerButton', 'success');
            document.getElementById('downloadResultsBtn').style.display = 'block';

            // Trigger Final Audit Summary
            const gt_data = {
                "cumulative_layout_shift": document.getElementById('cls').textContent,
                "largest_contentful_paint": document.getElementById('lcp').textContent,
                "total_blocking_time": document.getElementById('tbt').textContent
            };
            const webpage_audit_data = {
                'google_safe_site': document.getElementById('malware').textContent,
                'sitemap': document.getElementById('sitemap').textContent,
                'robots_txt': document.getElementById('robots').innerHTML,
                'pagespeed': document.getElementById('pagespeed_audit').textContent
            };

            const maxPages = parseInt(document.getElementById('maxPagesInput')?.value || 10);
            fetch("https://ccgdpp7dna.execute-api.ap-southeast-1.amazonaws.com/techAuditSummary", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    crawl: { body: dataForSeoCrawlItems }, // Mock expected structure for backward compatibility
                    gtmetrix: gt_data,
                    webpage_audit: webpage_audit_data,
                    total_pages: dataForSeoCrawlItems.length || dataForSeoCrawlUrls.size || maxPages
                })
            })
                .then(response => response.json())
                .then(data => {
                    const parsed = parseLambdaResponse(data);
                    document.getElementById('auditSummary').innerHTML = parsed.body || data.body || (typeof data === 'string' ? data : "Summary generated.");
                })
                .catch(error => console.error('Error fetching Audit Summary:', error))
                .finally(() => {
                    btn.innerHTML = 'Analyse Website';
                    btn.disabled = false;
                });
        }


        function processURL() {
            queryUrl = window.location.href;
            if (queryUrl.includes('?keywordAnalysis')) {
                query_split = queryUrl.split("&");
                console.log(query_split);

                query_split.forEach(parameter => {
                    if (parameter.includes('location=')) {
                        document.getElementById('location').value = parameter.replace('location=', '').replaceAll("%20", " ");
                    } else if (parameter.includes('language=')) {
                        document.getElementById('language').value = parameter.replace('language=', '').replaceAll("%20", " ");
                    } else if (parameter.includes('target=')) {
                        document.getElementById('domain').value = parameter.replace('target=', '').replaceAll("%2F", "/").replace("%3A", ":");
                    } else if (parameter.includes('keywords=')) {
                        document.getElementById('keywords').value = parameter.replace('keywords=', '').replaceAll('%20', ' ').replaceAll('+', ', ').replaceAll("%27", "'").replace('#', '');
                    }
                });

                validateAndSubmit();

                alert("Keyword analysis started based on the input URL.")


                //changes url without going to the page
                // window.history.replaceState({path:"?keywordAnalysis2"},'pageTitle',"?keywordAnalysis2");
            }

        }

        async function contentComparisonAnalysis() {
            analyzeBtn = document.getElementById('contentComparisonAnalyzeBtn');
            // Show loading messages, hide previous results
            resultsDiv.innerHTML = '';
            analyzeBtn.innerHTML = 'Analysing...';

            keyword = document.getElementById('comparison-keyword').value;
            const urlsInput = document.getElementById('comparison-urls').value;
            const language = document.getElementById('comparison-language').value;
            const location = document.getElementById('comparison-location').value;
            user = JSON.parse(localStorage.getItem('googleUser')).email;
            urls = urlsInput.split(/[\s,]+/).filter(url => url.trim() !== "");

            // Get selected page types
            const pageTypes = Array.from(document.querySelectorAll('input[name="target-page-type"]:checked'))
                .map(checkbox => checkbox.value);

            console.log(pageTypes);

            try {
                let serpUrls = [];
                try {
                    if (keyword != "") {
                        // 1. Fetch URLs from SERP API
                        const serpResponse = await fetch('https://2wv8kyc8dg.execute-api.ap-southeast-1.amazonaws.com/moreSerps', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ keyword, language, location, user, page_types: pageTypes, limit: 10 }),
                        });
                        const serpData = await serpResponse.json();
                        console.log(serpData);
                        serpUrls = Object.values(serpData).map(result => result.url);

                        if (urls != "") {
                            serpUrls = [...new Set([...serpUrls, ...urls])]; // Combine and deduplicate
                        }

                    } else {
                        serpUrls = urls;
                    }
                } catch (error) {
                    serpUrls = urls;
                }

                serpUrls.push(document.getElementById('comparison-domain').value);

                console.log(serpUrls);

                // 2. Fetch content analysis for each URL *concurrently*
                const analysisPromises = serpUrls.map(url =>
                    fetch('https://u24f9208q0.execute-api.ap-southeast-1.amazonaws.com/gptTopicsPerUrl', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, keyword }),
                    })
                        .then(res => {
                            if (!res.ok) {  // Check for errors
                                console.warn(`Content analysis API error for ${url}: ${res.status} ${res.statusText}.  Skipping.`);
                                return null; // Signal that this URL failed
                            }
                            return res.json();
                        })
                        .catch(error => {
                            console.warn(`Content analysis API error for ${url}: ${error.message}.  Skipping.`);
                            return null; // Signal that this URL failed
                        })
                );

                // Wait for *all* content analysis calls to complete
                analysisDataArray = await Promise.all(analysisPromises);

                // Combine analysis data, handling potential errors from individual API calls
                analysisData = {};
                analysisDataArray.forEach(item => {
                    try {
                        url = Object.keys(item['body'])[0];
                        analysisData[url] = item['body'][url];
                    } catch (error) {

                    }
                }
                );

                // Check if analysisData is empty after combining results.
                if (Object.keys(analysisData).length === 0) {
                    throw new Error("Content analysis failed for all URLs. Please check the URLs and try again.");
                }

                // 3. Create and display the table (modified createAnalysisTable function below)
                comparisonTableHTML = createAnalysisTable(analysisData, keyword, urls);  // Pass keyword and target URLs
                document.getElementById('initial-table').innerHTML = `<div id="tableContainer">${comparisonTableHTML}</div>`;

                // 4. Apply gradients (no change needed)
                applyGradientsToRows();

                // 5. Submit table data to comparisonRecommender API
                const comparisonResponse = await fetch('https://33v5mhjt47.execute-api.ap-southeast-1.amazonaws.com/comparisonRecommender', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ output: analysisData, keyword, location, pageTypes, domain: document.getElementById('comparison-domain').value }), // Send analysisData directly
                });
                const comparisonData = await comparisonResponse.json();

                console.log(comparisonData);

                // Display recommendations and output table from comparison API
                const recommendation = comparisonData.body.recommendation;

                try {
                    //const outputTableHTML = createHTMLTableFromJSON(comparisonData.body.output); // Parse JSON string to object
                    const outputTableHTML = createAnalysisTable(comparisonData.body.output, keyword, urls)
                    document.getElementById('initial-table').innerHTML = "";
                    document.getElementById('initial-table').innerHTML = `<div id="tableContainer">${outputTableHTML}</div>`;
                    resultsDiv.innerHTML += `<pre>${recommendation}</pre>`;
                    console.log('refresh succesful');

                    // 4. Apply gradients (no change needed)
                    applyGradientsToRows();

                } catch (error) {
                    console.log(error)
                    resultsDiv.innerHTML += `<pre>${recommendation}</pre>`;
                }

                /*
                const promises = serpUrls.map(url => {
                    return fetch('https://de0bccf9w7.execute-api.ap-southeast-1.amazonaws.com/keywordDensity', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ target: url.trim() })
                    })
                        .then(response => response.json())
                        .catch(error => {
                            console.log(response.json());
                            console.error("Error fetching data for " + url.trim() + ":", error);
                            return { error: `Error fetching data for ${url.trim()}: ${error.message || error}` } // Handle errors gracefully
                        });
                });
        
                const responses = await Promise.all(promises);
        
                displayDensityResults(serpUrls, responses);
        
                */


                analyzeBtn.innerHTML = 'Analyse (up to 3 mins)';
                await contentComparisonToDatabase();

            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                try {
                } catch (error) {
                }
                analyzeBtn.innerHTML = 'Analyse (up to 3 mins)';
            }
        }

        function displayDensityResults(urls, responses) {
            const resultsDiv = document.getElementById("keyword-density");
            let tableHTML = '<table>';

            // Create table headers (URLs)
            tableHTML += '<tr><th onclick="sortDensityKeyword()">Keyword</th>';
            urls.forEach(url => {
                tableHTML += `<th onclick="sortDensityTable('${url}')">${url}</th>`;
            });
            tableHTML += '</tr>';

            // Extract all unique keywords
            let allKeywords = new Set();
            responses.forEach(response => {
                if (Array.isArray(response)) {  // Check if the response is an array
                    response.forEach(item => allKeywords.add(item.keyword));
                }
            });
            allKeywords = Array.from(allKeywords);

            // Populate table rows with keyword data
            allKeywords.forEach(keyword => {
                tableHTML += `<tr><td>${keyword}</td>`;
                urls.forEach((url, urlIndex) => {
                    let frequency = 0;
                    if (Array.isArray(responses[urlIndex])) { //check if the response is an array.
                        const keywordData = responses[urlIndex].find(item => item.keyword === keyword);
                        frequency = keywordData ? keywordData.frequency : 0;
                    } else if (typeof responses[urlIndex] === 'object' && responses[urlIndex] !== null && responses[urlIndex].error) { //check for error.
                        frequency = responses[urlIndex].error;
                    } else {
                        frequency = "N/A"; //Handle unexpected response
                    }

                    tableHTML += `<td>${frequency}</td>`;
                });
                tableHTML += '</tr>';
            });

            tableHTML += '</table>';
            resultsDiv.innerHTML = `<div class="table-container">${tableHTML}</div>`;
        }

        function sortDensityTable(url) {
            // Get the table element
            var table = document.querySelector("#results table");
            if (!table) {
                return; // Table doesn't exist
            }

            // Get the index of the URL column to be sorted by
            var headerRow = table.rows[0];
            var columnIndex = -1;
            for (var i = 1; i < headerRow.cells.length; i++) {
                if (headerRow.cells[i].textContent === url) {
                    columnIndex = i;
                    break;
                }
            }

            if (columnIndex === -1) {
                return; // URL not found
            }

            // Get the table rows (excluding the header row)
            var rows = Array.from(table.rows).slice(1); // Convert to array for easier sorting

            // Sort the rows based on the frequency in the specified column
            rows.sort(function (row1, row2) {
                var frequency1 = row1.cells[columnIndex].textContent;
                var frequency2 = row2.cells[columnIndex].textContent;

                //Handle error responses
                if (frequency1 === "N/A") {
                    return -1;
                }
                if (frequency2 === "N/A") {
                    return 1;
                }

                return frequency2 - frequency1;
            });

            // Re-append the sorted rows to the table
            rows.forEach(row => table.appendChild(row));
        }

        function sortDensityKeyword() {
            var table = document.querySelector("#results table");
            if (!table) {
                return;
            }

            var rows = Array.from(table.rows).slice(1);

            rows.sort(function (row1, row2) {
                var keyword1 = row1.cells[0].textContent.toLowerCase();
                var keyword2 = row2.cells[0].textContent.toLowerCase();

                if (keyword1 < keyword2) {
                    return -1;
                }
                if (keyword1 > keyword2) {
                    return 1;
                }
                return 0;
            });

            rows.forEach(row => table.appendChild(row));
        }

        // Function to create the HTML table from the analysis data
        function createAnalysisTable(data, keyword, targetUrls) {
            let tableHTML = '<table id="analysisTable">';
            tableHTML += '<tr><th>URL</th>';

            const urls = Object.keys(data);
            urls.forEach(url => {
                tableHTML += `<th ${targetUrls.includes(url) && keyword ? 'class="targetUrl"' : ''}>
                        <a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a></th>`;
            });
            tableHTML += '</tr>';


            // Add Word Count row
            tableHTML += '<tr><td>Word Count</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td data-value="${data[url].word_count}">${data[url].word_count}</td>`;
                } catch (error) {
                    tableHTML += `<td data-value="0">0</td>`;
                }
            });
            tableHTML += '</tr>';

            // Add Page Type row
            tableHTML += '<tr><td>Page Type</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td>${data[url].page_type}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            // Add headings rows
            tableHTML += '<tr><td>h1</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td>  ${data[url].h1.join('<br>  ')}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            tableHTML += '<tr><td>h2</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td>  ${data[url].h2.join('<br>  ')}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            tableHTML += '<tr><td>h3</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td>  ${data[url].h3.join('<br>  ')}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            // Get all unique topics, handling missing topics
            let allTopics = [];
            urls.forEach(url => {
                if (data[url] && data[url].topics) {
                    allTopics = [...allTopics, ...Object.keys(data[url].topics)];
                }
            });
            const uniqueTopics = [...new Set(allTopics)];

            // Add Topic rows (handling missing topic data)
            uniqueTopics.forEach(topic => {
                tableHTML += `<tr><td>${topic.replaceAll('_', ' ')}</td>`;
                urls.forEach(url => {
                    const value = (data[url] && data[url].topics && data[url].topics[topic]) ? data[url].topics[topic] : 0;
                    tableHTML += `<td data-value="${value}">${value}</td>`;
                });
                tableHTML += '</tr>';
            });

            tableHTML += '</table>';
            return tableHTML;
        }

        function applyGradientsToRows() {
            const table = document.getElementById('analysisTable');
            for (let i = 1; i < table.rows.length; i++) { // Start from row 1 to skip header
                applyGradientToRow(table.rows[i]);
            }
        }

        function applyGradientToRow(row) {
            const values = Array.from(row.cells)
                .slice(1) // Skip the first cell (topic name)
                .map(cell => {
                    const value = parseFloat(cell.dataset.value);
                    return isNaN(value) ? -1 : value; // Assign -1 for non-numeric values
                });

            const max = Math.max(...values);
            const min = Math.min(...values);

            values.forEach((value, index) => {
                const cell = row.cells[index + 1]; // +1 to account for the first cell
                if (!isNaN(value) && value !== -1) { // Apply gradient only to numeric values
                    const percent = (value - min) / (max - min);
                    const red = Math.round(255 * (1 - percent));
                    const green = Math.round(255 * percent);
                    cell.style.backgroundColor = `rgb(${red}, ${green}, 0)`;
                }
            });
        }



        // Function to generate content
        const form = document.getElementById('content-form');
        const generatedContentDiv = document.getElementById('generated-content');
        const generateButton = document.getElementById('generate-button');

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            // Disable the button and change text
            generateButton.disabled = true;
            generateButton.textContent = 'Generating Content...';
            document.getElementById("smm").style.backgroundColor = "#004c9d";
            updateCollapsibleState('smm', 'running');
            updateCollapsibleState('contentGeneratorButton', 'running');
            updateCollapsibleState('smmReplyButton', 'running');

            const formData = new FormData(form);

            // Helper: safe getter (returns "" if field missing)
            const getVal = (name, fallback = "") => (formData.get(name) ?? fallback).toString().trim();

            // NEW: capture optional new fields (if present in the form)
            // Ensure your HTML inputs use these exact "name" attributes:
            // name="sensitivity", name="response_objective", name="response_platform"
            const sensitivity = getVal('sensitivity', "");
            const response_objective = getVal('response_objective', "");
            const response_platform = getVal('response_platform', "");

            // Helper function to process URLs
            async function processUrls(urlsText, apiUrl) {
                if (!urlsText) return [];

                const urls = urlsText.split(/[, \n]+/).filter(url => url.trim() !== "");
                const promises = urls.map(async (url) => {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url: url.trim() })
                        });

                        if (!response.ok) {
                            console.error(`Error fetching data from ${url}: ${response.status} - ${response.statusText}`);
                            return null;
                        }
                        return await response.json();
                    } catch (error) {
                        console.error(`Error fetching data from ${url}:`, error);
                        return null;
                    }
                });

                return (await Promise.all(promises)).filter(data => data !== null);
            }

            try {
                // Process Brand Guide URLs
                const brandGuideUrlsText = getVal('generator_brand_guide_urls', "");
                const brandGuideData = await processUrls(
                    brandGuideUrlsText,
                    'https://i3oxhgicub.execute-api.ap-southeast-1.amazonaws.com/pdfParser'
                );

                // Process Reference URLs
                const referenceUrlsText = getVal('reference-url', "");
                const webpageData = await processUrls(
                    referenceUrlsText,
                    'https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing'
                );

                const contentData = {
                    reference_post: getVal('sample-text', ""),
                    content_type: getVal('content-type', "blog-post"),
                    post_info: getVal('post-info', ""),
                    subgroups: getVal('subgroups', ""),
                    painpoints: getVal('painpoints', ""),
                    audience_goal: getVal('audience_goal', ""),
                    product_service: getVal('product_service', ""),
                    desired_action: getVal('desired_action', ""),
                    post_objectives: getVal('post_objectives', ""),
                    word_count: getVal('word_count', ""),
                    tone: getVal('tone', ""),
                    usp: getVal('usp', ""),
                    pov: getVal('brand-pov', ""), // Match HTML name
                    emojis: getVal('emojis', "no"),
                    hashtags: getVal('hashtags', "no"),
                    language: getVal('language', "english"), // Match HTML name

                    // NEW: include new fields in payload (optional)
                    sensitivity: sensitivity,
                    response_objective: response_objective,
                    response_platform: response_platform,

                    brand_guide: brandGuideData,
                    webpage_data: webpageData
                };

                const response = await fetch('https://panc0eazwj.execute-api.ap-southeast-1.amazonaws.com/content-generator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(contentData)
                });

                const data = await response.json();

                // Display the API response or error
                const outputText = document.getElementById('content-output-text');
                if (response.ok) {
                    outputText.innerText = data;
                    generatedContentDiv.style.display = "block";
                    updateCollapsibleState('smm', 'success');
                    updateCollapsibleState('contentGeneratorButton', 'success');
                    updateCollapsibleState('smmReplyButton', 'success');
                } else {
                    outputText.innerHTML = `<p class="error">Error: ${data.error || response.statusText}</p>`;
                    generatedContentDiv.style.display = "block";
                    updateCollapsibleState('smm', 'error');
                    updateCollapsibleState('contentGeneratorButton', 'error');
                    updateCollapsibleState('smmReplyButton', 'error');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                generatedContentDiv.innerHTML = '<p class="error">An error occurred while fetching data.</p>';
                updateCollapsibleState('smm', 'error');
                updateCollapsibleState('contentGeneratorButton', 'error');
                updateCollapsibleState('smmReplyButton', 'error');
            } finally {
                // Re-enable the button and reset text
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Content';

                // NOTE: "#green" is invalid. Use "green" or a hex code.
                document.getElementById("smm").style.backgroundColor = "green";
            }
        });


        function removeFaqItem(button) {
            const item = button.parentNode;
            item.remove();
            updateSchema(); // Update the schema after removing an item
        }

        let breadcrumbItemCount = 2; // Start with 2 items
        function addItem() {
            breadcrumbItemCount++;
            const breadcrumbItemsDiv = document.getElementById('breadcrumb-items');
            const newItem = document.createElement('div');
            newItem.className = "breadcrumb-item";
            newItem.innerHTML = `
            <input type="text" id="name${breadcrumbItemCount}" placeholder="Page #${breadcrumbItemCount}'s name" oninput="updateSchema()">
            <input type="url" id="url${breadcrumbItemCount}" placeholder="URL #${breadcrumbItemCount}" oninput="updateSchema()">
            <button class="remove-item" onclick="removeItem(this)">x</button>
        `;
            breadcrumbItemsDiv.appendChild(newItem);

            // Attach event listeners to new elements
            newItem.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updateSchema);
            });

            updateSchema();
        }

        function removeItem(button) {
            const item = button.parentNode;
            item.remove();
            updateSchema();
        }

        const schemaTypeSelect = document.getElementById('schema-type');
        const inputFieldsDiv = document.getElementById('input-fields');
        const schemaOutputDiv = document.getElementById('schema-output');

        const templates = {
            "LocalBusiness": Handlebars.compile(document.getElementById('local-business-template').innerHTML),
            "Product": Handlebars.compile(document.getElementById('product-template').innerHTML),
            "Event": Handlebars.compile(document.getElementById('event-template').innerHTML),
            "Article": Handlebars.compile(document.getElementById('article-template').innerHTML),
            "BreadcrumbList": Handlebars.compile(document.getElementById('breadcrumblist-template').innerHTML),
            "FAQPage": Handlebars.compile(document.getElementById('faqpage-template').innerHTML),
            "HowTo": Handlebars.compile(document.getElementById('howto-template').innerHTML),
            "JobPosting": Handlebars.compile(document.getElementById('jobposting-template').innerHTML),
            "Organization": Handlebars.compile(document.getElementById('organization-template').innerHTML),
            "Person": Handlebars.compile(document.getElementById('person-template').innerHTML),
            "VideoObject": Handlebars.compile(document.getElementById('video-object-template').innerHTML),
            "Website": Handlebars.compile(document.getElementById('website-template').innerHTML),
            "Review": Handlebars.compile(document.getElementById('review-template').innerHTML),
            "SoftwareApplication": Handlebars.compile(document.getElementById('software-application-template').innerHTML),
            "Recipe": Handlebars.compile(document.getElementById('recipe-template').innerHTML),
            "Course": Handlebars.compile(document.getElementById('course-template').innerHTML),
            "Service": Handlebars.compile(document.getElementById('service-template').innerHTML),
        }

        let faqItemCount = 1;

        schemaTypeSelect.addEventListener('change', () => {
            const selectedType = schemaTypeSelect.value;
            const template = templates[selectedType];

            if (template) {
                inputFieldsDiv.innerHTML = template();
                updateSchema(); // Initial update after template render
            } else {
                inputFieldsDiv.innerHTML = ''; // Clear if no template exists
                schemaOutputDiv.textContent = '';
            }


            // Add event listeners after rendering the template
            inputFieldsDiv.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updateSchema);
            });
        });

        // Initial setup (trigger the change event once to populate fields for default type)
        schemaTypeSelect.dispatchEvent(new Event('change'));

        function updateSchema() {
            const selectedType = schemaTypeSelect.value;
            const data = {};

            // Gather all input values
            const inputs = inputFieldsDiv.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    data[input.id] = input.checked;
                } else {
                    data[input.id] = input.value;
                }
            });

            try {
                let schema = {
                    "@context": "https://schema.org",
                    "@type": selectedType
                };

                // Helper to set nested values
                const setNestedValue = (obj, path, value) => {
                    const keys = path.split('_');
                    let current = obj;
                    for (let i = 0; i < keys.length - 1; i++) {
                        if (!current[keys[i]]) current[keys[i]] = {};
                        current = current[keys[i]];
                    }
                    current[keys[keys.length - 1]] = value;
                };

                // Process all data fields
                Object.keys(data).forEach(id => {
                    const val = data[id];
                    if (!val || val === "") return;

                    // Skip numeric/date IDs that are handled specifically in lists
                    if (/^(name|url|question|answer)\d+$/.test(id)) return;

                    if (id.includes('_')) {
                        setNestedValue(schema, id, val);
                    } else if (id === "sameAs" || id === "recipeInstructions" || (selectedType === "HowToSource" && (id === "supply" || id === "step"))) {
                        // Special handling for potential arrays/serialised JSON
                        if (id === "sameAs") {
                            const urls = val.split('\n').map(u => u.trim()).filter(u => u !== "");
                            schema[id] = urls.length === 1 ? urls[0] : urls;
                        } else if (id === "recipeInstructions") {
                            try {
                                schema[id] = JSON.parse(val);
                            } catch (e) {
                                schema[id] = val; // fallback to string
                            }
                        } else {
                            schema[id] = val;
                        }
                    } else {
                        schema[id] = val;
                    }
                });

                // Post-process specific types with list items
                if (selectedType === "BreadcrumbList") {
                    const itemListElement = [];
                    for (let i = 1; i <= breadcrumbItemCount; i++) {
                        const name = document.getElementById(`name${i}`);
                        const url = document.getElementById(`url${i}`);
                        if (name && url && name.value && url.value) {
                            itemListElement.push({
                                "@type": "ListItem",
                                "position": i,
                                "name": name.value,
                                "item": url.value
                            });
                        }
                    }
                    if (itemListElement.length > 0) schema.itemListElement = itemListElement;
                }

                if (selectedType === "FAQPage") {
                    const mainEntity = [];
                    for (let i = 1; document.getElementById(`question${i}`); i++) {
                        const q = document.getElementById(`question${i}`).value;
                        const a = document.getElementById(`answer${i}`).value;
                        if (q && a) {
                            mainEntity.push({
                                "@type": "Question",
                                "name": q,
                                "acceptedAnswer": {
                                    "@type": "Answer",
                                    "text": a
                                }
                            });
                        }
                    }
                    if (mainEntity.length > 0) schema.mainEntity = mainEntity;
                }

                // Final cleanup for nested objects that might be empty or need @type
                if (schema.offers && !schema.offers["@type"]) {
                    schema.offers["@type"] = "Offer";
                }
                if (schema.reviewRating && !schema.reviewRating["@type"]) {
                    schema.reviewRating["@type"] = "Rating";
                }
                if (schema.aggregateRating && !schema.aggregateRating["@type"]) {
                    schema.aggregateRating["@type"] = "AggregateRating";
                }
                if (schema.publisher && !schema.publisher["@type"]) {
                    schema.publisher["@type"] = "Organization";
                    if (schema.publisher.logo) {
                        schema.publisher.logo = {
                            "@type": "ImageObject",
                            "url": schema.publisher.logo
                        };
                    }
                }
                if (schema.contactPoint && !schema.contactPoint["@type"]) {
                    schema.contactPoint["@type"] = "ContactPoint";
                }
                if (schema.provider && !schema.provider["@type"]) {
                    schema.provider["@type"] = "Organization";
                }
                if (schema.itemReviewed && !schema.itemReviewed["@type"]) {
                    schema.itemReviewed["@type"] = "Thing"; // Generic fallback
                }

                schemaOutputDiv.textContent = '<script type="application/ld+json">\n' + JSON.stringify(schema, null, 2) + '\n<\/script>';

            } catch (error) {
                schemaOutputDiv.textContent = "Error generating schema. Check console.";
                console.error("Schema Generation Error:", error);
            }
        }

        function similarKeywords() {
            const keywordsInput = document.getElementById('keywords').value.split(/[\n,]+/).map(k => k.trim());
            const location = document.getElementById('location').value;
            const language = document.getElementById('language').value;

            if (keywordsInput[0] == "") {
                alert('Please enter keyword(s).');
                return;
            }
            if (!location) {
                alert('Please select a location.');
                return;
            }

            document.getElementById("keyword_suggestions").style.backgroundColor = "#004c9d";
            document.getElementById("expandSimilarKeywords").style.backgroundColor = "#004c9d";
            document.getElementById('keyword_suggestions').innerText = "Generating Similar Keywords..";
            updateCollapsibleState('keyword_suggestions', 'running');

            var url = "https://lgvdhcs4t2.execute-api.ap-southeast-1.amazonaws.com/similarKeywords";
            var queryString = {
                "keywords": keywordsInput,
                "location": location,
                "language": language,
                "user": JSON.parse(localStorage.getItem('googleUser')).email
            };

            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json",
            };
            fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(queryString)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                    updateCollapsibleState('keyword_suggestions', 'success');
                    document.getElementById('rankingError').innerText = "";
                    displaySimilarKeywords(data);
                    document.getElementById("keyword_suggestions").style.backgroundColor = "green";
                    document.getElementById("expandSimilarKeywords").style.backgroundColor = "green";
                    const keywordSuggestions = document.getElementById("keywordSuggestions");

                    const icon = document.getElementById("expandSimilarKeywords").querySelector('i');

                    if (keywordSuggestions.style.display === "block") {
                        document.getElementById('keyword_suggestions').innerText = "Keyword Suggestions (Similar Keywords / SERPs)";
                    }
                    else {
                        keywordSuggestions.style.display = "block";
                        icon.classList.remove('fa-plus-square');
                        icon.classList.add('fa-minus-square');
                        document.getElementById('keyword_suggestions').innerText = "Keyword Suggestions (Similar Keywords / SERPs)";
                    }
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                    updateCollapsibleState('keyword_suggestions', 'error');
                    document.getElementById("keyword_suggestions").style.backgroundColor = "#004c9d";
                    document.getElementById('keyword_suggestions').innerText = "Keyword Suggestions (Similar Keywords / SERPs)";
                });
            const tooltip = event.target.querySelector('span');  // Get the tooltip span
            if (tooltip) { // Check if the span element exists
                // The tooltip will now position itself correctly due to the CSS changes
            }
        }

        function rankingKeywords() {
            var domain = document.getElementById('domain').value.replace('www.', '').replace('htttps://', '').replace('http://', '');
            var location = document.getElementById('location').value;

            document.getElementById('rankingError').textContent = '';
            document.getElementById("ranking_keywords").style.backgroundColor = "#004c9d";
            document.getElementById("expandRankingKeywords").style.backgroundColor = "#004c9d";

            if (!domain) {
                alert('Please enter a URL or domain.');
                return;
            }
            if (!location) {
                alert('Please select a location.');
                return;
            }

            document.getElementById('ranking_keywords').innerText = "Getting Ranked Keywords..";
            updateCollapsibleState('ranking_keywords', 'running');

            var url = "https://0dqny7l5y9.execute-api.ap-southeast-1.amazonaws.com/rankingKeywords";

            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json",
            };

            var queryString = {
                "target": domain,
                "location": location,
                "user": JSON.parse(localStorage.getItem('googleUser')).email
            };

            fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(queryString)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    updateCollapsibleState('ranking_keywords', 'success');
                    displayRankedKeywords(data.body);
                    document.getElementById('ranking_keywords').innerText = "Ranking Keywords";
                    document.getElementById("ranking_keywords").style.backgroundColor = "green";
                    document.getElementById("expandRankingKeywords").style.backgroundColor = "green";
                    const rankingKeywordsDiv = document.getElementById("rankingKeywords");
                    const icon = document.getElementById("expandRankingKeywords").querySelector('i');

                    if (rankingKeywordsDiv.style.display === "block") {
                        console.log('Ranking Keywords already displayed');

                    } else {
                        console.log('ranking keywords not displayed');
                        rankingKeywordsDiv.style.display = "block"; // Show the element
                        icon.classList.remove('fa-plus-square');
                        icon.classList.add('fa-minus-square');
                    }
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                    updateCollapsibleState('ranking_keywords', 'error');
                    document.getElementById('ranking_keywords').innerText = "Ranking Keywords";  // Consistent use of innerText
                    document.getElementById("ranking_keywords").style.backgroundColor = "#004c9d";
                });
            const tooltip = event.target.querySelector('span');  // Get the tooltip span
            if (tooltip) { // Check if the span element exists
                // The tooltip will now position itself correctly due to the CSS changes
            }
        }

        const modalCache = {};

        function showSerps(keyword) {
            serpSection = document.getElementById("serp-section");
            serpSection.innerHTML = '<div><h2 id="modalKeyword"></h2><b>Search Volume: ' + keywordsCache[keyword]['search_vol'] + '  |  Difficulty: ' + keywordsCache[keyword]['competition'] + '</b><div id="modalContent"></div></div>';
            document.getElementById("modalKeyword").textContent = keyword;

            document.getElementById("modalContent").innerHTML = "<p>Loading SERPs for " + keyword + "...</p>"; // Placeholder

            if (modalCache[keyword]) {
                document.getElementById("modalContent").innerHTML = modalCache[keyword];
                return; // Exit early if data is in cache
            }

            serpModal(keyword).then(data => {
                if (data.error) {
                    document.getElementById("modalContent").innerHTML = "<p class='error'>Error: " + data.error + "</p>";
                    return;
                }

                modalCache[keyword] = document.getElementById("modalContent").innerHTML;

                const urls = Object.values(data.body).map(result => result.url);
                const metricsPromises = urls.map(url => fetchMetrics(url));

                Promise.all(metricsPromises)
                    .then(metricsResults => {
                        addMetricsToTable(data, metricsResults);

                        // Cache the final table HTML
                        modalCache[keyword] = document.getElementById("modalContent").innerHTML;
                    })
                    .catch(error => {
                        console.error("Error fetching metrics:", error);
                        document.getElementById("modalContent").innerHTML += "<p class='error'>Error fetching some metrics.</p>";
                    });

            });

        }

        async function serpModal(keyword) {
            const language = document.getElementById('language').value;
            const location = document.getElementById('location').value;
            user = JSON.parse(localStorage.getItem('googleUser')).email;
            try {
                const response = await fetch('https://8k6r15rg4m.execute-api.ap-southeast-1.amazonaws.com/serpLite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword, language, location, user }),
                });
                const serpData = await response.json();

                // Check for errors in SERP data
                if (serpData.error || serpData.statusCode !== 200) {
                    throw new Error("SERP API Error: " + (serpData.error || "Status code " + serpData.statusCode));
                }

                displayInitialTable(serpData);

                return serpData;


            } catch (error) {
                console.error("Error fetching data:", error);
                return { error: error.message }; // Return error message
            }
        }

        // Function to close the modal
        function closeModal() {
            const modal = document.getElementById("keywordModal");
            if (modal) {
                modal.style.display = "none";
            }
        }

        async function fetchMetrics(domain) { // for moz
            try {
                const response = await fetch('https://a7hptjtc8e.execute-api.ap-southeast-1.amazonaws.com/new', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain })
                });

                if (!response.ok) {
                    throw new Error(`Metrics API Error: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();

                console.log(data);

                return { "DA": data.domain_authority };

                return data.body; // Return the body directly
            } catch (error) {
                console.error("Error fetching metrics:", error);
                return { error: error.message }; // Return error object, better for handling
            }
        }

        function displayInitialTable(data) {
            let tableHtml = '<div class="table-container"><table><tr><th>Rank</th><th>URL</th><th>Title</th><th>Description</th></tr>';
            for (const rank in data.body) {
                const result = data.body[rank];
                tableHtml += `<tr><td>${rank}</td><td><a href="${result.url}" target="_blank">${result.url.replace('https://', '').replace('http://', '').replace('www.', '')}</a></td><td>${result.title}</td><td>${result.description}</td></tr>`;
            }
            tableHtml += "</table></div>";
            document.getElementById("modalContent").innerHTML = tableHtml;
        }

        function addMetricsToTable(data, metricsResults) {
            const table = document.getElementById("modalContent").querySelector("table");

            // Add header cells for metrics
            const headerRow = table.rows[0];
            const firstResultMetrics = metricsResults[0] || {}; //Handle missing metrics
            if (!firstResultMetrics.error) {
                for (const metricKey in firstResultMetrics) {
                    if (metricKey !== 'visible_text' && metricKey !== 'word_count' && metricKey !== 'title' && metricKey !== 'description' && metricKey !== 'click_depth') {
                        const th = document.createElement("th");
                        th.textContent = metricKey.replace(/_/g, ' ').toUpperCase();
                        headerRow.appendChild(th);
                    }
                }
            }

            // Add metric data to rows
            for (let i = 0; i < metricsResults.length; i++) {
                const row = table.rows[i + 1]; // Skip header row
                const metrics = metricsResults[i] || {};
                if (!metrics.error) {
                    for (const metricKey in firstResultMetrics) {   //Use firstResultMetrics for keys order
                        if (metricKey !== 'visible_text' && metricKey !== 'word_count' && metricKey !== 'title' && metricKey !== 'description' && metricKey !== 'click_depth') {

                            if (metrics.hasOwnProperty(metricKey)) {
                                const cell = row.insertCell();
                                cell.textContent = metrics[metricKey];
                            } else {
                                row.insertCell(); // Add an empty cell if the metric is missing
                            }

                        }
                    }
                } else {
                    // Add empty cells for all metrics if there is an error
                    for (const metricKey in firstResultMetrics) {
                        if (metricKey !== 'visible_text' && metricKey !== 'word_count' && metricKey !== 'title' && metricKey !== 'description' && metricKey !== 'click_depth') {
                            row.insertCell();
                        }
                    }
                }
            }
        }

        function displayRankedKeywords(rankedKeywordsData) {
            const rankedKeywordList = document.getElementById('rankedKeywordList');
            rankedKeywordList.innerHTML = ''; // Clear previous keywords

            // 1. Transform the data:
            const rankedKeywordsArray = Object.entries(rankedKeywordsData).map(([keyword, data]) => ({
                keyword: keyword,
                search_volume: data.search_volume,
                rank: data.rank,
                difficulty: data.difficulty
            }));

            rankedKeywordsArray.forEach((keywordObj, index) => {
                const row = document.createElement('tr');

                // Keyword column
                const keywordCell = document.createElement('td');
                keywordCell.textContent = keywordObj.keyword;
                row.appendChild(keywordCell);

                // Search Volume column
                const searchVolumeCell = document.createElement('td');
                searchVolumeCell.textContent = keywordObj.search_volume != null ? keywordObj.search_volume.toLocaleString() : '-';
                row.appendChild(searchVolumeCell);

                // Rank
                const rankCell = document.createElement('td');
                rankCell.textContent = keywordObj.rank || '-';
                row.appendChild(rankCell);

                // Difficulty column
                const difficultyCell = document.createElement('td');
                difficultyCell.textContent = keywordObj.difficulty || '-';
                row.appendChild(difficultyCell);

                // Checkbox column
                const checkboxCell = document.createElement('td');
                checkboxCell.style.textAlign = 'center';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = keywordObj.keyword;
                checkbox.checked = false;
                checkbox.addEventListener('change', updateKeywordsField);
                checkboxCell.appendChild(checkbox);
                row.appendChild(checkboxCell);

                rankedKeywordList.appendChild(row);
            });
            updateRankedKeywordsCount();
            document.getElementById('rankingKeywordsExport').style.display = 'block';

            // Add "Get More" button after the table
            const container = document.getElementById('rankingKeywords');
            let moreBtn = document.getElementById('get-more-keywords-button');
            if (moreBtn) moreBtn.remove();

            moreBtn = document.createElement('button');
            moreBtn.type = 'button';
            moreBtn.id = 'get-more-keywords-button';
            moreBtn.textContent = 'Get More Keywords';
            moreBtn.onclick = getMoreRanked;
            container.appendChild(moreBtn);
        }

        document.getElementById('rankedKeywordList').addEventListener('change', function (event) {
            if (event.target.type === 'checkbox') { // Only handle checkbox changes
                updateKeywordsField();
            }
        });


        const keywordTable = document.getElementById('keywordTable');
        const top100Table = document.getElementById('top100Table');

        async function getMoreRanked() {
            document.getElementById('rankedKeywordList').innerHTML = document.getElementById('rankedKeywordList').innerHTML.replace('<button type="button" id="get-more-keywords-button" onclick="getMoreRanked()">Get More Keywords</button>', '<button type="button" disabled id="get-more-keywords-button" onclick="getMoreRanked()">Getting Keywords</button>')
            const target = document.getElementById('domain').value;
            const language = document.getElementById('language').value;
            const location = document.getElementById('location').value;

            const apiUrl = 'https://ei6xj9x2rd.execute-api.ap-southeast-1.amazonaws.com/keywordsForSite';
            const requestBody = {
                location: location,
                language: language,
                target: target
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Clear existing table rows (except header)
                while (keywordTable.rows.length > 1) {
                    keywordTable.deleteRow(1);
                }

                // Clear top100Table rows (except header) before new data is added
                while (top100Table.rows.length > 1) {
                    top100Table.deleteRow(1);
                }

                document.getElementById("get-more-keywords-button").remove();

                const rankCheckerPromises = []; // Store promises for rank checking API calls

                for (const keyword in data) {
                    const row = keywordTable.insertRow();
                    const keywordCell = row.insertCell();
                    const volumeCell = row.insertCell();
                    const competitionCell = row.insertCell();
                    const rankCell = row.insertCell(); // New cell for rank

                    keywordCell.innerHTML = keyword;
                    volumeCell.innerHTML = data[keyword].search_volume;
                    competitionCell.innerHTML = data[keyword].competition || "N/A"; // Handle null competition

                    // Make rank checker API call and update rankCell when resolved
                    const rankCheckerApiUrl = 'https://v5bizygr4m.execute-api.ap-southeast-1.amazonaws.com/rankChecker';
                    const rankRequestBody = {
                        keyword: keyword,
                        language: language,
                        location: location,
                        target: target
                    };

                    const rankPromise = fetch(rankCheckerApiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(rankRequestBody)
                    }).then(res => {
                        if (!res.ok) {
                            throw new Error(`Rank checker HTTP error! status: ${res.status}`);
                        }
                        return res.json();
                    }).then(rankData => {

                        rankCell.innerHTML = rankData || 999; // Handle cases where rank is unavailable

                        const rank = parseInt(rankData); // Parse rankData to integer
                        if (rank >= 1 && rank <= 100) {
                            const top100Row = top100Table.insertRow();
                            const top100KeywordCell = top100Row.insertCell();
                            const top100VolumeCell = top100Row.insertCell();
                            const top100CompetitionCell = top100Row.insertCell();
                            const top100RankCell = top100Row.insertCell();

                            top100KeywordCell.innerHTML = keyword;
                            top100VolumeCell.innerHTML = data[keyword].search_volume;
                            top100CompetitionCell.innerHTML = data[keyword].competition || "N/A";
                            top100RankCell.innerHTML = rank;

                            const rankedKeywordList = document.getElementById('rankedKeywordList');
                            const headerCells = Array.from(document.querySelectorAll('#rankedKeywordHeaderRow .keyword-column'));
                            const currentKeywordCount = rankedKeywordList.querySelectorAll('li.keyword-row').length; //Correct length

                            // Append to rankedKeywordList (using a separate function for clarity)
                            appendRankedKeyword({ // Pass data as an object
                                keyword: keyword,
                                search_volume: data[keyword].search_volume,
                                rank: rank, // Use the parsed rank value
                                difficulty: data[keyword].competition || "N/A"
                            }, rankedKeywordList.children.length, headerCells, rankedKeywordList); // Use children.length to get correct index
                        }
                    }).catch(error => {
                        console.error('Error checking rank:', error);
                        rankCell.innerHTML = "Error"; // Indicate an error in the rank cell
                    });
                    rankCheckerPromises.push(rankPromise);
                }
                // Wait for all rank checking API calls to complete
                await Promise.all(rankCheckerPromises);


            } catch (error) {
                console.error('Error fetching keyword data:', error);
                // Display error message in the table or elsewhere on the page
                keywordTable.innerHTML = "<tr><td>Error fetching data.</td></tr>";

            }

        }

        function appendRankedKeyword(item, index, headerCells, rankedKeywordList) {
            const row = document.createElement('tr');

            // Column 0: Keyword
            const keywordCell = document.createElement('td');
            keywordCell.textContent = item.keyword;
            row.appendChild(keywordCell);

            // Column 1: Search Volume
            const searchVolumeCell = document.createElement('td');
            searchVolumeCell.textContent = item.search_volume || '-';
            row.appendChild(searchVolumeCell);

            // Column 2: Rank
            const rankCell = document.createElement('td');
            rankCell.textContent = item.rank || '-';
            row.appendChild(rankCell);

            // Column 3: Difficulty
            const difficultyCell = document.createElement('td');
            difficultyCell.textContent = item.difficulty || '-';
            row.appendChild(difficultyCell);

            // Column 4: Checkbox
            const checkboxCell = document.createElement('td');
            checkboxCell.style.textAlign = 'center';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = item.keyword;
            checkbox.addEventListener('change', updateKeywordsField);
            checkboxCell.appendChild(checkbox);
            row.appendChild(checkboxCell);

            rankedKeywordList.appendChild(row);
            updateRankedKeywordsCount();

            const getMoreBtn = document.getElementById('get-more-keywords-button');
            if (getMoreBtn) {
                getMoreBtn.disabled = false;
                getMoreBtn.textContent = 'Get More Keywords';
            }
        }

        keywordsCache = {};

        function displaySimilarKeywords(keywordsData) {
            const keywordList = document.getElementById('keywordList');
            keywordList.innerHTML = ''; // Clear previous keywords

            // 1. Transform the data:
            const keywordsArray = Object.entries(keywordsData.body).map(([keyword, data]) => ({
                keyword,
                search_volume: data.search_volume,
                competition: data.competition,
                cpc: data.cpc
            }));

            keywordsArray.forEach((keywordObj, index) => {
                const row = document.createElement('tr');

                // Keyword column
                const keywordCell = document.createElement('td');
                keywordCell.textContent = keywordObj.keyword;
                keywordCell.style.cursor = 'pointer';
                keywordCell.addEventListener('click', () => showSerps(keywordObj.keyword));
                row.appendChild(keywordCell);

                // Search Volume column
                const searchVolumeCell = document.createElement('td');
                searchVolumeCell.textContent = keywordObj.search_volume != null ? keywordObj.search_volume.toLocaleString() : '-';
                row.appendChild(searchVolumeCell);

                // Difficulty column
                const difficultyCell = document.createElement('td');
                difficultyCell.textContent = keywordObj.competition || '-';
                row.appendChild(difficultyCell);

                // CPC column
                const cpcCell = document.createElement('td');
                // Round CPC to 2 decimal places if it's a number
                const cpcValue = parseFloat(keywordObj.cpc);
                cpcCell.textContent = !isNaN(cpcValue) ? cpcValue.toFixed(2) : (keywordObj.cpc || '-');
                row.appendChild(cpcCell);

                // Checkbox column
                const checkboxCell = document.createElement('td');
                checkboxCell.style.textAlign = 'center';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = keywordObj.keyword;
                checkbox.checked = false;
                checkbox.addEventListener('change', updateKeywordsField);
                checkboxCell.appendChild(checkbox);
                row.appendChild(checkboxCell);

                keywordList.appendChild(row);

                keywordsCache[keywordObj.keyword] = {};
                keywordsCache[keywordObj.keyword]['search_vol'] = keywordObj.search_volume != null ? keywordObj.search_volume.toLocaleString() : '-';
                keywordsCache[keywordObj.keyword]['competition'] = keywordObj.competition;
                // Cache the rounded CPC as well for consistency if needed elsewhere
                keywordsCache[keywordObj.keyword]['cpc'] = !isNaN(cpcValue) ? cpcValue.toFixed(2) : (keywordObj.cpc || '-');
            });
            document.getElementById('keywordSuggestionsExport').style.display = 'block';
        }

        function updateRankedKeywordsCount() {
            const rankedKeywordList = document.getElementById('rankedKeywordList');
            const count = rankedKeywordList.querySelectorAll('tr').length; // Count table rows instead of li
            const heading = document.getElementById('rankedKeywordsCount');
            heading.textContent = `Ranked Keywords (${count}):`; // Update the heading text
        }

        function updateKeywordCount() {
            const keywordsTextArea = document.getElementById('keywords');
            const keywords = keywordsTextArea.value.split(/[\n,]+/).map(k => k.trim()).filter(Boolean); // Split by comma or newline, trim whitespace, remove empty strings
            const keywordCountSpan = document.getElementById('keywordCount');
            keywordCountSpan.textContent = `${keywords.length} keyword(s) selected`;
        }

        function updateKeywordsField() {
            const keywordsTextArea = document.getElementById('keywords');
            const checkedKeywords = new Set(); // Use a Set to store unique values

            // Get checked keywords from both tables
            try {
                const rankedKeywordsCheckboxes = document.querySelectorAll('#rankedKeywordList input[type="checkbox"]:checked');
                rankedKeywordsCheckboxes.forEach(checkbox => checkedKeywords.add(checkbox.value));
            } catch (error) {
                console.log(error);
            }

            try {
                const similarKeywordsCheckboxes = document.querySelectorAll('#keywordList input[type="checkbox"]:checked');
                similarKeywordsCheckboxes.forEach(checkbox => checkedKeywords.add(checkbox.value));
            } catch (error) {
                console.log(error);
            }

            try {
                const webpageKeywordsCheckboxes = document.querySelectorAll('#siteKeywords input[type="checkbox"]:checked');
                webpageKeywordsCheckboxes.forEach(checkbox => checkedKeywords.add(checkbox.value));
            } catch (error) {
                console.log(error);
            }

            keywordsTextArea.value = Array.from(checkedKeywords).join(', '); // Convert Set back to array before joining
            updateKeywordCount();
        }

        function updateCompetitorDomainsField() {
            const domainsTextArea = document.getElementById('competitor_domains');
            const checkedDomains = new Set(); // Use a Set to store unique values

            // Get checked keywords from both tables
            try {
                const domainsCheckboxes = document.querySelectorAll('#competitorsOutput input[type="checkbox"]:checked');
                domainsCheckboxes.forEach(checkbox => checkedDomains.add(checkbox.value));
            } catch (error) {
                console.log(error);
            }

            domainsTextArea.value = Array.from(checkedDomains).join(', '); // Convert Set back to array before joining
        }

        async function validateAndSubmit() {
            const domain = document.getElementById('domain').value;
            const keywordsInput = document.getElementById('keywords').value;
            const location = document.getElementById('location').value;
            const language = document.getElementById('language').value;

            new_url = "?keywordAnalysis&location=" + location.replaceAll(" ", "%20") + "&language=" + language.replaceAll(" ", "%20") + "&target=" + domain.replace(":", "%3A").replaceAll("/", "%2F") + "&keywords=" + keywordsInput.split(/[\n,]+/).map(k => k.trim()).filter(Boolean).join("+").replaceAll(" ", "%20").replaceAll("'", "%27")

            window.history.replaceState({ path: new_url }, '', new_url);

            document.getElementById('domainError').textContent = '';
            document.getElementById('keywordsError').textContent = '';

            if (!keywordsInput) {
                document.getElementById('keywordsError').textContent = 'Please enter one or more keywords.';
                return;
            }
            if (!location) {
                alert("Please select a location.");
                return;
            }

            const keywords = keywordsInput.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);

            document.getElementById('targetTitle').innerText = "";
            document.getElementById('targetDescription').innerText = "";
            //document.getElementById('targetDomainRank').innerText = "";
            document.getElementById('targetBacklinks').innerText = "";
            document.getElementById('targetSpamScore').innerText = "";
            document.getElementById('targetRefDomains').innerText = "";
            document.getElementById('targetInternalLinks').innerText = "";
            document.getElementById('targetExternalLinks').innerText = "";
            document.getElementById('targetH1').innerText = "";
            document.getElementById('targetImages').innerText = "";
            document.getElementById('targetCls').innerText = "";
            document.getElementById('targetLcp').innerText = "";
            document.getElementById('targetFid').innerText = "";
            document.getElementById('targetSchema').innerText = "";
            document.getElementById('targetReadability').innerText = "";
            document.getElementById('targetWordCount').innerText = "";
            document.getElementById('da').innerText = "";
            document.getElementById('pa').innerText = "";

            document.getElementById("meta_data").style.backgroundColor = "#004c9d";
            document.getElementById("domain_metrics").style.backgroundColor = "#004c9d";
            document.getElementById("keywordAnalysisBtn").style.backgroundColor = "#004c9d";

            if (!domain) { // if no target URL / domain
            } else {
                fetchDomainMetrics(domain);
            }

            await fetchKeywordMetrics(keywords, location, language);

            // **AWAIT ALL `keywordAnalysis` CALLS**
            await Promise.all(keywords.map(async keyword => {
                try {
                    await keywordAnalysis(keyword, language, location, domain);
                } catch (error) {
                    console.error(`Error during analysis for keyword ${keyword}:`, error);
                    // Display error in the keyword's collapsible section
                    const keywordContainer = document.getElementById(`keyword-container-${keyword.replace(/\s+/g, '-')}`);
                    if (keywordContainer) {
                        keywordContainer.innerHTML += `<p class="error">Error during analysis: ${error.message}</p>`;
                    }
                }
            }));

            // **NOW, displayOverallSummaryTable AFTER `keywordAnalysis` IS DONE for all keywords**
            await displayOverallSummaryTable(keywords, location, language, domain);
            await timeToRankToDatabase();
        }

        function displayTargetContentTable(targetContent, containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Element with ID '${containerId}' not found.`);
                return;
            }

            let tableHTML = `
        <h2>Possible URLs for KW Mapping</h2>
        <div class="table-container">
          <table class="wide-table">
            <thead>
              <tr>
                <th>Rank</th>
                <th>URL</th>
                <th>Title</th>
                <th>Description</th>
                <th>Domain Rank</th>
                <th>Backlinks</th>
                <th>Referring Domains</th>
                <th>Internal Links Count</th>
                <th>External Links Count</th>
                <th>Image Count</th>
                <th>CLS</th>
                <th>LCP</th>
                <th>FID</th>
                <th>Schema</th>
                <th>Readability</th>
                <th>Word Count</th>
                <th>Keyword in URL</th>
                <th>Keyword in Title</th>
                <th>Keyword in Description</th>
                <th>Keyword in H1</th>
                <th>Keyword in H2</th>
                <th>Keyword in Alt</th>
                <th>Keyword in Text</th>
              </tr>
            </thead>
            <tbody>
      `;

            targetContent.forEach(item => {
                tableHTML += `
            <tr>
              <td>${item.rank || 'N/A'}</td>
              <td><a href="${item.url}" target="_blank">${item.url}</a></td>
              <td>${item.title || 'N/A'}</td>
              <td>${item.description || 'N/A'}</td>
              <td>${item.domain_rank || 'N/A'}</td>
              <td>${item.backlinks || 'N/A'}</td>
              <td>${item.referring_domains || 'N/A'}</td>
              <td>${item.internal_links_count || 'N/A'}</td>
              <td>${item.external_links_count || 'N/A'}</td>
              <td>${item.image || 'N/A'}</td>
              <td>${item.cls || 'N/A'}</td>
              <td>${item.lcp || 'N/A'}</td>
              <td>${item.fid || 'N/A'}</td>
              <td>${item.schema || 'N/A'}</td>
              <td>${item.readability || 'N/A'}</td>
              <td>${item.word_count || 'N/A'}</td>
              <td>${item.eval?.kw_in_url || 'N/A'}</td>
              <td>${item.eval?.kw_in_title || 'N/A'}</td>
              <td>${item.eval?.kw_in_desc || 'N/A'}</td>
              <td>${item.eval?.kw_in_h1 || 'N/A'}</td>
              <td>${item.eval?.kw_in_h2 || 'N/A'}</td>
              <td>${item.eval?.kw_in_alt || 'N/A'}</td>
              <td>${item.eval?.kw_in_text || 'N/A'}</td>
            </tr>
          `;
            });

            tableHTML += `
            </tbody>
          </table>
        </div>
      `;

            container.innerHTML = tableHTML;
        }

        async function displaySerpResults(serpResults, containerId) {
            const resultsContainer = document.getElementById(containerId);
            if (!resultsContainer) {
                console.error(`Element with ID '${containerId}' not found.`);
                return;
            }

            let tableHTML = `
        <h2>SERP Results</h2>
        <div class="table-container">
          <table class="wide-table">
            <thead>
              <tr>
                <th>Rank</th>
                <th>URL</th>
                <th>Title</th>
                <th>Description</th>
                <th>DA</th>
                <th>Domain Rank</th>
                <th>Backlinks</th>
                <th>Backlinks Spam Score</th>
                <th>Referring Domains</th>
                <th>Internal Links Count</th>
                <th>External Links Count</th>
                <th>Image Count</th>
                <th>CLS</th>
                <th>LCP</th>
                <th>FID</th>
                <th>Schema</th>
                <th>Readability</th>
                <th>Word Count</th>
                <th>Keyword in URL</th>
                <th>Keyword in Title</th>
                <th>Keyword in Description</th>
                <th>Keyword in H1</th>
                <th>Keyword in H2</th>
                <th>Keyword in Alt</th>
                <th>Keyword in Text</th>
              </tr>
            </thead>
            <tbody>
      `;

            serpResults.forEach(result => {
                console.log(result);
                tableHTML += `
            <tr>
              <td>${result.rank}</td>
              <td><a href="${result.url}" target="_blank">${result.url}</a></td>
              <td>${result.title}</td>
              <td>${result.description}</td>
              <td>${result.da}</td>
              <td>${result.domain_rank || 'N/A'}</td>
              <td>${result.backlinks || 'N/A'}</td>
              <td>${result.backlinks_spam_score || 'N/A'}</td>
              <td>${result.referring_domains || 'N/A'}</td>
              <td>${result.internal_links_count || 'N/A'}</td>
              <td>${result.external_links_count || 'N/A'}</td>
              <td>${result.image || 'N/A'}</td>
              <td>${result.cls || 'N/A'}</td>
              <td>${result.lcp || 'N/A'}</td>
              <td>${result.fid || 'N/A'}</td>
              <td>${result.schema || 'N/A'}</td>
              <td>${result.readability || 'N/A'}</td>
              <td>${result.word_count || 'N/A'}</td>
              <td>${result.eval?.kw_in_url || 'N/A'}</td>
              <td>${result.eval?.kw_in_title || 'N/A'}</td>
              <td>${result.eval?.kw_in_desc || 'N/A'}</td>
              <td>${result.eval?.kw_in_h1 || 'N/A'}</td>
              <td>${result.eval?.kw_in_h2 || 'N/A'}</td>
              <td>${result.eval?.kw_in_alt || 'N/A'}</td>
              <td>${result.eval?.kw_in_text || 'N/A'}</td>
            </tr>
          `;
            });

            tableHTML += `
            </tbody>
          </table>
        </div>
      `;

            resultsContainer.innerHTML = tableHTML;
        }

        function displayKeywordRecommendations(recommendations, containerId) {
            const recommendationsContainer = document.getElementById(containerId);
            if (!recommendationsContainer) {
                console.error(`Element with ID '${containerId}' not found.`);
                return;
            }

            recommendationsContainer.innerHTML = `${recommendations}`;
        }

        async function getKeywordRecommendations(keyword, language, location, target_url, serp_dict) {
            const keywordMappingEndpoint = 'https://c0bkxhc1s3.execute-api.ap-southeast-1.amazonaws.com/keywordMapping';
            const kwRecommendationsEndpoint = 'https://pkbguam62a.execute-api.ap-southeast-1.amazonaws.com/kwRecommendationsStructured';
            const targetContentTableContainerId = `target-content-table-container-${keyword.replace(/\s+/g, '-')}`;

            try {

                // 1. Keyword Mapping API
                const keywordMappingResponse = await fetch(keywordMappingEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        location: location,
                        keyword: keyword,
                        language: language,
                        target: target_url //use target_url instead of target.
                    })
                });

                if (!keywordMappingResponse.ok) {
                    throw new Error(`Keyword Mapping API Error for ${keyword}: ${keywordMappingResponse.status} ${keywordMappingResponse.statusText}`);
                }

                const keywordMappingData = await keywordMappingResponse.json();
                console.log(`Keyword Mapping API Response for ${keyword}:`, keywordMappingData);

                if (keywordMappingData && keywordMappingData.body && Array.isArray(keywordMappingData.body)) {
                    const targetUrls = keywordMappingData.body;

                    // 2. Get Domain Metrics for Target URLs & Rank Checking
                    const targetDataPromises = targetUrls.map(async (url) => {
                        const domainMetrics = await getDomainMetrics(url, keyword);

                        return {
                            url: url,
                            ...domainMetrics?.body,
                            title: keywordMappingData.dict[url]?.title || 'N/A',
                            description: keywordMappingData.dict[url]?.description || 'N/A'
                        };
                    });

                    const targetData = await Promise.all(targetDataPromises);

                    console.log(`Target Content with Metrics and Rank for ${keyword}:`, targetData);

                    //Get the rank from the targetData table
                    const targetDataWithRank = await Promise.all(
                        targetData.map(async (item) => {
                            const rankData = await getRankForUrl(item.url, keyword, language, location);
                            return {
                                ...item,
                                rank: rankData
                            };
                        })
                    );

                    displayTargetContentTable(targetDataWithRank, targetContentTableContainerId);

                    // 3. Call Keyword Recommendations API
                    if (serp_dict) {
                        const kwRecommendationsResponse = await fetch(kwRecommendationsEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                keyword: keyword,
                                target_content: targetDataWithRank.map(item => ({ url: item.url, domain_metrics: item, rank: item.rank })), // Pass all data as domain_metrics
                                serps_dict: serp_dict
                            })
                        });

                        if (!kwRecommendationsResponse.ok) {
                            throw new Error(`Keyword Recommendations API Error for ${keyword}: ${kwRecommendationsResponse.status} ${kwRecommendationsResponse.statusText}`);
                        }

                        const kwRecommendationsData = await kwRecommendationsResponse.json();
                        console.log(`Keyword Recommendations API Response for ${keyword}:`, kwRecommendationsData);

                        displayKeywordRecommendations(kwRecommendationsData.body, `recommendations-container-${keyword.replace(/\s+/g, '-')}`);

                        // Extract URL
                        //mapped_url = kwRecommendationsData.body.match(/(https?:\/\/|www\.)([a-zA-Z0-9.-]+(\.[a-zA-Z]{2,})+[a-zA-Z0-9_/\-\?=\&%\#\.]*)/gi)[0];

                        // Extract Time to Rank using regex
                        const timeToRankMatch = kwRecommendationsData.body.match(/(0-3 months|3-6 months|6-9 months|9-12 months|more than 12 months|More than 12 months)/);
                        const timeToRank = timeToRankMatch ? timeToRankMatch[0] : 'N/A';
                        return [timeToRank];
                    } else {
                        console.warn(`Skipping Keyword Recommendations for ${keyword} due to missing serp_dict.`);
                        return 'N/A';
                    }
                } else {
                    console.warn(`Invalid Keyword Mapping API response format for ${keyword}. Expected 'body' as array.`);
                    return 'N/A';
                }

            } catch (error) {
                console.error(`Error during Keyword Mapping, Target Content Processing, or Keyword Recommendations for ${keyword}:`, error);
                return 'N/A';
            }
        }

        async function getRankForUrl(url, keyword, language, location) {
            try {
                const rankCheckerResponse = await fetch('https://v5bizygr4m.execute-api.ap-southeast-1.amazonaws.com/rankChecker', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword: keyword,
                        language: language,
                        location: location,
                        target: url // Set target to the current URL
                    })
                });

                if (rankCheckerResponse.ok) {
                    const rankCheckerData = await rankCheckerResponse.json();
                    return rankCheckerData; // Returns rank number.
                } else {
                    console.error(`Rank Checker API error for ${url}:`, rankCheckerResponse.status);
                    return 'N/A';
                }
            } catch (error) {
                console.error(`Error fetching rank for ${url}:`, error);
                return 'N/A';
            }
        }

        let allKeywords = [];
        let currentSortColumn = null;
        let sortAscending = true;
        let keywordMetrics = {}; // Store search volume and cpc
        let summaryData = [];

        async function getDomainMetrics(url, keyword) {
            const domainMetricsEndpoint = 'https://5zdbpwaia5.execute-api.ap-southeast-1.amazonaws.com/pageDomainMetrics';

            try {
                const response = await fetch(domainMetricsEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url,
                        keyword: keyword
                    })
                });

                if (!response.ok) {
                    console.warn(`Domain Metrics API Error for URL ${url}: ${response.status} ${response.statusText}`);
                    return null;
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error(`Error fetching domain metrics for URL ${url}:`, error);
                return null;
            }
        }

        async function keywordAnalysis(keyword, language, location, target) {
            user = JSON.parse(localStorage.getItem('googleUser')).email;
            const analysisResultsContainer = document.getElementById('keyword-analysis-results');
            const keywordContainerId = `keyword-container-${keyword.replace(/\s+/g, '-')}`;
            const keywordContentId = `keyword-content-${keyword.replace(/\s+/g, '-')}`;
            const resultsContainerId = `results-container-${keyword.replace(/\s+/g, '-')}`;
            const targetContentTableContainerId = `target-content-table-container-${keyword.replace(/\s+/g, '-')}`;
            const recommendationsContainerId = `recommendations-container-${keyword.replace(/\s+/g, '-')}`;


            document.getElementById("keywordAnalysisBtn").style.backgroundColor = "#004c9d";

            let collapsibleSection = document.getElementById(keywordContainerId);

            if (collapsibleSection) {
                // Keyword section exists, overwrite the content
                console.log(`Overwriting existing collapsible section for keyword: ${keyword}`);
                const keywordContent = document.getElementById(keywordContentId);
                if (keywordContent) {
                    keywordContent.innerHTML = `
            <div id="${targetContentTableContainerId}"></div>
            <div id="${resultsContainerId}"></div>
            <div id="${recommendationsContainerId}"></div>
          `;
                } else {
                    console.warn(`Keyword content element not found: ${keywordContentId}`);
                    // Recreate the content container if it's missing.  This shouldn't normally happen.
                    collapsibleSection.innerHTML = `
            <button type="button" class="keywords-collapsible">${keyword}</button>
            <div class="keywords-content" id="${keywordContentId}">
                <div id="${targetContentTableContainerId}"></div>
                <div id="${resultsContainerId}"></div>
                <div id="${recommendationsContainerId}"></div>
            </div>
          `;

                    const collapsibles = document.querySelectorAll('.keywords-collapsible');

                    collapsibles.forEach(collapsible => {
                        collapsible.addEventListener('click', function () {
                            this.classList.toggle('keywords-active');
                            const content = this.nextElementSibling;

                            // Toggle the display style of the content
                            if (content.style.display === 'block') {
                                content.style.display = 'none';
                            } else {
                                content.style.display = 'block';
                            }
                        });
                    });
                }

            } else {
                // Keyword section doesn't exist, create a new one
                console.log(`Creating new collapsible section for keyword: ${keyword}`);
                collapsibleSection = document.createElement('div');
                collapsibleSection.id = keywordContainerId;
                collapsibleSection.innerHTML = `
            <button type="button" class="keywords-collapsible">${keyword}</button>
            <div class="keywords-content" id="${keywordContentId}">
                <div id="${targetContentTableContainerId}"></div>
                <div id="${resultsContainerId}"></div>
                <div id="${recommendationsContainerId}"></div>
            </div>
        `;
                analysisResultsContainer.appendChild(collapsibleSection);

                const collapsibles = document.querySelectorAll('.keywords-collapsible');

                collapsibles.forEach(collapsible => {
                    collapsible.addEventListener('click', function () {
                        this.classList.toggle('keywords-active');
                        const content = this.nextElementSibling;

                        // Toggle the display style of the content
                        if (content.style.display === 'block') {
                            content.style.display = 'none';
                        } else {
                            content.style.display = 'block';
                        }
                    });
                });
            }

            try {
                const serpEndpoint = 'https://8k6r15rg4m.execute-api.ap-southeast-1.amazonaws.com/serpLite';
                const serpResponse = await fetch(serpEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword: keyword,
                        language: language,
                        location: location,
                        user: user
                    })
                });

                if (!serpResponse.ok) {
                    throw new Error(`SERP API Error: ${serpResponse.status} ${serpResponse.statusText}`);
                }

                const serpData = await serpResponse.json();
                console.log(`SERP API Response for ${keyword}:`, serpData);

                if (!serpData || !serpData.body) {
                    throw new Error(`Invalid SERP API response format for ${keyword}. Expected 'body' property.`);
                }

                const serp_dict = serpData.body;

                // Fetch domain metrics for SERP results and then display them
                const serpResultsWithMetrics = await Promise.all(
                    Object.entries(serp_dict).map(async ([rank, result]) => {
                        const domainMetrics = await getDomainMetrics(result.url, keyword);
                        return {
                            rank: rank,
                            ...result,
                            ...domainMetrics?.body // Add domain metrics to the result object
                        };
                    })
                );

                displaySerpResults(serpResultsWithMetrics, resultsContainerId);

                keywordRecommendations = await getKeywordRecommendations(keyword, language, location, target, serp_dict)

                // Await the keyword recommendations
                const timeToRank = keywordRecommendations[0];

                // Update the keywordMetrics object with time to rank
                keywordMetrics[keyword] = {
                    ...keywordMetrics[keyword],
                    timeToRank: timeToRank
                };

                console.log("Keyword Metrics after keywordAnalysis:", keywordMetrics);

                await displayOverallSummaryTable(keywords, location, language, target);
                document.getElementById('keyword-research-analysis-button').innerText = "Get Time To Rank";

            } catch (error) {
                console.error(`An error occurred for ${keyword}:`, error);
                const container = document.getElementById(resultsContainerId);
                if (container) {
                    container.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                } else {
                    console.warn(`Results container not found: ${resultsContainerId}`);
                }
                document.getElementById('keyword-research-analysis-button').innerText = "Get Time To Rank";
            }
        }

        async function timeToRankToDatabase() {
            endpoint = "https://0tmfunltch.execute-api.ap-southeast-1.amazonaws.com/timeToRankToDatabase";

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    url: document.getElementById('domain').value,
                    keywords: document.getElementById('keywords').value,
                    language: document.getElementById('language').value,
                    location: document.getElementById('location').value,
                    ranking_keywords: document.getElementById('rankingKeywords').innerHTML,
                    webpage_keywords: document.getElementById('siteKeywords').innerHTML,
                    suggestion_keywords: document.getElementById('keywordSuggestions').innerHTML,

                    meta_data: document.getElementById('metaData').innerHTML,
                    domain_metrics: document.getElementById('domainMetrics').innerHTML,

                    time_to_rank_table: document.getElementById('overall-summary').innerHTML,
                    keyword_analysis: document.getElementById('keywordAnalysis').innerHTML,

                    user: JSON.parse(localStorage.getItem('googleUser')).email
                })
            })

            data = await response.json();
        }

        async function displayOverallSummaryTable(keywords, location, language, target) {
            keywordsInput = document.getElementById('keywords').value;
            keywords = keywordsInput.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);
            const summaryContainer = document.getElementById('overall-summary');
            if (!summaryContainer) {
                console.error("Summary container not found");
                return;
            }

            // Prepare the data for the summary table, using keywordMetrics
            summaryData = keywords.map((keyword, index) => {
                const metrics = keywordMetrics[keyword] || {
                    cpc: 'N/A',
                    search_volume: 'N/A',
                    timeToRank: 'N/A',
                    //mapping: '-'
                }; // Provide default values

                return {
                    No: index + 1,
                    keyword: keyword,
                    search_volume: metrics.search_volume || 'N/A',
                    cpc: metrics.cpc || 'N/A',
                    timeToRank: metrics.timeToRank || 'N/A',
                    reason: '', // Initialize the 'Reason' field
                    //mapping: metrics.mapping || '',
                };
            });


            let tableHTML = `
<h2>Overall Keyword Summary</h2>
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>No.</th>
                <th onclick="sortSummaryTable('keyword')">Keyword</th>
                <th onclick="sortSummaryTable('search_volume')">Search Volume</th>
                <th onclick="sortSummaryTable('cpc')">CPC</th>
                <th onclick="sortSummaryTable('timeToRank')">Time to Rank</th>
                <th>Reason</th>
                
            </tr>
        </thead>
        <tbody>
`;

            for (let index = 0; index < summaryData.length; index++) {
                const item = summaryData[index];
                const timeToRankClass = getTimeToRankClass(item.timeToRank);

                // Fetch initial reason from API
                const reason = await fetchReasonFromAPI(item.keyword, location, language, target);
                summaryData[index].reason = reason; // Update summaryData with initial reason

                tableHTML += `
    <tr>
      <td>${item.No}</td>
      <td>${item.keyword}</td>
      <td>${item.search_volume}</td>
      <td>${item.cpc}</td>
      <td class="${timeToRankClass}">${item.timeToRank}</td>
      <td><textarea class="multiline-input" id="reason-${index}" onchange="updateReason(${index}, this.value)">${reason}</textarea></td>
      </tr>
  `;
            }

            tableHTML += `
        </tbody>
    </table>
</div>
`;

            summaryContainer.innerHTML = tableHTML + '<button id="downloadCsvBtn" onclick="downloadOverallSummaryTableAsCSV()">Download Keyword Summary as CSV</button><br><br>';

            // Show the download button
            document.getElementById('overall-summary').style.display = 'block';
            document.getElementById('downloadCsvBtn').style.display = 'block';

            document.getElementById("keywordAnalysisBtn").style.backgroundColor = "green";

        }

        function getTimeToRankClass(timeToRank) {
            if (timeToRank === 'more than 12 months') {
                return 'time-to-rank-more-than-12';
            } else if (timeToRank === '9-12 months') {
                return 'time-to-rank-9-12';
            } else if (timeToRank === '6-9 months') {
                return 'time-to-rank-6-9';
            } else if (timeToRank === '3-6 months') {
                return 'time-to-rank-3-6';
            } else if (timeToRank === '0-3 months') {
                return 'time-to-rank-0-3';
            } else {
                return ''; // Default class or no class
            }
        }

        async function fetchReasonFromAPI(keyword, location, language, target) {
            const reasonApiEndpoint = "https://cdahvw5qi7.execute-api.ap-southeast-1.amazonaws.com/reasonForKwSelection";

            try {
                const response = await fetch(reasonApiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        location: location,
                        language: language,
                        target: target,
                        keyword: keyword
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.body;
                } else {
                    console.error("Error fetching reason from API:", response.status);
                    return ''; // Return empty string in case of error
                }
            } catch (error) {
                console.error("Error fetching reason from API:", error);
                return ''; // Return empty string in case of error
            }
        }

        // Function to update the 'Reason' in the summaryData array
        function updateReason(index, reason) {
            summaryData[index].reason = reason;
        }

        let currentSummarySortColumn = null;
        let summarySortAscending = true;

        function fetchDomainMetrics(domain) {
            document.getElementById('keyword-research-analysis-button').innerText = "Analysing...";

            //moz 
            var url = "https://a7hptjtc8e.execute-api.ap-southeast-1.amazonaws.com/new";
            var queryString = {
                "domain": domain
            };
            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json"
            };
            fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(queryString)
            })
                .then(response => {
                    // Check if the response is successful
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('da').innerText = data.domain_authority;
                    document.getElementById('pa').innerText = data.page_authority;
                })
                .catch(error => {
                    console.error("Error fetching data:", error); // Log any errors
                    // Handle the error gracefully, perhaps display an error message to the user
                });

            api_url = "https://9px7sjbyyb.execute-api.ap-southeast-1.amazonaws.com/new";
            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json"
            };
            fetch(api_url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ url: domain })
            }).then(response => {
                // Check if the response is successful
                if (!response.ok) {
                    throw new Error(`Error obtaining domain metrics Status: ${response.status}`);
                }
                return response.json();
            })
                .then(data => {
                    console.log(data);
                    document.getElementById('targetTitle').innerText = data.body.title;
                    document.getElementById('targetDescription').innerText = data.body.description;
                    document.getElementById('targetBacklinks').innerText = data.body.backlinks;
                    document.getElementById('targetSpamScore').innerText = data.body.backlinks_spam_score;
                    document.getElementById('targetRefDomains').innerText = data.body.referring_domains;
                    document.getElementById('targetInternalLinks').innerText = data.body.internal_links_count;
                    document.getElementById('targetExternalLinks').innerText = data.body.external_links_count;
                    document.getElementById('targetH1').innerText = data.body.h1;
                    document.getElementById('targetImages').innerText = data.body.image;
                    document.getElementById('targetCls').innerText = data.body.cls;
                    document.getElementById('targetLcp').innerText = data.body.lcp;
                    document.getElementById('targetFid').innerText = data.body.fid;
                    document.getElementById('targetSchema').innerText = data.body.schema;
                    document.getElementById('targetReadability').innerText = data.body.readability;
                    document.getElementById('targetWordCount').innerText = data.body.word_count;

                    document.getElementById("meta_data").style.backgroundColor = "green";
                    document.getElementById("domain_metrics").style.backgroundColor = "green";
                })
                .catch(error => {
                    console.error("Error fetching targeted domain data:", error); // Log any errors
                    // Handle the error gracefully, perhaps display an error message to the user
                });
        }

        async function fetchSerpResults(keyword, location, domain) {
            user = JSON.parse(localStorage.getItem('googleUser')).email
            const apiEndpoint = "https://u22k9g2y8c.execute-api.ap-southeast-1.amazonaws.com/new";
            const requestBody = {
                location: location,
                keyword: keyword,
                targeted_url: domain,
                language: document.getElementById("location").value,
                user: user
            };

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                console.log(data);
                return data;
            } catch (error) {
                console.error('Error fetching SERP data:', error);
                return null;
            }
        }

        function removeRow(button) {
            let row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
        }

        function sortTable(column) {
            const table = document.getElementById("keywordResults");
            const rows = Array.from(table.rows);
            const dir = this.asc ? 'asc' : 'desc';

            rows.sort((a, b) => {
                // **Convert cell content to numbers before comparison:**
                const ax = parseFloat(a.cells[column].textContent) || 0; // Use parseFloat for numbers, 0 for non-numeric
                const bx = parseFloat(b.cells[column].textContent) || 0;

                return (ax > bx) ? (dir === 'asc' ? 1 : -1) : (ax < bx ? (dir === 'asc' ? -1 : 1) : 0);
            });

            rows.forEach(row => table.appendChild(row));
            this.asc = !this.asc;
        }

        function downloadSemCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";

            const generatedDiv = document.getElementById('generated');
            const tablesAndHeadings = Array.from(generatedDiv.querySelectorAll('h3, table')); // Select both h3 and table

            tablesAndHeadings.forEach((element, index) => {
                if (element.tagName === 'H3') {  // Check if it's a heading
                    const headingText = element.textContent.trim().replace(/_/g, ' ').toUpperCase(); //Add same formatting
                    const nextElement = tablesAndHeadings[index + 1]; // Check if next element exists

                    if (nextElement && nextElement.tagName === 'TABLE') {
                        const rows = Array.from(nextElement.querySelectorAll("tr"));

                        rows.forEach(row => {
                            const cells = Array.from(row.querySelectorAll("th, td"));

                            if (cells.length >= 2) { //Check if remove cell exists
                                cells.splice(1, 1); //Remove remove cell
                            }
                            //Replace 'Value' with headingText
                            if (cells.length > 0 && cells[0].textContent.trim() === 'Value') {
                                cells[0].textContent = headingText;
                            }

                            const rowText = cells.map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`).join(",");
                            csvContent += rowText + "\n";

                        });

                        csvContent += "\n"; // Add an empty row after each table's data
                    }


                }
            });


            // Create a hidden link element and trigger a click to download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "generated_sem.csv");
            document.body.appendChild(link); // Required for Firefox
            link.click(); // This will download the data file
            document.body.removeChild(link); // Cleanup 
        }

        function downloadKeywordAnalysisTableAsCSV() {
            const table = document.getElementById("keywordAnalysisResults").querySelector('table');
            if (!table) {
                console.error("Table not found!");
                return;
            }

            const rows = Array.from(table.querySelectorAll("tr"));

            // Add UTF-8 BOM (Byte Order Mark) to ensure proper encoding in Excel
            let csvContent = "\uFEFF";  // Unicode BOM
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll("th, td"));
                csvContent += cells.map(cell => {
                    let cellText = cell.textContent.trim();
                    if (!cellText && cell.innerHTML) {
                        cellText = cell.innerHTML.replace(/<[^>]*>/g, "").trim();
                    }

                    // **DEBUGGING:  Inspect the text BEFORE CSV escaping**
                    console.log("Cell text before escaping:", cellText); // Check if Korean is already garbled

                    return `"${cellText.replace(/"/g, '""')}"`;
                }).join(",") + "\n";
            });

            // **DEBUGGING: Inspect the CSV content before creating Blob**
            console.log("CSV Content before Blob:", csvContent);

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { // feature detection
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "keyword_analysis.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);  // Clean up
            } else {
                // IE10+ Fallback - opens the data URI in a new window
                window.open('data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));
            }
        }

        const keywordSortDirection = { 0: 'asc', 1: 'asc', 2: 'asc', 3: 'asc' };

        function sortKeywordSuggestions(columnIndex) {
            const keywordList = document.getElementById('keywordList');
            const rows = Array.from(keywordList.querySelectorAll('tr'));
            const isNumeric = columnIndex === 1 || columnIndex === 2 || columnIndex === 3;

            rows.sort((a, b) => {
                let valA = a.cells[columnIndex].innerText.trim().replace(/,/g, '');
                let valB = b.cells[columnIndex].innerText.trim().replace(/,/g, '');

                if (isNumeric) {
                    valA = valA === '-' ? -1 : parseFloat(valA);
                    valB = valB === '-' ? -1 : parseFloat(valB);
                    return keywordSortDirection[columnIndex] === 'asc' ? valA - valB : valB - valA;
                } else {
                    return keywordSortDirection[columnIndex] === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }
            });

            // Toggle direction
            keywordSortDirection[columnIndex] = keywordSortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';

            // Re-append sorted rows
            rows.forEach(row => keywordList.appendChild(row));
        }

        const rankedKeywordSortDirection = { 0: 'asc', 1: 'asc', 2: 'asc', 3: 'asc' };

        function sortRankedKeywords(columnIndex) {
            const rankedKeywordList = document.getElementById('rankedKeywordList');
            const rows = Array.from(rankedKeywordList.querySelectorAll('tr'));
            const isNumeric = columnIndex === 1 || columnIndex === 2 || columnIndex === 3;

            rows.sort((a, b) => {
                let valA = a.cells[columnIndex].innerText.trim().replace(/,/g, '');
                let valB = b.cells[columnIndex].innerText.trim().replace(/,/g, '');

                if (isNumeric) {
                    valA = valA === '-' ? -1 : parseFloat(valA);
                    valB = valB === '-' ? -1 : parseFloat(valB);
                    return rankedKeywordSortDirection[columnIndex] === 'asc' ? valA - valB : valB - valA;
                } else {
                    return rankedKeywordSortDirection[columnIndex] === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }
            });

            // Toggle direction
            rankedKeywordSortDirection[columnIndex] = rankedKeywordSortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';

            // Re-append sorted rows
            rows.forEach(row => rankedKeywordList.appendChild(row));
        }

        selectedItems = {};
        generatedData = {};

        async function semWebpageProducts() {
            const getProducts = document.getElementById("getProducts");
            if (!document.getElementById('sem_webpages').value && !document.getElementById('sem_additional').value) {
                alert("Please enter webpage URLs or additional information.");
                return;
            } else {
                getProducts.innerText = "Analysing...";
                if (document.getElementById("product-checkbox").checked) {
                    productFocus = true;
                } else {
                    productFocus = false;
                }
                if (document.getElementById("brand-checkbox").checked) {
                    brandFocus = true;
                } else {
                    brandFocus = false;
                }

                urls = document.getElementById("sem_webpages").value.split(/[\s,]+/).filter(url => url.trim() !== "");

                try {
                    const response = await fetch("https://13kntbziug.execute-api.ap-southeast-1.amazonaws.com/webpageProducts", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            pages: urls,
                            brand: brandFocus,
                            product: productFocus,
                            language: document.getElementById("sem_language").value,
                            additional: document.getElementById("sem_additional").value,
                        })
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const responseData = await response.json();
                    console.log(responseData);
                    const body = JSON.parse(responseData.body);

                    formattedString = "";

                    if (body['product/service'].length > 0) {
                        formattedString += "Product/Service: ";
                        if (Object.prototype.toString.call(body['product/service']) === '[object Array]') {
                            for (value in body['product/service']) {
                                formattedString += body['product/service'][value] + ", ";
                            }
                            formattedString = formattedString.slice(0, -2)
                        } else {
                            formattedString += body['product/service']
                        }
                    }

                    if (formattedString != "") {
                        formattedString += "\n\n";
                    }

                    if (body['brand/company'].length > 0) {
                        formattedString += "Brand/Company: ";
                        if (Object.prototype.toString.call(body['brand/company']) === '[object Array]') {
                            for (value in body['brand/company']) {
                                formattedString += body['brand/company'][value] + ", ";
                            }
                            formattedString = formattedString.slice(0, -2)
                        } else {
                            formattedString += body['brand/company']
                        }
                    }

                    document.getElementById("products").innerHTML = '<label for="identifiedProducts">Identfied Products/Services/Brand/Company:</label><br><textarea rows="6" id="identifiedProducts">' + formattedString + '</textarea>';
                    getProducts.innerText = "Step 1: Identify products/services/brand/company";
                } catch (error) {
                    console.error("Error:", error);
                    document.getElementById("output").innerText = "An error occurred with semWebpageProducts. Please check the console for details.";
                    getProducts.innerText = "Step 1: Identify products/services/brand/company";
                }
            }
        }

        async function semAnalyseWebsite() {
            const semButton = document.getElementById("semAnalyse");
            semButton.innerText = "Analysing...";
            try {
                const response = await fetch("https://sk7akfiy89.execute-api.ap-southeast-1.amazonaws.com/semWebsiteAnalyser", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        country: document.getElementById("sem_country").value,
                        additional: document.getElementById("sem_additional").value,
                        products: document.getElementById("identifiedProducts").value,
                        language: document.getElementById("sem_language").value,
                    })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const responseData = await response.json();
                const body = responseData.body;
                selectedItems = {}; // Clear selections
                document.getElementById('selected').style.display = 'block';
                //document.getElementById("selectedText").value = ""; // Clear textarea
                console.log(body);
                document.getElementById("output").innerHTML = await createSemTables(body);

                semButton.innerText = "Step 2: Generate KWs, USPs & Audience";
            } catch (error) {
                console.error("Error:", error);
                document.getElementById("output").innerText = "An error occurred with semWebsiteAnalyser. Please check the console for details.";
                semButton.innerText = "Step 2: Generate KWs, USPs & Audience";
            }
        }

        async function createSemTables(data) {
            let tablesHTML = "";
            const categories = ["short_keywords", "long_keywords", "usp", "target_audience_name"];
            const titles = ["Short-tail Keywords", "Long-tail Keywords", "USPs", "Target Audience"];

            for (let i = 0; i < categories.length; i++) {
                const category = categories[i];
                const title = titles[i];
                const items = data[category];


                // Fetch keyword metrics for short and long tail keywords
                let keywordMetrics = {};
                if (category === "short_keywords" || category === "long_keywords") {
                    const keywords = items.map(item => typeof item === 'object' ? Object.values(item)[0] : item);
                    keywordMetrics = await fetchKeywordMetricsSem(keywords);
                }

                let tableHTML = `<h2>${title}</h2><div class="table-container"><table><tr><th>Select</th><th>Value</th>`;
                if (category === "short_keywords" || category === "long_keywords") {
                    tableHTML += `<th>CPC</th><th>Search Volume</th>`; // Add CPC and Search Volume headers
                }
                tableHTML += `</tr>`;

                for (const item of items) {
                    const value = typeof item === 'object' ? Object.values(item)[0] : item;
                    tableHTML += `<tr><td><input type="checkbox" onchange="updateSemSelected('${value}', '${title}')"></td><td>${value}</td>`;

                    if (category === "short_keywords" || category === "long_keywords") {
                        const metrics = keywordMetrics[value] || { cpc: 'N/A', search_volume: 'N/A' };
                        tableHTML += `<td>${metrics.cpc}</td><td>${metrics.search_volume}</td>`; // Add CPC and Search Volume data
                    }

                    tableHTML += `</tr>`;
                }
                tableHTML += '</table></div>';
                tablesHTML += tableHTML;
            }
            return tablesHTML;
        }

        async function fetchKeywordMetrics(keywords, location, language) {
            const keywordMetricsEndpoint = 'https://gr8ar6zc4e.execute-api.ap-southeast-1.amazonaws.com/mangoolsKeywords';

            try {
                const response = await fetch(keywordMetricsEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keywords: keywords,
                        location: location,
                        language: language
                    })
                });

                if (!response.ok) {
                    throw new Error(`Keyword Metrics API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                keywordMetrics = data.body;
                console.log("Keyword Metrics:", keywordMetrics);

            } catch (error) {
                console.error("Error fetching keyword metrics:", error);
            }
        }

        async function fetchKeywordMetricsSem(keywords) {
            console.log(keywords);
            const location = document.getElementById("sem_country").value;
            const language = document.getElementById("sem_language").value;

            try {
                const response = await fetch("https://gr8ar6zc4e.execute-api.ap-southeast-1.amazonaws.com/mangoolsKeywords", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ keywords: keywords, location: location, language: language })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const metrics = data.body;

                console.log(data);

                // Convert the returned keyword metrics to a format that is easily accessible when populating the table
                const formattedMetrics = {};
                for (const keyword in metrics) {
                    formattedMetrics[keyword] = {
                        cpc: metrics[keyword].cpc,
                        search_volume: metrics[keyword].search_volume
                    };
                }
                return formattedMetrics;

            } catch (error) {
                console.error("Error fetching keyword metrics:", error);
                return {}; // Return an empty object in case of an error
            }
        }
        function updateSemSelected(value, category) {
            if (!selectedItems[category]) {
                selectedItems[category] = [];
            }
            const index = selectedItems[category].indexOf(value);
            if (index > -1) {
                selectedItems[category].splice(index, 1);
            } else {
                selectedItems[category].push(value);
            }
            displaySemSelectedItems();
        }

        function displaySemSelectedItems() {
            let selectedText = "";
            for (const category in selectedItems) {
                if (selectedItems[category].length > 0) {
                    selectedText += `${category}\n`;
                    selectedItems[category].forEach(item => {
                        selectedText += `${item}\n`;
                    });
                }
            }
            document.getElementById("selectedText").value = selectedText;
        }

        // --- Card Deletion & Undo Logic ---
        let deletedCardsStack = [];
        let allCompetitorUrls_Optimiser = { new: [], optimise: [] };
        let displayedCount_Optimiser = { new: 0, optimise: 0 };
        let selectedTopics_Optimiser = { new: new Set(), optimise: new Set() };

        function deleteCard(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;

            element.style.display = 'none';
            deletedCardsStack.push(elementId);
            updateUndoButtonState();
            if (elementId.startsWith('persona-card') || elementId.startsWith('comp-card')) {
                updatePersonaButtonsState();
            }
        }

        function undoDeletion() {
            if (deletedCardsStack.length === 0) return;

            const elementId = deletedCardsStack.pop();
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = '';
                // Optional: Scroll back to the restored card
                element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                if (elementId.startsWith('persona-card') || elementId.startsWith('comp-card')) {
                    updatePersonaButtonsState();
                }
            }
            updateUndoButtonState();
        }

        function updateUndoButtonState() {
            const undoBtns = document.querySelectorAll('.btn-undo');
            const undoBars = document.querySelectorAll('.undo-bar');

            const hasDeleted = deletedCardsStack.length > 0;

            undoBtns.forEach(btn => {
                btn.disabled = !hasDeleted;
                if (hasDeleted) {
                    btn.innerHTML = `<i class="fas fa-undo-alt"></i> Undo Deletion (${deletedCardsStack.length})`;
                } else {
                    btn.innerHTML = `<i class="fas fa-undo-alt"></i> Undo Deletion`;
                }
            });

            undoBars.forEach(bar => {
                bar.style.display = hasDeleted ? 'flex' : 'none';
            });
        }

        function getCompetitors() {
            document.getElementById("getCompetitorsBtn").innerText = "Getting Competitors...";
            document.getElementById("competitionBtn").style.backgroundColor = "#004c9d";
            updateCollapsibleState('competitionBtn', 'running');
            const keywords = document.getElementById('competitor_keywords').value.split(/[\n,]+/).map(k => k.trim());
            console.log(keywords);
            const competitorsLanguage = document.getElementById("competitors-language").value;
            const competitorsLocation = document.getElementById("competitors-location").value;

            fetch("https://itzj193chl.execute-api.ap-southeast-1.amazonaws.com/serpCompetitors", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    keywords: keywords,
                    location: competitorsLocation,
                    language: competitorsLanguage
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayCompetitorResults(data.body);
                    document.getElementById("competitorsOutput").style.display = "block";
                    document.getElementById("competitionBtn").style.backgroundColor = "green";
                    updateCollapsibleState('competitionBtn', 'success');
                })
                .catch(error => {
                    console.error("Error fetching competitors:", error);
                    document.getElementById("competitorsOutput").innerHTML = "Error fetching competitors.  See console for details.";
                    document.getElementById("competitionBtn").style.backgroundColor = "#004c9d";
                    updateCollapsibleState('competitionBtn', 'error');
                })
                .finally(() => {
                    document.getElementById("getCompetitorsBtn").innerText = "Step 1: Get Competitors";
                });
        }

        function displayCompetitorResults(results) {
            const outputDiv = document.getElementById("competitorsOutput");
            if (results === undefined) {
                alert("There are no results found for the keyword(s). Please try other keyword(s).")
            }
            if (!outputDiv) {
                console.error("Competitors output div not found!");
                return;
            }

            let tableHTML = `
        <table>
            <thead>
                <tr>
                    <th>Domain</th>
                    <th>Keyword and Rank</th>
                    <th>Select</th>
                </tr>
            </thead>
            <tbody>
    `;

            for (const domain in results) {
                if (results.hasOwnProperty(domain)) {
                    const keywordRanks = results[domain];
                    let keywordRankText = "";
                    for (const keyword in keywordRanks) {
                        if (keywordRanks.hasOwnProperty(keyword)) {
                            keywordRankText += `${keyword}: ${keywordRanks[keyword]}<br>`;
                        }
                    }

                    // Make the domain a hyperlink
                    const linkedDomain = `<a href="http://${domain}" target="_blank" rel="noopener noreferrer">${domain}</a>`;  //IMPORTANT:  Added http:// to the domain so if a naked domain is returned it will open.  Also add noreferrer to protect user privacy

                    tableHTML += `
                <tr>
                    <td>${linkedDomain}</td>
                    <td>${keywordRankText}</td>
                    <td><input type="checkbox" class="domain-checkbox" value="${domain}" onchange="updateCompetitorDomainsField()"></td>

                </tr>
            `;
                }
            }

            tableHTML += `
            </tbody>
        </table>
    `;

            outputDiv.innerHTML = tableHTML;

            // Add event listener after the table is rendered
            const checkboxes = document.querySelectorAll('.domain-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateCompetitorDomainsField);
            });
            // Show the button
            document.getElementById('getIntersectionResults').style.display = 'block';
        }

        async function getIntersectionResults() {
            document.getElementById('competitorsRanking').style.display = 'none';
            const checkedDomains = Array.from(document.querySelectorAll('.domain-checkbox:checked'))
                .map(checkbox => checkbox.value);

            if (checkedDomains.length === 0) {
                alert('Please select at least one domain.');
                return;
            }

            const target1Value = document.getElementById('competitors-target1').value;

            const apiCalls = checkedDomains.map(domain => {
                const requestBody = {
                    "language": "English",
                    "location": "Singapore",
                    "target1": target1Value,
                    "target2": domain
                };

                return fetch('https://8llvcx7m6e.execute-api.ap-southeast-1.amazonaws.com/domainIntersection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        return { domain: domain, data: data }; // Return domain along with the data
                    })
                    .catch(error => {
                        console.error(`Error fetching intersection results for ${domain}:`, error);
                        return { domain: domain, error: error }; // Return domain and the error
                    });
            });

            // Execute all API calls in parallel
            const results = await Promise.all(apiCalls);
            displayIntersectionResults(results);

        }

        async function getIntersectionResults2() {
            client_url = document.getElementById('competitors-target1').value;
            if (!client_url) {
                alert("Please enter a Target Domain.");
                return;
            }
            document.getElementById('getIntersectionResults2').innerText = "Getting Results..";
            var domains = document.getElementById('competitor_domains').value;
            domainsArray = domains.split(/[,\n]+/).map(domain => domain.trim()).filter(domain => domain !== "");

            var location = document.getElementById('competitors-location').value;

            var url = "https://0dqny7l5y9.execute-api.ap-southeast-1.amazonaws.com/rankingKeywords";

            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json",
            };

            const target1Value = document.getElementById('competitors-target1').value;

            const apiCalls = domainsArray.map(domain => {
                const requestBody = {
                    "language": document.getElementById('competitors-language').value,
                    "location": document.getElementById('competitors-location').value,
                    "target1": target1Value,
                    "target2": domain
                };

                return fetch('https://8llvcx7m6e.execute-api.ap-southeast-1.amazonaws.com/domainIntersection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        return { domain: domain, data: data }; // Return domain along with the data
                    })
                    .catch(error => {
                        console.error(`Error fetching intersection results for ${domain}:`, error);
                        return { domain: domain, error: error }; // Return domain and the error
                    });
            });

            // Execute all API calls in parallel
            const results = await Promise.all(apiCalls);
            displayIntersectionResults(results);
            document.getElementById('getIntersectionResults').style.display = 'block';
            document.getElementById('getIntersectionResults2').innerText = "Get Intersection Results";
        }
        function displayIntersectionResults(results) {
            const outputDiv = document.getElementById("competitorsRanking");
            if (!outputDiv) {
                console.error("Competitors output div not found!");
                return;
            }

            let tableHTML = `
    <table id="intersectionResultsTable">
      <thead>
        <tr>
          <th onclick="sortIntersectionTable('keyword')">Keyword</th>
          <th onclick="sortIntersectionTable('${document.getElementById("competitors-target1").value}')">${document.getElementById("competitors-target1").value}</th>
          ${results.map(result => `<th onclick="sortIntersectionTable('${result.domain}')">${result.domain}</th>`).join('')}
        </tr>
      </thead>
      <tbody>
  `;

            // Collect all unique keywords from the results
            const allKeywords = new Set();
            results.forEach(result => {
                if (result.data) {
                    Object.keys(result.data).forEach(keyword => allKeywords.add(keyword));
                }
            });

            // Iterate over each unique keyword and create a row
            allKeywords.forEach(keyword => {
                tableHTML += `
      <tr>
        <td>${keyword}</td>
    `;

                console.log(results);

                // Get target1 data
                tableHTML += `
      <td>${(results[0].data && results[0].data[keyword]) ? `<a href="${results[0].data[keyword][Object.keys(results[0].data[keyword])[3]][1]}"  target="_blank">${results[0].data[keyword][Object.keys(results[0].data[keyword])[3]][0]}</a>` : '999'}</td>
    `;

                //Add rankings for the rest of the selected domains
                results.forEach(result => {
                    if (result.data && result.data[keyword]) {

                        // Find first domain and retrieve rankings and URLs
                        const firstDomain = Object.keys(result.data[keyword])[4]
                        const domainData = result.data[keyword][firstDomain]

                        //Set ranks and URLs into the rows
                        tableHTML += `<td><a href="${domainData[1]}" target="_blank">${domainData[0]}</a></td>`;

                    } else if (result.error) {
                        tableHTML += `<td>Error</td>`;
                    } else {
                        tableHTML += `<td>999</td>`;
                    }
                });

                tableHTML += `</tr>`;
            });

            tableHTML += `
      </tbody>
    </table>
  `;

            outputDiv.innerHTML = tableHTML;
            outputDiv.innerHTML += '<br><button type="button" onclick="copyInteractionResultsTable()"><i class="fa fa-copy"></i></button>';
            outputDiv.innerHTML += '<button type="button" onclick="exportInteractionResultsTableToCSV()">Export as .csv</button>';
            document.getElementById('competitorsRanking').style.display = 'block';
        }

        async function generatePersona() {
            const btn = document.getElementById("generatePersonaBtn");
            const isMore = btn.innerText.includes("5 more");
            btn.innerText = "Generating...";
            document.getElementById("persona").style.backgroundColor = "#004c9d";
            updateCollapsibleState('persona', 'running');
            const webpagesInput = document.getElementById("persona_webpages").value;
            const manualInput = document.getElementById("persona_manual").value;
            const webpages = webpagesInput.split(/[\s,]+/).filter(url => url.trim() !== "");
            const personaContentDiv = document.getElementById("persona-results");
            let combinedResponses = "";

            try {
                // Fetch data from all URLs concurrently using Promise.all
                const responses = await Promise.all(
                    webpages.map(async url => {
                        try {
                            const response = await fetch("https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({ url: url })
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status} for URL: ${url}`);
                            }

                            return await response.json(); // Return the parsed JSON data
                        } catch (error) {
                            console.error(`Error fetching data from ${url}:`, error);
                            return null; // Return null in case of an error
                        }
                    })
                );

                // Combine the responses
                combinedResponses = responses.filter(response => response !== null).map(response => JSON.stringify(response)).join("\n");

                console.log(combinedResponses);

                // Send combined responses to the second API
                try {
                    const personaResponse = await fetch("https://tyqj3fni7h.execute-api.ap-southeast-1.amazonaws.com/personaGenerator", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ data: combinedResponses, manual: manualInput })
                    });

                    if (!personaResponse.ok) {
                        throw new Error(`HTTP error! status: ${personaResponse.status} for persona API`);
                    }

                    const personaData = await personaResponse.json();

                    // Parse the returned HTML to inject IDs and delete buttons
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = personaData.body;
                    const cards = tempDiv.querySelectorAll('.persona-card');

                    cards.forEach((card, index) => {
                        const uniqueId = `persona-card-${Date.now()}-${index}`;
                        card.id = uniqueId;
                        card.setAttribute('contenteditable', 'true');

                        // Add delete button if not already present
                        if (!card.querySelector('.card-delete-btn')) {
                            const deleteBtn = document.createElement('div');
                            deleteBtn.className = 'card-delete-btn';
                            deleteBtn.title = 'Delete persona';
                            deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                            deleteBtn.setAttribute('contenteditable', 'false');
                            deleteBtn.setAttribute('onclick', `event.stopPropagation(); deleteCard('${uniqueId}')`);
                            card.prepend(deleteBtn);
                        }
                    });

                    if (isMore) {
                        personaContentDiv.innerHTML += tempDiv.innerHTML;
                    } else {
                        personaContentDiv.innerHTML = tempDiv.innerHTML;
                    }

                    updatePersonaButtonsState();

                } catch (error) {
                    personaContentDiv.innerHTML = `<p style="color: red;">Error sending data to persona API: ${error.message}</p>`;
                    console.error("Error sending data to persona API:", error);
                }

            } catch (error) {
                personaContentDiv.innerHTML = `<p style="color: red;">An error occurred: ${error.message}</p>`;
                console.error("An error occurred:", error);
            } finally {
                document.getElementById("generatePersonaBtn").innerText = "Generate 5 more personas";
                document.getElementById("persona").style.backgroundColor = "green";
                updateCollapsibleState('persona', 'success');
                document.getElementById("copy-persona-results-button").style.display = "block";
                document.getElementById("persona-instruction").style.display = "block";

                // Show return button if we came from a pathway
                const returnBtn = document.getElementById("btnReturnToFlow");
                if (personaOriginPathway && returnBtn) {
                    returnBtn.style.display = "block";
                    returnBtn.innerText = `Return to ${personaOriginPathway === 'createNewFlow' ? 'Develop' : 'Optimise'} Content`;
                }
            }
        }

        function navigateToPersonas(pathway) {
            personaOriginPathway = pathway;

            // Sync values from pathway to persona generator
            const pWebpages = document.getElementById('persona_webpages');
            const pManual = document.getElementById('persona_manual');

            if (pathway === 'optimiseExistingFlow') {
                const url = document.getElementById('optimiserPageUrl').value.trim();
                const pk = document.getElementById('primaryKeyword').value.trim();
                const sk = document.getElementById('secondaryKeywords').value.trim();
                if (url && pWebpages) pWebpages.value = url;
                if (pManual) pManual.value = `Keywords: ${pk}${sk ? ', ' + sk.replace(/\n/g, ', ') : ''}`;
            } else if (pathway === 'createNewFlow') {
                const refUrls = document.getElementById('referenceUrls').value.trim();
                const pk = document.getElementById('primaryKeywordNew').value.trim();
                const sk = document.getElementById('secondaryKeywordsNew').value.trim();
                if (refUrls && pWebpages) pWebpages.value = refUrls;
                if (pManual) pManual.value = `Keywords: ${pk}${sk ? ', ' + sk.replace(/\n/g, ', ') : ''}`;
            }

            const personaSection = document.getElementById('persona');
            if (personaSection) {
                // Open the persona section if it's collapsed
                const content = personaSection.nextElementSibling;
                if (content && content.style.display !== "block") {
                    personaSection.click();
                }
                personaSection.scrollIntoView({ behavior: 'smooth' });

                // Ensure the return button is updated in case personas already exist
                const returnBtn = document.getElementById("btnReturnToFlow");
                if (returnBtn && document.getElementById("persona-results").innerHTML.trim() !== "") {
                    returnBtn.style.display = "block";
                    returnBtn.innerText = `Return to ${pathway === 'createNewFlow' ? 'Develop' : 'Optimise'} Content`;
                }
            }
        }

        function returnToPathway() {
            if (!personaOriginPathway) return;
            const element = document.getElementById(personaOriginPathway);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function getPersonaData() {
            const cards = document.querySelectorAll('#persona-results .persona-card');
            if (cards.length === 0) return "";

            let personaText = "\n\n--- TARGET AUDIENCE PERSONAS ---\n";
            let visibleCount = 0;
            cards.forEach((card) => {
                if (card.style.display === 'none') return;
                visibleCount++;
                // Clone to not affect the UI while stripping the delete button text if it exists
                const clone = card.cloneNode(true);
                const deleteBtn = clone.querySelector('.card-delete-btn');
                if (deleteBtn) deleteBtn.remove();
                personaText += `Persona ${visibleCount}:\n${clone.innerText.trim()}\n\n`;
            });
            return visibleCount > 0 ? personaText : "";
        }

        function updatePersonaButtonsState() {
            const cards = document.querySelectorAll('#persona-results .persona-card');
            let hasVisiblePersonas = false;
            for (let card of cards) {
                if (card.style.display !== 'none') {
                    hasVisiblePersonas = true;
                    break;
                }
            }
            const btnNew = document.getElementById('btnResearchPersonasNew');
            const btnOptimise = document.getElementById('btnResearchPersonasOptimise');

            const color = hasVisiblePersonas ? '#28a745' : '#6c757d'; // green or grey

            if (btnNew) btnNew.style.backgroundColor = color;
            if (btnOptimise) btnOptimise.style.backgroundColor = color;
        }

        function getSelectedTopicsData(flow) {
            const set = selectedTopics_Optimiser[flow];
            if (!set || set.size === 0) return "";
            return Array.from(set).join(', ');
        }

        async function generateMediaPlan() {
            document.getElementById("generateMediaPlanBtn").innerText = "Generating...";
            document.getElementById("mediaPlanBtn").style.backgroundColor = "#004c9d";
            updateCollapsibleState('mediaPlanBtn', 'running');
            const mediaplanContentDiv = document.getElementById("mediaPlanResults");
            const webpages = document.getElementById("MediaPlanWebpages").value.split(/[\s,]+/).filter(url => url.trim() !== "");

            const responses = await Promise.all(
                webpages.map(async url => {
                    try {
                        const response = await fetch("https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({ url: url })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} for URL: ${url}`);
                        }

                        return await response.json(); // Return the parsed JSON data
                    } catch (error) {
                        console.error(`Error fetching data from ${url}:`, error);
                        return null; // Return null in case of an error
                    }
                })
            );

            word_count = 0;
            responses.forEach((page) => {
                word_count += (page.body.other_text.split(" ")).length;
            });

            if (word_count < 500) {
                alert("Please consider adding more webpage URLs for the tool to generate better results. The tool will continue generating the media plan.");
            }


            personaData = document.getElementById("MediaPlanCustomerPersonas").value;
            manualInput = document.getElementById("persona_manual").value;

            if (personaData == "") {
                try {
                    const personaResponse = await fetch("https://tyqj3fni7h.execute-api.ap-southeast-1.amazonaws.com/personaGenerator", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ data: responses, manual: manualInput })
                    });

                    if (!personaResponse.ok) {
                        throw new Error(`HTTP error! status: ${personaResponse.status} for persona API`);
                    }

                    personaData = await personaResponse.json();
                    document.getElementById("mediaPlanPersonaResults").innerHTML = "<h2>Generated Personas</h2>" + personaData.body;
                    document.getElementById("mediaPlanPersonaResults").style.display = "block"

                } catch (error) {
                    alert(`Error sending data to persona API: ${error.message}`);
                    console.error("Error sending data to persona API:", error);
                }
            }

            // Gather all the data from the form fields
            const data = {
                webpagesInput: responses,
                budget: document.getElementById("MediaPlanBudget").value,
                manualInput: document.getElementById("MediaPlanManual").value,
                organisationalObjectives: document.getElementById("MediaPlanOrganisationalObjectives").value,
                mediaPlanLocation: document.getElementById("MediaPlanLocation").value,
                mediaPlanTargetAudience: document.getElementById("MediaPlanTargetAudience").value,
                mediaPlanCustomerPersonas: personaData,
                mediaPlanTouchpoints: document.getElementById("MediaPlanTouchpoints").value,
                mediaPlanContentStrategy: document.getElementById("MediaPlanContentStrategy").value,
                mediaPlanLandingPages: document.getElementById("MediaPlanLandingPages").value,
                mediaPlanCta: document.getElementById("MediaPlanCta").value,
                mediaPlanProductService: document.getElementById("MediaPlanProductService").value,
                mediaPlanKpis: document.getElementById("MediaPlanKpis").value,
                mediaPlanCompetitiveAnalysis: document.getElementById("MediaPlanCompetitiveAnalysis").value,
                mediaPlanCompliance: document.getElementById("MediaPlanCompliance").value,
                mediaPlanTechnologyPlan: document.getElementById("MediaPlanTechnologyPlan").value,
                mediaPlanAnalyticsReporting: document.getElementById("MediaPlanAnalyticsReporting").value,

                adFormats: {
                    googleDisplay: document.getElementById("MediaPlanAdFormatsGoogleDisplay").checked,
                    googleSearch: document.getElementById("MediaPlanAdFormatsGoogleSearch").checked,
                    fbIg: document.getElementById("MediaPlanAdFormatsFBIG").checked,
                    linkedIn: document.getElementById("MediaPlanAdFormatsLinkedIn").checked,
                    tikTok: document.getElementById("MediaPlanAdFormatsTikTok").checked
                }
            };

            try {
                // Combine the responses - the original implementation was parsing webpage
                // content, but now we skip that step and pass the data directly

                // Send the combined data to the media plan API
                const mediaPlanResponse = await fetch("https://h8ih2vc2xi.execute-api.ap-southeast-1.amazonaws.com/mediaPlanGenerator", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data) // Send all the data gathered from the form
                });

                if (!mediaPlanResponse.ok) {
                    throw new Error(`HTTP error! status: ${mediaPlanResponse.status} for media plan API`);
                }

                const mediaPlanData = await mediaPlanResponse.json();
                mediaplanContentDiv.innerHTML += "<br>" + mediaPlanData.body;

                // Funnel
                funnelResponse = await fetch("https://dpjtg2sr30.execute-api.ap-southeast-1.amazonaws.com/generateFunnel", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(Object.assign({}, personaData, mediaPlanData)) // Send all the data gathered from the form
                });

                if (!funnelResponse.ok) {
                    throw new Error(`HTTP error! status: ${funnelResponse.status} for media plan API`);
                }
                funnelData = await funnelResponse.json();

                funnelData = JSON.parse(funnelData.body);

                try {
                    document.getElementById("awareness-details").innerHTML = funnelData.Awareness.join('\n');
                } catch (error) {
                    document.getElementById("awareness-details").innerHTML = "N.A.";
                }
                try {
                    document.getElementById("discovery-details").innerHTML = funnelData.Discovery.join('\n');
                } catch (error) {
                    document.getElementById("discovery-details").innerHTML = "N.A.";
                }
                try {
                    document.getElementById("consideration-details").innerHTML = funnelData.Consideration.join('\n');
                } catch (error) {
                    document.getElementById("consideration-details").innerHTML = "N.A.";
                }
                try {
                    document.getElementById("conversion-details").innerHTML = funnelData.Conversion.join('\n');
                } catch (error) {
                    document.getElementById("conversion-details").innerHTML = "N.A.";
                }
                try {
                    document.getElementById("retention-details").innerHTML = funnelData.Retention.join('\n');
                } catch (error) {
                    document.getElementById("retention-details").innerHTML = "N.A.";
                }

                document.getElementById("funnel-container").style.display = "flex";
                document.getElementById("mediaPlanBtn").style.backgroundColor = "green";
                updateCollapsibleState('mediaPlanBtn', 'success');

            } catch (error) {
                mediaplanContentDiv.innerHTML = `<p style="color: red;">Error sending data to media plan API: ${error.message}</p>`;
                console.error("Error sending data to media plan API:", error);
            } finally {
                document.getElementById("generateMediaPlanBtn").innerText = "Generate Media Plan";
                if (document.getElementById("mediaPlanBtn").style.backgroundColor !== "green") {
                    updateCollapsibleState('mediaPlanBtn', 'error');
                }
            }
        }

        async function auditLandingPageDirectWeb() {
            document.getElementById("gauge").style.display = "none";
            document.getElementById("auditLandingPageBtn").innerText = "Evaluating landing page...";
            document.getElementById("landingPageAuditBtn").style.backgroundColor = "#004c9d";
            updateCollapsibleState('landingPageAuditBtn', 'running');
            landingPageAuditResultDiv = document.getElementById("landingPageAuditResults");

            const urlInput = document.getElementById("landingPageUrl").value;
            const auditKeyword = document.getElementById("landingPageAuditKeyword")?.value || null;

            // Check if the URL input is empty
            if (!urlInput || urlInput.trim() === "") {
                alert("Please enter a landing page URL.");
                document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
                return;
            }
            const finalAuditResponse = await fetch("https://7eehmzk9e0.execute-api.ap-southeast-1.amazonaws.com/auditLandingPageDirectWeb", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    keyword: auditKeyword, // Pass the keyword for main audit
                    url: urlInput
                })
            });

            const finalAuditData = await finalAuditResponse.json();

            // Display the results
            document.getElementById("landingPageAuditResults").innerHTML = finalAuditData.body;
            const gaugeElement = document.querySelector(".gauge");
            quality_score = finalAuditData.quality_score;
            setGaugeValue(gaugeElement, quality_score / 10);
            document.getElementById("gauge").style.display = "block";

            document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
            updateCollapsibleState('landingPageAuditBtn', 'success');
        }

        async function auditLandingPage2() {
            document.getElementById("gauge").style.display = "none";
            document.getElementById("auditLandingPageBtn").innerText = "Getting page content...";
            document.getElementById("landingPageAuditBtn").style.backgroundColor = "#004c9d";
            updateCollapsibleState('landingPageAuditBtn', 'running');
            landingPageAuditResultDiv = document.getElementById("landingPageAuditResults");

            const urlInput = document.getElementById("landingPageUrl").value;
            const auditKeyword = document.getElementById("landingPageAuditKeyword")?.value || null;

            // Check if the URL input is empty
            if (!urlInput || urlInput.trim() === "") {
                alert("Please enter a landing page URL.");
                document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
                return;
            }

            try {
                const landingPageAuditResponse = await fetch("https://ocgawi1990.execute-api.ap-southeast-1.amazonaws.com/auditLandingPageDataPull", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        url: urlInput
                    })
                });

                if (!landingPageAuditResponse.ok) {
                    const errorText = await landingPageAuditResponse.text();
                    throw new Error(`HTTP error! status: ${landingPageAuditResponse.status} - ${errorText}`);
                }

                const landingPageAuditData = await landingPageAuditResponse.json();

                // Split the HTML content into snippets of up to 100,000 characters
                const html = landingPageAuditData.html;
                const snippetSize = 100000;
                const snippets = [];
                for (let i = 0; i < html.length; i += snippetSize) {
                    snippets.push(html.substring(i, i + snippetSize));
                }

                console.log(landingPageAuditData.html.length);
                console.log(snippets.length);

                document.getElementById("auditLandingPageBtn").innerText = "Evaluating page elements...";

                // Send each snippet to the excerpt API concurrently
                const excerptPromises = snippets.map(snippet =>
                    fetch("https://vvoc1htseh.execute-api.ap-southeast-1.amazonaws.com/auditLandingPageExcerpt", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            html: snippet,
                            keyword: auditKeyword
                        })
                    }).then(response => {
                        if (!response.ok) {
                            return response.json().then(err => {
                                throw new Error(`Excerpt API error! status: ${response.status} - ${err.message || 'Unknown error'}`);
                            });
                        }
                        return response.json();
                    })
                );

                // Wait for all excerpt API calls to complete
                const excerptResponses = await Promise.all(excerptPromises);

                // Combine the responses from the excerpt API calls
                let combinedExcerptResponse = {
                    results: []
                };

                excerptResponses.forEach(response => {
                    if (response && response.results) {
                        combinedExcerptResponse.results = combinedExcerptResponse.results.concat(response.results);
                    }
                });

                document.getElementById("auditLandingPageBtn").innerText = "Auditing overall page...";

                // Send the combined response to the main audit API
                const finalAuditResponse = await fetch("https://llufeecqoe.execute-api.ap-southeast-1.amazonaws.com/auditLandingPage", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        excerpt_results: combinedExcerptResponse.results, // Pass the combined excerpt results
                        keyword: auditKeyword, // Pass the keyword for main audit
                        url: urlInput,
                        speed: landingPageAuditData.speed
                    })
                });

                if (!finalAuditResponse.ok) {
                    const errorText = await finalAuditResponse.text();
                    throw new Error(`Final Audit API error! status: ${finalAuditResponse.status} - ${errorText}`);
                }

                const finalAuditData = await finalAuditResponse.json();

                console.log(finalAuditData);

                // Display the results
                document.getElementById("landingPageAuditResults").innerHTML = `${JSON.stringify(finalAuditData['body'], null, 2)}`.replaceAll('"', '');
                const gaugeElement = document.querySelector(".gauge");
                quality_score = finalAuditData.quality_score;
                setGaugeValue(gaugeElement, quality_score / 10);
                document.getElementById("gauge").style.display = "block";

            } catch (error) {
                console.error("Error during audit:", error);
                alert(`Audit failed: ${error.message}`);
                document.getElementById("landingPageAuditResults").innerText = `Error: ${error.message}`;
            } finally {
                document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
                document.getElementById("landingPageAuditBtn").style.backgroundColor = "green"; // Revert to original style
                updateCollapsibleState('landingPageAuditBtn', 'success');
            }
        }

        async function auditLandingPage() {
            document.getElementById("gauge").style.display = "none";
            document.getElementById("auditLandingPageBtn").innerText = "Auditing...";
            document.getElementById("landingPageAuditBtn").style.backgroundColor = "#004c9d";
            updateCollapsibleState('landingPageAuditBtn', 'running');
            landingPageAuditResultDiv = document.getElementById("landingPageAuditResults");

            const urlInput = document.getElementById("landingPageUrl").value;
            const auditKeyword = document.getElementById("landingPageAuditKeyword")?.value || null;

            // Check if the URL input is empty
            if (!urlInput || urlInput.trim() === "") {
                alert("Please enter a landing page URL.");
                document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
                return;
            }

            // Send combined responses to the second API
            try {
                const landingPageAuditResponse = await fetch("https://llufeecqoe.execute-api.ap-southeast-1.amazonaws.com/auditLandingPage", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        url: urlInput,
                        keyword: auditKeyword
                    })
                });

                if (!landingPageAuditResponse.ok) {
                    const errorText = await landingPageAuditResponse.text();
                    throw new Error(`HTTP error! status: ${landingPageAuditResponse.status} - ${errorText}`);
                }

                const landingPageAuditData = await landingPageAuditResponse.json();

                if (landingPageAuditData && landingPageAuditData.body) {
                    landingPageAuditResultDiv.innerHTML = landingPageAuditData.body; // Removed +=
                    const gaugeElement = document.querySelector(".gauge");
                    quality_score = landingPageAuditData.quality_score;
                    setGaugeValue(gaugeElement, quality_score / 10);
                    document.getElementById("gauge").style.display = "block";
                } else {
                    landingPageAuditResultDiv.innerHTML = "<p>No results found.</p>";
                }

            } catch (error) {
                landingPageAuditResultDiv.innerHTML = `<p style="color: red;">Error landing page audit API: ${error.message}</p>`;
                console.error("Error sending data to landing page audit API:", error);
            } finally {
                document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
                document.getElementById("landingPageAuditBtn").style.backgroundColor = "green";
                updateCollapsibleState('landingPageAuditBtn', 'success');
            }
        }

        function setGaugeValue(gauge, value) {
            if (value < 0 || value > 1) {
                return;
            }

            const fillElement = gauge.querySelector(".gauge__fill");
            fillElement.style.transform = `rotate(${value / 2}turn)`;
            gauge.querySelector(".gauge__cover").innerHTML = `Quality Score<br>${Math.round(value * 10)}/10`;
        }

        async function generateGoogle() {
            document.getElementById("generateSem").innerText = "Generating...";
            document.getElementById("semButton").style.backgroundColor = "#004c9d";
            updateCollapsibleState('semButton', 'running');
            try {
                const response = await fetch("https://bztsly2z89.execute-api.ap-southeast-1.amazonaws.com/generateSemGoogle", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        country: document.getElementById("sem_country").value,
                        input: document.getElementById("selectedText").value,
                        tone: document.getElementById("sem_tone").value,
                        language: document.getElementById("sem_language").value,
                        type: document.getElementById("ad_format").value
                    })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const responseData = await response.json();
                const body = responseData.body;
                for (const key in body) {
                    if (!generatedData[key]) {
                        generatedData[key] = [];
                    }
                    generatedData[key] = generatedData[key].concat(body[key]); // Concatenate new data
                }
                displaySemGeneratedData(); // Call function to update HTML
                updateCollapsibleState('semButton', 'success');
                document.getElementById("generateSem").innerText = "Step 3: Select checkboxes then click here";
            } catch (error) {
                console.error("Error:", error);
                updateCollapsibleState('semButton', 'error');
                document.getElementById("generated").innerText = "An error occurred. Please check the console for details.";
                document.getElementById("generateSem").innerText = "Step 3: Select checkboxes then click here";
            }
        }
        function displaySemGeneratedData() {
            let generatedHTML = "";
            for (const category in generatedData) {
                if (generatedData[category].length > 0) {
                    if (category == "sitelinks") {
                        generatedHTML += `<h3>${category.replace(/_/g, ' ').toUpperCase()}</h3>`; // Nicer titles
                        generatedHTML += `<table>`;
                        generatedHTML += `<tr><th>Value</th><th>Remove</th></tr>`; // Add remove column header
                        generatedData[category].forEach((item, index) => { // Add index for row removal
                            sitelink = "";
                            for ([key, value] of Object.entries(item)) {
                                sitelink += `${value}<br>`;
                            }
                            generatedHTML += `<tr>
                            <td>${sitelink}</td>
                            <td><span class="remove-row" onclick="removeSemGeneratedRow('${category}', ${index})" onmouseover="" style="cursor: pointer;">X</span></td>
                         </tr>`;
                        });
                    } else {
                        generatedHTML += `<h3>${category.replace(/_/g, ' ').toUpperCase()}</h3>`; // Nicer titles
                        generatedHTML += `<table>`;
                        generatedHTML += `<tr><th>Value</th><th>Remove</th></tr>`; // Add remove column header
                        generatedData[category].forEach((item, index) => { // Add index for row removal
                            generatedHTML += `<tr>
                            <td>${item}</td>
                            <td><span class="remove-row" onclick="removeSemGeneratedRow('${category}', ${index})" onmouseover="" style="cursor: pointer;">X</span></td>
                         </tr>`;
                        });
                    }
                    generatedHTML += `</table>`;
                }
            }
            document.getElementById("generated").innerHTML = generatedHTML;
            document.getElementById("generated").innerHTML = document.getElementById("generated").innerHTML + '<br><button id="downloadSem" onclick="downloadSemCSV()">Download .csv</button>'
            document.getElementById("downloadSem").addEventListener("click", downloadSemCSV);
            document.getElementById("semButton").style.backgroundColor = "green";
        }
        function removeSemGeneratedRow(category, index) {
            generatedData[category].splice(index, 1);
            displaySemGeneratedData(); // Redraw the table
        }

        function downloadResultsAsXlsx() {
            const wb = XLSX.utils.book_new();

            // Add auditSummary tab
            const auditSummaryTables = document.getElementById('auditSummary').querySelectorAll('table');
            let auditSummaryData = [];

            auditSummaryTables.forEach((table, tableIndex) => {
                const tableData = extractTableData(table);

                // Add a blank row between tables (if it's not the first table)
                if (tableIndex > 0) {
                    auditSummaryData.push([]);
                }
                auditSummaryData = auditSummaryData.concat(tableData);
            });

            const auditSummaryWS = XLSX.utils.aoa_to_sheet(auditSummaryData);
            XLSX.utils.book_append_sheet(wb, auditSummaryWS, 'auditSummary');

            // Add gtMetrix tab
            const gtMetrixData = extractTableData(document.getElementById('gtmetrixReport').querySelector('table'));
            const gtMetrixWS = XLSX.utils.aoa_to_sheet(gtMetrixData);
            XLSX.utils.book_append_sheet(wb, gtMetrixWS, 'gtMetrix');

            // Add pageAnalysis tab
            const pageAnalysisData = extractTableData(document.getElementById('pageAuditReport').querySelector('table'));
            const pageAnalysisWS = XLSX.utils.aoa_to_sheet(pageAnalysisData);
            XLSX.utils.book_append_sheet(wb, pageAnalysisWS, 'pageAnalysis');


            // Add crawlerSection tab
            const crawlerData = extractTableData(document.getElementById('crawlerReport').querySelector('table'));
            const crawlerWS = XLSX.utils.aoa_to_sheet(crawlerData);
            XLSX.utils.book_append_sheet(wb, crawlerWS, 'crawlerSection');

            XLSX.writeFile(wb, 'technical_seo_results.xlsx');
        }

        function extractTableData(table) {
            const data = [];
            const rows = table.querySelectorAll('tr');

            rows.forEach(row => {
                const rowData = [];
                const cells = row.querySelectorAll('th, td');
                cells.forEach(cell => {
                    // Get text content, handling potential HTML inside cells
                    let cellText = cell.textContent.trim();
                    if (!cellText && cell.innerHTML) {
                        cellText = cell.innerHTML.replace(/<[^>]*>/g, "").trim();
                    }

                    rowData.push(cellText);
                });
                data.push(rowData);
            });
            return data;
        }

        function updateUI(isLoggedIn) {
            document.getElementById('loginForm').style.display = isLoggedIn ? 'none' : 'flex';
            document.getElementById('main-content').style.display = isLoggedIn ? 'block' : 'none';
            //document.getElementById('navbar').style.display = isLoggedIn ? 'block' : 'none';
        }


        function openSeo(event) {
            event.preventDefault();
            deactivateAllButtons();
            const seoButton = document.querySelector('button#seo');

            const icon = document.getElementById('seo').querySelector('i');
            if (icon && icon.classList.contains('fa-plus-square')) {
                icon.classList.remove('fa-plus-square');
                icon.classList.add('fa-minus-square');
            }
            if (seoButton) {
                seoButton.classList.toggle('active');
                const content = seoButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const keywordAnalysisLink = event.currentTarget;
                keywordAnalysisLink.classList.toggle('active-menu');

            };
            closeJourneyModal();
        }

        async function checkContent() {
            const brandGuideUrlsText = document.getElementById('brand_guide_urls').value || "";
            const otherUrlsText = document.getElementById('content_check_other_urls').value || "";
            const instructions = document.getElementById('content_check_instructions').value || "";
            const content = document.getElementById('content_to_check').value;
            document.getElementById("openFeedbackModalBtn").style.display = "none";
            document.getElementById("copy-check-results-button").style.display = "none";

            document.getElementById("contentCheckBtn").innerText = "Checking...";
            document.getElementById("checkContentResults").innerHTML = "";
            document.getElementById("contentcheck").style.backgroundColor = "#004c9d";

            // **Check if the content field is blank**
            if (!content || content.trim() === "") {
                alert("Please enter content to check.");
                document.getElementById("contentCheckBtn").innerText = "Check Content"; // Reset button text
                return;
            }


            // Split URLs by commas or newlines, and trim whitespace
            const brandGuideUrls = brandGuideUrlsText.split(/[, \n]+/).filter(url => url.trim() !== "");  //filter is important to remove empty strings
            const otherUrls = otherUrlsText.split(/[, \n]+/).filter(url => url.trim() !== ""); //filter is important to remove empty strings

            const allUrls = [...brandGuideUrls, ...otherUrls];  // Combine the arrays

            if (allUrls.length === 0) {
                console.warn("No URLs provided.");
                alert("Please enter at least one URL."); // Optional: provide user feedback
                document.getElementById("contentCheckBtn").innerText = "Check Content"; // Reset button text
                return;
            }

            // API endpoints
            const pdfParserApiUrl = "https://i3oxhgicub.execute-api.ap-southeast-1.amazonaws.com/pdfParser";
            const checkContentApiUrl = "https://mmyvj7yj11.execute-api.ap-southeast-1.amazonaws.com/checkContent";
            const contentParsingApiUrl = "https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing"; // Added content parsing API URL

            try {
                // Create an array of promises for the brand guide URLs API calls
                const brandGuideFetchPromises = brandGuideUrls.map(async url => {
                    try {
                        const response = await fetch(pdfParserApiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ url: url })
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`Error fetching URL ${url}: ${response.status} - ${errorText}`);
                            alert("The brand guide(s) failed to load successfully.");
                            throw new Error(`Failed to fetch ${url}: ${response.status} - ${errorText}`);
                        }

                        const data = await response.json();
                        return data;
                    } catch (error) {
                        console.error(`Error processing URL ${url}:`, error);
                        alert("The brand guide(s) failed to load successfully.");
                        return { url: url, error: error.message };
                    }
                });

                // Create an array of promises for the other URLs API calls to contentParsing endpoint
                const otherUrlsFetchPromises = otherUrls.map(async url => {
                    try {
                        const response = await fetch(contentParsingApiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ url: url })
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`Error fetching URL ${url}: ${response.status} - ${errorText}`);
                            alert("The URL(s) failed to load successfully.");
                            throw new Error(`Failed to fetch ${url}: ${response.status} - ${errorText}`);
                        }

                        const data = await response.json();
                        return data;
                    } catch (error) {
                        console.error(`Error processing URL ${url}:`, error);
                        alert("The URL(s) failed to load successfully.");
                        return { url: url, error: error.message };
                    }
                });


                // Use Promise.all to wait for all API calls to complete
                const brandGuideResults = await Promise.all(brandGuideFetchPromises);
                const otherUrlsResults = await Promise.all(otherUrlsFetchPromises);

                // Combine the responses from pdfParser API calls
                let combinedResponseFromBrandGuide = {};
                brandGuideResults.forEach((result, index) => {
                    combinedResponseFromBrandGuide[brandGuideUrls[index]] = result;  // Use the URL as the key for each response.  Important that allUrls[index] is used instead of result.url because result might be an error object without a .url field.
                });

                // Combine the responses from contentParsing API calls, extracting 'body'
                let combinedResponseFromOtherSources = {};
                otherUrlsResults.forEach((result, index) => {
                    if (result && result.body) {
                        combinedResponseFromOtherSources[otherUrls[index]] = result.body;
                    } else {
                        // Handle the case where 'body' is missing or result is an error object
                        combinedResponseFromOtherSources[otherUrls[index]] = result && result.error ? result.error : "No content"; //Store the error message in the combined response, so the user sees the error message on the UI
                        console.warn(`No 'body' found in the response from ${otherUrls[index]}`);
                    }
                });

                console.log("Combined Responses from brandGuideParser:", combinedResponseFromBrandGuide);
                console.log("Combined Responses from otherSources:", combinedResponseFromOtherSources);


                // Now, send the combined response to the checkContent API
                try {
                    const checkContentResponse = await fetch(checkContentApiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            "brand_guide": combinedResponseFromBrandGuide,
                            "instructions": instructions,
                            "content": content,
                            "other_sources": combinedResponseFromOtherSources  // Changed to the combined other sources response
                        })
                    });

                    if (!checkContentResponse.ok) {
                        const errorText = await checkContentResponse.text();
                        console.error(`Error calling checkContent API: ${checkContentResponse.status} - ${errorText}`);
                        throw new Error(`Failed to call checkContent API: ${checkContentResponse.status} - ${errorText}`);
                    }

                    const checkContentData = await checkContentResponse.json();
                    console.log("Response from checkContent API:", checkContentData);
                    // Display the response body to the user (e.g., in a div)
                    displayCheckContentResults(checkContentData['body']); // Implement this function to show the results
                    document.getElementById("contentcheck").style.backgroundColor = "green";
                } catch (checkContentError) {
                    console.error("Error calling checkContent API:", checkContentError);
                    alert("Error occurred while calling the checkContent API. See console for details.");
                }

            } catch (error) {
                console.error("An error occurred during the API calls:", error);
                alert("An error occurred while checking the content. See console for details."); // Provide user feedback
            }
            document.getElementById("contentCheckBtn").innerText = "Check Content"
        }

        function displayCheckContentResults(data) {
            // This function assumes you have an element with id "checkContentResults" to display the data.
            const resultsDiv = document.getElementById("checkContentResults");
            if (!resultsDiv) {
                console.warn("No element with id 'checkContentRsdfsdfsfesults' found to display the results.");
                return;
            }

            // Convert the data to a readable string (you might want to format it better)
            const formattedData = JSON.stringify(data, null, 2); // Pretty print JSON

            // Set the content of the results div
            resultsDiv.innerHTML = formattedData.replaceAll('"', '');
            document.getElementById("openFeedbackModalBtn").style.display = "block";
            document.getElementById("copy-check-results-button").style.display = "block";
        }


        function logout() {
            // Clear Google login
            if (googleUser) {
                google.accounts.id.revoke(googleUser.id_token, () => {
                    console.log('Google account revoked');
                });
                googleUser = null;
                localStorage.removeItem('googleUser');
            }

            // Clear login cookie
            document.cookie = "key=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

            updateUI(false);
            document.getElementById('loginError').textContent = "You have been logged out.";
            document.getElementById('loginForm').style.display = 'flex';
        }
        document.addEventListener('DOMContentLoaded', function () {
            const seoLink = document.getElementById('seo-link');
            const seoSubmenu = document.getElementById('seo-submenu');
            const smmLink = document.getElementById('smm-link');
            const smmSubmenu = document.getElementById('smm-submenu');
        });

        function downloadOverallSummaryTableAsCSV() {
            // CSV content
            const csvRows = [];

            // Add BOM (Byte Order Mark) for UTF-8 encoding, crucial for international characters
            const bom = "\uFEFF";

            // Headers - IMPORTANT:  Explicitly define the order.  This matches the table columns.
            const headers = ['No.', 'Keyword', 'Search Volume', 'CPC', 'Time to Rank', 'Reason', 'Mapping'];
            csvRows.push(headers.join(','));

            // Data rows
            summaryData.forEach(item => {
                const values = [
                    item.No,
                    item.keyword,
                    item.search_volume,
                    item.cpc,
                    item.timeToRank,
                    item.reason,
                ];
                // Use .map() and double quotes to handle commas and special characters
                const row = values.map(value => `"${String(value).replace(/"/g, '""')}"`).join(','); //IMPORTANT: Escape double quotes within the string
                csvRows.push(row);
            });


            // Create the CSV string
            const csvString = bom + csvRows.join('\n');


            // Create a download link
            const blob = new Blob([csvString], {
                type: 'text/csv;charset=utf-8'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'keyword_summary.csv');
            a.style.display = 'none'; // Hide the link

            // Programmatically trigger the download
            document.body.appendChild(a);
            a.click();

            // Clean up
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        async function getWebpageKeywords() {
            const location = document.getElementById('location').value;
            const language = document.getElementById('language').value;
            const target = document.getElementById('domain').value;

            if (target == "") {
                alert("Please enter a Domain / URL");
                return; // Important: Exit the function if target is empty
            }

            document.getElementById("keywords_for_site").style.backgroundColor = "#004c9d";
            document.getElementById("expandWebpageKeywords").style.backgroundColor = "#004c9d";
            document.getElementById('keywords_for_site').innerText = "Getting Webpage Keywords...";
            updateCollapsibleState('keywords_for_site', 'running');

            const endpoint = "https://ei6xj9x2rd.execute-api.ap-southeast-1.amazonaws.com/keywordsForSite";

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        location: location,
                        language: language,
                        target: target
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log(data);
                allKeywords = Object.entries(data).map(([keyword, values]) => ({
                    keyword,
                    search_volume: values.search_volume,
                    competition: values.competition,
                    search_intent: values.search_intent,
                    reason_for_choosing: values.reason_for_choosing
                }));

                displayKeywordsTable(allKeywords);
                updateKeywordCount(); //added to update the keyword count paragraph
                document.getElementById('keywords_for_site').innerText = "Keywords Based on Webpage Content";
                document.getElementById("keywords_for_site").style.backgroundColor = "green";
                updateCollapsibleState('keywords_for_site', 'success');
                document.getElementById("expandWebpageKeywords").style.backgroundColor = "green";

                const siteKeywordsDiv = document.getElementById("siteKeywords");
                const icon = document.getElementById("expandWebpageKeywords").querySelector('i');

                if (siteKeywordsDiv.style.display === "block") {
                } else {
                    siteKeywordsDiv.style.display = "block";
                    icon.classList.remove('fa-plus-square');
                    icon.classList.add('fa-minus-square');
                }


            } catch (error) {
                console.error("Error fetching keywords:", error);
                updateCollapsibleState('keywords_for_site', 'error');
                document.getElementById('keywords_for_site').innerText = "Keywords Based on Webpage Content";
                document.getElementById('rankingError').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }

        }

        function displayKeywordsTable(keywords) {
            const container = document.getElementById('siteKeywords');

            if (!container) {
                console.error("Keywords container not found");
                return;
            }
            //ADD A PARAGRAPH TO TRACK SELECTED KEYWORDS
            container.innerHTML = `
            <div class="table-container" style="max-height:250px; overflow-y: auto; overflow-x: hidden; border: 1px solid #e0e6ed; border-radius: 8px;">
              <table class="uniform-kw-table fixed-layout">
                <thead>
                    <tr>
                        <th class="col-kw" onclick="sortSiteTable('keyword')">Keyword</th>
                        <th class="col-vol" onclick="sortSiteTable('search_volume')">Search Vol</th>
                        <th class="col-comp" onclick="sortSiteTable('competition')">Comp.</th>
                        <th class="col-intent" onclick="sortSiteTable('search_intent')">Intent</th>
                        <th class="col-reason" onclick="sortSiteTable('reason_for_choosing')">Reason</th>
                        <th class="col-choose">Choose</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
        `;

            const tbody = container.querySelector('tbody');

            keywords.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                        <td>${item.keyword}</td>
                        <td>${item.search_volume != null ? item.search_volume.toLocaleString() : '-'}</td>
                        <td>${item.competition || '-'}</td>
                        <td>${item.search_intent || '-'}</td>
                        <td>${item.reason_for_choosing || '-'}</td>
                        <td style="text-align: center;"><input type="checkbox" value="${item.keyword}" onchange="updateSiteKeywords(this)"></td>
                    `;
                tbody.appendChild(row);
            });
            updateKeywordCount()
            document.getElementById('siteKeywords').innerHTML += '<br><button type="button" onclick="exportSiteKeywordsTableToCSV()">Export as .csv</i></button>';
        }

        function updateSiteKeywords(checkbox) {
            const keyword = checkbox.value;
            const keywordsInput = document.getElementById('keywords');
            let currentKeywords = keywordsInput.value.trim();

            if (checkbox.checked) {
                if (currentKeywords === "") {
                    keywordsInput.value = keyword;
                } else {
                    keywordsInput.value = currentKeywords + ", " + keyword;
                }
            } else {
                let keywordsArray = currentKeywords.split(',').map(item => item.trim());
                keywordsArray = keywordsArray.filter(item => item !== keyword);
                keywordsInput.value = keywordsArray.join(', ');
            }

            updateKeywordsField(); //update the main keywords field.
            updateKeywordCount(); //count the checkboxes selected in webpagekeywords
        }

        function sortSiteTable(column) {
            if (currentSortColumn === column) {
                sortAscending = !sortAscending;
            } else {
                currentSortColumn = column;
                sortAscending = true;
            }

            allKeywords.sort((a, b) => {
                let comparison = 0;

                if (column === 'keyword') {
                    comparison = a.keyword.localeCompare(b.keyword);
                } else if (column === 'search_volume') {
                    comparison = a.search_volume - b.search_volume;
                } else if (column === 'competition') {
                    comparison = a.competition - b.competition;
                } else if (column === 'search_intent') {
                    comparison = a.search_intent.localeCompare(b.search_intent);
                } else if (column === 'reason_for_choosing') {
                    comparison = a.reason_for_choosing.localeCompare(b.reason_for_choosing);
                }

                return sortAscending ? comparison : comparison * -1;
            });

            displayKeywordsTable(allKeywords);
        }

        function copyCheckContentResults() {
            const resultsDiv = document.getElementById("checkContentResults");

            if (!resultsDiv) {
                console.warn("No element with id 'checkContentResults' found.");
                alert("Content Check results not found.");
                return;
            }

            // Create a temporary element for copying.  This ensures we get ALL the content, including hidden parts.
            const tempElement = document.createElement("div");
            tempElement.innerHTML = resultsDiv.innerHTML; //copy innerHTML (preserves formatting)
            tempElement.style.whiteSpace = "pre-wrap";  // Preserve line breaks and spaces.  Crucial!
            tempElement.style.userSelect = "auto"; // Allow text selection

            document.body.appendChild(tempElement); // Add to the DOM

            // Select the text in the temporary element
            const selection = window.getSelection();
            selection.removeAllRanges();
            const range = document.createRange();
            range.selectNodeContents(tempElement);
            selection.addRange(range);


            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert("Content check results copied to clipboard!.");
                } else {
                    console.error("Failed to copy text.");
                    alert("Failed to copy.  Please try again or manually select and copy the text.");
                }
            } catch (err) {
                console.error('Unable to copy: ' + err);
                alert("An error occurred while copying.  Please try again or manually select and copy the text.");
            } finally {
                document.body.removeChild(tempElement);  // Remove the temporary element
                selection.removeAllRanges(); // Deselect everything
            }
        }

        function copyPersonaResults() {
            const resultsDiv = document.getElementById("persona-results");

            if (!resultsDiv) {
                console.warn("No element with id 'persona-results' found.");
                alert("Perosna results not found.");
                return;
            }

            // Create a temporary element for copying.  This ensures we get ALL the content, including hidden parts.
            const tempElement = document.createElement("div");
            tempElement.innerHTML = resultsDiv.innerHTML; //copy innerHTML (preserves formatting)
            tempElement.style.whiteSpace = "pre-wrap";  // Preserve line breaks and spaces.  Crucial!
            tempElement.style.userSelect = "auto"; // Allow text selection

            document.body.appendChild(tempElement); // Add to the DOM

            // Select the text in the temporary element
            const selection = window.getSelection();
            selection.removeAllRanges();
            const range = document.createRange();
            range.selectNodeContents(tempElement);
            selection.addRange(range);


            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert("Personas copied to clipboard!.");
                } else {
                    console.error("Failed to copy text.");
                    alert("Failed to copy.  Please try again or manually select and copy the text.");
                }
            } catch (err) {
                console.error('Unable to copy: ' + err);
                alert("An error occurred while copying.  Please try again or manually select and copy the text.");
            } finally {
                document.body.removeChild(tempElement);  // Remove the temporary element
                selection.removeAllRanges(); // Deselect everything
            }
        }


        // Get the modal
        var modal = document.getElementById("feedbackModal");

        // Get the button that opens the modal
        var btn = document.getElementById("openFeedbackModalBtn");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("feedback-close")[0];

        // When the user clicks the button, open the modal 
        btn.onclick = function () {
            populateFeedbackModal();
            modal.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function () {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            } else if (event.target == document.getElementById('queriesModal')) {
                closeQueriesModal();
            }
        }


        function populateFeedbackModal() {
            document.getElementById("guidelinesURLs").value = document.getElementById("brand_guide_urls").value;
            document.getElementById("websiteURLs").value = document.getElementById("content_check_other_urls").value;
            document.getElementById("otherInstructions").value = document.getElementById("content_check_instructions").value;
            document.getElementById("contentToCheck").value = document.getElementById("content_to_check").value;
            document.getElementById("checkResults").value = document.getElementById("checkContentResults").textContent;

            // Show the submit feedback button
            document.getElementById("openFeedbackModalBtn").style.display = "block";
        }


        document.getElementById("submitFeedbackBtn").addEventListener("click", function () {
            const feedbackData = {
                guidelinesURLs: document.getElementById("guidelinesURLs").value,
                websiteURLs: document.getElementById("websiteURLs").value,
                otherInstructions: document.getElementById("otherInstructions").value,
                contentToCheck: document.getElementById("contentToCheck").value,
                checkResults: document.getElementById("checkResults").value,
                userFeedback: document.getElementById("userFeedback").value,
                user: JSON.parse(localStorage.getItem('googleUser')).email
            };

            // API Endpoint URL
            const apiUrl = 'https://bj7bexizm7.execute-api.ap-southeast-1.amazonaws.com/contentCheckerFeedback'; // Replace with your actual API endpoint

            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(feedbackData)
            })
                .then(response => {
                    if (response.ok) {
                        alert("Feedback submitted successfully!");
                        document.getElementById("userFeedback").value = ""; // Clear feedback
                        modal.style.display = "none"; // Close the modal
                    } else {
                        alert("Failed to submit feedback.");
                    }
                })
                .catch(error => {
                    console.error("Error submitting feedback:", error);
                    alert("An error occurred while submitting feedback.");
                });
        });

        document.addEventListener('DOMContentLoaded', function () {
            const coll = document.getElementsByClassName("funnel-collapsible-before");

            for (let i = 0; i < coll.length; i++) {
                coll[i].addEventListener("click", function () {
                    const content = this.nextElementSibling;

                    if (this.classList.contains("funnel-collapsible-before")) {
                        // If it's 'collapsible-before', change to 'collapsible' and show content
                        this.classList.remove("funnel-collapsible-before");
                        this.classList.add("funnel-collapsible");
                        content.style.display = "block";
                    } else {
                        // If it's 'collapsible', change back to 'collapsible-before' and hide content
                        this.classList.remove("funnel-collapsible");
                        this.classList.add("funnel-collapsible-before");
                        content.style.display = "none";
                    }
                });
            }
        });

        function sortIntersectionTable(columnName) {
            const table = document.getElementById('intersectionResultsTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Determine sort direction
            let isAscending = true; // Default to ascending

            if (table.dataset.sortColumn === columnName) {
                // Same column clicked again, toggle sort direction
                isAscending = table.dataset.sortDirection === 'desc'; // Reverse
            }

            table.dataset.sortColumn = columnName;
            table.dataset.sortDirection = isAscending ? 'asc' : 'desc'; //Update direction

            // Sort rows
            const sortedRows = rows.sort((rowA, rowB) => {
                const cellA = rowA.querySelector(`td:nth-child(${getColumnIndex(table, columnName) + 1})`);
                const cellB = rowB.querySelector(`td:nth-child(${getColumnIndex(table, columnName) + 1})`);

                const valueA = cellA ? cellA.textContent.trim() : '';
                const valueB = cellB ? cellB.textContent.trim() : '';

                let comparison;
                if (isFinite(valueA) && isFinite(valueB)) {
                    comparison = Number(valueA) - Number(valueB); // Numeric comparison
                } else {
                    comparison = valueA.localeCompare(valueB);  // Text comparison
                }

                return isAscending ? comparison : -comparison; // Apply sort direction
            });

            // Append sorted rows to the tbody
            sortedRows.forEach(row => tbody.appendChild(row));
        }

        function getColumnIndex(table, columnName) {
            const headers = Array.from(table.querySelectorAll('th'));
            for (let i = 0; i < headers.length; i++) {
                if (headers[i].textContent.trim() === columnName) {
                    return i;
                }
            }
            return -1; // Column not found
        }

        function copyInteractionResultsTable() {
            const table = document.getElementById('intersectionResultsTable'); // Get the table element
            if (!table) {
                console.error("Interaction Results Table not found");
                return;
            }

            // Extract table data
            const rows = Array.from(table.querySelectorAll('tr'));
            const tableData = rows.map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                return cells.map(cell => cell.textContent.trim()).join('\t'); // Tab-separated values
            }).join('\n'); // Newline for each row

            // Copy to clipboard
            navigator.clipboard.writeText(tableData)
                .then(() => {
                    alert('Interaction Results Table copied to clipboard! You can now paste it into a spreadsheet.');
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Failed to copy the table. Please try again.');
                });
        }

        // Function to export the interactionResultsTable as a CSV file
        function exportInteractionResultsTableToCSV() {
            const table = document.getElementById('intersectionResultsTable'); // Get the table element
            if (!table) {
                console.error("Interaction Results Table not found");
                return;
            }

            // Extract table data
            const rows = Array.from(table.querySelectorAll('tr'));
            const csvData = rows.map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                return cells.map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`).join(','); // Comma-separated values, escape double quotes
            }).join('\n'); // Newline for each row

            // Add BOM (Byte Order Mark) for UTF-8 encoding, crucial for international characters
            const bom = "\uFEFF";
            const csvString = bom + csvData;

            // Create a download link
            const blob = new Blob([csvString], {
                type: 'text/csv;charset=utf-8'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'interaction_results.csv');
            a.style.display = 'none';

            // Programmatically trigger the download
            document.body.appendChild(a);
            a.click();

            // Clean up
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function exportSiteKeywordsTableToCSV() {
            const table = document.getElementById('siteKeywords'); // Get the table element
            if (!table) {
                console.error("Site Keywords Table not found");
                return;
            }

            // Extract table data
            const rows = Array.from(table.querySelectorAll('tr'));
            const csvData = rows.map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                return cells.map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`).join(','); // Comma-separated values, escape double quotes
            }).join('\n'); // Newline for each row

            // Add BOM (Byte Order Mark) for UTF-8 encoding, crucial for international characters
            const bom = "\uFEFF";
            const csvString = bom + csvData;

            // Create a download link
            const blob = new Blob([csvString], {
                type: 'text/csv;charset=utf-8'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'site_keywords.csv');
            a.style.display = 'none';

            // Programmatically trigger the download
            document.body.appendChild(a);
            a.click();

            // Clean up
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function exportRankedKeywordsToCSV(rankedKeywordHeaderRow, rankedKeywordList) {
            // Helper function to escape CSV values
            function escapeCsvValue(value) {
                if (typeof value !== 'string') {
                    value = String(value); // Convert to string if not already
                }
                return `"${value.replace(/"/g, '""')}"`; // Escape double quotes
            }

            // 1. Extract header texts from the header row
            const headers = Array.from(rankedKeywordHeaderRow.querySelectorAll('.keyword-column strong'))
                .map(th => th.textContent.trim());  //Get header row texts

            // Create header row string
            const csvHeaderRow = headers.map(header => escapeCsvValue(header)).join(',');

            // Initialize CSV content with header row
            let csvContent = csvHeaderRow + '\n';  //BOM for UTF-8 encoding.

            // 2. Loop through the list items in rankedKeywordList to extract data
            const listItems = Array.from(rankedKeywordList.querySelectorAll('li.keyword-row'));  //Get data rows
            listItems.forEach(item => {
                const columns = Array.from(item.querySelectorAll('.keyword-column'));  //Get data cells
                const rowValues = columns.map(column => column.textContent.trim());  //Trim spaces in between
                csvContent += rowValues.map(value => escapeCsvValue(value)).join(',') + '\n';  //Escape cell values then combine with a comma.
            });

            // Add BOM (Byte Order Mark) for UTF-8 encoding, crucial for special characters
            const bom = "\uFEFF";
            csvContent = bom + csvContent;

            // Create a download link element
            const link = document.createElement('a');
            link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));  //Set download properties
            link.setAttribute('download', 'ranked_keywords.csv');
            link.style.display = 'none';

            // Append the link to the document
            document.body.appendChild(link);

            // Trigger the download
            link.click();

            // Remove the link from the document
            document.body.removeChild(link);
        }

        function exportSelectedRankedKeywordsToCSV(rankedKeywordHeaderRow, rankedKeywordList) {
            // Helper function to escape CSV values
            function escapeCsvValue(value) {
                if (typeof value !== 'string') {
                    value = String(value); // Convert to string if not already
                }
                return `"${value.replace(/"/g, '""')}"`; // Escape double quotes
            }

            // 1. Extract header texts from the header row
            const headers = Array.from(rankedKeywordHeaderRow.querySelectorAll('.keyword-column strong'))
                .map(th => th.textContent.trim());

            // Create header row string
            const csvHeaderRow = headers.map(header => escapeCsvValue(header)).join(',');

            // Initialize CSV content with header row
            let csvContent = csvHeaderRow + '\n';

            // 2. Loop through the list items in rankedKeywordList and only export checked rows
            const listItems = Array.from(rankedKeywordList.querySelectorAll('li.keyword-row'));

            listItems.forEach(item => {
                // Check if the checkbox in the row is checked
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    const columns = Array.from(item.querySelectorAll('.keyword-column'));
                    const rowValues = columns.map(column => column.textContent.trim());
                    csvContent += rowValues.map(value => escapeCsvValue(value)).join(',') + '\n';
                }
            });

            // Add BOM (Byte Order Mark) for UTF-8 encoding
            const bom = "\uFEFF";
            csvContent = bom + csvContent;

            // Create a download link element
            const link = document.createElement('a');
            link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));
            link.setAttribute('download', 'ranked_keywords.csv');
            link.style.display = 'none';

            // Append the link to the document
            document.body.appendChild(link);

            // Trigger the download
            link.click();

            // Remove the link from the document
            document.body.removeChild(link);
        }

        function exportSelectedKeywordSuggestionsToCSV(keywordHeaderRow, keywordList) {
            // Helper function to escape CSV values
            function escapeCsvValue(value) {
                if (typeof value !== 'string') {
                    value = String(value); // Convert to string if not already
                }
                return `"${value.replace(/"/g, '""')}"`; // Escape double quotes
            }

            // 1. Extract header texts from the header row
            const headers = Array.from(keywordHeaderRow.querySelectorAll('.keyword-column strong'))
                .map(th => th.textContent.trim());

            // Create header row string
            const csvHeaderRow = headers.map(header => escapeCsvValue(header)).join(',');

            // Initialize CSV content with header row
            let csvContent = csvHeaderRow + '\n';

            // 2. Loop through the list items in rankedKeywordList and only export checked rows
            const listItems = Array.from(keywordList.querySelectorAll('li.keyword-row'));

            listItems.forEach(item => {
                // Check if the checkbox in the row is checked
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    const columns = Array.from(item.querySelectorAll('.keyword-column'));
                    const rowValues = columns.map(column => column.textContent.trim());
                    csvContent += rowValues.map(value => escapeCsvValue(value)).join(',') + '\n';
                }
            });

            // Add BOM (Byte Order Mark) for UTF-8 encoding
            const bom = "\uFEFF";
            csvContent = bom + csvContent;

            // Create a download link element
            const link = document.createElement('a');
            link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));
            link.setAttribute('download', 'keyword_ideas.csv');
            link.style.display = 'none';

            // Append the link to the document
            document.body.appendChild(link);

            // Trigger the download
            link.click();

            // Remove the link from the document
            document.body.removeChild(link);
        }

        function exportKeywordSuggestionsToCSV(keywordHeaderRow, keywordList) {
            // Helper function to escape CSV values
            function escapeCsvValue(value) {
                if (typeof value !== 'string') {
                    value = String(value); // Convert to string if not already
                }
                return `"${value.replace(/"/g, '""')}"`; // Escape double quotes
            }

            // 1. Extract header texts from the header row
            const headers = Array.from(keywordHeaderRow.querySelectorAll('.keyword-column strong'))
                .map(th => th.textContent.trim());  //Get header row texts

            // Create header row string
            const csvHeaderRow = headers.map(header => escapeCsvValue(header)).join(',');

            // Initialize CSV content with header row
            let csvContent = csvHeaderRow + '\n';  //BOM for UTF-8 encoding.

            // 2. Loop through the list items in rankedKeywordList to extract data
            const listItems = Array.from(keywordList.querySelectorAll('li.keyword-row'));  //Get data rows
            listItems.forEach(item => {
                const columns = Array.from(item.querySelectorAll('.keyword-column'));  //Get data cells
                const rowValues = columns.map(column => column.textContent.trim());  //Trim spaces in between
                csvContent += rowValues.map(value => escapeCsvValue(value)).join(',') + '\n';  //Escape cell values then combine with a comma.
            });

            // Add BOM (Byte Order Mark) for UTF-8 encoding, crucial for special characters
            const bom = "\uFEFF";
            csvContent = bom + csvContent;

            // Create a download link element
            const link = document.createElement('a');
            link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));  //Set download properties
            link.setAttribute('download', 'keyword_ideas.csv');
            link.style.display = 'none';

            // Append the link to the document
            document.body.appendChild(link);

            // Trigger the download
            link.click();

            // Remove the link from the document
            document.body.removeChild(link);
        }

        function logConversation(question, generated_answer, feedback, suggested_answer, conversation_id) {
            let user;
            try {
                user = JSON.parse(localStorage.getItem('googleUser')).email;
            } catch (error) {
                console.error("Error parsing user from local storage", error);
                return; // Early exit if user cannot be determined
            }

            fetch('https://7spo2afb9i.execute-api.ap-southeast-1.amazonaws.com/chatbotLogger', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    question: question,
                    generated_answer: generated_answer,
                    feedback: feedback || "",
                    suggested_answer: suggested_answer || "",
                    conversation_id: conversation_id,
                    user: user,
                    is_feedback: "no"
                })
            })
                .then(response => {
                    if (!response.ok) {
                        // Handle HTTP errors (4xx, 5xx status codes)
                        console.error("HTTP error!", response.status, response.statusText);
                        throw new Error(`HTTP error! ${response.status} ${response.statusText}`); //Re-throw to be caught in the .catch block

                    }
                    return response.json(); // Parse JSON body if the request is successful
                })
                .then(data => {
                    console.log("Conversation logged successfully:", data); //Log successful response
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    // Log the error message to the console, and potentially display it to the user

                });
        }


        // ---------------------------------------------------------
        // REVAMPED CHATBOT LOGIC
        // ---------------------------------------------------------

        let input_messages_chat = [];
        let conversation_id_chat = "";
        let userName_chat = "";
        let userEmail_chat = "";
        let userPhoto_chat = "";
        let selectedFiles_chat = [];

        // Load user info
        try {
            const googleChatUser = JSON.parse(localStorage.getItem('googleUser'));
            if (googleChatUser) {
                userName_chat = googleChatUser.name;
                userEmail_chat = googleChatUser.email;
                userPhoto_chat = googleChatUser.picture;
            }
        } catch (e) { console.error("Chat user load error", e); }

        document.addEventListener('DOMContentLoaded', () => {
            const chatMessages_chat = document.getElementById('chat-messages');
            const questionInput_chat = document.getElementById('question-input');
            const sendButton_chat = document.getElementById('send-button-2');
            const typingIndicator_chat = document.getElementById('typingIndicator');
            const chatbotModal_chat = document.getElementById('chatbot-modal');
            const chatbotButton_chat = document.getElementById('chatbot-button');
            const conversationList_chat = document.getElementById('conversation-list');
            const currentChatTitle_chat = document.getElementById('current-chat-title');
            const closeChatbotButton_chat = document.getElementById('close-chatbot');

            let isChatbotOpen_chat = false;

            chatbotButton_chat.addEventListener('click', () => {
                isChatbotOpen_chat = !isChatbotOpen_chat;
                chatbotModal_chat.style.display = isChatbotOpen_chat ? 'flex' : 'none';
                if (isChatbotOpen_chat && conversation_id_chat === "" && chatMessages_chat.innerHTML === "") {
                    startNewConversation();
                }
            });

            closeChatbotButton_chat.addEventListener('click', () => {
                chatbotModal_chat.style.display = 'none';
                isChatbotOpen_chat = false;
            });

            sendButton_chat.addEventListener('click', sendMessage_chat);
            questionInput_chat.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage_chat();
            });

            // Handle Paste for Images
            questionInput_chat.addEventListener('paste', function (event) {
                const items = (event.clipboardData || event.originalEvent.clipboardData).items;
                let hasImage = false;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf("image") !== -1) {
                        const blob = items[i].getAsFile();
                        if (blob) {
                            hasImage = true;
                            const timestamp = new Date().getTime();
                            const fileName = `pasted-image-${timestamp}.png`;
                            const file = new File([blob], fileName, { type: blob.type });
                            selectedFiles_chat.push(file);
                        }
                    }
                }
                if (hasImage) {
                    renderAttachmentPreview_chat();
                }
            });

            // Image Modal Close Logic
            const modal_chat = document.getElementById("image-modal-chat");
            const closeModal_chat = document.getElementById("close-modal-chat");
            if (closeModal_chat) {
                closeModal_chat.onclick = function () { modal_chat.style.display = "none"; }
            }
            if (modal_chat) {
                modal_chat.onclick = function (e) { if (e.target === modal_chat) modal_chat.style.display = "none"; }
            }

            function renderAttachmentPreview_chat() {
                const previewContainer = document.getElementById('attachment-preview-chat');
                if (!previewContainer) return;
                previewContainer.innerHTML = '';
                selectedFiles_chat.forEach((file, index) => {
                    const item = document.createElement('div');
                    item.className = 'attachment-item';

                    if (file.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.className = 'attachment-thumb';
                        img.src = URL.createObjectURL(file);
                        img.onload = () => URL.revokeObjectURL(img.src);
                        item.appendChild(img);
                    } else {
                        const div = document.createElement('div');
                        div.className = 'attachment-icon-placeholder';
                        div.textContent = file.name.split('.').pop().substring(0, 4).toUpperCase();
                        item.appendChild(div);
                    }

                    const removeBtn = document.createElement('div');
                    removeBtn.className = 'attachment-remove-btn';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = () => {
                        selectedFiles_chat.splice(index, 1);
                        renderAttachmentPreview_chat();
                    };
                    item.appendChild(removeBtn);
                    previewContainer.appendChild(item);
                });
            }

            const convertToBase64_chat = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve({
                        name: file.name,
                        type: file.type,
                        data: reader.result.split(',')[1]
                    });
                    reader.onerror = error => reject(error);
                });
            };

            async function sendMessage_chat() {
                const messageText = questionInput_chat.value.trim();
                const hasAttachments = selectedFiles_chat.length > 0;

                if (!messageText && !hasAttachments) return;

                // 1. Process Attachments
                let attachmentsPayload = [];
                let localDisplayContent = [];

                if (messageText) localDisplayContent.push({ type: "text", text: messageText });

                if (hasAttachments) {
                    try {
                        attachmentsPayload = await Promise.all(selectedFiles_chat.map(file => convertToBase64_chat(file)));
                        attachmentsPayload.forEach(att => {
                            if (att.type.startsWith("image/")) {
                                localDisplayContent.push({ type: "image_url", image_url: `data:${att.type};base64,${att.data}` });
                            } else {
                                localDisplayContent.push({ type: "text", text: `[File: ${att.name}]` });
                            }
                        });
                    } catch (err) {
                        console.error("Error processing attachments", err);
                        alert("Error reading attached files.");
                        return;
                    }
                }

                // 2. Display Message Locally
                displayMessage_chat(localDisplayContent, 'user');

                // 3. Reset UI
                questionInput_chat.value = '';
                selectedFiles_chat = [];
                renderAttachmentPreview_chat();

                input_messages_chat.push({ role: "user", content: localDisplayContent });
                displayTypingIndicator_chat();

                try {
                    const response = await fetch("https://8q9qwp4ytd.execute-api.ap-southeast-1.amazonaws.com/gptResponses2", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            question: messageText || "Image shared",
                            input_messages: input_messages_chat,
                            attachments: attachmentsPayload
                        }),
                    });
                    const data = await response.json();
                    await processData_chat(data);
                } catch (error) {
                    console.error("Chat error:", error);
                    hideTypingIndicator_chat();
                    displayMessage_chat("Error: Could not get response.", "bot");
                }
            }

            async function processData_chat(data) {
                input_messages_chat = data.input_messages || input_messages_chat;
                const hasFunctions = Array.isArray(data.functions) && data.functions.length > 0;

                if (!hasFunctions) {
                    const answer = typeof data.answer === "string" ? data.answer : "Sorry, I couldn't get an answer.";
                    displayMessage_chat(answer, "bot");
                    saveConversation_chat();
                    hideTypingIndicator_chat();
                    return;
                }

                try {
                    typingIndicator_chat.innerHTML = '<span style="color:#004c9d;"><i class="fas fa-cog fa-spin"></i> Researching...</span>';
                    typingIndicator_chat.style.display = 'block';

                    for (const fn of data.functions) {
                        const [name, args, call_id] = fn;
                        const result = await call_function_chat(name, args);

                        if (!conversation_id_chat && (!localStorage.getItem("chat_title") || localStorage.getItem("chat_title") === "New Conversation")) {
                            localStorage.setItem("chat_title", name);
                            currentChatTitle_chat.innerText = name;
                        }

                        input_messages_chat.push({
                            type: "function_call_output",
                            call_id: call_id,
                            output: JSON.stringify(result),
                        });
                    }
                    await returnFunctionResult_chat();
                } catch (err) {
                    console.error("Function error:", err);
                    hideTypingIndicator_chat();
                    displayMessage_chat("Error during tool execution.", "bot");
                }
            }

            async function returnFunctionResult_chat() {
                try {
                    const resp = await fetch("https://8q9qwp4ytd.execute-api.ap-southeast-1.amazonaws.com/gptResponses2", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ input_messages: input_messages_chat }),
                    });
                    const data = await resp.json();
                    await processData_chat(data);
                } catch (e) { console.error("Return result error", e); hideTypingIndicator_chat(); }
            }

            function displayMessage_chat(content, sender) {
                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper ${sender}`;
                const msg = document.createElement('div');
                msg.className = `message ${sender}`;
                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                avatar.innerHTML = sender === 'bot' ? '<i class="fas fa-robot"></i>' : (userPhoto_chat ? `<img src="${userPhoto_chat}">` : '<i class="fas fa-user"></i>');
                msg.appendChild(avatar);

                if (typeof content === 'string') {
                    msg.innerHTML += content.replace(/\n/g, '<br>');
                } else if (Array.isArray(content)) {
                    content.forEach(item => {
                        if (item.type === 'text') {
                            const p = document.createElement('span');
                            p.innerHTML = item.text.replace(/\n/g, '<br>');
                            msg.appendChild(p);
                        } else if (item.type === 'image_url') {
                            const img = document.createElement('img');
                            img.src = item.image_url;
                            img.onclick = function () {
                                document.getElementById("modal-img-chat").src = this.src;
                                document.getElementById("image-modal-chat").style.display = "block";
                            };
                            msg.appendChild(img);
                        }
                    });
                } else {
                    msg.innerHTML += JSON.stringify(content).replace(/\n/g, '<br>');
                }

                wrapper.appendChild(msg);
                chatMessages_chat.appendChild(wrapper);
                chatMessages_chat.scrollTop = chatMessages_chat.scrollHeight;
            }

            function displayTypingIndicator_chat() {
                typingIndicator_chat.style.display = 'block';
                chatMessages_chat.scrollTop = chatMessages_chat.scrollHeight;
            }

            function hideTypingIndicator_chat() {
                typingIndicator_chat.style.display = 'none';
            }

            window.startNewConversation = function () {
                chatMessages_chat.innerHTML = "";
                input_messages_chat = [];
                conversation_id_chat = "";
                currentChatTitle_chat.innerText = "New Conversation";
                localStorage.setItem("chat_title", "New Conversation");
                displayMessage_chat("Hello! I am your Digimetrics AI assistant. How can I help you today?", "bot");
                displayOptions_chat();
                loadPastConversations_chat();
            };

            function displayOptions_chat() {
                const optionsMessage = document.createElement("div");
                optionsMessage.className = "message bot";
                optionsMessage.style.marginBottom = "10px";
                optionsMessage.innerHTML = "Which area would you like to explore today?";

                const pathwayOne = [
                    {
                        header: "Focus",
                        options: [
                            { label: "SEO", value: "I would like to look at SEO today", icon: "fa-rocket" },
                            { label: "GEO", value: "I would like to look at GEO today", icon: "fa-brain" },
                            { label: "Paid Ads", value: "I would like to look at Paid Ads today", icon: "fa-ad" },
                            { label: "Social", value: "I would like to look at social media today", icon: "fa-share-nodes" }
                        ],
                    },
                ];

                pathwayOne.forEach((section) => {
                    const sectionDiv = document.createElement("div");
                    sectionDiv.className = "option-section";
                    sectionDiv.style.marginTop = "10px";

                    const btnContainer = document.createElement("div");
                    btnContainer.className = "button-container";
                    btnContainer.style.display = "flex";
                    btnContainer.style.flexWrap = "wrap";
                    btnContainer.style.gap = "5px";
                    btnContainer.style.marginTop = "5px";

                    section.options.forEach((opt) => {
                        const btn = document.createElement("button");
                        btn.style.cssText = "background:#fff; border:1px solid #ccc; padding:5px 10px; border-radius:15px; cursor:pointer; font-size:0.8rem;";
                        btn.innerHTML = `<i class="fas ${opt.icon}"></i> ${opt.label}`;
                        btn.onclick = () => {
                            questionInput_chat.value = opt.value;
                            sendMessage_chat();
                        };
                        btnContainer.appendChild(btn);
                    });
                    sectionDiv.appendChild(btnContainer);
                    optionsMessage.appendChild(sectionDiv);
                });

                const wrapper = document.createElement('div');
                wrapper.className = "message-wrapper bot";
                wrapper.appendChild(optionsMessage);
                chatMessages_chat.appendChild(wrapper);
                chatMessages_chat.scrollTop = chatMessages_chat.scrollHeight;
            }

            window.filterConversations = function () {
                const filter = document.getElementById('searchInput').value.toLowerCase();
                const items = conversationList_chat.getElementsByClassName('conversation-item');
                for (let item of items) {
                    item.style.display = item.innerText.toLowerCase().includes(filter) ? "" : "none";
                }
            };

            async function loadPastConversations_chat() {
                conversationList_chat.innerHTML = '<div style="padding:10px; font-size:0.8rem;">Loading...</div>';
                try {
                    const resp = await fetch("https://ro2g6qodt1.execute-api.ap-southeast-1.amazonaws.com/chatbotPastConversations", {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ user: userEmail_chat })
                    });
                    const convs = await resp.json();
                    conversationList_chat.innerHTML = "";
                    convs.forEach(c => {
                        const div = document.createElement("div");
                        div.className = "conversation-item";
                        div.onclick = () => loadConversationById_chat(c.id);
                        div.innerHTML = `<div class="name">${c.title}</div><div class="latest-message">${c.last_updated.split(' ')[0]}</div>`;
                        conversationList_chat.appendChild(div);
                    });
                } catch (e) { conversationList_chat.innerHTML = "Error loading history"; }
            }

            async function loadConversationById_chat(id) {
                chatMessages_chat.innerHTML = '<div style="padding:20px; text-align:center;"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
                try {
                    const resp = await fetch("https://ro2g6qodt1.execute-api.ap-southeast-1.amazonaws.com/chatbotPastConversations", {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ conversation_id: id })
                    });
                    const data = await resp.json();
                    conversation_id_chat = id;
                    input_messages_chat = data.messages;
                    currentChatTitle_chat.innerText = data.title;
                    chatMessages_chat.innerHTML = "";
                    data.messages.filter(m => m.role === 'user' || m.role === 'assistant').forEach(m => {
                        displayMessage_chat(m.content, m.role === 'user' ? 'user' : 'bot');
                    });
                } catch (e) { console.error(e); }
            }

            async function saveConversation_chat() {
                if (input_messages_chat.length < 2) return;
                try {
                    const resp = await fetch("https://8i8tbru5m2.execute-api.ap-southeast-1.amazonaws.com/createUpdateConversation", {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            user: userEmail_chat,
                            conversation_id: conversation_id_chat,
                            messages: input_messages_chat,
                            title: currentChatTitle_chat.innerText
                        })
                    });
                    const out = await resp.json();
                    if (!conversation_id_chat) conversation_id_chat = out;
                    loadPastConversations_chat();
                } catch (e) { console.error("Save error", e); }
            }

            async function call_function_chat(name, args) {
                switch (name) {
                    case "get_serps": return await get_serps_chat(args.keyword, args.language, args.location);
                    case "rank_checker": return await rank_checker_chat(args.keyword, args.language, args.location, args.target);
                    case "moz": return await moz_chat(args.domain);
                    case "gtMetrix": return await gtMetrix_chat(args.target);
                    case "keyword_metrics": return await keyword_metrics_chat(args.keywords, args.location, args.language);
                    case "scrape_webpage": return await scrape_webpage_chat(args.url);
                    case "ranking_keywords": return await ranking_keywords_chat(args.target, args.location);
                    case "similar_keywords": return await similar_keywords_chat(args.keywords, args.language, args.location);
                    case "keywords_for_site": return await keywords_for_site_chat(args.target, args.language, args.location);
                    case "crawler": return await crawler_chat(args.url, args.max_pages);
                    case "persona_generator": return await persona_generator_chat(args.data, args.manual);
                    case "media_plan_generator": return await media_plan_generator_chat(args.data);
                    case "landing_page_audit": return await landing_page_audit_chat(args.url, args.keyword);
                    case "sem_ad_generator": return await sem_ad_generator_chat(args.country, args.input_text, args.tone, args.language, args.ad_format);
                    case "keyword_mapping": return await keyword_mapping_chat(args.domain, args.keywords);
                    case "getHTML": return await getHTML_chat(args.target);
                    default: throw new Error(`Function ${name} not found`);
                }
            }

            // API Tool implementations
            async function get_serps_chat(k, l, loc) {
                const r = await fetch("https://8k6r15rg4m.execute-api.ap-southeast-1.amazonaws.com/serpLite", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ keyword: k, language: l, location: loc })
                }); return await r.json();
            }
            async function rank_checker_chat(k, l, loc, t) {
                const r = await fetch("https://v5bizygr4m.execute-api.ap-southeast-1.amazonaws.com/rankChecker", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ keyword: k, language: l, location: loc, target: t })
                }); return await r.json();
            }
            async function moz_chat(d) {
                const r = await fetch("https://a7hptjtc8e.execute-api.ap-southeast-1.amazonaws.com/new", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ domain: d })
                }); return await r.json();
            }
            async function gtMetrix_chat(t) {
                const r = await fetch("https://y5830908vh.execute-api.ap-southeast-1.amazonaws.com/gtmetrix", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ url: t })
                }); return await r.json();
            }
            async function keyword_metrics_chat(k, loc, l) {
                const r = await fetch("https://eo2ckwvxmf.execute-api.ap-southeast-1.amazonaws.com/keywordMetrics", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ keywords: k, location: loc, language: l })
                }); return await r.json();
            }
            async function scrape_webpage_chat(u) {
                const r = await fetch("https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ url: u })
                }); return await r.json();
            }
            async function ranking_keywords_chat(t, loc) {
                const r = await fetch("https://0dqny7l5y9.execute-api.ap-southeast-1.amazonaws.com/rankingKeywords", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ target: t, location: loc })
                }); return await r.json();
            }
            async function similar_keywords_chat(ks, l, loc) {
                const r = await fetch("https://lgvdhcs4t2.execute-api.ap-southeast-1.amazonaws.com/similarKeywords", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ keywords: ks, language: l, location: loc })
                }); return await r.json();
            }
            async function keywords_for_site_chat(t, l, loc) {
                const r = await fetch("https://ei6xj9x2rd.execute-api.ap-southeast-1.amazonaws.com/keywordsForSite", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ target: t, language: l, location: loc })
                }); return await r.json();
            }
            async function crawler_chat(u, m) {
                const r = await fetch("https://464q7iox7h.execute-api.ap-southeast-1.amazonaws.com/crawler", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ url: u, max_pages: m || 10 })
                }); return await r.json();
            }
            async function persona_generator_chat(d, man) {
                const r = await fetch("https://tyqj3fni7h.execute-api.ap-southeast-1.amazonaws.com/personaGenerator", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ data: d, manual: man })
                }); return await r.json();
            }
            async function media_plan_generator_chat(d) {
                const r = await fetch("https://h8ih2vc2xi.execute-api.ap-southeast-1.amazonaws.com/mediaPlanGenerator", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(d)
                }); return await r.json();
            }
            async function landing_page_audit_chat(u, k) {
                const r = await fetch("https://llufeecqoe.execute-api.ap-southeast-1.amazonaws.com/auditLandingPage", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ url: u, keyword: k })
                }); return await r.json();
            }
            async function sem_ad_generator_chat(c, i, t, l, adf) {
                const r = await fetch("https://bztsly2z89.execute-api.ap-southeast-1.amazonaws.com/generateSemGoogle", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ country: c, input: i, tone: t, language: l, type: adf })
                }); return await r.json();
            }
            async function keyword_mapping_chat(d, ks) {
                const r = await fetch("https://c0bkxhc1s3.execute-api.ap-southeast-1.amazonaws.com/keywordMapping", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ domain: d, keywords: ks })
                }); return await r.json();
            }
            async function getHTML_chat(u) {
                const r = await fetch("https://abrhhnjp4m.execute-api.ap-southeast-1.amazonaws.com/getHtml", {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ url: u })
                }); return await r.json();
            }

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && isChatbotOpen_chat) {
                    chatbotModal_chat.style.display = 'none';
                    isChatbotOpen_chat = false;
                }
            });
        });

        function goToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth' // Optional: Adds smooth scrolling
            });
        }

        function clearPageState() {
            const collapsibles = document.querySelectorAll('.collapsible');

            // Iterate over each element
            collapsibles.forEach(collapsible => {
                // Set the background color to the specified color
                collapsible.style.backgroundColor = "#004c9d";
            });
            // Clear input values
            document.getElementById('domain').value = '';
            document.getElementById('location').value = 'Singapore'; // Reset to default
            document.getElementById('language').value = 'English'; // Reset to default
            document.getElementById('keywords').value = '';

            //Clear values of content generator
            document.getElementById('subgroups').value = '';
            document.getElementById('painpoints').value = '';
            document.getElementById('audience_goal').value = '';
            document.getElementById('product_service').value = '';
            document.getElementById('desired_action').value = '';
            document.getElementById('post_objectives').value = '';
            document.getElementById('content-type').value = '';
            document.getElementById('word_count').value = '';
            document.getElementById('tone').value = '';
            document.getElementById('usp').value = '';
            document.getElementById('pov').value = '';
            document.getElementById('emojis').value = '';
            document.getElementById('hashtags').value = '';

            document.getElementById('generator_brand_guide_urls').value = '';
            document.getElementById('sample-text').value = '';
            document.getElementById('post-info').value = '';
            document.getElementById('reference-url').value = '';

            document.getElementById('landingPageUrl').value = '';
            document.getElementById('landingPageAuditKeyword').value = '';

            //Clear output section values
            document.getElementById('targetTitle').innerText = "";
            document.getElementById('targetDescription').innerText = "";
            //document.getElementById('targetDomainRank').innerText = "";
            document.getElementById('targetBacklinks').innerText = "";
            document.getElementById('targetSpamScore').innerText = "";
            document.getElementById('targetRefDomains').innerText = "";
            document.getElementById('targetInternalLinks').innerText = "";
            document.getElementById('targetExternalLinks').innerText = "";
            document.getElementById('targetH1').innerText = "";
            document.getElementById('targetImages').innerText = "";
            document.getElementById('targetCls').innerText = "";
            document.getElementById('targetLcp').innerText = "";
            document.getElementById('targetFid').innerText = "";
            document.getElementById('targetSchema').innerText = "";
            document.getElementById('targetReadability').innerText = "";
            document.getElementById('targetWordCount').innerText = "";
            document.getElementById('da').innerText = "";
            document.getElementById('pa').innerText = "";

            // Clear dynamic content sections
            document.getElementById('overall-summary').innerHTML = '';
            document.getElementById('keyword-analysis-results').innerHTML = '';
            document.getElementById('auditSummary').innerHTML = '';
            document.getElementById('comparison-results').innerHTML = '';

            //document.getElementById('crawlerReport').innerHTML = '';

            document.getElementById("competitors-target1").value = '';
            document.getElementById("competitor_keywords").value = '';
            document.getElementById("competitors-language").value = '';
            document.getElementById("competitors-location").value = '';
            document.getElementById("competitorsOutput").innerHTML = '';

            document.getElementById("persona_webpages").value = '';
            document.getElementById("persona_manual").value = '';
            document.getElementById("persona-results").innerHTML = '';

            document.getElementById("MediaPlanWebpages").value = '';
            document.getElementById("MediaPlanBudget").value = '';
            document.getElementById("MediaPlanManual").value = '';
            document.getElementById("mediaPlanResults").innerHTML = '';

            document.getElementById("content_check_other_urls").value = '';
            document.getElementById("brand_guide_urls").value = '';
            document.getElementById("content_check_instructions").value = '';
            document.getElementById("content_to_check").value = '';
            document.getElementById("checkContentResults").innerHTML = '';

            document.getElementById("on-page-url").value = '';
            document.getElementById("on-page-keywords").value = '';
            document.getElementById("onPageResults").innerHTML = '';
            document.getElementById("imageRecommendations").innerHTML = '';
            document.getElementById("contentRecommendations").innerHTML = '';


            //Clear technical seo output section and buttons
            //document.getElementById("auditSummary").innerHTML = "";
            //document.getElementById('downloadResultsBtn').style.display = 'none';

            // Clear local storage
            localStorage.removeItem('pageState');
            console.log('Page state cleared.');

            // Reset Visibility Style
            document.getElementById('overall-summary').style.display = 'none';

            //Call function to re-render components
            allKeywords = [];
        }

        function openQueriesModal() {
            document.getElementById('queriesModal').style.display = "block";
            loadPreviousQueries('on_page'); // Load data when modal opens
        }

        function openTimeToRankQueriesModal() {
            document.getElementById("timeToRankModal").style.display = "block";
            loadPreviousQueries('time_to_rank'); // Load data when modal opens
        }

        function openContentComparisonQueriesModal() {
            document.getElementById("contentComparisonkModal").style.display = "block";
            loadPreviousQueries('content_comparison'); // Load data when modal opens
        }


        function closeQueriesModal() {
            document.getElementById('queriesModal').style.display = "none";
        }

        function closeContentComparisonQueriesModal() {
            document.getElementById('contentComparisonkModal').style.display = "none";
        }

        function closeTimeToRankQueriesModal() {
            document.getElementById('timeToRankModal').style.display = "none";
        }

        // --- API Interaction Functions ---
        async function loadPreviousQueries(query_type) {
            const API_ENDPOINT = "https://vau2b5m95m.execute-api.ap-southeast-1.amazonaws.com/queryDatabase"; // Replace with your actual API endpoint
            const USER_EMAIL = JSON.parse(localStorage.getItem('googleUser')).email;
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user: USER_EMAIL,
                        collection: query_type
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (query_type == "on_page") {
                    populateQueriesTable(data);
                } else if (query_type == "time_to_rank") {
                    populateTimeToRankQueriesTable(data);
                } else if (query_type == "content_comparison") {
                    populateContentComparisonQueriesTable(data);
                }

            } catch (error) {
                console.error("Error loading previous queries:", error);
                alert("Failed to load previous queries. See console for details.");
            }
        }

        async function contentComparisonToDatabase() {
            endpoint = "https://7gdde3ohdl.execute-api.ap-southeast-1.amazonaws.com/contentComparisonToDatabase";

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    comparison_urls: document.getElementById('comparison-urls').value,
                    comparison_keyword: document.getElementById('comparison-keyword').value,
                    language: document.getElementById('comparison-language').value,
                    location: document.getElementById('comparison-location').value,

                    initial_table: document.getElementById('initial-table').innerHTML,
                    comparison_results: document.getElementById('comparison-results').innerHTML,
                    user: JSON.parse(localStorage.getItem('googleUser')).email
                })
            })

            data = await response.json();
        }

        function populateQueriesTable(queries) {
            const tableBody = document.getElementById('queriesTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ""; // Clear existing rows

            queries.forEach((query, index) => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = formatDate(query.date);
                row.insertCell(2).textContent = query.url;
                row.insertCell(3).textContent = query.keywords;
                row.insertCell(4).textContent = query.user; // Corrected the index here

                row.addEventListener('click', () => loadQueryData(query.id, "on_page")); // Add click listener
            });
            document.getElementById('on_page_loading').style.display = "none";
        }

        function populateTimeToRankQueriesTable(queries) {
            const tableBody = document.getElementById('timeToRankQueriesTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ""; // Clear existing rows

            queries.forEach((query, index) => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = formatDate(query.date);
                row.insertCell(2).textContent = query.url;
                row.insertCell(3).textContent = query.keywords;
                row.insertCell(4).textContent = query.user; // Corrected the index here

                row.addEventListener('click', () => loadTimeToRankQueryData(query.id, "time_to_rank")); // Add click listener
            });
            document.getElementById('time_to_rank_loading').style.display = "none";
        }

        function populateContentComparisonQueriesTable(queries) {
            const tableBody = document.getElementById('contentComparisonQueriesTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ""; // Clear existing rows

            queries.forEach((query, index) => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = formatDate(query.date);
                row.insertCell(2).textContent = query.comparison_urls;
                row.insertCell(3).textContent = query.comparison_keyword;
                row.insertCell(4).textContent = query.user; // Corrected the index here

                row.addEventListener('click', () => loadContentComparisonQueryData(query.id, "content_comparison")); // Add click listener
            });
            document.getElementById('content_comparison_loading').style.display = "none";
        }


        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');

            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        async function loadQueryData(id, collection) {
            showLoadingModal();
            endpoint = "https://3fbj0gjlak.execute-api.ap-southeast-1.amazonaws.com/loadSingleQuery";
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "id": id,
                    "collection": collection,
                })
            })

            query = await response.json();
            document.getElementById('on-page-url').value = query.url;
            document.getElementById('on-page-keywords').value = query.keywords.join(', ');
            document.getElementById('onPageResults').innerHTML = query.meta_table;
            document.getElementById('imageRecommendations').innerHTML = query.image_table;
            document.getElementById('contentRecommendations').innerHTML = query.content_table;

            document.getElementById('onPageResultsCollapsible').style.display = "block";
            document.getElementById('onPageResults').style.display = "block";
            document.getElementById('imageCollapsible').style.display = "block";
            document.getElementById('imageRecommendations').style.display = "block";
            document.getElementById('contentCollapsible').style.display = "block";
            document.getElementById('contentRecommendations').style.display = "block";


            hideLoadingModal();
            closeQueriesModal(); // Close modal after loading
        }

        // Delegate the event listener to the document
        document.addEventListener('DOMContentLoaded', function () {
            const collapsibles = document.querySelectorAll('.keywords-collapsible');

            collapsibles.forEach(collapsible => {
                collapsible.addEventListener('click', function () {
                    this.classList.toggle('keywords-active');
                    const content = this.nextElementSibling;

                    // Toggle the display style of the content
                    if (content.style.display === 'block') {
                        content.style.display = 'none';
                    } else {
                        content.style.display = 'block';
                    }
                });
            });
        });

        async function loadTimeToRankQueryData(id, collection) {
            showLoadingModal();
            endpoint = "https://3fbj0gjlak.execute-api.ap-southeast-1.amazonaws.com/loadSingleQuery";
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "id": id,
                    "collection": collection,
                })
            })

            query = await response.json();

            document.getElementById('domain').value = query.url;
            document.getElementById('keywords').value = query.keywords;
            document.getElementById('location').value = query.location;
            document.getElementById('language').value = query.language;

            document.getElementById('siteKeywords').innerHTML = query.webpage_keywords;
            document.getElementById('rankingKeywords').innerHTML = query.ranking_keywords;
            document.getElementById('keywordSuggestions').innerHTML = query.suggestion_keywords;

            document.getElementById('metaData').innerHTML = query.meta_data;
            document.getElementById('domainMetrics').innerHTML = query.domain_metrics;
            document.getElementById('overall-summary').innerHTML = query.time_to_rank_table;

            document.getElementById('keywordAnalysis').innerHTML = query.keyword_analysis;
            document.getElementById('keywordAnalysis').style.display = "block";
            hideLoadingModal();
            closeTimeToRankQueriesModal(); // Close modal after loading
        }

        async function loadContentComparisonQueryData(id, collection) {
            showLoadingModal();
            endpoint = "https://3fbj0gjlak.execute-api.ap-southeast-1.amazonaws.com/loadSingleQuery";
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "id": id,
                    "collection": collection,
                })
            })

            query = await response.json();
            document.getElementById('comparison-urls').value = query.comparison_urls;
            document.getElementById('comparison-keyword').value = query.comparison_keyword;
            document.getElementById('comparison-location').value = query.location;
            document.getElementById('comparison-language').value = query.language;

            document.getElementById('initial-table').innerHTML = query.initial_table;
            document.getElementById('comparison-results').innerHTML = query.comparison_results;
            hideLoadingModal();
            closeContentComparisonQueriesModal(); // Close modal after loading
        }

        // On Page
        async function getImages() {
            document.getElementById('contentCollapsible').style.backgroundColor = "#004c9d";
            document.getElementById('imageCollapsible').style.backgroundColor = "#004c9d";
            document.getElementById('onPageResultsCollapsible').style.backgroundColor = "#004c9d";

            document.getElementById('onPageResults').innerHTML = ""; // Clear previous results
            document.getElementById('imageRecommendations').innerHTML = ""; // Clear previous results
            document.getElementById('contentRecommendations').innerHTML = ""; // Clear previous results

            document.getElementById('onPageResultsCollapsible').style.display = "none";
            document.getElementById('imageCollapsible').style.display = "none";
            document.getElementById('contentCollapsible').style.display = "none";
            const url = document.getElementById('on-page-url').value;
            const keywords = document.getElementById('on-page-keywords').value; // Get keywords
            document.getElementById("getImagesBtn").innerText = "Extracting elements..."; // Change button text
            document.getElementById("getImagesBtn").innerHTML += '<img src="https://usagif.com/wp-content/uploads/loading-73.gif" width="50">';
            updateCollapsibleState('onPageButton', 'running');

            if (!url) {
                document.getElementById("getImagesBtn").innerText = "Extract Elements & Generate Recommendations"; //Revert button text
                return;
            }

            // Process keywords (split by commas or newlines)
            const keywordArray = keywords.split(/[,\n]+/).map(keyword => keyword.trim()).filter(keyword => keyword !== "");

            const endpoint = 'https://udjdc333m9.execute-api.ap-southeast-1.amazonaws.com/getImages';

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url,
                        keywords: keywordArray // Send keywords to the backend
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Call the second API and then display the data
                displayInitialData(data);


                if (!keywords) {
                    alert("No content recommendations will be given as no keywords were entered.")
                    document.getElementById("getImagesBtn").innerText = "Extract Elements & Generate Recommendations"
                    return;
                } else {
                    getOnPageRecommendations(data, keywordArray);
                    getContentRecommendations(url, keywordArray);
                    document.getElementById("getImagesBtn").innerText = "Generating Recommendations...";
                    document.getElementById("getImagesBtn").innerHTML += '<img src="https://usagif.com/wp-content/uploads/loading-73.gif" width="50">';
                    updateCollapsibleState('onPageButton', 'success');
                }

            } catch (error) {
                document.getElementById('onPageResults').innerHTML = `<p>Error: ${error}</p>`;
                document.getElementById("getImagesBtn").innerText = "Extract Elements & Generate Recommendations";
                updateCollapsibleState('onPageButton', 'error');
            }
        }

        // On Page
        async function getContentRecommendations(url, keywordArray) {
            const recommendationEndpoint = 'https://pkkz2e02ch.execute-api.ap-southeast-1.amazonaws.com/onPageContentRecommendations';

            try {
                const recommendationResponse = await fetch(recommendationEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url,
                        "keywords": keywordArray
                    })
                });

                if (!recommendationResponse.ok) {
                    throw new Error(`HTTP error! status: ${recommendationResponse.status}`);
                }

                const recommendationData = await recommendationResponse.json();
                console.log(recommendationData);

                let contentTableHTML = `
            <table id="contentTable">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Current Content</th>
                        <th>Recommendation</th>
                        <th>Rationale</th>
                    </tr>
                </thead>
                <tbody>
            `;

                let i = 0;
                for (const recommendation of recommendationData) {
                    contentTableHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td>${recommendation.current_value}</td>
                    <td><textarea>${recommendation.suggested_value}</textarea></td>
                    <td>${recommendation.rationale}</td>
                </tr>
            `;
                    i++;
                }


                contentTableHTML += `
                </tbody>
            </table>
            `;

                document.getElementById('contentRecommendations').innerHTML = contentTableHTML + '<div style="text-align: center;"><button class="export-button" onclick="exportOnPageToCSV()">Export to CSV</button></div>';
                document.getElementById('contentCollapsible').style.display = "block";
                localStorage.setItem('onPageContent', document.getElementById('contentRecommendations').innerHTML);

            } catch (error) {
                console.error("Error fetching recommendations:", error);
                document.getElementById('contentRecommendations').innerHTML = `<p>Error fetching recommendations: ${error}</p>`;
            }
        }

        async function getOnPageRecommendations(firstApiResponse, keywordArray) {
            const recommendationEndpoint = 'https://vwmqqj251d.execute-api.ap-southeast-1.amazonaws.com/onPageRecommendations';

            try {
                const recommendationResponse = await fetch(recommendationEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "data": firstApiResponse,
                        "keywords": keywordArray
                    })
                });

                if (!recommendationResponse.ok) {
                    throw new Error(`HTTP error! status: ${recommendationResponse.status}`);
                }

                const recommendationData = await recommendationResponse.json();
                displayAllData(recommendationData);
                localStorage.setItem('onPageResults', document.getElementById('onPageResults').innerHTML);
                localStorage.setItem('onPageImages', document.getElementById('imageRecommendations').innerHTML);
                updateCollapsibleState('onPageButton', 'success');

            } catch (error) {
                console.error("Error fetching recommendations:", error);
                updateCollapsibleState('onPageButton', 'error');
                document.getElementById('onPageResults').innerHTML = `<p>Error fetching recommendations: ${error}</p>`;
            }
        }

        // On page
        function displayInitialData(data) {
            // Add export button above meta table
            let resultsHTML = '';

            let metaTableHTML = `
            <table id="metaTable">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Current Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Meta Title</td>
                        <td>${data.meta_title}</td>
                    </tr>
                    <tr>
                        <td>Meta Description</td>
                        <td>${data.meta_description}</td>
                    </tr>
                    <tr>
                        <td>Canonical URL</td>
                        <td>${data.canonical_url}</td>
                    </tr>`;

            // Function to add heading rows
            function addHeadingRows(headingType, headings) {
                headings.forEach(heading => {
                    metaTableHTML += `
                            <tr>
                                <td>${headingType}</td>
                                <td>${heading}</td>
                            </tr>
                        `;
                });
            }

            addHeadingRows("H1 Heading", data.headings.h1);
            addHeadingRows("H2 Heading", data.headings.h2);
            addHeadingRows("H3 Heading", data.headings.h3);
            addHeadingRows("H4 Heading", data.headings.h4);

            metaTableHTML += `

                    </tbody>
                </table>
            `;

            let imageTableHTML = `
                    <table id="imageTable">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Image URL <button class="copy-button" onclick="copyColumn(1, 'imageTable')">Copy</button></th>
                                <th>Image Preview</th>
                                <th>Alt Text <button class="copy-button" onclick="copyColumn(3, 'imageTable')">Copy</button></th>
                            </tr>
                        </thead>
                        <tbody>
                `;

            for (let i = 0; i < data.image_data.length; i++) {
                const item = data.image_data[i];
                const imageUrl = Object.keys(item)[0];
                const altText = item[imageUrl] || ''; // Handle cases where alt text is empty

                imageTableHTML += `
            <tr>
                <td>${i + 1}</td>
                <td><a href="${imageUrl}" target="_blank">${imageUrl}</a></td>
                <td><img src="${imageUrl}" alt="${altText}"></td>
                <td>${altText}</td>
            </tr>
            `;
            }

            imageTableHTML += `
            </tbody>
        
         `;

            resultsHTML += metaTableHTML

            document.getElementById('imageRecommendations').innerHTML = imageTableHTML;

            // Add export button after image table
            resultsHTML += '<button class="export-button" onclick="exportOnPageToCSV()">Export to CSV</button>';

            document.getElementById('onPageResults').innerHTML = resultsHTML;

            document.getElementById('onPageResultsCollapsible').style.display = "block";
            document.getElementById('imageCollapsible').style.display = "block";

            localStorage.setItem('onPageUrl', document.getElementById('on-page-url').value);
            localStorage.setItem('onPageKeywords', document.getElementById('on-page-keywords').value);
            localStorage.setItem('onPageResults', document.getElementById('onPageResults').innerHTML);
        }

        // On-page
        function displayAllData(data) {
            console.log(data);
            // Add export button above meta table
            let resultsHTML = '';

            let metaTableHTML = `
        <table id="metaTable">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Current Value</th>
                    <th>Suggested Change</th>
                    <th>Rationale</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Meta Title</td>
                    <td>${data.meta_title.current_value}</td>
                    <td><textarea>${data.meta_title.suggested_value}</textarea></td>
                    <td>${data.meta_title.rationale}</td>
                </tr>
                <tr>
                    <td>Meta Description</td>
                    <td>${data.meta_description.current_value}</td>
                    <td><textarea>${data.meta_description.suggested_value}</textarea></td>
                    <td>${data.meta_description.rationale}</td>
                </tr>
                <tr>
                    <td>Canonical URL</td>
                    <td>${data.canonical_url.current_value}</td>
                    <td><textarea>${data.canonical_url.suggested_value}</textarea></td>
                    <td>${data.canonical_url.rationale}</td>
                </tr>`;

            // Function to add heading rows
            function addHeadingRows(headingType, headings) {
                headings.forEach(heading => {
                    metaTableHTML += `
                <tr>
                    <td>${headingType}</td>
                    <td>${heading.current_value}</td>
                    <td><textarea>${heading.suggested_value}</textarea></td>
                    <td>${heading.rationale}</td>
                </tr>
            `;
                });
            }

            addHeadingRows("H1 Heading", data.headings.h1);
            addHeadingRows("H2 Heading", data.headings.h2);
            addHeadingRows("H3 Heading", data.headings.h3);
            addHeadingRows("H4 Heading", data.headings.h4);

            metaTableHTML += `

            </tbody>
        </table>
    `;

            let imageTableHTML = `
            <table id="imageTable">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Image URL <button class="copy-button" onclick="copyColumn(1, 'imageTable')">Copy</button></th>
                        <th>Image Preview</th>
                        <th>Alt Text <button class="copy-button" onclick="copyColumn(3, 'imageTable')">Copy</button></th>
                        <th>Suggested Alt Text</th>
                        <th>Rationale</th>
                    </tr>
                </thead>
                <tbody>
        `;

            let i = 0;
            for (const imageData of data.image_data) {
                const imageUrl = Object.keys(imageData)[0];
                const imageDetails = imageData[imageUrl];

                imageTableHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td><a href="${imageUrl}" target="_blank">${imageUrl}</a></td>
                    <td><img src="${imageUrl}" alt="${imageDetails.current_value}"></td>
                    <td>${imageDetails.current_value}</td>
                    <td><textarea>${imageDetails.suggested_value}</textarea></td>
                    <td>${imageDetails.rationale}</td>
                </tr>
            `;
                i++;
            }


            imageTableHTML += `
                </tbody>
            </table>
        `;

            resultsHTML += metaTableHTML;

            // Add export button after image table
            resultsHTML += '<button class="export-button" onclick="exportOnPageToCSV()">Export to CSV</button>';

            document.getElementById('onPageResults').innerHTML = resultsHTML;
            document.getElementById('imageRecommendations').innerHTML = imageTableHTML;
            document.getElementById("getImagesBtn").innerText = "Extract Elements & Generate Recommendations";
            localStorage.setItem('onPageResults', document.getElementById('onPageResults').innerHTML);
            localStorage.setItem('onPageImages', document.getElementById('imageRecommendations').innerHTML);
            onPageToDatabase();
        }

        async function checkMangoolsQuota() {
            showLoadingModal();
            endpoint = "https://hjw4zjgve4.execute-api.ap-southeast-1.amazonaws.com/mangoolsQuota";

            const response = await fetch(endpoint, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })

            data = await response.json();
            hideLoadingModal();
            alert("Remaining quota for the day: " + data + "/200");

        }

        async function onPageToDatabase() {
            keywords = document.getElementById('on-page-keywords').value; // Get keywords
            keywordArray = keywords.split(/[,\n]+/).map(keyword => keyword.trim()).filter(keyword => keyword !== "");
            endpoint = "https://7nq1nq4ll5.execute-api.ap-southeast-1.amazonaws.com/onPageToDatabase";

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    url: document.getElementById('on-page-url').value,
                    keywords: keywordArray,
                    meta_table: document.getElementById('onPageResults').innerHTML,
                    image_table: document.getElementById('imageRecommendations').innerHTML,
                    content_table: document.getElementById('contentRecommendations').innerHTML,
                    user: JSON.parse(localStorage.getItem('googleUser')).email
                })
            })

            data = await response.json();
        }

        function copyColumn(columnIndex, tableId = 'onPageResults') {
            let table = document.querySelector('table'); // Default to the first table
            if (tableId === 'imageTable') {
                // Find the second table if tableId is 'imageTable'
                const tables = document.querySelectorAll('table');
                table = tables[1]; // Assuming the image table is the second one
            }

            if (!table) {
                console.error('Table not found');
                return;
            }

            const rows = table.querySelectorAll('tr');
            let columnText = '';

            for (let i = 1; i < rows.length; i++) { // Skip the header row
                const cells = rows[i].querySelectorAll('td');
                if (cells.length > columnIndex) {
                    columnText += cells[columnIndex].textContent.trim() + '\n';
                }
            }

            // Create a temporary textarea element to hold the text
            const textarea = document.createElement('textarea');
            textarea.value = columnText;
            document.body.appendChild(textarea);

            // Select the text in the textarea
            textarea.select();

            try {
                // Execute the copy command
                const successful = document.execCommand('copy');
                const msg = successful ? 'successful' : 'unsuccessful';
                console.log('Copying text command was ' + msg);
                alert('Column copied to clipboard!');
            } catch (err) {
                console.error('Oops, unable to copy', err);
                alert('Failed to copy column to clipboard.');
            }

            // Remove the temporary textarea
            document.body.removeChild(textarea);
        }

        function exportOnPageToCSV() {
            // Collect data from both tables
            const metaTable = document.getElementById('metaTable');
            const imageTable = document.getElementById('imageTable');
            const contentTable = document.getElementById('contentTable');


            if (!metaTable || !imageTable) {
                alert('Tables not found. Please extract data first.');
                return;
            }

            const metaData = tableToCSV(metaTable);
            const imageData = tableToCSV(imageTable);
            const contentData = tableToCSV(contentTable);

            // Combine the data with a separator
            const csvData = "Meta Table Data:\n" + metaData + "\n\nImage Table Data:\n" + imageData + "\n\nContent Recommendations:\n" + contentData;

            // Create a download link
            const filename = 'on_page_recommendations.csv';
            const csvFile = new Blob([csvData], {
                type: 'text/csv'
            });
            const downloadLink = document.createElement('a');
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        function tableToCSV(table) {
            const rows = table.querySelectorAll('tr');
            let csv = [];

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].querySelectorAll('th, td');
                let row = [];
                for (let j = 0; j < cells.length; j++) {
                    //remove the button tag
                    let cellText = cells[j].textContent.replace(/<[^>]*>?/gm, '').trim();
                    row.push('"' + cellText.replace(/"/g, '""') + '"'); // Escape double quotes
                }
                csv.push(row.join(','));
            }

            return csv.join('\n');
        }

        function showTooltip(event, text) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = text;
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';  // Position it next to the mouse
            tooltip.style.top = (event.pageY + 10) + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }


        function loadCachedData() {
            const url = localStorage.getItem('onPageUrl');
            const keywords = localStorage.getItem('onPageKeywords');
            const resultsHTML = localStorage.getItem('onPageResults');
            const imageHTML = localStorage.getItem('onPageImages');
            const contentHTML = localStorage.getItem('onPageContent');

            if (url) {
                document.getElementById('on-page-url').value = url;
            }
            if (keywords) {
                document.getElementById('on-page-keywords').value = keywords;
            }
            if (resultsHTML) {
                document.getElementById('onPageResults').innerHTML = resultsHTML;
                document.getElementById('onPageResultsCollapsible').style.display = "block";
                document.getElementById('onPageResultsCollapsible').style.backgroundColor = "green";
            }
            if (imageHTML) {
                document.getElementById('imageRecommendations').innerHTML = imageHTML;
                document.getElementById('imageCollapsible').style.display = "block";
                document.getElementById('imageCollapsible').style.backgroundColor = "green";
            }
            if (contentHTML) {
                document.getElementById('contentRecommendations').innerHTML = contentHTML;
                document.getElementById('contentCollapsible').style.display = "block";
                document.getElementById('contentCollapsible').style.backgroundColor = "green";
            }

            if (url || keywords || resultsHTML || imageHTML || contentHTML) {
            } else {
                alert('No data found in cache.');
            }
        }

        function clearOnPageData() {
            document.getElementById("on-page-url").value = "";
            document.getElementById("keywords").value = "";
            document.getElementById("onPageResults").innerText = "";
            document.getElementById("imageRecommendations").innerText = "";
            document.getElementById("contentRecommendations").innerText = "";

            document.getElementById('onPageResultsCollapsible').style.display = "none";
            document.getElementById('onPageResultsCollapsible').style.backgroundColor = "#004c9d";

            document.getElementById('imageCollapsible').style.display = "none";
            document.getElementById('imageCollapsible').style.backgroundColor = "#004c9d";

            document.getElementById('contentCollapsible').style.display = "none";
            document.getElementById('contentCollapsible').style.backgroundColor = "#004c9d";

        }

        async function checkRanks() {
            document.getElementById('rankCheckerResultsTable').style.display = "none";
            document.getElementById('checkRanksButton').innerHTML = "Checking rankings...";
            updateCollapsibleState('rankCheckerButton', 'running');
            const keywords = document.getElementById('rankCheckerKeywords').value.split('\n');
            domain = document.getElementById('rankCheckerDomain').value;
            const tableBody = document.getElementById('rankCheckerResultsTableBody');
            tableBody.innerHTML = ""; // Clear previous results
            const results = [];
            for (keyword of keywords) {
                const row = tableBody.insertRow();
                const rankCell = row.insertCell();
                const keywordCell = row.insertCell();

                rankCell.textContent = 'getting rank...';
                keywordCell.textContent = keyword;

                if (keyword.trim() !== "") { // Only make API call if keyword is not empty
                    results.push(fetchRank(keyword.trim(), row));
                } else {
                    rankCell.textContent = ''; // Clear "getting rank" for empty lines
                }
            }

            await Promise.all(results); // Wait for all API calls to complete
            document.getElementById('rankCheckerResultsTable').style.display = "block";
            document.getElementById('checkRanksButton').innerHTML = "Check Ranks";
            updateCollapsibleState('rankCheckerButton', 'success');
        }

        async function fetchRank(keyword, row) {
            domain = document.getElementById('rankCheckerDomain').value;
            console.log(domain);
            const rankCell = row.cells[0];
            try {
                const response = await fetch('https://v5bizygr4m.execute-api.ap-southeast-1.amazonaws.com/rankChecker', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "keyword": keyword,
                        "language": document.getElementById('rankCheckerLanguage').value,
                        "location": document.getElementById('rankCheckerLocation').value,
                        "target": domain
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }

                data = await response.json();

                if (data == null) {
                    data = 999;
                }
                rankCell.textContent = data;
            } catch (error) {
                console.error("Error fetching rank:", error);
                rankCell.textContent = 'not available';
            }
        }

        function loadFromLocalStorage() {
            const inputs = document.querySelectorAll('input, textarea, select');

            inputs.forEach(input => {
                const key = input.id;
                if (key) {
                    try {
                        const storedValue = localStorage.getItem(key);
                        if (storedValue !== null) {
                            const parsedValue = JSON.parse(storedValue);

                            if (input.type === 'checkbox') {
                                input.checked = parsedValue;
                            } else if (input.tagName === 'SELECT') {
                                input.value = parsedValue;
                            } else {
                                input.value = parsedValue;
                            }
                        }
                    } catch (error) {
                        console.error(`Error loading or parsing value for ${key}:`, error);
                    }
                }
            });

            // Load generated content
            const contentIds = [
                'overall-summary',
                'keyword-analysis-results',
                'technicalSeo',
                'contentComparison',
                'schema',
                'onPageSection',
                'rankChecker',
                'socialMedia',
                'SEM',
                'competitors_content',
                'persona_content',
                'mediaplan',
                'content_check_content',
                'landingPageAudit',
                'onPageResults',
                'imageRecommendations',
                'contentRecommendations'
            ];

            contentIds.forEach(id => {
                const element = document.getElementById(id);
                const storedContent = localStorage.getItem(id);
                if (element && storedContent) {
                    element.innerHTML = storedContent;
                }
            });

            console.log('Page state loaded from localStorage');
        }

        function saveToLocalStorage() {
            // Get all input elements (including textareas, selects)
            const inputs = document.querySelectorAll('input, textarea, select');

            inputs.forEach(input => {
                const key = input.id; // Use the input's ID as the storage key

                if (key) { // Only save if the input has an ID
                    let value;

                    if (input.type === 'checkbox') {
                        value = input.checked; // Boolean for checkboxes
                    } else if (input.tagName === 'SELECT') {
                        value = input.value; // Selected option's value
                    } else {
                        value = input.value; // Text input, textarea value
                    }

                    localStorage.setItem(key, JSON.stringify(value)); // Convert value to string for storage
                }
            });

            // Get all generated content elements by ID
            const contentIds = [
                'overall-summary',
                'keyword-analysis-results',
                'technicalSeo',
                'contentComparison',
                'schema',
                'onPageSection',
                'rankChecker',
                'socialMedia',
                'SEM',
                'competitors_content',
                'persona_content',
                'mediaplan',
                'content_check_content',
                'landingPageAudit'
            ];

            contentIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    localStorage.setItem(id, element.innerHTML);
                }
            });

            console.log('Page state saved to localStorage');
        }

        setInterval(saveToLocalStorage, 5000); // Save every 5 seconds
        const seoNavItem = document.getElementById('seoNavItem');
        const smmNavItem = document.getElementById('smmNavItem');
        const othersNavItem = document.getElementById('othersNavItem'); //Add others item

        function toggleDropdown(navItem) {
            navItem.classList.toggle('show');
        }

        if (window.innerWidth <= 600) {
            seoNavItem.addEventListener('click', (event) => {
                event.preventDefault();
                toggleDropdown(seoNavItem);
            });

            smmNavItem.addEventListener('click', (event) => {
                event.preventDefault();
                toggleDropdown(smmNavItem);
            });

            othersNavItem.addEventListener('click', (event) => { //Add function for others nav item on mobile
                event.preventDefault();
                toggleDropdown(othersNavItem);
            });
        }

        function showLoadingModal() {
            document.getElementById('loadingModal').style.display = "block";
        }

        // Function to hide the loading modal
        function hideLoadingModal() {
            document.getElementById('loadingModal').style.display = "none";
        }


        function initializeJourneyCollapsibles() {
            var coll = document.getElementsByClassName("journey-collapsible");
            for (i = 0; i < coll.length; i++) {
                // Calculate and set initial progress
                const totalSteps = parseInt(coll[i].dataset.totalSteps);
                const completedSteps = parseInt(coll[i].dataset.completedSteps);
                const percentage = (completedSteps / totalSteps) * 100;

                const progressBar = coll[i].querySelector('.progress-bar');
                progressBar.style.width = `${percentage}%`;

                coll[i].addEventListener("click", function () {
                    this.classList.toggle("active");
                    var content = this.nextElementSibling;
                    if (content.style.display === "block") {
                        content.style.display = "none";
                    } else {
                        content.style.display = "block";
                    }
                });
            }
            // Close Modal Button
            const closeBtn = modal.querySelector('.journey-close');
            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                modal.remove()
            });
        }

        function openJourneyModal() {
            document.getElementById('journey-modal').style.display = "block";
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    document.getElementById('journey-modal').style.display = 'none';
                }
            });
            updateJourney();
        }

        function closeJourneyModal() {
            document.getElementById('journey-modal').style.display = "none";
        }

        function updateJourney() {
            done = 0;
            // similar keywords
            if (document.getElementById("keywordList").children.length > 0) {
                document.getElementsByClassName('step')[0].innerHTML = '<div class="step-number completed"><i class="fas fa-check"></i></div>';
                done += 1;
            }
            // ranking keywords or keywords based on webpage content
            if (document.getElementById("rankedKeywordList").children.length > 0 || document.getElementById("siteKeywords").children.length > 0) {
                document.getElementsByClassName('step')[1].innerHTML = '<div class="step-number completed"><i class="fas fa-check"></i></div>';
                done += 1
            }
            // time to rank
            if (document.getElementById("overall-summary").children.length > 0) {
                document.getElementsByClassName('step')[2].innerHTML = '<div class="step-number completed"><i class="fas fa-check"></i></div>';
                done += 1
            }
            // seo tech audit
            if (document.getElementById("auditSummary").children.length > 0) {
                document.getElementsByClassName('step')[3].innerHTML = '<div class="step-number completed"><i class="fas fa-check"></i></div>';
                done += 1
            }
            // content comparison
            if (document.getElementById("comparison-results").children.length > 0) {
                document.getElementsByClassName('step')[4].innerHTML = '<div class="step-number completed"><i class="fas fa-check"></i></div>';
                done += 1
            }
            // on-page
            if (document.getElementById("onPageResults").children.length > 0) {
                document.getElementsByClassName('step')[5].innerHTML = '<div class="step-number completed"><i class="fas fa-check"></i></div>';
                done += 1
            }
            // rank checker
            if (document.getElementById("rankCheckerResultsTable").rows.length > 1) {
                document.getElementsByClassName('step')[6].innerHTML = '<div class="step-number completed"><i class="fas fa-check"></i></div>';
                done += 1
            }
            document.getElementsByClassName('journey-collapsible')[0].dataset.completedSteps = String(done);
            var coll = document.getElementsByClassName("journey-collapsible");
            for (i = 0; i < coll.length; i++) {
                // Calculate and set initial progress
                const totalSteps = parseInt(coll[i].dataset.totalSteps);
                const completedSteps = parseInt(coll[i].dataset.completedSteps);
                const percentage = (completedSteps / totalSteps) * 100;

                const progressBar = coll[i].querySelector('.progress-bar');
                progressBar.style.width = `${percentage}%`;
            }

        }

        async function keywordDensity() {
            const url = document.getElementById('google-simulator-url').value;

            // Validation of URL (Basic example)
            try {
                new URL(url); // Try to parse the URL.  Throws an error if invalid
            } catch (error) {
                console.error("Invalid URL:", url);
                return { error: "Invalid URL provided." };
            }

            try {
                const response = await fetch('https://de0bccf9w7.execute-api.ap-southeast-1.amazonaws.com/keywordDensity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ target: url.trim() })
                });

                if (!response.ok) {
                    // Handle HTTP errors (e.g., 404, 500)
                    const errorMessage = await response.text(); // Or response.json() if the API returns a JSON error
                    throw new Error(`HTTP error! Status: ${response.status}, Message: ${errorMessage}`);
                }

                const data = await response.json();

                keywordDensityDiv = document.getElementById("keyword-density");
                let tableHTML = '<div class="table-container"><table>';

                // Create table headers (URLs)
                tableHTML += '<thead><tr><th onclick="sortDensityKeyword()">Keyword</th>';
                // Assuming 'urls' and 'responses' are defined elsewhere, and are related to multiple URLs.  Since we are only processing ONE URL at a time here, these need to be adjusted or removed.  For this example, I'm assuming it should use the current URL.  If not, you need to define/get the correct 'urls' array.
                const urls = [url]; // Use the current URL in an array for consistency with the original logic
                urls.forEach(url => {
                    tableHTML += `<th onclick="sortDensityTable('${url}')">${url}</th>`;
                });
                tableHTML += `<th>Add to Keyword Analysis</th></tr></thead><tbody>`; // Added the header for the new column.

                // Extract all unique keywords
                let allKeywords = new Set();
                // `data` is now a direct response for a single URL. No need to iterate through `data`.
                if (Array.isArray(data)) {
                    data.forEach(item => allKeywords.add(item.keyword));
                }
                allKeywords = Array.from(allKeywords);

                // Populate table rows with keyword data
                allKeywords.forEach(keyword => {
                    const rowId = `keywordRow-${keyword.replace(/\s+/g, '-')}`; // Create a unique ID for the row.

                    tableHTML += `<tr id="${rowId}" style="cursor:zoom-in;" onclick="highlightKeyword('${keyword}')"><td>${keyword}</td>`; // ADDED onclick HERE!
                    urls.forEach((url, urlIndex) => {
                        let frequency = 0;
                        // Check if the data for the URL is an array.  Again, since we are processing one URL at a time, it should always be an array, *or* contain an error object.
                        if (Array.isArray(data)) {
                            const keywordData = data.find(item => item.keyword === keyword);
                            frequency = keywordData ? keywordData.frequency : 0;
                        } else if (typeof data === 'object' && data !== null && data.error) {
                            frequency = data.error;
                        } else {
                            frequency = "N/A"; // Handle unexpected response
                        }

                        tableHTML += `<td>${frequency}</td>`;
                    });
                    // Add the new column with the plus icon and the click handler. The data-keyword is essential.
                    tableHTML += `<td><a href="#" class="add-keyword-button" data-keyword="${keyword}" onclick="addKeywordToAnalysis(event, this)"><i class="fas fa-plus-circle"></i></a></td></tr>`;
                });

                tableHTML += '</tbody></table></div>';
                keywordDensityDiv.innerHTML = tableHTML;


            } catch (error) {
                console.error(`Error fetching data for ${url.trim()}:`, error);

            }
        }

        function addKeywordToAnalysis(event, element) { // Modify function to get event and element
            event.preventDefault(); // Prevent page from jumping to top
            const keyword = element.dataset.keyword; // Get the keyword from the data attribute
            const keywordsTextArea = document.getElementById('keywords');
            let currentKeywords = keywordsTextArea.value.trim();
            let keywordsArray = currentKeywords.split(',').map(k => k.trim()); // Split, trim, and create an array
            if (!keywordsArray.includes(keyword)) { // Check if the keyword already exists
                if (currentKeywords === "") {
                    keywordsTextArea.value = keyword;
                } else {
                    keywordsTextArea.value = currentKeywords + ", " + keyword;
                }

                // Change the link to display "Added"
                element.innerHTML = "Added";
                element.classList.remove("add-keyword-button")

            }
            updateKeywordCount(); //update the keyword count paragraph
        }

        function sortDensityTable(url) {
            // Get the table element
            var table = document.querySelector("#keyword-density table"); // Corrected selector
            if (!table) {
                return; // Table doesn't exist
            }

            // Get the index of the URL column to be sorted by
            var headerRow = table.rows[0];
            var columnIndex = -1;
            for (var i = 1; i < headerRow.cells.length; i++) {
                if (headerRow.cells[i].textContent === url) {
                    columnIndex = i;
                    break;
                }
            }

            if (columnIndex === -1) {
                return; // URL not found
            }

            // Get the table rows (excluding the header row)
            var rows = Array.from(table.rows).slice(1); // Convert to array for easier sorting

            // Sort the rows based on the frequency in the specified column
            rows.sort(function (row1, row2) {
                var frequency1 = row1.cells[columnIndex].textContent;
                var frequency2 = row2.cells[columnIndex].textContent;

                // Handle error responses
                if (frequency1 === "N/A") {
                    return -1;
                }
                if (frequency2 === "N/A") {
                    return 1;
                }

                return frequency2 - frequency1;
            });

            // Re-append the sorted rows to the table
            rows.forEach(row => table.appendChild(row));
        }

        function sortDensityKeyword() {
            var table = document.querySelector("#keyword-density table"); // Corrected selector
            if (!table) {
                return;
            }

            var rows = Array.from(table.rows).slice(1);

            rows.sort(function (row1, row2) {
                var keyword1 = row1.cells[0].textContent.toLowerCase();
                var keyword2 = row2.cells[0].textContent.toLowerCase();

                if (keyword1 < keyword2) {
                    return -1;
                }
                if (keyword1 > keyword2) {
                    return 1;
                }
                return 0;
            });

            rows.forEach(row => table.appendChild(row));
        }

        async function googleCrawlerSimulator() {
            const url = document.getElementById('google-simulator-url').value;
            if (!url) {
                alert("Please enter a URL.");
                return;
            }

            document.getElementById('simulatorError').innerText = "";
            document.getElementById('simulatorError').display = 'none';
            document.getElementById('simulatorBtn').innerText = "Loading..";
            document.getElementById('simulatorButton').style.backgroundColor = "004c9d";
            document.getElementById("crawler-simulator-results").style.display = "none";

            try {
                // Extract domain
                let domain;
                try {
                    const urlObj = new URL(url);
                    domain = urlObj.origin;
                } catch (e) {
                    console.error("Invalid URL:", url, e);
                    return;
                }

                // Function to handle successful results and display them
                const handleResult = (result, displayFunction, elementId) => {
                    try {
                        if (displayFunction) {
                            displayFunction(result);
                        } else if (elementId) {
                            document.getElementById(elementId).innerText = result;
                        }
                    } catch (e) {
                        console.error("Error displaying result:", e);
                        document.getElementById('simulatorError').innerText = "Error displaying result: " + e;
                        document.getElementById('simulatorError').style.display = 'block';
                    }
                };

                // Function to handle errors from each promise
                const handleError = (error, functionName) => {
                    console.error(`Error in ${functionName}:`, error);
                    document.getElementById('simulatorError').innerText = `Error in ${functionName}: ` + error;
                    document.getElementById('simulatorError').style.display = 'block';
                };

                // Fetch HTML content  - needs special handling due to displayResults
                const htmlPromise = fetch('https://abrhhnjp4m.execute-api.ap-southeast-1.amazonaws.com/getHtml', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url
                    })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error fetching HTML! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(htmlData => {
                        return displaySimulatorResults(htmlData.body);  // displayResults *returns* a promise or void
                    })
                    .catch(error => handleError(error, 'fetchHtml'));

                // Call keywordDensity simultaneously
                const keywordDensityPromise = keywordDensity();

                // Optionally, keep track of all promises to ensure they all complete
                Promise.all([
                    htmlPromise,
                    keywordDensityPromise
                ]).then(() => {
                    document.getElementById('simulatorBtn').innerText = "Analyse";
                }).catch(error => {
                    console.error('Error in Promise.all:', error);
                    document.getElementById('simulatorBtn').innerText = "Analyse";
                });


            } catch (error) {
                console.error('General Error:', error);
                document.getElementById('simulatorBtn').innerText = "Analyse";
            }
        }

        async function displaySimulatorResults(html) {
            return new Promise((resolve, reject) => {
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // Meta Information
                    document.getElementById('simulator-meta-title').innerText = doc.querySelector('meta[name="title"]') ? doc
                        .querySelector('meta[name="title"]').content : doc.title;
                    document.getElementById('simulator-meta-description').innerText = doc.querySelector('meta[name="description"]') ?
                        doc.querySelector('meta[name="description"]').content : "";
                    document.getElementById('simulator-canonical-tag').innerText = doc.querySelector('link[rel="canonical"]') ? doc
                        .querySelector('link[rel="canonical"]').href : "";


                    // Headers (H1-H6)
                    const headers = doc.querySelectorAll('h1, h2, h3, h4, h5, h6');
                    const headersBody = document.getElementById('simulator-headers-body');
                    const indentation = {
                        'H1': 0,
                        'H2': 1,
                        'H3': 2,
                        'H4': 3,
                        'H5': 4,
                        'H6': 5
                    };

                    const headerColors = { // Define colors for each header level.  Adjust these!
                        'H1': 'lightgreen',
                        'H2': 'lightblue',
                        'H3': 'lightyellow',
                        'H4': 'lightcoral',
                        'H5': 'lightcyan',
                        'H6': 'lightpink'
                    };

                    headers.forEach(header => {
                        let row = headersBody.insertRow();
                        let cell = row.insertCell();
                        // Remove whitespace and newlines
                        const headerText = header.innerText.trim().replace(/\s+/g, ' ');
                        const indentLevel = indentation[header.tagName];
                        const indent = ''.repeat(indentLevel * 4); // Adjust the number for desired indentation
                        const headerTag = header.tagName;
                        cell.innerHTML = `<span class="header-text">${indent}${headerTag}: ${headerText}</span>`;

                        // Apply background color based on header type
                        if (headerColors[headerTag]) {  // Check if a color is defined for this tag.
                            cell.style.backgroundColor = headerColors[headerTag];
                        }
                    });


                    // Links (Internal and External)
                    const links = doc.querySelectorAll('a[href]');
                    const linksBody = document.getElementById('simulator-links-body');
                    const existingLinks = new Set();

                    const linkPromises = [];

                    domain = 'https://' + document.getElementById('google-simulator-url').value.replace('http://', '').replace('https://', '').split('/')[0] + '/';

                    links.forEach(async link => {
                        href = link.href;
                        href = href.replace('http://127.0.0.1:5500/', domain).replace('https://app.digimetrics.ai/', domain);
                        const linkText = link.innerText.trim(); // Extract link text and trim whitespace


                        if (existingLinks.has(href)) {
                            return;
                        }

                        existingLinks.add(href);

                        let linkType = 'External';
                        try {
                            const url = new URL(href.replace('http://127.0.0.1:5500/', domain).replace('https://app.digimetrics.ai/', domain));
                            const currentUrl = new URL(document.getElementById('google-simulator-url').value);
                            if (url.hostname === currentUrl.hostname) {
                                linkType = 'Internal';
                            }
                        } catch (e) {
                            linkType = 'Internal';
                        }

                        let row = linksBody.insertRow();
                        let typeCell = row.insertCell();
                        let urlCell = row.insertCell();
                        let linkTextCell = row.insertCell(); // Add cell for link text

                        typeCell.innerText = linkType;

                        // Apply background color based on link type
                        if (linkType === 'Internal') {
                            typeCell.style.backgroundColor = 'lightblue';
                        } else {
                            typeCell.style.backgroundColor = 'lightcoral';
                        }


                        urlCell.innerHTML = `<a href="${href}" target="_blank" rel="noopener noreferrer">${href}</a>`;
                        linkTextCell.innerText = linkText; // Set the link text
                    });

                    internalLinks = [];

                    existingLinks.forEach(link => {
                        if (!link.includes("tel:") & !link.includes("mailto:")) {
                            if (link.includes('127.0.0.1:5500')) {
                                link = link.replace('http://127.0.0.1:5500/', domain).replace('https://app.digimetrics.ai/', domain);
                            }
                            internalLinks.push(link);
                        }
                    })


                    // Main function execution
                    /*
                    let initialResponse;
        
                    sendInitialRequest(document.getElementById('google-simulator-url').value, internalLinks)
                        .then(response => {
                            initialResponse = response;
        
                            console.log(document.getElementById('google-simulator-url').value);
                            console.log(initialResponse);
        
                            pollForResults(document.getElementById('google-simulator-url').value, initialResponse);
                        })
                        .catch(error => {
                            console.error("Error during initial request:", error);
                            reject(error); // Reject the promise if the initial request fails.  Crucial.
                            return; // Exit the function to prevent further execution if the initial request fails.
                        });
                    */


                    const clonedBody = doc.body.cloneNode(true);

                    // Remove script tags
                    const scripts = clonedBody.querySelectorAll('script');
                    scripts.forEach(script => script.remove());

                    // Remove style tags
                    const styles = clonedBody.querySelectorAll('style');
                    styles.forEach(style => style.remove());

                    // Remove select elements
                    const selects = clonedBody.querySelectorAll('select');
                    selects.forEach(select => select.remove());

                    try {
                        const customDropdown = clonedBody.querySelector('ul[role="listbox"]').parentNode;
                        if (customDropdown) {
                        } customDropdown.remove();
                    } catch (error) {

                    }

                    // Now get the innerText
                    const visibleText = clonedBody.innerText;
                    //const allPageText = doc.body.innerText || "";  // Extract text from the simulated document
                    document.getElementById("simulatorPageText").textContent = visibleText;

                    // Image Alt Text
                    const images = doc.querySelectorAll('img');
                    const imageAltBody = document.getElementById('simulator-image-alt-body');
                    const imageSizePromises = []; // Array to hold all the image size promises

                    images.forEach(image => {
                        const imageUrl = image.src.replace('http://127.0.0.1:5500/', domain).replace('https://app.digimetrics.ai/', domain);
                        imageSizePromises.push(
                            retryGetImageSize(imageUrl) // Use the retry function here
                                .then(sizeData => {
                                    let row = imageAltBody.insertRow();
                                    let thumbCell = row.insertCell();
                                    let urlCell = row.insertCell();
                                    let titleCell = row.insertCell();
                                    let altCell = row.insertCell();
                                    let sizeCell = row.insertCell(); // New cell for image size

                                    thumbCell.innerHTML = `<img src="${imageUrl}" alt="Thumbnail" class="thumbnail">`;
                                    urlCell.innerText = imageUrl;
                                    titleCell.innerText = image.title || "(No Title)"; // Show "(No Title)" if title is empty
                                    altCell.innerText = image.alt || "(No Alt Text)";
                                    sizeCell.innerText = sizeData || "Size Unavailable"; // Display image size

                                    // Highlight altCell if no alt text is present
                                    if (!image.alt) {
                                        altCell.style.backgroundColor = 'lightcoral';
                                    }
                                })
                                .catch(error => {
                                    console.error(`Failed to get size for ${imageUrl}: ${error}`);
                                    let row = imageAltBody.insertRow();
                                    let thumbCell = row.insertCell();
                                    let urlCell = row.insertCell();
                                    let titleCell = row.insertCell();
                                    let altCell = row.insertCell();
                                    let sizeCell = row.insertCell(); // New cell for image size

                                    thumbCell.innerHTML = `<img src="${imageUrl}" alt="Thumbnail" class="thumbnail">`;
                                    urlCell.innerText = imageUrl;
                                    titleCell.innerText = image.title || "(No Title)"; // Show "(No Title)" if title is empty
                                    altCell.innerText = image.alt || "(No Alt Text)";
                                    sizeCell.innerText = "Size Unavailable"; // Indicate size is unavailable

                                    // Highlight altCell if no alt text is present
                                    if (!image.alt) {
                                        altCell.style.backgroundColor = 'lightcoral';
                                    }
                                })
                        );
                    });

                    // Wait for all image size fetches and status code fetches to complete.
                    Promise.all([...imageSizePromises, ...linkPromises])
                        .then(() => {
                            document.getElementById("crawler-simulator-results").style.display = "block";
                            document.getElementById('simulatorButton').style.backgroundColor = "green";
                            resolve();
                        })
                        .catch(error => {
                            console.error("Error in displayResults", error);
                            reject(error);
                        });

                } catch (error) {
                    console.error("Error in displayResults", error);
                    reject(error);
                }
            });

        }

        async function retryGetImageSize(imageUrl, retries = 1) {
            try {
                return await getImageSize(imageUrl);
            } catch (error) {
                if (retries > 0) {
                    console.log(`Retrying getImageSize for ${imageUrl}, ${retries} retries remaining`);
                    await new Promise(resolve => setTimeout(resolve, 3000)); // Wait 1 second before retrying
                    return retryGetImageSize(imageUrl, retries - 1); // Decrement retries
                } else {
                    throw error; // If no retries left, throw the error
                }
            }
        }

        async function getImageSize(url) {
            const endpoint = "https://ftz64xiuh3.execute-api.ap-southeast-1.amazonaws.com/getImageSize";
            try {
                const response = await fetch(endpoint, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        url: url
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Initial request error:", error);
                throw error;
            }
        }

        async function sendInitialRequest(domain, urls) {
            const endpoint = "https://n0ge4xdang.execute-api.ap-southeast-1.amazonaws.com/getStatusCode";
            try {
                const response = await fetch(endpoint, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        domain: domain,
                        target_urls: urls,
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Initial request error:", error);
                throw error;
            }
        }


        async function pollForResults(domain, taskId) {
            const endpoint = "https://n0ge4xdang.execute-api.ap-southeast-1.amazonaws.com/getStatusCode";
            let intervalId;

            return new Promise((resolve, reject) => {
                intervalId = setInterval(async () => {
                    try {
                        const response = await fetch(endpoint, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                domain: domain,
                                task_id: taskId,
                            }),
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();

                        console.log(data);

                        if (data.remaining === 0) {
                            clearInterval(intervalId);
                            // Process results and resolve the promise
                            const results = {};
                            for (const page_to in data.results) {
                                results[domain + page_to['page_to']] = page_to["page_to_status_code"];
                            }
                            console.log(results);
                            resolve(results); // Resolve with the results
                        } else {
                            console.log(`Remaining: ${data.remaining}, Task ID: ${taskId}`);
                        }
                    } catch (error) {
                        clearInterval(intervalId);
                        console.error("Polling error:", error);
                        reject(error); // Reject the promise if there's an error
                    }
                }, 10000); // Poll every 10 seconds

                // Set initial delay to 10 seconds as requested
                setTimeout(() => {
                    // Do nothing - the interval will start after 10 seconds
                }, 10000);
            });
        }


        async function exportToPdf() {
            window.jsPDF = window.jspdf.jsPDF;
            // First, expand all collapsibles
            const collapsibles = document.querySelectorAll('.collapsible');
            collapsibles.forEach(collapsible => {
                collapsible.classList.add('active');
                collapsible.nextElementSibling.style.display = 'block';

                const icon = collapsible.querySelector('i');
                if (icon && icon.classList.contains('fa-plus-square')) {
                    icon.classList.remove('fa-plus-square');
                    icon.classList.add('fa-minus-square');
                }
            });

            // Get all journey collapsibles too
            const journeyCollapsibles = document.querySelectorAll('.journey-collapsible');
            journeyCollapsibles.forEach(collapsible => {
                collapsible.classList.add('active');
                collapsible.nextElementSibling.style.display = 'block';
                const totalSteps = parseInt(collapsible.dataset.totalSteps);
                const completedSteps = parseInt(collapsible.dataset.completedSteps);
                const percentage = (completedSteps / totalSteps) * 100;

                const progressBar = collapsible.querySelector('.progress-bar');
                progressBar.style.width = `${percentage}%`;
            });

            window.print();
        }

        function removeHighlights() {
            targeted_sections = ["simulatorPageText", "meta-table", "keyword-density", "headers-table", "links-table", "image-alt-table"];

            targeted_sections.forEach(sectionId => {
                const element = document.getElementById(sectionId);
                const highlighted = document.querySelectorAll('.highlight');
                highlighted.forEach(el => {
                    el.outerHTML = el.innerHTML; // Replace highlighted spans with their content
                });

            })
        }

        function highlightKeyword(keyword) {
            targeted_sections = ["simulatorPageText", "meta-table", "keyword-density", "headers-table", "links-table", "image-alt-table"];

            removeHighlights();

            targeted_sections.forEach(sectionId => {
                const element = document.getElementById(sectionId);

                if (element) {
                    if (!keyword) return; // If no keyword, do nothing

                    function highlightText(node, keyword) {
                        if (node.nodeType === Node.TEXT_NODE) {
                            const text = node.nodeValue;

                            // Create the flexible regex
                            const safeKeyword = keyword.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'); // Escape special characters in keyword for regex
                            const regexPattern = `(${safeKeyword.replace(/\s+/g, '[\\s-]*')})`;  // Replace spaces with flexible whitespace/hyphen
                            const regex = new RegExp(regexPattern, 'gi');

                            if (regex.test(text)) {
                                const newHtml = text.replace(regex, '<span class="highlight">$1</span>');
                                const tempElement = document.createElement('span');
                                tempElement.innerHTML = newHtml;

                                let nextSibling = node.nextSibling;
                                while (tempElement.firstChild) {
                                    node.parentNode.insertBefore(tempElement.firstChild, nextSibling);
                                }

                                node.remove();
                            }
                        } else if (node.nodeType === Node.ELEMENT_NODE) {
                            // Recursively process child nodes of element nodes
                            for (let i = 0; i < node.childNodes.length; i++) {
                                highlightText(node.childNodes[i], keyword);
                            }
                        }
                    }

                    // Start the recursive highlighting process from the root element
                    highlightText(element, keyword);

                } else {
                    console.warn(`Element with ID "${sectionId}" not found. Skipping.`);
                }
            });
        }

        let listCounter = 1;
        let deletedLists = []; // Store an array of deleted lists for multiple undo

        const undoBtn = document.getElementById('undoBtn');
        undoBtn.addEventListener('click', undoDelete);

        document.getElementById('addListBtn').addEventListener('click', addNewList);

        // No longer using a hardcoded mapping
        let keywordMapping = {};

        const listsContainer = document.getElementById('listsContainer');

        async function mapKeywords() {
            collapsible = document.getElementById('keyword_mapping')
            collapsible.classList.add('active');
            collapsible.nextElementSibling.style.display = 'block';
            const domain = document.getElementById('domain').value; // Get domain
            const location = document.getElementById('location').value;
            const language = document.getElementById('language').value;
            const keywordsInput = document.getElementById('keywords').value;

            console.log(keywordsInput);

            mapKeywordsBtn.innerText = "Mapping...";

            const keywords = keywordsInput.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);

            // Clear the existing mapping
            keywordMapping = {};
            clearAllLists(); //remove all the lists
            listCounter = 1; //restart the list counter


            // Create an array to hold the promises for each fetch request
            const fetchPromises = keywords.map(keyword => {
                return fetch('https://6s7ijwwsa8.execute-api.ap-southeast-1.amazonaws.com/dragDrop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        domain: domain,
                        keyword: keyword,
                        language: language,
                        location: location,
                    })
                }).then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                }).then(data => {
                    data = data.replace(domain, '').replace('http://', '').replace('www.', '').replace('https://', '');
                    // Use the API response URL as the key in your mapping
                    if (data) {
                        if (!keywordMapping[data]) {
                            keywordMapping[data] = [];
                        }
                        keywordMapping[data].push(keyword); // Map keyword to URL
                    } else {
                        console.warn(`API response missing URL for keyword: ${keyword}`);
                    }
                })
                    .catch(error => {
                        console.error(`Error for keyword "${keyword}":`, error);
                    });
            });

            try {
                // Wait for all promises to resolve before populating the lists
                await Promise.all(fetchPromises);

                // Now populate the lists based on the built-up keywordMapping
                populateListsFromMapping();
                mapKeywordsBtn.innerText = "Map Keywords";
            } catch (error) {
                console.error("An error occurred during the fetch requests:", error);
                mapKeywordsBtn.innerText = "Map Keywords";
            }
        }

        function createListContainer(url) {
            const listContainer = document.createElement('div');
            listContainer.classList.add('list-container');

            const renameInput = document.createElement('input');
            renameInput.type = 'text';
            renameInput.classList.add('rename-input');
            renameInput.value = url;

            // Add event listener for renameList
            renameInput.addEventListener('blur', function () {
                renameList(this);
            });

            const deleteButton = document.createElement('button');
            deleteButton.classList.add('delete-list-btn');
            deleteButton.textContent = 'X';
            deleteButton.addEventListener('click', function () {
                deleteList(this);
            });


            const listId = 'list' + listCounter;
            const list = document.createElement('ul');
            list.id = listId;
            list.classList.add('keyword-list');
            list.addEventListener('drop', drop);
            list.addEventListener('dragover', allowDrop);

            listContainer.appendChild(renameInput);
            listContainer.appendChild(deleteButton);
            listContainer.appendChild(list);

            // Add the "Page Recommendations" button
            const recommendationsButton = document.createElement('button');
            recommendationsButton.style.margin = "5px auto";
            recommendationsButton.style.display = "block";
            domain = document.getElementById('domain').value;
            recommendationsButton.textContent = 'Page Recommendations';
            recommendationsButton.addEventListener('click', function () {
                // Disable the button
                this.disabled = true;
                this.classList.add('disabled');

                // Get the URL from the input field *inside* this function
                const currentURL = domain + renameInput.value;

                console.log(currentURL);

                // Get the list items and put them into an array
                const listItems = Array.from(list.children).map(item => item.textContent.trim());

                getPageRecommendations(currentURL, listItems, this); // Pass the button element
            });
            listContainer.appendChild(recommendationsButton);
            return { listContainer, list, renameInput };
        }

        function createKeywordListItem(keyword) {
            const listItem = document.createElement('li');
            listItem.draggable = true;
            listItem.addEventListener('dragstart', drag);
            listItem.id = keyword;
            listItem.textContent = keyword; // Display keyword
            return listItem;
        }

        function populateListsFromMapping() {
            for (const url in keywordMapping) {
                if (keywordMapping.hasOwnProperty(url)) {
                    const { listContainer, list, renameInput } = createListContainer(url);

                    keywordMapping[url].forEach(keyword => {
                        const listItem = createKeywordListItem(keyword);
                        list.appendChild(listItem);
                    });

                    listsContainer.appendChild(listContainer);
                    listCounter++;
                }
            }
        }

        function clearAllLists() {
            while (listsContainer.firstChild) {
                listsContainer.removeChild(listsContainer.firstChild);
            }
        }



        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }

        const MAX_ITEMS_PER_LIST = 20; // Set the maximum limit
        const HEIGHT_PER_KEYWORD = 6; // Additional increase per keyword.



        function drop(ev) {
            ev.preventDefault();
            const target = ev.target;

            if (target.classList.contains('keyword-list')) {
                target.classList.remove('drag-over'); // Always remove the drag-over class

                // Check if the list is full again before dropping (safety check)
                if (target.children.length < MAX_ITEMS_PER_LIST) {
                    var data = ev.dataTransfer.getData("text");
                    var draggedElement = document.getElementById(data);
                    target.appendChild(draggedElement);

                    // Increase the height of the list
                    const currentHeight = parseInt(window.getComputedStyle(target).minHeight);
                    const numberOfKeywords = target.children.length;
                    const heightIncrease = (numberOfKeywords * HEIGHT_PER_KEYWORD);
                    target.style.minHeight = (currentHeight + heightIncrease) + 'px';

                    target.classList.remove('list-full'); // remove the list-full class if there are items to drop
                } else {
                    //Optional: Prevent the drop from occurring
                    //You can optionally add additional error handling here
                    target.classList.remove('list-full');
                    return;
                }

            } else {
                target.classList.remove('drag-over');
                target.classList.remove('list-full'); //also, prevent adding css if element does not have the correct class
            }
        }

        function addNewList() {
            const listsContainer = document.getElementById('listsContainer');

            const listContainer = document.createElement('div');
            listContainer.classList.add('list-container');

            const listId = 'list' + listCounter;
            const defaultName = '/url-' + listCounter;

            const renameInput = document.createElement('input');
            renameInput.type = 'text';
            renameInput.classList.add('rename-input');
            renameInput.value = defaultName;

            // Add event listener for renameList
            renameInput.addEventListener('blur', function () {
                renameList(this);
            });


            const deleteButton = document.createElement('button');
            deleteButton.classList.add('delete-list-btn');
            deleteButton.textContent = 'X';
            deleteButton.addEventListener('click', function () {
                deleteList(this);
            });

            const list = document.createElement('ul');
            list.id = listId;
            list.classList.add('keyword-list');
            list.addEventListener('drop', drop);
            list.addEventListener('dragover', allowDrop);

            listContainer.appendChild(renameInput);
            listContainer.appendChild(deleteButton);
            listContainer.appendChild(list);

            // Add the "Page Recommendations" button
            const recommendationsButton = document.createElement('button');
            recommendationsButton.textContent = 'Page Recommendations';
            recommendationsButton.addEventListener('click', function () {
                // Disable the button
                this.disabled = true;
                this.classList.add('disabled');

                const url = renameInput.value; //get the url value

                // Get the list items and put them into an array
                const listItems = Array.from(list.children).map(item => item.textContent.trim());

                console.log(listItems);

                getPageRecommendations(url, listItems, this); // Pass both URL and the array of list items and the button element
            });
            listContainer.appendChild(recommendationsButton);

            listsContainer.appendChild(listContainer);

            listCounter++;
        }

        function renameList(inputElement) {
            // No longer need to update a separate H2. The input itself IS the name.
        }

        function deleteList(deleteButton) {
            const listContainer = deleteButton.parentNode;
            const listsContainer = document.getElementById('listsContainer');

            // Store the deleted list details for undo
            deletedLists.push({
                element: listContainer,
                nextSibling: listContainer.nextSibling,
                listsContainer: listsContainer
            });

            listsContainer.removeChild(listContainer);

            // Enable the undo button if there are no more deleted lists
            undoBtn.disabled = deletedLists.length === 0;
        }

        function undoDelete() {
            if (deletedLists.length > 0) {
                const lastDeleted = deletedLists.pop(); // Get the last deleted list

                // Re-insert the deleted list
                if (lastDeleted.nextSibling) {
                    lastDeleted.listsContainer.insertBefore(lastDeleted.element, lastDeleted.nextSibling);
                } else {
                    lastDeleted.listsContainer.appendChild(lastDeleted.element);
                }

                // Disable the undo button if there are no more deleted lists
                undoBtn.disabled = deletedLists.length === 0;
            }
        }

        async function getPageRecommendations(url, listElement, button) {
            const recommendationEndpoint = 'https://pkkz2e02ch.execute-api.ap-southeast-1.amazonaws.com/onPageContentRecommendations';

            try {
                const recommendationResponse = await fetch(recommendationEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url,
                        "keywords": listElement
                    })
                });

                recommendationData = await recommendationResponse.json();

                // Create collapsible structure
                const collapsibleButton = document.createElement('button');
                collapsibleButton.classList.add('collapsible50');
                collapsibleButton.textContent = `${url}`;

                const contentDiv = document.createElement('div');
                contentDiv.classList.add('content');

                // Check if the response is a list of dictionaries
                if (Array.isArray(recommendationData) && recommendationData.length > 0 && typeof recommendationData[0] === 'object') {
                    // Create a table
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';

                    // Create table header
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    const headers = Object.keys(recommendationData[0]);

                    headers.forEach(headerText => {
                        const th = document.createElement('th');
                        th.textContent = headerText;
                        th.style.border = '1px solid #ddd';
                        th.style.padding = '8px';
                        th.style.textAlign = 'left';
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);


                    // Create table body
                    const tbody = document.createElement('tbody');
                    recommendationData.forEach(item => {
                        const row = document.createElement('tr');
                        headers.forEach(header => {
                            const cell = document.createElement('td');
                            cell.textContent = item[header];
                            cell.style.border = '1px solid #ddd';
                            cell.style.padding = '8px';
                            row.appendChild(cell);
                        });
                        tbody.appendChild(row);
                    });
                    table.appendChild(tbody);

                    contentDiv.innerHTML += '<h3>Content Optimisation</h3>';

                    contentDiv.appendChild(table); // Append the table to the content div

                    endpoint = 'https://udjdc333m9.execute-api.ap-southeast-1.amazonaws.com/getImages';

                    response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            url: url,
                            keywords: listElement // Send keywords to the backend
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    data = await response.json();

                    console.log(data);

                    const recommendationEndpoint = 'https://vwmqqj251d.execute-api.ap-southeast-1.amazonaws.com/onPageRecommendations';

                    const recommendationResponse = await fetch(recommendationEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            "data": data,
                            "keywords": listElement
                        })
                    });

                    if (!recommendationResponse.ok) {
                        throw new Error(`HTTP error! status: ${recommendationResponse.status}`);
                    }

                    recommendationData = await recommendationResponse.json();

                    data = recommendationData;
                    let resultsHTML = '';

                    let metaTableHTML = `<h3>Meta and Headings</h3>
        <table id="metaTable">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Current Value</th>
                    <th>Suggested Change</th>
                    <th>Rationale</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Meta Title</td>
                    <td>${data.meta_title.current_value}</td>
                    <td><textarea>${data.meta_title.suggested_value}</textarea></td>
                    <td>${data.meta_title.rationale}</td>
                </tr>
                <tr>
                    <td>Meta Description</td>
                    <td>${data.meta_description.current_value}</td>
                    <td><textarea>${data.meta_description.suggested_value}</textarea></td>
                    <td>${data.meta_description.rationale}</td>
                </tr>
                <tr>
                    <td>Canonical URL</td>
                    <td>${data.canonical_url.current_value}</td>
                    <td><textarea>${data.canonical_url.suggested_value}</textarea></td>
                    <td>${data.canonical_url.rationale}</td>
                </tr>`;

                    // Function to add heading rows
                    function addHeadingRows(headingType, headings) {
                        headings.forEach(heading => {
                            metaTableHTML += `
                <tr>
                    <td>${headingType}</td>
                    <td>${heading.current_value}</td>
                    <td><textarea>${heading.suggested_value}</textarea></td>
                    <td>${heading.rationale}</td>
                </tr>
            `;
                        });
                    }

                    addHeadingRows("H1 Heading", data.headings.h1);
                    addHeadingRows("H2 Heading", data.headings.h2);
                    addHeadingRows("H3 Heading", data.headings.h3);
                    addHeadingRows("H4 Heading", data.headings.h4);

                    metaTableHTML += `

            </tbody>
        </table>
    `;

                    let imageTableHTML = `<h3>Image Title and Alt Text</h3>
            <table id="imageTable">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Image URL <button class="copy-button" onclick="copyColumn(1, 'imageTable')">Copy</button></th>
                        <th>Image Preview</th>
                        <th>Alt Text <button class="copy-button" onclick="copyColumn(3, 'imageTable')">Copy</button></th>
                        <th>Suggested Alt Text</th>
                        <th>Rationale</th>
                    </tr>
                </thead>
                <tbody>
        `;

                    let i = 0;
                    for (const imageData of data.image_data) {
                        const imageUrl = Object.keys(imageData)[0];
                        const imageDetails = imageData[imageUrl];

                        imageTableHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td><a href="${imageUrl}" target="_blank">${imageUrl}</a></td>
                    <td><img src="${imageUrl}" alt="${imageDetails.current_value}"></td>
                    <td>${imageDetails.current_value}</td>
                    <td><textarea>${imageDetails.suggested_value}</textarea></td>
                    <td>${imageDetails.rationale}</td>
                </tr>
            `;
                        i++;
                    }


                    imageTableHTML += `
                </tbody>
            </table>
        `;

                    resultsHTML += metaTableHTML;

                    // Add export button after image table
                    resultsHTML += '<button class="export-button" onclick="exportOnPageToCSV()">Export to CSV</button>';

                    contentDiv.innerHTML += resultsHTML;
                    contentDiv.innerHTML += imageTableHTML;

                } else {
                    // If it's not a list of dictionaries, just set the innerHTML
                    contentDiv.innerHTML = recommendationData;
                }


                // Append elements to the recommendations div
                const recommendationsDiv = document.getElementById('recommendations');
                recommendationsDiv.appendChild(collapsibleButton);
                recommendationsDiv.appendChild(contentDiv);

                // Add event listener for collapsible functionality
                collapsibleButton.addEventListener('click', function () {
                    this.classList.toggle('active');
                    const content = this.nextElementSibling;
                    if (content.style.display === 'block') {
                        content.style.display = 'none';
                    } else {
                        content.style.display = 'block';
                    }
                });

                console.log(recommendationData); // Now logs the parsed JSON data

            } catch (error) {
                console.error("Error fetching recommendations:", error);
            } finally {
                // Re-enable the button in the finally block to ensure it always happens
                button.disabled = false;
                button.classList.remove('disabled');
            }
        }

        let selectedFiles_smm = [];

        const convertToBase64Smm = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve({
                    name: file.name,
                    type: file.type,
                    data: reader.result.split(',')[1]
                });
                reader.onerror = error => reject(error);
            });
        };

        function renderSmmResponseAttachments() {
            const fileInput = document.getElementById('smm-response-files');
            const previewContainer = document.getElementById('smm-response-attachment-preview');
            if (!previewContainer) return;

            // Sync selectedFiles_smm with input.files for initialization/consistency
            if (fileInput.files.length > 0) {
                // If we want to allow additive selection, we'd need more complex logic. 
                // For now, let's just make it simple: last selection wins or we manage the array.
                selectedFiles_smm = Array.from(fileInput.files);
            } else {
                selectedFiles_smm = [];
            }

            previewContainer.innerHTML = '';
            selectedFiles_smm.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'attachment-item';

                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.className = 'attachment-thumb';
                    img.src = URL.createObjectURL(file);
                    img.onload = () => URL.revokeObjectURL(img.src);
                    item.appendChild(img);
                } else {
                    const div = document.createElement('div');
                    div.className = 'attachment-icon-placeholder';
                    div.textContent = file.name.split('.').pop().substring(0, 4).toUpperCase();
                    item.appendChild(div);
                }

                const removeBtn = document.createElement('div');
                removeBtn.className = 'attachment-remove-btn';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = () => {
                    selectedFiles_smm.splice(index, 1);
                    // Update input.files synchronously is hard, so we just rely on the array for generation
                    renderSmmResponseAttachmentsSync();
                };
                item.appendChild(removeBtn);
                previewContainer.appendChild(item);
            });
        }

        // Helper to re-render without re-reading from input
        function renderSmmResponseAttachmentsSync() {
            const previewContainer = document.getElementById('smm-response-attachment-preview');
            previewContainer.innerHTML = '';
            selectedFiles_smm.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'attachment-item';
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.className = 'attachment-thumb';
                    img.src = URL.createObjectURL(file);
                    img.onload = () => URL.revokeObjectURL(img.src);
                    item.appendChild(img);
                } else {
                    const div = document.createElement('div');
                    div.className = 'attachment-icon-placeholder';
                    div.textContent = file.name.split('.').pop().substring(0, 4).toUpperCase();
                    item.appendChild(div);
                }
                const removeBtn = document.createElement('div');
                removeBtn.className = 'attachment-remove-btn';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = () => {
                    selectedFiles_smm.splice(index, 1);
                    renderSmmResponseAttachmentsSync();
                };
                item.appendChild(removeBtn);
                previewContainer.appendChild(item);
            });
        }

        async function generateHumanReply() {
            const commentInput = document.getElementById('smm-comment-input');
            const instructionInput = document.getElementById('smm-instructions-input');
            const replyDisplay = document.getElementById('smm-reply-display');
            const submitBtn = document.getElementById('generateSmmReplyBtn');

            const sensitivityEl = document.getElementById('sensitivity');
            const responseObjectiveEl = document.getElementById('response_objective');
            const responsePlatformEl = document.getElementById('response_platform');

            const commentText = commentInput.value.trim();
            const instructionText = instructionInput.value.trim();
            const hasAttachments = selectedFiles_smm.length > 0;

            if (!commentText && !hasAttachments) {
                alert("Please provide a comment or upload an attachment to generate a reply.");
                return;
            }

            const sensitivity = sensitivityEl ? sensitivityEl.value : "";
            const response_objective = responseObjectiveEl ? responseObjectiveEl.value : "";
            const response_platform = responsePlatformEl ? responsePlatformEl.value : "";

            submitBtn.innerText = "Processing Attachments...";
            submitBtn.disabled = true;

            const replyText = document.getElementById('smm-reply-text');
            if (replyText) replyText.innerText = "";
            replyDisplay.style.display = "none";

            let filesContent = "";
            let attachmentsPayload = [];

            try {
                // 1. Process Attachments
                if (hasAttachments) {
                    for (const file of selectedFiles_smm) {
                        if (file.type.startsWith('image/')) {
                            const base64Data = await convertToBase64Smm(file); // Reuse helper
                            attachmentsPayload.push(base64Data);
                        } else if (file.type.includes('pdf') || file.type.includes('word') || file.name.endsWith('.docx')) {
                            // Parse Document Content
                            const formData = new FormData();
                            formData.append('file', file);
                            const pdfResp = await fetch('https://tpsk8n8hsh.execute-api.ap-southeast-1.amazonaws.com/pdfParser', {
                                method: 'POST',
                                body: formData
                            });
                            const pdfData = await pdfResp.json();
                            const extractedText = pdfData.text || pdfData.body || "";
                            filesContent += `\n--- Context from file: ${file.name} ---\n${extractedText}\n`;
                        }
                    }
                }

                submitBtn.innerText = "Drafting Reply...";

                const payload = {
                    question: commentText || "Please analyze the attached image/document and suggest a reply.",
                    instruction: instructionText + (filesContent ? "\n\nSUPPLEMENTARY DOCUMENTATION:\n" + filesContent : ""),
                    sensitivity: sensitivity,
                    response_objective: response_objective,
                    response_platform: response_platform,
                    attachments: attachmentsPayload
                };

                const response = await fetch('https://5m2upu2fxf.execute-api.ap-southeast-1.amazonaws.com/communityEngagement', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Server error: ${response.statusText}`);

                const data = await response.json();
                if (replyText) {
                    replyText.innerText = data.answer || "No response generated.";
                    replyDisplay.style.display = "block";
                }

                const smmBtn = document.getElementById("smmReplyButton");
                if (smmBtn) smmBtn.style.backgroundColor = "green";

            } catch (error) {
                console.error("Error generating reply:", error);
                replyDisplay.style.display = "block";
                if (replyText) {
                    replyText.innerText = "Sorry, I couldn't generate a reply. Error: " + error.message;
                    replyText.style.color = "red";
                }
            } finally {
                submitBtn.innerText = "Generate Reply";
                submitBtn.disabled = false;
            }
        }

        async function generateSocialMediaStrategy() {
            const btn = document.getElementById('generateSmsBtn');
            const outputDisplay = document.getElementById('sms-results-display');
            const houseContainer = document.getElementById('sms-house-container');
            const gridContainer = document.getElementById('sms-grid-container');

            // Collect Form Data
            const brandContext = document.getElementById('brand_context').value;
            const strategicAmbition = document.getElementById('strategic_ambition').value;
            const strategicChallenge = document.getElementById('strategic_challenge').value;
            const priorityAudiences = document.getElementById('priority_audiences').value;
            const proofPoints = document.getElementById('proof_points').value;
            const fileInput = document.getElementById('sms_files');

            if (!brandContext && !strategicAmbition && !strategicChallenge && (!fileInput.files || fileInput.files.length === 0)) {
                alert("Please provide either brand context details or upload supporting documents.");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Strategising...';
            updateCollapsibleState('smsButton', 'running');

            let filesContent = "";
            if (fileInput.files && fileInput.files.length > 0) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Parsing Files...';
                for (let i = 0; i < fileInput.files.length; i++) {
                    const file = fileInput.files[i];
                    const formData = new FormData();
                    formData.append('file', file);
                    try {
                        const pdfResponse = await fetch('https://tpsk8n8hsh.execute-api.ap-southeast-1.amazonaws.com/pdfParser', {
                            method: 'POST',
                            body: formData
                        });
                        const pdfData = await pdfResponse.json();
                        const extractedText = pdfData.text || pdfData.body || "";
                        filesContent += `\n--- Content from file: ${file.name} ---\n${extractedText}\n`;
                    } catch (e) {
                        console.error(`Parsing failed for file: ${file.name}`, e);
                    }
                }
            }

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Strategising...';

            try {
                const response = await fetch('https://8domnt5y2f.execute-api.ap-southeast-1.amazonaws.com/socialMediaStrategy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'social_media_strategy',
                        brand_context: brandContext,
                        strategic_ambition: strategicAmbition,
                        strategic_challenge: strategicChallenge,
                        priority_audiences: priorityAudiences,
                        proof_points: proofPoints,
                        additional_info: filesContent
                    })
                });

                if (!response.ok) throw new Error("Failed to generate strategy.");

                const resData = await response.json();
                let data = resData.answer;

                // Robust parsing for Proxy Integration (wrapped in body)
                if (!data && resData.body) {
                    try {
                        const parsedBody = typeof resData.body === 'string' ? JSON.parse(resData.body) : resData.body;
                        data = parsedBody.answer || parsedBody;
                    } catch (e) {
                        data = resData.body;
                    }
                }

                // If data is still a string, try one more parse (in case 'answer' was a JSON string)
                if (typeof data === 'string' && (data.trim().startsWith('{') || data.trim().startsWith('['))) {
                    try {
                        data = JSON.parse(data);
                    } catch (e) {
                        console.warn("Attempted to parse string data as JSON but failed", e);
                    }
                }

                // Fallback: if data is still a string and we can't find .house, render as innerHTML
                if (typeof data === 'string' && !data.house) {
                    console.warn("Received content that doesn't match expected JSON schema, rendering as-is");
                    document.getElementById('sms-output-text').innerHTML = data;
                    outputDisplay.style.display = 'block';
                    updateCollapsibleState('smsButton', 'success');
                    return;
                }

                // Ensure data is defined before accessing properties
                if (!data) {
                    throw new Error("Received empty or invalid data from strategy generator.");
                }

                // Populate House
                if (data.house) {
                    document.getElementById('house-positioning').innerText = data.house.positioning || "";
                    const obs = document.getElementById('house-objectives').querySelectorAll('.objective-bar');
                    if (data.house.objectives && data.house.objectives.length >= 3) {
                        obs[0].innerText = data.house.objectives[0];
                        obs[1].innerText = data.house.objectives[1];
                        obs[2].innerText = data.house.objectives[2];
                    }
                    houseContainer.style.display = 'block';
                }

                // Populate Grid
                if (data.grid) {
                    document.getElementById('grid-primary-goal').innerText = data.grid.primary_goal || "";

                    const methods = ["Inspire", "Cultivate", "Connect", "Amplify"];
                    const stratCells = document.getElementById('grid-strategies').querySelectorAll('td');
                    const audCells = document.getElementById('grid-audiences').querySelectorAll('td');
                    const pillCells = document.getElementById('grid-pillars').querySelectorAll('td');

                    methods.forEach((m, i) => {
                        const mData = data.grid.methods[m] || {};
                        stratCells[i].innerText = mData.strategy || "";
                        audCells[i].innerText = mData.audience || "";
                        pillCells[i].innerText = mData.pillars || "";
                    });

                    gridContainer.style.display = 'table';
                }

                outputDisplay.style.display = 'block';
                updateCollapsibleState('smsButton', 'success');
                outputDisplay.scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch (error) {
                console.error("Error generating strategy:", error);
                outputDisplay.style.display = 'block';
                document.getElementById('sms-output-text').innerText = `Error: ${error.message}`;
                updateCollapsibleState('smsButton', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Generate Strategy House';
            }
        }

        let selectedFiles_pillar = [];

        function renderPillarAttachments() {
            const fileInput = document.getElementById('pillar_pdf');
            const previewContainer = document.getElementById('pillar-attachment-preview');
            if (!previewContainer) return;
            selectedFiles_pillar = Array.from(fileInput.files);
            renderPillarAttachmentsSync();
        }

        function renderPillarAttachmentsSync() {
            const previewContainer = document.getElementById('pillar-attachment-preview');
            previewContainer.innerHTML = '';
            selectedFiles_pillar.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'attachment-item';
                const div = document.createElement('div');
                div.className = 'attachment-icon-placeholder';
                div.textContent = file.name.split('.').pop().substring(0, 4).toUpperCase();
                item.appendChild(div);

                const removeBtn = document.createElement('div');
                removeBtn.className = 'attachment-remove-btn';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = () => {
                    selectedFiles_pillar.splice(index, 1);
                    renderPillarAttachmentsSync();
                };
                item.appendChild(removeBtn);
                previewContainer.appendChild(item);
            });
        }

        async function generateContentPillarFramework() {
            const btn = document.getElementById('generatePillarBtn');
            const outputDisplay = document.getElementById('pillar-results-display');
            const outputText = document.getElementById('pillar-output-text');
            const pdfInput = document.getElementById('pillar_pdf');

            // Collect Form Data
            const businessModel = document.getElementById('pillar_business_model').value;
            const objectives = Array.from(document.querySelectorAll('input[name="pillar_objective"]:checked')).map(cb => cb.value);
            const audienceType = document.getElementById('pillar_audience_type').value;
            const complexity = document.getElementById('pillar_complexity').value;
            const platforms = Array.from(document.querySelectorAll('input[name="pillar_platform"]:checked')).map(cb => cb.value);
            const sensitivity = document.getElementById('pillar_sensitivity').value;
            const tolerance = document.getElementById('pillar_promo_tolerance').value;
            const website = document.getElementById('pillar_website').value.trim();
            const brandGuide = document.getElementById('pillar_brand_guide').value;
            const competitors = document.getElementById('pillar_competitors').value;

            if (objectives.length > 2) {
                alert("Please select a maximum of 2 business objectives.");
                return;
            }
            if (objectives.length === 0) {
                alert("Please select at least one business objective.");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Strategising...';
            updateCollapsibleState('pillarFrameworkButton', 'running');

            let pdfContent = "";
            if (selectedFiles_pillar.length > 0) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Parsing Files...';
                for (const file of selectedFiles_pillar) {
                    const formData = new FormData();
                    formData.append('file', file);
                    try {
                        const pdfResponse = await fetch('https://tpsk8n8hsh.execute-api.ap-southeast-1.amazonaws.com/pdfParser', {
                            method: 'POST',
                            body: formData
                        });
                        const pdfData = await pdfResponse.json();
                        const extractedText = pdfData.text || pdfData.body || "";
                        pdfContent += `\n--- Content from file: ${file.name} ---\n${extractedText}\n`;
                    } catch (e) {
                        console.error(`Parsing failed for file: ${file.name}`, e);
                    }
                }
            }

            try {
                const response = await fetch('https://j4aca9hcmh.execute-api.ap-southeast-1.amazonaws.com/contentPillar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'pillar_framework',
                        business_model: businessModel,
                        objectives: objectives,
                        audience_type: audienceType,
                        decision_complexity: complexity,
                        platforms: platforms,
                        risk_sensitivity: sensitivity,
                        promotional_tolerance: tolerance,
                        reference_urls: { website, brandGuide, competitors },
                        additional_info: pdfContent
                    })
                });

                if (!response.ok) throw new Error("Failed to generate framework.");

                const data = await response.json();
                console.log("Pillar Framework Data:", data);

                if (data.answer) {
                    answer = data.answer;
                } else if (data.body) {
                    try {
                        const body = typeof data.body === 'string' ? JSON.parse(data.body) : data.body;
                        answer = body.answer || body.result || "";
                    } catch (e) {
                        answer = data.body;
                    }
                } else {
                    answer = typeof data === 'string' ? data : JSON.stringify(data);
                }

                // If answer is still an object (e.g. from data.answer), extract its text
                if (typeof answer === 'object' && answer !== null) {
                    answer = answer.text || answer.result || JSON.stringify(answer);
                }

                outputText.innerHTML = answer;
                outputDisplay.style.display = "block";
                updateCollapsibleState('pillarFrameworkButton', 'success');
                outputDisplay.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error("Error generating pillar framework:", error);
                alert("An error occurred while generating the framework. Check console for details.");
                updateCollapsibleState('pillarFrameworkButton', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Generate Strategic Framework';
            }
        }

        function copyToClipboard(elementId, event) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const selection = window.getSelection();
            selection.removeAllRanges();
            const range = document.createRange();
            range.selectNodeContents(element);
            selection.addRange(range);

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    // Find the button that triggered this
                    const btn = event.currentTarget;
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                    }, 2000);
                }
            } catch (err) {
                console.error('Unable to copy', err);
            } finally {
                selection.removeAllRanges();
            }
        }

        function formatMarkdownToHTML(md) {
            if (typeof md !== 'string') {
                console.error("formatMarkdownToHTML expected a string, but received:", md);
                return "";
            }
            // Very basic markdown to HTML for tables and bold
            let html = md.replace(/### (.*)/g, '<h3>$1</h3>')
                .replace(/## (.*)/g, '<h2>$1</h2>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n\n/g, '<br><br>');

            // Table conversion
            if (html.includes('|')) {
                const lines = html.split('\n');
                let inTable = false;
                let tableHtml = '<table class="generated-table"><tbody>';

                lines.forEach(line => {
                    if (line.trim().startsWith('|')) {
                        if (!inTable) inTable = true;
                        const cells = line.split('|').filter(c => c.trim().length > 0 || line.indexOf('|' + c + '|') !== -1).map(c => c.trim());
                        if (cells.length > 0 && !line.includes('---')) {
                            tableHtml += '<tr>' + cells.map(c => `<td>${c}</td>`).join('') + '</tr>';
                        }
                    } else if (inTable) {
                        inTable = false;
                        tableHtml += '</tbody></table>';
                        html = html.replace(line.trim(), tableHtml + '\n' + line.trim());
                    }
                });
                if (inTable) html += '</tbody></table>';
            }
            return html;
        }


        function allowDrop(ev) {
            ev.preventDefault();
            const target = ev.target;

            if (target.classList.contains('keyword-list')) {
                // Check if the list is full
                if (target.children.length < MAX_ITEMS_PER_LIST) {
                    target.classList.add('drag-over');
                } else {
                    // Optional: Provide visual feedback that the list is full
                    target.classList.add('list-full'); // Add a class for styling, e.g., red border
                }
            }
        }

        async function scanForCompliance(flowType = 'new') {
            const isNew = flowType === 'new';
            const topicId = isNew ? 'newArticleTopic' : 'primaryKeyword';
            const listId = isNew ? 'complianceGuidelinesList' : 'complianceGuidelinesList-Optimise';
            const btnId = isNew ? 'btnScanCompliance' : 'btnScanCompliance-Optimise';

            let topic = document.getElementById(topicId).value.trim();

            // Fallback for optimise flow: try title if keyword is empty
            if (!isNew && !topic) {
                topic = document.getElementById('editorTitle').value.trim();
            }

            const listContainer = document.getElementById(listId);
            const scanBtn = document.getElementById(btnId);

            if (!topic) {
                alert(`Please enter a ${isNew ? 'topic' : 'primary keyword/title'} first so the AI can identify relevant regulations.`);
                return;
            }

            scanBtn.disabled = true;
            const originalBtnHtml = scanBtn.innerHTML;
            scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
            listContainer.innerHTML = '<div style="font-size: 12px; color: #004c9d;">Identifying regulatory requirements...</div>';

            try {
                const response = await fetch(OPTIMISER_ENDPOINTS.COMPLIANCE_RECOMMENDER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: topic,
                        industry: aiContentSettings.industry,
                        jurisdiction: aiContentSettings.jurisdictions,
                        audience: aiContentSettings.audience
                    })
                });

                const data = await response.json();
                const result = parseLambdaResponse(data);
                const suggestions = result.suggestions || [];

                if (suggestions.length === 0) {
                    listContainer.innerHTML = '<div style="font-size: 12px; color: #666;">No specific regulations identified for this topic.</div>';
                } else {
                    listContainer.innerHTML = '';
                    suggestions.forEach((item, index) => {
                        const wrapper = document.createElement('div');
                        wrapper.style.cssText = 'background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 6px; flex: 1; min-width: 250px; display: flex; align-items: flex-start; gap: 10px;';

                        const isChecked = index === 0 ? 'checked' : '';
                        wrapper.innerHTML = `
                            <input type="checkbox" id="chk_${item.id}_${flowType}" value="${item.name}" ${isChecked} style="margin-top: 3px;">
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <label for="chk_${item.id}_${flowType}" style="font-size: 13px; font-weight: bold; color: #333; cursor: pointer; display: block;">${item.name}</label>
                                    ${item.url ? `<a href="${item.url}" target="_blank" title="View Source" style="color: #1a73e8; font-size: 12px; margin-left:10px;"><i class="fas fa-external-link-alt"></i></a>` : ''}
                                </div>
                                <p style="font-size: 11px; color: #666; margin: 3px 0 0 0; line-height: 1.3;">${item.description}</p>
                            </div>
                        `;
                        listContainer.appendChild(wrapper);
                    });
                }
            } catch (error) {
                console.error("Compliance Scan Error:", error);
                listContainer.innerHTML = '<div style="font-size: 12px; color: #d93025;">Error scanning for guidelines. You can still manually enter requirements below.</div>';
            } finally {
                scanBtn.disabled = false;
                scanBtn.innerHTML = originalBtnHtml;
            }
        }

        function getSelectedCompliance(flowType = 'new') {
            const isNew = flowType === 'new';
            const listId = isNew ? 'complianceGuidelinesList' : 'complianceGuidelinesList-Optimise';
            const customId = isNew ? 'customCompliance' : 'customCompliance-Optimise';

            const container = document.getElementById(listId);
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            let complianceText = Array.from(checkboxes).map(cb => cb.value).join(', ');

            const customValue = document.getElementById(customId).value.trim();
            if (customValue) {
                complianceText += (complianceText ? '; ' : '') + customValue;
            }

            return complianceText;
        }

        function switchOptimiserFlow(type) {
            currentOptimiserFlow = type;
            const decision = document.getElementById('optimiserDecisionPanel');
            const newFlow = document.getElementById('createNewFlow');
            const optimiseFlow = document.getElementById('optimiseExistingFlow');
            const optimiserLayout = document.querySelector('.optimiser-layout');

            decision.style.display = (type === 'reset') ? 'block' : 'none';
            newFlow.classList.toggle('active', type === 'new');
            optimiseFlow.classList.toggle('active', type === 'optimise');

            // Reset outline step UI if switching away from specific flows
            if (type === 'reset' || type === 'new' || type === 'optimise') {
                const outlineWrapper = document.getElementById('outlineStepWrapper');
                if (outlineWrapper) outlineWrapper.style.display = 'none';

                // Reset compliance guidelines UI for both flows
                ['complianceGuidelinesList', 'complianceGuidelinesList-Optimise'].forEach(id => {
                    const list = document.getElementById(id);
                    if (list) list.innerHTML = `<div style="font-size: 12px; color: #999; width: 100%; font-style: italic;">No guidelines checked yet. Click "Check" to identify relevant regulations for your ${id.includes('Optimise') ? 'keywords' : 'topic'}.</div>`;
                });
            }

            // Show editor immediately for both paths to ensure "AI Links" and other tools are available
            if (type === 'new' || type === 'optimise') {
                if (optimiserLayout) optimiserLayout.style.display = 'flex';
            } else if (type === 'reset') {
                if (optimiserLayout) optimiserLayout.style.display = 'none';
            }

            // Optional: Reset data context if switching
            if (type === 'new') {
                console.log("Entering New Article flow");
            } else if (type === 'optimise') {
                console.log("Entering Optimise Existing flow");
            }
        }

        async function analyzeAndProposeOutline() {
            const keyword = document.getElementById('primaryKeywordNew').value.trim();
            const location = document.getElementById('locationOptimiserNew').value;
            const topic = document.getElementById('newArticleTopic').value.trim();
            const btn = document.getElementById('btnAnalyzeAndPropose');

            if (!keyword) return alert("Please specify a primary keyword for analysis.");

            btn.disabled = true;
            const originalBtnHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching SERPs...';
            updateCollapsibleState('aiContentOptimiserBtn', 'running');

            try {
                // 1. Fetch up to 50 SERP URLs
                const serpResponse = await fetch('https://2wv8kyc8dg.execute-api.ap-southeast-1.amazonaws.com/moreSerps', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword, language: "English", location: location, "page_types": "any", limit: 30 }),
                });
                const serpData = await serpResponse.json();
                const serpUrls = Object.values(serpData).map(result => result.url);
                console.log("SERP Analysis (New): Found URLs:", serpUrls.length);

                // Save for Load More
                allCompetitorUrls_Optimiser.new = serpUrls;
                displayedCount_Optimiser.new = 0;

                // 2. Initialize first batch skeletons (up to 10)
                const initialBatchSize = Math.min(10, serpUrls.length);
                const initialBatch = serpUrls.slice(0, initialBatchSize);
                const skeletalData = initialBatch.map((url, index) => ({
                    url, rank: index + 1, loading: true
                }));
                renderCompetitorCards(skeletalData, 'competitorInsightsGrid', 'competitorAnalysisWrapper', keyword);

                // Update displayed count
                displayedCount_Optimiser.new = initialBatchSize;

                // Show Load More (Always visible if any results exist, or just always)
                const loadMoreWrapper = document.getElementById('loadMoreWrapper');
                const loadMoreBtn = document.getElementById('btnLoadMoreCompetitors');
                if (loadMoreBtn) loadMoreBtn.innerHTML = '<i class="fas fa-plus"></i> Load More Competitors';
                if (loadMoreWrapper) loadMoreWrapper.style.display = 'block';

                // 3. Process first batch topics
                const analysisPromises = initialBatch.map(async (url, index) => {
                    const cardId = `comp-card-competitorInsightsGrid-${index}`;
                    const cardElement = document.getElementById(cardId);

                    const contentPromise = fetchWithRetry('https://u24f9208q0.execute-api.ap-southeast-1.amazonaws.com/gptTopicsPerUrl', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, keyword }),
                    }, 2, data => data && data.body && data.body[url] && data.body[url].topics).catch(() => ({ url, error: true }));

                    const designPromise = fetchWithRetry(OPTIMISER_ENDPOINTS.DESIGN_ANALYSIS, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url }),
                    }, 2, data => (data.body || data).elements).catch(() => ({ url, designError: true }));

                    const [contentData, designData] = await Promise.all([contentPromise, designPromise]);
                    const result = { ...contentData, designData, rank: index + 1, url };

                    if (cardElement) {
                        cardElement.innerHTML = getCompetitorCardInnerHtml(result, cardId, keyword);
                    }
                    return result;
                });

                await Promise.all(analysisPromises);
                updateCollapsibleState('aiContentOptimiserBtn', 'success');

                // Auto-activate all content tabs to sync with AI suggestions
                autoActivateAllContentTabs('competitorInsightsGrid');

                // Show selection area
                const selectionWrapper = document.getElementById('selectedTopicsWrapper');
                if (selectionWrapper) {
                    selectionWrapper.style.display = 'block';
                    selectionWrapper.scrollIntoView({ behavior: 'smooth' });
                }

            } catch (error) {
                console.error("Analysis error:", error);
                updateCollapsibleState('aiContentOptimiserBtn', 'error');
                alert("Failed to analyze SERPs.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnHtml;
            }
        }

        async function analyseCompetitorsOptimise() {
            const keyword = document.getElementById('primaryKeyword').value.trim();
            const location = document.getElementById('locationOptimiserOptimise').value;
            const btn = document.getElementById('btnAnalyseCompetitorsOptimise');

            if (!keyword) return alert("Please specify a primary keyword for analysis.");

            btn.disabled = true;
            const originalBtnHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching SERPs...';
            updateCollapsibleState('aiContentOptimiserBtn', 'running');

            try {
                // 1. Fetch up to 50 SERP URLs
                const serpResponse = await fetch('https://2wv8kyc8dg.execute-api.ap-southeast-1.amazonaws.com/moreSerps', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword, language: "English", location: location, "page_types": "any", limit: 30 }),
                });
                const serpData = await serpResponse.json();
                const serpUrls = Object.values(serpData).map(result => result.url);
                console.log("SERP Analysis (Optimise): Found URLs:", serpUrls.length);

                // Save for Load More
                allCompetitorUrls_Optimiser.optimise = serpUrls;
                displayedCount_Optimiser.optimise = 0;

                // 2. Initialize first batch skeletons (up to 10)
                const initialBatchSize = Math.min(10, serpUrls.length);
                const initialBatch = serpUrls.slice(0, initialBatchSize);
                const skeletalData = initialBatch.map((url, index) => ({
                    url, rank: index + 1, loading: true
                }));
                renderCompetitorCards(skeletalData, 'competitorInsightsGrid-Optimise', 'competitorAnalysisWrapper-Optimise', keyword);

                // Update displayed count
                displayedCount_Optimiser.optimise = initialBatchSize;

                // Show Load More (Always visible if results exist)
                const loadMoreWrapper = document.getElementById('loadMoreWrapper-Optimise');
                const loadMoreBtn = document.getElementById('btnLoadMoreCompetitors-Optimise');
                if (loadMoreBtn) loadMoreBtn.innerHTML = '<i class="fas fa-plus"></i> Load More Competitors';
                if (loadMoreWrapper) loadMoreWrapper.style.display = serpUrls.length > 0 ? 'block' : 'none';

                // 3. Process first batch topics
                const analysisPromises = initialBatch.map(async (url, index) => {
                    const cardId = `comp-card-competitorInsightsGrid-Optimise-${index}`;
                    const cardElement = document.getElementById(cardId);

                    const contentPromise = fetchWithRetry('https://u24f9208q0.execute-api.ap-southeast-1.amazonaws.com/gptTopicsPerUrl', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, keyword }),
                    }, 2, data => data && data.body && data.body[url] && data.body[url].topics).catch(() => ({ url, error: true }));

                    const designPromise = fetchWithRetry(OPTIMISER_ENDPOINTS.DESIGN_ANALYSIS, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url }),
                    }, 2, data => (data.body || data).elements).catch(() => ({ url, designError: true }));

                    const [contentData, designData] = await Promise.all([contentPromise, designPromise]);
                    const result = { ...contentData, designData, rank: index + 1, url };

                    if (cardElement) {
                        cardElement.innerHTML = getCompetitorCardInnerHtml(result, cardId, keyword);
                    }
                    return result;
                });

                await Promise.all(analysisPromises);
                updateCollapsibleState('aiContentOptimiserBtn', 'success');

                // Auto-activate all content tabs
                autoActivateAllContentTabs('competitorInsightsGrid-Optimise');

                // Show selection area
                const selectionWrapper = document.getElementById('selectedTopicsWrapper-Optimise');
                if (selectionWrapper) {
                    selectionWrapper.style.display = 'block';
                    selectionWrapper.scrollIntoView({ behavior: 'smooth' });
                }

            } catch (error) {
                console.error("Analysis error:", error);
                updateCollapsibleState('aiContentOptimiserBtn', 'error');
                alert("Failed to analyze SERPs.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnHtml;
            }
        }

        async function applyGapAnalysisRewrite() {
            const btn = document.getElementById('btnApplyGapRewrite');
            // Read from innerText of the rich-text div for AI processing
            const suggestionDiv = document.getElementById('gapAnalysisResults-Optimise');
            const suggestions = suggestionDiv ? suggestionDiv.innerText.trim() : "";
            const editor = document.getElementById('editorContent');
            const originalContent = editor.innerText.trim();
            const originalHtml = editor.innerHTML;
            const keyword = document.getElementById('primaryKeyword').value.trim();

            if (!suggestions) return alert("Please ensure there are suggestions to apply.");
            if (!originalContent) return alert("Editor content is empty.");

            btn.disabled = true;
            const originalBtnHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rewriting article...';
            updateCollapsibleState('aiContentOptimiserBtn', 'running');

            try {
                const personaContext = getPersonaData();
                const selectedTopics = getSelectedTopicsData(currentOptimiserFlow);

                const rewritePrompt = `
REWRITE THE FOLLOWING ARTICLE BASED ON THE PROVIDED IMPROVEMENT SUGGESTIONS.

${personaContext ? "STRICTLY ADHERE TO THESE TARGET PERSONAS DURING REWRITE:\n" + personaContext + "\n" : ""}
${selectedTopics ? "ENSURE THESE COMPETITOR TOPICS ARE COVERED:\n" + selectedTopics + "\n" : ""}

PRIMARY KEYWORD: "${keyword}"

IMPROVEMENT SUGGESTIONS:
"""
${suggestions}
"""

ORIGINAL ARTICLE CONTENT:
"""
${originalContent}
"""

INSTRUCTIONS:
1. Integrate all the improvement suggestions into the article.
2. Ensure the content gaps are filled and depth is added where suggested.
3. Maintain a natural, professional flow.
4. Do NOT just append the suggestions; fully integrate them into the existing structure.
5. Return the full rewritten article in Markdown format. IMPORTANT: DO NOT include any markdown code block markers like \` \` \` or \` \` \`markdown in your response.
                    `.trim();

                const response = await fetch(OPTIMISER_ENDPOINTS.CONTENT_AI, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generate',
                        prompt: rewritePrompt,
                        settings: aiContentSettings
                    })
                });

                const data = await response.json();
                const result = parseLambdaResponse(data);

                if (result && result.result) {
                    // 1. Clean response: Strip code block markers if AI ignored instructions
                    let cleanedResult = result.result.replace(/```markdown\n?/gi, '').replace(/```\n?/gi, '').trim();

                    // 2. Format to HTML
                    const newHtml = formatMarkdown(cleanedResult);

                    // 3. Store state for Accept/Reject
                    originalHtmlReview = originalHtml;
                    pendingRewriteHtml = newHtml;

                    // 4. Compute and show diff
                    const diffHtml = computeDiff(originalHtml, newHtml);
                    editor.innerHTML = diffHtml;
                    editor.classList.add('review-mode');
                    editor.contentEditable = "false"; // Disable editing during review

                    // 5. Show review bar
                    document.getElementById('rewriteReviewBar').style.display = 'flex';

                    updateEditorMetrics();
                } else {
                    alert("Failed to rewrite article. Please try again.");
                }

            } catch (error) {
                console.error("Rewrite error:", error);
                alert("An error occurred while rewriting the article.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnHtml;
            }
        }

        /**
         * Generic function to render competitor cards into a specific grid
         */
        function renderCompetitorCards(analysisDataArray, gridId, wrapperId, keyword, append = false) {
            const competitorWrapper = document.getElementById(wrapperId);
            const competitorGrid = document.getElementById(gridId);
            if (competitorWrapper && competitorGrid) {
                if (!append) competitorGrid.innerHTML = '';

                analysisDataArray.forEach((item, index) => {
                    const card = document.createElement('div');
                    card.className = 'competitor-card';
                    card.id = `comp-card-${gridId}-${displayedCount_Optimiser[gridId.includes('Optimise') ? 'optimise' : 'new'] + index}`;
                    card.innerHTML = getCompetitorCardInnerHtml(item, card.id, keyword);
                    competitorGrid.appendChild(card);
                });

                competitorWrapper.style.display = 'block';
            }
        }

        function getCompetitorCardInnerHtml(item, cardId, keyword) {
            const rank = item ? item.rank : '';
            const url = item.url || 'Unknown URL';
            const displayUrl = url.length > 50 ? url.substring(0, 47) + '...' : url;

            if (item && item.loading) {
                return `
                    <div class="competitor-card-rank">${rank || ''}</div>
                    <div class="card-delete-btn" title="Delete competitor" onclick="deleteCard('${cardId}')">
                        <i class="fas fa-trash-alt"></i>
                    </div>
                    <div class="competitor-card-url" title="${url}">
                        <i class="fas fa-spinner fa-spin"></i> ${displayUrl}
                    </div>
                    <div style="padding: 30px 10px; text-align: center; color: #999; font-size: 0.85em;">
                        <i class="fas fa-search-location fa-2x" style="display: block; margin-bottom: 10px; opacity: 0.3;"></i>
                        Analyzing competitor page...
                    </div>
                `;
            }

            const topics = (item && item.body && item.body[url]) ? item.body[url].topics : null;
            const topicEntries = topics ? Object.entries(topics) : [];
            const designData = item.designData;

            if (item && !item.error) {
                return `
                    <div class="competitor-card-rank">${rank || ''}</div>
                    <div class="card-delete-btn" title="Delete competitor" onclick="deleteCard('${cardId}')">
                        <i class="fas fa-trash-alt"></i>
                    </div>
                    <a href="${url}" target="_blank" class="competitor-card-url" title="${url}">
                        <i class="fas fa-external-link-alt"></i> ${displayUrl}
                    </a>
                    
                    <div class="competitor-card-toggle">
                        <button class="active" onclick="switchCompetitorCardTab('${cardId}', 'content')">Content</button>
                        <button onclick="switchCompetitorCardTab('${cardId}', 'design')">Design</button>
                    </div>

                    <div class="tab-content content-tab">
                        <table class="competitor-table">
                            <thead>
                                <tr>
                                    <th>Topic</th>
                                    <th style="text-align: right;">Words</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${topicEntries.map(([topic, count]) => `
                                    <tr onclick="toggleTopicSelection(this, '${topic.replace(/'/g, "\\'")}', '${cardId.includes('Optimise') ? 'optimise' : 'new'}')">
                                        <td>${topic}</td>
                                        <td class="word-count-cell">${count.toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                                ${topicEntries.length === 0 ? '<tr><td colspan="2" style="text-align:center; color:#999; padding: 10px;">No content data available.</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>

                    <div class="tab-content design-tab" style="display: none;">
                        ${renderDesignInsightsHtml(designData)}
                    </div>
                `;
            } else {
                return `
                    <div class="competitor-card-rank">${rank || ''}</div>
                    <div class="card-delete-btn" title="Delete competitor" onclick="deleteCard('${cardId}')">
                        <i class="fas fa-trash-alt"></i>
                    </div>
                    <div class="competitor-card-retry-container">
                        <a href="${url}" target="_blank" class="competitor-card-url" title="${url}" style="margin-bottom: 5px;">
                            <i class="fas fa-external-link-alt"></i> ${displayUrl}
                        </a>
                        <p style="font-size: 0.85em; color: #888; margin: 0;">Unable to retrieve page content.</p>
                        <button class="competitor-card-retry-btn" onclick="retrySingleCompetitorContent('${url}', '${keyword}', document.getElementById('${cardId}'), '${rank}')">
                            <i class="fas fa-sync-alt"></i> Retry
                        </button>
                    </div>
                `;
            }
        }

        function switchCompetitorCardTab(cardId, tabType) {
            const card = document.getElementById(cardId);
            if (!card) return;

            const buttons = card.querySelectorAll('.competitor-card-toggle button');
            buttons.forEach(btn => btn.classList.toggle('active', btn.innerText.toLowerCase() === tabType));

            const contentTab = card.querySelector('.content-tab');
            const designTab = card.querySelector('.design-tab');

            if (tabType === 'content' && contentTab && designTab) {
                contentTab.style.display = 'block';
                designTab.style.display = 'none';
            } else if (tabType === 'design' && contentTab && designTab) {
                contentTab.style.display = 'none';
                designTab.style.display = 'block';
            }
        }

        /**
         * Automatically activates the 'Content' tab for all competitor cards in a grid
         */
        function autoActivateAllContentTabs(gridId) {
            const grid = document.getElementById(gridId);
            if (!grid) return;

            const cards = grid.querySelectorAll('.competitor-card');
            cards.forEach(card => {
                switchCompetitorCardTab(card.id, 'content');
            });
        }

        function renderDesignInsightsHtml(designData) {
            if (!designData || designData.designError) {
                return '<p style="font-size: 0.8em; color: #999; text-align: center; padding: 10px;">Design analysis unavailable.</p>';
            }

            const actualData = designData.body || designData;
            if (!actualData.elements) {
                return '<p style="font-size: 0.8em; color: #999; text-align: center; padding: 10px;">Design analysis data structure invalid.</p>';
            }

            const elements = actualData.elements;
            const elementKeys = [
                { key: 'paragraphs', label: 'Paragraphs' },
                { key: 'ordered_lists', label: 'Ordered Lists' },
                { key: 'unordered_lists', label: 'Unordered Lists' },
                { key: 'infographics', label: 'Infographics' },
                { key: 'charts', label: 'Charts' },
                { key: 'tables', label: 'Tables' },
                { key: 'images', label: 'Images' },
                { key: 'alt_text', label: 'Alt Text' }
            ];

            return `
                <table class="design-insights-table">
                    <thead>
                        <tr>
                            <th>Element</th>
                            <th>Status / Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${elementKeys.map(({ key, label }) => {
                const data = elements[key] || { present: false };
                const statusClass = data.present ? 'status-present' : 'status-absent';
                const statusText = data.present ? (data.count || 'Present') : 'None';
                return `
                                <tr>
                                    <td>${label}</td>
                                    <td>
                                        <span class="status-badge ${statusClass}">${statusText}</span>
                                        ${data.details ? `<div style="font-size: 9px; color: #888; margin-top: 2px;">${data.details}</div>` : ''}
                                    </td>
                                </tr>
                            `;
            }).join('')}
                    </tbody>
                </table>
                ${actualData.summary ? `<div style="font-size: 10px; color: #666; font-style: italic; margin-top: 10px; border-top: 1px solid #eee; padding-top: 5px;">${actualData.summary}</div>` : ''}
            `;
        }

        // --- New Helper Functions for Topic Selection and Load More ---

        function toggleTopicSelection(row, topic, flow) {
            const isSelected = row.classList.toggle('selected');
            const set = selectedTopics_Optimiser[flow];
            const textId = flow === 'optimise' ? 'selectedTopicsText-Optimise' : 'selectedTopicsText';
            const textArea = document.getElementById(textId);
            const wrapperId = flow === 'optimise' ? 'selectedTopicsWrapper-Optimise' : 'selectedTopicsWrapper';

            if (isSelected) {
                set.add(topic);
            } else {
                set.delete(topic);
                row.classList.remove('ai-picked');
            }

            // Show wrapper if there are selections
            const wrapper = document.getElementById(wrapperId);
            if (wrapper) wrapper.style.display = 'block';

            // Update textarea
            if (textArea) {
                textArea.value = Array.from(set).join('\n');
            }
        }

        function selectAllTopics(flow) {
            const gridId = flow === 'optimise' ? 'competitorInsightsGrid-Optimise' : 'competitorInsightsGrid';
            const grid = document.getElementById(gridId);
            if (!grid) return;

            const set = selectedTopics_Optimiser[flow];
            const rows = grid.querySelectorAll('.competitor-table tbody tr');

            rows.forEach(row => {
                const cells = row.cells;
                if (!cells || cells.length < 2) return;
                const topic = cells[0].textContent.trim();
                // Avoid selection if it's the "No data" placeholder
                if (topic && topic !== "No content data available." && !row.classList.contains('selected')) {
                    row.classList.add('selected');
                    set.add(topic);
                }
            });

            // Update Textarea
            const textId = flow === 'optimise' ? 'selectedTopicsText-Optimise' : 'selectedTopicsText';
            const textArea = document.getElementById(textId);
            if (textArea) {
                textArea.value = Array.from(set).join('\n');
            }
        }

        function deselectAllTopics(flow) {
            const gridId = flow === 'optimise' ? 'competitorInsightsGrid-Optimise' : 'competitorInsightsGrid';
            const grid = document.getElementById(gridId);
            if (!grid) return;

            const set = selectedTopics_Optimiser[flow];
            const rows = grid.querySelectorAll('.competitor-table tr.selected');

            rows.forEach(row => {
                row.classList.remove('selected');
                row.classList.remove('ai-picked');
            });

            set.clear();

            // Update Textarea
            const textId = flow === 'optimise' ? 'selectedTopicsText-Optimise' : 'selectedTopicsText';
            const textArea = document.getElementById(textId);
            if (textArea) {
                textArea.value = '';
            }
        } async function aiPickTopics(flow) {
            const gridId = flow === 'optimise' ? 'competitorInsightsGrid-Optimise' : 'competitorInsightsGrid';
            const keywordId = flow === 'optimise' ? 'primaryKeyword' : 'primaryKeywordNew';
            const secondaryId = flow === 'optimise' ? 'secondaryKeywords' : 'secondaryKeywordsNew';
            const btnId = flow === 'optimise' ? 'btnAiPick-optimise' : 'btnAiPick-new';

            const keyword = document.getElementById(keywordId).value.trim();
            const location = document.getElementById(flow === 'optimise' ? 'locationOptimiserOptimise' : 'locationOptimiserNew').value;
            const secondaryText = document.getElementById(secondaryId).value.trim();
            const secondaryKeywords = secondaryText.split('\n').map(k => k.trim()).filter(k => k);

            const grid = document.getElementById(gridId);
            if (!grid) return;

            // Collect topics and their frequencies across ALL competitors
            const topicData = {}; // { topic: { frequency: N, sourceCompetitors: [index...] } }
            const rows = grid.querySelectorAll('.competitor-table tbody tr');

            rows.forEach(row => {
                const topic = row.cells[0]?.textContent.trim();
                if (topic && topic !== "No content data available.") {
                    if (!topicData[topic]) {
                        topicData[topic] = { frequency: 0 };
                    }
                    topicData[topic].frequency += 1;
                }
            });

            const allTopics = Object.keys(topicData).map(topic => ({
                topic: topic,
                frequency: topicData[topic].frequency
            }));

            if (allTopics.size === 0) {
                return alert("No topics found. Please run SERP analysis first.");
            }

            const btn = document.getElementById(btnId);
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AI Picking...';

            try {
                const response = await fetch(OPTIMISER_ENDPOINTS.AI_TOPIC_PICKER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        primary_keyword: keyword,
                        secondary_keywords: secondaryKeywords,
                        all_topics: allTopics,
                        location: location
                    })
                });

                if (!response.ok) throw new Error("Lambda response not OK");

                const data = await response.json();
                console.log(data.body);
                console.log(data.body.selected_topics);
                const pickedTopics = data.body.selected_topics || [];
                console.log(pickedTopics);

                if (pickedTopics.length > 0) {
                    applyAiPickedTopics(flow, pickedTopics);
                } else {
                    alert("AI couldn't pick any topics.");
                }
            } catch (error) {
                console.error("AI Topic Picking error:", error);
                alert("Failed to get AI assistance for topic picking. Ensure your Lambda endpoint is correctly configured in OPTIMISER_ENDPOINTS.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        function applyAiPickedTopics(flow, pickedTopics) {
            const gridId = flow === 'optimise' ? 'competitorInsightsGrid-Optimise' : 'competitorInsightsGrid';
            const grid = document.getElementById(gridId);
            const set = selectedTopics_Optimiser[flow];
            const textId = flow === 'optimise' ? 'selectedTopicsText-Optimise' : 'selectedTopicsText';
            const textArea = document.getElementById(textId);
            const wrapperId = flow === 'optimise' ? 'selectedTopicsWrapper-Optimise' : 'selectedTopicsWrapper';

            const rows = grid.querySelectorAll('.competitor-table tbody tr');
            rows.forEach(row => {
                const topicCell = row.cells[0];
                if (!topicCell) return;
                const topicText = topicCell.textContent.trim().toLowerCase();

                // Smart matching: 
                // 1. Exact match (case-insensitive)
                // 2. The picked topic contains the row topic (or vice-versa) - simple "fuzzy"
                const isMatched = pickedTopics.some(pt => {
                    const picked = pt.toLowerCase();
                    return picked === topicText ||
                        (picked.length > 5 && topicText.length > 5 && (picked.includes(topicText) || topicText.includes(picked)));
                });

                if (isMatched) {
                    row.classList.add('ai-picked');
                    if (!row.classList.contains('selected')) {
                        row.classList.add('selected');
                        // Use the original topic text from the row to maintain consistency in selections
                        const originalTopic = topicCell.textContent.trim();
                        set.add(originalTopic);
                    }
                }
            });

            // Show wrapper
            const wrapper = document.getElementById(wrapperId);
            if (wrapper) wrapper.style.display = 'block';

            // Update Textarea
            if (textArea) {
                textArea.value = Array.from(set).join('\n');
            }
        }

        async function loadMoreCompetitors(flow) {
            const batchSize = 10;
            let start = displayedCount_Optimiser[flow];
            let allUrls = allCompetitorUrls_Optimiser[flow];
            let nextBatch = allUrls.slice(start, start + batchSize);

            const gridId = flow === 'optimise' ? 'competitorInsightsGrid-Optimise' : 'competitorInsightsGrid';
            const wrapperId = flow === 'optimise' ? 'competitorAnalysisWrapper-Optimise' : 'competitorAnalysisWrapper';
            const loadMoreBtnId = flow === 'optimise' ? 'btnLoadMoreCompetitors-Optimise' : 'btnLoadMoreCompetitors';
            const keywordId = flow === 'optimise' ? 'primaryKeyword' : 'primaryKeywordNew';
            const keyword = document.getElementById(keywordId).value.trim();
            const location = document.getElementById(flow === 'optimise' ? 'locationOptimiserOptimise' : 'locationOptimiserNew').value;

            const btn = document.getElementById(loadMoreBtnId);
            if (btn) btn.disabled = true;

            if (nextBatch.length === 0) {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-check"></i> No more results pre-fetched';
                }
                return;
            }


            if (btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

            // 1. Initial render with skeletons
            const skeletalData = nextBatch.map((url, index) => ({
                url, rank: start + index + 1, loading: true
            }));
            renderCompetitorCards(skeletalData, gridId, wrapperId, keyword, true);

            // 2. Process batch
            const promises = nextBatch.map(async (url, index) => {
                const actualRank = start + index + 1;
                const cardId = `comp-card-${gridId}-${start + index}`;
                const cardElement = document.getElementById(cardId);

                const contentPromise = fetchWithRetry('https://u24f9208q0.execute-api.ap-southeast-1.amazonaws.com/gptTopicsPerUrl', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, keyword }),
                }, 2, d => d && d.body && d.body[url] && d.body[url].topics).catch(() => ({ url, error: true }));

                const designPromise = fetchWithRetry(OPTIMISER_ENDPOINTS.DESIGN_ANALYSIS, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url }),
                }, 2, data => (data.body || data).elements).catch(() => ({ url, designError: true }));

                const [contentData, designData] = await Promise.all([contentPromise, designPromise]);
                const result = { ...contentData, designData, rank: actualRank, url };

                if (cardElement) {
                    cardElement.innerHTML = getCompetitorCardInnerHtml(result, cardId, keyword);
                }
                return result;
            });

            await Promise.all(promises);
            autoActivateAllContentTabs(gridId);

            displayedCount_Optimiser[flow] += nextBatch.length;
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus"></i> Load More Competitors';
                if (displayedCount_Optimiser[flow] >= allUrls.length) {
                    btn.innerHTML = '<i class="fas fa-check"></i> No more results pre-fetched';
                }
            }
        }

        async function runGapAnalysisWithTopics(flow) {
            const textAreaId = flow === 'optimise' ? 'selectedTopicsText-Optimise' : 'selectedTopicsText';
            const selectedTopicsText = document.getElementById(textAreaId).value.trim();
            const keywordId = flow === 'optimise' ? 'primaryKeyword' : 'primaryKeywordNew';
            const keyword = document.getElementById(keywordId).value.trim();

            // Collect all current analysis data for context
            const gridId = flow === 'optimise' ? 'competitorInsightsGrid-Optimise' : 'competitorInsightsGrid';
            const gridRows = document.querySelectorAll(`#${gridId} .competitor-card`);

            if (flow === 'optimise') {
                // Manually trigger the existing gap analysis logic but with prioritized topics
                await runTargetedGapAnalysisOptimise(selectedTopicsText, keyword);
            } else {
                // For 'new' flow, we update the outline based on topics
                await runTargetedOutlineGeneration(selectedTopicsText, keyword);
            }
        }

        async function runTargetedGapAnalysisOptimise(selectedTopics, keyword) {
            const btn = document.getElementById('btnRunGapAnalysisFromTopics');
            const resultsArea = document.getElementById('gapAnalysisResults-Optimise');
            const loading = document.getElementById('gapAnalysisLoading-Optimise');
            const wrapper = document.getElementById('gapAnalysisWrapper-Optimise');
            const editorContent = document.getElementById('editorContent').innerText.trim();

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing gaps...';
            wrapper.style.display = 'block';
            resultsArea.style.display = 'none';
            loading.style.display = 'block';

            try {
                const personaContext = getPersonaData();
                const gapPrompt = `
ANALYSE THE FOLLOWING DATA FOR CONTENT GAPS AND IMPROVEMENT SUGGESTIONS.
${personaContext ? "STRICTLY ADHERE TO THE FOLLOWING TARGET PERSONAS:\n" + personaContext : ""}

PRIORITIZE ANALYZING THESE SPECIFIC TOPICS CHOSEN BY THE USER:
${selectedTopics || "No specific topics chosen, analyze overall gaps."}

PRIMARY KEYWORD: "${keyword}"

YOUR CURRENT EDITOR CONTENT:
"""
${editorContent}
"""

INSTRUCTIONS:
1. Compare your content vs the cherry-picked topics.
2. Identify specific "Content Gaps" related to these topics.
3. Provide 3-5 actionable steps to improve the SEO and value of your existing content.
4. Keep the tone professional and constructive.
                    `.trim();

                const response = await fetch(OPTIMISER_ENDPOINTS.CONTENT_AI, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'generate', prompt: gapPrompt, settings: aiContentSettings })
                });

                const data = await response.json();
                const result = parseLambdaResponse(data);

                loading.style.display = 'none';
                resultsArea.style.display = 'block';
                // Render as HTML instead of raw text
                resultsArea.innerHTML = formatMarkdown(result.result);
                resultsArea.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error("Gap analysis error:", error);
                alert("Failed to run gap analysis.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Run AI Gap Analysis';
            }
        }

        async function runTargetedOutlineGeneration(selectedTopics, keyword) {
            const btn = document.getElementById('btnRunAnalysisFromTopics');
            const outlineArea = document.getElementById('editableOutline');
            const outlineWrapper = document.getElementById('outlineStepWrapper');
            const loading = document.getElementById('outlineLoading-New');
            const topic = document.getElementById('newArticleTopic').value.trim();

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating outline...';
            outlineWrapper.style.display = 'block';
            outlineArea.style.display = 'none';
            loading.style.display = 'block';

            try {
                const personaContext = getPersonaData();
                const prompt = `
Generate a structured article outline (H1, H2, H3) for the following topic and keyword.
${personaContext ? "THE OUTLINE MUST BE SPECIFICALLY TAILORED TO THESE PERSONAS:\n" + personaContext : ""}

PRIORITIZE INCLUDING THESE CHERRY-PICKED TOPICS IDENTIFIED FROM COMPETITOR RESEARCH:
${selectedTopics}

TOPIC: "${topic}"
PRIMARY KEYWORD: "${keyword}"

INSTRUCTIONS:
1. Ensure the outline is unique and high-value.
2. Cover the cherry-picked topics comprehensively.
3. Account for EEAT principles.
4. Output in a clear, editable text format.
                `.trim();

                const response = await fetch(OPTIMISER_ENDPOINTS.CONTENT_AI, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'generate', prompt: prompt, settings: aiContentSettings })
                });

                const data = await response.json();
                const result = parseLambdaResponse(data);

                loading.style.display = 'none';
                outlineArea.style.display = 'block';
                outlineArea.value = result.result;
                outlineArea.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error("Outline generation error:", error);
                alert("Failed to generate outline.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Run AI Content Analysis';
            }
        }

        async function retrySingleCompetitorContent(url, keyword, cardElement, rank) {
            const btn = cardElement.querySelector('.competitor-card-retry-btn');
            // const originalContent = cardElement.innerHTML; // No longer needed as we use the rank/url passed in

            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Retrying...';
            }

            try {
                const contentPromise = fetchWithRetry('https://u24f9208q0.execute-api.ap-southeast-1.amazonaws.com/gptTopicsPerUrl', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, keyword }),
                }, 2, d => {
                    return d && d.body && d.body[url] &&
                        d.body[url].topics &&
                        Object.keys(d.body[url].topics).length > 0;
                }).catch(() => ({ url, error: true }));

                const designPromise = fetchWithRetry(OPTIMISER_ENDPOINTS.DESIGN_ANALYSIS, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url }),
                }, 2, data => {
                    console.log(data);
                    const actualData = data.body || data;
                    return actualData && actualData.elements && Object.keys(actualData.elements).length > 0;
                }).catch(() => ({ url, designError: true }));

                const [contentData, designData] = await Promise.all([contentPromise, designPromise]);

                if (contentData && !contentData.error) {
                    const result = {
                        ...contentData,
                        designData: designData,
                        rank: rank,
                        url: url
                    };
                    cardElement.innerHTML = getCompetitorCardInnerHtml(result, cardElement.id, keyword);
                } else {
                    throw new Error("Failed to fetch data on retry");
                }
            } catch (error) {
                console.error("Manual retry failed:", error);
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> Retry Failed (Try Again)';
                }
            }
        }

        async function generateNewArticle() {
            const topic = document.getElementById('newArticleTopic').value.trim();
            const primaryKeyword = document.getElementById('primaryKeywordNew').value.trim();
            const secondaryKeywords = document.getElementById('secondaryKeywordsNew').value.trim();
            const outline = document.getElementById('editableOutline').value.trim();
            const refUrls = document.getElementById('referenceUrls').value.trim();
            const btn = document.getElementById('btnGenerateNewArticle');
            const editor = document.getElementById('editorContent');
            const editorTitle = document.getElementById('editorTitle');
            const optimiserLayout = document.querySelector('.optimiser-layout');

            if (!outline) return alert("Please review and refine the outline first.");

            btn.disabled = true;
            const originalBtnHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Writing Full Article...';

            // Sync keywords back to main state
            const pk = document.getElementById('primaryKeywordNew').value.trim();
            const sk = document.getElementById('secondaryKeywordsNew').value.trim();
            document.getElementById('primaryKeyword').value = pk;
            document.getElementById('secondaryKeywords').value = sk;

            const complianceText = getSelectedCompliance('new');
            const complianceInstruction = complianceText
                ? `\n\nSTRICT COMPLIANCE NOTICE: The generated content MUST adhere to the following regulations and guidelines. Ensure legal disclaimers or required phrasing are included if these guidelines dictate so:\n- ${complianceText}`
                : "";

            const personaContext = getPersonaData();
            const personaInstruction = personaContext
                ? `\n\nTARGET AUDIENCE PERSONAS:\n${personaContext}\n(Ensure the tone, examples, and solutions are specifically relevant to these individuals.)`
                : "";

            // EEAT and SEO Guidelines
            const eeatPrompt = `
Generate a comprehensive, structured SEO article based on the following APPROVED OUTLINE and GUIDELINES.

TOPIC: "${topic}"
PRIMARY KEYWORD: "${primaryKeyword}"
SECONDARY KEYWORDS: "${secondaryKeywords}"
${complianceInstruction}${personaInstruction}

APPROVED OUTLINE:
${outline}

REFERENCE URLS:
${refUrls || "None provided"}

CRITICAL CONTENT GUIDELINES (EEAT):
1. EXPERIENCE (E): Write with a first-person perspective or direct experience.
2. EXPERTISE (E): Provide deep, focused coverage of the intent.
3. AUTHORITATIVENESS (A): Reference credible sources (placeholders like [Source: Name]).
4. READABILITY: Grade-school level. Simple language, short sentences.
5. USEFULNESS: Include FAQs, Definitions, and Media Placeholders [IMAGE: Description].
6. UNIQUENESS: Maintain the unique POV proposed in the outline.
7. FORMATTING: Strict Header hierarchy (H2, H3), bulleted lists, and Markdown tables.
`.trim();

            try {
                const response = await fetch(OPTIMISER_ENDPOINTS.CONTENT_AI, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generate',
                        prompt: eeatPrompt,
                        settings: aiContentSettings
                    })
                });

                const data = await response.json();
                const result = parseLambdaResponse(data);

                if (editor) {
                    editor.innerHTML = formatMarkdown(result.result);
                    updateEditorMetrics();
                    if (editorTitle) editorTitle.value = topic;
                }

                // Reveal the layout
                if (optimiserLayout) {
                    optimiserLayout.style.display = 'flex';
                    optimiserLayout.scrollIntoView({ behavior: 'smooth' });
                }

            } catch (error) {
                console.error("Article generation error:", error);
                alert("Failed to generate article. Please check your connection and try again.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnHtml;
            }
        }

        // Compliance File Handle
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('complianceFileUpload')?.addEventListener('change', function (e) {
                const list = document.getElementById('complianceFileList');
                if (!list) return;
                list.innerHTML = '';
                Array.from(this.files).forEach(file => {
                    const div = document.createElement('div');
                    div.style.padding = '4px 0';
                    div.innerHTML = `<i class="fas fa-check-circle" style="color: #34a853;"></i> ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                    list.appendChild(div);
                });
            });
        });

        function renderGscPerformanceTable() {
            const tableBody = document.getElementById('table-performance-body');
            const pageIndicator = document.getElementById('gscPageIndicator');
            const btnPrev = document.getElementById('btnGscPrevPage');
            const btnNext = document.getElementById('btnGscNextPage');

            if (!tableBody) return;
            tableBody.innerHTML = '';

            const totalPages = Math.ceil(gscPerformanceData.length / rowsPerPage) || 1;
            if (gscCurrentPage > totalPages) gscCurrentPage = totalPages;
            if (gscCurrentPage < 1) gscCurrentPage = 1;

            const start = (gscCurrentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = gscPerformanceData.slice(start, end);

            pageData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                            <td style="padding: 8px; border-bottom: 1px solid #eee; width: 40%;">
                                <b>${row.query}</b><br>
                                <a href="${row.pageUrl}" target="_blank" style="color: #1a73e8; text-decoration: none; font-size: 11px; word-break: break-all;">${row.pageUrl}</a>
                            </td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right; width: 15%;">${row.clicks}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right; width: 15%;">${row.impressions}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right; width: 15%;">${row.ctr}%</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right; width: 15%;">${row.position}</td>
                        `;
                tableBody.appendChild(tr);
            });

            // Update UI
            if (pageIndicator) pageIndicator.innerText = `Page ${gscCurrentPage} of ${totalPages}`;
            if (btnPrev) {
                btnPrev.disabled = gscCurrentPage === 1;
                btnPrev.style.opacity = btnPrev.disabled ? '0.5' : '1';
            }
            if (btnNext) {
                btnNext.disabled = (gscCurrentPage === totalPages || totalPages === 0);
                btnNext.style.opacity = btnNext.disabled ? '0.5' : '1';
            }

            updateSortIcons();
        }

        function sortByGscColumn(column) {
            if (gscSortColumn === column) {
                gscSortOrder = (gscSortOrder === 'desc') ? 'asc' : 'desc';
            } else {
                gscSortColumn = column;
                gscSortOrder = 'desc';
            }

            gscPerformanceData.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                if (column === 'position') { valA = parseFloat(a.rawPosition); valB = parseFloat(b.rawPosition); }
                else if (column === 'ctr') { valA = parseFloat(a.rawCtr); valB = parseFloat(b.rawCtr); }
                else if (column === 'clicks' || column === 'impressions') {
                    valA = parseInt(valA);
                    valB = parseInt(valB);
                }
                else if (column === 'query') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (valA < valB) return gscSortOrder === 'asc' ? -1 : 1;
                if (valA > valB) return gscSortOrder === 'asc' ? 1 : -1;
                return 0;
            });

            gscCurrentPage = 1;
            renderGscPerformanceTable();
        }

        function changeGscPage(direction) {
            const totalPages = Math.ceil(gscPerformanceData.length / rowsPerPage);
            gscCurrentPage += direction;
            if (gscCurrentPage < 1) gscCurrentPage = 1;
            if (gscCurrentPage > totalPages) gscCurrentPage = totalPages;
            renderGscPerformanceTable();
        }

        function updateSortIcons() {
            const icons = ['query', 'clicks', 'impressions', 'ctr', 'position'];
            icons.forEach(col => {
                const icon = document.getElementById(`sort-icon-${col}`);
                if (!icon) return;
                if (col === gscSortColumn) {
                    icon.className = gscSortOrder === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
                    icon.style.color = '#1967d2';
                } else {
                    icon.className = 'fas fa-sort';
                    icon.style.color = '#ccc';
                }
            });
        }

        // Actionables State
        let actionablesState = {
            striking: { data: [], currentPage: 1, pageSize: 15, sortCol: 'impressions', sortOrder: 'desc' },
            gaps: { data: [], currentPage: 1, pageSize: 15, sortCol: 'impressions', sortOrder: 'desc' },
            semantic: { data: [], currentPage: 1, pageSize: 15, sortCol: 'queries', sortOrder: 'desc' },
            pruning: { data: [], currentPage: 1, pageSize: 15, sortCol: 'clicks', sortOrder: 'asc' }
        };

        function toggleActionableSection(header) {
            header.classList.toggle('active');
            const content = header.nextElementSibling;
            if (content.classList.contains('actionable-collapsible-content')) {
                content.classList.toggle('active');
            }
        }

        function runMasterclassSection(sectionId) {
            if (!selectedGscProperty || selectedGscProperty === "") {
                return alert("Please select a Search Console property first (under 'Indexing' or 'Search Insights' tab).");
            }
            if (!gscPerformanceData || gscPerformanceData.length === 0) {
                return alert("Please click 'Refresh Insights' first (under 'Search Insights' tab) to load property data.");
            }

            const container = document.getElementById(`masterclass-dynamic-${sectionId}`);
            if (!container) return;

            // Show loading
            container.innerHTML = '<div style="text-align: center; padding: 30px;"><i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #1a73e8; margin-bottom: 10px;"></i><br><span style="font-size: 14px; color: #666;">Analyzing GSC performance data...</span></div>';

            // Brief delay for UX/feel
            setTimeout(() => {
                let data = [];

                if (sectionId === 'striking') {
                    data = gscPerformanceData
                        .filter(row => row.rawPosition > 5 && row.rawPosition <= 20)
                        .sort((a, b) => b.impressions - a.impressions);
                } else if (sectionId === 'gaps') {
                    const questions = ["how", "what", "why", "best", "vs", "which", "where", "can"];
                    data = gscPerformanceData
                        .filter(row => questions.some(q => row.query.toLowerCase().includes(q)) && row.clicks < 5 && row.impressions > 50)
                        .sort((a, b) => b.impressions - a.impressions);
                } else if (sectionId === 'semantic') {
                    // Group by URL
                    const urlGroups = {};
                    gscPerformanceData.forEach(row => {
                        if (!urlGroups[row.pageUrl]) urlGroups[row.pageUrl] = [];
                        urlGroups[row.pageUrl].push(row.query);
                    });

                    data = Object.entries(urlGroups)
                        .filter(([url, queries]) => queries.length > 5)
                        .sort((a, b) => b[1].length - a[1].length)
                        .map(([url, queries]) => ({ url, queries }));
                } else if (sectionId === 'pruning') {
                    const pageStats = {};
                    gscPerformanceData.forEach(row => {
                        if (!pageStats[row.pageUrl]) pageStats[row.pageUrl] = { clicks: 0, impressions: 0 };
                        pageStats[row.pageUrl].clicks += parseInt(row.clicks);
                        pageStats[row.pageUrl].impressions += parseInt(row.impressions);
                    });

                    data = Object.entries(pageStats)
                        .filter(([url, stats]) => stats.clicks < 5 && url.length > 10)
                        .sort((a, b) => a[1].clicks - b[1].clicks)
                        .map(([url, stats]) => ({ url, clicks: stats.clicks, impressions: stats.impressions }));
                }

                actionablesState[sectionId].data = data;
                actionablesState[sectionId].currentPage = 1;

                // Apply default sort
                const state = actionablesState[sectionId];
                state.data.sort((a, b) => {
                    let valA, valB;
                    const column = state.sortCol;
                    if (column === 'queries') { valA = a.queries.length; valB = b.queries.length; }
                    else if (column === 'query' || column === 'url') { valA = (a[column] || a.url).toLowerCase(); valB = (b[column] || b.url).toLowerCase(); }
                    else { valA = parseFloat(a[column]); valB = parseFloat(b[column]); }
                    if (valA < valB) return state.sortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return state.sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });

                renderActionableTable(sectionId);
            }, 800);
        }

        const actionableExplanations = {
            striking_near: "Ranking on Page 2 (Pos 6-10) means Google already finds the page highly relevant. These targeted tweaks can push the page into the top visibility bracket without needing new backlinks.",
            striking_far: "Pages in positions 11-20 are on the cusp of significant traffic. Adding internal links or new subheads helps consolidate authority and signals deeper relevance to search crawlers.",
            gap: "These queries represent high user interest but poor current satisfaction. Answering these directly improves 'Helpful Content' signals and captures traffic your competitors are missing.",
            semantic: "A single page ranking for too many disparate topics can dilute its focus. Splitting into child pages allows for more targeted H1s and deeper keyword coverage for each specific intent.",
            prune_update: "High impressions but zero clicks suggest your content is visible but fails to meet the user's need or has a poor title/meta. Updating is high-value because the traffic potential is already proven.",
            prune_merge: "Zombie pages dilute your sitewide authority (Crawl Budget). Pruning or merging them consolidates 'link juice' into your top-performing pages, leading to better sitewide performance."
        };

        function renderActionableTable(sectionId) {
            const container = document.getElementById(`masterclass-dynamic-${sectionId}`);
            const paginationEl = document.getElementById(`pagination-${sectionId}`);
            const state = actionablesState[sectionId];

            if (!container || !state.data) return;

            const totalPages = Math.ceil(state.data.length / state.pageSize) || 1;
            const start = (state.currentPage - 1) * state.pageSize;
            const pageData = state.data.slice(start, start + state.pageSize);

            let html = '<table class="masterclass-table"><thead><tr>';

            if (sectionId === 'striking') {
                html += `
                    <th onclick="sortActionableTable('${sectionId}', 'query')">Query ${getSortIcon(sectionId, 'query')}</th>
                    <th onclick="sortActionableTable('${sectionId}', 'impressions')">Impr. ${getSortIcon(sectionId, 'impressions')}</th>
                    <th onclick="sortActionableTable('${sectionId}', 'position')">Pos. ${getSortIcon(sectionId, 'position')}</th>
                    <th>Action</th>`;
                html += '</tr></thead><tbody>';
                if (pageData.length === 0) {
                    html += '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #999;">No results found.</td></tr>';
                } else {
                    pageData.forEach(item => {
                        const pos = parseFloat(item.position);
                        const explanationKey = pos <= 10 ? 'striking_near' : 'striking_far';
                        const actionText = pos <= 10 ? 'Move to H2; Add to first 100 words' : 'Create new H2 section; Add internal link';
                        html += `<tr>
                            <td><b>${item.query}</b></td>
                            <td>${parseInt(item.impressions).toLocaleString()}</td>
                            <td><span style="color: #1e8e3e; font-weight: bold;">${item.position}</span></td>
                            <td><span class="action-tooltip-trigger" title="${actionableExplanations[explanationKey]}">${actionText}</span></td>
                        </tr>`;
                    });
                }
            } else if (sectionId === 'gaps') {
                html += `
                    <th onclick="sortActionableTable('${sectionId}', 'query')">Question Query ${getSortIcon(sectionId, 'query')}</th>
                    <th onclick="sortActionableTable('${sectionId}', 'impressions')">Impr. ${getSortIcon(sectionId, 'impressions')}</th>
                    <th onclick="sortActionableTable('${sectionId}', 'clicks')">Clicks ${getSortIcon(sectionId, 'clicks')}</th>
                    <th>Potential</th>`;
                html += '</tr></thead><tbody>';
                if (pageData.length === 0) {
                    html += '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #999;">No results found.</td></tr>';
                } else {
                    pageData.forEach(item => {
                        html += `<tr>
                            <td><b>${item.query}</b></td>
                            <td>${parseInt(item.impressions).toLocaleString()}</td>
                            <td>${item.clicks}</td>
                            <td><span class="action-tooltip-trigger" title="${actionableExplanations.gap}"><b>High</b>: Create FAQ or Guide</span></td>
                        </tr>`;
                    });
                }
            } else if (sectionId === 'semantic') {
                html += `
                    <th onclick="sortActionableTable('${sectionId}', 'url')">Core URL ${getSortIcon(sectionId, 'url')}</th>
                    <th onclick="sortActionableTable('${sectionId}', 'queries')">Query Mix ${getSortIcon(sectionId, 'queries')}</th>
                    <th>Recommendation</th>`;
                html += '</tr></thead><tbody>';
                if (pageData.length === 0) {
                    html += '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #999;">No results found.</td></tr>';
                } else {
                    pageData.forEach(item => {
                        const shortUrl = item.url.split('/').filter(s => s && !s.includes('http')).pop() || '/';
                        html += `<tr>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><a href="${item.url}" target="_blank" style="color: #1a73e8; font-size: 11px;">${shortUrl}</a></td>
                            <td style="font-size: 11px;">${item.queries.slice(0, 3).join(', ')} (+${item.queries.length - 3} more)</td>
                            <td><span class="action-tooltip-trigger" title="${actionableExplanations.semantic}">Split into <b>${Math.ceil(item.queries.length / 5)}</b> child pages</span></td>
                        </tr>`;
                    });
                }
            } else if (sectionId === 'pruning') {
                html += `
                    <th onclick="sortActionableTable('${sectionId}', 'url')">URL ${getSortIcon(sectionId, 'url')}</th>
                    <th onclick="sortActionableTable('${sectionId}', 'clicks')">Clicks ${getSortIcon(sectionId, 'clicks')}</th>
                    <th onclick="sortActionableTable('${sectionId}', 'impressions')">Impr. ${getSortIcon(sectionId, 'impressions')}</th>
                    <th>Decision</th>`;
                html += '</tr></thead><tbody>';
                if (pageData.length === 0) {
                    html += '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #999;">No results found.</td></tr>';
                } else {
                    pageData.forEach(item => {
                        const shortUrl = item.url.split('/').filter(s => s && !s.includes('http')).pop() || '/';
                        const action = item.impressions > 100 ? 'Update (thin content)' : 'Merge/Delete';
                        const explanationKey = item.impressions > 100 ? 'prune_update' : 'prune_merge';
                        html += `<tr>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><a href="${item.url}" target="_blank" style="color: #ea4335; font-size: 11px;">${shortUrl}</a></td>
                            <td>${item.clicks}</td>
                            <td>${item.impressions.toLocaleString()}</td>
                            <td><span class="action-tooltip-trigger" title="${actionableExplanations[explanationKey]}"><b>${action}</b></span></td>
                        </tr>`;
                    });
                }
            }

            html += '</tbody></table>';
            container.innerHTML = html;

            // Render Pagination
            if (state.data.length > state.pageSize) {
                paginationEl.style.display = 'flex';
                paginationEl.innerHTML = `
                    <button class="actionable-page-btn" ${state.currentPage === 1 ? 'disabled' : ''} onclick="changeActionablePage('${sectionId}', -1)">
                        <i class="fas fa-chevron-left"></i> Prev
                    </button>
                    <span style="font-size: 12px; color: #5f6368;">Page <b>${state.currentPage}</b> of ${totalPages}</span>
                    <button class="actionable-page-btn" ${state.currentPage === totalPages ? 'disabled' : ''} onclick="changeActionablePage('${sectionId}', 1)">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                `;
            } else {
                paginationEl.style.display = 'none';
            }
        }

        function changeActionablePage(sectionId, direction) {
            const state = actionablesState[sectionId];
            const totalPages = Math.ceil(state.data.length / state.pageSize);
            state.currentPage += direction;
            if (state.currentPage < 1) state.currentPage = 1;
            if (state.currentPage > totalPages) state.currentPage = totalPages;
            renderActionableTable(sectionId);
        }

        function sortActionableTable(sectionId, column) {
            const state = actionablesState[sectionId];
            if (state.sortCol === column) {
                state.sortOrder = (state.sortOrder === 'desc') ? 'asc' : 'desc';
            } else {
                state.sortCol = column;
                state.sortOrder = 'desc';
            }

            state.data.sort((a, b) => {
                let valA, valB;

                // Specific accessors based on data structure
                if (column === 'queries') { valA = a.queries.length; valB = b.queries.length; }
                else if (column === 'query' || column === 'url') { valA = (a[column] || a.url).toLowerCase(); valB = (b[column] || b.url).toLowerCase(); }
                else { valA = parseFloat(a[column]); valB = parseFloat(b[column]); }

                if (valA < valB) return state.sortOrder === 'asc' ? -1 : 1;
                if (valA > valB) return state.sortOrder === 'asc' ? 1 : -1;
                return 0;
            });

            state.currentPage = 1;
            renderActionableTable(sectionId);
        }

        function getSortIcon(sectionId, column) {
            const state = actionablesState[sectionId];
            if (state.sortCol !== column) return '<i class="fas fa-sort" style="opacity: 0.3;"></i>';
            return state.sortOrder === 'asc' ? '<i class="fas fa-sort-up"></i>' : '<i class="fas fa-sort-down"></i>';
        }

        let originalHtmlReview = "";
        let pendingRewriteHtml = "";

        function acceptRewrite() {
            const editor = document.getElementById('editorContent');
            editor.innerHTML = pendingRewriteHtml;
            editor.classList.remove('review-mode');
            editor.contentEditable = "true";
            document.getElementById('rewriteReviewBar').style.display = 'none';
            updateEditorMetrics();
            alert("Changes accepted!");
        }

        function rejectRewrite() {
            const editor = document.getElementById('editorContent');
            editor.innerHTML = originalHtmlReview;
            editor.classList.remove('review-mode');
            editor.contentEditable = "true";
            document.getElementById('rewriteReviewBar').style.display = 'none';
            updateEditorMetrics();
            alert("Changes rejected. Restored original content.");
        }

        function finalizeReview() {
            const editor = document.getElementById('editorContent');
            // Check if there are still review blocks
            const blocks = editor.querySelectorAll('.review-block-container');
            if (blocks.length > 0) {
                if (!confirm("There are still blocks pending review. These will NOT be part of your final content until accepted. Continue and hide review mode?")) {
                    return;
                }
            }
            editor.classList.remove('review-mode');
            editor.contentEditable = "true";
            document.getElementById('rewriteReviewBar').style.display = 'none';
            updateEditorMetrics();
            alert("Review mode exited. Current editor content preserved.");
        }

        /**
         * A very basic word-level diffing implementation for visual review
         */
        function computeDiff(oldHtml, newHtml) {
            // This is now the entry point for granular diffing
            return computeGranularDiff(oldHtml, newHtml);
        }

        function computeGranularDiff(oldHtml, newHtml) {
            // Helper to split HTML into blocks (tags remain with content)
            const splitIntoBlocks = (html) => {
                // This regex captures blocks like <p>...</p>, <h2>...</h2>, etc.
                // It treats non-wrapped text as separate blocks
                const blocks = [];
                const regex = /<([a-z1-6]+)([^>]*)>([\s\S]*?)<\/\1>/gi;
                let lastIndex = 0;
                let match;

                while ((match = regex.exec(html)) !== null) {
                    if (match.index > lastIndex) {
                        const gap = html.substring(lastIndex, match.index).trim();
                        if (gap) blocks.push(gap);
                    }
                    blocks.push(match[0]);
                    lastIndex = regex.lastIndex;
                }
                const remaining = html.substring(lastIndex).trim();
                if (remaining) blocks.push(remaining);
                return blocks;
            };

            const oldBlocks = splitIntoBlocks(oldHtml);
            const newBlocks = splitIntoBlocks(newHtml);

            let resultHtml = "";
            let newIndex = 0;
            let oldIndex = 0;

            // Simple block-level traversal
            while (newIndex < newBlocks.length) {
                const newBlock = newBlocks[newIndex];
                const oldBlock = oldBlocks[oldIndex] || "";

                // Strip tags for comparison to see if content effectively changed
                const strip = (h) => h.replace(/<[^>]+>/g, '').trim();

                if (strip(newBlock) === strip(oldBlock)) {
                    // Unchanged block
                    resultHtml += `<div class="review-unchanged">${newBlock}</div>`;
                    oldIndex++;
                } else {
                    const blockId = `rev_${Date.now()}_${newIndex}`;
                    resultHtml += `
                        <div id="${blockId}" class="review-block-container" data-original="${encodeURIComponent(oldBlock)}">
                            <div class="review-side-by-side">
                                <div class="review-column col-original">
                                    <div class="review-column-header"><i class="fas fa-history"></i> Original</div>
                                    <div class="review-original-body">${oldBlock}</div>
                                </div>
                                <div class="review-column col-suggested">
                                    <div class="review-column-header"><i class="fas fa-magic"></i> AI Suggested (Editable)</div>
                                    <div class="review-suggestion-body" contenteditable="true">${newBlock}</div>
                                </div>
                            </div>
                            <div class="review-block-actions">
                                <button class="btn-review-reject" onclick="rejectBlockSuggestion(this)">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                                <button class="btn-review-accept" onclick="acceptBlockSuggestion(this)">
                                    <i class="fas fa-check"></i> Accept This Block
                                </button>
                            </div>
                        </div>
                    `;
                    if (oldBlock) oldIndex++;
                }
                newIndex++;
            }
            return resultHtml;
        }

        function acceptBlockSuggestion(btn) {
            const container = btn.closest('.review-block-container');
            if (!container) return;
            const suggestion = container.querySelector('.review-suggestion-body').innerHTML;
            container.outerHTML = suggestion;
            updateEditorMetrics();
        }

        function rejectBlockSuggestion(btn) {
            const container = btn.closest('.review-block-container');
            if (!container) return;
            const original = decodeURIComponent(container.getAttribute('data-original'));
            container.outerHTML = original;
            updateEditorMetrics();
        }

        function toggleOriginalBlock(btn) {
            const container = btn.closest('.review-block-container');
            if (!container) return;
            const preview = container.querySelector('.review-original-preview');
            const isVisible = preview.style.display === 'block';
            preview.style.display = isVisible ? 'none' : 'block';
            btn.innerHTML = isVisible ? '<i class="fas fa-eye"></i> View Original' : '<i class="fas fa-eye-slash"></i> Hide Original';
        }

    </script>

    <!-- AI Settings Modal -->
    <div id="aiSettingsModal" class="feedback-modal">
        <div class="ai-settings-modal-content">
            <div class="modal-header">
                <h2>Article Optimizer</h2>
                <span class="close-modal" onclick="closeAiSettingsModal()">&times;</span>
            </div>

            <div class="settings-sections-container">
                <!-- Configuration Section -->
                <div class="settings-section">
                    <div class="section-header">
                        <h3><i class="fas fa-cog"></i> Configuration</h3>
                    </div>
                    <div class="form-group full">
                        <label>Target Audience: <span class="required">*</span></label>
                        <input type="text" id="setAudience" value="Working professionals"
                            placeholder="e.g., Young working professionals in Singapore">
                    </div>
                    <div class="form-row">
                        <div class="form-group half">
                            <label>Brand Tone: <span class="required">*</span></label>
                            <select id="setBrandTone">
                                <option value="Professional">Professional</option>
                                <option value="Casual">Casual</option>
                                <option value="Authoritative">Authoritative</option>
                            </select>
                        </div>
                        <div class="form-group half">
                            <label>Search Intent:</label>
                            <select id="setSearchIntent">
                                <option value="Informational">Informational</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Transactional">Transactional</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Industry & Compliance Section -->
                <div class="settings-section">
                    <h3>Industry & Compliance</h3>
                    <div class="form-row">
                        <div class="form-group half">
                            <label>Industry:</label>
                            <select id="setIndustry">
                                <option value="General">General</option>
                                <option value="Finance">Finance</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Technology">Technology</option>
                            </select>
                        </div>
                        <div class="form-group half">
                            <label>Risk Level:</label>
                            <select id="setRiskLevel">
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group full">
                        <label>Jurisdictions:</label>
                        <input type="text" id="setJurisdictions" placeholder="SG">
                        <span class="help-text">Comma-separated country codes</span>i
                    </div>
                </div>

                <!-- Locale & Style Section -->
                <div class="settings-section">
                    <h3>Locale & Style</h3>
                    <div class="form-row">
                        <div class="form-group half">
                            <label>Locale:</label>
                            <select id="setLocale">
                                <option value="en-SG">English (Singapore)</option>
                                <option value="en-US">English (US)</option>
                                <option value="en-GB">English (UK)</option>
                            </select>
                        </div>
                        <div class="form-group half">
                            <label>Reading Level:</label>
                            <select id="setReadingLevel">
                                <option value="Grade 6-8 (Easy)">Grade 6-8 (Easy)</option>
                                <option value="High School">High School</option>
                                <option value="University">University</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Content Guidelines Section -->
                <div class="settings-section">
                    <h3>Content Guidelines</h3>
                    <div class="form-group full">
                        <label>DO Use Words:</label>
                        <input type="text" id="setDoUseWords" placeholder="e.g., premium, luxury, sophisticated">
                        <span class="help-text">Comma-separated mandatory terms</span>
                    </div>
                    <div class="form-group full">
                        <label>DO NOT Use Words:</label>
                        <input type="text" id="setDoNotUseWords" placeholder="e.g., cheap, economical, budget">
                        <span class="help-text">Comma-separated banned terms</span>
                    </div>
                    <div class="form-group full">
                        <label>Focus Products/Services:</label>
                        <input type="text" id="setFocusProducts" placeholder="e.g., Premium Condos, Luxury Apartments">
                        <span class="help-text">Comma-separated products to highlight</span>
                    </div>
                </div>

                <!-- SEO & Compliance Section -->
                <div class="settings-section">
                    <h3>SEO & Compliance</h3>
                    <div class="form-group full">
                        <label>Schema Type:</label>
                        <select id="setSchemaType">
                            <option value="Article">Article</option>
                            <option value="BlogPosting">Blog Posting</option>
                            <option value="Product">Product</option>
                        </select>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="setComplianceDisclaimers">
                        <label for="setComplianceDisclaimers">Require Compliance Disclaimers</label>
                    </div>
                    <div class="form-group checkbox-group" style="margin-top: 5px;">
                        <input type="checkbox" id="setSuggestExternalLinks">
                        <label for="setSuggestExternalLinks">Suggest External Links (Smart Linking)</label>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-reset" onclick="resetAiSettings()">Reset to Default</button>
                <div class="footer-right">
                    <button class="btn-close" onclick="closeAiSettingsModal()">Close</button>
                    <button class="btn-apply" onclick="applyAiSettings()">Apply</button>
                </div>
            </div>
        </div>
    </div>
</body>


</html>