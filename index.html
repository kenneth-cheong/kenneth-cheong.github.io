<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digimetrics</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon"
        href="https://mediaonemarketing.com.sg/wp-content/uploads/2023/11/cropped-MediaOne-M-favicon-logo-32x32.png"
        sizes="32x32">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script>
        // Google Sign-In variables (global scope)
        let googleUser = null; // Store the Google user object
        let codeReceiverURI = 'https://ts9k398yn8.execute-api.ap-southeast-1.amazonaws.com/googleLogin'; // Update with your actual URI

        // Function called after successful Google Sign-In
        function handleCredentialResponse(response) {
            fetch(codeReceiverURI, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ credential: response.credential })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.body.success) {
                        googleUser = data.body.user;
                        localStorage.setItem('googleUser', JSON.stringify(googleUser));
                        updateUI(true); // User logged in
                        console.log(data.body);
                        document.getElementById('logoutLink').querySelector('span') = "Logout " + data.body.user.name;
                    } else {
                        console.error("Backend verification failed:", data.message);
                        document.getElementById('loginError').textContent = data.message || "Google login failed.";
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loginError').textContent = "An error occurred.";
                });
        }


        function checkGoogleLogin() {
            const storedUser = localStorage.getItem('googleUser');
            if (storedUser) {
                googleUser = JSON.parse(storedUser);
                updateUI(true); // Already logged in via Google
                document.getElementById('logoutLink').querySelector('span').textContent = "Logout " + googleUser.name.split(' ')[0];
                return true; // Indicate Google login success
            }

            google.accounts.id.initialize({
                client_id: '365369983219-12iqvk3v35kf03p3ts1gikglddtkofvq.apps.googleusercontent.com',
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.getElementById('googleSignInButton'),
                { theme: "outline", size: "large" }
            );
            return false; // Google login not yet completed
        }

        // Function to update UI based on login status (modified)
        function updateUI(isLoggedIn) {
            document.getElementById('loginForm').style.display = isLoggedIn ? 'none' : 'flex';
            document.getElementById('main-content').style.display = isLoggedIn ? 'block' : 'none';
            document.getElementById('navbar').style.display = isLoggedIn ? 'block' : 'none';

            //Optionally: Display user info after Google login
            if (isLoggedIn && googleUser) {
                // Example: Show username after successful login
                const welcomeMessage = document.createElement('p');
                welcomeMessage.textContent = `Welcome, ${googleUser.name}!`;
                document.getElementById('main-content').prepend(welcomeMessage);  // or wherever you want to display it.
            }
        }

        window.onload = () => {
            const isLoggedIn = checkGoogleLogin();
            if (!isLoggedIn) {
                // Show the regular login form only if neither Google nor cookie login are active.
                document.getElementById('loginForm').style.display = 'flex';
            }
        }

    </script>



    <style>
        #loginForm {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            /* Semi-transparent background */
            z-index: 9999;
            /* Ensure it's on top */
        }

        #loginForm input {
            margin: 10px 0;
            padding: 8px;
            min-width: 40%;
        }

        #loginForm button {
            background-color: #004c9d;
            /* Example color */
            color: white;
            /* Text color */
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #navbar a.active-menu {
            background-color: #0056b3;
            font-weight: bold;
            border-radius: 10px;
        }


        #analysistable th:first-child,
        #analysistable td:first-child {
            position: sticky;
            left: 0;
            background-color: #004c9d;
            color: white;
        }

        thead th {
            position: sticky;
            top: 0;
            /* Stick the header to the top */
            background-color: #ddd;
            /* Optional: Different background for header */
            z-index: 1;
            /* Ensure header stays above other sticky elements */
        }


        #main-content {
            /* Initially hidden */
            display: none;
        }

        #keywordModal {
            display: flex;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 50%;
            height: 95%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            padding: 2%;
            border-radius: 20px;
        }

        .modal-content {
            background-color: #fefefe;
            border: 1px solid #888;
            width: 95%;
            border-radius: 10px;
            max-height: 95%;
            /* Account for padding/margin or border if present*/
            overflow-y: auto;
            /* Add vertical scrollbar if content overflows */
            padding: 15px;
        }

        .modal-content h2 {
            /* Example - add padding around the h2 */
            padding: 10px;
        }

        .modal-content table {
            /* Example - Add padding to the table */
            padding: 10px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #schema-output {
            white-space: pre-wrap;
            /* Allow line breaks */
            border: 1px solid #ccc;
            padding: 10px;
            font-family: monospace;
        }

        #navbar a i {
            margin-right: 2%;
            /* Adjust spacing as needed */
        }

        #navbar {
            width: 15%;
            background-color: #004c9d;
            color: white;
            padding: 10px;
            position: fixed;
            height: 100%;
            overflow-y: auto;
            border-radius: 10px;
            transition: width 0.3s;
        }

        /* Styles for smaller screens (e.g., mobile) */
        @media screen and (max-width: 768px) {
            #navbar {
                width: 60px;
                /* Reduced width for smaller screens */
            }

            #navbar img {
                width: 100%;
                /* Smaller logo */
            }

            #navbar span {
                display: none;
                /* Hide text labels */
            }

            #main-content {
                margin-left: 80px;
                /* Adjusted margin for smaller navbar */
            }

            .column {
                width: 100%;
            }
        }

        #navbar img {
            display: block;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 10%;
            margin-top: 10%;
        }

        #navbar a {
            display: block;
            padding: 10px 2px;
            color: white;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        #navbar a:hover {
            background-color: #0056b3;
            border-radius: 10px;
        }

        /* Adjust main content area to accommodate the navbar */
        #main-content {
            flex: 1;
            /* Allow main content to take up remaining space */
            margin-left: 17%;
            /* Adjust margin to create space for navbar */
            padding: 20px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 10px;
            background-color: #fbf7f5;
            color: #333;
            text-wrap: wrap;
        }

        input,
        select,
        button,
        textarea {
            padding: 10px;
            margin: 10px;
            border-radius: 10px;
            border: 1px solid #c8c8c8;
            font-family: inherit;
            font-size: 16px;
        }

        button {
            transition: background-color 0.3s, transform 0.1s;
            /* Add transform for a subtle lift effect */
            background-color: #c8c9ca;
        }

        button:hover {
            background-color: #004c9d;
            /* Darker blue on hover */
            transform: translateY(-2px);
            /* Move up slightly on hover */
            cursor: pointer;
            /* Change cursor to a pointer on hover */
            color: white;
        }

        input {
            min-width: 90%;
        }

        .input-short {
            min-width: 30%;
        }

        textarea {
            min-width: 90%;
            min-height: 50px;
            max-width: 90%;
        }

        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            background-color: #fffef7;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            table-layout: auto;
            display: block;
            table-layout: fixed;
            overflow-y: scroll;
        }

        #crawlerReport table {
            height: 600px;
        }

        .hidden-table {
            display: none;
        }

        th {
            resize: horizontal;
        }

        #crawlerReport th,
        #crawlerReport td {
            width: 10%;
            /* Adjust as needed for column distribution */
            overflow-x: auto;
            /* white-space: nowrap; Prevent text from wrapping */
            max-width: 200px;
            /* Adjust as needed */
            overflow-x: auto;
            vertical-align: top;
        }

        th,
        td {
            padding: 12px 8px;
            border: 1px solid #ddd;
            font-size: 14px;
            background-color: white;
            overflow: hidden;
        }

        th {
            background-color: #004c9d;
            position: sticky;
            color: white;
            top: 0;
        }

        .error {
            color: red;
            margin-left: 10px;
        }

        .collapsible {
            background-color: #004c9d;
            font-weight: bold;
            color: white;
            cursor: pointer;
            padding: 20px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 18px;
            transition: background-color 0.3s ease;
        }

        .collapsible:hover {
            background-color: #0056b3;
        }

        .collapsible-loading {
            background-color: #ffad33;
        }

        .content {
            display: none;
            padding: 20px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 10px;
        }

        button.sort-button {
            padding: 3px 6px;
            font-size: 12px;
            margin-left: 5px;
            background-color: #286b37;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }

        button.sort-button:hover {
            background-color: #218838;
        }

        hr {
            border-top: 4px solid rgb(95, 103, 154);
            border-radius: 7px;
            width: 100%;
        }

        .header-container {
            display: flex;
            align-items: center;
            /* Vertically center the items in the container */
            margin: 20px 0;
            /* Add some margin for spacing around the header */
            background-color: black;
            height: 70px;
            border-radius: 10px;
        }

        .header-container img {
            margin-right: 15px;
            /* Space between the image and the text */
            width: 75px;
            /* Adjust the width as needed */
            height: auto;
            /* Maintain aspect ratio */
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 4px solid #f3f3f3;
            /* Light grey */
            border-top: 4px solid #3498db;
            /* Blue */
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }

        p,
        h1,
        h2,
        h3 {
            text-wrap: wrap;
            font-family: 'Roboto', sans-serif;
        }

        h2 {
            margin-top: 20px;
        }

        h1 {
            margin: 0;
            /* Removes default margin */
            font-size: 36px;
            /* Optional: Adjust font size as needed */
        }

        #keywordListContainer {
            display: flex;
            /* Enable Flexbox layout for columns */
            flex-direction: column;
            /* Stack columns vertically */
            max-width: 100%;
            padding: 2px;
        }

        #keywordListContainer h3 {
            font-size: 1em;
            margin-top: 0;
            /* Reduce default margin */
        }

        .keyword-row {
            /* Style each row */
            display: flex;
            /* Use Flexbox for each row */
            align-items: center;
            /* Vertically center content in each row */
            margin-bottom: 5px;
            max-width: 65%;
        }

        .keyword-column {
            /* Style for each column */
            flex: 1;
            /* Each column takes equal width */
            margin-right: 5px;
            /* Space between columns */
            min-width: 50px;
        }

        .keyword-column:hover {
            font-size: 1.1em;
            cursor: pointer;
        }

        .keyword-column:nth-child(1) {
            /* Keyword column */
            flex: 0 0 60%;
        }

        .keyword-column:nth-child(2) {
            /* Search Volume column */
            flex: 0 0 30%;
        }

        .keyword-column:nth-child(3) {
            /* Difficulty column */
            flex: 0 0 22%;
        }

        input[type="checkbox"] {
            width: 3em;
        }


        .checkbox-column {
            flex: 0 0 5%;
            margin-right: 0;
        }

        .column {
            float: left;
            width: 50%;
        }

        ul {
            max-height: 350px;
            overflow: auto;
            width: 100%;
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: Window;
        }

        li {
            margin: 5px;
            padding: 0px;
            align-items: left;
        }

        label,
        label-fixed {
            color: WindowText;
            margin: 0;
            padding: 0;
            width: 100%;
        }

        .label-short {
            width: 100%;
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #auditSummary table {
            width: 50%;
            float: right;
            padding: 10px;
            height: 560px;
        }

        /* Table styling */
        #analysisTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            /* Remove display: block and table-layout: fixed  */
            max-height: 700px;
            /* Or whatever max height you want */
            overflow: auto;
            /* Scrollbars appear only when needed */
        }

        #analysisTable a {
            color: white;
        }

        #analysisTable th,
        #analysisTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            word-wrap: break-word;
            vertical-align: top;
            /* Align content to the top of each cell */
        }

        /* Make the table scrollable if it's too wide */
        #tableContainer {
            width: 100%;
            overflow-x: auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #SEM .column {
            width: 48%;
            /* Adjust as needed */
            float: left;
            /* Float columns side by side */
            margin-right: 2%;
            /* Add spacing between columns */
            box-sizing: border-box;
            /* Include padding and border in width calculation */
        }

        #SEM .column:last-child {
            margin-right: 0;
            /* No margin on the last column */
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 3em;
            height: 1.5em;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 1em;
            width: 1em;
            left: 3px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #004c9d;
        }

        input:focus+.slider {
            box-shadow: 0 0 1px #004c9d;
        }

        input:checked+.slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }


        .toggle-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .toggle-label {
            margin-right: 10px;
        }

        .toggle-label-right {
            margin-left: 10px;
        }

        .header-container img {
            margin-left: 20px;
            width: 400px;
            height: auto;
        }

        .faq-item {
            display: flex;
            align-items: flex-start;
            /* Align to top */
            margin-bottom: 10px;
        }

        .faq-item input,
        .faq-item textarea {
            flex-grow: 1;
            margin-right: 10px;
            min-width: 0;
            /* Prevent inputs from taking minimum width */
        }

        .faq-item textarea {
            min-height: 80px;
        }

        #navbar ul {
            list-style: none;
            padding: 0;
            margin: 0;
            background-color: #004c9d;
            max-height: None;
        }

        #navbar li {
            padding-left: 10px;
            /* Base indentation */
        }

        #navbar li ul li {
            padding-left: 20px;
            /* Increased indentation for sub-items */
        }

        /* You can add more levels as needed */
        #navbar li ul li ul li {
            padding-left: 30px;
        }

        .keyword-count {
            margin-left: 10px;
            color: #004c9d;
        }

        #downloadResultsBtn {
            display: none;
            /* Initially hidden */
            margin-top: 20px;
        }

        #navbar li a#logoutLink {
            display: block;
            color: white;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        #navbar li a#logoutLink:hover {
            background-color: #0056b3;
            /* Match hover effect of other links */
            border-radius: 10px;
        }

        #navbar li a#logoutLink i {
            /* Icon styling if needed */
            margin-right: 2%;
        }

        .tooltip {
            position: relative;
            /* Make the button position its children */
            display: inline-block;
            /* Necessary for relative positioning to work */
        }

        .tooltip span {
            position: absolute;
            z-index: 10;
            left: 50%;
            /* Center horizontally */
            transform: translateX(-50%);
            /* Center horizontally */
            bottom: calc(100% + 5px);
            /* Position below the button */
            min-width: 200px;
            max-width: 500px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            opacity: 0;
            visibility: hidden;
            /* Hide initially */
            transition: opacity 0.3s, visibility 0.3s;
            border-radius: 15px;
            font-size: 14px;
        }

        .tooltip:hover span {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>

<body>
    <div id="loginForm">
        <div id="googleSignInButton"></div>
        <p id="loginError" style="color: red;"></p>
    </div>
    <nav id="navbar">
        <img src="https://static.mycareersfuture.gov.sg/images/company/logos/a42a0e5029fd642119584ecdc6218b3a/MEDIAONE%20BUSINESS%20GROUP%20PTE.%20LTD..png"
            alt="MediaOne SEO Agency Logo">
        <ul>
            <li><a href="#seoSection" onclick="openKeywordAnalysis(event)"><i class="fas fa-search"></i>
                    <span>SEO</span></a>
                <ul>
                    <li><a href="#keywordAnalysis" onclick="openKeywordAnalysis(event)"><i class="fas fa-chart-bar"></i>
                            <span>Keyword Analysis</span></a>
                    </li>
                    <li><a href="#technicalSeo" onclick="openTechnicalSeo(event)"><i class="fas fa-tools"></i>
                            <span>Technical SEO</span></a></li>
                    <li><a href="#contentComparison" onclick="openContentComparison(event)"><i
                                class="fa fa-balance-scale"></i> <span>Content
                                Comparison</span></a></li>
                    <li><a href="#schema" onclick="openSchemaGenerator(event)"><i class="fas fa-code"></i> <span>Schema
                                Generator</span></a></li>
                </ul>
            </li>
            <li><a href="#socialMedia" onclick="openContentGenerator(event)"><i class="fas fa-share-alt"></i>
                    <span>SMM</span></a>
                <ul>
                    <li><a href="#contentGenerator" onclick="openContentGenerator(event)"><i class="fas fa-pen"></i>
                            <span>Content Generator</span></a></li>
                </ul>
            </li>
            <li><a href="#SEM" onclick="openSem(event)"><i class="fas fa-ad"></i> <span>SEM</span></a></li>
            <br><br>
            <li><a href="#" id="logoutLink" onclick="logout(event)"><i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span></a></li>
        </ul>
    </nav>
    </nav>
    <div id="main-content">
        <div class="header-container">
            <img src="Digimetrics Logo-02.png">
        </div>
        <hr>

        <button class="collapsible" id="seo">Search Engine Optimisation (SEO)</button>
        <div class="content" id="seoSection">

            <!-- Input Form for User Data -->
            <div class="column">
                <form id="seoForm">
                    <div>
                        <label-fixed for="domain">Targeted Domain / URL:</label-fixed>
                        <input type="url" id="domain" name="domain" required
                            placeholder="Domain: example.com | Webpage: https://www.example.com/">
                        <span class="error" id="domainError"></span>
                    </div>
                    <div>
                        <label-fixed for="location">Targeted Location or Country (required):</label-fixed>
                        <select id="location" name="location" required>
                            <option value="Singapore">Singapore</option>
                            <option value="Australia">Australia</option>
                            <option value="Brazil">Brazil</option>
                            <option value="Canada">Canada</option>
                            <option value="China">China</option>
                            <option value="France">France</option>
                            <option value="Germany">Germany</option>
                            <option value="India">India</option>
                            <option value="Indonesia">Indonesia</option>
                            <option value="Italy">Italy</option>
                            <option value="Japan">Japan</option>
                            <option value="Malaysia">Malaysia</option>
                            <option value="Mexico">Mexico</option>
                            <option value="Netherlands">Netherlands</option>
                            <option value="Russia">Russia</option>
                            <option value="South Korea">South Korea</option>
                            <option value="Spain">Spain</option>
                            <option value="Thailand">Thailand</option>
                            <option value="United Kingdom">United Kingdom</option>
                            <option value="United States">United States</option>
                            <option value="Vietnam">Vietnam</option>
                        </select>
                    </div>

                    <div>
                        <label-fixed for="language">Language (required):</label-fixed>
                        <select id="language" name="language" required>
                            <option value="English">English</option>
                            <option value="Arabic">Arabic</option>
                            <option value="Chinese (Simplified)">Chinese (Simplified)</option>
                            <option value="Chinese (Traditional)">Chinese (Traditional)</option>
                            <option value="Dutch">Dutch</option>
                            <option value="French">French</option>
                            <option value="German">German</option>
                            <option value="Hindi">Hindi</option>
                            <option value="Indonesian">Indonesian</option>
                            <option value="Italian">Italian</option>
                            <option value="Japanese">Japanese</option>
                            <option value="Korean">Korean</option>
                            <option value="Malay">Malay</option>
                            <option value="Portuguese">Portuguese</option>
                            <option value="Russian">Russian</option>
                            <option value="Spanish">Spanish</option>
                            <option value="Tamil">Tamil</option>
                            <option value="Thai">Thai</option>
                            <option value="Vietnamese">Vietnamese</option>
                        </select>
                    </div><br>
                    <div>
                        <label-fixed for="keywords">Keyword(s) of Interest (comma or newline separated):</label-fixed>
                        <span id="keywordCount" style="margin-left: 10px; color: #004c9d;"></span><br> <textarea
                            id="keywords" name="keywords" required placeholder="keyword1, keyword2"
                            oninput="updateKeywordCount()"></textarea>
                        <span class="error" id="keywordsError"></span>
                    </div>

                    <button type="button" id="keyword-research-analysis-button" class="tooltip" onclick="validateAndSubmit(event)">Analyse
                        <span>Click to get the estimated time to rank for the selected keywords and the webpage's metrics.</span>
                    </button>
                        <button type="button" id="similar" class="tooltip" onclick="similarKeywords(event)">Similar Keywords / SERPs
                            <span>Click to generate similar keywords based on the up to 20 of the keyword(s) you provided. </span>
                          </button>
                    <button type="button" id="ranking" class="tooltip" onclick="rankingKeywords(event)">Get Ranking Keywords
                        <span>Click to get the keywords which the domain or URL is ranking for.</span>
                    </button>
                </form>
                <div id="rankingError"></div>
                <table id="keywordTable" style="display: none;">
                    <tr>
                        <th>Keyword</th>
                        <th>Search Volume</th>
                        <th>Competition</th>
                        <th>Rank</th>
                    </tr>
                </table>

                <table id="top100Table" style="display: none;">
                    <tr>
                        <th>Keyword</th>
                        <th>Search Volume</th>
                        <th>Competition</th>
                        <th>Rank</th>
                    </tr>
                </table>

            </div>

            <div class="column">
                <button class="collapsible" id="keyword_suggestions">Keyword Suggestions
                </button>
                <div class="content" id="keywordSuggestions" >
                    <div id="keywordListContainer">
                        <h3 class="tooltip">Keyword Suggestions:
                            <span>Click on the keyword to see it's SERPs.</span>
                        </h3>
                        <div class="keyword-row" id="keywordHeaderRow">
                            <div class="keyword-column tooltip" onclick="sortKeywordSuggestions(0)">
                                <strong>Keyword</strong>
                                <span>Click on the keyword to see it's SERPs.</span>
                            </div>
                            <div class="keyword-column" onclick="sortKeywordSuggestions(1)">
                                <strong>Search Vol</strong>
                            </div>
                            <div class="keyword-column" onclick="sortKeywordSuggestions(2)">
                                <strong>Difficulty</strong>
                            </div>
                            <div class="keyword-column" onclick="sortKeywordSuggestions(3)">
                                <strong>CPC</strong>
                            </div>
                            <div class="checkbox-column"></div><strong>Choose</strong>
                        </div>
                        <ul id="keywordList">
                        </ul>
                    </div>
                </div>

                <br>

                <button class="collapsible" id="ranking_keywords">Ranking Keywords</button>
                <div class="content" id="rankingKeywords">
                    <div id="keywordListContainer">
                        <h3 id="rankedKeywordsCount">Ranked Keywords:</h3>
                        <div class="keyword-row" id="rankedKeywordHeaderRow">
                            <div class="keyword-column" onclick="sortRankedKeywords(0)">
                                <strong>Keyword</strong>
                            </div>
                            <div class="keyword-column" onclick="sortRankedKeywords(1)">
                                <strong>Search Vol</strong>
                            </div>
                            <div class="keyword-column" onclick="sortRankedKeywords(2)">
                                <strong>Rank</strong>
                            </div>
                            <div class="keyword-column" onclick="sortRankedKeywords(3)">
                                <strong>Difficulty</strong>
                            </div>
                            <div class="checkbox-column"></div><strong>Choose</strong>
                        </div>
                        <ul id="rankedKeywordList"></ul>
                    </div>
                </div>
            </div>


            <hr>
            <button class="collapsible" id="meta_data">Meta Data</button>
            <div class="content" id="metaData">
                <p><b>Meta Title: </b><span id="targetTitle">-</span></p>
                <p><b>Meta Description: </b><span id="targetDescription">-</span></p>
                <p><b>h1 Header: </b><span id="targetH1">-</span></p>

            </div>

            <button class="collapsible" id="domain_metrics">Domain Metrics (DA, PA, PageSpeed)</button>
            <div class="content" id="domainMetrics">
                <div class="column">
                    <p><b>Domain Authority (DA): </b><span id="da">-</span></p>
                    <p><b>Page Authority (PA): </b><span id="pa">-</span></p>
                    <p><b>Google PageSpeed: </b><span id="targetPagespeed">-</span></p>
                    <p><b>Backlinks Spam Score: </b><span id="targetSpamScore">-</span></p>
                    <p><b>Backlinks: </b><span id="targetBacklinks">-</span></p>
                    <p><b>Referring Domains: </b><span id="targetRefDomains">-</span></p>
                    <p><b>Domain Rank: </b><span id="targetDomainRank">-</span></p>
                    <p><b>Page Word Count: </b><span id="targetWordCount">-</span></p>
                </div>
                <div class="column">
                    <p><b>Internal Links: </b><span id="targetInternalLinks">-</span></p>
                    <p><b>External Links: </b><span id="targetExternalLinks">-</span></p>
                    <p><b>Flesch Readability: </b><span id="targetReadability">-</span></p>
                    <p><b>Images: </b><span id="targetImages">-</span></p>
                    <p><b>CLS: </b><span id="targetCls">-</span></p>
                    <p><b>LCP: </b><span id="targetLcp">-</span></p>
                    <p><b>FID: </b><span id="targetFid">-</span></p>
                    <p><b>Schema: </b><span id="targetSchema">-</span></p>
                </div>
                <div style="clear: both;"></div>
                <div> </div> <!-- Clearfix -->
            </div>
            <hr>
            <button class="collapsible" id="keywordAnalysis">Keyword Analysis</button>
            <div class="content" id="keywordAnalysis">
                <div id="keywordAnalysisResults"></div>
                <button id="downloadKeywordAnalysisCSVButton" onclick="downloadKeywordAnalysisTableAsCSV()"
                    style="display:none;">Download .csv</button>
            </div>
            <hr>
            <button class="collapsible" id="technicalButton">Technical SEO</button>
            <div class="content" id="technicalSeo">
                <label for="urlInput">Enter URL:</label>
                <input type="text" id="urlInput">
                <br>
                <label for="maxPagesInput">Max Pages to Crawl:</label>
                <input type="number" id="maxPagesInput" value="10">

                <button id="submitBtn">Analyse Website</button>

                <br><br>

                <div id="auditSummary"></div>

                <button class="collapsible" id="gtButton">GTmetrix Results</button>
                <div class="content" id="gtMetrix">
                    <div id="gtmetrixReport" style="display:none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Report URL</td>
                                    <td id="reportUrl"></td>
                                </tr>
                                <tr>
                                    <td>Cumulative Layout Shift</td>
                                    <td id="cls"></td>
                                </tr>
                                <tr>
                                    <td>Largest Contentful Paint</td>
                                    <td id="lcp"></td>
                                </tr>
                                <tr>
                                    <td>Total Blocking Time</td>
                                    <td id="tbt"></td>
                                </tr>
                                <tr>
                                    <td>GTmetrix Grade</td>
                                    <td id="grade"></td>
                                </tr>
                                <tr>
                                    <td>GTmetrix Performance Score</td>
                                    <td id="performance"></td>
                                </tr>
                            </tbody>
                        </table>
                        <br><br>
                    </div>
                </div>

                <button class="collapsible" id="pageButton">Page Analysis Results</button>
                <div class="content" id="pageAnalysis">
                    <div id="pageAuditReport" style="display:none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>PageSpeed (Mobile)</td>
                                    <td id="pagespeed_audit"></td>
                                </tr>
                                <tr>
                                    <td>Malware</td>
                                    <td id="malware"></td>
                                </tr>
                                <tr>
                                    <td>robots.txt</td>
                                    <td id="robots"></td>
                                </tr>
                                <tr>
                                    <td>Sitemap</td>
                                    <td id="sitemap"></td>
                                </tr>
                            </tbody>
                        </table>
                        <br><br>
                    </div>
                </div>

                <button class="collapsible" id="crawlerButton">Crawler Report</button>
                <div class="content" id="crawlerSection">
                    <div id="crawlerReport" style="display:none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>URL</th>
                                    <th>Code</th>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>Canonical</th>
                                    <th>Hreflang</th>
                                    <th>Alt Text</th>
                                    <th>H1</th>
                                    <th>H2</th>
                                    <th>Word Count</th>
                                    <th>UI/UX</th>
                                </tr>
                            </thead>
                            <tbody id="crawlerTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <button id="downloadResultsBtn" onclick="downloadResultsAsXlsx()">Download results as xlsx</button>
            </div>
            <hr>
            <button class="collapsible" id="contentComparisonButton">Content Comparison</button>
            <div class="content" id="contentComparison">
                <label for="comparison-keyword">Keyword:</label>
                <input type="text" id="comparison-keyword" placeholder="e.g., digital marketing">
                <br>
                <label for="comparison-urls">or URLs (separate by new line or comma):</label>
                <textarea id="comparison-urls"
                    placeholder="e.g., https://example.com, https://another-example.com"></textarea>
                <br>
                <div class="column">
                    <label for="comparison-language">Language:</label>
                    <input type="text" id="comparison-language" value="English" placeholder="e.g., English">
                </div>
                <div class="column">
                    <label for="comparison-location">Location:</label>
                    <input type="text" id="comparison-location" value="Singapore" placeholder="e.g., Singapore">
                </div>
                <br>
                <button id="analyzeBtn">Analyse (up to 3 mins)</button>

                <div id="loading-messages">
                    <p class="message"></p>
                </div>
                <div id="initial-table"></div>
                <div id="comparison-results"></div>
            </div>

            <hr>

            <button class="collapsible" id="schemaGeneratorButton">Schema Generator</button>
            <div class="content" id="schema">
                <label for="schema-type">Schema Type:</label>
                <select id="schema-type">
                    <option value="LocalBusiness">Local Business</option>
                    <option value="Product">Product</option>
                    <option value="Event">Event</option>
                    <option value="Article">Article</option>
                    <option value="BreadcrumbList">Breadcrumb</option>
                    <option value="Event">Event</option>
                    <option value="FAQPage">FAQ Page</option>
                    <option value="HowTo">How-to</option>
                    <option value="JobPosting">Job Posting</option>
                    <option value="Organization">Organisation</option>
                    <option value="Person">Person</option>
                    <option value="Product">Product</option>
                    <option value="VideoObject">Video</option>
                    <option value="Website">Website</option>
                    <!-- Add more schema types as needed -->
                </select>

                <div id="input-fields"></div>
                <div id="schema-output"></div>
            </div>
        </div>
        <hr>
        <button class="collapsible" id="smm">Social Media (SMM)</button>
        <div class="content" id="socialMedia">
            <button class="collapsible" id="contentGeneratorButton">Content Generator</button>
            <div class="content" id="contentGenerator">
                <form id="content-form">
                    <div class="column">
                        <div class="column">
                            <label for="gender">Gender:</label><br>
                            <select id="gender" name="gender">
                                <option value=""></option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="non-specfic-gender">Non-Specific</option>
                            </select>
                        </div>
                        <div class="column">
                            <label for="age-range">Age e.g. Students, 30-40 years old:</label>
                            <input class="input-short" type="text" id="age-range" name="age-range">
                        </div>

                        <div style="clear: both;"></div>

                        <label for="occupation">Occupation e.g. Homemakers, Professionals:</label><br>
                        <input type="text" id="occupation" name="occupation">

                        <label for="income">Income (e.g. Mid Income):</label>
                        <input type="text" id="income" name="income">

                        <label for="reference-url">Reference Webpage URL (Optional):</label>
                        <input type="url" id="reference-url" name="reference-url">

                    </div>

                    <div class="column">

                        <label for="subgroups">Sub-Groups (e.g. Badminton Players):</label>
                        <input type="text" id="subgroups" name="subgroups">

                        <label for="painpoints">Pain Points (e.g. not enough time):</label>
                        <input type="text" id="painpoints" name="painpoints">

                        <label for="audience_goal">Audience Goals (e.g. Convenience):</label>
                        <input type="text" id="audience_goal" name="audience_goal">

                    </div>


                    <br>

                    <label for="reference-files">Reference Files/Brand Guide (Optional - Up to 5):</label>
                    <input class="input-short" type="file" id="reference-files" name="reference-files" multiple
                        disabled>
                    <br><br>

                    <label for="sample-text">Sample Text/Post (Optional):</label><br>
                    <textarea id="sample-text" name="sample-text"></textarea><br><br>

                    <label for="post-info">Content of Post:</label><br>
                    <textarea id="post-info" name="post-info"></textarea><br><br>

                    <div class="column">

                        <label for="product_service">Product / Service:</label>
                        <input type="text" id="product_service" name="product_service">

                        <label for="desired_action">Desired Action e.g. Contact us:</label>
                        <input type="text" id="desired_action" name="desired_action">
                        <br>

                        <label for="post_objectives">Post Objectives e.g. Branding, Lifestyle, Seasonal
                            Greetings:</label>
                        <input type="text" id="post_objectives" name="post_objectives">

                        <div class="column">
                            <label for="content-type">Type of Content:</label><br>
                            <select id="content-type" name="content-type">
                                <option value="blog-post">Blog Post</option>
                                <option value="instagram-caption">Instagram Caption</option>
                                <option value="facebook-post">Facebook Post</option>
                                <option value="linkedin-post">LinkedIn Post</option>
                            </select>
                        </div>

                        <br>
                        <div class="column">

                            <label for="word_count">Word Count e.g. Long, 100 words:</label>
                            <input class="input-short" type="text" id="word_count" name="word_count">
                        </div>


                    </div>

                    <div class="column">

                        <label for="tone">Tone of Voice e.g. Luxury, Professional, Casual:</label>
                        <input type="text" id="tone" name="tone">
                        <br>

                        <label for="usp">Unique Selling Point e.g. Available 24/7, Budget friendly:</label>
                        <input type="text" id="usp" name="usp">

                        <label for="pov">POV e.g. 1st person, 3rd person:</label>
                        <input type="text" id="pov" name="pov">
                        <br>

                        <div class="column">
                            <label for="emojis">Emojis:</label><br>
                            <select id="emojis" name="emojis">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                        <div class="column">
                            <label for="hashtags">Hashtags:</label><br>
                            <select id="hashtags" name="hashtags">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                    </div>
                    <div style="clear: both;"></div>

                    <button type="submit" id="generate-button">Generate Content</button>
                </form>

                <div id="generated-content"></div>
            </div>
        </div>

        <hr>
        <button class="collapsible" id="semButton">Search Engine Marketing (SEM)</button>
        <div class="content" id="SEM">
            <label for="ad_format">Ad Formats:</label><br>
            <select id="ad_format" name="ad_format">
                <option value="google-responsive-search-ads">Google Responsive Search Ads</option>
                <option value="google-performance-max-ads">Google Performance Max Ads</option>
                <option value="google-display-ads">Google Display Ads</option>
                <option value="meta-image-ads">Meta Image Ads</option>
                <option value="meta-video-ads">Meta Video Ads</option>
                <option value="meta-carousel-ads">Meta Carousel Ads</option>
                <option value="meta-collection-ads">Meta Collection Ads</option>
                <option value="linkedin-image-ads">LinkedIn Image Ads</option>
                <option value="linkedin-carousel-ads">LinkedIn Carousel Ads</option>
                <option value="linkedin-video-ads">LinkedIn Video Ads</option>
                <option value="linkedin-click-to-message-ads">LinkedIn Click To Message Ads</option>
            </select>
            <br>
            <label for="sem_webpages">Webpages (seperated by commas or new lines):</label><br>
            <textarea id="sem_webpages" placeholder="e.g., https://example.com, https://another-example.com"></textarea>
            <br>
            <div class="column">
                <label for="sem_country">Country:</label><br>
                <input type="text" id="sem_country" value="Singapore"><br>
            </div>
            <div class="column">
                <label for="sem_tone">Tone of Voice:</label><br>
                <input type="text" id="sem_tone" value="Salesy"><br>
            </div>
            <div class="column">
                <label for="sem_language">Language:</label><br>
                <input type="text" id="sem_language" value="English"><br>
            </div>
            <div style="clear: both;"></div><br>
            <div class="toggle-container" id="semBrandFocus">
                <span class="toggle-label">Don't Focus on Brand/Company</span>
                <label class="switch">
                    <input type="checkbox" id="brand-checkbox"> <span class="slider round"></span>
                </label>
                <span class="toggle-label-right">Focus on Brand/Company</span>
            </div><br>
            <div class="toggle-container" id="semProductFocus">
                <span class="toggle-label">Don't Focus on Products/Services</span>
                <label class="switch">
                    <input type="checkbox" id="product-checkbox" checked> <span class="slider round"></span>
                </label>
                <span class="toggle-label-right">Focus on Products/Services</span>
            </div>
            <div style="clear: both;"></div>
            <br>
            <label for="sem_additional">Addtional Information (optional):</label><br>
            <textarea id="sem_additional"
                placeholder="You can input information that is not found in the webpage(s) content or focus area(s) here"></textarea></textarea>

            <br>
            <button id="getProducts" onclick="semWebpageProducts()">Step 1: Identify
                products/services/brand/company</button>
            <br>
            <div id="products"></div>
            <br>
            <button id="semAnalyse" onclick="semAnalyseWebsite()">Step 2: Generate KWs, USPs & Audience</button>
            <br>

            <div class="column" id="output"></div>
            <div class="column" id="selected" style="display:none;">
                <h2>Selected</h2>
                <textarea id="selectedText" rows="20"></textarea><br>
                <button id="generateSem" onclick="generateGoogle()">Step 3: Select checkboxes then click
                    here</button>
                <h2>Generated</h2>
                <div id="generated"></div>
            </div>
            <div style="clear: both;"></div>
            <div> </div> <!-- Clearfix -->
        </div>
    </div>

    <script id="local-business-template" type="text/x-handlebars-template">
        <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
        <label for="address">Address:</label><input type="text" id="address" oninput="updateSchema()"><br>
        <label for="telephone">Telephone:</label><input type="text" id="telephone" oninput="updateSchema()"><br>
      </script>

    <script id="product-template" type="text/x-handlebars-template">
          <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
          <label for="description">Description:</label><input type="text" id="description" oninput="updateSchema()"><br>
          <label for="brand">Brand:</label><input type="text" id="brand" oninput="updateSchema()"><br>
      </script>

    <script id="event-template" type="text/x-handlebars-template">
          <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
          <label for="startDate">Start Date:</label><input type="date" id="startDate" oninput="updateSchema()"><br>
          <label for="location">Location:</label><input type="text" id="location" oninput="updateSchema()"><br>
          <label for="description">Description:</label><textarea id="description" oninput="updateSchema()"></textarea><br>
      </script>

    <script id="article-template" type="text/x-handlebars-template">
          <label for="headline">Headline:</label><input type="text" id="headline" oninput="updateSchema()"><br>
          <label for="author">Author:</label><input type="text" id="author" oninput="updateSchema()"><br>
          <label for="datePublished">Date Published:</label><input type="date" id="datePublished" oninput="updateSchema()"><br>
          <label for="articleBody">Article Body:</label><textarea id="articleBody" oninput="updateSchema()"></textarea><br>
      </script>

    <script id="breadcrumblist-template" type="text/x-handlebars-template">
          <div id="breadcrumb-items">
              <div class="breadcrumb-item">
                  <input type="text" id="name1" placeholder="Page #1's name" oninput="updateSchema()">
                  <input type="url" id="url1" placeholder="URL #1" oninput="updateSchema()">
                  <button class="remove-item" onclick="removeItem(this)">x</button>
              </div>
              <div class="breadcrumb-item">
                  <input type="text" id="name2" placeholder="Page #2's name" oninput="updateSchema()">
                  <input type="url" id="url2" placeholder="URL #2" oninput="updateSchema()">
                   <button class="remove-item" onclick="removeItem(this)">x</button>
              </div>
          </div>
          <button onclick="addItem()"> + ADD URL </button>
      
        </script>

    <script id="faqpage-template" type="text/x-handlebars-template">
          <div id="faq-items">
              <div class="faq-item">
                  <input type="text" id="question1" placeholder="Question #1" oninput="updateSchema()">
                  <textarea id="answer1" placeholder="Answer" oninput="updateSchema()"></textarea>
                  <button class="remove-item" onclick="removeFaqItem(this)">x</button> <br>
              </div>
          </div>
          <button onclick="addFaqItem()">+ ADD QUESTION</button>
      </script>
    <script id="howto-template" type="text/x-handlebars-template">
          <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
          <label for="description">Description:</label><textarea id="description" oninput="updateSchema()"></textarea><br>
          <label for="supply">Supply (JSON-LD array of HowToSupply objects):</label><textarea id="supply" class="json-ld" oninput="updateSchema()"></textarea><br>
          <label for="step">Steps (JSON-LD array of HowToStep objects):</label><textarea id="step" class="json-ld" oninput="updateSchema()"></textarea><br>
          * See schema.org/HowTo for details on HowToSupply and HowToStep structure.
        </script>

    <script id="jobposting-template" type="text/x-handlebars-template">
          <label for="title">Job Title:</label><input type="text" id="title" oninput="updateSchema()"><br>
          <label for="description">Job Description:</label><textarea id="description" oninput="updateSchema()"></textarea><br>
          <label for="datePosted">Date Posted:</label><input type="date" id="datePosted" oninput="updateSchema()"><br>
          <label for="employmentType">Employment Type:</label><input type="text" id="employmentType" oninput="updateSchema()"><br>
          <label for="hiringOrganization">Hiring Organization (Name):</label><input type="text" id="hiringOrganization_name" oninput="updateSchema()"><br>
         <label for="hiringOrganization">Hiring Organization (Website):</label><input type="url" id="hiringOrganization_sameAs" oninput="updateSchema()"><br>
        </script>


    <script id="organization-template" type="text/x-handlebars-template">
          <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
          <label for="url">URL:</label><input type="url" id="url" oninput="updateSchema()"><br>
          <label for="logo">Logo URL:</label><input type="url" id="logo" oninput="updateSchema()"><br>
        </script>

    <script id="person-template" type="text/x-handlebars-template">
          <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
          <label for="jobTitle">Job Title:</label><input type="text" id="jobTitle" oninput="updateSchema()"><br>
        
        </script>


    <script id="video-object-template" type="text/x-handlebars-template">
            <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
            <label for="description">Description:</label><input type="text" id="description" oninput="updateSchema()"><br>
            <label for="uploadDate">Upload Date:</label><input type="date" id="uploadDate" oninput="updateSchema()"><br>
            <label for="thumbnailUrl">Thumbnail URL:</label><input type="url" id="thumbnailUrl" oninput="updateSchema()"><br>
        </script>

    <script id="website-template" type="text/x-handlebars-template">
            <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
            <label for="url">URL:</label><input type="url" id="url" oninput="updateSchema()"><br>
        </script>

    <script>

        const submitBtn = document.getElementById('submitBtn');
        const gtmetrixReportDiv = document.getElementById('gtmetrixReport');
        const crawlerReportDiv = document.getElementById('crawlerReport');
        const crawlerTableBody = document.getElementById('crawlerTableBody');
        const pageAuditReportDiv = document.getElementById('pageAuditReport');

        const analyzeBtn = document.getElementById('analyzeBtn');
        const resultsDiv = document.getElementById('comparison-results');
        const loadingMessagesDiv = document.getElementById('loading-messages');
        const messageElement = document.querySelector('.message');
        const messages = [
            'Getting SERP results...',
            'Analysing Page Content...',
            'Formulating Content Topics...',
            'Comparing Topics Across Results...',
            'Collating Findings...'
        ];
        let currentMessageIndex = 0;

        brandCheckbox = document.getElementById('brand-checkbox');
        productCheckbox = document.getElementById('product-checkbox');

        brandCheckbox.addEventListener('change', () => {
            if (brandCheckbox.checked) {
            } else {
                if (productCheckbox.checked) {

                } else {
                    productCheckbox.checked = true;
                }
            }
        });

        productCheckbox.addEventListener('change', () => {
            if (productCheckbox.checked) {
            } else {
                if (brandCheckbox.checked) {

                } else {
                    brandCheckbox.checked = true;
                }
            }
        });

        submitBtn.addEventListener('click', () => {
            const url = document.getElementById('urlInput').value;
            const maxPages = document.getElementById('maxPagesInput').value;

            submitBtn.innerHTML = 'Analysing...';
            document.getElementById("technicalButton").style.backgroundColor = "#004c9d";
            document.getElementById("gtButton").style.backgroundColor = "#004c9d";
            document.getElementById("pageButton").style.backgroundColor = "#004c9d";
            document.getElementById("crawlerButton").style.backgroundColor = "#004c9d";

            document.getElementById('auditSummary').innerHTML = "";

            // GTMetrix API call
            fetch("https://y5830908vh.execute-api.ap-southeast-1.amazonaws.com/gtmetrix", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            })
                .then(response => response.json())
                .then(gt_data => {
                    document.getElementById('reportUrl').innerHTML = '<a href="' + gt_data.body.data.links.report_url + '" target="_blank" rel="noopener noreferrer">' + gt_data.body.data.links.report_url + '</a>';
                    document.getElementById('cls').textContent = gt_data.body.data.attributes.cumulative_layout_shift;
                    document.getElementById('lcp').textContent = gt_data.body.data.attributes.largest_contentful_paint;
                    document.getElementById('tbt').textContent = gt_data.body.data.attributes.total_blocking_time;
                    document.getElementById('grade').textContent = gt_data.body.data.attributes.gtmetrix_grade;
                    document.getElementById('performance').textContent = gt_data.body.data.attributes.performance_score;

                    gtmetrixReportDiv.style.display = 'block';
                    document.getElementById("gtButton").style.backgroundColor = "green";

                })

                .catch(error => console.error('Error fetching GTMetrix data:', error));


            // Webpage Audit
            fetch("https://7vkudwlzhh.execute-api.ap-southeast-1.amazonaws.com/webpageAudit", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            })
                .then(response => response.json())
                .then(webpage_audit_data => {
                    document.getElementById('malware').textContent = webpage_audit_data.body.malware;
                    document.getElementById('sitemap').textContent = webpage_audit_data.body.sitemap;
                    document.getElementById('robots').innerHTML = webpage_audit_data.body.robots;
                    document.getElementById('pagespeed_audit').textContent = webpage_audit_data.body.pagespeed;

                    pageAuditReportDiv.style.display = 'block';
                    document.getElementById("pageButton").style.backgroundColor = "green";
                    document.getElementById("technicalButton").style.backgroundColor = "green";
                })
                .catch(error => console.error('Error fetching Webpage Audit data:', error));


            // Crawler API call
            fetch("https://464q7iox7h.execute-api.ap-southeast-1.amazonaws.com/crawler", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url, max_pages: parseInt(maxPages) })
            })
                .then(response => response.json())
                .then(data => {
                    crawlerTableBody.innerHTML = ''; // Clear previous data

                    for (const pageUrl in data.body) {
                        const pageData = data.body[pageUrl];
                        const row = document.createElement('tr');
                        row.innerHTML = `   
                        <td>${pageUrl}</td>
                        <td>${pageData.code}</td>
                        <td>${pageData.title}</td>
                        <td>${pageData.description}</td>
                        <td>${pageData.canonical}</td>
                        <td>${pageData.hreflang}</td>
                        <td>${pageData.alt_text}</td>
                        <td>${pageData.h1}</td>
                        <td>${pageData.h2}</td>
                        <td>${pageData.word_count}</td>
                        <td>${pageData.uiux}</td>
                    `;
                        crawlerTableBody.appendChild(row);
                    }
                    crawlerReportDiv.style.display = 'block';
                    submitBtn.innerHTML = 'Analyse Website';


                    // Audit Summary
                    gt_data = { "cumulative_layout_shift": document.getElementById('cls').textContent, "largest_contentful_paint": document.getElementById('lcp').textContent, "total_blocking_time": document.getElementById('tbt').textContent };
                    webpage_audit_data = { 'google_safe_site': document.getElementById('malware').textContent, 'sitemap': document.getElementById('sitemap').textContent, 'robots_txt': document.getElementById('robots').innerHTML, 'pagespeed': document.getElementById('pagespeed_audit').textContent };

                    fetch("https://ccgdpp7dna.execute-api.ap-southeast-1.amazonaws.com/techAuditSummary", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ crawl: data, gtmetrix: gt_data, webpage_audit: webpage_audit_data })
                    })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('auditSummary').innerHTML = data.body;
                            document.getElementById("crawlerButton").style.backgroundColor = "green";
                        })
                        .catch(error => console.error('Error fetching Audt Summary API:', error));

                })
                .catch(error => {
                    console.error('Error fetching crawler data:', error);
                    submitBtn.innerHTML = 'Analyse Website';
                })

                .finally(() => {
                    document.getElementById('downloadResultsBtn').style.display = 'block';
                });

        });

        analyzeBtn.addEventListener('click', async () => {
            // Show loading messages, hide previous results
            resultsDiv.innerHTML = '';
            analyzeBtn.innerHTML = 'Analysing...';
            loadingMessagesDiv.classList.add('active');

            keyword = document.getElementById('comparison-keyword').value;
            const urlsInput = document.getElementById('comparison-urls').value;
            const language = document.getElementById('comparison-language').value;
            const location = document.getElementById('comparison-location').value;
            user = JSON.parse(localStorage.getItem('googleUser')).email
            urls = urlsInput.split(/[\s,]+/).filter(url => url.trim() !== "");
            const loadingMessageInterval = setInterval(updateLoadingMessage, 4000);

            try {
                // Function to cycle through loading messages
                function updateLoadingMessage() {
                    messageElement.textContent = messages[currentMessageIndex];
                    currentMessageIndex = (currentMessageIndex + 1) % messages.length;
                }

                // Start cycling loading messages
                //const loadingMessageInterval = setInterval(updateLoadingMessage, 4000);

                let serpUrls = [];
                try {
                    if (keyword != "") {
                        // 1. Fetch URLs from SERP API
                        const serpResponse = await fetch('https://u22k9g2y8c.execute-api.ap-southeast-1.amazonaws.com/new', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ keyword, language, location, user }),
                        });
                        const serpData = await serpResponse.json();
                        if (serpData.statusCode !== 200) {
                            throw new Error(`SERP API Error: ${serpData.body || serpData.errorMessage}`);
                        }
                        serpUrls = Object.values(serpData.body).map(result => result.url);

                        if (urls != "") {
                            serpUrls = [...new Set([...serpUrls, ...urls])]; // Combine and deduplicate
                        }

                    } else {
                        serpUrls = urls;
                    }
                } catch (error) {
                    serpUrls = urls;
                }

                // 2. Fetch content analysis for each URL *concurrently*
                const analysisPromises = serpUrls.map(url =>
                    fetch('https://u24f9208q0.execute-api.ap-southeast-1.amazonaws.com/gptTopicsPerUrl', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, keyword }),
                    }).then(res => {
                        if (!res.ok) {  // Check for errors
                            throw new Error(`Content analysis API error for ${url}: ${res.status} ${res.statusText}`);
                        }
                        return res.json();
                    })
                );

                // Wait for *all* content analysis calls to complete
                analysisDataArray = await Promise.all(analysisPromises);

                // Combine analysis data, handling potential errors from individual API calls
                analysisData = {};
                analysisDataArray.forEach(item => {
                    url = Object.keys(item['body'])[0];
                    analysisData[url] = item['body'][url];
                }
                );

                // Check if analysisData is empty after combining results.
                if (Object.keys(analysisData).length === 0) {
                    throw new Error("Content analysis failed for all URLs. Please check the URLs and try again.");
                }

                // 3. Create and display the table (modified createAnalysisTable function below)
                comparisonTableHTML = createAnalysisTable(analysisData, keyword, urls);  // Pass keyword and target URLs
                document.getElementById('initial-table').innerHTML = `<div id="tableContainer">${comparisonTableHTML}</div>`;

                // 4. Apply gradients (no change needed)
                applyGradientsToRows();

                // 5. Submit table data to comparisonRecommender API
                const comparisonResponse = await fetch('https://33v5mhjt47.execute-api.ap-southeast-1.amazonaws.com/comparisonRecommender', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ output: analysisData, keyword }), // Send analysisData directly
                });
                const comparisonData = await comparisonResponse.json();

                // Display recommendations and output table from comparison API
                const recommendation = comparisonData.body.recommendation;

                try {
                    //const outputTableHTML = createHTMLTableFromJSON(comparisonData.body.output); // Parse JSON string to object
                    const outputTableHTML = createAnalysisTable(comparisonData.body.output, keyword, urls)
                    document.getElementById('initial-table').innerHTML = "";
                    document.getElementById('initial-table').innerHTML = `<div id="tableContainer">${outputTableHTML}</div>`;
                    resultsDiv.innerHTML += `<pre>${recommendation}</pre>`;
                    console.log('refresh succesful');

                    // 4. Apply gradients (no change needed)
                    applyGradientsToRows();

                } catch (error) {
                    console.log(error)
                    resultsDiv.innerHTML += `<pre>${recommendation}</pre>`;
                }

                // --- Data is ready, stop loading messages ---
                clearInterval(loadingMessageInterval);
                loadingMessagesDiv.classList.remove('active');

                analyzeBtn.innerHTML = 'Analyse (up to 3 mins)';

            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                try {
                    clearInterval(loadingMessageInterval);
                    loadingMessagesDiv.classList.remove('active');
                } catch (error) {
                    clearInterval(loadingMessageInterval);
                    loadingMessagesDiv.classList.remove('active');
                }
                loadingMessagesDiv.classList.remove('active');
                analyzeBtn.innerHTML = 'Analyse (up to 3 mins)';
            }
        });

        // Function to create the HTML table from the analysis data
        function createAnalysisTable(data, keyword, targetUrls) {
            let tableHTML = '<table id="analysisTable">';
            tableHTML += '<tr><th>URL</th>';

            const urls = Object.keys(data);
            urls.forEach(url => {
                tableHTML += `<th ${targetUrls.includes(url) && keyword ? 'class="targetUrl"' : ''}>
                        <a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a></th>`;
            });
            tableHTML += '</tr>';


            // Add Word Count row
            tableHTML += '<tr><td>Word Count</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td data-value="${data[url].word_count}">${data[url].word_count}</td>`;
                } catch (error) {
                    tableHTML += `<td data-value="0">0</td>`;
                }
            });
            tableHTML += '</tr>';

            // Add Page Type row
            tableHTML += '<tr><td>Page Type</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td>${data[url].page_type}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            // Add headings rows
            tableHTML += '<tr><td>h1</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td> • ${data[url].h1.join('<br> • ')}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            tableHTML += '<tr><td>h2</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td> • ${data[url].h2.join('<br> • ')}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            tableHTML += '<tr><td>h3</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td> • ${data[url].h3.join('<br> • ')}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            // Get all unique topics, handling missing topics
            let allTopics = [];
            urls.forEach(url => {
                if (data[url] && data[url].topics) {
                    allTopics = [...allTopics, ...Object.keys(data[url].topics)];
                }
            });
            const uniqueTopics = [...new Set(allTopics)];

            // Add Topic rows (handling missing topic data)
            uniqueTopics.forEach(topic => {
                tableHTML += `<tr><td>${topic.replaceAll('_', ' ')}</td>`;
                urls.forEach(url => {
                    const value = (data[url] && data[url].topics && data[url].topics[topic]) ? data[url].topics[topic] : 0;
                    tableHTML += `<td data-value="${value}">${value}</td>`;
                });
                tableHTML += '</tr>';
            });

            tableHTML += '</table>';
            return tableHTML;
        }

        function applyGradientsToRows() {
            const table = document.getElementById('analysisTable');
            for (let i = 1; i < table.rows.length; i++) { // Start from row 1 to skip header
                applyGradientToRow(table.rows[i]);
            }
        }

        function applyGradientToRow(row) {
            const values = Array.from(row.cells)
                .slice(1) // Skip the first cell (topic name)
                .map(cell => {
                    const value = parseFloat(cell.dataset.value);
                    return isNaN(value) ? -1 : value; // Assign -1 for non-numeric values
                });

            const max = Math.max(...values);
            const min = Math.min(...values);

            values.forEach((value, index) => {
                const cell = row.cells[index + 1]; // +1 to account for the first cell
                if (!isNaN(value) && value !== -1) { // Apply gradient only to numeric values
                    const percent = (value - min) / (max - min);
                    const red = Math.round(255 * (1 - percent));
                    const green = Math.round(255 * percent);
                    cell.style.backgroundColor = `rgb(${red}, ${green}, 0)`;
                }
            });
        }

        const form = document.getElementById('content-form');
        const generatedContentDiv = document.getElementById('generated-content');
        const generateButton = document.getElementById('generate-button');

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            // Disable the button and change text
            generateButton.disabled = true;
            generateButton.textContent = 'Generating Content...';

            const formData = new FormData(form);
            const contentData = {
                "url": formData.get('reference-url'),
                "reference_post": formData.get('sample-text'),
                "content_type": formData.get('content-type'),
                "post_info": formData.get('post-info'),
                "gender": formData.get('gender'),
                "age-range": formData.get('age-range'),
                "occupation": formData.get('occupation'),
                "income": formData.get('income'),
                "subgroups": formData.get('subgroups'),
                "painpoints": formData.get('painpoints'),
                "audience_goal": formData.get('audience_goal'),
                "product_service": formData.get('product_service'),
                "desired_action": formData.get('desired_action'),
                "post_objectives": formData.get('post_objectives'),
                "word_count": formData.get('word_count'),
                "tone": formData.get('tone'),
                "usp": formData.get('usp'),
                "pov": formData.get('pov'),
                "emojis": formData.get('emojis'),
                "hashtags": formData.get('hashtags')
            };

            try {
                const response = await fetch('https://panc0eazwj.execute-api.ap-southeast-1.amazonaws.com/content-generator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(contentData)
                });

                const data = await response.json();

                // Display the API response or error
                if (response.ok) {
                    generatedContentDiv.innerHTML = `<p>${data}</p>`;
                } else {
                    generatedContentDiv.innerHTML = `<p class="error">Error: ${data.error || response.statusText}</p>`;
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                generatedContentDiv.innerHTML = '<p class="error">An error occurred while fetching data.</p>';
            } finally {
                // Re-enable the button and reset text
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Content';
            }
        });


        function removeFaqItem(button) {
            const item = button.parentNode;
            item.remove();
            updateSchema(); // Update the schema after removing an item
        }

        let breadcrumbItemCount = 2; // Start with 2 items
        function addItem() {
            breadcrumbItemCount++;
            const breadcrumbItemsDiv = document.getElementById('breadcrumb-items');
            const newItem = document.createElement('div');
            newItem.className = "breadcrumb-item";
            newItem.innerHTML = `
            <input type="text" id="name${breadcrumbItemCount}" placeholder="Page #${breadcrumbItemCount}'s name" oninput="updateSchema()">
            <input type="url" id="url${breadcrumbItemCount}" placeholder="URL #${breadcrumbItemCount}" oninput="updateSchema()">
            <button class="remove-item" onclick="removeItem(this)">x</button>
        `;
            breadcrumbItemsDiv.appendChild(newItem);

            // Attach event listeners to new elements
            newItem.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updateSchema);
            });

            updateSchema();
        }

        function removeItem(button) {
            const item = button.parentNode;
            item.remove();
            updateSchema();
        }

        const schemaTypeSelect = document.getElementById('schema-type');
        const inputFieldsDiv = document.getElementById('input-fields');
        const schemaOutputDiv = document.getElementById('schema-output');

        const templates = {
            "LocalBusiness": Handlebars.compile(document.getElementById('local-business-template').innerHTML),
            "Product": Handlebars.compile(document.getElementById('product-template').innerHTML),
            "Event": Handlebars.compile(document.getElementById('event-template').innerHTML),
            "Article": Handlebars.compile(document.getElementById('article-template').innerHTML),
            "BreadcrumbList": Handlebars.compile(document.getElementById('breadcrumblist-template').innerHTML),
            "FAQPage": Handlebars.compile(document.getElementById('faqpage-template').innerHTML),
            "HowTo": Handlebars.compile(document.getElementById('howto-template').innerHTML),
            "JobPosting": Handlebars.compile(document.getElementById('jobposting-template').innerHTML),
            "Organization": Handlebars.compile(document.getElementById('organization-template').innerHTML),
            "Person": Handlebars.compile(document.getElementById('person-template').innerHTML),
            "VideoObject": Handlebars.compile(document.getElementById('video-object-template').innerHTML),
            "Website": Handlebars.compile(document.getElementById('website-template').innerHTML),
        }

        let faqItemCount = 1;

        schemaTypeSelect.addEventListener('change', () => {
            const selectedType = schemaTypeSelect.value;
            const template = templates[selectedType];

            if (template) {
                inputFieldsDiv.innerHTML = template();
                updateSchema(); // Initial update after template render
            } else {
                inputFieldsDiv.innerHTML = ''; // Clear if no template exists
                schemaOutputDiv.textContent = '';
            }


            // Add event listeners after rendering the template
            inputFieldsDiv.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updateSchema);
            });
        });

        // Initial setup (trigger the change event once to populate fields for default type)
        schemaTypeSelect.dispatchEvent(new Event('change'));

        function updateSchema() {
            const selectedType = schemaTypeSelect.value;
            const data = {};

            // Gather input values based on the selected schema type
            for (const input of inputFieldsDiv.querySelectorAll('input')) {
                data[input.id] = input.value;
            }

            try {

                const schema = {
                    "@context": "https://schema.org",
                    "@type": selectedType,
                    ...data // Spread the input data into the schema object
                };

                // Special handling for fields that require JSON-LD structures:
                if (selectedType === "FAQPage" && data.mainEntity) {
                    schema.mainEntity = JSON.parse(data.mainEntity);
                }
                if (selectedType === "BreadcrumbList" && data.itemListElement) {
                    schema.itemListElement = JSON.parse(data.itemListElement);
                }

                if (selectedType === "BreadcrumbList") {
                    const itemListElement = [];

                    for (let i = 1; i <= breadcrumbItemCount; i++) {
                        const name = document.getElementById(`name${i}`);
                        const url = document.getElementById(`url${i}`);

                        if (name && url && name.value && url.value) {
                            itemListElement.push({
                                "@type": "ListItem",
                                "position": i,
                                "name": name.value,
                                "item": url.value
                            });
                        }

                    }
                    if (itemListElement.length > 0) {
                        schema.itemListElement = itemListElement;
                    }

                }


                if (selectedType === "FAQPage") {
                    const mainEntity = [];


                    for (let i = 1; document.getElementById(`question${i}`); i++) {
                        const question = document.getElementById(`question${i}`).value;
                        const answer = document.getElementById(`answer${i}`).value;

                        if (question && answer) {  // Make sure both question and answer are filled
                            mainEntity.push({
                                "@type": "Question",
                                "name": question,
                                "acceptedAnswer": {
                                    "@type": "Answer",
                                    "text": answer
                                }
                            });
                        }

                    }

                    if (mainEntity.length > 0) { // Only add mainEntity if there are FAQ items
                        schema.mainEntity = mainEntity;
                    }

                }

                schemaOutputDiv.textContent = '<script type="application/ld+json">\n' + JSON.stringify(schema, null, 2) + '\n<\/script>';

            } catch (error) {
                schemaOutputDiv.textContent = "Invalid JSON-LD input in one of the fields.";
                console.error("JSON Parsing Error:", error);
            }
        }

        function similarKeywords() {
            const keywordsInput = document.getElementById('keywords').value.split(/[\n,]+/).map(k => k.trim());
            const location = document.getElementById('location').value;
            const language = document.getElementById('language').value;

            if (keywordsInput[0] == "") {
                document.getElementById('rankingError').textContent = 'Please enter keyword(s).';
                return;
            }
            if (!location) {
                document.getElementById('rankingError').textContent = 'Please select a location.';
                return;
            }

            document.getElementById("keyword_suggestions").style.backgroundColor = "#004c9d";
            document.getElementById('similar').innerText = "Generating...";

            var url = "https://lgvdhcs4t2.execute-api.ap-southeast-1.amazonaws.com/similarKeywords";
            var queryString = {
                "keywords": keywordsInput,
                "location": location,
                "language": language,
                "user": JSON.parse(localStorage.getItem('googleUser')).email
            };
            
            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json",
            };
            fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(queryString)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displaySimilarKeywords(data);
                    document.getElementById('similar').innerHTML = "Similar Keywords / SERPs<span>Click to generate similar keywords based on the up to 20 of the keyword(s) you provided. </span>";
                    document.getElementById("keyword_suggestions").style.backgroundColor = "green";
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                    document.getElementById('similar').innerText = "Similar Keywords / SERPs";
                    document.getElementById("keyword_suggestions").style.backgroundColor = "#004c9d";
                });
            const tooltip = event.target.querySelector('span');  // Get the tooltip span
            if (tooltip) { // Check if the span element exists
                // The tooltip will now position itself correctly due to the CSS changes
            }
        }

        function rankingKeywords() {
            var domain = document.getElementById('domain').value;
            var location = document.getElementById('location').value;

            document.getElementById('rankingError').textContent = '';
            document.getElementById("ranking_keywords").style.backgroundColor = "#004c9d";

            if (!domain) {
                document.getElementById('rankingError').textContent = 'Please enter a URL or domain.';
                return;
            }
            if (!location) {
                document.getElementById('rankingError').textContent = 'Please select a location.';
                return;
            }

            document.getElementById('ranking').innerText = "Generating...";

            var url = "https://0dqny7l5y9.execute-api.ap-southeast-1.amazonaws.com/rankingKeywords";

            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json",
            };

            var queryString = {
                "target": domain,
                "location": location,
                "user": JSON.parse(localStorage.getItem('googleUser')).email
            };

            fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(queryString)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    //console.log("Ranking Keywords:", data.body);
                    displayRankedKeywords(data.body);
                    document.getElementById('ranking').innerHTML = "Get Ranking Keywords<span>Click to get the keywords which the domain or URL is ranking for.</span>";
                    document.getElementById("ranking_keywords").style.backgroundColor = "green";
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                    document.getElementById('ranking').innerHTML = "Get Ranking Keywords<span>Click to get the keywords which the domain or URL is ranking for.</span>";
                    document.getElementById("ranking_keywords").style.backgroundColor = "#004c9d";
                });
                const tooltip = event.target.querySelector('span');  // Get the tooltip span
            if (tooltip) { // Check if the span element exists
                // The tooltip will now position itself correctly due to the CSS changes
            }
        }

        const modalCache = {};

        function openModal(keyword) {
            let modal = document.getElementById("keywordModal");
            if (!modal) {
                modal = document.createElement("div");
                modal.id = "keywordModal";
                modal.style.display = "none"; // Initially hidden
                modal.innerHTML = `<div class="modal-content"><span class="close" onclick="closeModal()">×</span><h2 id="modalKeyword"></h2><div id="modalContent"></div></div>`;
                document.body.appendChild(modal);
                /*
                    modal.addEventListener('click', (event) => {
                        if (event.target === modal) { // Check if click is on modal background
                            closeModal();
                        }
                    });
                */
            }
            // Set modal content (replace with your actual data fetching)
            document.getElementById("modalKeyword").textContent = keyword;

            if (modalCache[keyword]) {
                document.getElementById("modalContent").innerHTML = modalCache[keyword];
                modal.style.display = "block";
                return; // Exit early if data is in cache
            }

            document.getElementById("modalContent").innerHTML = "<p>Loading SERPs for " + keyword + "...</p>"; // Placeholder
            modal.style.display = "block";

            serpModal(keyword).then(data => {
                if (data.error) {
                    document.getElementById("modalContent").innerHTML = "<p class='error'>Error: " + data.error + "</p>";
                    return;
                }

                modalCache[keyword] = document.getElementById("modalContent").innerHTML;

                const urls = Object.values(data.body).map(result => result.url);
                const metricsPromises = urls.map(url => fetchMetrics(url));

                Promise.all(metricsPromises)
                    .then(metricsResults => {
                        addMetricsToTable(data, metricsResults);

                        // Cache the final table HTML
                        modalCache[keyword] = document.getElementById("modalContent").innerHTML;
                    })
                    .catch(error => {
                        console.error("Error fetching metrics:", error);
                        document.getElementById("modalContent").innerHTML += "<p class='error'>Error fetching some metrics.</p>";
                    });

            });

        }

        async function serpModal(keyword) {
            const language = document.getElementById('language').value;
            const location = document.getElementById('location').value;
            user = JSON.parse(localStorage.getItem('googleUser')).email
            try {
                const response = await fetch('https://8k6r15rg4m.execute-api.ap-southeast-1.amazonaws.com/serpLite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword, language, location, user }),
                });
                const serpData = await response.json();

                // Check for errors in SERP data
                if (serpData.error || serpData.statusCode !== 200) {
                    throw new Error("SERP API Error: " + (serpData.error || "Status code " + serpData.statusCode));
                }

                displayInitialTable(serpData);

                return serpData;


            } catch (error) {
                console.error("Error fetching data:", error);
                return { error: error.message }; // Return error message
            }
        }

        // Function to close the modal
        function closeModal() {
            const modal = document.getElementById("keywordModal");
            if (modal) {
                modal.style.display = "none";
            }
        }

        /* 

        async function fetchMetrics(domain) { // domain metrics including domain rank
            try {
                const response = await fetch('https://9px7sjbyyb.execute-api.ap-southeast-1.amazonaws.com/new', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain })
                });

                if (!response.ok) {
                    throw new Error(`Metrics API Error: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                return data.body; // Return the body directly
            } catch (error) {
                console.error("Error fetching metrics:", error);
                return { error: error.message }; // Return error object, better for handling
            }
        }

        */

        async function fetchMetrics(domain) { // for moz
            try {
                const response = await fetch('https://a7hptjtc8e.execute-api.ap-southeast-1.amazonaws.com/new', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain })
                });

                if (!response.ok) {
                    throw new Error(`Metrics API Error: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();

                return { "DA": data.body.results[0].domain_authority };

                return data.body; // Return the body directly
            } catch (error) {
                console.error("Error fetching metrics:", error);
                return { error: error.message }; // Return error object, better for handling
            }
        }

        function displayInitialTable(data) {
            let tableHtml = "<table><tr><th>Rank</th><th>URL</th><th>Title</th><th>Description</th></tr>";
            for (const rank in data.body) {
                const result = data.body[rank];
                tableHtml += `<tr><td>${rank}</td><td><a href="${result.url}" target="_blank">${result.url}</a></td><td>${result.title}</td><td>${result.description}</td></tr>`;
            }
            tableHtml += "</table>";
            document.getElementById("modalContent").innerHTML = tableHtml;
        }


        function addMetricsToTable(data, metricsResults) {
            const table = document.getElementById("modalContent").querySelector("table");

            // Add header cells for metrics
            const headerRow = table.rows[0];
            const firstResultMetrics = metricsResults[0] || {}; //Handle missing metrics
            if (!firstResultMetrics.error) {
                for (const metricKey in firstResultMetrics) {
                    if (metricKey !== 'visible_text' && metricKey !== 'word_count' && metricKey !== 'title' && metricKey !== 'description' && metricKey !== 'click_depth') {
                        const th = document.createElement("th");
                        th.textContent = metricKey.replace(/_/g, ' ').toUpperCase();
                        headerRow.appendChild(th);
                    }
                }
            }

            // Add metric data to rows
            for (let i = 0; i < metricsResults.length; i++) {
                const row = table.rows[i + 1]; // Skip header row
                const metrics = metricsResults[i] || {};
                if (!metrics.error) {
                    for (const metricKey in firstResultMetrics) {   //Use firstResultMetrics for keys order
                        if (metricKey !== 'visible_text' && metricKey !== 'word_count' && metricKey !== 'title' && metricKey !== 'description' && metricKey !== 'click_depth') {

                            if (metrics.hasOwnProperty(metricKey)) {
                                const cell = row.insertCell();
                                cell.textContent = metrics[metricKey];
                            } else {
                                row.insertCell(); // Add an empty cell if the metric is missing
                            }

                        }
                    }
                } else {
                    // Add empty cells for all metrics if there is an error
                    for (const metricKey in firstResultMetrics) {
                        if (metricKey !== 'visible_text' && metricKey !== 'word_count' && metricKey !== 'title' && metricKey !== 'description' && metricKey !== 'click_depth') {
                            row.insertCell();
                        }
                    }
                }
            }
        }


        function displayRankedKeywords(rankedKeywordsData) {
            const rankedKeywordList = document.getElementById('rankedKeywordList');
            rankedKeywordList.innerHTML = ''; // Clear previous keywords

            const headerCells = Array.from(document.querySelectorAll('#rankedKeywordHeaderRow .keyword-column'));

            // 1. Transform the data:
            const rankedKeywordsArray = Object.entries(rankedKeywordsData).map(([keyword, data]) => ({
                keyword: keyword,
                search_volume: data.search_volume,
                rank: data.rank,
                difficulty: data.difficulty
            }));

            rankedKeywordsArray.forEach((keywordObj, index) => {
                const listItem = document.createElement('li');
                listItem.classList.add('keyword-row');

                // Keyword column
                const keywordDiv = document.createElement('div');
                keywordDiv.classList.add('keyword-column');
                keywordDiv.style.width = `${headerCells[0].offsetWidth}px`;
                keywordDiv.textContent = keywordObj.keyword;
                listItem.appendChild(keywordDiv);

                // Search Volume column
                const searchVolumeDiv = document.createElement('div');
                searchVolumeDiv.classList.add('keyword-column');
                searchVolumeDiv.style.width = `${headerCells[1].offsetWidth}px`;
                searchVolumeDiv.textContent = keywordObj.search_volume != null ? keywordObj.search_volume.toLocaleString() : '-'; // Handle null search volume
                listItem.appendChild(searchVolumeDiv);

                // Rank
                const rankDiv = document.createElement('div');
                rankDiv.classList.add('keyword-column');
                rankDiv.style.width = `${headerCells[2].offsetWidth}px`;
                rankDiv.textContent = keywordObj.rank || '-';
                listItem.appendChild(rankDiv);

                // Difficulty column
                const difficultyDiv = document.createElement('div');
                difficultyDiv.classList.add('keyword-column');
                difficultyDiv.style.width = `${headerCells[3].offsetWidth}px`;
                difficultyDiv.textContent = keywordObj.difficulty || '-';
                listItem.appendChild(difficultyDiv);

                // Checkbox column
                const checkboxDiv = document.createElement('div');
                checkboxDiv.classList.add('checkbox-column');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = `chk${index + 1}`;
                checkbox.id = `chk${index + 1}`;
                checkbox.value = keywordObj.keyword;
                checkbox.checked = false;
                checkbox.addEventListener('change', updateKeywordsField);
                checkboxDiv.appendChild(checkbox);
                listItem.appendChild(checkboxDiv);

                rankedKeywordList.appendChild(listItem);
            });
            updateRankedKeywordsCount();
            rankedKeywordList.innerHTML += '<button type="button" id="get-more-keywords-button" onclick="getMoreRanked()">Get More Keywords</button>';
        }

        document.getElementById('rankedKeywordList').addEventListener('change', function (event) {
            if (event.target.type === 'checkbox') { // Only handle checkbox changes
                updateKeywordsField();
            }
        });


        const keywordTable = document.getElementById('keywordTable');
        const top100Table = document.getElementById('top100Table');

        async function getMoreRanked() {
            document.getElementById('rankedKeywordList').innerHTML = document.getElementById('rankedKeywordList').innerHTML.replace('<button type="button" id="get-more-keywords-button" onclick="getMoreRanked()">Get More Keywords</button>', '<button type="button" disabled id="get-more-keywords-button" onclick="getMoreRanked()">Getting Keywords</button>')
            const target = document.getElementById('domain').value;
            const language = document.getElementById('language').value;
            const location = document.getElementById('location').value;

            const apiUrl = 'https://ei6xj9x2rd.execute-api.ap-southeast-1.amazonaws.com/keywordsForSite';
            const requestBody = {
                location: location,
                language: language,
                target: target
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Clear existing table rows (except header)
                while (keywordTable.rows.length > 1) {
                    keywordTable.deleteRow(1);
                }

                // Clear top100Table rows (except header) before new data is added
                while (top100Table.rows.length > 1) {
                    top100Table.deleteRow(1);
                }

                document.getElementById("get-more-keywords-button").remove();

                const rankCheckerPromises = []; // Store promises for rank checking API calls

                for (const keyword in data) {
                    const row = keywordTable.insertRow();
                    const keywordCell = row.insertCell();
                    const volumeCell = row.insertCell();
                    const competitionCell = row.insertCell();
                    const rankCell = row.insertCell(); // New cell for rank

                    keywordCell.innerHTML = keyword;
                    volumeCell.innerHTML = data[keyword].search_volume;
                    competitionCell.innerHTML = data[keyword].competition || "N/A"; // Handle null competition

                    // Make rank checker API call and update rankCell when resolved
                    const rankCheckerApiUrl = 'https://v5bizygr4m.execute-api.ap-southeast-1.amazonaws.com/rankChecker';
                    const rankRequestBody = {
                        keyword: keyword,
                        language: language,
                        location: location,
                        target: target
                    };

                    const rankPromise = fetch(rankCheckerApiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(rankRequestBody)
                    }).then(res => {
                        if (!res.ok) {
                            throw new Error(`Rank checker HTTP error! status: ${res.status}`);
                        }
                        return res.json();
                    }).then(rankData => {

                        rankCell.innerHTML = rankData || 999; // Handle cases where rank is unavailable

                        const rank = parseInt(rankData); // Parse rankData to integer
                        if (rank >= 1 && rank <= 100) {
                            const top100Row = top100Table.insertRow();
                            const top100KeywordCell = top100Row.insertCell();
                            const top100VolumeCell = top100Row.insertCell();
                            const top100CompetitionCell = top100Row.insertCell();
                            const top100RankCell = top100Row.insertCell();

                            top100KeywordCell.innerHTML = keyword;
                            top100VolumeCell.innerHTML = data[keyword].search_volume;
                            top100CompetitionCell.innerHTML = data[keyword].competition || "N/A";
                            top100RankCell.innerHTML = rank;

                            const rankedKeywordList = document.getElementById('rankedKeywordList');
                            const headerCells = Array.from(document.querySelectorAll('#rankedKeywordHeaderRow .keyword-column'));
                            const currentKeywordCount = rankedKeywordList.querySelectorAll('li.keyword-row').length; //Correct length

                            // Append to rankedKeywordList (using a separate function for clarity)
                            appendRankedKeyword({ // Pass data as an object
                                keyword: keyword,
                                search_volume: data[keyword].search_volume,
                                rank: rank, // Use the parsed rank value
                                difficulty: data[keyword].competition || "N/A"
                            }, rankedKeywordList.children.length, headerCells, rankedKeywordList); // Use children.length to get correct index
                        }
                    }).catch(error => {
                        console.error('Error checking rank:', error);
                        rankCell.innerHTML = "Error"; // Indicate an error in the rank cell
                    });
                    rankCheckerPromises.push(rankPromise);
                }
                // Wait for all rank checking API calls to complete
                await Promise.all(rankCheckerPromises);


            } catch (error) {
                console.error('Error fetching keyword data:', error);
                // Display error message in the table or elsewhere on the page
                keywordTable.innerHTML = "<tr><td>Error fetching data.</td></tr>";

            }

        }

        function appendRankedKeyword(item, index, headerCells, rankedKeywordList) {
            const listItem = document.createElement('li');
            listItem.classList.add('keyword-row');

            // Column 0: Keyword
            const keywordDiv = document.createElement('div');
            keywordDiv.classList.add('keyword-column');
            keywordDiv.textContent = item.keyword;
            listItem.appendChild(keywordDiv);

            // Column 1: Search Volume
            const searchVolumeDiv = document.createElement('div');
            searchVolumeDiv.classList.add('keyword-column');
            searchVolumeDiv.textContent = item.search_volume || '-';
            listItem.appendChild(searchVolumeDiv);

            // Column 2: Rank
            const rankDiv = document.createElement('div');
            rankDiv.classList.add('keyword-column');
            rankDiv.textContent = item.rank || '-';
            listItem.appendChild(rankDiv);

            // Column 3: Difficulty
            const difficultyDiv = document.createElement('div');
            difficultyDiv.classList.add('keyword-column');
            difficultyDiv.textContent = item.difficulty || '-';
            listItem.appendChild(difficultyDiv);

            // Column 4: Checkbox
            const checkboxDiv = document.createElement('div');
            checkboxDiv.classList.add('checkbox-column');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = item.keyword;
            checkbox.addEventListener('change', updateKeywordsField);
            checkboxDiv.appendChild(checkbox);
            listItem.appendChild(checkboxDiv);

            rankedKeywordList.appendChild(listItem);
            updateRankedKeywordsCount();

            document.getElementById('rankedKeywordList').innerHTML = document.getElementById('rankedKeywordList').innerHTML.replace('<button type="button" disabled id="get-more-keywords-button" onclick="getMoreRanked()">Getting Keywords</button>', '');
        }

        function displaySimilarKeywords(keywordsData) {
            const keywordList = document.getElementById('keywordList');
            keywordList.innerHTML = ''; // Clear previous keywords

            const headerCells = Array.from(document.querySelectorAll('#keywordHeaderRow .keyword-column'));

            // 1. Transform the data:
            const keywordsArray = Object.entries(keywordsData.body).map(([keyword, data]) => ({
                keyword,
                search_volume: data.search_volume,
                competition: data.competition,
                cpc: data.cpc
            }));

            keywordsArray.forEach((keywordObj, index) => {
                const listItem = document.createElement('li');
                listItem.classList.add('keyword-row');

                // Keyword column
                const keywordDiv = document.createElement('div');
                keywordDiv.classList.add('keyword-column');
                keywordDiv.style.width = `${headerCells[0].offsetWidth}px`;
                keywordDiv.textContent = keywordObj.keyword;
                keywordDiv.addEventListener('click', () => openModal(keywordObj.keyword));
                listItem.appendChild(keywordDiv);

                // Search Volume column
                const searchVolumeDiv = document.createElement('div');
                searchVolumeDiv.classList.add('keyword-column');
                searchVolumeDiv.style.width = `${headerCells[1].offsetWidth}px`;
                searchVolumeDiv.textContent = keywordObj.search_volume != null ? keywordObj.search_volume.toLocaleString() : '-'; // Handle null search volume
                listItem.appendChild(searchVolumeDiv);

                // Difficulty column
                const difficultyDiv = document.createElement('div');
                difficultyDiv.classList.add('keyword-column');
                difficultyDiv.style.width = `${headerCells[2].offsetWidth}px`;
                difficultyDiv.textContent = keywordObj.competition || '-';
                listItem.appendChild(difficultyDiv);

                // CPC column
                const cpcDiv = document.createElement('div');
                cpcDiv.classList.add('keyword-column');
                cpcDiv.style.width = `${headerCells[3].offsetWidth}px`;
                cpcDiv.textContent = keywordObj.cpc || '-';
                listItem.appendChild(cpcDiv);

                // Checkbox column
                const checkboxDiv = document.createElement('div');
                checkboxDiv.classList.add('checkbox-column');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = `chk${index + 1}`;
                checkbox.id = `chk${index + 1}`;
                checkbox.value = keywordObj.keyword;
                checkbox.checked = false;
                checkbox.addEventListener('change', updateKeywordsField);
                checkboxDiv.appendChild(checkbox);
                listItem.appendChild(checkboxDiv);

                keywordList.appendChild(listItem);
            });
        }

        function updateRankedKeywordsCount() {
            const rankedKeywordList = document.getElementById('rankedKeywordList');
            const count = rankedKeywordList.querySelectorAll('li.keyword-row').length; // Count only the keyword rows (li elements)
            const heading = document.getElementById('rankedKeywordsCount');
            heading.textContent = `Ranked Keywords (${count}):`; // Update the heading text
        }

        function updateKeywordCount() {
            const keywordsTextArea = document.getElementById('keywords');
            const keywords = keywordsTextArea.value.split(/[\n,]+/).map(k => k.trim()).filter(Boolean); // Split by comma or newline, trim whitespace, remove empty strings
            const keywordCountSpan = document.getElementById('keywordCount');
            keywordCountSpan.textContent = `${keywords.length} keyword(s) selected`;
        }

        function updateKeywordsField() {
            const keywordsTextArea = document.getElementById('keywords');
            const checkedKeywords = new Set(); // Use a Set to store unique values

            // Get checked keywords from both tables
            try {
                const rankedKeywordsCheckboxes = document.querySelectorAll('#rankedKeywordList input[type="checkbox"]:checked');
                rankedKeywordsCheckboxes.forEach(checkbox => checkedKeywords.add(checkbox.value));
            } catch (error) {
                console.log(error);
            }

            try {
                const similarKeywordsCheckboxes = document.querySelectorAll('#keywordList input[type="checkbox"]:checked');
                similarKeywordsCheckboxes.forEach(checkbox => checkedKeywords.add(checkbox.value));
            } catch (error) {
                console.log(error);
            }

            keywordsTextArea.value = Array.from(checkedKeywords).join(', '); // Convert Set back to array before joining
            updateKeywordCount();
        }

        function validateAndSubmit() {
            const domain = document.getElementById('domain').value;
            const keywordsInput = document.getElementById('keywords').value;
            const location = document.getElementById('location').value;

            document.getElementById('domainError').textContent = '';
            document.getElementById('keywordsError').textContent = '';
            /*
            if (!domain) {
                document.getElementById('domainError').textContent = 'Please enter a valid URL.';
                return;
            }
                */
            if (!keywordsInput) {
                document.getElementById('keywordsError').textContent = 'Please enter one or more keywords.';
                return;
            }
            if (!location) {
                alert("Please select a location.");
                return;
            }

            const keywords = keywordsInput.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);

            document.getElementById('targetTitle').innerText = "";
            document.getElementById('targetDescription').innerText = "";
            document.getElementById('targetDomainRank').innerText = "";
            document.getElementById('targetBacklinks').innerText = "";
            document.getElementById('targetSpamScore').innerText = "";
            document.getElementById('targetPagespeed').innerText = '-/100';
            document.getElementById('targetRefDomains').innerText = "";
            document.getElementById('targetInternalLinks').innerText = "";
            document.getElementById('targetExternalLinks').innerText = "";
            document.getElementById('targetH1').innerText = "";
            document.getElementById('targetImages').innerText = "";
            document.getElementById('targetCls').innerText = "";
            document.getElementById('targetLcp').innerText = "";
            document.getElementById('targetFid').innerText = "";
            document.getElementById('targetSchema').innerText = "";
            document.getElementById('targetReadability').innerText = "";
            document.getElementById('targetWordCount').innerText = "";
            document.getElementById('da').innerText = "";
            document.getElementById('pa').innerText = "";

            document.getElementById("meta_data").style.backgroundColor = "#004c9d";
            document.getElementById("domain_metrics").style.backgroundColor = "#004c9d";
            document.getElementById("keywordAnalysis").style.backgroundColor = "#004c9d";

            fetchDomainMetrics(domain);
            keywordAnalysis();
        }

        async function keywordAnalysis() {
            document.getElementById("keyword-research-analysis-button").innerHTML = "Analysing...";
            try{
                const domain = document.getElementById("domain").value;
            } catch (error) {
                domain = "";
            }
            const keywords = document.getElementById("keywords").value.split(/[\n,]+/).map(s => s.trim()).filter(s => s !== "");
            const location = document.getElementById("location").value;
            const language = document.getElementById("language").value;
            user = JSON.parse(localStorage.getItem('googleUser')).email

            const keywordAnalysisResults = document.getElementById("keywordAnalysisResults");
            keywordAnalysisResults.innerHTML = ""; // Clear previous results


            const keywordMetrics = await Promise.all(keywords.map(keyword =>
                fetch('https://785lzorod8.execute-api.ap-southeast-1.amazonaws.com/kwMetrics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword, location, language, target_url: domain })
                }).then(res => res.json())
            ));


            let keywordTableHtml = "<table><tr><th>No.</th><th>Keyword</th><th>Search Volume</th><th>KW Difficulty</th><th>Current Rank</th><th>Time To Rank</th><th>Comments</th></tr>";
            keywordMetrics.forEach((data, index) => {
                try {
                    keywordTableHtml += `<tr onclick="showSERPs(${index})"><td>${index + 1}</td><td id="keyword-${index}" class="keyword-cell" onmouseover="" style="cursor: pointer;">${data.body.keyword}       <div class="loading-spinner" id="spinner-${index}"></div></td><td>${data.body.search_volume}</td><td>${data.body.competition}</td><td>${data.body.rank}</td><td><div class="loading-spinner" id="kw-${index}-time-to-rank"></div></td><td><div class="loading-spinner" id="kw-${index}-time-to-rank-reason"></div></td></tr>`; // Spinner for Time to Rank and keyword
                } catch (error) {
                    document.getElementById('rankingError').textContent += '\n' + error;
                }
            });
            keywordTableHtml += "</table>";
            keywordAnalysisResults.innerHTML = keywordTableHtml;
            document.getElementById("downloadKeywordAnalysisCSVButton").style.display = "block";
            document.getElementById("keywordAnalysis").style.backgroundColor = "green";

            const serpData = {};
            const pageMetrics = {};

            await Promise.all(keywords.map(async (keyword, index) => {
                const serpResponse = await fetch('https://u22k9g2y8c.execute-api.ap-southeast-1.amazonaws.com/new', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ location, keyword, language, user })
                }).then(res => res.json());
                serpData[index] = serpResponse.body;

                await Promise.all(Object.values(serpResponse.body).map(async result => {
                    const metricsResponse = await fetch('https://5zdbpwaia5.execute-api.ap-southeast-1.amazonaws.com/pageDomainMetrics', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: result.url, keyword, user })
                    }).then(res => res.json());
                    pageMetrics[result.url] = metricsResponse.body; // Store by URL
                    //console.log(metricsResponse);
                }));

                await createSERPTable(index, serpData[index], pageMetrics, keyword); // create and initially hide the tables
                await waitForSpinnersToRemove(index);

                await getTimeTakenToRank(index, keyword);

                const spinner = document.getElementById(`spinner-${index}`);
                spinner.remove(); // Remove spinner element completely
            }));
        }

        async function getTimeTakenToRank(index, keyword) {
            const domain = document.getElementById("domain").value;
            const location = document.getElementById("location").value;
            const language = document.getElementById("language").value;
            const serpTable = document.getElementById(`serp-table-${index}`);
            try {
                const res = await fetch('https://6qyc0fatt2.execute-api.ap-southeast-1.amazonaws.com/timeTakenToRank', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: serpTable.innerHTML, url: domain, keyword: keyword, location: location, language: language })
                });

                const timeTakenToRankData = await res.json();

                // Update the correct row in the first table (keywordMetrics table)
                document.getElementById(`kw-${index}-time-to-rank`).classList.remove('loading-spinner');
                document.getElementById(`kw-${index}-time-to-rank`).innerHTML = timeTakenToRankData.body.choice.replaceAll('"', '').replace('choice: ', '').replace('{', '');

                document.getElementById(`kw-${index}-time-to-rank-reason`).classList.remove('loading-spinner');
                document.getElementById(`kw-${index}-time-to-rank-reason`).innerHTML = timeTakenToRankData.body.reason.replaceAll('"', '').replace('reason: ', '').replace('}', '');

            } catch (error) {
                console.error(`Error getting Time To Rank for ${keyword}:`, error);
                // Handle the error appropriately (e.g., display an error message in the table)
                document.getElementById(`kw-${index}-time-to-rank`).classList.remove('loading-spinner');
                document.getElementById(`kw-${index}-time-to-rank`).innerHTML = "Error"; // Or some error message

                document.getElementById(`kw-${index}-time-to-rank-reason`).classList.remove('loading-spinner');
                document.getElementById(`kw-${index}-time-to-rank-reason`).innerHTML = "Error"; // Or some error message

            }
        }

        function createSERPTable(index, serpResults, pageMetrics, keyword) {
            let serpTableHtml = `<br><table class="hidden-table" id="serp-table-${index}">`;
            serpTableHtml += `<tr><th>Rank</th><th>URL</th><th>Title</th><th>Description</th><th>Domain Rank</th><th>Backlinks</th><th>Spam Score</th><th>Referring Domains</th><th>KW in URL</th><th>KW in Title</th><th>KW in Desc</th><th>KW in H1</th><th>KW in H2</th><th>KW in Alt</th><th>KW in Text</th><th>Word Count</th></tr>`;

            rowsPopulated = 0;

            if (typeof serpResults === 'object' && serpResults !== null && serpResults !== undefined) {
                const ranks = Object.keys(serpResults); // Get the keys (ranks) as an array

                ranks.forEach(rank => {
                    const result = serpResults[rank];
                    const metrics = pageMetrics[result.url] || {};
                    const evalMetrics = metrics.eval || {};

                    serpTableHtml += `<tr><td>${parseInt(rank)}</td><td>${result.url}</td><td>${result.title}</td><td>${result.description}</td>
                         <td><div class="loading-spinner"></div></td><td><div class="loading-spinner"></div></td><td><div class="loading-spinner"></div></td>
                          <td><div class="loading-spinner"></div></td><td><div class="loading-spinner"></div></td><td><div class="loading-spinner"></div></td>
                          <td><div class="loading-spinner"></div></td><td><div class="loading-spinner"></div></td><td><div class="loading-spinner"></div></td>
                          <td><div class="loading-spinner"></div></td><td><div class="loading-spinner"></div></td><td><div class="loading-spinner"></div></td></tr>`;

                    setTimeout(() => { // Use setTimeout to ensure elements are created
                        const domainRankCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(5)`);
                        domainRankCell.innerHTML = metrics.domain_rank || '-';

                        const backlinksCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(6)`);
                        backlinksCell.innerHTML = metrics.backlinks || '-';

                        const spamCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(7)`);
                        spamCell.innerHTML = metrics.backlinks_spam_score || '-';

                        const referringhDomainsCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(8)`);
                        referringhDomainsCell.innerHTML = metrics.referring_domains || '-';

                        // ... similarly update other cells (spam score, referring domains, etc.) ...
                        const kwInUrlCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(9)`);
                        kwInUrlCell.innerHTML = evalMetrics.kw_in_url || '-';

                        const kwInTitleCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(10)`);
                        kwInTitleCell.innerHTML = evalMetrics.kw_in_title || '-';

                        const kwInDescCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(11)`);
                        kwInDescCell.innerHTML = evalMetrics.kw_in_desc || '-';

                        const kwInH1Cell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(12)`);
                        kwInH1Cell.innerHTML = evalMetrics.kw_in_h1 || '-';

                        const kwInH2Cell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(13)`);
                        kwInH2Cell.innerHTML = evalMetrics.kw_in_h2 || '-';

                        const kwInAltCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(14)`);
                        kwInAltCell.innerHTML = evalMetrics.kw_in_alt || '-';

                        const kwInTextCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(15)`);
                        kwInTextCell.innerHTML = evalMetrics.kw_in_text || '-';

                        const wordCountCell = document.querySelector(`#serp-table-${index} tr:nth-child(${parseInt(rank) + 1}) td:nth-child(16)`);
                        wordCountCell.innerHTML = metrics.word_count || '-';

                        rowsPopulated++; // increment after all cells in the row are updated.
                    }, 60000); // Adjust timeout if needed
                });
            } else {
                console.error("serpResults is not a valid object or is null:", serpResults);
                // Display an error message or take other appropriate action.
                serpTableHtml += `<tr><td colspan="16">Error: Could not retrieve SERP data.</td></tr>`; // Display a message in the table
            }

            serpTableHtml += "</table>";
            document.getElementById("keywordAnalysisResults").innerHTML += serpTableHtml;
            document.getElementById("keyword-research-analysis-button").innerHTML = "Analyse<span>Click to get the estimated time to rank for the selected keywords and the webpage's metrics.</span>";

            return new Promise(resolve => {
                const intervalId = setInterval(() => {
                    //console.log(`Checking for spinners in table ${index}, rows populated: ${rowsPopulated}/${Object.keys(serpResults).length}, spinners: ${document.querySelectorAll(`#serp-table-${index} .loading-spinner`).length}`);
                    if (rowsPopulated === Object.keys(serpResults).length && document.querySelectorAll(`#serp-table-${index} .loading-spinner`).length === 0) {
                        console.log(`Resolving promise for table ${index}`);
                        clearInterval(intervalId);
                        resolve();
                    }
                }, 100);
            });
        }

        // New function to wait for spinners to be removed
        async function waitForSpinnersToRemove(index) {
            return new Promise(resolve => {
                const intervalId = setInterval(() => {
                    if (document.querySelectorAll(`#serp-table-${index} .loading-spinner`).length === 0) {
                        clearInterval(intervalId);
                        resolve();
                    }
                }, 2000); // Check every 2s
            });
        }

        function showSERPs(index) {
            const serpTable = document.getElementById(`serp-table-${index}`);
            serpTable.style.display = (serpTable.style.display === "none" || serpTable.style.display === "") ? "table" : "none";

            // Hide other SERP tables:
            const allSERPTables = document.querySelectorAll('.hidden-table');
            allSERPTables.forEach(table => {
                if (table.id !== `serp-table-${index}`) {
                    table.style.display = "none";
                }
            });
        }

        function fetchDomainMetrics(domain) {
            document.getElementById('keyword-research-analysis-button').innerText = "Analysing...";

            //moz 
            var url = "https://a7hptjtc8e.execute-api.ap-southeast-1.amazonaws.com/new";
            var queryString = {
                "domain": domain
            };
            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json"
            };
            fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(queryString)
            })
                .then(response => {
                    // Check if the response is successful
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('da').innerText = data.body.results[0].domain_authority;
                    document.getElementById('pa').innerText = data.body.results[0].page_authority;
                })
                .catch(error => {
                    console.error("Error fetching data:", error); // Log any errors
                    // Handle the error gracefully, perhaps display an error message to the user
                });

            api_url = "https://9px7sjbyyb.execute-api.ap-southeast-1.amazonaws.com/new";
            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json"
            };
            fetch(api_url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ url: domain })
            }).then(response => {
                // Check if the response is successful
                if (!response.ok) {
                    throw new Error(`Error obtaining domain metrics Status: ${response.status}`);
                }
                return response.json();
            })
                .then(data => {
                    document.getElementById('targetTitle').innerText = data.body.title;
                    document.getElementById('targetDescription').innerText = data.body.description;
                    document.getElementById('targetDomainRank').innerText = data.body.domain_rank;
                    document.getElementById('targetBacklinks').innerText = data.body.backlinks;
                    document.getElementById('targetSpamScore').innerText = data.body.backlinks_spam_score;
                    document.getElementById('targetPagespeed').innerText = '-/100';
                    document.getElementById('targetRefDomains').innerText = data.body.referring_domains;
                    document.getElementById('targetInternalLinks').innerText = data.body.internal_links_count;
                    document.getElementById('targetExternalLinks').innerText = data.body.external_links_count;
                    document.getElementById('targetH1').innerText = data.body.h1;
                    document.getElementById('targetImages').innerText = data.body.image;
                    document.getElementById('targetCls').innerText = data.body.cls;
                    document.getElementById('targetLcp').innerText = data.body.lcp;
                    document.getElementById('targetFid').innerText = data.body.fid;
                    document.getElementById('targetSchema').innerText = data.body.schema;
                    document.getElementById('targetReadability').innerText = data.body.readability;
                    document.getElementById('targetWordCount').innerText = data.body.word_count;

                    document.getElementById("meta_data").style.backgroundColor = "green";
                    document.getElementById("domain_metrics").style.backgroundColor = "green";
                })
                .catch(error => {
                    console.error("Error fetching targeted domain data:", error); // Log any errors
                    // Handle the error gracefully, perhaps display an error message to the user
                });
        }

        async function fetchSerpResults(keyword, location, domain) {
            user = JSON.parse(localStorage.getItem('googleUser')).email
            const apiEndpoint = "https://u22k9g2y8c.execute-api.ap-southeast-1.amazonaws.com/new";
            const requestBody = {
                location: location,
                keyword: keyword,
                targeted_url: domain,
                language: document.getElementById("location").value,
                user: user
            };

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                console.log(data);
                return data;
            } catch (error) {
                console.error('Error fetching SERP data:', error);
                return null;
            }
        }

        async function fetchContentAnalysisData(url) {
            const apiEndpoint = "https://v21e9kd3h1.execute-api.ap-southeast-1.amazonaws.com/timetoRank3";
            const requestBody = { url: url };

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching content analysis data:', error);
                return null;
            }
        }

        async function fetchOnPageAnalysisData(url) {
            const apiEndpoint = "https://tpl2mrhmc0.execute-api.ap-southeast-1.amazonaws.com/new";
            const requestBody = { url: url };

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching on-page analysis data:', error);
                return null;
            }
        }

        // --- Helper functions to show and hide the loading indicator ---
        function showLoadingIndicator(parent) {
            const loadingIndicator = document.getElementById("loadingIndicator");
            parent.parentNode.insertBefore(loadingIndicator, parent); // Insert before the table
            parent.classList.add("loading");
            loadingIndicator.style.display = "block";
        }

        function hideLoadingIndicator(parent) {
            const loadingIndicator = document.getElementById("loadingIndicator");
            loadingIndicator.style.display = "none";
            parent.classList.remove("loading");
        }

        function removeRow(button) {
            let row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
        }

        document.addEventListener('DOMContentLoaded', function () {
            const coll = document.getElementsByClassName("collapsible");
            for (let i = 0; i < coll.length; i++) {
                coll[i].addEventListener("click", function () {
                    this.classList.toggle("active");
                    const content = this.nextElementSibling;
                    content.style.display = content.style.display === "block" ? "none" : "block";
                });
            }
        });

        function sortTable(column) {
            const table = document.getElementById("keywordResults");
            const rows = Array.from(table.rows);
            const dir = this.asc ? 'asc' : 'desc';

            rows.sort((a, b) => {
                // **Convert cell content to numbers before comparison:**
                const ax = parseFloat(a.cells[column].textContent) || 0; // Use parseFloat for numbers, 0 for non-numeric
                const bx = parseFloat(b.cells[column].textContent) || 0;

                return (ax > bx) ? (dir === 'asc' ? 1 : -1) : (ax < bx ? (dir === 'asc' ? -1 : 1) : 0);
            });

            rows.forEach(row => table.appendChild(row));
            this.asc = !this.asc;
        }

        function downloadSemCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";

            const generatedDiv = document.getElementById('generated');
            const tablesAndHeadings = Array.from(generatedDiv.querySelectorAll('h3, table')); // Select both h3 and table

            tablesAndHeadings.forEach((element, index) => {
                if (element.tagName === 'H3') {  // Check if it's a heading
                    const headingText = element.textContent.trim().replace(/_/g, ' ').toUpperCase(); //Add same formatting
                    const nextElement = tablesAndHeadings[index + 1]; // Check if next element exists

                    if (nextElement && nextElement.tagName === 'TABLE') {
                        const rows = Array.from(nextElement.querySelectorAll("tr"));

                        rows.forEach(row => {
                            const cells = Array.from(row.querySelectorAll("th, td"));

                            if (cells.length >= 2) { //Check if remove cell exists
                                cells.splice(1, 1); //Remove remove cell
                            }
                            //Replace 'Value' with headingText
                            if (cells.length > 0 && cells[0].textContent.trim() === 'Value') {
                                cells[0].textContent = headingText;
                            }

                            const rowText = cells.map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`).join(",");
                            csvContent += rowText + "\n";

                        });

                        csvContent += "\n"; // Add an empty row after each table's data
                    }


                }
            });


            // Create a hidden link element and trigger a click to download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "generated_sem.csv");
            document.body.appendChild(link); // Required for Firefox
            link.click(); // This will download the data file
            document.body.removeChild(link); // Cleanup 
        }

        function downloadKeywordAnalysisTableAsCSV() {
            const table = document.getElementById("keywordAnalysisResults").querySelector('table');
            if (!table) {
                console.error("Table not found!");  // Handle the case where the table doesn't exist
                return;
            }

            const rows = Array.from(table.querySelectorAll("tr"));

            let csvContent = "";  // Start with an empty string (no BOM)
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll("th, td"));
                csvContent += cells.map(cell => {
                    let cellText = cell.textContent.trim();
                    if (!cellText && cell.innerHTML) {
                        cellText = cell.innerHTML.replace(/<[^>]*>/g, "").trim();
                    }
                    return `"${cellText.replace(/"/g, '""')}"`
                }).join(",") + "\n";
            });


            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { // feature detection
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "keyword_analysis.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);  // Clean up
            } else {
                // IE10+ Fallback - opens the data URI in a new window
                window.open('data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));
            }
        }

        // Attach the download function to the button
        document.getElementById("downloadKeywordAnalysisCSVButton").addEventListener("click", downloadKeywordAnalysisTableAsCSV);

        let currentKeywordSortColumn = null;
        let keywordSortAscending = true;

        let currentRankedKeywordSortColumn = null;
        let rankedKeywordSortAscending = true;

        function sortKeywordSuggestions(column) {
            const keywordList = document.getElementById('keywordList');
            const listItems = Array.from(keywordList.children);

            if (column === currentKeywordSortColumn) {
                keywordSortAscending = !keywordSortAscending;
            } else {
                keywordSortAscending = true;
                currentKeywordSortColumn = column;
            }

            listItems.sort((a, b) => {
                const aValue = a.children[column].textContent;
                const bValue = b.children[column].textContent;

                // Convert to number for sorting if possible
                const aNum = parseFloat(aValue.replace(/,/g, ''));
                const bNum = parseFloat(bValue.replace(/,/g, ''));

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return keywordSortAscending ? aNum - bNum : bNum - aNum;
                } else {
                    return keywordSortAscending
                        ? aValue.localeCompare(bValue)
                        : bValue.localeCompare(aValue);
                }
            });

            listItems.forEach(item => keywordList.appendChild(item));
        }


        function sortRankedKeywords(column) {
            const keywordList = document.getElementById('rankedKeywordList');
            const listItems = Array.from(keywordList.children);

            // Toggle sort direction if same column is clicked
            if (column === currentRankedKeywordSortColumn) {
                rankedKeywordSortAscending = !rankedKeywordSortAscending;
            } else {
                rankedKeywordSortAscending = true;
                currentRankedKeywordSortColumn = column;
            }

            listItems.sort((a, b) => {
                try {
                    const aValue = a.children[column].textContent.trim();
                    const bValue = b.children[column].textContent.trim();

                    const aNum = parseFloat(aValue.replace(/,/g, ''));
                    const bNum = parseFloat(bValue.replace(/,/g, ''));

                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return rankedKeywordSortAscending ? aNum - bNum : bNum - aNum;
                    } else {
                        return rankedKeywordSortAscending
                            ? aValue.localeCompare(bValue)
                            : bValue.localeCompare(aValue);
                    }
                } catch (error) {
                }
            });

            listItems.forEach(item => keywordList.appendChild(item));
        }

        selectedItems = {};
        generatedData = {};

        async function semWebpageProducts() {
            const getProducts = document.getElementById("getProducts");
            if (!document.getElementById('sem_webpages').value && !document.getElementById('sem_additional').value) {
                alert("Please enter webpage URLs or additional information.");
                return;
            } else {
                getProducts.innerText = "Analysing...";
                if (document.getElementById("semProductFocus").checked) {
                    productFocus = true;
                } else {
                    productFocus = false;
                }
                if (document.getElementById("semBrandFocus").checked) {
                    brandFocus = true;
                } else {
                    brandFocus = false;
                }

                urls = document.getElementById("sem_webpages").value.split(/[\s,]+/).filter(url => url.trim() !== "");

                try {
                    const response = await fetch("https://13kntbziug.execute-api.ap-southeast-1.amazonaws.com/webpageProducts", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            pages: urls,
                            brand: brandFocus,
                            product: productFocus,
                            language: document.getElementById("sem_language").value,
                            additional: document.getElementById("sem_additional").value,
                        })
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const responseData = await response.json();
                    const body = JSON.parse(responseData.body);

                    formattedString = "";

                    if (body['product/service'].length > 0) {
                        formattedString += "Product/Service: ";
                        if (Object.prototype.toString.call(body['product/service']) === '[object Array]') {
                            for (value in body['product/service']) {
                                formattedString += body['product/service'][value] + ", ";
                            }
                            formattedString = formattedString.slice(0, -2)
                        } else {
                            formattedString += body['product/service']
                        }
                    }

                    if (formattedString != "") {
                        formattedString += "\n\n";
                    }

                    if (body['brand/company'].length > 0) {
                        formattedString += "Brand/Company: ";
                        if (Object.prototype.toString.call(body['brand/company']) === '[object Array]') {
                            for (value in body['brand/company']) {
                                formattedString += body['brand/company'][value] + ", ";
                            }
                            formattedString = formattedString.slice(0, -2)
                        } else {
                            formattedString += body['brand/company']
                        }
                    }

                    document.getElementById("products").innerHTML = '<label for="identifiedProducts">Identfied Products/Services/Brand/Company:</label><br><textarea rows="6" id="identifiedProducts">' + formattedString + '</textarea>';
                    getProducts.innerText = "Step 1: Identify products/services/brand/company";
                } catch (error) {
                    console.error("Error:", error);
                    document.getElementById("output").innerText = "An error occurred with semWebpageProducts. Please check the console for details.";
                    getProducts.innerText = "Step 1: Identify products/services/brand/company";
                }
            }
        }

        async function semAnalyseWebsite() {
            const semButton = document.getElementById("semAnalyse");
            semButton.innerText = "Analysing...";
            try {
                const response = await fetch("https://sk7akfiy89.execute-api.ap-southeast-1.amazonaws.com/semWebsiteAnalyser", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        country: document.getElementById("sem_country").value,
                        additional: document.getElementById("sem_additional").value,
                        products: document.getElementById("identifiedProducts").value,
                        language: document.getElementById("sem_language").value,
                    })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const responseData = await response.json();
                const body = responseData.body;
                selectedItems = {}; // Clear selections
                document.getElementById('selected').style.display = 'block';
                document.getElementById("selectedText").value = ""; // Clear textarea
                document.getElementById("output").innerHTML = createSemTables(body);

                firstTable = document.getElementById("output").querySelector("table");
                const rows = Array.from(firstTable.querySelectorAll("tr"));
                const rowData = [];

                rows.forEach(row => {
                    const cells = Array.from(row.querySelectorAll("td"));
                    cells.shift(); // Remove the first cell
                    cells.forEach(cell => {
                        rowData.push(cell.textContent.trim()); // Push each cell's text
                    });
                });

                console.log(rowData); // Now this will work correctly!
                semButton.innerText = "Step 2: Generate KWs, USPs & Audience";
            } catch (error) {
                console.error("Error:", error);
                document.getElementById("output").innerText = "An error occurred with semWebsiteAnalyser. Please check the console for details.";
                semButton.innerText = "Step 2: Generate KWs, USPs & Audience";
            }
        }

        function createSemTables(data) {
            let tablesHTML = "";
            const categories = ["short_keywords", "long_keywords", "usp", "target_audience_name"];
            const titles = ["Short-tail Keywords", "Long-tail Keywords", "USPs", "Target Audience"];
            for (let i = 0; i < categories.length; i++) {
                const category = categories[i];
                const title = titles[i];
                const items = data[category];
                let tableHTML = `<h2>${title}</h2><table><tr><th>Select</th><th>Value</th></tr>`;
                for (const item of items) {
                    const value = typeof item === 'object' ? Object.values(item)[0] : item;
                    tableHTML += `<tr><td><input type="checkbox" onchange="updateSemSelected('${value}', '${title}')"></td><td>${value}</td></tr>`;
                }
                tableHTML += '</table>';
                tablesHTML += tableHTML;
            }
            return tablesHTML;
        }
        function updateSemSelected(value, category) {
            if (!selectedItems[category]) {
                selectedItems[category] = [];
            }
            const index = selectedItems[category].indexOf(value);
            if (index > -1) {
                selectedItems[category].splice(index, 1);
            } else {
                selectedItems[category].push(value);
            }
            displaySemSelectedItems();
        }
        function displaySemSelectedItems() {
            let selectedText = "";
            for (const category in selectedItems) {
                if (selectedItems[category].length > 0) {
                    selectedText += `${category}\n`;
                    selectedItems[category].forEach(item => {
                        selectedText += `${item}\n`;
                    });
                    selectedText += "\n"; // Add extra newline between categories
                }
            }
            document.getElementById("selectedText").value = selectedText;  // Update textarea value
        }
        async function generateGoogle() {
            document.getElementById("generateSem").innerText = "Generating...";
            try {
                const response = await fetch("https://bztsly2z89.execute-api.ap-southeast-1.amazonaws.com/generateSemGoogle", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        country: document.getElementById("sem_country").value,
                        input: document.getElementById("selectedText").value,
                        tone: document.getElementById("sem_tone").value,
                        language: document.getElementById("sem_language").value,
                        type: document.getElementById("ad_format").value
                    })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const responseData = await response.json();
                const body = responseData.body;
                for (const key in body) {
                    if (!generatedData[key]) {
                        generatedData[key] = [];
                    }
                    generatedData[key] = generatedData[key].concat(body[key]); // Concatenate new data
                }
                displaySemGeneratedData(); // Call function to update HTML
                document.getElementById("generateSem").innerText = "Step 3: Select checkboxes then click here";
            } catch (error) {
                console.error("Error:", error);
                document.getElementById("generated").innerText = "An error occurred. Please check the console for details.";
                document.getElementById("generateSem").innerText = "Step 3: Select checkboxes then click here";
            }
        }
        function displaySemGeneratedData() {
            let generatedHTML = "";
            for (const category in generatedData) {
                if (generatedData[category].length > 0) {
                    if (category == "sitelinks") {
                        generatedHTML += `<h3>${category.replace(/_/g, ' ').toUpperCase()}</h3>`; // Nicer titles
                        generatedHTML += `<table>`;
                        generatedHTML += `<tr><th>Value</th><th>Remove</th></tr>`; // Add remove column header
                        generatedData[category].forEach((item, index) => { // Add index for row removal
                            sitelink = "";
                            for ([key, value] of Object.entries(item)) {
                                sitelink += `${value}<br>`;
                            }
                            generatedHTML += `<tr>
                            <td>${sitelink}</td>
                            <td><span class="remove-row" onclick="removeSemGeneratedRow('${category}', ${index})" onmouseover="" style="cursor: pointer;">X</span></td>
                         </tr>`;
                        });
                    } else {
                        generatedHTML += `<h3>${category.replace(/_/g, ' ').toUpperCase()}</h3>`; // Nicer titles
                        generatedHTML += `<table>`;
                        generatedHTML += `<tr><th>Value</th><th>Remove</th></tr>`; // Add remove column header
                        generatedData[category].forEach((item, index) => { // Add index for row removal
                            generatedHTML += `<tr>
                            <td>${item}</td>
                            <td><span class="remove-row" onclick="removeSemGeneratedRow('${category}', ${index})" onmouseover="" style="cursor: pointer;">X</span></td>
                         </tr>`;
                        });
                    }
                    generatedHTML += `</table>`;
                }
            }
            document.getElementById("generated").innerHTML = generatedHTML;
            document.getElementById("generated").innerHTML = document.getElementById("generated").innerHTML + '<br><button id="downloadSem" onclick="downloadSemCSV()">Download .csv</button>'
            document.getElementById("downloadSem").addEventListener("click", downloadSemCSV);
        }
        function removeSemGeneratedRow(category, index) {
            generatedData[category].splice(index, 1);
            displaySemGeneratedData(); // Redraw the table
        }

        function downloadResultsAsXlsx() {
            const wb = XLSX.utils.book_new();

            // Add auditSummary tab
            const auditSummaryTables = document.getElementById('auditSummary').querySelectorAll('table');
            let auditSummaryData = [];

            auditSummaryTables.forEach((table, tableIndex) => {
                const tableData = extractTableData(table);

                // Add a blank row between tables (if it's not the first table)
                if (tableIndex > 0) {
                    auditSummaryData.push([]);
                }
                auditSummaryData = auditSummaryData.concat(tableData);
            });

            const auditSummaryWS = XLSX.utils.aoa_to_sheet(auditSummaryData);
            XLSX.utils.book_append_sheet(wb, auditSummaryWS, 'auditSummary');

            // Add gtMetrix tab
            const gtMetrixData = extractTableData(document.getElementById('gtmetrixReport').querySelector('table'));
            const gtMetrixWS = XLSX.utils.aoa_to_sheet(gtMetrixData);
            XLSX.utils.book_append_sheet(wb, gtMetrixWS, 'gtMetrix');

            // Add pageAnalysis tab
            const pageAnalysisData = extractTableData(document.getElementById('pageAuditReport').querySelector('table'));
            const pageAnalysisWS = XLSX.utils.aoa_to_sheet(pageAnalysisData);
            XLSX.utils.book_append_sheet(wb, pageAnalysisWS, 'pageAnalysis');


            // Add crawlerSection tab
            const crawlerData = extractTableData(document.getElementById('crawlerReport').querySelector('table'));
            const crawlerWS = XLSX.utils.aoa_to_sheet(crawlerData);
            XLSX.utils.book_append_sheet(wb, crawlerWS, 'crawlerSection');

            XLSX.writeFile(wb, 'technical_seo_results.xlsx');
        }

        function extractTableData(table) {
            const data = [];
            const rows = table.querySelectorAll('tr');

            rows.forEach(row => {
                const rowData = [];
                const cells = row.querySelectorAll('th, td');
                cells.forEach(cell => {
                    // Get text content, handling potential HTML inside cells
                    let cellText = cell.textContent.trim();
                    if (!cellText && cell.innerHTML) {
                        cellText = cell.innerHTML.replace(/<[^>]*>/g, "").trim();
                    }

                    rowData.push(cellText);
                });
                data.push(rowData);
            });
            return data;
        }

        function updateUI(isLoggedIn) {
            document.getElementById('loginForm').style.display = isLoggedIn ? 'none' : 'flex';
            document.getElementById('main-content').style.display = isLoggedIn ? 'block' : 'none';
            document.getElementById('navbar').style.display = isLoggedIn ? 'block' : 'none';
        }


        function openSeo(event) {
            event.preventDefault();
            deactivateAllButtons();
            const seoButton = document.querySelector('button#seo');
            if (seoButton) {
                seoButton.classList.toggle('active');
                const content = seoButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const keywordAnalysisLink = event.currentTarget;
                keywordAnalysisLink.classList.toggle('active-menu');

                const seoSubmenuItems = keywordAnalysisLink.closest('ul').querySelectorAll('li a');
                seoSubmenuItems.forEach(item => {
                    if (item !== keywordAnalysisLink) {
                        item.classList.remove('active-menu');
                    }
                });
            }
        }

        function openKeywordAnalysis(event) {
            event.preventDefault();
            deactivateAllButtons();
            const seoButton = document.querySelector('button#seo');
            if (seoButton) {
                seoButton.classList.toggle('active');
                const content = seoButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const keywordAnalysisLink = event.currentTarget;
                keywordAnalysisLink.classList.toggle('active-menu');

                const seoSubmenuItems = keywordAnalysisLink.closest('ul').querySelectorAll('li a');
                seoSubmenuItems.forEach(item => {
                    if (item !== keywordAnalysisLink) {
                        item.classList.remove('active-menu');
                    }
                });

                if (content.style.display === "block") {
                    const keywordAnalysisSection = document.getElementById('seo');
                    if (keywordAnalysisSection) {
                        keywordAnalysisSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }

        function openTechnicalSeo(event) {
            event.preventDefault();
            deactivateAllButtons();
            openSeo(event);
            Button = document.querySelector('button#technicalButton');
            if (Button) {
                Button.classList.toggle('active');
                const content = Button.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const technicalSeoLink = event.currentTarget;
                technicalSeoLink.classList.toggle('active-menu');

                const seoSubmenuItems = technicalSeoLink.closest('ul').querySelectorAll('li a');
                seoSubmenuItems.forEach(item => {
                    if (item !== technicalSeoLink) {
                        item.classList.remove('active-menu');
                    }
                });

                if (content.style.display === "block") {
                    const technicalSeoSection = document.getElementById('technicalButton');
                    if (technicalSeoSection) {
                        technicalSeoSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }

        function openContentComparison(event) {
            event.preventDefault();
            deactivateAllButtons();
            openSeo(event);
            Button = document.querySelector('button#contentComparisonButton');
            if (Button) {
                Button.classList.toggle('active');
                const content = Button.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const contentComparisonLink = event.currentTarget;
                contentComparisonLink.classList.toggle('active-menu');

                const seoSubmenuItems = contentComparisonLink.closest('ul').querySelectorAll('li a');
                seoSubmenuItems.forEach(item => {
                    if (item !== contentComparisonLink) {
                        item.classList.remove('active-menu');
                    }
                });

                if (content.style.display === "block") {
                    const contentComparisonSection = document.getElementById('contentComparison');
                    if (contentComparisonSection) {
                        contentComparisonSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }

        function openSchemaGenerator(event) {
            event.preventDefault();
            deactivateAllButtons();
            openSeo(event);
            Button = document.querySelector('button#schemaGeneratorButton');
            if (Button) {
                Button.classList.toggle('active');
                const content = Button.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const schemaGeneratorLink = event.currentTarget;
                schemaGeneratorLink.classList.toggle('active-menu');

                const seoSubmenuItems = schemaGeneratorLink.closest('ul').querySelectorAll('li a');
                seoSubmenuItems.forEach(item => {
                    if (item !== schemaGeneratorLink) {
                        item.classList.remove('active-menu');
                    }
                });

                if (content.style.display === "block") {
                    const schemaGeneratorSection = document.getElementById('schema');
                    if (schemaGeneratorSection) {
                        schemaGeneratorSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }

        function openContentGenerator(event) {
            event.preventDefault();
            deactivateAllButtons();
            const smmButton = document.querySelector('button#smm');
            if (smmButton) {
                smmButton.classList.toggle('active');
                const content = smmButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const smmLink = event.currentTarget;
                smmLink.classList.toggle('active-menu');

                const seoSubmenuItems = smmLink.closest('ul').querySelectorAll('li a');
                seoSubmenuItems.forEach(item => {
                    if (item !== smmLink) {
                        item.classList.remove('active-menu');
                    }
                });

                if (content.style.display === "block") {
                    const smmSection = document.getElementById('smm');
                    if (smmSection) {
                        smmSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            Button = document.querySelector('button#contentGeneratorButton');
            if (Button) {
                Button.classList.toggle('active');
                const content = Button.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const contentGeneratorLink = event.currentTarget;
                contentGeneratorLink.classList.toggle('active-menu');

                const seoSubmenuItems = contentGeneratorLink.closest('ul').querySelectorAll('li a');
                seoSubmenuItems.forEach(item => {
                    if (item !== contentGeneratorLink) {
                        item.classList.remove('active-menu');
                    }
                });

                if (content.style.display === "block") {
                    const contentGeneratorSection = document.getElementById('smm');
                    if (contentGeneratorSection) {
                        contentGeneratorSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }

        function openSem(event) {
            event.preventDefault();
            deactivateAllButtons();

            const semButton = document.querySelector('button#semButton');
            if (semButton) {
                semButton.classList.toggle('active');
                const content = semButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const semLink = event.currentTarget;
                semLink.classList.toggle('active-menu');

                const seoSubmenuItems = semLink.closest('ul').querySelectorAll('li a');
                seoSubmenuItems.forEach(item => {
                    if (item !== semLink) {
                        item.classList.remove('active-menu');
                    }
                });

                if (content.style.display === "block") {
                    const semSection = document.getElementById('semButton');
                    if (semSection) {
                        semSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }

        function deactivateAllButtons() {
            const buttons = document.querySelectorAll('button.collapsible'); // Select all collapsible buttons
            buttons.forEach(button => {
                button.classList.remove('active'); // Remove the 'active' class
                const content = button.nextElementSibling; // Get the content div
                if (content) {
                    content.style.display = 'none'; // Hide the content
                }

                button.style.backgroundColor = "#004c9d"; // Reset color

                // Remove active class from menu items
                const navbarLinks = document.querySelectorAll('#navbar a');
                navbarLinks.forEach(link => link.classList.remove('active-menu'));


            });
        }

        function logout() {
            // Clear Google login
            if (googleUser) {
                google.accounts.id.revoke(googleUser.id_token, () => {
                    console.log('Google account revoked');
                });
                googleUser = null;
                localStorage.removeItem('googleUser');
            }

            // Clear login cookie
            document.cookie = "key=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

            updateUI(false);
            document.getElementById('loginError').textContent = "You have been logged out.";
            document.getElementById('loginForm').style.display = 'flex';
        }
    </script

</body>

</html>