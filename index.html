<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digimetrics</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon"
        href="https://mediaonemarketing.com.sg/wp-content/uploads/2023/11/cropped-MediaOne-M-favicon-logo-32x32.png"
        sizes="32x32">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Google Sign-In variables (global scope)
        let googleUser = null; // Store the Google user object
        let codeReceiverURI = 'https://ts9k398yn8.execute-api.ap-southeast-1.amazonaws.com/googleLogin'; // Update with your actual URI

        // Function called after successful Google Sign-In
        function handleCredentialResponse(response) {
            fetch(codeReceiverURI, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ credential: response.credential })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.body.success) {
                        googleUser = data.body.user;
                        localStorage.setItem('googleUser', JSON.stringify(googleUser));
                        updateUI(true); // User logged in
                        console.log(data.body);
                        document.getElementById('logoutLink').querySelector('span') = "Logout " + data.body.user.name;
                    } else {
                        console.error("Backend verification failed:", data.message);
                        document.getElementById('loginError').textContent = data.message || "Google login failed.";
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loginError').textContent = "An error occurred.";
                });
        }

        function checkGoogleLogin() {
            const storedUser = localStorage.getItem('googleUser');
            if (storedUser) {
                googleUser = JSON.parse(storedUser);
                updateUI(true); // Already logged in via Google
                return true; // Indicate Google login success
            }

            google.accounts.id.initialize({
                client_id: '365369983219-12iqvk3v35kf03p3ts1gikglddtkofvq.apps.googleusercontent.com',
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.getElementById('googleSignInButton'),
                { theme: "outline", size: "large" }
            );
            return false; // Google login not yet completed
        }

        // Function to update UI based on login status (modified)
        function updateUI(isLoggedIn) {
            document.getElementById('loginForm').style.display = isLoggedIn ? 'none' : 'flex';
            document.getElementById('main-content').style.display = isLoggedIn ? 'block' : 'none';
            document.getElementById('navbar').style.display = isLoggedIn ? 'block' : 'none';

            //Optionally: Display user info after Google login
            if (isLoggedIn && googleUser) {
                // Example: Show username after successful login
                const welcomeMessage = document.createElement('p');
                welcomeMessage.textContent = `Welcome, ${googleUser.name}!`;
                document.getElementById('main-content').prepend(welcomeMessage);  // or wherever you want to display it.
            }
        }

        window.onload = async () => {
            const isLoggedIn = checkGoogleLogin();
            if (!isLoggedIn) {
                // Show the regular login form only if neither Google nor cookie login are active.
                document.getElementById('loginForm').style.display = 'flex';
            }

            try {
                const response = await fetch('https://nud0xqa1h4.execute-api.ap-southeast-1.amazonaws.com/createThreadId', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                document.getElementById('threadId').innerText = data;
                console.log(data);
                processURL();
                initializeJourneyCollapsibles();
                //loadFromLocalStorage();

            } catch (error) {
                console.error('Error fetching or parsing thread ID:', error);
                // Handle the error appropriately, e.g., display an error message to the user.
                document.getElementById('threadId').innerText = "Error retrieving thread ID"; // or some other error message
            }

        };

    </script>



    <style>
        #loginForm {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }

        #loginForm input {
            margin: 10px 0;
            padding: 8px;
            min-width: 40%;
        }

        label {
            font-weight: normal;
        }

        #loginForm button {
            background-color: #004c9d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #navbar a.active-menu {
            background-color: #0056b3;
            font-weight: bold;
            border-radius: 10px;
        }

        #analysisTable td:first-child {
            left: 0;
            position: sticky;
            background-color: #4c82bc;
            color: white;
            border: 1px solid white;
        }

        #analysisTable th:first-child {
            left: 0;
            background-color: #004c9d;
            position: sticky;
            color: white;
            border: 1px solid white;
            z-index: 1;
        }

        thead th {
            position: sticky;
            top: 0;
            background-color: #004c9d;
            z-index: 1;
        }


        #main-content {
            display: none;
        }

        #schema-output {
            white-space: pre-wrap;
            border: 1px solid #ccc;
            padding: 10px;
            font-family: monospace;
        }

        #navbar a i {
            margin-right: 2%;
        }

        #navbar {
            width: 15%;
            background-color: #004c9d;
            color: white;
            padding: 10px;
            position: fixed;
            height: 100%;
            overflow-y: auto;
            border-radius: 10px;
            transition: width 0.3s;
        }

        #navbar img {
            display: block;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 10%;
            margin-top: 10%;
        }

        #navbar a {
            display: block;
            padding: 5px 2px;
            color: white;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        #navbar a:hover {
            background-color: #0056b3;
            border-radius: 10px;
        }

        #main-content {
            flex: 1;
            padding: 10px;
        }

        body,
        pre {
            font-family: 'Roboto', sans-serif;
            margin: 10px;
            background-color: #fbf7f5;
            color: #333;
            text-wrap: wrap;
            font-size: 0.9em;
        }

        input,
        select,
        button,
        textarea {
            padding: 5px 8px;
            margin: 5px;
            border-radius: 10px;
            border: 1px solid #c8c8c8;
            font-family: inherit;
        }

        input {
            width: 90%;
        }

        button {
            margin: 5px;
            transition: background-color 0.3s, transform 0.1s;
            background-color: #c8c9ca;
        }

        button:hover {
            background-color: #004c9d;
            transform: translateY(-2px);
            cursor: pointer;
            color: white;
        }

        .input-short {
            min-width: 30%;
        }

        textarea {
            min-width: 90%;
            min-height: 50px;
            max-width: 90%;
        }

        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            table-layout: auto;
            display: block;
            table-layout: fixed;
            overflow-y: scroll;
            word-break: break-word;
        }

        .loading-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .loading-modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 30%;
            text-align: center;
        }

        /* Loader animation */
        .loader {
            border: 16px solid #f3f3f3;
            border-top: 16px solid #3498db;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }

        .highlight {
            background-color: yellow;
            font-weight: bold;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #crawlerReport table {
            height: 600px;
        }

        .hidden-table {
            display: none;
        }

        .thumbnail {
            max-width: 100px;
            max-height: 100px;
            cursor: pointer;
        }

        th {
            resize: horizontal;
        }

        #crawlerReport th,
        #crawlerReport td {
            width: 10%;
            overflow-x: auto;
            max-width: 200px;
            overflow-x: auto;
            vertical-align: top;
        }

        th,
        td {
            padding: 8px 8px;
            border: 1px solid #ddd;
            font-size: 1em;
            background-color: white;
            overflow: hidden;
            word-break: auto-phrase;
        }

        th {
            background-color: #004c9d;
            position: sticky;
            color: white;
            top: 0;
        }

        #image-alt-table,
        #links-table,
        #headers-table {
            word-break: inherit;
        }

        .error {
            color: red;
            margin-left: 10px;
        }

        .collapsible {
            background-color: #004c9d;
            color: white;
            cursor: pointer;
            padding: 10px;
            width: 99%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .collapsible50 {
            background-color: #4c9d00;
            color: white;
            cursor: pointer;
            padding: 10px;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1em;
            transition: background-color 0.3s ease;
            margin-left: 2%;
        }

        .collapsible90 {
            background-color: #004c9d;
            color: white;
            cursor: pointer;
            padding: 10px;
            width: 85%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .collapsible-plus {
            background-color: #004c9d;
            color: white;
            cursor: pointer;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .collapsible:hover {
            background-color: #0056b3;
        }

        .content {
            display: none;
            overflow: hidden;
            padding-top: 15px;
            padding-bottom: 15px;
        }

        /* AI Content Optimiser Layout */
        .optimiser-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            margin-top: 15px;
        }

        .editor-main {
            flex: 1;
            min-width: 0;
            /* Prevent flex overflow */
        }

        .sidebar-right {
            width: 320px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Editor Container Styles */
        .editor-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
            color: #333;
            text-align: left;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #dce4f2;
            background-color: #fff;
        }

        .editor-title-container {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        .editor-title-container label {
            font-weight: normal;
            margin-right: 15px;
            color: #444;
            font-size: 1.1em;
        }

        .editor-title-input {
            border: none;
            font-size: 1.25em;
            width: 100%;
            outline: none;
            color: #333;
            font-weight: 600;
        }

        .editor-metrics {
            font-size: 0.9em;
            color: #666;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .editor-toolbar {
            display: flex;
            flex-direction: column;
            padding: 0px;
            background-color: #f8fafd;
            border-bottom: 1px solid #dce4f2;
            gap: 0px;
        }

        .toolbar-row {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            border-right: 1px solid #dce4f2;
            padding: 0 10px;
            margin-right: 4px;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-btn {
            background: none;
            border: 1px solid transparent;
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            color: #444;
            font-size: 15px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
        }

        .toolbar-btn:hover {
            background-color: #e8effa;
            color: #004c9d;
            border-color: #c8d6f0;
        }

        .toolbar-btn.active {
            background-color: #dce6f5;
            color: #004c9d;
            border-color: #b8cced;
        }

        .editor-content {
            padding: 25px 30px;
            height: 700px;
            outline: none;
            overflow-y: auto;
            line-height: 1.7;
            font-size: 16px;
            background-color: #fdfdff;
            border: 1px solid transparent;
            margin: 0;
            transition: background-color 0.2s;
        }

        .editor-content:focus {
            background-color: #fff;
            box-shadow: inset 0 0 10px rgba(0, 76, 157, 0.03);
        }

        /* Diff Highlights */
        .diff-original {
            background-color: #ffe6e6;
            color: #cc0000;
            text-decoration: line-through;
            padding: 2px 4px;
            border-radius: 3px;
            margin: 0 2px;
        }

        .diff-new {
            background-color: #fff9db;
            color: #333;
            padding: 2px 4px;
            border-radius: 3px;
            margin: 0 2px;
            border-bottom: 1px dashed #f08c00;
        }

        .diff-preview-wrapper {
            display: inline;
            position: relative;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fafafa;
            margin: 5px 0;
        }

        .diff-controls {
            display: inline-flex;
            gap: 5px;
            margin-left: 10px;
            vertical-align: middle;
        }

        .diff-controls button {
            padding: 2px 8px;
            font-size: 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-diff-accept {
            background: #4caf50;
            color: white;
        }

        .btn-diff-undo {
            background: #f44336;
            color: white;
        }

        .btn-gradient:disabled {
            background: #e0e0e0 !important;
            color: #999 !important;
            cursor: not-allowed;
            box-shadow: none !important;
            opacity: 1;
        }

        /* Generated Content Preview */
        .generated-content-block {
            background-color: #fff9db;
            border: 1px dashed #f08c00;
            border-radius: 6px;
            padding: 12px;
            margin: 15px 0;
            position: relative;
            transition: all 0.3s ease;
        }

        .generated-badge {
            display: inline-block;
            background: #f08c00;
            color: white;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .generated-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            border-top: 1px solid rgba(240, 140, 0, 0.2);
            padding-top: 8px;
        }

        .generated-actions button {
            padding: 6px 12px;
            font-size: 11px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-accept-content {
            background: #4caf50;
            color: white;
        }

        .btn-accept-content:hover {
            background: #43a047;
        }

        .btn-remove-content {
            background: #f44336;
            color: white;
        }

        .btn-remove-content:hover {
            background: #e53935;
        }

        /* Sidebar Card Styles */
        .sidebar-card {
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 10px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        }

        /* Gauge Styles */
        .gauge-container {
            position: relative;
            width: 180px;
            height: 180px;
            margin: 0 auto 20px;
        }

        .gauge-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .gauge-bg {
            fill: none;
            stroke: #f0f0f0;
            stroke-width: 12;
        }

        .gauge-fill {
            fill: none;
            stroke: #ff9800;
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 440;
            stroke-dashoffset: 132;
            /* (1 - score/100) * 440 */
            transition: stroke-dashoffset 1s ease-out;
        }

        .gauge-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .gauge-score {
            display: block;
            font-size: 42px;
            font-weight: 800;
            color: #333;
            line-height: 1;
        }

        .gauge-label {
            display: block;
            font-size: 14px;
            color: #888;
            margin-top: 5px;
        }

        /* Metric Bar Styles */
        .metric-item {
            margin-bottom: 18px;
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 700;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-bar-bg {
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: #4caf50;
            border-radius: 4px;
            transition: width 0.8s ease-out;
        }

        /* Stats Row */
        .stats-row {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            font-size: 14px;
            color: #555;
            font-weight: 500;
        }

        .stats-item i {
            margin-right: 5px;
            color: #888;
        }

        /* Action Buttons */
        .btn-gradient {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-seo {
            background: #004c9d;
            box-shadow: 0 4px 10px rgba(0, 76, 157, 0.2);
        }

        .btn-keywords {
            background: #004c9d;
            margin-bottom: 15px;
        }

        .btn-gradient:hover {
            background: #003a7a;
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(0, 76, 157, 0.3);
        }

        /* Tabs Interface */
        .sidebar-tabs {
            padding: 0;
            margin: -24px -24px 20px -24px;
            border-bottom: 1px solid #eee;
            display: flex;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 5px;
            border: none;
            background: none;
            font-size: 13px;
            font-weight: 600;
            color: #888;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn i {
            font-size: 16px;
        }

        .tab-btn.active {
            color: #004c9d;
            border-bottom-color: #004c9d;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Keyword List */
        .keyword-freq-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .keyword-freq-item {
            background: #fcfcfc;
            border: 1px solid #f0f0f0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .keyword-freq-header {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        /* AI Tab Styles */
        .ai-prompt-area {
            width: 100%;
            height: 100px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            resize: none;
            outline: none;
        }

        .ai-prompt-area:focus {
            border-color: #2575fc;
        }

        .ai-actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .ai-action-btn {
            padding: 10px;
            background: white;
            border: 1px solid #eee;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: #555;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .ai-action-btn:hover {
            background: #f8fbff;
            border-color: #d0d7ff;
            color: #004c9d;
        }

        /* Multi-keyword Textarea */
        .keyword-input-textarea {
            width: 100%;
            height: 80px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            margin-top: 8px;
            outline: none;
        }

        .keyword-input-textarea:focus {
            border-color: #004c9d;
        }

        /* Status Box */
        .status-box {
            background: #ebfbee;
            color: #2b8a3e;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
            font-size: 14px;
            margin-top: 15px;
        }

        .status-box i {
            font-size: 20px;
        }

        /* Image Resizing */
        .img-resize-handle {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 12px;
            height: 12px;
            background: #004c9d;
            border: 2px solid white;
            border-radius: 50%;
            cursor: nwse-resize;
            display: none;
            z-index: 15;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .img-optimiser-wrapper:hover .img-resize-handle {
            display: block;
        }

        /* Floating Selection Toolbar */
        .selection-toolbar {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 2000;
            padding: 6px;
            align-items: center;
            gap: 5px;
            border: 1px solid #eee;
            pointer-events: auto;
        }

        .selection-toolbar button {
            background: none;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #333;
            transition: all 0.2s;
        }

        .selection-toolbar button:hover {
            background: #f5f8ff;
            color: #004c9d;
        }

        .selection-toolbar button i {
            font-size: 14px;
        }

        .st-separator {
            width: 1px;
            height: 20px;
            background: #eee;
            margin: 0 5px;
        }

        .st-settings {
            padding: 8px !important;
            color: #888 !important;
        }

        .st-settings:hover {
            color: #333 !important;
            background: #f5f5f5 !important;
        }

        /* Custom Tooltips */
        .tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 2500;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.15s ease-in-out;
            font-size: 11px;
            font-weight: normal;
            line-height: 1.4;
            pointer-events: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            white-space: normal;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .editor-content h1 {
            font-size: 2.2em;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .editor-content h2 {
            font-size: 1.8em;
            margin-bottom: 12px;
        }

        .editor-content h3 {
            font-size: 1.4em;
            margin-bottom: 10px;
        }

        .editor-content blockquote {
            border-left: 5px solid #004c9d;
            margin: 15px 0;
            padding: 10px 20px;
            background-color: #f8fbff;
            color: #555;
            font-style: italic;
        }

        .editor-content ul,
        .editor-content ol {
            padding-left: 30px;
            margin-bottom: 15px;
        }

        .editor-content img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin: 10px 0;
        }

        .editor-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }

        .editor-content td {
            border: 1px solid #ddd;
            padding: 10px;
        }

        button.sort-button {
            padding: 3px 6px;
            font-size: 1em;
            margin-left: 5px;
            background-color: #286b37;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }

        button.sort-button:hover {
            background-color: #218838;
        }

        hr {
            border-top: 4px solid rgb(95, 103, 154);
            border-radius: 7px;
            width: 100%;
        }

        .header-container {
            display: flex;
            align-items: center;
            margin: 20px 0;
            background-color: black;
            height: 70px;
            border-radius: 10px;
        }

        .header-container img {
            margin-right: 15px;
            width: auto;
            height: 70%;
        }

        p,
        h1,
        h2,
        h3 {
            text-wrap: wrap;
            font-family: 'Roboto', sans-serif;
        }

        h2 {
            margin-top: 20px;
        }

        h1 {
            margin: 0;
            font-size: 1.5em;
        }

        #keywordListContainer {
            display: flex;
            flex-direction: column;
            max-width: 100%;
            padding: 2px;
        }

        #keywordListContainer h3 {
            font-size: 1em;
            margin-top: 0;
        }

        .keyword-row {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            max-width: 65%;
        }

        .keyword-column {
            flex: 1;
            margin-right: 5px;
            min-width: 50px;
        }

        .keyword-column:hover {
            font-size: 1em;
            cursor: pointer;
        }

        .keyword-column:nth-child(1) {
            flex: 0 0 60%;
        }

        .keyword-column:nth-child(2) {
            flex: 0 0 30%;
        }

        .keyword-column:nth-child(3) {
            flex: 0 0 22%;
        }

        input[type="checkbox"] {
            width: 3em;
        }


        .checkbox-column {
            flex: 0 0 5%;
            margin-right: 0;
        }

        .column {
            float: left;
            width: 50%;
        }

        .column60 {
            float: left;
            width: 60%;
        }

        .column40 {
            float: left;
            width: 40%;
        }

        .column50 {
            float: left;
            width: 48%;
            padding: 1%;
        }

        ul {
            max-height: 350px;
            overflow: auto;
            width: 100%;
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: Window;
        }

        li {
            margin: 5px;
            padding: 0px;
            align-items: left;
        }

        label,
        label-fixed {
            color: WindowText;
            margin: 0;
            padding: 0;
            width: 100%;
        }

        .label-short {
            width: 100%;
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 2em;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #auditSummary table {
            width: 50%;
            float: right;
            padding: 10px;
            height: 560px;
        }

        #analysisTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            max-height: 700px;
            overflow: auto;
        }

        #analysisTable a {
            color: white;
        }

        #analysisTable th,
        #analysisTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            word-wrap: break-word;
            vertical-align: top;
        }

        #tableContainer {
            width: 100%;
            overflow-x: auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #SEM .column {
            width: 48%;
            float: left;
            margin-right: 2%;
            box-sizing: border-box;
        }

        #SEM .column:last-child {
            margin-right: 0;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 3em;
            height: 1.5em;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 1em;
            width: 1em;
            left: 4%;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #004c9d;
        }

        input:focus+.slider {
            box-shadow: 0 0 1px #004c9d;
        }

        input:checked+.slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }


        .toggle-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .toggle-label {
            margin-right: 10px;
        }

        .toggle-label-right {
            margin-left: 10px;
        }

        .header-container img {
            margin-left: 20px;
            width: 400px;
            height: auto;
        }

        .faq-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .faq-item input,
        .faq-item textarea {
            flex-grow: 1;
            margin-right: 10px;
            min-width: 0;
        }

        .faq-item textarea {
            min-height: 80px;
        }

        #navbar ul {
            list-style: none;
            padding: 0;
            margin: 0;
            background-color: #004c9d;
            max-height: None;
        }

        #navbar li {
            padding-left: 10px;
        }

        #navbar li ul li {
            padding-left: 20px;
        }

        #navbar li ul li ul li {
            padding-left: 30px;
        }

        .keyword-count {
            margin-left: 10px;
            color: #004c9d;
        }

        #downloadResultsBtn {
            display: none;
            margin-top: 20px;
        }

        #navbar li a#logoutLink {
            display: block;
            color: white;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        #navbar li a#logoutLink:hover {
            background-color: #0056b3;
            border-radius: 10px;
        }

        #navbar li a#logoutLink i {
            margin-right: 2%;
        }

        #navbar .submenu {
            display: none;
        }


        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip span {
            position: absolute;
            z-index: 10;
            left: 50%;
            transform: translateX(-50%);
            bottom: calc(100% + 5px);
            min-width: 200px;
            max-width: 500px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            border-radius: 15px;
            font-size: 0.9em;
        }

        .tooltip:hover span {
            opacity: 1;
            visibility: visible;
        }

        #overall-summary .table-container table {
            width: 100%;
            table-layout: auto;
        }

        #overall-summary .table-container th,
        #overall-summary .table-container td {
            white-space: normal;
            word-break: break-word;
            max-width: none;
            padding: 8px;
            vertical-align: top;
        }

        #overall-summary .table-container th:nth-child(1),
        #overall-summary .table-container td:nth-child(1) {
            width: 5%;
        }

        #overall-summary .table-container th:nth-child(2),
        /* Column KW */
        #overall-summary .table-container td:nth-child(2) {
            width: 15%;
            /* Column KW width */
        }

        #overall-summary .table-container th:nth-child(3),
        /* Column SV */
        #overall-summary .table-container td:nth-child(3) {
            width: 7%;
            /* Column SV width */
        }

        #overall-summary .table-container th:nth-child(4),
        /* Column CPC */
        #overall-summary .table-container td:nth-child(4) {
            width: 5%;
            /* Column CPC width */
        }

        #overall-summary .table-container th:nth-child(5),
        /* Column Time */
        #overall-summary .table-container td:nth-child(5) {
            width: 10%;
            /* Column Time width */
        }

        #overall-summary .table-container th:nth-child(6),
        /* Column Reason */
        #overall-summary .table-container td:nth-child(6) {
            width: 40%;
            /* Column Reason width */
        }

        #overall-summary .table-container th:nth-child(7),
        #overall-summary .table-container td:nth-child(7) {
            width: 18%;
            /* targteted URL */
        }

        #overall-summary .table-container textarea {
            width: 100%;
            /* Make textareas fill the column width */
            box-sizing: border-box;
            /* Include padding and border in the width */
            height: 80px;
            /* Set an initial height for the textareas */
            resize: vertical;
            /* Allow vertical resizing */
            font-family: inherit;
        }

        .keywords-collapsible {
            min-width: 100%;
            text-align: left;
            margin: 1px;
        }

        .time-to-rank-0-3 {
            background-color: #c6efc6;
            /* Example: Light green */
        }

        .time-to-rank-3-6 {
            background-color: #9bd3ae;
            /* Example: Medium green */
        }

        .time-to-rank-6-9 {
            background-color: #ffda66;
            /* Example: Yellow */
        }

        .time-to-rank-9-12 {
            background-color: #fbb668;
            /* Example: Orange */
        }

        .time-to-rank-more-than-12 {
            background-color: #f4746b;
            /* Example: Red */
        }

        .media-plan-checkbox {
            min-width: 0%;
        }

        /* The Modal (background) */
        .feedback-modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 1001;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
        }

        .modal-content {
            display: block;
            position: fixed;
            /* Stay in place */
            z-index: 1;
            /* Sit on top */
            left: 5%;
            top: 5%;
            width: 90%;
            /* Full width */
            height: auto;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: #fefefe;
            border-radius: 10px;
            padding: 1%;
            border: 3px solid #ccc;
        }

        /* Modal Content/Box */
        .feedback-modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 60%;
            /* Could be more or less, depending on screen size */
            border-radius: 10px;
        }

        /* The Close Button */
        .feedback-close,
        .journey-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .feedback-close:hover,
        .feedback-close:focus,
        .journey-close:hover,
        .journey-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* AI Settings Modal Styles */
        .ai-settings-modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 0;
            width: 90%;
            max-width: 600px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            border: none;
        }

        .ai-settings-modal-content .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-settings-modal-content .modal-header h2 {
            margin: 0;
            color: #004c9d;
            font-size: 1.5rem;
        }

        .ai-settings-modal-content .close-modal {
            font-size: 24px;
            color: #999;
            cursor: pointer;
            transition: color 0.2s;
        }

        .ai-settings-modal-content .close-modal:hover {
            color: #333;
        }

        .settings-sections-container {
            padding: 20px 25px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section h3 {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-header h3 {
            margin-bottom: 0;
            border: none;
            padding: 0;
        }

        .advanced-toggle {
            background: #2b67f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: 500;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .form-group.half {
            flex: 1;
        }

        .form-group.full {
            width: 100%;
        }

        .form-group label {
            font-size: 0.9rem;
            color: #555 !important;
            margin-bottom: 6px;
            font-weight: 600 !important;
        }

        .form-group .required {
            color: #f44336;
        }

        .form-group input[type="text"],
        .form-group select {
            padding: 10px 12px;
            border: 1px solid #dce4f2;
            border-radius: 8px;
            font-size: 0.95rem;
            color: #333;
            background: #fff;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #004c9d;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 76, 157, 0.1);
        }

        .help-text {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
            font-style: italic;
        }

        .checkbox-group {
            flex-direction: row;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group label {
            margin-bottom: 0 !important;
            cursor: pointer;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafafa;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .btn-reset {
            background: #ff7e1d;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .footer-right {
            display: flex;
            gap: 10px;
        }

        .btn-close {
            background: white;
            color: #333;
            border: 1px solid #ddd;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-apply {
            background: #2b67f6;
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .funnel-container {
            width: 90%;
            margin: 20px auto;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .funnel-collapsible-before {
            color: white;
            cursor: pointer;
            padding: 20px;
            width: 100%;
            border: none;
            text-align: center;
            outline: none;
            transition: background-color 0.8s ease;
            border-radius: 50px;
            font-size: 1em;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        .funnel-collapsible {
            color: white;
            cursor: pointer;
            padding: 20px;
            width: 100%;
            border: none;
            text-align: center;
            outline: none;
            transition: background-color 0.8s ease;
            border-radius: 50px 50px 0px 0px;
            font-size: 1em;
            box-sizing: border-box;
            margin: 0px;
        }

        .funnel-content {
            width: 100%;
            display: none;
            padding: 20px;
            border-radius: 0px 0px 50px 50px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .gauge {
            width: 100%;
            max-width: 250px;
            font-family: "Roboto", sans-serif;
            font-size: 18px;
            font-weight: bolder;
            color: #686868;
        }

        .gauge__body {
            width: 100%;
            height: 0;
            padding-bottom: 50%;
            background: linear-gradient(90deg, rgba(253, 29, 29, 1) 0%, rgb(245, 229, 0) 50%, rgba(33, 255, 68, 1) 100%);
            position: relative;
            border-top-left-radius: 100% 200%;
            border-top-right-radius: 100% 200%;
            overflow: hidden;
        }

        .gauge__fill {
            position: absolute;
            top: 100%;
            left: 0;
            width: inherit;
            height: 100%;
            transform-origin: center top;
            transform: rotate(0.25turn);
            transition: transform 0.2s ease-out;
            border: 2.5px solid #5d5d5d;
            /* Solid border for a more defined outline */
        }

        .gauge__cover {
            width: 75%;
            height: 150%;
            background: #f0f0f0;
            border-radius: 50%;
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-bottom: 25%;
            box-sizing: border-box;
            text-align: center;
        }

        .collapsible i {
            margin-right: 1em;
        }


        .checkbox-wrapper-25 input[type="checkbox"] {
            background-image: -webkit-linear-gradient(hsla(0, 0%, 0%, .1), hsla(0, 0%, 100%, .1)),
                -webkit-linear-gradient(left, #f66 50%, rgb(0, 164, 90) 50%);
            background-size: 100% 100%, 200% 100%;
            background-position: 0 0, 15px 0;
            border-radius: 25px;
            box-shadow: inset 0 1px 4px hsla(0, 0%, 0%, .5),
                inset 0 0 10px hsla(0, 0%, 0%, .5),
                0 0 0 1px hsla(0, 0%, 0%, .1),
                0 -1px 2px 2px hsla(0, 0%, 0%, .25),
                0 2px 2px 2px hsla(0, 0%, 100%, .75);
            cursor: pointer;
            height: 25px;
            padding: 0px 25px 0px 0px;
            -webkit-appearance: none;
            -webkit-transition: .25s;
            min-width: 50px;
        }

        .checkbox-wrapper-25 input[type="checkbox"]:after {
            background-color: #eee;
            background-image: -webkit-linear-gradient(hsla(0, 0%, 100%, .1), hsla(0, 0%, 0%, .1));
            border-radius: 25px;
            box-shadow: inset 0 1px 1px 1px hsla(0, 0%, 100%, 1),
                inset 0 -1px 1px 1px hsla(0, 0%, 0%, .25),
                0 1px 3px 1px hsla(0, 0%, 0%, .5),
                0 0 2px hsla(0, 0%, 0%, .25);
            content: '';
            display: block;
            height: 25px;
            width: 25px;
        }

        .checkbox-wrapper-25 input[type="checkbox"]:checked {
            background-position: 0 0, 35px 0;
            padding-left: 25px;
            padding-right: 0;
        }

        .mediaPlanPersonaResults {
            max-height: 500px;
            overflow: auto;
            display: none;
        }

        /* The Modal (background) */
        .feedback-modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 1002;
            /* Ensure it's on top of chatbot-modal */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
        }

        /* Modal Content/Box */
        .feedback-modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            /* Could be more or less, depending on screen size */
            border-radius: 10px;
            position: relative;
            /* Add this */
            z-index: 1002;
            /* Ensure it's on top */
        }

        #chatbot-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            /* Lower z-index than feedback modal */
            width: 60%;
            border: 5px solid #bababa;
            height: 80%;
        }

        #chat-messages {
            overflow-y: scroll;
            margin-bottom: 10px;
            padding: 10px;
            height: 80%;
        }

        .message {
            padding: 8px 12px;
            border-radius: 20px;
            margin-bottom: 8px;
            clear: both;
            /* Prevents floating issues */
            max-width: 70%;
            /* Limits bubble width */
            word-wrap: break-word;
            /* Long words don't break the layout */
        }

        .user {
            background-color: #DCF8C6;
            /* Light green for user */
            float: right;
            /* Align user messages to the right */
        }

        .chatbot {
            background-color: #ECE5DD;
            /* Light gray for chatbot */
            float: left;
            /* Align chatbot messages to the left */
        }

        #question-input {
            flex-grow: 1;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            min-width: 70%;
        }

        .collapsible-icon {
            margin-right: 5px;
            /* Changed from margin-left to margin-right */
            cursor: pointer;
            /*  Change cursor on hover */
            font-size: larger;
            /* Adjust size of the icon as needed */
            transition: transform 0.2s ease-in-out;
            /* Smooth animation when changing */
        }

        .collapsible-icon.open {
            transform: rotate(45deg);
            /* Rotate to become a "x" sign when open */
        }

        #seo-submenu.submenu.show,
        #smm-submenu.submenu.show {
            display: block;
        }

        #seo-submenu.submenu,
        #smm-submenu.submenu {
            display: none;
        }


        #metaTable td:nth-child(1) {
            width: 15%;
            /* Adjust this value as needed */
            word-break: break-word;
            /* Prevent overflow by breaking long words */
        }

        #metaTable td:nth-child(2) {
            width: 20%;
            /* Adjust this value as needed */
            word-break: break-word;
            /* Prevent overflow by breaking long words */
        }

        #metaTable td:nth-child(3) {
            width: 30%;
            /* Adjust this value as needed */
            word-break: break-word;
            /* Prevent overflow by breaking long words */
        }

        #imageTable img {
            max-width: 80px;
            max-height: 80px;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
            /* Center the images */
        }


        #imageTable td:nth-child(2) {
            width: 20%;
            /* Adjust this value as needed */
            word-break: break-word;
        }

        #imageTable td:nth-child(4) {
            width: 30%;
            /* Adjust this value as needed */
            word-break: break-word;
        }

        #imageTable td:nth-child(5) {
            width: 30%;
            /* Adjust this value as needed */
            word-break: break-word;
        }

        #contentTable td:nth-child(1) {
            text-align: center;
            padding: 10px;
        }

        #contentTable td:nth-child(2) {
            width: 30%;
            /* Adjust this value as needed */
            word-break: break-word;
            padding: 10px;
        }

        #contentTable td:nth-child(3) {
            width: 36%;
            /* Adjust this value as needed */
            word-break: break-word;
        }

        #contentTable td:nth-child(4) {
            width: 32%;
            /* Adjust this value as needed */
            word-break: break-word;
            padding: 10px;
        }

        .queries-modal {
            display: none;
            position: fixed;
            z-index: 20;
            left: 5%;
            top: 5%;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            overflow: auto;
        }

        .queries-modal-content {
            background-color: #fefefe;
            padding: 20px;
            border: 1px solid #888;
            width: fit-content;
            border-radius: 20px;
            /* Could be more or less, depending on screen size */
        }

        css to set width of individual columns in table in div id modalContent #modalContent table {
            width: 100%;
            /* Ensure the table takes up the full width of the modal */
            table-layout: fixed;
            /* Crucial for fixed column widths */
        }

        #modalContent table {
            width: 100%;
            /* Ensure the table takes up the full width of the modal */
            table-layout: fixed;
            /* Crucial for fixed column widths */
            border-collapse: collapse;
            /* Good to have for consistent borders */
            word-break: break-word;
        }

        #modalContent table tr {
            height: 10px;
        }

        #modalContent th:nth-child(1),
        #modalContent td:nth-child(1) {
            width: 10%;

        }

        #modalContent th:nth-child(2),
        #modalContent td:nth-child(2) {
            max-width: 20%;
        }

        #modalContent th:nth-child(3),
        #modalContent td:nth-child(3) {
            max-width: 20%;
        }

        #modalContent th:nth-child(4),
        #modalContent td:nth-child(4) {
            max-width: 30%;
        }

        #modalContent th:nth-child(5),
        #modalContent td:nth-child(5) {
            width: 10%;
        }

        /* Add this rule to your existing CSS */
        #logoutNavItem {
            margin-left: auto;
        }

        #mangoolsQuota {
            margin-left: 40px;
        }

        .process {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 1%;
            margin-bottom: 0%;
            margin-left: 5%;
            margin-right: 5%;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: auto;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, transform 0.2s ease-in-out;

        }

        .step-number.completed {
            background-color: green;
            color: #fff;
            border-color: green;
        }

        .step-number.completed i {
            display: inline-block;
        }

        .step-number i {
            display: none;
        }

        .line {
            flex-grow: 1;
            height: 1px;
            background-color: #ddd;
            margin: 0 20px;
        }

        .step-card-container {
            width: calc(100% / 7);
            /* Each container takes up 1/7 of the total width */
            display: flex;
            justify-content: center;
            /* Center the content horizontally */
        }

        .step-card {
            background-color: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin: 10px;
            text-align: center;
            width: 100%;
            /* Step card takes the full width of its container */
            box-sizing: border-box;
            /* Ensures padding doesn't affect width */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            /*Smooth transitions for hover*/
        }

        .step-card:hover {
            transform: translateY(-5px);
            /* Move card up slightly on hover */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            /* Increase shadow on hover */
            cursor: pointer;
        }

        .step-card i {
            font-size: 24px;
            margin-bottom: 8px;
            color: #004c9d;
            transition: color 0.3s ease;
            /*Smooth transition for color*/
        }

        .step-card:hover i {
            color: #003366;
            /* Darker color on hover */
        }

        .step-title {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .step-description {
            font-size: 14px;
            color: #555;
        }

        .step-card-row {
            display: flex;
            justify-content: space-between;
        }

        .progress-bar-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 10px;
            overflow: hidden;
            /* Hide the overflowing progress */
        }

        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            /* Green color for the progress */
            width: 0;
            /* Initial width is 0 */
            transition: width 0.3s ease;
            /* Smooth transition for the width */
        }

        /* Collapsible styles */
        .journey-collapsible {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 8px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: background-color 0.3s ease;
            /*Smooth transition for background color */
            position: relative;
            /* Required for absolute positioning of the progress bar */
        }

        .journey-collapsible-text {
            position: relative;
            z-index: 2;
            /* Ensure text stays on top of the progress bar */
        }

        .journey-collapsible:hover {
            background-color: #ddd;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }

        .list-container {
            width: 300px;
            margin: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .keyword-list {
            list-style: none;
            padding: 0;
            margin: 0;
            min-height: 200px;
            /* Starting height */
        }

        .keyword-list li {
            background-color: #eee;
            border: 1px solid #ddd;
            padding: 8px 12px;
            margin-bottom: 5px;
            cursor: grab;
            border-radius: 20px;
            user-select: none;
        }

        .keyword-list li:hover {
            background-color: #ddd;
        }

        .keyword-list.drag-over {
            background-color: #f9f9f9;
            border: 2px dashed #aaa;
        }

        .rename-input {
            width: 80%;
            margin-bottom: 5px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 1.2em;
            background-color: #bee1ff;
        }

        .delete-list-btn {
            position: absolute;
            top: 15px;
            right: 4px;
            background-color: transparent;
            border: none;
            cursor: pointer;
            color: #888;
        }

        .delete-list-btn:hover {
            color: #333;
        }

        .disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @media screen and (max-width: 1081px) {

            .column,
            .column40,
            .column60 {
                width: 100%;
            }

            #SEM .column {
                width: 100%;
            }
        }

        @media screen and (max-width: 900px) {

            .content {
                width: 100%;
            }


            .header-container img {
                margin-right: 5%;
                /* Space between the image and the text */
                width: 80%;
                /* Adjust the width as needed */
                height: auto;
            }

            .collapsible-icon {
                display: none;
            }

            #navbar {
                width: 60px;
                /* Reduced width for smaller screens */
            }

            #navbar img {
                width: 100%;
                /* Smaller logo */
            }

            #navbar span {
                display: none;
                /* Hide text labels */
            }

            .column,
            .column40,
            .column60,
            .column50 {
                width: 100%;
            }

            .toggle-label {
                margin-right: 10px;
            }

            .toggle-label-right {
                margin-left: 10px;
            }

            #SEM .column {
                width: 100%;
            }

            .sliderMobile {
                min-width: 20px;
            }

            input:checked+.slider:before {
                -webkit-transform: translateX(18px);
                -ms-transform: translateX(18px);
                transform: translateX(18px);
            }

            #navbar li ul li {
                padding-left: 0px;
                /* Increased indentation for sub-items */
            }

            .toggle-label,
            .toggle-label-right {
                font-size: 0.75em;
            }
        }

        /* Style the navbar */
        .navbar {
            background-color: #21468B;
            display: flex;
            align-items: center;
            padding: 0.05%;
            color: white;
            z-index: 2;
            border-radius: 10px;
            top: 10px;
            position: sticky;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.7);
        }

        /* Logo Container */
        .logo-container {
            width: 150px;
            text-align: center;
            padding-right: 30px;
        }

        .logo-container img {
            padding-left: 20px;
            height: 15px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .nav-item>a {
            color: white;
            text-decoration: none;
            font-size: 16px;
            padding: 8px 40px;
            text-align: center;
            display: block;
        }

        /* Change color on hover */
        .nav-item:hover a {
            background-color: #ddd;
            color: black;
            border-radius: 0px;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 3;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            box-sizing: border-box;
            border-radius: 0px;
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
            background-color: transparent;
            border-radius: 0px;
        }

        .nav-item:hover .dropdown-content {
            display: block;
        }

        /* Mobile adjustments (example) */
        @media screen and (max-width: 600px) {
            .navbar {
                flex-direction: column;
                align-items: left;
            }

            .nav-item {
                width: 100%;
            }

            .nav-item>a {
                text-align: left;
            }

            .dropdown-content {
                position: relative;
                left: 0;
                transform: none;
                width: 100%;
                box-shadow: none;
            }

            .nav-item:hover .dropdown-content {
                display: none;
            }

            .nav-item.show .dropdown-content {
                display: block;
            }

            .nav-item.show {
                background-color: #ddd;
                color: black;
            }

            .nav-item.show>a {
                color: black;
                background-color: #ddd;
            }
        }

        @media print {
            body {
                font-size: 12pt;
                /* Adjust font size for printing */
                line-height: 1.5;
            }

            /* Hide elements not needed for printing */
            .no-print {
                display: none;
            }

            #competitors-ranking,
            #competitorsOutput {
                height: auto;
            }

            /* Add margins for each page (important for printing) */
            @page {
                margin: 1cm;
                /* Adjust margins as needed */
            }

            /* Force page breaks where needed */
            .page-break {
                page-break-before: always;
            }

            .navbar {
                position: static;
                width: 100%;
            }

            .column,
            .column40,
            .column50,
            .column60 {
                width: 100%;
            }

            #SEM .column {
                width: 100%;
            }
        }
    </style>
</head>

<body>

    <div id="loginForm">
        <div id="googleSignInButton"></div>
        <p id="loginError" style="color: red;"></p>
    </div>

    <div class="navbar">
        <div class="logo-container" id="logo" style="cursor: pointer;" onclick="window.location.reload()">
            <img src="Digimetrics Logo-02.png" alt="MediaOne Logo">
        </div>

        <div class="nav-item" id="seoNavItem">
            <a href="#" onclick="showSeoOnly(event)">SEO</a>
            <div class="dropdown-content">
                <a href="#keywordAnalysis" onclick="openKeywordAnalysis(event)">Keyword Analysis</a>
                <a href="#crawlerSimulator" onclick="openCrawlerSimulator(event)">Google Crawler Simulator</a>
                <a href="#technicalSeo" onclick="openTechnicalSeo(event)">Technical SEO</a>
                <a href="#contentComparison" onclick="openContentComparison(event)">Competitor Content Comparison &
                    Recommendations</a>
                <a href="#schemaGeneratorButton" onclick="openSchemaGenerator(event)">Schema Generator</a>
                <a href="#onPageSection" onclick="openOnPage(event)"> On-Page Optimisation</a>
                <a href="#rankCheckerSection" onclick="openRankChecker(event)">Rank Checker</a>
            </div>
        </div>

        <div class="nav-item" id="smmNavItem">
            <a href="#" onclick="showSmmOnly(event)">SMM</a>
            <div class="dropdown-content">
                <a href="#contentGenerator" onclick="openContentGenerator(event)">Content Generator</a>
                <a href="#responseGenerator" onclick="openResponseGenerator(event)">Social Media Response Generator</a>
            </div>
        </div>

        <div class="nav-item">
            <a href="#" onclick="showSemOnly(event)">SEM</a>
        </div>

        <div class="nav-item" id="othersNavItem">
            <a href="#" onclick="showOthersOnly(event)">Others</a>
            <div class="dropdown-content">
                <a href="#" onclick="openCompetitors(event)">Competitors Identifier</a>
                <a href="#personaContent" onclick="openPersona(event)">Persona Generator</a>
                <a href="#mediaplan" onclick="openMediaPlan(event)">Media Plan</a>
                <a href="#" onclick="openContentCheck(event)">Content Check</a>
                <a href="#" onclick="openLandingPageAudit(event)">Landing Page Audit</a>
                <a href="#" onclick="openAiContentOptimiser(event)">AI Content Optimiser</a>
            </div>
        </div>

        <div class="nav-item" id="uat">
            <a href="/uat.html" target="_blank">UAT</a>
        </div>

        <div class="nav-item" id="exporPdf">
            <a href="#" onclick="exportToPdf(event)">PDF</a>
        </div>

        <div class="nav-item" id="mangoolsQuota">
            <a href="#" onclick="checkMangoolsQuota(event)">Credits</a>
        </div>

        <div class="nav-item" id="logoutNavItem">
            <a href="#" onclick="logout(event)">Logout</a>
        </div>


    </div>

    <div id="loadingModal" class="loading-modal">
        <div class="loading-modal-content">
            <div class="loader"></div>
            <p>Loading, please wait...</p>
        </div>
    </div>

    <div id="main-content">

        <div id="chatbot-modal">
            <div style="display: none;" id="threadId"></div>
            <div style="display: none;" id="previous-response-id"></div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Chat with Digimetrics AI</h2>
                <button id="close-chatbot"
                    style="background: none; border: none; font-size: 25px; cursor: pointer;"></button>
            </div>
            <div id="chat-messages"></div>
            <div style="display: flex;">
                <input type="text" id="question-input" placeholder="Type your question...">
                <button id="send-button-2">Send</button>
            </div>
        </div>

        <div id="journey-modal" class="feedback-modal">
            <div class="feedback-modal-content">
                <span class="journey-close" onclick="closeJourneyModal()"></span>
                <h2>Digimetrics Journey</h2>
                <button type="button" class="journey-collapsible" data-total-steps="7" data-completed-steps="0">
                    <div class="progress-bar-container">
                        <div class="progress-bar"></div>
                    </div>
                    <span class="journey-collapsible-text">Steps 1 - 7</span>
                </button>
                <div class="content">
                    <div class="process">
                        <div class="step">
                            <div class="step-number">01</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">02</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">03</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">04</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">05</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">06</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">07</div>
                        </div>
                    </div>

                    <div class="step-card-row">
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-search"></i>
                                <div class="step-title" onclick="openKeywordAnalysis(event)">Generate Keywords From Seed
                                    Keywords</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-globe"></i>
                                <div class="step-title" onclick="openKeywordAnalysis(event)">Get Ranking Keywords /
                                    Keywords Based on Webpage Content</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-clock"></i>
                                <div class="step-title" onclick="openKeywordAnalysis(event)">Get Keywords' Time To Rank
                                </div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-tools"></i>
                                <div class="step-title" onclick="openTechnicalSeo(event)">Technical SEO Audit</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-balance-scale"></i>
                                <div class="step-title" onclick="openContentComparison(event)">Competitor Content
                                    Comparison & Recommendations</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-file-code"></i>
                                <div class="step-title" onclick="openOnPage(event)">On-Page SEO</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-signal"></i>
                                <div class="step-title" onclick="openRankChecker(event)">Rank Checker</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- journey-collapsible Section 2: Steps 8-14 -->
                <button type="button" class="journey-collapsible" data-total-steps="7" data-completed-steps="0">
                    <div class="progress-bar-container">
                        <div class="progress-bar"></div>
                    </div>
                    <span class="journey-collapsible-text">Steps 8 - 14</span>
                </button>
                <div class="content">
                    <div class="process">
                        <div class="step">
                            <div class="step-number">08</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">09</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">10</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">11</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">12</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">13</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">14</div>
                        </div>
                    </div>

                    <div class="step-card-row">
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-sitemap"></i>
                                <div class="step-title" onclick="openSchemaGenerator(event)">Schema Generator</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-user-friends"></i>
                                <div class="step-title" onclick="openCompetitors(event)">Competitors Identifier</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-id-card"></i>
                                <div class="step-title" onclick="openPersona(event)">Persona Generator</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-bullhorn"></i>
                                <div class="step-title" onclick="openMediaPlan(event)">Media Plan</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-edit"></i>
                                <div class="step-title" onclick="openContentGenerator(event)">Content Generator</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-clipboard-check"></i>
                                <div class="step-title" onclick="openContentCheck(event)">Content Checker</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-home"></i>
                                <div class="step-title" onclick="openLandingPageAudit(event)">Landing Page Audit</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- journey-collapsible Section 2: Steps 15- -->
                <button type="button" class="journey-collapsible" data-total-steps="7" data-completed-steps="0">
                    <div class="progress-bar-container">
                        <div class="progress-bar"></div>
                    </div>
                    <span class="journey-collapsible-text">Steps 15 -</span>
                </button>
                <div class="content">
                    <div class="process">
                        <div class="step">
                            <div class="step-number">15</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">16</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">17</div>
                        </div>
                        <div class="line"></div>
                        <div class="step">
                            <div class="step-number">18</div>
                        </div>
                    </div>

                    <div class="step-card-row">
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-ad"></i>
                                <div class="step-title" onclick="openSem(event)">SEM Ad Generator</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-magic"></i>
                                <div class="step-title" onclick="openAiContentOptimiser(event)">AI Content Optimiser
                                </div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-flask"></i>
                                <div class="step-title">Step 17</div>
                            </div>
                        </div>
                        <div class="step-card-container">
                            <div class="step-card">
                                <i class="fas fa-map-signs"></i>
                                <div class="step-title">Step 18</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="seoSection">
            <button class="collapsible" id="seo"><i class="fas fa-plus-square"></i><i class="fab fa-google"></i>Search
                Engine Optimisation (SEO)</button>
            <div class="content">

                <!-- Modal for Content Comparison Queries -->
                <div id="contentComparisonkModal" class="queries-modal" style="display:none">
                    <div class="queries-modal-content">
                        <span class="close" onclick="closeContentComparisonQueriesModal()"></span>
                        <h2>Previous Content Comparison Queries</h2>
                        <div id="content_comparison_loading"
                            style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; /* Adjust height as needed */">
                            <img src="https://usagif.com/wp-content/uploads/loading-73.gif" alt="Loading..."
                                style="width: 100px; height: 100px;">
                            <p style="text-align: center;">Loading queries...</p>
                        </div>

                        <table id="contentComparisonQueriesTable">
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>Date</th>
                                    <th>URL</th>
                                    <th>Keywords</th>
                                    <th>User</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Queries will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Modal for Previous Time To Rank Queries -->
                <div id="timeToRankModal" class="queries-modal" style="display:none">
                    <div class="queries-modal-content">
                        <span class="close" onclick="closeTimeToRankQueriesModal()"></span>
                        <h2>Previous Time To Rank Queries</h2>
                        <div id="time_to_rank_loading"
                            style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; /* Adjust height as needed */">
                            <img src="https://usagif.com/wp-content/uploads/loading-73.gif" alt="Loading..."
                                style="width: 100px; height: 100px;">
                            <p style="text-align: center;">Loading queries...</p>
                        </div>

                        <table id="timeToRankQueriesTable">
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>Date</th>
                                    <th>URL</th>
                                    <th>Keywords</th>
                                    <th>User</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Queries will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Modal for Previous On-Page Queries -->
                <div id="queriesModal" class="queries-modal" style="display:none">
                    <div class="queries-modal-content">
                        <span class="close" onclick="closeQueriesModal()"></span>
                        <h2>Previous On-Page Queries</h2>

                        <div id="on_page_loading"
                            style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; /* Adjust height as needed */">
                            <img src="https://usagif.com/wp-content/uploads/loading-73.gif" alt="Loading..."
                                style="width: 100px; height: 100px;">
                            <p style="text-align: center;">Loading queries...</p>
                        </div>

                        <table id="queriesTable">
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>Date</th>
                                    <th>URL</th>
                                    <th>Keywords</th>
                                    <th>User</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Queries will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="feedbackModal" class="feedback-modal">
                    <div class="feedback-modal-content">
                        <span class="feedback-close"></span>
                        <h2>Feedback</h2>

                        <label for="userFeedback">Your Feedback:</label>
                        <textarea id="userFeedback"
                            style="width: 100%; height: 100px; background-color:#eef5fe;"></textarea><br>

                        <label for="checkResults">Check Results:</label>
                        <textarea id="checkResults" readonly style="width: 100%; height: 100px;"></textarea><br>

                        <label for="guidelinesURLs">URLs of Guidelines PDFs:</label>
                        <textarea id="guidelinesURLs" readonly style="width: 100%; height: 20px;"></textarea><br>

                        <label for="websiteURLs">Any other website/guidelines URLs:</label>
                        <textarea id="websiteURLs" readonly style="width: 100%; height: 20px;"></textarea><br>

                        <label for="otherInstructions">Any other instructions:</label>
                        <textarea id="otherInstructions" readonly style="width: 100%; height: 20px;"></textarea><br>

                        <label for="contentToCheck">Content to Check:</label>
                        <textarea id="contentToCheck" readonly style="width: 100%; height: 30px;"></textarea><br>

                        <button id="submitFeedbackBtn">Submit Feedback</button>
                    </div>
                </div>

                <!-- Input Form for User Data -->
                <div class="column50">
                    <form id="seoForm">
                        <label-fixed for="domain">Domain / URL:</label-fixed>
                        <input type="url" id="domain" name="domain" style="min-width: 60%"
                            placeholder="Site Audit: https://www.abc.com | Page Audit: www.abc.com"
                            onmouseover="showTooltip(event, 'E.g.<br>https:\/\/www.example.com will target one webpage<br>www.example.com will target the entire website')"
                            onmouseout="hideTooltip()">
                        <div id="tooltip"
                            style="position: absolute; font-size: 0.9em; background-color: #568cc2; color: white; border: 1px solid #ccc; padding: 5px; display: none; z-index: 1000; border-radius: 10px;">
                        </div>
                        <span class="error" id="domainError"></span>
                        <br>
                        <label-fixed for="location">Targeted Location (required):</label-fixed>
                        <select id="location" name="location" required>
                            <option value="Singapore">Singapore</option>
                            <option value="None">Global</option>
                            <option value="Australia">Australia</option>
                            <option value="Bhutan">Bhutan</option>
                            <option value="Brazil">Brazil</option>
                            <option value="Canada">Canada</option>
                            <option value="China">China</option>
                            <option value="France">France</option>
                            <option value="Germany">Germany</option>
                            <option value="Hong Kong">Hong Kong</option>
                            <option value="India">India</option>
                            <option value="Indonesia">Indonesia</option>
                            <option value="Italy">Italy</option>
                            <option value="Japan">Japan</option>
                            <option value="Malaysia">Malaysia</option>
                            <option value="Mexico">Mexico</option>
                            <option value="Netherlands">Netherlands</option>
                            <option value="Netherlands">Philippines</option>
                            <option value="South Korea">South Korea</option>
                            <option value="Spain">Spain</option>
                            <option value="Taiwan">Taiwan</option>
                            <option value="Thailand">Thailand</option>
                            <option value="United Kingdom">United Kingdom</option>
                            <option value="United States">United States</option>
                            <option value="Vietnam">Vietnam</option>
                        </select><br>

                        <label-fixed for="language">Language (required):</label-fixed>
                        <select id="language" name="language" required>
                            <option value="English">English</option>
                            <option value="Arabic">Arabic</option>
                            <option value="Chinese (Simplified)">Chinese (Simplified)</option>
                            <option value="Chinese (Traditional)">Chinese (Traditional)</option>
                            <option value="Dutch">Dutch</option>
                            <option value="French">French</option>
                            <option value="German">German</option>
                            <option value="Hindi">Hindi</option>
                            <option value="Indonesian">Indonesian</option>
                            <option value="Italian">Italian</option>
                            <option value="Japanese">Japanese</option>
                            <option value="Korean">Korean</option>
                            <option value="Malay">Malay</option>
                            <option value="Portuguese">Portuguese</option>
                            <option value="Russian">Russian</option>
                            <option value="Spanish">Spanish</option>
                            <option value="Tamil">Tagalog</option>
                            <option value="Tamil">Tamil</option>
                            <option value="Thai">Thai</option>
                            <option value="Vietnamese">Vietnamese</option>
                        </select>
                        <br>
                        <div>
                            <label-fixed for="keywords">Keyword(s) of Interest (comma or newline
                                separated):</label-fixed>
                            <span id="keywordCount" style="margin-left: 10px; color: #004c9d;"></span><br> <textarea
                                id="keywords" name="keywords" required placeholder="keyword1, keyword2"
                                oninput="updateKeywordCount()"></textarea>
                            <span class="error" id="keywordsError"></span>
                        </div>

                        <button type="button" id="keyword-research-analysis-button" class="tooltip"
                            onclick="validateAndSubmit(event)">Get Time To Rank
                            <span>Click to get the estimated time to rank for the selected keywords and the webpage's
                                metrics.</span>
                        </button>
                        <button type="button" id="mapKeywordsBtn" class="tooltip" onclick="mapKeywords()">Map Keywords
                            <span>Click to get see recommended URL mapping for the selected keywords.</span></button>
                        <button type="button" onclick="openTimeToRankQueriesModal()" id="loadTimeToRankQueriesBtn">Load
                            Previous
                            Queries</button>
                    </form>
                    <div id="rankingError"></div>
                    <table id="keywordTable" style="display: none;">
                        <tr>
                            <th>Keyword</th>
                            <th>Search Volume</th>
                            <th>Competition</th>
                            <th>Rank</th>
                        </tr>
                    </table>

                    <table id="top100Table" style="display: none;">
                        <tr>
                            <th>Keyword</th>
                            <th>Search Volume</th>
                            <th>Competition</th>
                            <th>Rank</th>
                        </tr>
                    </table>
                    <button class="collapsible-plus" id="expandSimilarKeywords"><i
                            class="fas fa-plus-square"></i></button>
                    <button class="collapsible90" id="keyword_suggestions" onclick="similarKeywords(event)">Keyword
                        Suggestions (Similar Keywords / SERPs)
                    </button>
                    <div class="content" id="keywordSuggestions">
                        <div id="keywordListContainer">
                            <div class="keyword-row" id="keywordHeaderRow">
                                <div class="keyword-column tooltip" onclick="sortKeywordSuggestions(0)">
                                    <strong>Keyword</strong>
                                    <span>Click on the keyword to see it's SERPs.</span>
                                </div>
                                <div class="keyword-column" onclick="sortKeywordSuggestions(1)">
                                    <strong>Search Vol</strong>
                                </div>
                                <div class="keyword-column" onclick="sortKeywordSuggestions(2)">
                                    <strong>Difficulty</strong>
                                </div>
                                <div class="keyword-column" onclick="sortKeywordSuggestions(3)">
                                    <strong>CPC</strong>
                                </div>
                                <div class="checkbox-column"></div><strong>Choose</strong>
                            </div>
                            <ul id="keywordList"></ul>
                            <div id="keywordSuggestionsExport" style="display:none">
                                <button type="button"
                                    onclick="exportSelectedKeywordSuggestionsToCSV(keywordHeaderRow, keywordList)">Export
                                    selected as
                                    .csv</button>
                                <button type="button"
                                    onclick="exportKeywordSuggestionsToCSV(keywordHeaderRow, keywordList)">Export all as
                                    .csv</button>
                            </div>
                        </div>
                    </div>

                    <br>
                    <button class="collapsible-plus" id="expandRankingKeywords"><i
                            class="fas fa-plus-square"></i></button>
                    <button class="collapsible90" id="ranking_keywords" onclick="rankingKeywords(event)">Ranking
                        Keywords</button>
                    <div class="content" id="rankingKeywords">
                        <div id="rankedKeywordsCount"></div>
                        <div id="keywordListContainer">
                            <div class="keyword-row" id="rankedKeywordHeaderRow">
                                <div class="keyword-column" onclick="sortRankedKeywords(0)">
                                    <strong>Keyword</strong>
                                </div>
                                <div class="keyword-column" onclick="sortRankedKeywords(1)">
                                    <strong>Search Vol</strong>
                                </div>
                                <div class="keyword-column" onclick="sortRankedKeywords(2)">
                                    <strong>Rank</strong>
                                </div>
                                <div class="keyword-column" onclick="sortRankedKeywords(3)">
                                    <strong>Difficulty</strong>
                                </div>
                                <div class="checkbox-column"></div><strong>Choose</strong>
                            </div>
                            <ul id="rankedKeywordList"></ul>
                            <div id="rankingKeywordsExport" style="display:none">
                                <button type="button"
                                    onclick="exportSelectedRankedKeywordsToCSV(rankedKeywordHeaderRow, rankedKeywordList)">Export
                                    selected as
                                    .csv</button>
                                <button type="button"
                                    onclick="exportRankedKeywordsToCSV(rankedKeywordHeaderRow, rankedKeywordList)">Export
                                    all as
                                    .csv</button>
                            </div>
                        </div>
                    </div><br>
                    <button class="collapsible-plus" id="expandWebpageKeywords"><i
                            class="fas fa-plus-square"></i></button>
                    <button class="collapsible90" id="keywords_for_site" onclick="getWebpageKeywords(event)">Keywords
                        Based
                        on Webpage Content</button>
                    <div class="content" id="siteKeywords" style="padding:10px">
                    </div>
                </div>

                <div class="column50">
                    <div id="serp-section"></div>
                </div>

                <hr>
                <button class="collapsible" id="keyword_mapping"><i class="fas fa-plus-square"></i>Keyword
                    Mapping</button>
                <div class="content" id="keywordMapping">
                    <button id="addListBtn">Add New URL</button>
                    <button id="undoBtn" disabled>Undo Delete</button>
                    <div class="container" id="listsContainer"></div>
                    <div id="recommendations"></div>
                </div>
                <button class="collapsible" id="meta_data"><i class="fas fa-plus-square"></i>Meta Data</button>
                <div class="content" id="metaData">
                    <p><b>Meta Title: </b><span id="targetTitle">-</span></p>
                    <p><b>Meta Description: </b><span id="targetDescription">-</span></p>
                    <p><b>h1 Header: </b><span id="targetH1">-</span></p>

                </div>

                <button class="collapsible" id="domain_metrics"><i class="fas fa-plus-square"></i>Domain Metrics (DA,
                    PA,
                    PageSpeed)</button>
                <div class="content" id="domainMetrics">
                    <div class="column">
                        <p><b>Domain Authority (DA): </b><span id="da">-</span></p>
                        <p><b>Page Authority (PA): </b><span id="pa">-</span></p>
                        <p><b>Backlinks Spam Score: </b><span id="targetSpamScore">-</span></p>
                        <p><b>Backlinks: </b><span id="targetBacklinks">-</span></p>
                        <p><b>Referring Domains: </b><span id="targetRefDomains">-</span></p>
                        <p><b>Page Word Count: </b><span id="targetWordCount">-</span></p>
                    </div>
                    <div class="column">
                        <p><b>Internal Links: </b><span id="targetInternalLinks">-</span></p>
                        <p><b>External Links: </b><span id="targetExternalLinks">-</span></p>
                        <p><b>Flesch Readability: </b><span id="targetReadability">-</span></p>
                        <p><b>Images: </b><span id="targetImages">-</span></p>
                        <p><b>CLS: </b><span id="targetCls">-</span></p>
                        <p><b>LCP: </b><span id="targetLcp">-</span></p>
                        <p><b>FID: </b><span id="targetFid">-</span></p>
                        <p><b>Schema: </b><span id="targetSchema">-</span></p>
                    </div>
                    <div style="clear: both;"></div>
                    <div> </div> <!-- Clearfix -->
                </div>
                <hr>
                <div class="page-break"></div>
                <button class="collapsible" id="keywordAnalysisBtn"><i class="fas fa-plus-square"></i>Keyword
                    Analysis</button>
                <div class="content" id="keywordAnalysis">
                    <div id="overall-summary" style="display:none;"></div>
                    <div id="keyword-analysis-results">
                        <!-- Collapsible sections for each keyword analysis will be added here -->
                    </div>
                </div>
                <hr>
                <div class="page-break"></div>
                <button class="collapsible" id="simulatorButton"><i class="fas fa-plus-square"></i>Google Crawler
                    Simulator</button>
                <div class="content" id="crawlerSimulator">
                    <label for="google-simulator-url">Enter URL:</label>
                    <input type="url" id="google-simulator-url" size="50"><br>
                    <button id="simulatorBtn" onclick="googleCrawlerSimulator()">Analyse</button>
                    <div id="simulatorError" style="color: red;"></div>
                    <div id="crawler-simulator-results" style="display: none;">
                        <h3>Meta Information</h3>
                        <table id="meta-table">
                            <thead>
                                <tr>
                                    <th>Property</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Meta Title</td>
                                    <td id="simulator-meta-title"></td>
                                </tr>
                                <tr>
                                    <td>Meta Description</td>
                                    <td id="simulator-meta-description"></td>
                                </tr>
                                <tr>
                                    <td>Canonical Tag</td>
                                    <td id="simulator-canonical-tag"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="column40" id="keyword-density-section">
                            <h3>Keyword Density</h3>
                            <div id="keyword-density"
                                style="max-height: 1000px; overflow-y: scroll; text-align: center;">
                            </div>
                        </div>
                        <div></div>
                        <div class="column60">
                            <h3>Page Text</h3>
                            <div id="simulatorPageText" style="max-height: 1000px; overflow-y: scroll; padding:10px">
                            </div>
                        </div>
                        <div class="page-break"></div>
                        <div style="clear: both;"></div>
                        <div> </div> <!-- Clearfix -->
                        <h3>Headers</h3>
                        <table id="headers-table">
                            <thead>
                                <tr>
                                    <th>Header</th>
                                </tr>
                            </thead>
                            <tbody id="simulator-headers-body">
                            </tbody>
                        </table>

                        <div class="page-break"></div>
                        <!-- Page break before Links -->
                        <h3>Links</h3>
                        <table id="links-table">
                            <thead>
                                <tr>
                                    <th>Link Type</th>
                                    <th>URL</th>
                                    <th>Link Text</th>
                                </tr>
                            </thead>
                            <tbody id="simulator-links-body">
                            </tbody>
                        </table>


                        <h3>Image Alt Text</h3>
                        <table id="image-alt-table">
                            <thead>
                                <tr>
                                    <th>Thumbnail</th>
                                    <th>Image URL</th>
                                    <th>Title</th>
                                    <th>Alt Text</th>
                                    <th>Size</th>
                                </tr>
                            </thead>
                            <tbody id="simulator-image-alt-body">
                            </tbody>
                        </table>

                    </div>
                </div>
                <hr>
                <div class="page-break"></div>
                <button class="collapsible" id="technicalButton"><i class="fas fa-plus-square"></i>Technical
                    SEO</button>
                <div class="content" id="technicalSeo">
                    <label for="urlInput">Enter URL:</label>
                    <input type="url" id="urlInput">
                    <br>
                    <label for="maxPagesInput">Max Pages to Crawl:</label>
                    <input type="number" id="maxPagesInput" value="10">

                    <button id="submitBtn">Analyse Website</button>

                    <br><br>

                    <div id="auditSummary"></div>

                    <button class="collapsible" id="gtButton"><i class="fas fa-plus-square"></i>GTmetrix
                        Results</button>
                    <div class="content" id="gtMetrix">
                        <div id="gtmetrixReport" style="display:none;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Report URL</td>
                                        <td id="reportUrl"></td>
                                    </tr>
                                    <tr>
                                        <td>Cumulative Layout Shift</td>
                                        <td id="cls"></td>
                                    </tr>
                                    <tr>
                                        <td>Largest Contentful Paint</td>
                                        <td id="lcp"></td>
                                    </tr>
                                    <tr>
                                        <td>Total Blocking Time</td>
                                        <td id="tbt"></td>
                                    </tr>
                                    <tr>
                                        <td>GTmetrix Grade</td>
                                        <td id="grade"></td>
                                    </tr>
                                    <tr>
                                        <td>GTmetrix Performance Score</td>
                                        <td id="performance"></td>
                                    </tr>
                                </tbody>
                            </table>
                            <br><br>
                        </div>
                    </div>

                    <button class="collapsible" id="pageButton"><i class="fas fa-plus-square"></i>Page Analysis
                        Results</button>
                    <div class="content" id="pageAnalysis">
                        <div id="pageAuditReport" style="display:none;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Metric</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>PageSpeed (Mobile)</td>
                                        <td id="pagespeed_audit"></td>
                                    </tr>
                                    <tr>
                                        <td>Malware</td>
                                        <td id="malware"></td>
                                    </tr>
                                    <tr>
                                        <td>robots.txt</td>
                                        <td id="robots"></td>
                                    </tr>
                                    <tr>
                                        <td>Sitemap</td>
                                        <td id="sitemap"></td>
                                    </tr>
                                </tbody>
                            </table>
                            <br><br>
                        </div>
                    </div>

                    <button class="collapsible" id="crawlerButton"><i class="fas fa-plus-square"></i>Crawler
                        Report</button>
                    <div class="content" id="crawlerSection">
                        <div id="crawlerReport" style="display:none;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>URL</th>
                                        <th>Code</th>
                                        <th>Title</th>
                                        <th>Description</th>
                                        <th>Canonical</th>
                                        <th>Hreflang</th>
                                        <th>Alt Text</th>
                                        <th>H1</th>
                                        <th>H2</th>
                                        <th>Word Count</th>
                                        <th>UI/UX</th>
                                    </tr>
                                </thead>
                                <tbody id="crawlerTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <button id="downloadResultsBtn" onclick="downloadResultsAsXlsx()">Download results as xlsx</button>
                </div>
                <hr>
                <div class="page-break"></div>
                <button class="collapsible" id="contentComparisonButton"><i class="fas fa-plus-square"></i>Content
                    Comparison</button>
                <div class="content" id="contentComparison">
                    <label for="comparison-keyword">Keyword:</label>
                    <input type="text" id="comparison-keyword" placeholder="e.g., digital marketing">
                    <br>
                    <label for="comparison-domain">Target Domain or URL:</label>
                    <input type="url" id="comparison-domain"
                        onmouseover="showTooltip(event, 'Using this field will add this URL to the top 10 SERPs comparison.')"
                        onmouseout="hideTooltip()" placeholder="e.g., example.com">
                    <br>
                    <label for="comparison-urls">or Other Specific URLs (separate by new line or comma):</label>
                    <textarea id="comparison-urls"
                        onmouseover="showTooltip(event, 'Using this field will run the analysis based on the URLs in this field only.')"
                        onmouseout="hideTooltip()"
                        placeholder="e.g., https://example.com, https://another-example.com"></textarea>
                    <br>

                    <label>Page Types to Target:</label><br>
                    <input type="checkbox" id="target-blogs" name="target-page-type" value="blog article"
                        onmouseover="showTooltip(event, 'If no URLs are classifed as this page type, the analysis will be done for the all page types.')"
                        onmouseout="hideTooltip()">
                    <label for="target-blogs"
                        onmouseover="showTooltip(event, 'If no URLs are classifed as this page type, the analysis will be done for the all page types.')"
                        onmouseout="hideTooltip()">Blog Article</label>
                    <input type="checkbox" id="target-product" name="target-page-type" value="product/service-page"
                        onmouseover="showTooltip(event, 'If no URLs are classifed as this page type, the analysis will be done for the all page types.')"
                        onmouseout="hideTooltip()">
                    <label for="target-product"
                        onmouseover="showTooltip(event, 'If no URLs are classifed as this page type, the analysis will be done for the all page types.')"
                        onmouseout="hideTooltip()">Product/Service Page</label>
                    <input type="checkbox" id="target-landing" name="target-page-type" value="landing page"
                        onmouseover="showTooltip(event, 'If no URLs are classifed as this page type, the analysis will be done for the all page types.')"
                        onmouseout="hideTooltip()">
                    <label for="target-landing"
                        onmouseover="showTooltip(event, 'If no URLs are classifed as this page type, the analysis will be done for the all page types.')"
                        onmouseout="hideTooltip()">Landing Page</label>
                    <input type="checkbox" id="target-any" name="target-page-type" value="any" checked>
                    <label for="target-any">Any</label>
                    <br>

                    <div class="column">
                        <label for="comparison-language">Language:</label>
                        <input type="text" id="comparison-language" value="English" placeholder="e.g., English">
                    </div>
                    <div class="column">
                        <label for="comparison-location">Location:</label>
                        <input type="text" id="comparison-location" value="Singapore" placeholder="e.g., Singapore">
                    </div>
                    <br>
                    <button id="contentComparisonAnalyzeBtn" onclick="contentComparisonAnalysis()">Analyse (up to 3
                        mins)</button>
                    <button type="button" onclick="openContentComparisonQueriesModal()"
                        id="loadContentComparisonQueriesBtn">Load Previous
                        Queries</button>
                    <div id="initial-table"></div>
                    <div id="comparison-results"></div>
                    <div id="keyword-density"></div>
                </div>

                <hr>
                <div class="page-break"></div>
                <button class="collapsible" id="schemaGeneratorButton"><i class="fas fa-plus-square"></i>Schema
                    Generator</button>
                <div class="content" id="schema">
                    <label for="schema-type">Schema Type:</label>
                    <select id="schema-type">
                        <option value="LocalBusiness">Local Business</option>
                        <option value="Product">Product</option>
                        <option value="Event">Event</option>
                        <option value="Article">Article</option>
                        <option value="BreadcrumbList">Breadcrumb</option>
                        <option value="Event">Event</option>
                        <option value="FAQPage">FAQ Page</option>
                        <option value="HowTo">How-to</option>
                        <option value="JobPosting">Job Posting</option>
                        <option value="Organization">Organisation</option>
                        <option value="Person">Person</option>
                        <option value="Product">Product</option>
                        <option value="VideoObject">Video</option>
                        <option value="Website">Website</option>
                        <!-- Add more schema types as needed -->
                    </select>

                    <div id="input-fields"></div>
                    <div id="schema-output"></div>
                </div>
                <hr>
                <div class="page-break"></div>
                <button class="collapsible" id="onPageButton"><i class="fas fa-plus-square"></i>On-Page
                    Optimisation</button>
                <div id="onPageSection" class="content">
                    <div class="input-group">
                        <div style="align-items: center; margin-bottom: 5px;">
                            <label for="on-page-url" style="margin-right: 5px;">Enter URL:</label><br>
                            <input type="url" id="on-page-url" placeholder="https://example.com" required>

                        </div>

                        <label for="on-page-keywords">Enter Keywords (comma or newline separated):</label>
                        <textarea id="on-page-keywords" rows="4" placeholder="keyword1, keyword2, keyword3"></textarea>

                        <button onclick="getImages()" id="getImagesBtn">Extract Elements & Generate
                            Recommendations</button>
                        <!-- 
                    <button onclick="loadCachedData()" class="load-cache-button">Load Cached Data From Browser</button>
                    -->
                        <button type="button" onclick="openQueriesModal()" id="loadQueriesBtn">Load Previous
                            Queries</button>
                        <button onclick="clearOnPageData()" style="white-space: nowrap;">Clear Data</button>
                    </div>
                    <button class="collapsible" id="onPageResultsCollapsible" style="display: none;">Meta Data and
                        Headings</button>
                    <div class="content" id="onPageResults"></div>
                    <button class="collapsible" id="imageCollapsible" style="display: none;">Image Alt Text</button>
                    <div class="content" id="imageRecommendations"></div>
                    <button class="collapsible" id="contentCollapsible" style="display: none;">Content</button>
                    <div class="content" id="contentRecommendations"></div>
                </div>
                <hr>
                <div class="page-break"></div>
                <button class="collapsible" id="rankCheckerButton"><i class="fas fa-plus-square"></i>Rank
                    Checker</button>
                <div class="content" id="rankChecker">
                    <label-fixed for="rankCheckerKeywords">Keywords:</label-fixed><br>
                    <textarea id="rankCheckerKeywords" rows="10" cols="50"
                        placeholder="Enter keywords, one per line, up to 1,200 keywords"></textarea>
                    <br>
                    <label-fixed for="rankCheckerDomain">Targeted Domain / URL:</label-fixed><br>
                    <input type="url" id="rankCheckerDomain" value="https://mediaonemarketing.com.sg"><br>
                    <label-fixed for="rankCheckerLanguage">Language:</label-fixed><br>
                    <input type="text" id="rankCheckerLanguage" value="English"><br>
                    <label-fixed for="rankCheckerLocation">Location:</label-fixed><br>
                    <input type="text" id="rankCheckerLocation" value="Singapore">
                    <br><br>
                    <button id="checkRanksButton" onclick="checkRanks()">Check Ranks</button>
                    <table id="rankCheckerResultsTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Keyword</th>
                            </tr>
                        </thead>
                        <tbody id="rankCheckerResultsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <hr>
            <div class="page-break"></div>
        </div>

        <div id="smmSection">
            <button class="collapsible" id="smm"><i class="fas fa-plus-square"></i><i
                    class="fas fa-share-alt"></i>Social
                Media (SMM)</button>
            <div class="content" id="socialMedia">
                <button class="collapsible" id="contentGeneratorButton"><i class="fas fa-plus-square"></i>Content
                    Generator</button>
                <div class="content" id="contentGenerator">
                    <form id="content-form">


                        <!-- --- NEW STRATEGIC FIELDS --- -->
                        <label for="post-role">What is the role of this post?</label>
                        <select id="post-role" name="post-role">
                            <option value="awareness">Build awareness</option>
                            <option value="trust">Build trust / credibility</option>
                            <option value="educate">Educate / explain</option>
                            <option value="consideration">Drive consideration</option>
                            <option value="action">Prompt action</option>
                        </select><br>
                        <label for="strategy-fit">Where does this post sit in the broader content strategy?</label>
                        <select id="strategy-fit" name="strategy-fit">
                            <option value="positioning">Brand positioning</option>
                            <option value="proof">Proof / credibility</option>
                            <option value="engagement">Community engagement</option>
                            <option value="campaign">Campaign support</option>
                            <option value="conversion">Conversion support</option>
                        </select><br><br>

                        <label for="core-message">Core Message (What is the one thing the audience must take
                            away?):</label>
                        <input type="text" id="core-message" name="core-message"
                            placeholder="e.g. Our tool saves 2 hours daily"><br><br>
                        <!-- ---------------------------- -->

                        <label for="subgroups">Sub-Groups (e.g. Badminton Players):</label>
                        <input type="text" id="subgroups" name="subgroups"><br>

                        <label for="painpoints">Pain Points (e.g. not enough time):</label>
                        <input type="text" id="painpoints" name="painpoints"><br>

                        <label for="audience_goal">Audience Goals (e.g. Convenience):</label>
                        <input type="text" id="audience_goal" name="audience_goal"><br>

                        <label for="generator_brand_guide_urls">URLs of Brand Guide PDFs (public
                            accessible):</label><br>
                        <textarea style="min-width: 90%; max-width: 90%;" id="generator_brand_guide_urls"
                            placeholder="Enter URLs separated by commas or newlines"></textarea><br>
                        <br>

                        <label for="sample-text">Sample Text/Post (Optional):</label><br>
                        <textarea id="sample-text" name="sample-text"></textarea><br><br>

                        <label for="reference-url">Reference Webpage URL (Optional):</label>
                        <textarea id="reference-url" name="reference-url"
                            placeholder="Enter URLs separated by commas or newlines"></textarea><br>

                        <label for="post-info">Content of Post:</label><br>
                        <textarea id="post-info" name="post-info"></textarea><br><br>

                        <div class="column">
                            <label for="product_service">Product / Service:</label>
                            <input type="text" id="product_service" name="product_service">
                            <br>

                            <label for="desired_action">Desired Action e.g. Contact us:</label>
                            <input type="text" id="desired_action" name="desired_action">
                            <br>

                            <div class="column">
                                <label for="content-type">Type of Content:</label><br>
                                <select id="content-type" name="content-type">
                                    <option value="blog-post">Blog Post</option>
                                    <option value="instagram-caption">Instagram Caption</option>
                                    <option value="facebook-post">Facebook Post</option>
                                    <option value="linkedin-post">LinkedIn Post</option>
                                </select>
                            </div>

                            <br>
                            <div class="column">
                                <label for="word_count">Word Count e.g. Long, 100 words:</label>
                                <input class="input-short" type="text" id="word_count" name="word_count">
                            </div>
                        </div>

                        <div class="column">
                            <label for="tone">Tone of Voice e.g. Luxury, Professional, Casual:</label>
                            <input type="text" id="tone" name="tone">
                            <br>

                            <!-- --- NEW BRAND POV FIELD --- -->
                            <label for="brand-pov">Brand POV / Stance:</label>
                            <select id="brand-pov" name="brand-pov">
                                <option value="authority">Confident authority</option>
                                <option value="guide">Helpful guide</option>
                                <option value="partner">Reassuring partner</option>
                                <option value="peer">Community peer</option>
                            </select>
                            <br>

                            <label for="usp">Unique Selling Point e.g. Available 24/7, Budget friendly:</label>
                            <input type="text" id="usp" name="usp"><br>

                            <!-- --- NEW LANGUAGE FIELD --- -->
                            <div class="column">
                                <label for="language">Language:</label><br>
                                <select id="language" name="language">
                                    <option value="english">English</option>
                                    <option value="chinese">Chinese</option>
                                </select>
                            </div>
                        </div>
                        <div style="clear: both;"></div>

                        <!-- --- NEW CONSTRAINTS FIELD --- -->
                        <label for="constraints">Constraints or Must-Include Info (e.g. Compliance, Pricing):</label>
                        <input type="text" id="constraints" name="constraints"
                            placeholder="Compliance wording, pricing disclaimer, etc."><br><br>

                        <button type="submit" id="generate-button">Generate Content</button>
                    </form>

                    <div id="generated-content"></div>
                </div>
                <!-- Social Media Comment Reply Generator -->
                <button class="collapsible" id="smmReplyButton">
                    <i class="fas fa-plus-square"></i><i class="fas fa-comments"></i> Social Media Response Generator
                </button>
                <div class="content" id="smmReplyContent">
                    <label for="smm-comment-input">Paste the Client's Comment:</label><br>
                    <textarea id="smm-comment-input" style="min-height: 120px; width: 90%;"
                        placeholder="e.g. I want to air my grieviance.."></textarea><br>

                    <label for="sensitivity">Precedent / Sensitivity Level:</label><br>
                    <select id="sensitivity" name="sensitivity">
                        <option value="routine">Routine (common issue)</option>
                        <option value="heightened">Heightened (repeated complaint / sensitive topic)</option>
                        <option value="high_risk">High-risk (legal, safety, regulatory, viral potential)</option>
                    </select>
                    <br>

                    <label for="response_objective">Response Objective:</label><br>
                    <select id="response_objective" name="response_objective">
                        <option value="de_escalate">De-escalate situation</option>
                        <option value="correct_misinformation">Correct misinformation</option>
                        <option value="demonstrate_accountability">Demonstrate accountability</option>
                        <option value="protect_brand_reputation">Protect brand reputation</option>
                        <option value="redirect_to_private_resolution">Redirect to private resolution</option>
                    </select>
                    <br>

                    <label for="response_platform">Platform:</label><br>
                    <select id="response_platform" name="response_platform">
                        <option value="meta">Meta / Facebook</option>
                        <option value="instagram">Instagram</option>
                        <option value="linkedin">LinkedIn</option>
                        <option value="tiktok">TikTok</option>
                    </select>
                    <br>

                    <label for="smm-instructions-input">Additional Instructions:</label><br>
                    <textarea id="smm-instructions-input" style="min-height: 120px; width: 90%;"
                        placeholder="e.g. These are the additional information for consideration.."></textarea><br>

                    <button type="button" id="generateSmmReplyBtn" onclick="generateHumanReply()">Generate
                        Reply</button>

                    <div id="smm-reply-display"
                        style="margin-top: 15px; padding: 20px; background-color: #ffffff; border-left: 5px solid #004c9d; border-radius: 10px; display: none; line-height: 1.6; font-size: 1.1em;">
                        <!-- Human-like text response will appear here -->
                    </div>
                </div>
            </div>
            <hr>
        </div>

        <div id="semSection">
            <div class="page-break"></div>
            <button class="collapsible" id="semButton"><i class="fas fa-plus-square"></i><i class="fas fa-ad"></i>Search
                Engine Marketing (SEM)</button>
            <div class="content" id="SEM">
                <label for="ad_format">Ad Formats:</label><br>
                <select id="ad_format" name="ad_format">
                    <option value="google-responsive-search-ads">Google Responsive Search Ads</option>
                    <option value="google-performance-max-ads">Google Performance Max Ads</option>
                    <option value="google-display-ads">Google Display Ads</option>
                    <option value="meta-image-ads">Meta Image Ads</option>
                    <option value="meta-video-ads">Meta Video Ads</option>
                    <option value="meta-carousel-ads">Meta Carousel Ads</option>
                    <option value="meta-collection-ads">Meta Collection Ads</option>
                    <option value="linkedin-image-ads">LinkedIn Image Ads</option>
                    <option value="linkedin-carousel-ads">LinkedIn Carousel Ads</option>
                    <option value="linkedin-video-ads">LinkedIn Video Ads</option>
                    <option value="linkedin-click-to-message-ads">LinkedIn Click To Message Ads</option>
                </select>
                <br>
                <label for="sem_webpages">Webpages (seperated by commas or new lines):</label><br>
                <textarea id="sem_webpages"
                    placeholder="e.g., https://example.com, https://another-example.com"></textarea>
                <br>
                <div class="column">
                    <label for="sem_country">Country:</label><br>
                    <input type="text" id="sem_country" value="Singapore"><br>
                </div>
                <div class="column">
                    <label for="sem_tone">Tone of Voice:</label><br>
                    <input type="text" id="sem_tone" value="Salesy"><br>
                </div>
                <div class="column">
                    <label for="sem_language">Language:</label><br>
                    <input type="text" id="sem_language" value="English"><br>
                </div>
                <div style="clear: both;"></div><br>
                <div class="toggle-container" id="semBrandFocus">
                    <span class="toggle-label">Don't Focus on Brand/Company</span>
                    <label class="switch">
                        <input type="checkbox" id="brand-checkbox" class="sliderMobile"> <span
                            class="slider round"></span>
                    </label>
                    <span class="toggle-label-right">Focus on Brand/Company</span>
                </div><br>
                <div class="toggle-container" id="semProductFocus">
                    <span class="toggle-label">Don't Focus on Products/Services</span>
                    <label class="switch">
                        <input type="checkbox" id="product-checkbox" class="sliderMobile" checked> <span
                            class="slider round"></span>
                    </label>
                    <span class="toggle-label-right">Focus on Products/Services</span>
                </div>
                <div style="clear: both;"></div>
                <br>
                <label for="sem_additional">Addtional Information (optional):</label><br>
                <textarea id="sem_additional"
                    placeholder="You can input information that is not found in the webpage(s) content or focus area(s) here"></textarea></textarea>

                <br>
                <button id="getProducts" onclick="semWebpageProducts()">Step 1: Identify
                    products/services/brand/company</button>
                <br>
                <div id="products"></div>
                <br>
                <button id="semAnalyse" onclick="semAnalyseWebsite()">Step 2: Generate KWs, USPs & Audience</button>
                <br>

                <div class="column" id="output"></div>
                <div class="column" id="selected" style="display:none;">
                    <h2>Selected</h2>
                    <textarea id="selectedText" rows="20"></textarea><br>
                    <button id="generateSem" onclick="generateGoogle()">Step 3: Select checkboxes then click
                        here</button>
                    <h2>Generated</h2>
                    <div id="generated"></div>
                </div>
                <div style="clear: both;"></div>
                <div> </div> <!-- Clearfix -->
            </div>
            <hr>
        </div>

        <div id="competitorsSection">
            <div class="page-break"></div>
            <button class="collapsible" id="competitionBtn"><i class="fas fa-plus-square"></i><i
                    class="fas fa-search"></i>Competitors Identifier</button>
            <div class="content" id="competitors_content">
                <div class="column50">
                    <label for="competitors-target1">Target Domain:</label>
                    <input type="url" id="competitors-target1" placeholder="e.g. www.abc.com"><br>
                    <label for="competitor_keywords">Keywords (seperated by commas or new
                        lines):</label><br>
                    <textarea id="competitor_keywords"></textarea><br>
                    <label for="competitors-language">Language:</label>
                    <input type="text" id="competitors-language" value="English" placeholder="e.g., English"><br>
                    <label for="competitors-location">Location:</label>
                    <input type="text" id="competitors-location" value="Singapore" placeholder="e.g., Singapore"><br>
                    <button id="getCompetitorsBtn" onclick="getCompetitors()">Get Competitors</button><br>
                    <div id="competitorsOutput" style="display:none;height:400px;overflow:auto;">
                        <br>
                    </div>
                </div>
                <div class="column50">
                    <label for="competitor_domains">Competitor Domains:</label><br>
                    <textarea id="competitor_domains"></textarea><br>
                    <button id="getIntersectionResults2" onclick="getIntersectionResults2()">
                        Get Intersection
                        Results</button><br>


                    <div id="getIntersectionResults"></div>
                    <div id="competitorsRanking" style="display:none;height:400px;overflow:auto;"></div>
                </div>
            </div>
            <hr>
        </div>

        <div id="personaSection">
            <div class="page-break"></div>
            <button class="collapsible" id="persona"><i class="fas fa-plus-square"></i><i
                    class="fas fa-users"></i>Persona
                Generator</button>
            <div class="content" id="persona_content">
                <label for="persona_webpages">Company / Product Information Webpages (seperated by commas or new
                    lines):</label><br>
                <textarea id="persona_webpages"
                    placeholder="e.g., https://example.com, https://another-example.com"></textarea><br>
                <label for="persona_manual">Any other information (optional):</label><br>
                <textarea id="persona_manual" placeholder="Focus on this product."></textarea>
                <button id="generatePersonaBtn" onclick="generatePersona()">Generate Personas</button>
                <div id="persona-results"></div>
                <button type="button" id="copy-persona-results-button" class="tooltip" style="display:none"
                    onclick="copyPersonaResults(event)">Copy to clipboard<span>Click to copy the persona results to your
                        clipboard.</span>
                </button>
            </div>
            <hr>
        </div>

        <div id="mediaPlanSection">
            <div class="page-break"></div>
            <button class="collapsible" id="mediaPlanBtn"><i class="fas fa-plus-square"></i><i
                    class="fas fa-bullseye"></i>Media Plan</button>
            <div class="content" id="mediaplan">
                <label for="MediaPlanWebpages">Company / Product Information Webpages (seperated by commas or new
                    lines):</label><br>
                <textarea id="MediaPlanWebpages"
                    placeholder="e.g., https://example.com, https://another-example.com"></textarea><br>
                <label for="MediaPlanBudget">Monthly Budget:</label><br>
                <input type="text" id="MediaPlanBudget" name="budget"><br>
                <label for="MediaPlanAdFormats">Preferred Ad Formats:</label><br>

                <input type="checkbox" checked class="media-plan-checkbox" id="MediaPlanAdFormatsGoogleDisplay"
                    name="MediaPlanAdFormatsGoogleDisplay" value="MediaPlanAdFormatsGoogleDisplay">
                <label for="MediaPlanAdFormatsGoogleDisplay">Google Display</label><br>
                <input type="checkbox" checked class="media-plan-checkbox" id="MediaPlanAdFormatsGoogleSearch"
                    name="MediaPlanAdFormatsGoogleSearch" value="MediaPlanAdFormatsGoogleSearch">
                <label for="MediaPlanAdFormatsGoogleSearch">Google Search</label><br>
                <input type="checkbox" checked class="media-plan-checkbox" id="MediaPlanAdFormatsFBIG"
                    name="MediaPlanAdFormatsFBIG" value="MediaPlanAdFormatsFBIG">
                <label for="MediaPlanAdFormatsFBIG">Facebook / Instagram</label><br>
                <input type="checkbox" checked class="media-plan-checkbox" id="MediaPlanAdFormatsLinkedIn"
                    name="MediaPlanAdFormatsLinkedIn" value="MediaPlanAdFormatsLinkedIn">
                <label for="MediaPlanAdFormatsLinkedIn">LinkedIn</label><br>
                <input type="checkbox" checked class="media-plan-checkbox" id="MediaPlanAdFormatsTikTok"
                    name="MediaPlanAdFormatsTikTok" value="MediaPlanAdFormatsTikTok">
                <label for="MediaPlanAdFormatsTikTok">TikTok</label><br><br>

                <label for="MediaPlanManual">Any other information (optional):</label><br>
                <textarea id="MediaPlanManual" placeholder="Focus on this product."></textarea><br>

                <button class="collapsible" id="mediaPlanOtherFieldsBtn">Other Fields (optional)</button>
                <div class="content" id="mediaplanothers">

                    <label for="MediaPlanOrganisationalObjectives">Organisational Objectives:</label><br>
                    <textarea id="MediaPlanOrganisationalObjectives"
                        placeholder="e.g., Increase brand awareness by 20%"></textarea><br>

                    <label for="MediaPlanLocation">Target Location:</label><br>
                    <input type="text" id="MediaPlanLocation" name="mediaPlanLocation"
                        placeholder="e.g., Singapore"><br>

                    <label for="MediaPlanTargetAudience">Target Audience:</label><br>
                    <input type="text" id="MediaPlanTargetAudience" name="mediaPlanTargetAudience"
                        placeholder="e.g., Millennials, Tech Enthusiasts"><br>

                    <label for="MediaPlanCustomerPersonas">Customer Personas:</label><br>
                    <textarea id="MediaPlanCustomerPersonas"
                        placeholder="Description of your ideal customers."></textarea><br>

                    <label for="MediaPlanTouchpoints">Customer Touchpoints:</label><br>
                    <textarea id="MediaPlanTouchpoints"
                        placeholder="List all interaction points a customer might have with your brand."></textarea><br>

                    <label for="MediaPlanContentStrategy">Content Strategy:</label><br>
                    <textarea id="MediaPlanContentStrategy"
                        placeholder="e.g., Blog posts, videos, infographics"></textarea><br>

                    <label for="MediaPlanLandingPages">Landing Pages:</label><br>
                    <textarea id="MediaPlanLandingPages" placeholder="URLs of relevant landing pages."></textarea><br>

                    <label for="MediaPlanCta">Calls-to-Action (CTAs):</label><br>
                    <textarea id="MediaPlanCta" placeholder="e.g., Sign up, Download, Buy Now"></textarea><br>

                    <label for="MediaPlanProductService">Specific Products/Services to Promote:</label><br>
                    <textarea id="MediaPlanProductService"
                        placeholder="List the products or services you want to highlight."></textarea><br>

                    <label for="MediaPlanKpis">Key Performance Indicators (KPIs):</label><br>
                    <textarea id="MediaPlanKpis"
                        placeholder="e.g., Engagement rate, Conversion rate, ROAS"></textarea><br>

                    <label for="MediaPlanCompetitiveAnalysis">Competitive Analysis:</label><br>
                    <textarea id="MediaPlanCompetitiveAnalysis"
                        placeholder="Information about your competitors' strategies."></textarea><br>

                    <label for="MediaPlanCompliance">Compliance and Regulations:</label><br>
                    <textarea id="MediaPlanCompliance"
                        placeholder="Relevant legal and industry regulations."></textarea><br>

                    <label for="MediaPlanTechnologyPlan">Technology Plan:</label><br>
                    <textarea id="MediaPlanTechnologyPlan"
                        placeholder="Marketing technologies and tools to be used."></textarea><br>

                    <label for="MediaPlanAnalyticsReporting">Analytics and Reporting:</label><br>
                    <textarea id="MediaPlanAnalyticsReporting"
                        placeholder="Processes for tracking and reporting performance."></textarea><br>

                </div>

                <button id="generateMediaPlanBtn" onclick="generateMediaPlan()">Generate Media Plan</button>
                <div id="mediaPlanPersonaResults" class="mediaPlanPersonaResults">
                    <hr>
                </div>
                <div id="mediaPlanResults"></div>

                <div class="funnel-container" id="funnel-container" style="display:none;">
                    <button class="funnel-collapsible-before"
                        style="background-color: #7554ae; width:100%;"><b>AWARENESS
                            (TOFU)</b>
                        <p id="awareness-summary">Attract a wider audience. Make your brand known using tactics like
                            SEO, social media, content marketing, and paid ads. The goal is to increase visibility and
                            spark
                            initial interest in your brand.</p>
                    </button>
                    <div class="funnel-content" style="background-color: #bba9d9;">
                        <p id="awareness-details">N.A.</p>
                    </div>

                    <button class="funnel-collapsible-before" style="background-color: #3a857d; width:90%;"><b>DISCOVERY
                            (MOFU)</b>
                        <p id="discovery-summary">Educate and engage your audience. Provide valuable information and
                            resources that help potential customers understand their problem and your potential
                            solution.
                            Content like ebooks, webinars, and helpful blog posts are key.</p>
                    </button>
                    <div class="funnel-content" style="background-color: #b8d1cf; width:90%;">
                        <p id="discovery-details">N.A.</p>
                    </div>

                    <button class="funnel-collapsible-before"
                        style="background-color: #e67c3a; width:80%;"><b>CONSIDERATION
                            (MOFU)</b>
                        <p id="consideration-summary">Showcase your value proposition. Demonstrate how your product or
                            service specifically solves the customer's needs and stands out from the competition. Use
                            case
                            studies, testimonials, product demos, and comparisons.</p>
                    </button>
                    <div class="funnel-content" style="background-color: #f0cbb4; width:80%;">
                        <p id="consideration-details">N.A.</p>
                    </div>

                    <button class="funnel-collapsible-before"
                        style="background-color: #e57373; width:70%;"><b>CONVERSION
                            (BOFU)</b>
                        <p id="conversion-summary">Drive action and close the sale. Make it easy for potential customers
                            to purchase by offering trials, discounts, consultations, or clear calls to action. Focus on
                            removing obstacles and building confidence in their decision.</p>
                    </button>
                    <div class="funnel-content" style="background-color: #f4c8c8; width:70%;">
                        <p id="conversion-details">N.A.</p>
                    </div>

                    <button class="funnel-collapsible-before"
                        style="background-color: #3a85c3; width:60%;"><b>RETENTION</b>
                        <p id="retention-summary">Foster loyalty. Provide ongoing value and build lasting relationships
                            with
                            your customers. Offer
                            personalized communications, loyalty programs, and exclusive offers to encourage repeat
                            purchases and
                            brand advocacy. Happy customers become your best marketers.</p>
                    </button>
                    <div class="funnel-content" style="background-color: #b2cfe7; width:60%;">
                        <p id="retention-details">N.A.</p>
                    </div>
                </div>
            </div>

            <hr>
        </div>

        <div id="contentCheckerSection">
            <div class="page-break"></div>
            <button class="collapsible" id="contentcheck"><i class="fas fa-plus-square"></i><i
                    class="fas fa-book-open"></i>Content Checker</button>
            <div class="content" id="content_check_content">
                <label for="brand_guide_urls">URLs of Guidelines PDFs (public accessible) e.g. brand guides:</label><br>
                <textarea id="brand_guide_urls"
                    placeholder="e.g., https://drive.google.com/file/d/xxxxxxxxx/view?usp=drive_link&#10https://another-example.com/sample.pdf"></textarea><br>
                <label for="content_check_other_urls">Any other website/guidelines URLs: </label><br>
                <textarea id="content_check_other_urls"
                    placeholder="https://regulations-for-industry-advertising.com/"></textarea><br>
                <label for="content_check_instructions">Any other instructions: </label><br>
                <textarea id="content_check_instructions"
                    placeholder="e.g Do not use the word 'cheap' in the content'"></textarea><br>
                <label for="content_to_check">Content to Check: </label><br>
                <textarea id="content_to_check" style="min-height: 200px;"
                    placeholder="Your content here"></textarea><br>
                <button id="contentCheckBtn" onclick="checkContent()">Check Content</button><br>
                <div id="checkContentResults"></div>
                <div style="display: flex; align-items: center;">
                    <button type="button" id="copy-check-results-button" class="tooltip" style="display:none"
                        onclick="copyCheckContentResults(event)">
                        <i class="fa fa-copy"></i>
                        <span>Click to copy the check results to your clipboard.</span>
                    </button>
                    <button id="openFeedbackModalBtn" style="display:none; margin-left: 10px;">Feedback</button>
                </div>
            </div>
            <hr>
        </div>

        <div id="landingPageAuditSection">
            <div class="page-break"></div>
            <button class="collapsible" id="landingPageAuditBtn"><i class="fas fa-plus-square"></i><i
                    class="fas fa-clipboard-check"></i>Landing Page
                Audit</button>
            <div class="content" id="landingPageAudit">
                <label for="landingPageUrl">Landing Page URL:</label><br>
                <input type="url" id="landingPageUrl" placeholder="e.g., https://example.com"><br>
                <label for="landingPageAuditKeyword">Target Keyword (optional):</label><br>
                <input type="text" id="landingPageAuditKeyword" name="landingPageAuditKeyword"><br>
                <button id="auditLandingPageBtn" onclick="auditLandingPageDirectWeb()">Audit Landing Page</button>
                <div class="gauge" id="gauge" style="display:none;">
                    <br>
                    <div class="gauge__body">
                        <div class="gauge__fill"></div>
                        <div class="gauge__cover"></div>
                        <br>
                    </div>
                    <br>
                </div>
                <div id="landingPageAuditResults"></div>
            </div>
            <hr>
        </div>

        <div id="aiContentOptimiserSection">
            <div class="page-break"></div>
            <button class="collapsible" id="aiContentOptimiserBtn"><i class="fas fa-plus-square"></i><i
                    class="fas fa-magic"></i>AI Content Optimiser</button>
            <div class="content" id="aiContentOptimiser">
                <!-- New Inputs Section -->
                <div style="margin-bottom: 20px;">
                    <div style="margin-bottom: 15px;">
                        <label for="optimiserPageUrl"
                            style="font-weight: normal; display: block; margin-bottom: 5px;">Page URL:</label>
                        <input type="url" id="optimiserPageUrl" value="https://mediaonemarketing.com.sg/seo-agency"
                            placeholder="e.g., https://example.com"
                            style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box;">
                    </div>
                    <div style="display: flex; gap: 20px;">
                        <div style="flex: 1;">
                            <label for="primaryKeyword"
                                style="font-weight: bold; display: flex; align-items: center; gap: 5px; margin-bottom: 5px;">
                                Primary Focus Keyword:
                                <span class="tooltip-container">
                                    <i class="fas fa-info-circle"
                                        style="color: #004c9d; cursor: help; font-size: 13px;"></i>
                                    <span class="tooltip-text">The most important keyword for this content. The AI will
                                        prioritize this above all else to ensure clear targeting. Keep it concise and
                                        highly targeted.</span>
                                </span>
                            </label>
                            <input type="text" id="primaryKeyword" value="seo agency" placeholder="e.g., seo agency"
                                style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box;">
                        </div>
                        <div style="flex: 1;">
                            <label for="secondaryKeywords"
                                style="font-weight: normal; display: flex; align-items: center; gap: 5px; margin-bottom: 5px;">
                                Secondary Keywords (one per line):
                                <span class="tooltip-container">
                                    <i class="fas fa-info-circle"
                                        style="color: #004c9d; cursor: help; font-size: 13px;"></i>
                                    <span class="tooltip-text">Additional keywords to include if they fit naturally.
                                        These will not dilute the main targeting. Include only truly relevant
                                        terms.</span>
                                </span>
                            </label>
                            <textarea id="secondaryKeywords" class="keyword-input-textarea"
                                placeholder="Enter secondary keywords here..." style="min-height: 80px;">seo marketing singapore
seo agencies in singapore
Best SEO Agency Singapore
Search Engine Optimisation Singapore
Digital Marketing Agency Singapore
SEO Services Singapore
Enterprise SEO Singapore</textarea>
                        </div>
                    </div>
                </div>

                <div class="optimiser-layout">
                    <!-- Main Editor Column -->
                    <div class="editor-main">
                        <div class="editor-container">
                            <div class="editor-header">
                                <div class="editor-title-container">
                                    <label style="width:5%;">Title</label>
                                    <input type="text" id="editorTitle" class="editor-title-input"
                                        value="Top-Rated SEO Agency in Singapore | MediaOne Marketing"
                                        placeholder="Enter post title...">
                                </div>
                                <div class="editor-metrics">
                                    <span>Word Count: <span id="editorHeaderWordCount">0</span></span>
                                </div>
                            </div>
                            <div class="editor-toolbar">
                                <div class="toolbar-row">
                                    <div class="toolbar-group">
                                        <button class="toolbar-btn" onclick="execCmd('undo')" title="Undo"><i
                                                class="fas fa-undo"></i></button>
                                        <button class="toolbar-btn" onclick="execCmd('redo')" title="Redo"><i
                                                class="fas fa-redo"></i></button>
                                    </div>
                                    <div class="toolbar-group">
                                        <button class="toolbar-btn" onclick="execCmd('bold')" title="Bold"><i
                                                class="fas fa-bold"></i></button>
                                        <button class="toolbar-btn" onclick="execCmd('italic')" title="Italic"><i
                                                class="fas fa-italic"></i></button>
                                        <button class="toolbar-btn" onclick="execCmd('strikeThrough')"
                                            title="Strikethrough"><i class="fas fa-strikethrough"></i></button>
                                        <button class="toolbar-btn" onclick="execCmd('formatBlock', 'pre')"
                                            title="Code"><i class="fas fa-code"></i></button>
                                        <button class="toolbar-btn" onclick="execCmd('underline')" title="Underline"><i
                                                class="fas fa-underline"></i></button>
                                    </div>
                                    <div class="toolbar-group">
                                        <button class="toolbar-btn" onclick="insertLink()" title="Insert Link"><i
                                                class="fas fa-link"></i></button>
                                        <button class="toolbar-btn"
                                            onclick="document.getElementById('imageUploadInput').click()"
                                            title="Upload Image"><i class="fas fa-upload"></i></button>
                                        <button class="toolbar-btn" onclick="insertImage()" title="Insert Image Link"><i
                                                class="fas fa-image"></i></button>
                                        <input type="file" id="imageUploadInput" style="display: none;" accept="image/*"
                                            onchange="handleLocalImageUpload(this)">
                                    </div>
                                    <div class="toolbar-group">
                                        <button class="toolbar-btn" onclick="execCmd('justifyLeft')"
                                            title="Align Left"><i class="fas fa-align-left"></i></button>
                                        <button class="toolbar-btn" onclick="execCmd('justifyCenter')"
                                            title="Align Center"><i class="fas fa-align-center"></i></button>
                                        <button class="toolbar-btn" onclick="execCmd('justifyRight')"
                                            title="Align Right"><i class="fas fa-align-right"></i></button>
                                    </div>
                                    <div class="toolbar-group">
                                        <button class="toolbar-btn" onclick="execCmd('formatBlock', 'H1')"
                                            title="Heading 1">H1</button>
                                        <button class="toolbar-btn" onclick="execCmd('formatBlock', 'H2')"
                                            title="Heading 2">H2</button>
                                        <button class="toolbar-btn" onclick="execCmd('formatBlock', 'H3')"
                                            title="Heading 3">H3</button>
                                    </div>
                                    <div class="toolbar-group">
                                        <button class="toolbar-btn" onclick="execCmd('insertUnorderedList')"
                                            title="Bullet List"><i class="fas fa-list-ul"></i></button>
                                        <button class="toolbar-btn" onclick="execCmd('insertOrderedList')"
                                            title="Numbered List"><i class="fas fa-list-ol"></i></button>
                                        <button class="toolbar-btn" onclick="execCmd('formatBlock', 'blockquote')"
                                            title="Quote"><i class="fas fa-quote-right"></i></button>
                                    </div>
                                    <div class="toolbar-group">
                                        <button class="toolbar-btn" onclick="insertTable()" title="Insert Table"><i
                                                class="fas fa-table"></i></button>
                                    </div>
                                </div>
                            </div>
                            <div id="editorContent" class="editor-content" contenteditable="true"
                                oninput="updateEditorMetrics()">
                                <h1>Top-Rated SEO Agency in Singapore | MediaOne Marketing</h1>
                                <p>As the leading <b>SEO agency</b> in Singapore, MediaOne Marketing is dedicated to
                                    helping businesses achieve unprecedented digital growth through strategic search
                                    engine optimisation. In today's competitive landscape, having a strong online
                                    presence is no longer optionalit's essential for survival and success. Our <b>SEO
                                        marketing Singapore</b> team combines years of expertise with cutting-edge
                                    technology to deliver results that truly matter across all industries.</p>
                                <h2>Why Work With One of the Best SEO Agencies in Singapore?</h2>
                                <p>Unlike other <b>seo agencies in singapore</b>, MediaOne takes a holistic approach to
                                    digital marketing. We understand that <b>SEO services Singapore</b> aren't just
                                    about rankings; they are about driving high-quality traffic that converts into loyal
                                    customers. Our enterprise SEO strategies are data-driven, ensuring that every move
                                    we make is backed by rigorous analysis and search volume insights. We don't just
                                    guess; we prove our value through consistent performance metrics.</p>
                                <h3>Our Specialized SEO Methodology</h3>
                                <p>Our process begins with finding high-intent keywords like <i>SEO marketing
                                        Singapore</i> and <i>best seo agency Singapore</i>. We then optimize your site's
                                    structure, content, and backlink profile to ensure maximum visibility on Google. As
                                    a full-service <b>digital marketing agency Singapore</b>, we don't just stop at
                                    technical SEO. We craft compelling content that speaks directly to your audience's
                                    needs, establishing your brand as a primary authority in your niche. By bridging the
                                    gap between user intent and technical excellence, we ensure long-term growth.</p>
                                <p>Whether you are a local SME or a global enterprise, our <b>Search Engine Optimisation
                                        Singapore</b> services are tailored to meet your specific goals and budgets. We
                                    focus on long-term sustainability, helping you climb the SERPs and stay there even
                                    through algorithm updates. Partner with MediaOne, the <b>SEO agency Singapore</b>
                                    trusts, and experience the difference that professional optimization can make for
                                    your bottom line. Let's transform your digital journey together into a success story
                                    that inspires others.</p>
                                <p>Our commitment to transparency means you get real-time reports and clear
                                    communication every step of the way. Stop leaving your traffic to chance and start
                                    dominating the search results today.</p>
                            </div>

                            <!-- Floating Selection Toolbar -->
                            <div id="selectionToolbar" class="selection-toolbar">
                                <button onclick="handleSelectionAction('rewrite')"><i class="fas fa-magic"></i>
                                    Rewrite</button>
                                <button onclick="handleSelectionAction('expand')"><i class="fas fa-expand-alt"></i>
                                    Expand</button>
                                <button onclick="handleSelectionAction('shorten')"><i class="fas fa-compress-alt"></i>
                                    Shorten</button>
                                <div class="st-separator"></div>
                                <button class="st-settings" onclick="openAiSettingsModal()"><i
                                        class="fas fa-cog"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Right Sidebar -->
                    <div class="sidebar-right">
                        <!-- Panel 1: SEO Analysis -->
                        <div class="sidebar-card">
                            <div class="gauge-container">
                                <svg class="gauge-svg" viewBox="0 0 160 160">
                                    <circle class="gauge-bg" cx="80" cy="80" r="70"></circle>
                                    <circle id="seoScoreGauge" class="gauge-fill" cx="80" cy="80" r="70"
                                        style="stroke-dashoffset: 440;"></circle>
                                </svg>
                                <div class="gauge-text">
                                    <span id="seoScoreValue" class="gauge-score">0</span>
                                    <span class="gauge-label">SEO Score</span>
                                </div>
                            </div>

                            <div class="metric-item">
                                <div class="metric-header"><span>Title</span><span id="titleScore">0%</span></div>
                                <div class="progress-bar-bg">
                                    <div id="titleBar" class="progress-bar-fill" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-header"><span>Headings</span><span id="headingsScore">0%</span></div>
                                <div class="progress-bar-bg">
                                    <div id="headingsBar" class="progress-bar-fill" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-header"><span>Readability</span><span id="readabilityScore">0%</span>
                                </div>
                                <div class="progress-bar-bg">
                                    <div id="readabilityBar" class="progress-bar-fill" style="width: 0%;"></div>
                                </div>
                            </div>

                            <div class="stats-row">
                                <div class="stats-item"><i class="fas fa-file-alt"></i> Words: <span
                                        id="wordCount">0</span></div>
                                <div class="stats-item"><i class="fas fa-font"></i> Chars: <span
                                        id="charCountStat">0</span></div>
                            </div>
                            <div class="stats-row" style="margin-top: -10px;">
                                <div class="stats-item"><i class="fas fa-coins"></i> Tokens (est): <span
                                        id="tokenCount">0</span></div>
                            </div>

                            <button class="btn-gradient btn-seo" onclick="runSeoAnalysis()">
                                <i class="fas fa-search"></i> Run SEO Analysis
                            </button>
                        </div>

                        <!-- Panel 2: Intelligence Tabs -->
                        <div class="sidebar-card" style="padding: 15px;">
                            <div class="sidebar-tabs">
                                <button class="tab-btn active" onclick="switchOptimiserTab('keywords')"><i
                                        class="fas fa-chart-bar"></i>Keywords</button>
                                <button class="tab-btn" onclick="switchOptimiserTab('ai')"><i
                                        class="fas fa-magic"></i>AI</button>
                                <button class="tab-btn" onclick="switchOptimiserTab('check')"><i
                                        class="fas fa-check-circle"></i>Check</button>
                            </div>

                            <!-- Keywords Tab -->
                            <div id="tab-keywords" class="tab-content active">
                                <button class="btn-gradient btn-keywords" style="background: #004c9d;"
                                    onclick="analyzeKeywordFrequency()">
                                    <i class="fas fa-sync-alt"></i> Re-analyze Keywords
                                </button>
                                <div
                                    style="font-size: 13px; color: #666; display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Keywords Found: <b id="kwsFound">0</b></span>
                                    <span>Total Words: <b id="totalWordsStat">0</b></span>
                                </div>
                                <div id="keywordFrequencyList" class="keyword-freq-list">
                                    <p style="text-align: center; color: #999; font-style: italic; margin-top:20px;">No
                                        keywords analyzed yet.</p>
                                </div>
                            </div>

                            <!-- AI Tab -->
                            <div id="tab-ai" class="tab-content">
                                <div style="font-weight: 600; font-size: 14px; margin-bottom: 10px;">Generate Content
                                </div>
                                <textarea id="aiPrompt" class="ai-prompt-area"
                                    placeholder="e.g., Write a paragraph about benefits of SEO..."></textarea>
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <button id="btnAiGenerate" class="btn-gradient"
                                        style="background: #004c9d; flex: 1;" onclick="aiGenerateContent()">
                                        <i class="fas fa-magic"></i> Generate
                                    </button>
                                    <button id="btnAiContinue" class="btn-gradient"
                                        style="background: #004c9d; flex: 1;" onclick="aiContinueWriting()">
                                        <i class="fas fa-pen"></i> Continue
                                    </button>
                                </div>
                            </div>

                            <!-- Check Tab -->
                            <div id="tab-check" class="tab-content">
                                <button class="btn-gradient" style="background: #004c9d; margin-bottom: 20px;"
                                    onclick="runPlagiarismCheck()">
                                    <i class="fas fa-search"></i> Check Plagiarism
                                </button>
                                <div class="sidebar-card"
                                    style="border: 1px solid #eee; padding: 15px; margin-bottom: 15px;">
                                    <div id="plagiarismScore"
                                        style="font-size: 32px; font-weight: 800; text-align: center; color: #2b8a3e;">
                                        100.0%</div>
                                    <div style="text-align: center; font-weight: 600; color: #333;">Excellent</div>
                                    <div style="text-align: center; font-size: 13px; color: #888;">Originality Score
                                    </div>
                                    <div id="plagiarismMeta"
                                        style="text-align: center; font-size: 13px; color: #555; margin-top: 10px;">0
                                        words  0 match(es)</div>
                                </div>
                                <div id="plagiarismStatus" class="status-box">
                                    <i class="fas fa-check-circle"></i>
                                    <div>
                                        <div id="plagiarismTitle">No Plagiarism Detected</div>
                                        <div id="plagiarismMsg"
                                            style="font-size: 12px; font-weight: 400; opacity: 0.8;">Your content
                                            appears to be original.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button id="goToTop-button" onclick="openJourneyModal()"
        style="position: fixed; bottom: 10px; right: 245px; background-color: #d89030; color: white; border: none; padding: 10px 20px; border-radius: 100px; cursor: pointer; z-index: 1000; font-size:1.2em;box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.7);">
        <i class="fas fa-route"></i>
    </button>

    <button id="cleanup-button" onclick="clearPageState()"
        style="position: fixed; bottom: 10px; right: 80px; background-color: hsl(0, 71%, 49%); color: white; border: none; padding: 10px 20px; border-radius: 100px; cursor: pointer; z-index: 1000; font-size:1.2em;box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.7);">
        Clear Data <i class="fas fa-trash-alt" style="margin-left: 10px;"></i>
    </button>
    <button id="chatbot-button"
        style="position: fixed; bottom: 10px; right: 10px; background-color: hsl(118, 40%, 43%); color: white; border: none; padding: 10px 20px; border-radius: 100px; cursor: pointer; z-index: 1000; font-size:1.2em;box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.7);">
        <i class="fas fa-comment-dots"></i>
    </button>

    <script id="local-business-template" type="text/x-handlebars-template">
        <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
        <label for="address">Address:</label><input type="text" id="address" oninput="updateSchema()"><br>
        <label for="telephone">Telephone:</label><input type="text" id="telephone" oninput="updateSchema()"><br>
      </script>

    <script id="product-template" type="text/x-handlebars-template">
          <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
          <label for="description">Description:</label><input type="text" id="description" oninput="updateSchema()"><br>
          <label for="brand">Brand:</label><input type="text" id="brand" oninput="updateSchema()"><br>
      </script>

    <script id="event-template" type="text/x-handlebars-template">
          <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
          <label for="startDate">Start Date:</label><input type="date" id="startDate" oninput="updateSchema()"><br>
          <label for="location">Location:</label><input type="text" id="location" oninput="updateSchema()"><br>
          <label for="description">Description:</label><textarea id="description" oninput="updateSchema()"></textarea><br>
      </script>

    <script id="article-template" type="text/x-handlebars-template">
          <label for="headline">Headline:</label><input type="text" id="headline" oninput="updateSchema()"><br>
          <label for="author">Author:</label><input type="text" id="author" oninput="updateSchema()"><br>
          <label for="datePublished">Date Published:</label><input type="date" id="datePublished" oninput="updateSchema()"><br>
          <label for="articleBody">Article Body:</label><textarea id="articleBody" oninput="updateSchema()"></textarea><br>
      </script>

    <script id="breadcrumblist-template" type="text/x-handlebars-template">
          <div id="breadcrumb-items">
              <div class="breadcrumb-item">
                  <input type="text" id="name1" placeholder="Page #1's name" oninput="updateSchema()">
                  <input type="url" id="url1" placeholder="URL #1" oninput="updateSchema()">
                  <button class="remove-item" onclick="removeItem(this)">x</button>
              </div>
              <div class="breadcrumb-item">
                  <input type="text" id="name2" placeholder="Page #2's name" oninput="updateSchema()">
                  <input type="url" id="url2" placeholder="URL #2" oninput="updateSchema()">
                   <button class="remove-item" onclick="removeItem(this)">x</button>
              </div>
          </div>
          <button onclick="addItem()"> + ADD URL </button>
      
        </script>

    <script id="faqpage-template" type="text/x-handlebars-template">
          <div id="faq-items">
              <div class="faq-item">
                  <input type="text" id="question1" placeholder="Question #1" oninput="updateSchema()">
                  <textarea id="answer1" placeholder="Answer" oninput="updateSchema()"></textarea>
                  <button class="remove-item" onclick="removeFaqItem(this)">x</button> <br>
              </div>
          </div>
          <button onclick="addFaqItem()">+ ADD QUESTION</button>
      </script>
    <script id="howto-template" type="text/x-handlebars-template">
          <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
          <label for="description">Description:</label><textarea id="description" oninput="updateSchema()"></textarea><br>
          <label for="supply">Supply (JSON-LD array of HowToSupply objects):</label><textarea id="supply" class="json-ld" oninput="updateSchema()"></textarea><br>
          <label for="step">Steps (JSON-LD array of HowToStep objects):</label><textarea id="step" class="json-ld" oninput="updateSchema()"></textarea><br>
          * See schema.org/HowTo for details on HowToSupply and HowToStep structure.
        </script>

    <script id="jobposting-template" type="text/x-handlebars-template">
          <label for="title">Job Title:</label><input type="text" id="title" oninput="updateSchema()"><br>
          <label for="description">Job Description:</label><textarea id="description" oninput="updateSchema()"></textarea><br>
          <label for="datePosted">Date Posted:</label><input type="date" id="datePosted" oninput="updateSchema()"><br>
          <label for="employmentType">Employment Type:</label><input type="text" id="employmentType" oninput="updateSchema()"><br>
          <label for="hiringOrganization">Hiring Organization (Name):</label><input type="text" id="hiringOrganization_name" oninput="updateSchema()"><br>
         <label for="hiringOrganization">Hiring Organization (Website):</label><input type="url" id="hiringOrganization_sameAs" oninput="updateSchema()"><br>
        </script>


    <script id="organization-template" type="text/x-handlebars-template">
          <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
          <label for="url">URL:</label><input type="url" id="url" oninput="updateSchema()"><br>
          <label for="logo">Logo URL:</label><input type="url" id="logo" oninput="updateSchema()"><br>
        </script>

    <script id="person-template" type="text/x-handlebars-template">
          <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
          <label for="jobTitle">Job Title:</label><input type="text" id="jobTitle" oninput="updateSchema()"><br>
        
        </script>


    <script id="video-object-template" type="text/x-handlebars-template">
            <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
            <label for="description">Description:</label><input type="text" id="description" oninput="updateSchema()"><br>
            <label for="uploadDate">Upload Date:</label><input type="date" id="uploadDate" oninput="updateSchema()"><br>
            <label for="thumbnailUrl">Thumbnail URL:</label><input type="url" id="thumbnailUrl" oninput="updateSchema()"><br>
        </script>

    <script id="website-template" type="text/x-handlebars-template">
            <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
            <label for="url">URL:</label><input type="url" id="url" oninput="updateSchema()"><br>
        </script>

    <script>

        document.addEventListener('DOMContentLoaded', function () {
            const collapsibles = document.querySelectorAll('.collapsible'); // Select all collapsibles
            collapsibles.forEach(collapsible => {
                collapsible.addEventListener('click', function () {
                    this.classList.toggle('active');
                    const content = this.nextElementSibling;

                    const icon = this.querySelector('i');

                    if (icon) {
                        if (icon.classList.contains('fa-plus-square')) {
                            icon.classList.remove('fa-plus-square');
                            icon.classList.add('fa-minus-square');
                        } else {
                            icon.classList.remove('fa-minus-square');
                            icon.classList.add('fa-plus-square');
                        }
                    }

                    content.style.display = content.style.display === 'block' ? 'none' : 'block';
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            const collapsibles = document.querySelectorAll('.collapsible-plus'); // Select all collapsibles
            collapsibles.forEach(collapsible => {
                collapsible.addEventListener('click', function () {
                    const icon = this.querySelector('i'); // Select the <i> element
                    const content = this.nextElementSibling.nextElementSibling; //Select the actual content

                    if (!content) {
                        console.warn("No content found after the .collapsible");
                        return;
                    }
                    icon.classList.toggle('fa-plus-square');
                    icon.classList.toggle('fa-minus-square');

                    content.style.display = content.style.display === 'block' ? 'none' : 'block';
                });
            });
        });

        function addFaqItem() {
            faqItemCount++;
            const faqItemsDiv = document.getElementById('faq-items');
            const newItem = document.createElement('div');
            newItem.className = "faq-item";
            newItem.innerHTML = `
        <input type="text" id="question${faqItemCount}" placeholder="Question #${faqItemCount}" oninput="updateSchema()">
        <textarea type="text" id="answer${faqItemCount}" placeholder="Answer" oninput="updateSchema()"></textarea>
        <button class="remove-item" onclick="removeFaqItem(this)">x</button>
    `;
            faqItemsDiv.appendChild(newItem);

            // Attach event listeners to new elements
            newItem.querySelectorAll('input, textarea').forEach(input => {
                input.addEventListener('input', updateSchema);
            });

            updateSchema();
        }

        function deactivateAllButtons() {
            const buttons = document.querySelectorAll('button.collapsible'); // Select all collapsible buttons
            buttons.forEach(button => {
                button.classList.remove('active'); // Remove the 'active' class
                const content = button.nextElementSibling; // Get the content div
                if (content) {
                    content.style.display = 'none'; // Hide the content
                }

                button.style.backgroundColor = "#004c9d"; // Reset color

                // Remove active class from menu items
                const navbarLinks = document.querySelectorAll('#navbar a');
                navbarLinks.forEach(link => link.classList.remove('active-menu'));


            });
        }

        function showSeoOnly(event) {
            document.getElementById('seoSection').style.display = "block";
            document.getElementById('smmSection').style.display = "none";
            document.getElementById('semSection').style.display = "none";
            document.getElementById('competitorsSection').style.display = "none";
            document.getElementById('personaSection').style.display = "none";
            document.getElementById('mediaPlanSection').style.display = "none";
            document.getElementById('contentCheckerSection').style.display = "none";
            document.getElementById('landingPageAuditSection').style.display = "none";
            document.getElementById('aiContentOptimiserSection').style.display = "none";
        }

        function showSmmOnly(event) {
            document.getElementById('seoSection').style.display = "none";
            document.getElementById('smmSection').style.display = "block";
            document.getElementById('semSection').style.display = "none";
            document.getElementById('competitorsSection').style.display = "none";
            document.getElementById('personaSection').style.display = "none";
            document.getElementById('mediaPlanSection').style.display = "none";
            document.getElementById('contentCheckerSection').style.display = "none";
            document.getElementById('landingPageAuditSection').style.display = "none";
            document.getElementById('aiContentOptimiserSection').style.display = "none";
        }

        function showSemOnly(event) {
            document.getElementById('seoSection').style.display = "none";
            document.getElementById('smmSection').style.display = "none";
            document.getElementById('semSection').style.display = "block";
            document.getElementById('competitorsSection').style.display = "none";
            document.getElementById('personaSection').style.display = "none";
            document.getElementById('mediaPlanSection').style.display = "none";
            document.getElementById('contentCheckerSection').style.display = "none";
            document.getElementById('landingPageAuditSection').style.display = "none";
            document.getElementById('aiContentOptimiserSection').style.display = "none";
        }

        function showOthersOnly(event) {
            document.getElementById('seoSection').style.display = "none";
            document.getElementById('smmSection').style.display = "none";
            document.getElementById('semSection').style.display = "none";
            document.getElementById('competitorsSection').style.display = "block";
            document.getElementById('personaSection').style.display = "block";
            document.getElementById('mediaPlanSection').style.display = "block";
            document.getElementById('contentCheckerSection').style.display = "block";
            document.getElementById('landingPageAuditSection').style.display = "block";
            document.getElementById('aiContentOptimiserSection').style.display = "block";
        }

        function openKeywordAnalysis(event) {
            showSeoOnly(event)
            event.preventDefault();
            deactivateAllButtons();
            const seoButton = document.querySelector('button#seo');
            if (seoButton) {
                seoButton.classList.toggle('active');
                const content = seoButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const keywordAnalysisLink = event.currentTarget;
                keywordAnalysisLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const keywordAnalysisSection = document.getElementById('seo');
                    if (keywordAnalysisSection) {
                        keywordAnalysisSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        function openTechnicalSeo(event) {
            showSeoOnly(event)
            event.preventDefault();
            deactivateAllButtons();
            openSeo(event);
            Button = document.querySelector('button#technicalButton');
            if (Button) {
                Button.classList.toggle('active');
                const content = Button.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const technicalSeoLink = event.currentTarget;
                technicalSeoLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const technicalSeoSection = document.getElementById('technicalButton');
                    if (technicalSeoSection) {
                        technicalSeoSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        function openCrawlerSimulator(event) {
            event.preventDefault();
            deactivateAllButtons();
            openSeo(event);
            Button = document.querySelector('button#simulatorButton');
            if (Button) {
                Button.classList.toggle('active');
                const content = Button.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const simulatorLink = event.currentTarget;
                simulatorLink.classList.toggle('active-menu');

                const icon = document.getElementById('simulatorButton').querySelector('i');
                if (icon && icon.classList.contains('fa-plus-square')) {
                    icon.classList.remove('fa-plus-square');
                    icon.classList.add('fa-minus-square');
                }

                if (content.style.display === "block") {
                    const simulatorSection = document.getElementById('simulatorButton');
                    if (simulatorSection) {
                        simulatorSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        function openContentComparison(event) {
            event.preventDefault();
            deactivateAllButtons();
            openSeo(event);
            Button = document.querySelector('button#contentComparisonButton');
            if (Button) {
                Button.classList.toggle('active');
                const content = Button.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const contentComparisonLink = event.currentTarget;
                contentComparisonLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const contentComparisonSection = document.getElementById('contentComparisonButton');
                    if (contentComparisonSection) {
                        contentComparisonSection.scrollIntoView({ behavior: 'smooth' });
                    }

                }
            }
            closeJourneyModal();
        }

        function openSchemaGenerator(event) {
            showSeoOnly(event)
            event.preventDefault();
            deactivateAllButtons();
            openSeo(event);
            Button = document.querySelector('button#schemaGeneratorButton');
            if (Button) {
                Button.classList.toggle('active');
                const content = Button.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const schemaGeneratorLink = event.currentTarget;
                schemaGeneratorLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const schemaGeneratorSection = document.getElementById('schemaGeneratorButton');
                    if (schemaGeneratorSection) {
                        schemaGeneratorSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }


        function openOnPage(event) {
            showSeoOnly(event)
            event.preventDefault();
            deactivateAllButtons();
            openSeo(event);
            Button = document.querySelector('button#onPageButton');
            if (Button) {
                Button.classList.toggle('active');
                const content = Button.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const schemaGeneratorLink = event.currentTarget;
                schemaGeneratorLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const schemaGeneratorSection = document.getElementById('onPageButton');
                    if (schemaGeneratorSection) {
                        schemaGeneratorSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        function openRankChecker(event) {
            showSeoOnly(event)
            event.preventDefault();
            deactivateAllButtons();
            openSeo(event);
            Button = document.querySelector('button#rankCheckerButton');
            if (Button) {
                Button.classList.toggle('active');
                const content = Button.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const schemaGeneratorLink = event.currentTarget;
                schemaGeneratorLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const schemaGeneratorSection = document.getElementById('rankCheckerButton');
                    if (schemaGeneratorSection) {
                        schemaGeneratorSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        function openContentGenerator(event) {
            event.preventDefault();
            deactivateAllButtons();
            const smmButton = document.querySelector('button#smm');
            if (smmButton) {
                smmButton.classList.toggle('active');
                const content = smmButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const smmLink = event.currentTarget;
                smmLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const smmSection = document.getElementById('smm');
                    if (smmSection) {
                        smmSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            Button = document.querySelector('button#contentGeneratorButton');
            if (Button) {
                Button.classList.toggle('active');
                const content = Button.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const contentGeneratorLink = event.currentTarget;
                contentGeneratorLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const contentGeneratorSection = document.getElementById('smm');
                    if (contentGeneratorSection) {
                        contentGeneratorSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        function openResponseGenerator(event) {
            event.preventDefault();
            deactivateAllButtons();
            const smmButton = document.querySelector('button#smm');
            if (smmButton) {
                smmButton.classList.toggle('active');
                const content = smmButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const smmLink = event.currentTarget;
                smmLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const smmSection = document.getElementById('smm');
                    if (smmSection) {
                        smmSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            Button = document.querySelector('button#smmReplyButton');
            if (Button) {
                Button.classList.toggle('active');
                const content = Button.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const responseGeneratorLink = event.currentTarget;
                responseGeneratorLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const contentGeneratorSection = document.getElementById('smm');
                    if (contentGeneratorSection) {
                        contentGeneratorSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        function openSem(event) {
            event.preventDefault();
            deactivateAllButtons();

            showSemOnly(event);

            const semButton = document.querySelector('button#semButton');
            if (semButton) {
                semButton.classList.toggle('active');
                const content = semButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const semLink = event.currentTarget;
                semLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const semSection = document.getElementById('semButton');
                    if (semSection) {
                        semSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        function openCompetitors(event) {
            event.preventDefault();
            deactivateAllButtons();

            showOthersOnly(event);

            const competitorsButton = document.querySelector('button#competitionBtn');
            if (competitorsButton) {
                competitorsButton.classList.toggle('active');
                const content = competitorsButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const competitorsLink = event.currentTarget;
                competitorsLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const competitorsSection = document.getElementById('competitionBtn');
                    if (competitorsSection) {
                        competitorsSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        function openPersona(event) {
            event.preventDefault();
            deactivateAllButtons();

            const personaButton = document.querySelector('button#persona');
            if (personaButton) {
                personaButton.classList.toggle('active');
                const content = personaButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const personaLink = event.currentTarget;
                personaLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const personaSection = document.getElementById('persona');
                    if (personaSection) {
                        personaSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        function openMediaPlan(event) {
            event.preventDefault();
            deactivateAllButtons();

            const mediaPlanButton = document.querySelector('button#mediaPlanBtn');
            if (mediaPlanButton) {
                mediaPlanButton.classList.toggle('active');
                const content = mediaPlanButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const mediaPlanLink = event.currentTarget;
                mediaPlanLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const mediaPlanSection = document.getElementById('mediaPlanBtn');
                    if (mediaPlanSection) {
                        mediaPlanSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        function openContentCheck(event) {
            event.preventDefault();
            deactivateAllButtons();

            const contentCheckButton = document.querySelector('button#contentcheck');
            if (contentCheckButton) {
                contentCheckButton.classList.toggle('active');
                const content = contentCheckButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const contentCheckLink = event.currentTarget;
                contentCheckLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const contentCheckSection = document.getElementById('contentcheck');
                    if (contentCheckSection) {
                        // Get the element *before* contentCheckSection
                        let previousElement = contentCheckSection.previousElementSibling;

                        // Scroll to the previous element if it exists
                        if (previousElement) {
                            previousElement.scrollIntoView({ behavior: 'smooth', block: 'start' }); // block: 'start' is important for precise positioning
                        } else {
                            // If there's no previous element (e.g., contentCheckSection is the first child),
                            // scroll to the top of the contentCheckSection instead (or handle as desired)
                            contentCheckSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                }
            }
            closeJourneyModal();
        }

        function openAiContentOptimiser(event) {
            event.preventDefault();
            deactivateAllButtons();

            const aiOptimiserButton = document.querySelector('button#aiContentOptimiserBtn');
            if (aiOptimiserButton) {
                aiOptimiserButton.classList.toggle('active');
                const content = aiOptimiserButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const aiOptimiserLink = event.currentTarget;
                aiOptimiserLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const aiOptimiserSection = document.getElementById('aiContentOptimiser');
                    if (aiOptimiserSection) {
                        aiOptimiserSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        function execCmd(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('editorContent').focus();
        }

        function insertLink() {
            const url = prompt("Enter the URL:");
            if (url) execCmd('createLink', url);
        }

        function insertImage() {
            const url = prompt("Enter the Image URL:");
            if (url) {
                const imgId = "img_" + Date.now();
                const imgHtml = `
                    <div class="img-optimiser-wrapper" id="wrap_${imgId}" style="position: relative; display: inline-block; margin: 15px 0; max-width: 100%;">
                        <img id="${imgId}" src="${url}" style="max-width: 100%; border-radius: 6px; display: block;" 
                             onmouseover="showImageTool(this)" onmouseout="hideImageTool(this)">
                        <div class="img-tool-overlay" id="overlay_${imgId}" style="display: none; position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; z-index: 10; width: 250px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div style="color: white; font-size: 12px; font-weight: bold;">Alt Text:</div>
                                <button onclick="generateAiAlt('${imgId}')" style="background: #004c9d; color: white; border: none; padding: 3px 6px; border-radius: 4px; cursor: pointer; font-size: 10px;" title="AI Generate"> AI</button>
                            </div>
                            <textarea id="alt_${imgId}" placeholder="Enter alt text..." 
                                      style="width: 100%; box-sizing: border-box; padding: 5px; font-size: 11px; border-radius: 4px; border: none; resize: none; min-height: 45px; max-height: 200px; font-family: inherit; line-height: 1.4; overflow-y: hidden;" 
                                      oninput="updateImgAlt('${imgId}', this.value); autoResizeAlt(this)"></textarea>
                            <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 8px; width: 100%; background: #f44336; color: white; border: none; padding: 5px; border-radius: 4px; cursor: pointer; font-size: 11px;">Remove Image</button>
                        </div>
                        <div class="img-resize-handle" onmousedown="startImgResize(event, '${imgId}')"></div>
                    </div>
                `;
                execCmd('insertHTML', imgHtml);
            }
        }

        function insertTable() {
            const rows = prompt("Number of rows:", 3);
            const cols = prompt("Number of columns:", 3);
            if (rows && cols) {
                let table = '<table border="1" style="width:100%; border-collapse: collapse;">';
                for (let i = 0; i < rows; i++) {
                    table += '<tr>';
                    for (let j = 0; j < cols; j++) {
                        table += '<td style="padding: 10px; border: 1px solid #ddd;">&nbsp;</td>';
                    }
                    table += '</tr>';
                }
                table += '</table><p>&nbsp;</p>';
                execCmd('insertHTML', table);
            }
        }

        // AI Content Optimiser Logic
        function switchOptimiserTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            const btn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.innerText.toLowerCase().includes(tabId));
            if (btn) btn.classList.add('active');

            const content = document.getElementById(`tab-${tabId}`);
            if (content) content.classList.add('active');
        }

        function updateEditorMetrics() {
            const editor = document.getElementById('editorContent');
            const text = editor.innerText || "";
            const charCount = text.length;
            const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
            const tokenCount = Math.ceil(wordCount * 1.3);

            if (document.getElementById('editorHeaderWordCount')) document.getElementById('editorHeaderWordCount').innerText = wordCount;
            document.getElementById('wordCount').innerText = wordCount;
            document.getElementById('charCountStat').innerText = charCount;
            document.getElementById('tokenCount').innerText = tokenCount;
            if (document.getElementById('totalWordsStat')) document.getElementById('totalWordsStat').innerText = wordCount;
        }

        // Configuration for AI Content Optimiser Lambda Endpoints
        const OPTIMISER_ENDPOINTS = {
            SEO_ANALYSIS: 'https://diyjtwnt4l.execute-api.ap-southeast-1.amazonaws.com/seoContentAnalysisScore',
            CONTENT_AI: 'https://0oes56fj4l.execute-api.ap-southeast-1.amazonaws.com/aiOptimiser',
            KEYWORD_FREQ: 'https://qtd6t9voui.execute-api.ap-southeast-1.amazonaws.com/keywordFrequency',
            PLAGIARISM: 'https://tg6m9b7gsj.execute-api.ap-southeast-1.amazonaws.com/plagarismCheck',
            IMAGE_ALT: 'https://ty3ndlwcnk.execute-api.ap-southeast-1.amazonaws.com/altTextGenerator'
        };

        /**
         * Robustly parse response from Lambda.
         * Handles cases where the response is a direct object or wrapped in a 'body' string (Proxy Integration).
         */
        function parseLambdaResponse(data) {
            if (data && data.body && typeof data.body === 'string') {
                try {
                    return JSON.parse(data.body);
                } catch (e) {
                    console.error("Failed to parse Lambda body string:", e);
                    return data;
                }
            }
            return data;
        }

        /**
         * Simple Markdown-to-HTML formatter
         */
        function formatMarkdown(text) {
            if (!text) return "";
            let html = text;

            // Headings (match from deepest to shallowest)
            html = html.replace(/^### (.*$)/gim, '<h5>$1</h5>');
            html = html.replace(/^## (.*$)/gim, '<h4>$1</h4>'); // Using offset levels for editor context
            html = html.replace(/^# (.*$)/gim, '<h3>$1</h3>');

            // User requested: # -> h2, ## -> h3 (but we adjust one level down for better flow in editor)
            // Let's stick to user request mapping if they were specific:
            // "change the '#' to h2 headers, '##' to h3 headers"
            html = text
                .replace(/^### (.*$)/gim, '<h4>$1</h4>')
                .replace(/^## (.*$)/gim, '<h3>$1</h3>')
                .replace(/^# (.*$)/gim, '<h2>$1</h2>')
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                .replace(/\n/g, '<br>');

            return html;
        }

        function updateMetricGauge(id, percent) {
            const gauge = document.getElementById(id);
            const valueDisplay = document.getElementById('seoScoreValue');
            const offset = 440 - (percent / 100) * 440;
            gauge.style.strokeDashoffset = offset;
            valueDisplay.innerText = percent;

            if (percent > 80) gauge.style.stroke = "#4caf50";
            else if (percent > 50) gauge.style.stroke = "#ff9800";
            else gauge.style.stroke = "#f44336";
        }

        async function runSeoAnalysis() {
            const btn = document.querySelector('.btn-seo');
            const originalContent = btn.innerHTML;
            const content = document.getElementById('editorContent').innerHTML;
            const title = document.getElementById('editorTitle').value;

            if (OPTIMISER_ENDPOINTS.SEO_ANALYSIS === 'YOUR_SEO_ANALYSIS_LAMBDA_URL') {
                alert("Please configure the SEO Analysis Lambda URL in the code.");
                return;
            }

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            btn.disabled = true;

            const primaryKeyword = document.getElementById('primaryKeyword')?.value || "";
            const secondaryKeywords = document.getElementById('secondaryKeywords')?.value || "";

            try {
                const response = await fetch(OPTIMISER_ENDPOINTS.SEO_ANALYSIS, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content,
                        title,
                        primary_keyword: primaryKeyword,
                        secondary_keywords: secondaryKeywords,
                        use_ai: true
                    })
                });
                const data = await response.json();
                const result = parseLambdaResponse(data);

                console.log("SEO Analysis Parsed Result:", result);

                const score = result.overall_score || result.overallScore || 0;
                console.log("Populating score to gauge:", score);

                // Update Gauges and Bars with real data
                updateMetricGauge('seoScoreGauge', score);

                // Redundant update for safety
                const scoreVal = document.getElementById('seoScoreValue');
                if (scoreVal) scoreVal.innerText = Math.round(score);

                if (result.title_analysis) {
                    document.getElementById('titleScore').innerText = Math.round(result.title_analysis.score || 0) + '%';
                    document.getElementById('titleBar').style.width = (result.title_analysis.score || 0) + '%';
                }
                if (result.heading_analysis) {
                    document.getElementById('headingsScore').innerText = Math.round(result.heading_analysis.score || 0) + '%';
                    document.getElementById('headingsBar').style.width = (result.heading_analysis.score || 0) + '%';
                }
                if (result.readability_analysis) {
                    document.getElementById('readabilityScore').innerText = Math.round(result.readability_analysis.score || 0) + '%';
                    document.getElementById('readabilityBar').style.width = (result.readability_analysis.score || 0) + '%';
                }

                const wordCountElem = document.getElementById('wordCount');
                if (wordCountElem) wordCountElem.innerText = result.word_count || 0;
            } catch (error) {
                console.error("SEO Analysis Error:", error);
                alert("Failed to run SEO analysis. Check console for details.");
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        async function analyzeKeywordFrequency() {
            const content = document.getElementById('editorContent').innerHTML;
            const listContainer = document.getElementById('keywordFrequencyList');
            const btn = document.querySelector('.btn-keywords');
            const originalContent = btn.innerHTML;

            if (OPTIMISER_ENDPOINTS.KEYWORD_FREQ === 'YOUR_KEYWORD_FREQ_LAMBDA_URL') {
                // Fallback to basic local analysis if no URL provided
                runLocalKeywordAnalysis();
                return;
            }

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            btn.disabled = true;

            try {
                const response = await fetch(OPTIMISER_ENDPOINTS.KEYWORD_FREQ, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                const data = await response.json();
                const result = parseLambdaResponse(data);

                console.log("Keyword Freq Parsed Result:", result);

                listContainer.innerHTML = "";
                if (result.keywords && result.keywords.length > 0) {
                    result.keywords.forEach(kw => {
                        const item = document.createElement('div');
                        item.className = 'keyword-freq-item';
                        item.innerHTML = `
                            <div class="keyword-freq-header">
                                <span>${kw.keyword}</span>
                                <span>${kw.count}x (${kw.density}%)</span>
                            </div>
                            <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: ${Math.min(kw.density * 10, 100)}%; background: #3b5bdb;"></div></div>
                        `;
                        listContainer.appendChild(item);
                    });
                    document.getElementById('kwsFound').innerText = result.keywords.length;
                    document.getElementById('totalWordsStat').innerText = result.total_words || 0;
                } else {
                    listContainer.innerHTML = '<p style="text-align: center; color: #999; margin-top:20px;">No keywords found.</p>';
                    document.getElementById('totalWordsStat').innerText = result.total_words || 0;
                }
            } catch (error) {
                console.error("Keyword Freq Error:", error);
                runLocalKeywordAnalysis(); // Final fallback
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        function runLocalKeywordAnalysis() {
            const content = document.getElementById('editorContent').innerText.toLowerCase();
            const primaryKw = document.getElementById('primaryKeyword').value.trim();
            const secondaryKwsText = document.getElementById('secondaryKeywords').value;
            const secondaryKws = secondaryKwsText.split('\n').map(k => k.trim()).filter(k => k !== "");

            const keywords = [];
            if (primaryKw) keywords.push(primaryKw);
            keywords.push(...secondaryKws);

            const listContainer = document.getElementById('keywordFrequencyList');
            const totalWords = content.trim() ? content.trim().split(/\s+/).length : 0;

            if (keywords.length === 0) {
                alert("Please enter at least a primary focus keyword.");
                return;
            }

            listContainer.innerHTML = "";
            let foundCount = 0;

            keywords.forEach(kw => {
                if (!kw) return;
                const regex = new RegExp(`\\b${kw.toLowerCase().replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'g');
                const matches = content.match(regex) || [];
                const count = matches.length;
                const density = totalWords > 0 ? ((count / totalWords) * 100).toFixed(2) : "0.00";

                if (count > 0) foundCount++;

                const item = document.createElement('div');
                item.className = 'keyword-freq-item';
                item.innerHTML = `
                    <div class="keyword-freq-header">
                        <span>${kw}</span>
                        <span>${count}x (${density}%)</span>
                    </div>
                    <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: ${Math.min(density * 10, 100)}%; background: #3b5bdb;"></div></div>
                `;
                listContainer.appendChild(item);
            });

            document.getElementById('kwsFound').innerText = foundCount;
            document.getElementById('totalWordsStat').innerText = totalWords;
        }

        function handleLocalImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const imgId = "img_" + Date.now();
                    const imgHtml = `
                        <div class="img-optimiser-wrapper" id="wrap_${imgId}" style="position: relative; display: inline-block; margin: 15px 0; max-width: 100%;">
                            <img id="${imgId}" src="${e.target.result}" style="max-width: 100%; border-radius: 6px; display: block;" 
                                 onmouseover="showImageTool(this)" onmouseout="hideImageTool(this)">
                            <div class="img-tool-overlay" id="overlay_${imgId}" style="display: none; position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; z-index: 10; width: 250px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                    <div style="color: white; font-size: 12px; font-weight: bold;">Alt Text:</div>
                                    <button onclick="generateAiAlt('${imgId}')" style="background: #004c9d; color: white; border: none; padding: 3px 6px; border-radius: 4px; cursor: pointer; font-size: 10px;" title="AI Generate"> AI</button>
                                </div>
                                <textarea id="alt_${imgId}" placeholder="Enter alt text..." 
                                          style="width: 100%; box-sizing: border-box; padding: 5px; font-size: 11px; border-radius: 4px; border: none; resize: none; min-height: 45px; max-height: 200px; font-family: inherit; line-height: 1.4; overflow-y: hidden;" 
                                          oninput="updateImgAlt('${imgId}', this.value); autoResizeAlt(this)"></textarea>
                                <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 8px; width: 100%; background: #f44336; color: white; border: none; padding: 5px; border-radius: 4px; cursor: pointer; font-size: 11px;">Remove Image</button>
                            </div>
                            <div class="img-resize-handle" onmousedown="startImgResize(event, '${imgId}')"></div>
                        </div>
                    `;
                    execCmd('insertHTML', imgHtml);
                    input.value = ''; // Reset the input value so the same file can be uploaded again
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function showImageTool(img) {
            const overlay = document.getElementById("overlay_" + img.id);
            if (overlay) overlay.style.display = "block";
        }

        function hideImageTool(img) {
            // We use a small timeout to allow moving mouse into the overlay
            img._hideTimeout = setTimeout(() => {
                const overlay = document.getElementById("overlay_" + img.id);
                if (overlay && !overlay.matches(':hover')) overlay.style.display = "none";
            }, 300);
        }

        // Image resizing logic
        let resizingImg = null;
        let startX, startY, startWidth, startHeight;

        function startImgResize(e, imgId) {
            e.preventDefault();
            resizingImg = document.getElementById(imgId);
            startX = e.clientX;
            startY = e.clientY;
            startWidth = resizingImg.offsetWidth;
            startHeight = resizingImg.offsetHeight;

            window.addEventListener('mousemove', handleImgResize);
            window.addEventListener('mouseup', stopImgResize);
        }

        function handleImgResize(e) {
            if (!resizingImg) return;
            const diffX = e.clientX - startX;
            const newWidth = startWidth + diffX;

            // Maintain aspect ratio by only setting width (max-width is already 100%)
            if (newWidth > 50) {
                resizingImg.style.width = newWidth + 'px';
            }
        }

        function stopImgResize() {
            window.removeEventListener('mousemove', handleImgResize);
            window.removeEventListener('mouseup', stopImgResize);
            resizingImg = null;
        }

        // Ensure overlay stays visible when hovered
        document.addEventListener('mouseover', (e) => {
            if (e.target.closest('.img-tool-overlay')) {
                const overlay = e.target.closest('.img-tool-overlay');
                const imgId = overlay.id.replace('overlay_', '');
                const img = document.getElementById(imgId);
                if (img) clearTimeout(img._hideTimeout);
            }
        });

        function updateImgAlt(imgId, val) {
            const img = document.getElementById(imgId);
            if (img) img.alt = val;
        }

        function autoResizeAlt(el) {
            el.style.height = 'auto';
            const newHeight = el.scrollHeight;
            el.style.height = newHeight + 'px';

            // Show scrollbar only if it hits max-height (200px)
            if (newHeight >= 200) {
                el.style.overflowY = 'auto';
            } else {
                el.style.overflowY = 'hidden';
            }
        }

        async function generateAiAlt(imgId) {
            const altInput = document.getElementById('alt_' + imgId);
            const img = document.getElementById(imgId);
            if (!img) return;

            const editor = document.getElementById('editorContent');
            const pageContext = document.getElementById('editorTitle')?.value || editor.innerText.substring(0, 500);
            const primaryKeyword = document.getElementById('primaryKeyword')?.value || "";
            const secondaryKeywords = document.getElementById('secondaryKeywords')?.value || "";
            const focusKeywords = (primaryKeyword + "\n" + secondaryKeywords).trim();

            // Try to find placement relative to headers
            let placement = "Within content";
            let prev = img.previousElementSibling;
            while (prev) {
                if (prev.tagName && prev.tagName.startsWith('H')) {
                    placement = `Under heading "${prev.innerText}"`;
                    break;
                }
                prev = prev.previousElementSibling;
            }

            if (OPTIMISER_ENDPOINTS.IMAGE_ALT === 'YOUR_IMAGE_ALT_LAMBDA_URL') {
                altInput.value = "Vision AI endpoint not configured.";
                return;
            }

            altInput.value = "AI analyzing image...";

            try {
                // Prepare request body
                const body = {
                    page_context: pageContext,
                    image_placement: placement,
                    primary_keyword: primaryKeyword,
                    secondary_keywords: secondaryKeywords
                };

                // Handle image source (URL or base64)
                if (img.src.startsWith('data:')) {
                    body.image_data = img.src.split(',')[1];
                } else {
                    body.image_url = img.src;
                }

                const response = await fetch(OPTIMISER_ENDPOINTS.IMAGE_ALT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                const result = parseLambdaResponse(data);

                if (result.error) {
                    altInput.value = "Error: " + result.error;
                } else {
                    altInput.value = result.result || "SEO Image Description";
                    updateImgAlt(imgId, altInput.value);
                    autoResizeAlt(altInput);
                }
            } catch (error) {
                console.error("Alt Gen Error:", error);
                altInput.value = "Failed to reach AI.";
            }
        }

        async function aiGenerateContent() {
            const prompt = document.getElementById('aiPrompt').value;
            if (!prompt) return alert("Please enter a prompt.");
            const editor = document.getElementById('editorContent');
            const btn = document.getElementById('btnAiGenerate');
            const originalBtnContent = btn.innerHTML;

            if (OPTIMISER_ENDPOINTS.CONTENT_AI === 'YOUR_CONTENT_AI_LAMBDA_URL') {
                alert("Please configure the Content AI Lambda URL.");
                return;
            }

            // Button loading state
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Writing...';
            btn.disabled = true;

            const loadingId = "loading_" + Date.now();
            editor.innerHTML += `<p id="${loadingId}"><i>Generating content for: ${prompt}...</i></p>`;

            const primaryKeyword = document.getElementById('primaryKeyword')?.value || "";
            const secondaryKeywords = document.getElementById('secondaryKeywords')?.value || "";

            try {
                const response = await fetch(OPTIMISER_ENDPOINTS.CONTENT_AI, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generate',
                        prompt: prompt,
                        primary_keyword: primaryKeyword,
                        secondary_keywords: secondaryKeywords,
                        settings: aiContentSettings
                    })
                });
                const data = await response.json();
                const result = parseLambdaResponse(data);

                document.getElementById(loadingId).remove();

                const blockId = "gen_" + Date.now();
                const formattedContent = formatMarkdown(result.result);
                const generatedHtml = `
                    <div id="${blockId}" class="generated-content-block" contenteditable="false">
                        <div class="generated-badge">generated content</div>
                        <div class="generated-text-body" style="color: #333;" contenteditable="true">
                            ${formattedContent}
                        </div>
                        <div class="generated-actions">
                            <button class="btn-accept-content" onclick="acceptGeneratedContent('${blockId}')">
                                <i class="fas fa-check"></i> Accept
                            </button>
                            <button class="btn-remove-content" onclick="removeGeneratedContent('${blockId}')">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                    <p>&nbsp;</p>
                `;

                editor.innerHTML += generatedHtml;
                updateEditorMetrics();
            } catch (error) {
                document.getElementById(loadingId).innerHTML = "<i>Error generating content.</i>";
            } finally {
                btn.innerHTML = originalBtnContent;
                btn.disabled = false;
            }
        }

        function acceptGeneratedContent(blockId) {
            const block = document.getElementById(blockId);
            if (!block) return;

            // Get just the text content body
            const body = block.querySelector('.generated-text-body');
            const content = body ? body.innerHTML : "";

            // Replace the block with just its content
            const wrapper = document.createElement('div');
            wrapper.innerHTML = content;

            block.parentNode.replaceChild(wrapper, block);
            updateEditorMetrics();
        }

        function removeGeneratedContent(blockId) {
            const block = document.getElementById(blockId);
            if (block) {
                // Also remove the trailing &nbsp; p tag if it exists
                if (block.nextElementSibling && block.nextElementSibling.tagName === 'P' && block.nextElementSibling.innerHTML === '&nbsp;') {
                    block.nextElementSibling.remove();
                }
                block.remove();
            }
            updateEditorMetrics();
        }

        async function aiContinueWriting() {
            const editor = document.getElementById('editorContent');
            const content = editor.innerHTML;
            const btn = document.getElementById('btnAiContinue');
            const originalBtnContent = btn.innerHTML;

            if (OPTIMISER_ENDPOINTS.CONTENT_AI === 'YOUR_CONTENT_AI_LAMBDA_URL') {
                alert("Please configure the Content AI Lambda URL.");
                return;
            }

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Writing...';
            btn.disabled = true;

            const loadingId = "loading_" + Date.now();
            editor.innerHTML += `<p id="${loadingId}"><i>Continuing writing...</i></p>`;

            const primaryKeyword = document.getElementById('primaryKeyword')?.value || "";
            const secondaryKeywords = document.getElementById('secondaryKeywords')?.value || "";

            try {
                const response = await fetch(OPTIMISER_ENDPOINTS.CONTENT_AI, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'continue',
                        content: content,
                        primary_keyword: primaryKeyword,
                        secondary_keywords: secondaryKeywords,
                        settings: aiContentSettings
                    })
                });
                const data = await response.json();
                const result = parseLambdaResponse(data);

                document.getElementById(loadingId).remove();

                const blockId = "gen_" + Date.now();
                const formattedContent = formatMarkdown(result.result);
                const generatedHtml = `
                    <div id="${blockId}" class="generated-content-block" contenteditable="false">
                        <div class="generated-badge">generated content</div>
                        <div class="generated-text-body" style="color: #333;" contenteditable="true">
                            ${formattedContent}
                        </div>
                        <div class="generated-actions">
                            <button class="btn-accept-content" onclick="acceptGeneratedContent('${blockId}')">
                                <i class="fas fa-check"></i> Accept
                            </button>
                            <button class="btn-remove-content" onclick="removeGeneratedContent('${blockId}')">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                `;
                editor.innerHTML += generatedHtml;
                updateEditorMetrics();
            } catch (error) {
                document.getElementById(loadingId).innerHTML = "<i>Error continuing text.</i>";
            } finally {
                btn.innerHTML = originalBtnContent;
                btn.disabled = false;
            }
        }

        async function aiQuickAction(type) {
            const editor = document.getElementById('editorContent');
            const content = editor.innerHTML;

            if (OPTIMISER_ENDPOINTS.CONTENT_AI === 'YOUR_CONTENT_AI_LAMBDA_URL') {
                const blockId = "gen_" + Date.now();
                editor.innerHTML = `
                    <div id="${blockId}" class="generated-content-block" contenteditable="false">
                        <div class="generated-badge">generated content</div>
                        <div class="generated-text-body" style="color: #333;" contenteditable="true">
                            <b>[${type.toUpperCase()}ED CONTENT]</b><br>${editor.innerHTML}
                        </div>
                        <div class="generated-actions">
                            <button class="btn-accept-content" onclick="acceptGeneratedContent('${blockId}')">
                                <i class="fas fa-check"></i> Accept
                            </button>
                            <button class="btn-remove-content" onclick="removeGeneratedContent('${blockId}')">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                `;
                updateEditorMetrics();
                return;
            }

            const btn = (event && event.currentTarget) ? event.currentTarget : (event && event.target ? event.target.closest('button') : null);
            const originalContent = btn ? btn.innerHTML : null;
            if (btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;
            }

            const primaryKeyword = document.getElementById('primaryKeyword')?.value || "";
            const secondaryKeywords = document.getElementById('secondaryKeywords')?.value || "";

            try {
                const response = await fetch(OPTIMISER_ENDPOINTS.CONTENT_AI, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: type,
                        content: content,
                        primary_keyword: primaryKeyword,
                        secondary_keywords: secondaryKeywords,
                        settings: aiContentSettings
                    })
                });
                const data = await response.json();
                const result = parseLambdaResponse(data);

                const blockId = "gen_" + Date.now();
                const formattedContent = formatMarkdown(result.result);
                editor.innerHTML = `
                    <div id="${blockId}" class="generated-content-block" contenteditable="false">
                        <div class="generated-badge">generated content</div>
                        <div class="generated-text-body" style="color: #333;" contenteditable="true">
                            ${formattedContent}
                        </div>
                        <div class="generated-actions">
                            <button class="btn-accept-content" onclick="acceptGeneratedContent('${blockId}')">
                                <i class="fas fa-check"></i> Accept
                            </button>
                            <button class="btn-remove-content" onclick="removeGeneratedContent('${blockId}')">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                `;
                updateEditorMetrics();
            } catch (error) {
                alert("Error performing AI action.");
            } finally {
                if (btn) {
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                }
            }
        }

        async function runPlagiarismCheck() {
            const scoreDisp = document.getElementById('plagiarismScore');
            const metaDisp = document.getElementById('plagiarismMeta');
            const statusBox = document.getElementById('plagiarismStatus');
            const content = document.getElementById('editorContent').innerText;

            if (OPTIMISER_ENDPOINTS.PLAGIARISM === 'YOUR_PLAGIARISM_LAMBDA_URL') {
                scoreDisp.innerText = "Check Disabled";
                return;
            }

            scoreDisp.innerText = "Checking...";
            metaDisp.innerText = "Connecting to Copyscape...";

            try {
                const response = await fetch(OPTIMISER_ENDPOINTS.PLAGIARISM, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: content })
                });
                const data = await response.json();
                const result = parseLambdaResponse(data);

                console.log("Plagiarism Parsed Result:", result);

                if (result.error || (result.raw_api_response && result.raw_api_response.error)) {
                    const errMsg = result.error || result.raw_api_response.error;
                    scoreDisp.innerText = "Error";
                    metaDisp.innerText = errMsg;
                    statusBox.className = "status-box error";
                    return;
                }

                const score = result.originality_score !== undefined ? result.originality_score : 100;
                scoreDisp.innerText = Math.round(score) + "%";
                metaDisp.innerText = `${result.word_count || content.split(/\s+/).length} words  ${result.total_matches || 0} match(es)`;

                let sourcesHtml = "";
                if (result.matched_sources && result.matched_sources.length > 0) {
                    sourcesHtml = '<div style="margin-top: 10px; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 10px; font-size: 12px; text-align: left;">';
                    sourcesHtml += '<b>Matched Sources:</b><ul style="margin: 5px 0; padding-left: 20px;">';
                    result.matched_sources.forEach(src => {
                        sourcesHtml += `<li style="margin-bottom: 4px;"><a href="${src.url}" target="_blank" style="color: #004c9d; word-break: break-all;">${src.title || src.url}</a> (${src.minwordsmatched || '?'}+ words)</li>`;
                    });
                    sourcesHtml += '</ul></div>';
                }

                if (score > 90) {
                    statusBox.className = "status-box success";
                    document.getElementById('plagiarismTitle').innerText = "Original Content";
                    document.getElementById('plagiarismMsg').innerText = "No significant matches found. Content appears original.";
                    statusBox.style.background = "#e6ffe6";
                    statusBox.style.color = "#008000";
                } else if (score > 70) {
                    statusBox.className = "status-box warning";
                    document.getElementById('plagiarismTitle').innerText = "Minor Matches Found";
                    document.getElementById('plagiarismMsg').innerText = "A few phrases match existing online sources.";
                    statusBox.style.background = "#fff9db";
                    statusBox.style.color = "#f08c00";
                } else {
                    statusBox.className = "status-box error";
                    document.getElementById('plagiarismTitle').innerText = "Significant Plagiarism Detected";
                    document.getElementById('plagiarismMsg').innerText = "Multiple sections match existing online sources. Review required.";
                    statusBox.style.background = "#ffe6e6";
                    statusBox.style.color = "#cc0000";
                }

                // Append sources list if it exists
                const existingList = statusBox.querySelector('.sources-list');
                if (existingList) existingList.remove();
                if (sourcesHtml) {
                    const listContainer = document.createElement('div');
                    listContainer.className = "sources-list";
                    listContainer.innerHTML = sourcesHtml;
                    statusBox.appendChild(listContainer);
                }

            } catch (error) {
                console.error("Plagiarism Check Error:", error);
                scoreDisp.innerText = "Error";
                metaDisp.innerText = "Failed to run check.";
                statusBox.className = "status-box error";
                document.getElementById('plagiarismTitle').innerText = "Check Failed";
                document.getElementById('plagiarismMsg').innerText = "Could not connect to plagiarism service.";
                statusBox.style.background = "#ffe6e6";
                statusBox.style.color = "#cc0000";
            }
        }

        // Floating Selection Toolbar Logic
        const editor = document.getElementById('editorContent');
        const selectionToolbar = document.getElementById('selectionToolbar');

        editor.addEventListener('mouseup', showSelectionToolbar);
        editor.addEventListener('keyup', showSelectionToolbar);
        document.addEventListener('mousedown', (e) => {
            if (selectionToolbar && !selectionToolbar.contains(e.target) && !editor.contains(e.target)) {
                hideSelectionToolbar();
            }
        });
        // Global AI Content Settings State
        let aiContentSettings = {
            audience: "",
            brandTone: "Professional",
            searchIntent: "Informational",
            industry: "General",
            riskLevel: "Low",
            jurisdictions: "SG",
            locale: "en-SG",
            readingLevel: "Grade 6-8 (Easy)",
            doUseWords: "",
            doNotUseWords: "",
            focusProducts: "",
            schemaType: "Article",
            complianceDisclaimers: false
        };

        function openAiSettingsModal() {
            const modal = document.getElementById('aiSettingsModal');
            if (!modal) return;

            // Populate modal with current settings
            document.getElementById('setAudience').value = aiContentSettings.audience;
            document.getElementById('setBrandTone').value = aiContentSettings.brandTone;
            document.getElementById('setSearchIntent').value = aiContentSettings.searchIntent;
            document.getElementById('setIndustry').value = aiContentSettings.industry;
            document.getElementById('setRiskLevel').value = aiContentSettings.riskLevel;
            document.getElementById('setJurisdictions').value = aiContentSettings.jurisdictions;
            document.getElementById('setLocale').value = aiContentSettings.locale;
            document.getElementById('setReadingLevel').value = aiContentSettings.readingLevel;
            document.getElementById('setDoUseWords').value = aiContentSettings.doUseWords;
            document.getElementById('setDoNotUseWords').value = aiContentSettings.doNotUseWords;
            document.getElementById('setFocusProducts').value = aiContentSettings.focusProducts;
            document.getElementById('setSchemaType').value = aiContentSettings.schemaType;
            document.getElementById('setComplianceDisclaimers').checked = aiContentSettings.complianceDisclaimers;

            modal.style.display = 'block';
        }

        function closeAiSettingsModal() {
            const modal = document.getElementById('aiSettingsModal');
            if (modal) modal.style.display = 'none';
        }

        function resetAiSettings() {
            // Revert global state to defaults
            aiContentSettings = {
                audience: "",
                brandTone: "Professional",
                searchIntent: "Informational",
                industry: "General",
                riskLevel: "Low",
                jurisdictions: "SG",
                locale: "en-SG",
                readingLevel: "Grade 6-8 (Easy)",
                doUseWords: "",
                doNotUseWords: "",
                focusProducts: "",
                schemaType: "Article",
                complianceDisclaimers: false
            };
            openAiSettingsModal(); // Refresh UI
        }

        function applyAiSettings() {
            // Save modal values to global state
            aiContentSettings = {
                audience: document.getElementById('setAudience').value,
                brandTone: document.getElementById('setBrandTone').value,
                searchIntent: document.getElementById('setSearchIntent').value,
                industry: document.getElementById('setIndustry').value,
                riskLevel: document.getElementById('setRiskLevel').value,
                jurisdictions: document.getElementById('setJurisdictions').value,
                locale: document.getElementById('setLocale').value,
                readingLevel: document.getElementById('setReadingLevel').value,
                doUseWords: document.getElementById('setDoUseWords').value,
                doNotUseWords: document.getElementById('setDoNotUseWords').value,
                focusProducts: document.getElementById('setFocusProducts').value,
                schemaType: document.getElementById('setSchemaType').value,
                complianceDisclaimers: document.getElementById('setComplianceDisclaimers').checked
            };
            closeAiSettingsModal();
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('aiSettingsModal');
            if (event.target == modal) {
                closeAiSettingsModal();
            }
        };

        function showSelectionToolbar() {
            const selection = window.getSelection();
            if (selection.isCollapsed || selection.toString().trim().length === 0) {
                hideSelectionToolbar();
                return;
            }

            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();

            // Position above selection
            selectionToolbar.style.display = 'flex';
            const toolbarRect = selectionToolbar.getBoundingClientRect();

            // Calculate absolute position (accounting for window scroll)
            const top = rect.top + window.scrollY - toolbarRect.height - 10;
            const left = rect.left + window.scrollX + (rect.width / 2) - (toolbarRect.width / 2);

            selectionToolbar.style.top = `${top}px`;
            selectionToolbar.style.left = `${left}px`;
        }

        function hideSelectionToolbar() {
            if (selectionToolbar) selectionToolbar.style.display = 'none';
        }

        async function handleSelectionAction(action) {
            const selection = window.getSelection();
            const selectedText = selection.toString();
            if (!selectedText) return;

            if (OPTIMISER_ENDPOINTS.CONTENT_AI === 'YOUR_CONTENT_AI_LAMBDA_URL') {
                alert("AI Content endpoint not configured.");
                return;
            }

            // Save the range before making the API call
            const range = selection.getRangeAt(0);

            // Show a temporary "processing" state in the toolbar
            const originalToolbarHtml = selectionToolbar.innerHTML;
            const actionLabel = action.charAt(0).toUpperCase() + action.slice(1);
            selectionToolbar.innerHTML = `<div style="padding: 8px 15px; font-size: 13px; color: #004c9d; display: flex; align-items: center; gap: 10px; font-weight: 500;">
                                            <i class="fas fa-spinner fa-spin"></i> AI ${actionLabel} in progress...
                                          </div>`;

            try {
                const response = await fetch(OPTIMISER_ENDPOINTS.CONTENT_AI, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action, content: selectedText, settings: aiContentSettings })
                });
                const data = await response.json();
                const result = parseLambdaResponse(data);

                const formattedContent = formatMarkdown(result.result);
                const diffId = "diff_" + Date.now();

                // Create the diff reveal structure
                // Use a span wrapper so it doesn't break paragraph flow
                const diffHtml = `
                    <span id="${diffId}" class="diff-preview-wrapper" contenteditable="false">
                        <span class="diff-original" title="Original text">${selectedText}</span>
                        <span class="diff-new" contenteditable="true" title="AI suggestion (Editable)">${formattedContent}</span>
                        <span class="diff-controls">
                            <button class="btn-diff-accept" onclick="acceptSelectionDiff('${diffId}')">Accept</button>
                            <button class="btn-diff-undo" onclick="undoSelectionDiff('${diffId}')">Undo</button>
                        </span>
                    </span>
                `;

                // Re-select the range
                selection.removeAllRanges();
                selection.addRange(range);

                // Replace selection with the diff structure
                document.execCommand('insertHTML', false, diffHtml);

                hideSelectionToolbar();
                updateEditorMetrics();
            } catch (error) {
                console.error("Selection Action Error:", error);
                alert("Error performing AI action on selection.");
                selectionToolbar.innerHTML = originalToolbarHtml;
            } finally {
                if (selectionToolbar.innerHTML.includes('spinner')) {
                    selectionToolbar.innerHTML = originalToolbarHtml;
                }
            }
        }

        function acceptSelectionDiff(diffId) {
            const diffEl = document.getElementById(diffId);
            if (!diffEl) return;

            const newTextEl = diffEl.querySelector('.diff-new');
            const acceptedContent = newTextEl ? newTextEl.innerHTML : "";

            // Replace the whole diff wrapper with just the new content
            const temp = document.createElement('span');
            temp.innerHTML = acceptedContent;
            diffEl.parentNode.replaceChild(temp, diffEl);

            updateEditorMetrics();
        }

        function undoSelectionDiff(diffId) {
            const diffEl = document.getElementById(diffId);
            if (!diffEl) return;

            const originalTextEl = diffEl.querySelector('.diff-original');
            const originalContent = originalTextEl ? originalTextEl.innerHTML : "";

            // Revert back to original text
            const temp = document.createElement('span');
            temp.innerHTML = originalContent;
            diffEl.parentNode.replaceChild(temp, diffEl);

            updateEditorMetrics();
        }

        async function optimiseContent() {
            const resultsDiv = document.getElementById("aiContentOptimiserResults");
            resultsDiv.innerHTML = "<p>Analyzing full structure and content for SEO health...</p>";
            setTimeout(() => {
                runSeoAnalysis();
                resultsDiv.innerHTML = "<div style='background: #e7f5ff; padding: 10px; border-radius: 4px; margin-top: 10px;'>Overall SEO Analysis Triggered. Check the sidebar for detailed score.</div>";
            }, 1000);
        }

        function openLandingPageAudit(event) {
            event.preventDefault();
            deactivateAllButtons();

            const landingPageAuditButton = document.querySelector('button#landingPageAuditBtn');
            if (landingPageAuditButton) {
                landingPageAuditButton.classList.toggle('active');
                const content = landingPageAuditButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const landingPageAuditLink = event.currentTarget;
                landingPageAuditLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const landingPageAuditSection = document.getElementById('landingPageAudit');
                    if (landingPageAuditSection) {
                        landingPageAuditSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            closeJourneyModal();
        }

        const urlFields = document.querySelectorAll('input[type="url"], textarea#reference-urls, textarea#sem_webpages, textarea#persona_webpages, textarea#MediaPlanWebpages');

        urlFields.forEach(input => {
            input.addEventListener('input', syncUrls);
        });

        function syncUrls(event) {
            const currentUrl = event.target.value;

            urlFields.forEach(input => {
                input.value = currentUrl;
            });
        }

        let currentKeywordSortColumn = null;
        let keywordSortAscending = true;

        let currentRankedKeywordSortColumn = null;
        let rankedKeywordSortAscending = true;

        const submitBtn = document.getElementById('submitBtn');
        const gtmetrixReportDiv = document.getElementById('gtmetrixReport');
        const crawlerReportDiv = document.getElementById('crawlerReport');
        const crawlerTableBody = document.getElementById('crawlerTableBody');
        const pageAuditReportDiv = document.getElementById('pageAuditReport');

        analyzeBtn = document.getElementById('analyzeBtn');
        const resultsDiv = document.getElementById('comparison-results');
        const messageElement = document.querySelector('.message');
        const messages = [
            'Getting SERP results...',
            'Analysing Page Content...',
            'Formulating Content Topics...',
            'Comparing Topics Across Results...',
            'Collating Findings...'
        ];
        let currentMessageIndex = 0;

        brandCheckbox = document.getElementById('brand-checkbox');
        productCheckbox = document.getElementById('product-checkbox');

        brandCheckbox.addEventListener('change', () => {
            if (brandCheckbox.checked) {
            } else {
                if (productCheckbox.checked) {

                } else {
                    productCheckbox.checked = true;
                }
            }
        });

        productCheckbox.addEventListener('change', () => {
            if (productCheckbox.checked) {
            } else {
                if (brandCheckbox.checked) {

                } else {
                    brandCheckbox.checked = true;
                }
            }
        });

        submitBtn.addEventListener('click', () => {
            const url = document.getElementById('urlInput').value;
            const maxPages = document.getElementById('maxPagesInput').value;

            submitBtn.innerHTML = 'Analysing...';
            document.getElementById("technicalButton").style.backgroundColor = "#004c9d";
            document.getElementById("gtButton").style.backgroundColor = "#004c9d";
            document.getElementById("pageButton").style.backgroundColor = "#004c9d";
            document.getElementById("crawlerButton").style.backgroundColor = "#004c9d";

            document.getElementById('auditSummary').innerHTML = "";

            // GTMetrix API call
            fetch("https://y5830908vh.execute-api.ap-southeast-1.amazonaws.com/gtmetrix", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            })
                .then(response => response.json())
                .then(gt_data => {
                    document.getElementById('reportUrl').innerHTML = '<a href="' + gt_data.body.data.links.report_url + '" target="_blank" rel="noopener noreferrer">' + gt_data.body.data.links.report_url + '</a>';
                    document.getElementById('cls').textContent = gt_data.body.data.attributes.cumulative_layout_shift;
                    document.getElementById('lcp').textContent = gt_data.body.data.attributes.largest_contentful_paint;
                    document.getElementById('tbt').textContent = gt_data.body.data.attributes.total_blocking_time;
                    document.getElementById('grade').textContent = gt_data.body.data.attributes.gtmetrix_grade;
                    document.getElementById('performance').textContent = gt_data.body.data.attributes.performance_score;

                    gtmetrixReportDiv.style.display = 'block';
                    document.getElementById("gtButton").style.backgroundColor = "green";

                })

                .catch(error => console.error('Error fetching GTMetrix data:', error));


            // Webpage Audit
            fetch("https://7vkudwlzhh.execute-api.ap-southeast-1.amazonaws.com/webpageAudit", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            })
                .then(response => response.json())
                .then(webpage_audit_data => {
                    document.getElementById('malware').textContent = webpage_audit_data.body.malware;
                    document.getElementById('sitemap').textContent = webpage_audit_data.body.sitemap;
                    document.getElementById('robots').innerHTML = webpage_audit_data.body.robots;
                    document.getElementById('pagespeed_audit').textContent = webpage_audit_data.body.pagespeed;

                    pageAuditReportDiv.style.display = 'block';
                    document.getElementById("pageButton").style.backgroundColor = "green";
                    document.getElementById("technicalButton").style.backgroundColor = "green";
                })
                .catch(error => console.error('Error fetching Webpage Audit data:', error));


            // Crawler API call
            fetch("https://464q7iox7h.execute-api.ap-southeast-1.amazonaws.com/crawler", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url, max_pages: parseInt(maxPages) })
            })
                .then(response => response.json())
                .then(data => {
                    crawlerTableBody.innerHTML = ''; // Clear previous data

                    for (const pageUrl in data.body) {
                        const pageData = data.body[pageUrl];
                        const row = document.createElement('tr');
                        row.innerHTML = `   
                        <td>${pageUrl}</td>
                        <td>${pageData.code}</td>
                        <td>${pageData.title}</td>
                        <td>${pageData.description}</td>
                        <td>${pageData.canonical}</td>
                        <td>${pageData.hreflang}</td>
                        <td>${pageData.alt_text}</td>
                        <td>${pageData.h1}</td>
                        <td>${pageData.h2}</td>
                        <td>${pageData.word_count}</td>
                        <td>${pageData.uiux}</td>
                    `;
                        crawlerTableBody.appendChild(row);
                    }
                    crawlerReportDiv.style.display = 'block';
                    submitBtn.innerHTML = 'Analyse Website';


                    // Audit Summary
                    gt_data = { "cumulative_layout_shift": document.getElementById('cls').textContent, "largest_contentful_paint": document.getElementById('lcp').textContent, "total_blocking_time": document.getElementById('tbt').textContent };
                    webpage_audit_data = { 'google_safe_site': document.getElementById('malware').textContent, 'sitemap': document.getElementById('sitemap').textContent, 'robots_txt': document.getElementById('robots').innerHTML, 'pagespeed': document.getElementById('pagespeed_audit').textContent };

                    fetch("https://ccgdpp7dna.execute-api.ap-southeast-1.amazonaws.com/techAuditSummary", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ crawl: data, gtmetrix: gt_data, webpage_audit: webpage_audit_data })
                    })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('auditSummary').innerHTML = data.body;
                            document.getElementById("crawlerButton").style.backgroundColor = "green";
                        })
                        .catch(error => console.error('Error fetching Audt Summary API:', error));

                })
                .catch(error => {
                    console.error('Error fetching crawler data:', error);
                    submitBtn.innerHTML = 'Analyse Website';
                })

                .finally(() => {
                    document.getElementById('downloadResultsBtn').style.display = 'block';
                });

        });

        function processURL() {
            queryUrl = window.location.href;
            if (queryUrl.includes('?keywordAnalysis')) {
                query_split = queryUrl.split("&");
                console.log(query_split);

                query_split.forEach(parameter => {
                    if (parameter.includes('location=')) {
                        document.getElementById('location').value = parameter.replace('location=', '').replaceAll("%20", " ");
                    } else if (parameter.includes('language=')) {
                        document.getElementById('language').value = parameter.replace('language=', '').replaceAll("%20", " ");
                    } else if (parameter.includes('target=')) {
                        document.getElementById('domain').value = parameter.replace('target=', '').replaceAll("%2F", "/").replace("%3A", ":");
                    } else if (parameter.includes('keywords=')) {
                        document.getElementById('keywords').value = parameter.replace('keywords=', '').replaceAll('%20', ' ').replaceAll('+', ', ').replaceAll("%27", "'").replace('#', '');
                    }
                });

                validateAndSubmit();

                alert("Keyword analysis started based on the input URL.")


                //changes url without going to the page
                // window.history.replaceState({path:"?keywordAnalysis2"},'pageTitle',"?keywordAnalysis2");
            }

        }

        async function contentComparisonAnalysis() {
            analyzeBtn = document.getElementById('contentComparisonAnalyzeBtn');
            // Show loading messages, hide previous results
            resultsDiv.innerHTML = '';
            analyzeBtn.innerHTML = 'Analysing...';

            keyword = document.getElementById('comparison-keyword').value;
            const urlsInput = document.getElementById('comparison-urls').value;
            const language = document.getElementById('comparison-language').value;
            const location = document.getElementById('comparison-location').value;
            user = JSON.parse(localStorage.getItem('googleUser')).email;
            urls = urlsInput.split(/[\s,]+/).filter(url => url.trim() !== "");

            // Get selected page types
            const pageTypes = Array.from(document.querySelectorAll('input[name="target-page-type"]:checked'))
                .map(checkbox => checkbox.value);

            console.log(pageTypes);

            try {
                let serpUrls = [];
                try {
                    if (keyword != "") {
                        // 1. Fetch URLs from SERP API
                        const serpResponse = await fetch('https://2wv8kyc8dg.execute-api.ap-southeast-1.amazonaws.com/moreSerps', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ keyword, language, location, user, page_types: pageTypes }),
                        });
                        const serpData = await serpResponse.json();
                        console.log(serpData);
                        serpUrls = Object.values(serpData).map(result => result.url);

                        if (urls != "") {
                            serpUrls = [...new Set([...serpUrls, ...urls])]; // Combine and deduplicate
                        }

                    } else {
                        serpUrls = urls;
                    }
                } catch (error) {
                    serpUrls = urls;
                }

                serpUrls.push(document.getElementById('comparison-domain').value);

                console.log(serpUrls);

                // 2. Fetch content analysis for each URL *concurrently*
                const analysisPromises = serpUrls.map(url =>
                    fetch('https://u24f9208q0.execute-api.ap-southeast-1.amazonaws.com/gptTopicsPerUrl', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, keyword }),
                    })
                        .then(res => {
                            if (!res.ok) {  // Check for errors
                                console.warn(`Content analysis API error for ${url}: ${res.status} ${res.statusText}.  Skipping.`);
                                return null; // Signal that this URL failed
                            }
                            return res.json();
                        })
                        .catch(error => {
                            console.warn(`Content analysis API error for ${url}: ${error.message}.  Skipping.`);
                            return null; // Signal that this URL failed
                        })
                );

                // Wait for *all* content analysis calls to complete
                analysisDataArray = await Promise.all(analysisPromises);

                // Combine analysis data, handling potential errors from individual API calls
                analysisData = {};
                analysisDataArray.forEach(item => {
                    try {
                        url = Object.keys(item['body'])[0];
                        analysisData[url] = item['body'][url];
                    } catch (error) {

                    }
                }
                );

                // Check if analysisData is empty after combining results.
                if (Object.keys(analysisData).length === 0) {
                    throw new Error("Content analysis failed for all URLs. Please check the URLs and try again.");
                }

                // 3. Create and display the table (modified createAnalysisTable function below)
                comparisonTableHTML = createAnalysisTable(analysisData, keyword, urls);  // Pass keyword and target URLs
                document.getElementById('initial-table').innerHTML = `<div id="tableContainer">${comparisonTableHTML}</div>`;

                // 4. Apply gradients (no change needed)
                applyGradientsToRows();

                // 5. Submit table data to comparisonRecommender API
                const comparisonResponse = await fetch('https://33v5mhjt47.execute-api.ap-southeast-1.amazonaws.com/comparisonRecommender', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ output: analysisData, keyword, location, pageTypes, domain: document.getElementById('comparison-domain').value }), // Send analysisData directly
                });
                const comparisonData = await comparisonResponse.json();

                console.log(comparisonData);

                // Display recommendations and output table from comparison API
                const recommendation = comparisonData.body.recommendation;

                try {
                    //const outputTableHTML = createHTMLTableFromJSON(comparisonData.body.output); // Parse JSON string to object
                    const outputTableHTML = createAnalysisTable(comparisonData.body.output, keyword, urls)
                    document.getElementById('initial-table').innerHTML = "";
                    document.getElementById('initial-table').innerHTML = `<div id="tableContainer">${outputTableHTML}</div>`;
                    resultsDiv.innerHTML += `<pre>${recommendation}</pre>`;
                    console.log('refresh succesful');

                    // 4. Apply gradients (no change needed)
                    applyGradientsToRows();

                } catch (error) {
                    console.log(error)
                    resultsDiv.innerHTML += `<pre>${recommendation}</pre>`;
                }

                /*
                const promises = serpUrls.map(url => {
                    return fetch('https://de0bccf9w7.execute-api.ap-southeast-1.amazonaws.com/keywordDensity', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ target: url.trim() })
                    })
                        .then(response => response.json())
                        .catch(error => {
                            console.log(response.json());
                            console.error("Error fetching data for " + url.trim() + ":", error);
                            return { error: `Error fetching data for ${url.trim()}: ${error.message || error}` } // Handle errors gracefully
                        });
                });
        
                const responses = await Promise.all(promises);
        
                displayDensityResults(serpUrls, responses);
        
                */


                analyzeBtn.innerHTML = 'Analyse (up to 3 mins)';
                await contentComparisonToDatabase();

            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                try {
                } catch (error) {
                }
                analyzeBtn.innerHTML = 'Analyse (up to 3 mins)';
            }
        }

        function displayDensityResults(urls, responses) {
            const resultsDiv = document.getElementById("keyword-density");
            let tableHTML = '<table>';

            // Create table headers (URLs)
            tableHTML += '<tr><th onclick="sortDensityKeyword()">Keyword</th>';
            urls.forEach(url => {
                tableHTML += `<th onclick="sortDensityTable('${url}')">${url}</th>`;
            });
            tableHTML += '</tr>';

            // Extract all unique keywords
            let allKeywords = new Set();
            responses.forEach(response => {
                if (Array.isArray(response)) {  // Check if the response is an array
                    response.forEach(item => allKeywords.add(item.keyword));
                }
            });
            allKeywords = Array.from(allKeywords);

            // Populate table rows with keyword data
            allKeywords.forEach(keyword => {
                tableHTML += `<tr><td>${keyword}</td>`;
                urls.forEach((url, urlIndex) => {
                    let frequency = 0;
                    if (Array.isArray(responses[urlIndex])) { //check if the response is an array.
                        const keywordData = responses[urlIndex].find(item => item.keyword === keyword);
                        frequency = keywordData ? keywordData.frequency : 0;
                    } else if (typeof responses[urlIndex] === 'object' && responses[urlIndex] !== null && responses[urlIndex].error) { //check for error.
                        frequency = responses[urlIndex].error;
                    } else {
                        frequency = "N/A"; //Handle unexpected response
                    }

                    tableHTML += `<td>${frequency}</td>`;
                });
                tableHTML += '</tr>';
            });

            tableHTML += '</table>';
            resultsDiv.innerHTML = tableHTML;
        }

        function sortDensityTable(url) {
            // Get the table element
            var table = document.querySelector("#results table");
            if (!table) {
                return; // Table doesn't exist
            }

            // Get the index of the URL column to be sorted by
            var headerRow = table.rows[0];
            var columnIndex = -1;
            for (var i = 1; i < headerRow.cells.length; i++) {
                if (headerRow.cells[i].textContent === url) {
                    columnIndex = i;
                    break;
                }
            }

            if (columnIndex === -1) {
                return; // URL not found
            }

            // Get the table rows (excluding the header row)
            var rows = Array.from(table.rows).slice(1); // Convert to array for easier sorting

            // Sort the rows based on the frequency in the specified column
            rows.sort(function (row1, row2) {
                var frequency1 = row1.cells[columnIndex].textContent;
                var frequency2 = row2.cells[columnIndex].textContent;

                //Handle error responses
                if (frequency1 === "N/A") {
                    return -1;
                }
                if (frequency2 === "N/A") {
                    return 1;
                }

                return frequency2 - frequency1;
            });

            // Re-append the sorted rows to the table
            rows.forEach(row => table.appendChild(row));
        }

        function sortDensityKeyword() {
            var table = document.querySelector("#results table");
            if (!table) {
                return;
            }

            var rows = Array.from(table.rows).slice(1);

            rows.sort(function (row1, row2) {
                var keyword1 = row1.cells[0].textContent.toLowerCase();
                var keyword2 = row2.cells[0].textContent.toLowerCase();

                if (keyword1 < keyword2) {
                    return -1;
                }
                if (keyword1 > keyword2) {
                    return 1;
                }
                return 0;
            });

            rows.forEach(row => table.appendChild(row));
        }

        // Function to create the HTML table from the analysis data
        function createAnalysisTable(data, keyword, targetUrls) {
            let tableHTML = '<table id="analysisTable">';
            tableHTML += '<tr><th>URL</th>';

            const urls = Object.keys(data);
            urls.forEach(url => {
                tableHTML += `<th ${targetUrls.includes(url) && keyword ? 'class="targetUrl"' : ''}>
                        <a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a></th>`;
            });
            tableHTML += '</tr>';


            // Add Word Count row
            tableHTML += '<tr><td>Word Count</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td data-value="${data[url].word_count}">${data[url].word_count}</td>`;
                } catch (error) {
                    tableHTML += `<td data-value="0">0</td>`;
                }
            });
            tableHTML += '</tr>';

            // Add Page Type row
            tableHTML += '<tr><td>Page Type</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td>${data[url].page_type}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            // Add headings rows
            tableHTML += '<tr><td>h1</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td>  ${data[url].h1.join('<br>  ')}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            tableHTML += '<tr><td>h2</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td>  ${data[url].h2.join('<br>  ')}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            tableHTML += '<tr><td>h3</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td>  ${data[url].h3.join('<br>  ')}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            // Get all unique topics, handling missing topics
            let allTopics = [];
            urls.forEach(url => {
                if (data[url] && data[url].topics) {
                    allTopics = [...allTopics, ...Object.keys(data[url].topics)];
                }
            });
            const uniqueTopics = [...new Set(allTopics)];

            // Add Topic rows (handling missing topic data)
            uniqueTopics.forEach(topic => {
                tableHTML += `<tr><td>${topic.replaceAll('_', ' ')}</td>`;
                urls.forEach(url => {
                    const value = (data[url] && data[url].topics && data[url].topics[topic]) ? data[url].topics[topic] : 0;
                    tableHTML += `<td data-value="${value}">${value}</td>`;
                });
                tableHTML += '</tr>';
            });

            tableHTML += '</table>';
            return tableHTML;
        }

        function applyGradientsToRows() {
            const table = document.getElementById('analysisTable');
            for (let i = 1; i < table.rows.length; i++) { // Start from row 1 to skip header
                applyGradientToRow(table.rows[i]);
            }
        }

        function applyGradientToRow(row) {
            const values = Array.from(row.cells)
                .slice(1) // Skip the first cell (topic name)
                .map(cell => {
                    const value = parseFloat(cell.dataset.value);
                    return isNaN(value) ? -1 : value; // Assign -1 for non-numeric values
                });

            const max = Math.max(...values);
            const min = Math.min(...values);

            values.forEach((value, index) => {
                const cell = row.cells[index + 1]; // +1 to account for the first cell
                if (!isNaN(value) && value !== -1) { // Apply gradient only to numeric values
                    const percent = (value - min) / (max - min);
                    const red = Math.round(255 * (1 - percent));
                    const green = Math.round(255 * percent);
                    cell.style.backgroundColor = `rgb(${red}, ${green}, 0)`;
                }
            });
        }



        // Function to generate content
        const form = document.getElementById('content-form');
        const generatedContentDiv = document.getElementById('generated-content');
        const generateButton = document.getElementById('generate-button');

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            // Disable the button and change text
            generateButton.disabled = true;
            generateButton.textContent = 'Generating Content...';
            document.getElementById("smm").style.backgroundColor = "#004c9d";

            const formData = new FormData(form);

            // Helper: safe getter (returns "" if field missing)
            const getVal = (name, fallback = "") => (formData.get(name) ?? fallback).toString().trim();

            // NEW: capture optional new fields (if present in the form)
            // Ensure your HTML inputs use these exact "name" attributes:
            // name="sensitivity", name="response_objective", name="response_platform"
            const sensitivity = getVal('sensitivity', "");
            const response_objective = getVal('response_objective', "");
            const response_platform = getVal('response_platform', "");

            // Helper function to process URLs
            async function processUrls(urlsText, apiUrl) {
                if (!urlsText) return [];

                const urls = urlsText.split(/[, \n]+/).filter(url => url.trim() !== "");
                const promises = urls.map(async (url) => {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url: url.trim() })
                        });

                        if (!response.ok) {
                            console.error(`Error fetching data from ${url}: ${response.status} - ${response.statusText}`);
                            return null;
                        }
                        return await response.json();
                    } catch (error) {
                        console.error(`Error fetching data from ${url}:`, error);
                        return null;
                    }
                });

                return (await Promise.all(promises)).filter(data => data !== null);
            }

            try {
                // Process Brand Guide URLs
                const brandGuideUrlsText = getVal('generator_brand_guide_urls', "");
                const brandGuideData = await processUrls(
                    brandGuideUrlsText,
                    'https://i3oxhgicub.execute-api.ap-southeast-1.amazonaws.com/pdfParser'
                );

                // Process Reference URLs
                const referenceUrlsText = getVal('reference-url', "");
                const webpageData = await processUrls(
                    referenceUrlsText,
                    'https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing'
                );

                const contentData = {
                    reference_post: getVal('sample-text', ""),
                    content_type: getVal('content-type', "blog-post"),
                    post_info: getVal('post-info', ""),
                    subgroups: getVal('subgroups', ""),
                    painpoints: getVal('painpoints', ""),
                    audience_goal: getVal('audience_goal', ""),
                    product_service: getVal('product_service', ""),
                    desired_action: getVal('desired_action', ""),
                    post_objectives: getVal('post_objectives', ""),
                    word_count: getVal('word_count', ""),
                    tone: getVal('tone', ""),
                    usp: getVal('usp', ""),
                    pov: getVal('pov', ""),
                    emojis: getVal('emojis', "no"),
                    hashtags: getVal('hashtags', "no"),

                    // NEW: include new fields in payload (optional)
                    sensitivity: sensitivity,
                    response_objective: response_objective,
                    response_platform: response_platform,

                    brand_guide: brandGuideData,
                    webpage_data: webpageData
                };

                const response = await fetch('https://panc0eazwj.execute-api.ap-southeast-1.amazonaws.com/content-generator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(contentData)
                });

                const data = await response.json();

                // Display the API response or error
                if (response.ok) {
                    generatedContentDiv.innerHTML = `<p>${data}</p>`;
                } else {
                    generatedContentDiv.innerHTML = `<p class="error">Error: ${data.error || response.statusText}</p>`;
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                generatedContentDiv.innerHTML = '<p class="error">An error occurred while fetching data.</p>';
            } finally {
                // Re-enable the button and reset text
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Content';

                // NOTE: "#green" is invalid. Use "green" or a hex code.
                document.getElementById("smm").style.backgroundColor = "green";
            }
        });


        function removeFaqItem(button) {
            const item = button.parentNode;
            item.remove();
            updateSchema(); // Update the schema after removing an item
        }

        let breadcrumbItemCount = 2; // Start with 2 items
        function addItem() {
            breadcrumbItemCount++;
            const breadcrumbItemsDiv = document.getElementById('breadcrumb-items');
            const newItem = document.createElement('div');
            newItem.className = "breadcrumb-item";
            newItem.innerHTML = `
            <input type="text" id="name${breadcrumbItemCount}" placeholder="Page #${breadcrumbItemCount}'s name" oninput="updateSchema()">
            <input type="url" id="url${breadcrumbItemCount}" placeholder="URL #${breadcrumbItemCount}" oninput="updateSchema()">
            <button class="remove-item" onclick="removeItem(this)">x</button>
        `;
            breadcrumbItemsDiv.appendChild(newItem);

            // Attach event listeners to new elements
            newItem.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updateSchema);
            });

            updateSchema();
        }

        function removeItem(button) {
            const item = button.parentNode;
            item.remove();
            updateSchema();
        }

        const schemaTypeSelect = document.getElementById('schema-type');
        const inputFieldsDiv = document.getElementById('input-fields');
        const schemaOutputDiv = document.getElementById('schema-output');

        const templates = {
            "LocalBusiness": Handlebars.compile(document.getElementById('local-business-template').innerHTML),
            "Product": Handlebars.compile(document.getElementById('product-template').innerHTML),
            "Event": Handlebars.compile(document.getElementById('event-template').innerHTML),
            "Article": Handlebars.compile(document.getElementById('article-template').innerHTML),
            "BreadcrumbList": Handlebars.compile(document.getElementById('breadcrumblist-template').innerHTML),
            "FAQPage": Handlebars.compile(document.getElementById('faqpage-template').innerHTML),
            "HowTo": Handlebars.compile(document.getElementById('howto-template').innerHTML),
            "JobPosting": Handlebars.compile(document.getElementById('jobposting-template').innerHTML),
            "Organization": Handlebars.compile(document.getElementById('organization-template').innerHTML),
            "Person": Handlebars.compile(document.getElementById('person-template').innerHTML),
            "VideoObject": Handlebars.compile(document.getElementById('video-object-template').innerHTML),
            "Website": Handlebars.compile(document.getElementById('website-template').innerHTML),
        }

        let faqItemCount = 1;

        schemaTypeSelect.addEventListener('change', () => {
            const selectedType = schemaTypeSelect.value;
            const template = templates[selectedType];

            if (template) {
                inputFieldsDiv.innerHTML = template();
                updateSchema(); // Initial update after template render
            } else {
                inputFieldsDiv.innerHTML = ''; // Clear if no template exists
                schemaOutputDiv.textContent = '';
            }


            // Add event listeners after rendering the template
            inputFieldsDiv.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updateSchema);
            });
        });

        // Initial setup (trigger the change event once to populate fields for default type)
        schemaTypeSelect.dispatchEvent(new Event('change'));

        function updateSchema() {
            const selectedType = schemaTypeSelect.value;
            const data = {};

            // Gather input values based on the selected schema type
            for (const input of inputFieldsDiv.querySelectorAll('input')) {
                data[input.id] = input.value;
            }

            try {

                const schema = {
                    "@context": "https://schema.org",
                    "@type": selectedType,
                    ...data // Spread the input data into the schema object
                };

                // Special handling for fields that require JSON-LD structures:
                if (selectedType === "FAQPage" && data.mainEntity) {
                    schema.mainEntity = JSON.parse(data.mainEntity);
                }
                if (selectedType === "BreadcrumbList" && data.itemListElement) {
                    schema.itemListElement = JSON.parse(data.itemListElement);
                }

                if (selectedType === "BreadcrumbList") {
                    const itemListElement = [];

                    for (let i = 1; i <= breadcrumbItemCount; i++) {
                        const name = document.getElementById(`name${i}`);
                        const url = document.getElementById(`url${i}`);

                        if (name && url && name.value && url.value) {
                            itemListElement.push({
                                "@type": "ListItem",
                                "position": i,
                                "name": name.value,
                                "item": url.value
                            });
                        }

                    }
                    if (itemListElement.length > 0) {
                        schema.itemListElement = itemListElement;
                    }

                }


                if (selectedType === "FAQPage") {
                    const mainEntity = [];


                    for (let i = 1; document.getElementById(`question${i}`); i++) {
                        const question = document.getElementById(`question${i}`).value;
                        const answer = document.getElementById(`answer${i}`).value;

                        if (question && answer) {  // Make sure both question and answer are filled
                            mainEntity.push({
                                "@type": "Question",
                                "name": question,
                                "acceptedAnswer": {
                                    "@type": "Answer",
                                    "text": answer
                                }
                            });
                        }

                    }

                    if (mainEntity.length > 0) { // Only add mainEntity if there are FAQ items
                        schema.mainEntity = mainEntity;
                    }

                }

                schemaOutputDiv.textContent = '<script type="application/ld+json">\n' + JSON.stringify(schema, null, 2) + '\n<\/script>';

            } catch (error) {
                schemaOutputDiv.textContent = "Invalid JSON-LD input in one of the fields.";
                console.error("JSON Parsing Error:", error);
            }
        }

        function similarKeywords() {
            const keywordsInput = document.getElementById('keywords').value.split(/[\n,]+/).map(k => k.trim());
            const location = document.getElementById('location').value;
            const language = document.getElementById('language').value;

            if (keywordsInput[0] == "") {
                alert('Please enter keyword(s).');
                return;
            }
            if (!location) {
                alert('Please select a location.');
                return;
            }

            document.getElementById("keyword_suggestions").style.backgroundColor = "#004c9d";
            document.getElementById("expandSimilarKeywords").style.backgroundColor = "#004c9d";
            document.getElementById('keyword_suggestions').innerText = "Generating Similar Keywords..";

            var url = "https://lgvdhcs4t2.execute-api.ap-southeast-1.amazonaws.com/similarKeywords";
            var queryString = {
                "keywords": keywordsInput,
                "location": location,
                "language": language,
                "user": JSON.parse(localStorage.getItem('googleUser')).email
            };

            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json",
            };
            fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(queryString)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                    document.getElementById('rankingError').innerText = "";
                    displaySimilarKeywords(data);
                    document.getElementById("keyword_suggestions").style.backgroundColor = "green";
                    document.getElementById("expandSimilarKeywords").style.backgroundColor = "green";
                    const keywordSuggestions = document.getElementById("keywordSuggestions");

                    const icon = document.getElementById("expandSimilarKeywords").querySelector('i');

                    if (keywordSuggestions.style.display === "block") {
                        document.getElementById('keyword_suggestions').innerText = "Keyword Suggestions (Similar Keywords / SERPs)";
                    }
                    else {
                        keywordSuggestions.style.display = "block";
                        icon.classList.remove('fa-plus-square');
                        icon.classList.add('fa-minus-square');
                        document.getElementById('keyword_suggestions').innerText = "Keyword Suggestions (Similar Keywords / SERPs)";
                    }
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                    document.getElementById("keyword_suggestions").style.backgroundColor = "#004c9d";
                    document.getElementById('keyword_suggestions').innerText = "Keyword Suggestions (Similar Keywords / SERPs)";
                });
            const tooltip = event.target.querySelector('span');  // Get the tooltip span
            if (tooltip) { // Check if the span element exists
                // The tooltip will now position itself correctly due to the CSS changes
            }
        }

        function rankingKeywords() {
            var domain = document.getElementById('domain').value.replace('www.', '').replace('htttps://', '').replace('http://', '');
            var location = document.getElementById('location').value;

            document.getElementById('rankingError').textContent = '';
            document.getElementById("ranking_keywords").style.backgroundColor = "#004c9d";
            document.getElementById("expandRankingKeywords").style.backgroundColor = "#004c9d";

            if (!domain) {
                alert('Please enter a URL or domain.');
                return;
            }
            if (!location) {
                alert('Please select a location.');
                return;
            }

            document.getElementById('ranking_keywords').innerText = "Getting Ranked Keywords..";

            var url = "https://0dqny7l5y9.execute-api.ap-southeast-1.amazonaws.com/rankingKeywords";

            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json",
            };

            var queryString = {
                "target": domain,
                "location": location,
                "user": JSON.parse(localStorage.getItem('googleUser')).email
            };

            fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(queryString)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayRankedKeywords(data.body);
                    document.getElementById('ranking_keywords').innerText = "Ranking Keywords";
                    document.getElementById("ranking_keywords").style.backgroundColor = "green";
                    document.getElementById("expandRankingKeywords").style.backgroundColor = "green";
                    const rankingKeywordsDiv = document.getElementById("rankingKeywords");
                    const icon = document.getElementById("expandRankingKeywords").querySelector('i');

                    if (rankingKeywordsDiv.style.display === "block") {
                        console.log('Ranking Keywords already displayed');

                    } else {
                        console.log('ranking keywords not displayed');
                        rankingKeywordsDiv.style.display = "block"; // Show the element
                        icon.classList.remove('fa-plus-square');
                        icon.classList.add('fa-minus-square');
                    }
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                    document.getElementById('ranking_keywords').innerText = "Ranking Keywords";  // Consistent use of innerText
                    document.getElementById("ranking_keywords").style.backgroundColor = "#004c9d";
                });
            const tooltip = event.target.querySelector('span');  // Get the tooltip span
            if (tooltip) { // Check if the span element exists
                // The tooltip will now position itself correctly due to the CSS changes
            }
        }

        const modalCache = {};

        function showSerps(keyword) {
            serpSection = document.getElementById("serp-section");
            serpSection.innerHTML = '<div><h2 id="modalKeyword"></h2><b>Search Volume: ' + keywordsCache[keyword]['search_vol'] + '  |  Difficulty: ' + keywordsCache[keyword]['competition'] + '</b><div id="modalContent"></div></div>';
            document.getElementById("modalKeyword").textContent = keyword;

            document.getElementById("modalContent").innerHTML = "<p>Loading SERPs for " + keyword + "...</p>"; // Placeholder

            if (modalCache[keyword]) {
                document.getElementById("modalContent").innerHTML = modalCache[keyword];
                return; // Exit early if data is in cache
            }

            serpModal(keyword).then(data => {
                if (data.error) {
                    document.getElementById("modalContent").innerHTML = "<p class='error'>Error: " + data.error + "</p>";
                    return;
                }

                modalCache[keyword] = document.getElementById("modalContent").innerHTML;

                const urls = Object.values(data.body).map(result => result.url);
                const metricsPromises = urls.map(url => fetchMetrics(url));

                Promise.all(metricsPromises)
                    .then(metricsResults => {
                        addMetricsToTable(data, metricsResults);

                        // Cache the final table HTML
                        modalCache[keyword] = document.getElementById("modalContent").innerHTML;
                    })
                    .catch(error => {
                        console.error("Error fetching metrics:", error);
                        document.getElementById("modalContent").innerHTML += "<p class='error'>Error fetching some metrics.</p>";
                    });

            });

        }

        async function serpModal(keyword) {
            const language = document.getElementById('language').value;
            const location = document.getElementById('location').value;
            user = JSON.parse(localStorage.getItem('googleUser')).email;
            try {
                const response = await fetch('https://8k6r15rg4m.execute-api.ap-southeast-1.amazonaws.com/serpLite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword, language, location, user }),
                });
                const serpData = await response.json();

                // Check for errors in SERP data
                if (serpData.error || serpData.statusCode !== 200) {
                    throw new Error("SERP API Error: " + (serpData.error || "Status code " + serpData.statusCode));
                }

                displayInitialTable(serpData);

                return serpData;


            } catch (error) {
                console.error("Error fetching data:", error);
                return { error: error.message }; // Return error message
            }
        }

        // Function to close the modal
        function closeModal() {
            const modal = document.getElementById("keywordModal");
            if (modal) {
                modal.style.display = "none";
            }
        }

        async function fetchMetrics(domain) { // for moz
            try {
                const response = await fetch('https://a7hptjtc8e.execute-api.ap-southeast-1.amazonaws.com/new', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain })
                });

                if (!response.ok) {
                    throw new Error(`Metrics API Error: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();

                console.log(data);

                return { "DA": data.domain_authority };

                return data.body; // Return the body directly
            } catch (error) {
                console.error("Error fetching metrics:", error);
                return { error: error.message }; // Return error object, better for handling
            }
        }

        function displayInitialTable(data) {
            let tableHtml = "<table><tr><th>Rank</th><th>URL</th><th>Title</th><th>Description</th></tr>";
            for (const rank in data.body) {
                const result = data.body[rank];
                tableHtml += `<tr><td>${rank}</td><td><a href="${result.url}" target="_blank">${result.url.replace('https://', '').replace('http://', '').replace('www.', '')}</a></td><td>${result.title}</td><td>${result.description}</td></tr>`;
            }
            tableHtml += "</table>";
            document.getElementById("modalContent").innerHTML = tableHtml;
        }

        function addMetricsToTable(data, metricsResults) {
            const table = document.getElementById("modalContent").querySelector("table");

            // Add header cells for metrics
            const headerRow = table.rows[0];
            const firstResultMetrics = metricsResults[0] || {}; //Handle missing metrics
            if (!firstResultMetrics.error) {
                for (const metricKey in firstResultMetrics) {
                    if (metricKey !== 'visible_text' && metricKey !== 'word_count' && metricKey !== 'title' && metricKey !== 'description' && metricKey !== 'click_depth') {
                        const th = document.createElement("th");
                        th.textContent = metricKey.replace(/_/g, ' ').toUpperCase();
                        headerRow.appendChild(th);
                    }
                }
            }

            // Add metric data to rows
            for (let i = 0; i < metricsResults.length; i++) {
                const row = table.rows[i + 1]; // Skip header row
                const metrics = metricsResults[i] || {};
                if (!metrics.error) {
                    for (const metricKey in firstResultMetrics) {   //Use firstResultMetrics for keys order
                        if (metricKey !== 'visible_text' && metricKey !== 'word_count' && metricKey !== 'title' && metricKey !== 'description' && metricKey !== 'click_depth') {

                            if (metrics.hasOwnProperty(metricKey)) {
                                const cell = row.insertCell();
                                cell.textContent = metrics[metricKey];
                            } else {
                                row.insertCell(); // Add an empty cell if the metric is missing
                            }

                        }
                    }
                } else {
                    // Add empty cells for all metrics if there is an error
                    for (const metricKey in firstResultMetrics) {
                        if (metricKey !== 'visible_text' && metricKey !== 'word_count' && metricKey !== 'title' && metricKey !== 'description' && metricKey !== 'click_depth') {
                            row.insertCell();
                        }
                    }
                }
            }
        }

        function displayRankedKeywords(rankedKeywordsData) {
            const rankedKeywordList = document.getElementById('rankedKeywordList');
            rankedKeywordList.innerHTML = ''; // Clear previous keywords

            const headerCells = Array.from(document.querySelectorAll('#rankedKeywordHeaderRow .keyword-column'));

            // 1. Transform the data:
            const rankedKeywordsArray = Object.entries(rankedKeywordsData).map(([keyword, data]) => ({
                keyword: keyword,
                search_volume: data.search_volume,
                rank: data.rank,
                difficulty: data.difficulty
            }));

            rankedKeywordsArray.forEach((keywordObj, index) => {
                const listItem = document.createElement('li');
                listItem.classList.add('keyword-row');

                // Keyword column
                const keywordDiv = document.createElement('div');
                keywordDiv.classList.add('keyword-column');
                keywordDiv.style.width = `${headerCells[0].offsetWidth}px`;
                keywordDiv.textContent = keywordObj.keyword;
                listItem.appendChild(keywordDiv);

                // Search Volume column
                const searchVolumeDiv = document.createElement('div');
                searchVolumeDiv.classList.add('keyword-column');
                searchVolumeDiv.style.width = `${headerCells[1].offsetWidth}px`;
                searchVolumeDiv.textContent = keywordObj.search_volume != null ? keywordObj.search_volume.toLocaleString() : '-'; // Handle null search volume
                listItem.appendChild(searchVolumeDiv);

                // Rank
                const rankDiv = document.createElement('div');
                rankDiv.classList.add('keyword-column');
                rankDiv.style.width = `${headerCells[2].offsetWidth}px`;
                rankDiv.textContent = keywordObj.rank || '-';
                listItem.appendChild(rankDiv);

                // Difficulty column
                const difficultyDiv = document.createElement('div');
                difficultyDiv.classList.add('keyword-column');
                difficultyDiv.style.width = `${headerCells[3].offsetWidth}px`;
                difficultyDiv.textContent = keywordObj.difficulty || '-';
                listItem.appendChild(difficultyDiv);

                // Checkbox column
                const checkboxDiv = document.createElement('div');
                checkboxDiv.classList.add('checkbox-column');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = `chk${index + 1}`;
                checkbox.id = `chk${index + 1}`;
                checkbox.value = keywordObj.keyword;
                checkbox.checked = false;
                checkbox.addEventListener('change', updateKeywordsField);
                checkboxDiv.appendChild(checkbox);
                listItem.appendChild(checkboxDiv);

                rankedKeywordList.appendChild(listItem);
            });
            updateRankedKeywordsCount();
            document.getElementById('rankingKeywordsExport').style.display = 'block';
            rankedKeywordList.innerHTML += '<button type="button" id="get-more-keywords-button" onclick="getMoreRanked()">Get More Keywords</button>';
        }

        document.getElementById('rankedKeywordList').addEventListener('change', function (event) {
            if (event.target.type === 'checkbox') { // Only handle checkbox changes
                updateKeywordsField();
            }
        });


        const keywordTable = document.getElementById('keywordTable');
        const top100Table = document.getElementById('top100Table');

        async function getMoreRanked() {
            document.getElementById('rankedKeywordList').innerHTML = document.getElementById('rankedKeywordList').innerHTML.replace('<button type="button" id="get-more-keywords-button" onclick="getMoreRanked()">Get More Keywords</button>', '<button type="button" disabled id="get-more-keywords-button" onclick="getMoreRanked()">Getting Keywords</button>')
            const target = document.getElementById('domain').value;
            const language = document.getElementById('language').value;
            const location = document.getElementById('location').value;

            const apiUrl = 'https://ei6xj9x2rd.execute-api.ap-southeast-1.amazonaws.com/keywordsForSite';
            const requestBody = {
                location: location,
                language: language,
                target: target
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Clear existing table rows (except header)
                while (keywordTable.rows.length > 1) {
                    keywordTable.deleteRow(1);
                }

                // Clear top100Table rows (except header) before new data is added
                while (top100Table.rows.length > 1) {
                    top100Table.deleteRow(1);
                }

                document.getElementById("get-more-keywords-button").remove();

                const rankCheckerPromises = []; // Store promises for rank checking API calls

                for (const keyword in data) {
                    const row = keywordTable.insertRow();
                    const keywordCell = row.insertCell();
                    const volumeCell = row.insertCell();
                    const competitionCell = row.insertCell();
                    const rankCell = row.insertCell(); // New cell for rank

                    keywordCell.innerHTML = keyword;
                    volumeCell.innerHTML = data[keyword].search_volume;
                    competitionCell.innerHTML = data[keyword].competition || "N/A"; // Handle null competition

                    // Make rank checker API call and update rankCell when resolved
                    const rankCheckerApiUrl = 'https://v5bizygr4m.execute-api.ap-southeast-1.amazonaws.com/rankChecker';
                    const rankRequestBody = {
                        keyword: keyword,
                        language: language,
                        location: location,
                        target: target
                    };

                    const rankPromise = fetch(rankCheckerApiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(rankRequestBody)
                    }).then(res => {
                        if (!res.ok) {
                            throw new Error(`Rank checker HTTP error! status: ${res.status}`);
                        }
                        return res.json();
                    }).then(rankData => {

                        rankCell.innerHTML = rankData || 999; // Handle cases where rank is unavailable

                        const rank = parseInt(rankData); // Parse rankData to integer
                        if (rank >= 1 && rank <= 100) {
                            const top100Row = top100Table.insertRow();
                            const top100KeywordCell = top100Row.insertCell();
                            const top100VolumeCell = top100Row.insertCell();
                            const top100CompetitionCell = top100Row.insertCell();
                            const top100RankCell = top100Row.insertCell();

                            top100KeywordCell.innerHTML = keyword;
                            top100VolumeCell.innerHTML = data[keyword].search_volume;
                            top100CompetitionCell.innerHTML = data[keyword].competition || "N/A";
                            top100RankCell.innerHTML = rank;

                            const rankedKeywordList = document.getElementById('rankedKeywordList');
                            const headerCells = Array.from(document.querySelectorAll('#rankedKeywordHeaderRow .keyword-column'));
                            const currentKeywordCount = rankedKeywordList.querySelectorAll('li.keyword-row').length; //Correct length

                            // Append to rankedKeywordList (using a separate function for clarity)
                            appendRankedKeyword({ // Pass data as an object
                                keyword: keyword,
                                search_volume: data[keyword].search_volume,
                                rank: rank, // Use the parsed rank value
                                difficulty: data[keyword].competition || "N/A"
                            }, rankedKeywordList.children.length, headerCells, rankedKeywordList); // Use children.length to get correct index
                        }
                    }).catch(error => {
                        console.error('Error checking rank:', error);
                        rankCell.innerHTML = "Error"; // Indicate an error in the rank cell
                    });
                    rankCheckerPromises.push(rankPromise);
                }
                // Wait for all rank checking API calls to complete
                await Promise.all(rankCheckerPromises);


            } catch (error) {
                console.error('Error fetching keyword data:', error);
                // Display error message in the table or elsewhere on the page
                keywordTable.innerHTML = "<tr><td>Error fetching data.</td></tr>";

            }

        }

        function appendRankedKeyword(item, index, headerCells, rankedKeywordList) {
            const listItem = document.createElement('li');
            listItem.classList.add('keyword-row');

            // Column 0: Keyword
            const keywordDiv = document.createElement('div');
            keywordDiv.classList.add('keyword-column');
            keywordDiv.textContent = item.keyword;
            listItem.appendChild(keywordDiv);

            // Column 1: Search Volume
            const searchVolumeDiv = document.createElement('div');
            searchVolumeDiv.classList.add('keyword-column');
            searchVolumeDiv.textContent = item.search_volume || '-';
            listItem.appendChild(searchVolumeDiv);

            // Column 2: Rank
            const rankDiv = document.createElement('div');
            rankDiv.classList.add('keyword-column');
            rankDiv.textContent = item.rank || '-';
            listItem.appendChild(rankDiv);

            // Column 3: Difficulty
            const difficultyDiv = document.createElement('div');
            difficultyDiv.classList.add('keyword-column');
            difficultyDiv.textContent = item.difficulty || '-';
            listItem.appendChild(difficultyDiv);

            // Column 4: Checkbox
            const checkboxDiv = document.createElement('div');
            checkboxDiv.classList.add('checkbox-column');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = item.keyword;
            checkbox.addEventListener('change', updateKeywordsField);
            checkboxDiv.appendChild(checkbox);
            listItem.appendChild(checkboxDiv);

            rankedKeywordList.appendChild(listItem);
            updateRankedKeywordsCount();

            document.getElementById('rankedKeywordList').innerHTML = document.getElementById('rankedKeywordList').innerHTML.replace('<button type="button" disabled id="get-more-keywords-button" onclick="getMoreRanked()">Getting Keywords</button>', '');
        }

        keywordsCache = {};

        function displaySimilarKeywords(keywordsData) {
            const keywordList = document.getElementById('keywordList');
            keywordList.innerHTML = ''; // Clear previous keywords

            const headerCells = Array.from(document.querySelectorAll('#keywordHeaderRow .keyword-column'));

            // 1. Transform the data:
            const keywordsArray = Object.entries(keywordsData.body).map(([keyword, data]) => ({
                keyword,
                search_volume: data.search_volume,
                competition: data.competition,
                cpc: data.cpc
            }));

            keywordsArray.forEach((keywordObj, index) => {
                const listItem = document.createElement('li');
                listItem.classList.add('keyword-row');

                // Keyword column
                const keywordDiv = document.createElement('div');
                keywordDiv.classList.add('keyword-column');
                keywordDiv.style.width = `${headerCells[0].offsetWidth}px`;
                keywordDiv.textContent = keywordObj.keyword;
                keywordDiv.addEventListener('click', () => showSerps(keywordObj.keyword));
                listItem.appendChild(keywordDiv);

                // Search Volume column
                const searchVolumeDiv = document.createElement('div');
                searchVolumeDiv.classList.add('keyword-column');
                searchVolumeDiv.style.width = `${headerCells[1].offsetWidth}px`;
                searchVolumeDiv.textContent = keywordObj.search_volume != null ? keywordObj.search_volume.toLocaleString() : '-'; // Handle null search volume
                listItem.appendChild(searchVolumeDiv);

                // Difficulty column
                const difficultyDiv = document.createElement('div');
                difficultyDiv.classList.add('keyword-column');
                difficultyDiv.style.width = `${headerCells[2].offsetWidth}px`;
                difficultyDiv.textContent = keywordObj.competition || '-';
                listItem.appendChild(difficultyDiv);

                // CPC column
                const cpcDiv = document.createElement('div');
                cpcDiv.classList.add('keyword-column');
                cpcDiv.style.width = `${headerCells[3].offsetWidth}px`;
                cpcDiv.textContent = keywordObj.cpc || '-';
                listItem.appendChild(cpcDiv);

                // Checkbox column
                const checkboxDiv = document.createElement('div');
                checkboxDiv.classList.add('checkbox-column');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = `chk${index + 1}`;
                checkbox.id = `chk${index + 1}`;
                checkbox.value = keywordObj.keyword;
                checkbox.checked = false;
                checkbox.addEventListener('change', updateKeywordsField);
                checkboxDiv.appendChild(checkbox);
                listItem.appendChild(checkboxDiv);

                keywordList.appendChild(listItem);

                keywordsCache[keywordObj.keyword] = {};
                keywordsCache[keywordObj.keyword]['search_vol'] = keywordObj.search_volume != null ? keywordObj.search_volume.toLocaleString() : '-';
                keywordsCache[keywordObj.keyword]['competition'] = keywordObj.competition;
                keywordsCache[keywordObj.keyword]['cpc'] = keywordObj.cpc;
            });
            document.getElementById('keywordSuggestionsExport').style.display = 'block';
        }

        function updateRankedKeywordsCount() {
            const rankedKeywordList = document.getElementById('rankedKeywordList');
            const count = rankedKeywordList.querySelectorAll('li.keyword-row').length; // Count only the keyword rows (li elements)
            const heading = document.getElementById('rankedKeywordsCount');
            heading.textContent = `Ranked Keywords (${count}):`; // Update the heading text
        }

        function updateKeywordCount() {
            const keywordsTextArea = document.getElementById('keywords');
            const keywords = keywordsTextArea.value.split(/[\n,]+/).map(k => k.trim()).filter(Boolean); // Split by comma or newline, trim whitespace, remove empty strings
            const keywordCountSpan = document.getElementById('keywordCount');
            keywordCountSpan.textContent = `${keywords.length} keyword(s) selected`;
        }

        function updateKeywordsField() {
            const keywordsTextArea = document.getElementById('keywords');
            const checkedKeywords = new Set(); // Use a Set to store unique values

            // Get checked keywords from both tables
            try {
                const rankedKeywordsCheckboxes = document.querySelectorAll('#rankedKeywordList input[type="checkbox"]:checked');
                rankedKeywordsCheckboxes.forEach(checkbox => checkedKeywords.add(checkbox.value));
            } catch (error) {
                console.log(error);
            }

            try {
                const similarKeywordsCheckboxes = document.querySelectorAll('#keywordList input[type="checkbox"]:checked');
                similarKeywordsCheckboxes.forEach(checkbox => checkedKeywords.add(checkbox.value));
            } catch (error) {
                console.log(error);
            }

            try {
                const webpageKeywordsCheckboxes = document.querySelectorAll('#siteKeywords input[type="checkbox"]:checked');
                webpageKeywordsCheckboxes.forEach(checkbox => checkedKeywords.add(checkbox.value));
            } catch (error) {
                console.log(error);
            }

            keywordsTextArea.value = Array.from(checkedKeywords).join(', '); // Convert Set back to array before joining
            updateKeywordCount();
        }

        function updateCompetitorDomainsField() {
            const domainsTextArea = document.getElementById('competitor_domains');
            const checkedDomains = new Set(); // Use a Set to store unique values

            // Get checked keywords from both tables
            try {
                const domainsCheckboxes = document.querySelectorAll('#competitorsOutput input[type="checkbox"]:checked');
                domainsCheckboxes.forEach(checkbox => checkedDomains.add(checkbox.value));
            } catch (error) {
                console.log(error);
            }

            domainsTextArea.value = Array.from(checkedDomains).join(', '); // Convert Set back to array before joining
        }

        async function validateAndSubmit() {
            const domain = document.getElementById('domain').value;
            const keywordsInput = document.getElementById('keywords').value;
            const location = document.getElementById('location').value;
            const language = document.getElementById('language').value;

            new_url = "?keywordAnalysis&location=" + location.replaceAll(" ", "%20") + "&language=" + language.replaceAll(" ", "%20") + "&target=" + domain.replace(":", "%3A").replaceAll("/", "%2F") + "&keywords=" + keywordsInput.split(/[\n,]+/).map(k => k.trim()).filter(Boolean).join("+").replaceAll(" ", "%20").replaceAll("'", "%27")

            window.history.replaceState({ path: new_url }, '', new_url);

            document.getElementById('domainError').textContent = '';
            document.getElementById('keywordsError').textContent = '';

            if (!keywordsInput) {
                document.getElementById('keywordsError').textContent = 'Please enter one or more keywords.';
                return;
            }
            if (!location) {
                alert("Please select a location.");
                return;
            }

            const keywords = keywordsInput.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);

            document.getElementById('targetTitle').innerText = "";
            document.getElementById('targetDescription').innerText = "";
            //document.getElementById('targetDomainRank').innerText = "";
            document.getElementById('targetBacklinks').innerText = "";
            document.getElementById('targetSpamScore').innerText = "";
            document.getElementById('targetRefDomains').innerText = "";
            document.getElementById('targetInternalLinks').innerText = "";
            document.getElementById('targetExternalLinks').innerText = "";
            document.getElementById('targetH1').innerText = "";
            document.getElementById('targetImages').innerText = "";
            document.getElementById('targetCls').innerText = "";
            document.getElementById('targetLcp').innerText = "";
            document.getElementById('targetFid').innerText = "";
            document.getElementById('targetSchema').innerText = "";
            document.getElementById('targetReadability').innerText = "";
            document.getElementById('targetWordCount').innerText = "";
            document.getElementById('da').innerText = "";
            document.getElementById('pa').innerText = "";

            document.getElementById("meta_data").style.backgroundColor = "#004c9d";
            document.getElementById("domain_metrics").style.backgroundColor = "#004c9d";
            document.getElementById("keywordAnalysisBtn").style.backgroundColor = "#004c9d";

            if (!domain) { // if no target URL / domain
            } else {
                fetchDomainMetrics(domain);
            }

            await fetchKeywordMetrics(keywords, location, language);

            // **AWAIT ALL `keywordAnalysis` CALLS**
            await Promise.all(keywords.map(async keyword => {
                try {
                    await keywordAnalysis(keyword, language, location, domain);
                } catch (error) {
                    console.error(`Error during analysis for keyword ${keyword}:`, error);
                    // Display error in the keyword's collapsible section
                    const keywordContainer = document.getElementById(`keyword-container-${keyword.replace(/\s+/g, '-')}`);
                    if (keywordContainer) {
                        keywordContainer.innerHTML += `<p class="error">Error during analysis: ${error.message}</p>`;
                    }
                }
            }));

            // **NOW, displayOverallSummaryTable AFTER `keywordAnalysis` IS DONE for all keywords**
            await displayOverallSummaryTable(keywords, location, language, domain);
            await timeToRankToDatabase();
        }

        function displayTargetContentTable(targetContent, containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Element with ID '${containerId}' not found.`);
                return;
            }

            let tableHTML = `
        <h2>Possible URLs for KW Mapping</h2>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>URL</th>
                <th>Title</th>
                <th>Description</th>
                <th>Domain Rank</th>
                <th>Backlinks</th>
                <th>Referring Domains</th>
                <th>Internal Links Count</th>
                <th>External Links Count</th>
                <th>Image Count</th>
                <th>CLS</th>
                <th>LCP</th>
                <th>FID</th>
                <th>Schema</th>
                <th>Readability</th>
                <th>Word Count</th>
                <th>Keyword in URL</th>
                <th>Keyword in Title</th>
                <th>Keyword in Description</th>
                <th>Keyword in H1</th>
                <th>Keyword in H2</th>
                <th>Keyword in Alt</th>
                <th>Keyword in Text</th>
              </tr>
            </thead>
            <tbody>
      `;

            targetContent.forEach(item => {
                tableHTML += `
            <tr>
              <td>${item.rank || 'N/A'}</td>
              <td><a href="${item.url}" target="_blank">${item.url}</a></td>
              <td>${item.title || 'N/A'}</td>
              <td>${item.description || 'N/A'}</td>
              <td>${item.domain_rank || 'N/A'}</td>
              <td>${item.backlinks || 'N/A'}</td>
              <td>${item.referring_domains || 'N/A'}</td>
              <td>${item.internal_links_count || 'N/A'}</td>
              <td>${item.external_links_count || 'N/A'}</td>
              <td>${item.image || 'N/A'}</td>
              <td>${item.cls || 'N/A'}</td>
              <td>${item.lcp || 'N/A'}</td>
              <td>${item.fid || 'N/A'}</td>
              <td>${item.schema || 'N/A'}</td>
              <td>${item.readability || 'N/A'}</td>
              <td>${item.word_count || 'N/A'}</td>
              <td>${item.eval?.kw_in_url || 'N/A'}</td>
              <td>${item.eval?.kw_in_title || 'N/A'}</td>
              <td>${item.eval?.kw_in_desc || 'N/A'}</td>
              <td>${item.eval?.kw_in_h1 || 'N/A'}</td>
              <td>${item.eval?.kw_in_h2 || 'N/A'}</td>
              <td>${item.eval?.kw_in_alt || 'N/A'}</td>
              <td>${item.eval?.kw_in_text || 'N/A'}</td>
            </tr>
          `;
            });

            tableHTML += `
            </tbody>
          </table>
        </div>
      `;

            container.innerHTML = tableHTML;
        }

        async function displaySerpResults(serpResults, containerId) {
            const resultsContainer = document.getElementById(containerId);
            if (!resultsContainer) {
                console.error(`Element with ID '${containerId}' not found.`);
                return;
            }

            let tableHTML = `
        <h2>SERP Results</h2>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>URL</th>
                <th>Title</th>
                <th>Description</th>
                <th>DA</th>
                <th>Domain Rank</th>
                <th>Backlinks</th>
                <th>Backlinks Spam Score</th>
                <th>Referring Domains</th>
                <th>Internal Links Count</th>
                <th>External Links Count</th>
                <th>Image Count</th>
                <th>CLS</th>
                <th>LCP</th>
                <th>FID</th>
                <th>Schema</th>
                <th>Readability</th>
                <th>Word Count</th>
                <th>Keyword in URL</th>
                <th>Keyword in Title</th>
                <th>Keyword in Description</th>
                <th>Keyword in H1</th>
                <th>Keyword in H2</th>
                <th>Keyword in Alt</th>
                <th>Keyword in Text</th>
              </tr>
            </thead>
            <tbody>
      `;

            serpResults.forEach(result => {
                console.log(result);
                tableHTML += `
            <tr>
              <td>${result.rank}</td>
              <td><a href="${result.url}" target="_blank">${result.url}</a></td>
              <td>${result.title}</td>
              <td>${result.description}</td>
              <td>${result.da}</td>
              <td>${result.domain_rank || 'N/A'}</td>
              <td>${result.backlinks || 'N/A'}</td>
              <td>${result.backlinks_spam_score || 'N/A'}</td>
              <td>${result.referring_domains || 'N/A'}</td>
              <td>${result.internal_links_count || 'N/A'}</td>
              <td>${result.external_links_count || 'N/A'}</td>
              <td>${result.image || 'N/A'}</td>
              <td>${result.cls || 'N/A'}</td>
              <td>${result.lcp || 'N/A'}</td>
              <td>${result.fid || 'N/A'}</td>
              <td>${result.schema || 'N/A'}</td>
              <td>${result.readability || 'N/A'}</td>
              <td>${result.word_count || 'N/A'}</td>
              <td>${result.eval?.kw_in_url || 'N/A'}</td>
              <td>${result.eval?.kw_in_title || 'N/A'}</td>
              <td>${result.eval?.kw_in_desc || 'N/A'}</td>
              <td>${result.eval?.kw_in_h1 || 'N/A'}</td>
              <td>${result.eval?.kw_in_h2 || 'N/A'}</td>
              <td>${result.eval?.kw_in_alt || 'N/A'}</td>
              <td>${result.eval?.kw_in_text || 'N/A'}</td>
            </tr>
          `;
            });

            tableHTML += `
            </tbody>
          </table>
        </div>
      `;

            resultsContainer.innerHTML = tableHTML;
        }

        function displayKeywordRecommendations(recommendations, containerId) {
            const recommendationsContainer = document.getElementById(containerId);
            if (!recommendationsContainer) {
                console.error(`Element with ID '${containerId}' not found.`);
                return;
            }

            recommendationsContainer.innerHTML = `${recommendations}`;
        }

        async function getKeywordRecommendations(keyword, language, location, target_url, serp_dict) {
            const keywordMappingEndpoint = 'https://c0bkxhc1s3.execute-api.ap-southeast-1.amazonaws.com/keywordMapping';
            const kwRecommendationsEndpoint = 'https://pkbguam62a.execute-api.ap-southeast-1.amazonaws.com/kwRecommendationsStructured';
            const targetContentTableContainerId = `target-content-table-container-${keyword.replace(/\s+/g, '-')}`;

            try {

                // 1. Keyword Mapping API
                const keywordMappingResponse = await fetch(keywordMappingEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        location: location,
                        keyword: keyword,
                        language: language,
                        target: target_url //use target_url instead of target.
                    })
                });

                if (!keywordMappingResponse.ok) {
                    throw new Error(`Keyword Mapping API Error for ${keyword}: ${keywordMappingResponse.status} ${keywordMappingResponse.statusText}`);
                }

                const keywordMappingData = await keywordMappingResponse.json();
                console.log(`Keyword Mapping API Response for ${keyword}:`, keywordMappingData);

                if (keywordMappingData && keywordMappingData.body && Array.isArray(keywordMappingData.body)) {
                    const targetUrls = keywordMappingData.body;

                    // 2. Get Domain Metrics for Target URLs & Rank Checking
                    const targetDataPromises = targetUrls.map(async (url) => {
                        const domainMetrics = await getDomainMetrics(url, keyword);

                        return {
                            url: url,
                            ...domainMetrics?.body,
                            title: keywordMappingData.dict[url]?.title || 'N/A',
                            description: keywordMappingData.dict[url]?.description || 'N/A'
                        };
                    });

                    const targetData = await Promise.all(targetDataPromises);

                    console.log(`Target Content with Metrics and Rank for ${keyword}:`, targetData);

                    //Get the rank from the targetData table
                    const targetDataWithRank = await Promise.all(
                        targetData.map(async (item) => {
                            const rankData = await getRankForUrl(item.url, keyword, language, location);
                            return {
                                ...item,
                                rank: rankData
                            };
                        })
                    );

                    displayTargetContentTable(targetDataWithRank, targetContentTableContainerId);

                    // 3. Call Keyword Recommendations API
                    if (serp_dict) {
                        const kwRecommendationsResponse = await fetch(kwRecommendationsEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                keyword: keyword,
                                target_content: targetDataWithRank.map(item => ({ url: item.url, domain_metrics: item, rank: item.rank })), // Pass all data as domain_metrics
                                serps_dict: serp_dict
                            })
                        });

                        if (!kwRecommendationsResponse.ok) {
                            throw new Error(`Keyword Recommendations API Error for ${keyword}: ${kwRecommendationsResponse.status} ${kwRecommendationsResponse.statusText}`);
                        }

                        const kwRecommendationsData = await kwRecommendationsResponse.json();
                        console.log(`Keyword Recommendations API Response for ${keyword}:`, kwRecommendationsData);

                        displayKeywordRecommendations(kwRecommendationsData.body, `recommendations-container-${keyword.replace(/\s+/g, '-')}`);

                        // Extract URL
                        //mapped_url = kwRecommendationsData.body.match(/(https?:\/\/|www\.)([a-zA-Z0-9.-]+(\.[a-zA-Z]{2,})+[a-zA-Z0-9_/\-\?=\&%\#\.]*)/gi)[0];

                        // Extract Time to Rank using regex
                        const timeToRankMatch = kwRecommendationsData.body.match(/(0-3 months|3-6 months|6-9 months|9-12 months|more than 12 months|More than 12 months)/);
                        const timeToRank = timeToRankMatch ? timeToRankMatch[0] : 'N/A';
                        return [timeToRank];
                    } else {
                        console.warn(`Skipping Keyword Recommendations for ${keyword} due to missing serp_dict.`);
                        return 'N/A';
                    }
                } else {
                    console.warn(`Invalid Keyword Mapping API response format for ${keyword}. Expected 'body' as array.`);
                    return 'N/A';
                }

            } catch (error) {
                console.error(`Error during Keyword Mapping, Target Content Processing, or Keyword Recommendations for ${keyword}:`, error);
                return 'N/A';
            }
        }

        async function getRankForUrl(url, keyword, language, location) {
            try {
                const rankCheckerResponse = await fetch('https://v5bizygr4m.execute-api.ap-southeast-1.amazonaws.com/rankChecker', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword: keyword,
                        language: language,
                        location: location,
                        target: url // Set target to the current URL
                    })
                });

                if (rankCheckerResponse.ok) {
                    const rankCheckerData = await rankCheckerResponse.json();
                    return rankCheckerData; // Returns rank number.
                } else {
                    console.error(`Rank Checker API error for ${url}:`, rankCheckerResponse.status);
                    return 'N/A';
                }
            } catch (error) {
                console.error(`Error fetching rank for ${url}:`, error);
                return 'N/A';
            }
        }

        let allKeywords = [];
        let currentSortColumn = null;
        let sortAscending = true;
        let keywordMetrics = {}; // Store search volume and cpc
        let summaryData = [];

        async function getDomainMetrics(url, keyword) {
            const domainMetricsEndpoint = 'https://5zdbpwaia5.execute-api.ap-southeast-1.amazonaws.com/pageDomainMetrics';

            try {
                const response = await fetch(domainMetricsEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url,
                        keyword: keyword
                    })
                });

                if (!response.ok) {
                    console.warn(`Domain Metrics API Error for URL ${url}: ${response.status} ${response.statusText}`);
                    return null;
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error(`Error fetching domain metrics for URL ${url}:`, error);
                return null;
            }
        }

        async function keywordAnalysis(keyword, language, location, target) {
            user = JSON.parse(localStorage.getItem('googleUser')).email;
            const analysisResultsContainer = document.getElementById('keyword-analysis-results');
            const keywordContainerId = `keyword-container-${keyword.replace(/\s+/g, '-')}`;
            const keywordContentId = `keyword-content-${keyword.replace(/\s+/g, '-')}`;
            const resultsContainerId = `results-container-${keyword.replace(/\s+/g, '-')}`;
            const targetContentTableContainerId = `target-content-table-container-${keyword.replace(/\s+/g, '-')}`;
            const recommendationsContainerId = `recommendations-container-${keyword.replace(/\s+/g, '-')}`;


            document.getElementById("keywordAnalysisBtn").style.backgroundColor = "#004c9d";

            let collapsibleSection = document.getElementById(keywordContainerId);

            if (collapsibleSection) {
                // Keyword section exists, overwrite the content
                console.log(`Overwriting existing collapsible section for keyword: ${keyword}`);
                const keywordContent = document.getElementById(keywordContentId);
                if (keywordContent) {
                    keywordContent.innerHTML = `
            <div id="${targetContentTableContainerId}"></div>
            <div id="${resultsContainerId}"></div>
            <div id="${recommendationsContainerId}"></div>
          `;
                } else {
                    console.warn(`Keyword content element not found: ${keywordContentId}`);
                    // Recreate the content container if it's missing.  This shouldn't normally happen.
                    collapsibleSection.innerHTML = `
            <button type="button" class="keywords-collapsible">${keyword}</button>
            <div class="keywords-content" id="${keywordContentId}">
                <div id="${targetContentTableContainerId}"></div>
                <div id="${resultsContainerId}"></div>
                <div id="${recommendationsContainerId}"></div>
            </div>
          `;

                    const collapsibles = document.querySelectorAll('.keywords-collapsible');

                    collapsibles.forEach(collapsible => {
                        collapsible.addEventListener('click', function () {
                            this.classList.toggle('keywords-active');
                            const content = this.nextElementSibling;

                            // Toggle the display style of the content
                            if (content.style.display === 'block') {
                                content.style.display = 'none';
                            } else {
                                content.style.display = 'block';
                            }
                        });
                    });
                }

            } else {
                // Keyword section doesn't exist, create a new one
                console.log(`Creating new collapsible section for keyword: ${keyword}`);
                collapsibleSection = document.createElement('div');
                collapsibleSection.id = keywordContainerId;
                collapsibleSection.innerHTML = `
            <button type="button" class="keywords-collapsible">${keyword}</button>
            <div class="keywords-content" id="${keywordContentId}">
                <div id="${targetContentTableContainerId}"></div>
                <div id="${resultsContainerId}"></div>
                <div id="${recommendationsContainerId}"></div>
            </div>
        `;
                analysisResultsContainer.appendChild(collapsibleSection);

                const collapsibles = document.querySelectorAll('.keywords-collapsible');

                collapsibles.forEach(collapsible => {
                    collapsible.addEventListener('click', function () {
                        this.classList.toggle('keywords-active');
                        const content = this.nextElementSibling;

                        // Toggle the display style of the content
                        if (content.style.display === 'block') {
                            content.style.display = 'none';
                        } else {
                            content.style.display = 'block';
                        }
                    });
                });
            }

            try {
                const serpEndpoint = 'https://8k6r15rg4m.execute-api.ap-southeast-1.amazonaws.com/serpLite';
                const serpResponse = await fetch(serpEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword: keyword,
                        language: language,
                        location: location,
                        user: user
                    })
                });

                if (!serpResponse.ok) {
                    throw new Error(`SERP API Error: ${serpResponse.status} ${serpResponse.statusText}`);
                }

                const serpData = await serpResponse.json();
                console.log(`SERP API Response for ${keyword}:`, serpData);

                if (!serpData || !serpData.body) {
                    throw new Error(`Invalid SERP API response format for ${keyword}. Expected 'body' property.`);
                }

                const serp_dict = serpData.body;

                // Fetch domain metrics for SERP results and then display them
                const serpResultsWithMetrics = await Promise.all(
                    Object.entries(serp_dict).map(async ([rank, result]) => {
                        const domainMetrics = await getDomainMetrics(result.url, keyword);
                        return {
                            rank: rank,
                            ...result,
                            ...domainMetrics?.body // Add domain metrics to the result object
                        };
                    })
                );

                displaySerpResults(serpResultsWithMetrics, resultsContainerId);

                keywordRecommendations = await getKeywordRecommendations(keyword, language, location, target, serp_dict)

                // Await the keyword recommendations
                const timeToRank = keywordRecommendations[0];

                // Update the keywordMetrics object with time to rank
                keywordMetrics[keyword] = {
                    ...keywordMetrics[keyword],
                    timeToRank: timeToRank
                };

                console.log("Keyword Metrics after keywordAnalysis:", keywordMetrics);

                await displayOverallSummaryTable(keywords, location, language, target);
                document.getElementById('keyword-research-analysis-button').innerText = "Get Time To Rank";

            } catch (error) {
                console.error(`An error occurred for ${keyword}:`, error);
                const container = document.getElementById(resultsContainerId);
                if (container) {
                    container.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                } else {
                    console.warn(`Results container not found: ${resultsContainerId}`);
                }
                document.getElementById('keyword-research-analysis-button').innerText = "Get Time To Rank";
            }
        }

        async function timeToRankToDatabase() {
            endpoint = "https://0tmfunltch.execute-api.ap-southeast-1.amazonaws.com/timeToRankToDatabase";

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    url: document.getElementById('domain').value,
                    keywords: document.getElementById('keywords').value,
                    language: document.getElementById('language').value,
                    location: document.getElementById('location').value,
                    ranking_keywords: document.getElementById('rankingKeywords').innerHTML,
                    webpage_keywords: document.getElementById('siteKeywords').innerHTML,
                    suggestion_keywords: document.getElementById('keywordSuggestions').innerHTML,

                    meta_data: document.getElementById('metaData').innerHTML,
                    domain_metrics: document.getElementById('domainMetrics').innerHTML,

                    time_to_rank_table: document.getElementById('overall-summary').innerHTML,
                    keyword_analysis: document.getElementById('keywordAnalysis').innerHTML,

                    user: JSON.parse(localStorage.getItem('googleUser')).email
                })
            })

            data = await response.json();
        }

        async function displayOverallSummaryTable(keywords, location, language, target) {
            keywordsInput = document.getElementById('keywords').value;
            keywords = keywordsInput.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);
            const summaryContainer = document.getElementById('overall-summary');
            if (!summaryContainer) {
                console.error("Summary container not found");
                return;
            }

            // Prepare the data for the summary table, using keywordMetrics
            summaryData = keywords.map((keyword, index) => {
                const metrics = keywordMetrics[keyword] || {
                    cpc: 'N/A',
                    search_volume: 'N/A',
                    timeToRank: 'N/A',
                    //mapping: '-'
                }; // Provide default values

                return {
                    No: index + 1,
                    keyword: keyword,
                    search_volume: metrics.search_volume || 'N/A',
                    cpc: metrics.cpc || 'N/A',
                    timeToRank: metrics.timeToRank || 'N/A',
                    reason: '', // Initialize the 'Reason' field
                    //mapping: metrics.mapping || '',
                };
            });


            let tableHTML = `
<h2>Overall Keyword Summary</h2>
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>No.</th>
                <th onclick="sortSummaryTable('keyword')">Keyword</th>
                <th onclick="sortSummaryTable('search_volume')">Search Volume</th>
                <th onclick="sortSummaryTable('cpc')">CPC</th>
                <th onclick="sortSummaryTable('timeToRank')">Time to Rank</th>
                <th>Reason</th>
                
            </tr>
        </thead>
        <tbody>
`;

            for (let index = 0; index < summaryData.length; index++) {
                const item = summaryData[index];
                const timeToRankClass = getTimeToRankClass(item.timeToRank);

                // Fetch initial reason from API
                const reason = await fetchReasonFromAPI(item.keyword, location, language, target);
                summaryData[index].reason = reason; // Update summaryData with initial reason

                tableHTML += `
    <tr>
      <td>${item.No}</td>
      <td>${item.keyword}</td>
      <td>${item.search_volume}</td>
      <td>${item.cpc}</td>
      <td class="${timeToRankClass}">${item.timeToRank}</td>
      <td><textarea class="multiline-input" id="reason-${index}" onchange="updateReason(${index}, this.value)">${reason}</textarea></td>
      </tr>
  `;
            }

            tableHTML += `
        </tbody>
    </table>
</div>
`;

            summaryContainer.innerHTML = tableHTML + '<button id="downloadCsvBtn" onclick="downloadOverallSummaryTableAsCSV()">Download Keyword Summary as CSV</button><br><br>';

            // Show the download button
            document.getElementById('overall-summary').style.display = 'block';
            document.getElementById('downloadCsvBtn').style.display = 'block';

            document.getElementById("keywordAnalysisBtn").style.backgroundColor = "green";

        }

        function getTimeToRankClass(timeToRank) {
            if (timeToRank === 'more than 12 months') {
                return 'time-to-rank-more-than-12';
            } else if (timeToRank === '9-12 months') {
                return 'time-to-rank-9-12';
            } else if (timeToRank === '6-9 months') {
                return 'time-to-rank-6-9';
            } else if (timeToRank === '3-6 months') {
                return 'time-to-rank-3-6';
            } else if (timeToRank === '0-3 months') {
                return 'time-to-rank-0-3';
            } else {
                return ''; // Default class or no class
            }
        }

        async function fetchReasonFromAPI(keyword, location, language, target) {
            const reasonApiEndpoint = "https://cdahvw5qi7.execute-api.ap-southeast-1.amazonaws.com/reasonForKwSelection";

            try {
                const response = await fetch(reasonApiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        location: location,
                        language: language,
                        target: target,
                        keyword: keyword
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.body;
                } else {
                    console.error("Error fetching reason from API:", response.status);
                    return ''; // Return empty string in case of error
                }
            } catch (error) {
                console.error("Error fetching reason from API:", error);
                return ''; // Return empty string in case of error
            }
        }

        // Function to update the 'Reason' in the summaryData array
        function updateReason(index, reason) {
            summaryData[index].reason = reason;
        }

        let currentSummarySortColumn = null;
        let summarySortAscending = true;

        function fetchDomainMetrics(domain) {
            document.getElementById('keyword-research-analysis-button').innerText = "Analysing...";

            //moz 
            var url = "https://a7hptjtc8e.execute-api.ap-southeast-1.amazonaws.com/new";
            var queryString = {
                "domain": domain
            };
            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json"
            };
            fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(queryString)
            })
                .then(response => {
                    // Check if the response is successful
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('da').innerText = data.domain_authority;
                    document.getElementById('pa').innerText = data.page_authority;
                })
                .catch(error => {
                    console.error("Error fetching data:", error); // Log any errors
                    // Handle the error gracefully, perhaps display an error message to the user
                });

            api_url = "https://9px7sjbyyb.execute-api.ap-southeast-1.amazonaws.com/new";
            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json"
            };
            fetch(api_url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ url: domain })
            }).then(response => {
                // Check if the response is successful
                if (!response.ok) {
                    throw new Error(`Error obtaining domain metrics Status: ${response.status}`);
                }
                return response.json();
            })
                .then(data => {
                    console.log(data);
                    document.getElementById('targetTitle').innerText = data.body.title;
                    document.getElementById('targetDescription').innerText = data.body.description;
                    document.getElementById('targetBacklinks').innerText = data.body.backlinks;
                    document.getElementById('targetSpamScore').innerText = data.body.backlinks_spam_score;
                    document.getElementById('targetRefDomains').innerText = data.body.referring_domains;
                    document.getElementById('targetInternalLinks').innerText = data.body.internal_links_count;
                    document.getElementById('targetExternalLinks').innerText = data.body.external_links_count;
                    document.getElementById('targetH1').innerText = data.body.h1;
                    document.getElementById('targetImages').innerText = data.body.image;
                    document.getElementById('targetCls').innerText = data.body.cls;
                    document.getElementById('targetLcp').innerText = data.body.lcp;
                    document.getElementById('targetFid').innerText = data.body.fid;
                    document.getElementById('targetSchema').innerText = data.body.schema;
                    document.getElementById('targetReadability').innerText = data.body.readability;
                    document.getElementById('targetWordCount').innerText = data.body.word_count;

                    document.getElementById("meta_data").style.backgroundColor = "green";
                    document.getElementById("domain_metrics").style.backgroundColor = "green";
                })
                .catch(error => {
                    console.error("Error fetching targeted domain data:", error); // Log any errors
                    // Handle the error gracefully, perhaps display an error message to the user
                });
        }

        async function fetchSerpResults(keyword, location, domain) {
            user = JSON.parse(localStorage.getItem('googleUser')).email
            const apiEndpoint = "https://u22k9g2y8c.execute-api.ap-southeast-1.amazonaws.com/new";
            const requestBody = {
                location: location,
                keyword: keyword,
                targeted_url: domain,
                language: document.getElementById("location").value,
                user: user
            };

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                console.log(data);
                return data;
            } catch (error) {
                console.error('Error fetching SERP data:', error);
                return null;
            }
        }

        function removeRow(button) {
            let row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
        }

        function sortTable(column) {
            const table = document.getElementById("keywordResults");
            const rows = Array.from(table.rows);
            const dir = this.asc ? 'asc' : 'desc';

            rows.sort((a, b) => {
                // **Convert cell content to numbers before comparison:**
                const ax = parseFloat(a.cells[column].textContent) || 0; // Use parseFloat for numbers, 0 for non-numeric
                const bx = parseFloat(b.cells[column].textContent) || 0;

                return (ax > bx) ? (dir === 'asc' ? 1 : -1) : (ax < bx ? (dir === 'asc' ? -1 : 1) : 0);
            });

            rows.forEach(row => table.appendChild(row));
            this.asc = !this.asc;
        }

        function downloadSemCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";

            const generatedDiv = document.getElementById('generated');
            const tablesAndHeadings = Array.from(generatedDiv.querySelectorAll('h3, table')); // Select both h3 and table

            tablesAndHeadings.forEach((element, index) => {
                if (element.tagName === 'H3') {  // Check if it's a heading
                    const headingText = element.textContent.trim().replace(/_/g, ' ').toUpperCase(); //Add same formatting
                    const nextElement = tablesAndHeadings[index + 1]; // Check if next element exists

                    if (nextElement && nextElement.tagName === 'TABLE') {
                        const rows = Array.from(nextElement.querySelectorAll("tr"));

                        rows.forEach(row => {
                            const cells = Array.from(row.querySelectorAll("th, td"));

                            if (cells.length >= 2) { //Check if remove cell exists
                                cells.splice(1, 1); //Remove remove cell
                            }
                            //Replace 'Value' with headingText
                            if (cells.length > 0 && cells[0].textContent.trim() === 'Value') {
                                cells[0].textContent = headingText;
                            }

                            const rowText = cells.map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`).join(",");
                            csvContent += rowText + "\n";

                        });

                        csvContent += "\n"; // Add an empty row after each table's data
                    }


                }
            });


            // Create a hidden link element and trigger a click to download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "generated_sem.csv");
            document.body.appendChild(link); // Required for Firefox
            link.click(); // This will download the data file
            document.body.removeChild(link); // Cleanup 
        }

        function downloadKeywordAnalysisTableAsCSV() {
            const table = document.getElementById("keywordAnalysisResults").querySelector('table');
            if (!table) {
                console.error("Table not found!");
                return;
            }

            const rows = Array.from(table.querySelectorAll("tr"));

            // Add UTF-8 BOM (Byte Order Mark) to ensure proper encoding in Excel
            let csvContent = "\uFEFF";  // Unicode BOM
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll("th, td"));
                csvContent += cells.map(cell => {
                    let cellText = cell.textContent.trim();
                    if (!cellText && cell.innerHTML) {
                        cellText = cell.innerHTML.replace(/<[^>]*>/g, "").trim();
                    }

                    // **DEBUGGING:  Inspect the text BEFORE CSV escaping**
                    console.log("Cell text before escaping:", cellText); // Check if Korean is already garbled

                    return `"${cellText.replace(/"/g, '""')}"`;
                }).join(",") + "\n";
            });

            // **DEBUGGING: Inspect the CSV content before creating Blob**
            console.log("CSV Content before Blob:", csvContent);

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { // feature detection
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "keyword_analysis.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);  // Clean up
            } else {
                // IE10+ Fallback - opens the data URI in a new window
                window.open('data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));
            }
        }

        function sortKeywordSuggestions(column) {
            const keywordList = document.getElementById('keywordList');
            const listItems = Array.from(keywordList.children);

            if (column === currentKeywordSortColumn) {
                keywordSortAscending = !keywordSortAscending;
            } else {
                keywordSortAscending = true;
                currentKeywordSortColumn = column;
            }

            listItems.sort((a, b) => {
                const aValue = a.children[column].textContent;
                const bValue = b.children[column].textContent;

                // Convert to number for sorting if possible
                const aNum = parseFloat(aValue.replace(/,/g, ''));
                const bNum = parseFloat(bValue.replace(/,/g, ''));

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return keywordSortAscending ? aNum - bNum : bNum - aNum;
                } else {
                    return keywordSortAscending
                        ? aValue.localeCompare(bValue)
                        : bValue.localeCompare(aValue);
                }
            });

            listItems.forEach(item => keywordList.appendChild(item));
        }

        function sortRankedKeywords(column) {
            const keywordList = document.getElementById('rankedKeywordList');
            const listItems = Array.from(keywordList.children);

            // Toggle sort direction if same column is clicked
            if (column === currentRankedKeywordSortColumn) {
                rankedKeywordSortAscending = !rankedKeywordSortAscending;
            } else {
                rankedKeywordSortAscending = true;
                currentRankedKeywordSortColumn = column;
            }

            listItems.sort((a, b) => {
                try {
                    const aValue = a.children[column].textContent.trim();
                    const bValue = b.children[column].textContent.trim();

                    const aNum = parseFloat(aValue.replace(/,/g, ''));
                    const bNum = parseFloat(bValue.replace(/,/g, ''));

                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return rankedKeywordSortAscending ? aNum - bNum : bNum - aNum;
                    } else {
                        return rankedKeywordSortAscending
                            ? aValue.localeCompare(bValue)
                            : bValue.localeCompare(aValue);
                    }
                } catch (error) {
                }
            });

            listItems.forEach(item => keywordList.appendChild(item));
        }

        selectedItems = {};
        generatedData = {};

        async function semWebpageProducts() {
            const getProducts = document.getElementById("getProducts");
            if (!document.getElementById('sem_webpages').value && !document.getElementById('sem_additional').value) {
                alert("Please enter webpage URLs or additional information.");
                return;
            } else {
                getProducts.innerText = "Analysing...";
                if (document.getElementById("semProductFocus").checked) {
                    productFocus = true;
                } else {
                    productFocus = false;
                }
                if (document.getElementById("semBrandFocus").checked) {
                    brandFocus = true;
                } else {
                    brandFocus = false;
                }

                urls = document.getElementById("sem_webpages").value.split(/[\s,]+/).filter(url => url.trim() !== "");

                try {
                    const response = await fetch("https://13kntbziug.execute-api.ap-southeast-1.amazonaws.com/webpageProducts", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            pages: urls,
                            brand: brandFocus,
                            product: productFocus,
                            language: document.getElementById("sem_language").value,
                            additional: document.getElementById("sem_additional").value,
                        })
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const responseData = await response.json();
                    console.log(responseData);
                    const body = JSON.parse(responseData.body);

                    formattedString = "";

                    if (body['product/service'].length > 0) {
                        formattedString += "Product/Service: ";
                        if (Object.prototype.toString.call(body['product/service']) === '[object Array]') {
                            for (value in body['product/service']) {
                                formattedString += body['product/service'][value] + ", ";
                            }
                            formattedString = formattedString.slice(0, -2)
                        } else {
                            formattedString += body['product/service']
                        }
                    }

                    if (formattedString != "") {
                        formattedString += "\n\n";
                    }

                    if (body['brand/company'].length > 0) {
                        formattedString += "Brand/Company: ";
                        if (Object.prototype.toString.call(body['brand/company']) === '[object Array]') {
                            for (value in body['brand/company']) {
                                formattedString += body['brand/company'][value] + ", ";
                            }
                            formattedString = formattedString.slice(0, -2)
                        } else {
                            formattedString += body['brand/company']
                        }
                    }

                    document.getElementById("products").innerHTML = '<label for="identifiedProducts">Identfied Products/Services/Brand/Company:</label><br><textarea rows="6" id="identifiedProducts">' + formattedString + '</textarea>';
                    getProducts.innerText = "Step 1: Identify products/services/brand/company";
                } catch (error) {
                    console.error("Error:", error);
                    document.getElementById("output").innerText = "An error occurred with semWebpageProducts. Please check the console for details.";
                    getProducts.innerText = "Step 1: Identify products/services/brand/company";
                }
            }
        }

        async function semAnalyseWebsite() {
            const semButton = document.getElementById("semAnalyse");
            semButton.innerText = "Analysing...";
            try {
                const response = await fetch("https://sk7akfiy89.execute-api.ap-southeast-1.amazonaws.com/semWebsiteAnalyser", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        country: document.getElementById("sem_country").value,
                        additional: document.getElementById("sem_additional").value,
                        products: document.getElementById("identifiedProducts").value,
                        language: document.getElementById("sem_language").value,
                    })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const responseData = await response.json();
                const body = responseData.body;
                selectedItems = {}; // Clear selections
                document.getElementById('selected').style.display = 'block';
                //document.getElementById("selectedText").value = ""; // Clear textarea
                console.log(body);
                document.getElementById("output").innerHTML = await createSemTables(body);

                semButton.innerText = "Step 2: Generate KWs, USPs & Audience";
            } catch (error) {
                console.error("Error:", error);
                document.getElementById("output").innerText = "An error occurred with semWebsiteAnalyser. Please check the console for details.";
                semButton.innerText = "Step 2: Generate KWs, USPs & Audience";
            }
        }

        async function createSemTables(data) {
            let tablesHTML = "";
            const categories = ["short_keywords", "long_keywords", "usp", "target_audience_name"];
            const titles = ["Short-tail Keywords", "Long-tail Keywords", "USPs", "Target Audience"];

            for (let i = 0; i < categories.length; i++) {
                const category = categories[i];
                const title = titles[i];
                const items = data[category];


                // Fetch keyword metrics for short and long tail keywords
                let keywordMetrics = {};
                if (category === "short_keywords" || category === "long_keywords") {
                    const keywords = items.map(item => typeof item === 'object' ? Object.values(item)[0] : item);
                    keywordMetrics = await fetchKeywordMetricsSem(keywords);
                }

                let tableHTML = `<h2>${title}</h2><table><tr><th>Select</th><th>Value</th>`;
                if (category === "short_keywords" || category === "long_keywords") {
                    tableHTML += `<th>CPC</th><th>Search Volume</th>`; // Add CPC and Search Volume headers
                }
                tableHTML += `</tr>`;

                for (const item of items) {
                    const value = typeof item === 'object' ? Object.values(item)[0] : item;
                    tableHTML += `<tr><td><input type="checkbox" onchange="updateSemSelected('${value}', '${title}')"></td><td>${value}</td>`;

                    if (category === "short_keywords" || category === "long_keywords") {
                        const metrics = keywordMetrics[value] || { cpc: 'N/A', search_volume: 'N/A' };
                        tableHTML += `<td>${metrics.cpc}</td><td>${metrics.search_volume}</td>`; // Add CPC and Search Volume data
                    }

                    tableHTML += `</tr>`;
                }
                tableHTML += '</table>';
                tablesHTML += tableHTML;
            }
            return tablesHTML;
        }

        async function fetchKeywordMetrics(keywords, location, language) {
            const keywordMetricsEndpoint = 'https://gr8ar6zc4e.execute-api.ap-southeast-1.amazonaws.com/mangoolsKeywords';

            try {
                const response = await fetch(keywordMetricsEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keywords: keywords,
                        location: location,
                        language: language
                    })
                });

                if (!response.ok) {
                    throw new Error(`Keyword Metrics API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                keywordMetrics = data.body;
                console.log("Keyword Metrics:", keywordMetrics);

            } catch (error) {
                console.error("Error fetching keyword metrics:", error);
            }
        }

        async function fetchKeywordMetricsSem(keywords) {
            console.log(keywords);
            const location = document.getElementById("sem_country").value;
            const language = document.getElementById("sem_language").value;

            try {
                const response = await fetch("https://gr8ar6zc4e.execute-api.ap-southeast-1.amazonaws.com/mangoolsKeywords", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ keywords: keywords, location: location, language: language })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const metrics = data.body;

                console.log(data);

                // Convert the returned keyword metrics to a format that is easily accessible when populating the table
                const formattedMetrics = {};
                for (const keyword in metrics) {
                    formattedMetrics[keyword] = {
                        cpc: metrics[keyword].cpc,
                        search_volume: metrics[keyword].search_volume
                    };
                }
                return formattedMetrics;

            } catch (error) {
                console.error("Error fetching keyword metrics:", error);
                return {}; // Return an empty object in case of an error
            }
        }
        function updateSemSelected(value, category) {
            if (!selectedItems[category]) {
                selectedItems[category] = [];
            }
            const index = selectedItems[category].indexOf(value);
            if (index > -1) {
                selectedItems[category].splice(index, 1);
            } else {
                selectedItems[category].push(value);
            }
            displaySemSelectedItems();
        }
        function displaySemSelectedItems() {
            let selectedText = "";
            for (const category in selectedItems) {
                if (selectedItems[category].length > 0) {
                    selectedText += `${category}\n`;
                    selectedItems[category].forEach(item => {
                        selectedText += `${item}\n`;
                    });
                    selectedText += "\n"; // Add extra newline between categories
                }
            }
            document.getElementById("selectedText").value = selectedText;  // Update textarea value
        }

        function getCompetitors() {
            document.getElementById("getCompetitorsBtn").innerText = "Getting Competitors...";
            document.getElementById("competitionBtn").style.backgroundColor = "#004c9d";
            const keywords = document.getElementById('competitor_keywords').value.split(/[\n,]+/).map(k => k.trim());
            console.log(keywords);
            const competitorsLanguage = document.getElementById("competitors-language").value;
            const competitorsLocation = document.getElementById("competitors-location").value;

            fetch("https://itzj193chl.execute-api.ap-southeast-1.amazonaws.com/serpCompetitors", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    keywords: keywords,
                    location: competitorsLocation,
                    language: competitorsLanguage
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayCompetitorResults(data.body);
                    document.getElementById("competitorsOutput").style.display = "block";
                    document.getElementById("competitionBtn").style.backgroundColor = "green";
                })
                .catch(error => {
                    console.error("Error fetching competitors:", error);
                    document.getElementById("competitorsOutput").innerHTML = "Error fetching competitors.  See console for details.";
                    document.getElementById("competitionBtn").style.backgroundColor = "#004c9d";
                })
                .finally(() => {
                    document.getElementById("getCompetitorsBtn").innerText = "Step 1: Get Competitors";
                });
        }

        function displayCompetitorResults(results) {
            const outputDiv = document.getElementById("competitorsOutput");
            if (results === undefined) {
                alert("There are no results found for the keyword(s). Please try other keyword(s).")
            }
            if (!outputDiv) {
                console.error("Competitors output div not found!");
                return;
            }

            let tableHTML = `
        <table>
            <thead>
                <tr>
                    <th>Domain</th>
                    <th>Keyword and Rank</th>
                    <th>Select</th>
                </tr>
            </thead>
            <tbody>
    `;

            for (const domain in results) {
                if (results.hasOwnProperty(domain)) {
                    const keywordRanks = results[domain];
                    let keywordRankText = "";
                    for (const keyword in keywordRanks) {
                        if (keywordRanks.hasOwnProperty(keyword)) {
                            keywordRankText += `${keyword}: ${keywordRanks[keyword]}<br>`;
                        }
                    }

                    // Make the domain a hyperlink
                    const linkedDomain = `<a href="http://${domain}" target="_blank" rel="noopener noreferrer">${domain}</a>`;  //IMPORTANT:  Added http:// to the domain so if a naked domain is returned it will open.  Also add noreferrer to protect user privacy

                    tableHTML += `
                <tr>
                    <td>${linkedDomain}</td>
                    <td>${keywordRankText}</td>
                    <td><input type="checkbox" class="domain-checkbox" value="${domain}" onchange="updateCompetitorDomainsField()"></td>

                </tr>
            `;
                }
            }

            tableHTML += `
            </tbody>
        </table>
    `;

            outputDiv.innerHTML = tableHTML;

            // Add event listener after the table is rendered
            const checkboxes = document.querySelectorAll('.domain-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateCompetitorDomainsField);
            });
            // Show the button
            document.getElementById('getIntersectionResults').style.display = 'block';
        }

        async function getIntersectionResults() {
            document.getElementById('competitorsRanking').style.display = 'none';
            const checkedDomains = Array.from(document.querySelectorAll('.domain-checkbox:checked'))
                .map(checkbox => checkbox.value);

            if (checkedDomains.length === 0) {
                alert('Please select at least one domain.');
                return;
            }

            const target1Value = document.getElementById('competitors-target1').value;

            const apiCalls = checkedDomains.map(domain => {
                const requestBody = {
                    "language": "English",
                    "location": "Singapore",
                    "target1": target1Value,
                    "target2": domain
                };

                return fetch('https://8llvcx7m6e.execute-api.ap-southeast-1.amazonaws.com/domainIntersection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        return { domain: domain, data: data }; // Return domain along with the data
                    })
                    .catch(error => {
                        console.error(`Error fetching intersection results for ${domain}:`, error);
                        return { domain: domain, error: error }; // Return domain and the error
                    });
            });

            // Execute all API calls in parallel
            const results = await Promise.all(apiCalls);
            displayIntersectionResults(results);

        }

        async function getIntersectionResults2() {
            client_url = document.getElementById('competitors-target1').value;
            if (!client_url) {
                alert("Please enter a Target Domain.");
                return;
            }
            document.getElementById('getIntersectionResults2').innerText = "Getting Results..";
            var domains = document.getElementById('competitor_domains').value;
            domainsArray = domains.split(/[,\n]+/).map(domain => domain.trim()).filter(domain => domain !== "");

            var location = document.getElementById('competitors-location').value;

            var url = "https://0dqny7l5y9.execute-api.ap-southeast-1.amazonaws.com/rankingKeywords";

            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json",
            };

            const target1Value = document.getElementById('competitors-target1').value;

            const apiCalls = domainsArray.map(domain => {
                const requestBody = {
                    "language": document.getElementById('competitors-language').value,
                    "location": document.getElementById('competitors-location').value,
                    "target1": target1Value,
                    "target2": domain
                };

                return fetch('https://8llvcx7m6e.execute-api.ap-southeast-1.amazonaws.com/domainIntersection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        return { domain: domain, data: data }; // Return domain along with the data
                    })
                    .catch(error => {
                        console.error(`Error fetching intersection results for ${domain}:`, error);
                        return { domain: domain, error: error }; // Return domain and the error
                    });
            });

            // Execute all API calls in parallel
            const results = await Promise.all(apiCalls);
            displayIntersectionResults(results);
            document.getElementById('getIntersectionResults').style.display = 'block';
            document.getElementById('getIntersectionResults2').innerText = "Get Intersection Results";
        }
        function displayIntersectionResults(results) {
            const outputDiv = document.getElementById("competitorsRanking");
            if (!outputDiv) {
                console.error("Competitors output div not found!");
                return;
            }

            let tableHTML = `
    <table id="intersectionResultsTable">
      <thead>
        <tr>
          <th onclick="sortIntersectionTable('keyword')">Keyword</th>
          <th onclick="sortIntersectionTable('${document.getElementById("competitors-target1").value}')">${document.getElementById("competitors-target1").value}</th>
          ${results.map(result => `<th onclick="sortIntersectionTable('${result.domain}')">${result.domain}</th>`).join('')}
        </tr>
      </thead>
      <tbody>
  `;

            // Collect all unique keywords from the results
            const allKeywords = new Set();
            results.forEach(result => {
                if (result.data) {
                    Object.keys(result.data).forEach(keyword => allKeywords.add(keyword));
                }
            });

            // Iterate over each unique keyword and create a row
            allKeywords.forEach(keyword => {
                tableHTML += `
      <tr>
        <td>${keyword}</td>
    `;

                console.log(results);

                // Get target1 data
                tableHTML += `
      <td>${(results[0].data && results[0].data[keyword]) ? `<a href="${results[0].data[keyword][Object.keys(results[0].data[keyword])[3]][1]}"  target="_blank">${results[0].data[keyword][Object.keys(results[0].data[keyword])[3]][0]}</a>` : '999'}</td>
    `;

                //Add rankings for the rest of the selected domains
                results.forEach(result => {
                    if (result.data && result.data[keyword]) {

                        // Find first domain and retrieve rankings and URLs
                        const firstDomain = Object.keys(result.data[keyword])[4]
                        const domainData = result.data[keyword][firstDomain]

                        //Set ranks and URLs into the rows
                        tableHTML += `<td><a href="${domainData[1]}" target="_blank">${domainData[0]}</a></td>`;

                    } else if (result.error) {
                        tableHTML += `<td>Error</td>`;
                    } else {
                        tableHTML += `<td>999</td>`;
                    }
                });

                tableHTML += `</tr>`;
            });

            tableHTML += `
      </tbody>
    </table>
  `;

            outputDiv.innerHTML = tableHTML;
            outputDiv.innerHTML += '<br><button type="button" onclick="copyInteractionResultsTable()"><i class="fa fa-copy"></i></button>';
            outputDiv.innerHTML += '<button type="button" onclick="exportInteractionResultsTableToCSV()">Export as .csv</button>';
            document.getElementById('competitorsRanking').style.display = 'block';
        }

        async function generatePersona() {
            document.getElementById("generatePersonaBtn").innerText = "Generating...";
            document.getElementById("persona").style.backgroundColor = "#004c9d";
            const webpagesInput = document.getElementById("persona_webpages").value;
            const manualInput = document.getElementById("persona_manual").value;
            const webpages = webpagesInput.split(/[\s,]+/).filter(url => url.trim() !== "");
            const personaContentDiv = document.getElementById("persona-results");
            let combinedResponses = "";

            try {
                // Fetch data from all URLs concurrently using Promise.all
                const responses = await Promise.all(
                    webpages.map(async url => {
                        try {
                            const response = await fetch("https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({ url: url })
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status} for URL: ${url}`);
                            }

                            return await response.json(); // Return the parsed JSON data
                        } catch (error) {
                            console.error(`Error fetching data from ${url}:`, error);
                            return null; // Return null in case of an error
                        }
                    })
                );

                // Combine the responses
                combinedResponses = responses.filter(response => response !== null).map(response => JSON.stringify(response)).join("\n");

                console.log(combinedResponses);

                // Send combined responses to the second API
                try {
                    const personaResponse = await fetch("https://tyqj3fni7h.execute-api.ap-southeast-1.amazonaws.com/personaGenerator", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ data: combinedResponses, manual: manualInput })
                    });

                    if (!personaResponse.ok) {
                        throw new Error(`HTTP error! status: ${personaResponse.status} for persona API`);
                    }

                    const personaData = await personaResponse.json();
                    personaContentDiv.innerHTML += personaData.body;

                } catch (error) {
                    personaContentDiv.innerHTML = `<p style="color: red;">Error sending data to persona API: ${error.message}</p>`;
                    console.error("Error sending data to persona API:", error);
                }

            } catch (error) {
                personaContentDiv.innerHTML = `<p style="color: red;">An error occurred: ${error.message}</p>`;
                console.error("An error occurred:", error);
            } finally {
                document.getElementById("generatePersonaBtn").innerText = "Generate Personas";
                document.getElementById("persona").style.backgroundColor = "green";
                document.getElementById("copy-persona-results-button").style.display = "block";
            }
        }

        async function generateMediaPlan() {
            document.getElementById("generateMediaPlanBtn").innerText = "Generating...";
            document.getElementById("mediaPlanBtn").style.backgroundColor = "#004c9d";
            const mediaplanContentDiv = document.getElementById("mediaPlanResults");
            const webpages = document.getElementById("MediaPlanWebpages").value.split(/[\s,]+/).filter(url => url.trim() !== "");

            const responses = await Promise.all(
                webpages.map(async url => {
                    try {
                        const response = await fetch("https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({ url: url })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} for URL: ${url}`);
                        }

                        return await response.json(); // Return the parsed JSON data
                    } catch (error) {
                        console.error(`Error fetching data from ${url}:`, error);
                        return null; // Return null in case of an error
                    }
                })
            );

            word_count = 0;
            responses.forEach((page) => {
                word_count += (page.body.other_text.split(" ")).length;
            });

            if (word_count < 500) {
                alert("Please consider adding more webpage URLs for the tool to generate better results. The tool will continue generating the media plan.");
            }


            personaData = document.getElementById("MediaPlanCustomerPersonas").value;
            manualInput = document.getElementById("persona_manual").value;

            if (personaData == "") {
                try {
                    const personaResponse = await fetch("https://tyqj3fni7h.execute-api.ap-southeast-1.amazonaws.com/personaGenerator", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ data: responses, manual: manualInput })
                    });

                    if (!personaResponse.ok) {
                        throw new Error(`HTTP error! status: ${personaResponse.status} for persona API`);
                    }

                    personaData = await personaResponse.json();
                    document.getElementById("mediaPlanPersonaResults").innerHTML = "<h2>Generated Personas</h2>" + personaData.body;
                    document.getElementById("mediaPlanPersonaResults").style.display = "block"

                } catch (error) {
                    alert(`Error sending data to persona API: ${error.message}`);
                    console.error("Error sending data to persona API:", error);
                }
            }

            // Gather all the data from the form fields
            const data = {
                webpagesInput: responses,
                budget: document.getElementById("MediaPlanBudget").value,
                manualInput: document.getElementById("MediaPlanManual").value,
                organisationalObjectives: document.getElementById("MediaPlanOrganisationalObjectives").value,
                mediaPlanLocation: document.getElementById("MediaPlanLocation").value,
                mediaPlanTargetAudience: document.getElementById("MediaPlanTargetAudience").value,
                mediaPlanCustomerPersonas: personaData,
                mediaPlanTouchpoints: document.getElementById("MediaPlanTouchpoints").value,
                mediaPlanContentStrategy: document.getElementById("MediaPlanContentStrategy").value,
                mediaPlanLandingPages: document.getElementById("MediaPlanLandingPages").value,
                mediaPlanCta: document.getElementById("MediaPlanCta").value,
                mediaPlanProductService: document.getElementById("MediaPlanProductService").value,
                mediaPlanKpis: document.getElementById("MediaPlanKpis").value,
                mediaPlanCompetitiveAnalysis: document.getElementById("MediaPlanCompetitiveAnalysis").value,
                mediaPlanCompliance: document.getElementById("MediaPlanCompliance").value,
                mediaPlanTechnologyPlan: document.getElementById("MediaPlanTechnologyPlan").value,
                mediaPlanAnalyticsReporting: document.getElementById("MediaPlanAnalyticsReporting").value,

                adFormats: {
                    googleDisplay: document.getElementById("MediaPlanAdFormatsGoogleDisplay").checked,
                    googleSearch: document.getElementById("MediaPlanAdFormatsGoogleSearch").checked,
                    fbIg: document.getElementById("MediaPlanAdFormatsFBIG").checked,
                    linkedIn: document.getElementById("MediaPlanAdFormatsLinkedIn").checked,
                    tikTok: document.getElementById("MediaPlanAdFormatsTikTok").checked
                }
            };

            try {
                // Combine the responses - the original implementation was parsing webpage
                // content, but now we skip that step and pass the data directly

                // Send the combined data to the media plan API
                const mediaPlanResponse = await fetch("https://h8ih2vc2xi.execute-api.ap-southeast-1.amazonaws.com/mediaPlanGenerator", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data) // Send all the data gathered from the form
                });

                if (!mediaPlanResponse.ok) {
                    throw new Error(`HTTP error! status: ${mediaPlanResponse.status} for media plan API`);
                }

                const mediaPlanData = await mediaPlanResponse.json();
                mediaplanContentDiv.innerHTML += "<br>" + mediaPlanData.body;

                // Funnel
                funnelResponse = await fetch("https://dpjtg2sr30.execute-api.ap-southeast-1.amazonaws.com/generateFunnel", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(Object.assign({}, personaData, mediaPlanData)) // Send all the data gathered from the form
                });

                if (!funnelResponse.ok) {
                    throw new Error(`HTTP error! status: ${funnelResponse.status} for media plan API`);
                }
                funnelData = await funnelResponse.json();

                funnelData = JSON.parse(funnelData.body);

                try {
                    document.getElementById("awareness-details").innerHTML = funnelData.Awareness.join('\n');
                } catch (error) {
                    document.getElementById("awareness-details").innerHTML = "N.A.";
                }
                try {
                    document.getElementById("discovery-details").innerHTML = funnelData.Discovery.join('\n');
                } catch (error) {
                    document.getElementById("discovery-details").innerHTML = "N.A.";
                }
                try {
                    document.getElementById("consideration-details").innerHTML = funnelData.Consideration.join('\n');
                } catch (error) {
                    document.getElementById("consideration-details").innerHTML = "N.A.";
                }
                try {
                    document.getElementById("conversion-details").innerHTML = funnelData.Conversion.join('\n');
                } catch (error) {
                    document.getElementById("conversion-details").innerHTML = "N.A.";
                }
                try {
                    document.getElementById("retention-details").innerHTML = funnelData.Retention.join('\n');
                } catch (error) {
                    document.getElementById("retention-details").innerHTML = "N.A.";
                }

                document.getElementById("funnel-container").style.display = "flex";
                document.getElementById("mediaPlanBtn").style.backgroundColor = "green";

            } catch (error) {
                mediaplanContentDiv.innerHTML = `<p style="color: red;">Error sending data to media plan API: ${error.message}</p>`;
                console.error("Error sending data to media plan API:", error);
            } finally {
                document.getElementById("generateMediaPlanBtn").innerText = "Generate Media Plan";
            }
        }

        async function auditLandingPageDirectWeb() {
            document.getElementById("gauge").style.display = "none";
            document.getElementById("auditLandingPageBtn").innerText = "Evaluating landing page...";
            document.getElementById("landingPageAuditBtn").style.backgroundColor = "#004c9d";
            landingPageAuditResultDiv = document.getElementById("landingPageAuditResults");

            const urlInput = document.getElementById("landingPageUrl").value;
            const auditKeyword = document.getElementById("landingPageAuditKeyword")?.value || null;

            // Check if the URL input is empty
            if (!urlInput || urlInput.trim() === "") {
                alert("Please enter a landing page URL.");
                document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
                return;
            }
            const finalAuditResponse = await fetch("https://7eehmzk9e0.execute-api.ap-southeast-1.amazonaws.com/auditLandingPageDirectWeb", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    keyword: auditKeyword, // Pass the keyword for main audit
                    url: urlInput
                })
            });

            const finalAuditData = await finalAuditResponse.json();

            // Display the results
            document.getElementById("landingPageAuditResults").innerHTML = finalAuditData.body;
            const gaugeElement = document.querySelector(".gauge");
            quality_score = finalAuditData.quality_score;
            setGaugeValue(gaugeElement, quality_score / 10);
            document.getElementById("gauge").style.display = "block";

            document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
        }

        async function auditLandingPage2() {
            document.getElementById("gauge").style.display = "none";
            document.getElementById("auditLandingPageBtn").innerText = "Getting page content...";
            document.getElementById("landingPageAuditBtn").style.backgroundColor = "#004c9d";
            landingPageAuditResultDiv = document.getElementById("landingPageAuditResults");

            const urlInput = document.getElementById("landingPageUrl").value;
            const auditKeyword = document.getElementById("landingPageAuditKeyword")?.value || null;

            // Check if the URL input is empty
            if (!urlInput || urlInput.trim() === "") {
                alert("Please enter a landing page URL.");
                document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
                return;
            }

            try {
                const landingPageAuditResponse = await fetch("https://ocgawi1990.execute-api.ap-southeast-1.amazonaws.com/auditLandingPageDataPull", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        url: urlInput
                    })
                });

                if (!landingPageAuditResponse.ok) {
                    const errorText = await landingPageAuditResponse.text();
                    throw new Error(`HTTP error! status: ${landingPageAuditResponse.status} - ${errorText}`);
                }

                const landingPageAuditData = await landingPageAuditResponse.json();

                // Split the HTML content into snippets of up to 100,000 characters
                const html = landingPageAuditData.html;
                const snippetSize = 100000;
                const snippets = [];
                for (let i = 0; i < html.length; i += snippetSize) {
                    snippets.push(html.substring(i, i + snippetSize));
                }

                console.log(landingPageAuditData.html.length);
                console.log(snippets.length);

                document.getElementById("auditLandingPageBtn").innerText = "Evaluating page elements...";

                // Send each snippet to the excerpt API concurrently
                const excerptPromises = snippets.map(snippet =>
                    fetch("https://vvoc1htseh.execute-api.ap-southeast-1.amazonaws.com/auditLandingPageExcerpt", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            html: snippet,
                            keyword: auditKeyword
                        })
                    }).then(response => {
                        if (!response.ok) {
                            return response.json().then(err => {
                                throw new Error(`Excerpt API error! status: ${response.status} - ${err.message || 'Unknown error'}`);
                            });
                        }
                        return response.json();
                    })
                );

                // Wait for all excerpt API calls to complete
                const excerptResponses = await Promise.all(excerptPromises);

                // Combine the responses from the excerpt API calls
                let combinedExcerptResponse = {
                    results: []
                };

                excerptResponses.forEach(response => {
                    if (response && response.results) {
                        combinedExcerptResponse.results = combinedExcerptResponse.results.concat(response.results);
                    }
                });

                document.getElementById("auditLandingPageBtn").innerText = "Auditing overall page...";

                // Send the combined response to the main audit API
                const finalAuditResponse = await fetch("https://llufeecqoe.execute-api.ap-southeast-1.amazonaws.com/auditLandingPage", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        excerpt_results: combinedExcerptResponse.results, // Pass the combined excerpt results
                        keyword: auditKeyword, // Pass the keyword for main audit
                        url: urlInput,
                        speed: landingPageAuditData.speed
                    })
                });

                if (!finalAuditResponse.ok) {
                    const errorText = await finalAuditResponse.text();
                    throw new Error(`Final Audit API error! status: ${finalAuditResponse.status} - ${errorText}`);
                }

                const finalAuditData = await finalAuditResponse.json();

                console.log(finalAuditData);

                // Display the results
                document.getElementById("landingPageAuditResults").innerHTML = `${JSON.stringify(finalAuditData['body'], null, 2)}`.replaceAll('"', '');
                const gaugeElement = document.querySelector(".gauge");
                quality_score = finalAuditData.quality_score;
                setGaugeValue(gaugeElement, quality_score / 10);
                document.getElementById("gauge").style.display = "block";

            } catch (error) {
                console.error("Error during audit:", error);
                alert(`Audit failed: ${error.message}`);
                document.getElementById("landingPageAuditResults").innerText = `Error: ${error.message}`;
            } finally {
                document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
                document.getElementById("landingPageAuditBtn").style.backgroundColor = "green"; // Revert to original style
            }
        }

        async function auditLandingPage() {
            document.getElementById("gauge").style.display = "none";
            document.getElementById("auditLandingPageBtn").innerText = "Auditing...";
            document.getElementById("landingPageAuditBtn").style.backgroundColor = "#004c9d";
            landingPageAuditResultDiv = document.getElementById("landingPageAuditResults");

            const urlInput = document.getElementById("landingPageUrl").value;
            const auditKeyword = document.getElementById("landingPageAuditKeyword")?.value || null;

            // Check if the URL input is empty
            if (!urlInput || urlInput.trim() === "") {
                alert("Please enter a landing page URL.");
                document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
                return;
            }

            // Send combined responses to the second API
            try {
                const landingPageAuditResponse = await fetch("https://llufeecqoe.execute-api.ap-southeast-1.amazonaws.com/auditLandingPage", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        url: urlInput,
                        keyword: auditKeyword
                    })
                });

                if (!landingPageAuditResponse.ok) {
                    const errorText = await landingPageAuditResponse.text();
                    throw new Error(`HTTP error! status: ${landingPageAuditResponse.status} - ${errorText}`);
                }

                const landingPageAuditData = await landingPageAuditResponse.json();

                if (landingPageAuditData && landingPageAuditData.body) {
                    landingPageAuditResultDiv.innerHTML = landingPageAuditData.body; // Removed +=
                    const gaugeElement = document.querySelector(".gauge");
                    quality_score = landingPageAuditData.quality_score;
                    setGaugeValue(gaugeElement, quality_score / 10);
                    document.getElementById("gauge").style.display = "block";
                } else {
                    landingPageAuditResultDiv.innerHTML = "<p>No results found.</p>";
                }

            } catch (error) {
                landingPageAuditResultDiv.innerHTML = `<p style="color: red;">Error landing page audit API: ${error.message}</p>`;
                console.error("Error sending data to landing page audit API:", error);
            } finally {

                document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
                document.getElementById("landingPageAuditBtn").style.backgroundColor = "green";
            }
        }

        function setGaugeValue(gauge, value) {
            if (value < 0 || value > 1) {
                return;
            }

            const fillElement = gauge.querySelector(".gauge__fill");
            fillElement.style.transform = `rotate(${value / 2}turn)`;
            gauge.querySelector(".gauge__cover").innerHTML = `Quality Score<br>${Math.round(value * 10)}/10`;
        }

        async function generateGoogle() {
            document.getElementById("generateSem").innerText = "Generating...";
            document.getElementById("semButton").style.backgroundColor = "#004c9d";
            try {
                const response = await fetch("https://bztsly2z89.execute-api.ap-southeast-1.amazonaws.com/generateSemGoogle", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        country: document.getElementById("sem_country").value,
                        input: document.getElementById("selectedText").value,
                        tone: document.getElementById("sem_tone").value,
                        language: document.getElementById("sem_language").value,
                        type: document.getElementById("ad_format").value
                    })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const responseData = await response.json();
                const body = responseData.body;
                for (const key in body) {
                    if (!generatedData[key]) {
                        generatedData[key] = [];
                    }
                    generatedData[key] = generatedData[key].concat(body[key]); // Concatenate new data
                }
                displaySemGeneratedData(); // Call function to update HTML
                document.getElementById("generateSem").innerText = "Step 3: Select checkboxes then click here";
            } catch (error) {
                console.error("Error:", error);
                document.getElementById("generated").innerText = "An error occurred. Please check the console for details.";
                document.getElementById("generateSem").innerText = "Step 3: Select checkboxes then click here";
            }
        }
        function displaySemGeneratedData() {
            let generatedHTML = "";
            for (const category in generatedData) {
                if (generatedData[category].length > 0) {
                    if (category == "sitelinks") {
                        generatedHTML += `<h3>${category.replace(/_/g, ' ').toUpperCase()}</h3>`; // Nicer titles
                        generatedHTML += `<table>`;
                        generatedHTML += `<tr><th>Value</th><th>Remove</th></tr>`; // Add remove column header
                        generatedData[category].forEach((item, index) => { // Add index for row removal
                            sitelink = "";
                            for ([key, value] of Object.entries(item)) {
                                sitelink += `${value}<br>`;
                            }
                            generatedHTML += `<tr>
                            <td>${sitelink}</td>
                            <td><span class="remove-row" onclick="removeSemGeneratedRow('${category}', ${index})" onmouseover="" style="cursor: pointer;">X</span></td>
                         </tr>`;
                        });
                    } else {
                        generatedHTML += `<h3>${category.replace(/_/g, ' ').toUpperCase()}</h3>`; // Nicer titles
                        generatedHTML += `<table>`;
                        generatedHTML += `<tr><th>Value</th><th>Remove</th></tr>`; // Add remove column header
                        generatedData[category].forEach((item, index) => { // Add index for row removal
                            generatedHTML += `<tr>
                            <td>${item}</td>
                            <td><span class="remove-row" onclick="removeSemGeneratedRow('${category}', ${index})" onmouseover="" style="cursor: pointer;">X</span></td>
                         </tr>`;
                        });
                    }
                    generatedHTML += `</table>`;
                }
            }
            document.getElementById("generated").innerHTML = generatedHTML;
            document.getElementById("generated").innerHTML = document.getElementById("generated").innerHTML + '<br><button id="downloadSem" onclick="downloadSemCSV()">Download .csv</button>'
            document.getElementById("downloadSem").addEventListener("click", downloadSemCSV);
            document.getElementById("semButton").style.backgroundColor = "green";
        }
        function removeSemGeneratedRow(category, index) {
            generatedData[category].splice(index, 1);
            displaySemGeneratedData(); // Redraw the table
        }

        function downloadResultsAsXlsx() {
            const wb = XLSX.utils.book_new();

            // Add auditSummary tab
            const auditSummaryTables = document.getElementById('auditSummary').querySelectorAll('table');
            let auditSummaryData = [];

            auditSummaryTables.forEach((table, tableIndex) => {
                const tableData = extractTableData(table);

                // Add a blank row between tables (if it's not the first table)
                if (tableIndex > 0) {
                    auditSummaryData.push([]);
                }
                auditSummaryData = auditSummaryData.concat(tableData);
            });

            const auditSummaryWS = XLSX.utils.aoa_to_sheet(auditSummaryData);
            XLSX.utils.book_append_sheet(wb, auditSummaryWS, 'auditSummary');

            // Add gtMetrix tab
            const gtMetrixData = extractTableData(document.getElementById('gtmetrixReport').querySelector('table'));
            const gtMetrixWS = XLSX.utils.aoa_to_sheet(gtMetrixData);
            XLSX.utils.book_append_sheet(wb, gtMetrixWS, 'gtMetrix');

            // Add pageAnalysis tab
            const pageAnalysisData = extractTableData(document.getElementById('pageAuditReport').querySelector('table'));
            const pageAnalysisWS = XLSX.utils.aoa_to_sheet(pageAnalysisData);
            XLSX.utils.book_append_sheet(wb, pageAnalysisWS, 'pageAnalysis');


            // Add crawlerSection tab
            const crawlerData = extractTableData(document.getElementById('crawlerReport').querySelector('table'));
            const crawlerWS = XLSX.utils.aoa_to_sheet(crawlerData);
            XLSX.utils.book_append_sheet(wb, crawlerWS, 'crawlerSection');

            XLSX.writeFile(wb, 'technical_seo_results.xlsx');
        }

        function extractTableData(table) {
            const data = [];
            const rows = table.querySelectorAll('tr');

            rows.forEach(row => {
                const rowData = [];
                const cells = row.querySelectorAll('th, td');
                cells.forEach(cell => {
                    // Get text content, handling potential HTML inside cells
                    let cellText = cell.textContent.trim();
                    if (!cellText && cell.innerHTML) {
                        cellText = cell.innerHTML.replace(/<[^>]*>/g, "").trim();
                    }

                    rowData.push(cellText);
                });
                data.push(rowData);
            });
            return data;
        }

        function updateUI(isLoggedIn) {
            document.getElementById('loginForm').style.display = isLoggedIn ? 'none' : 'flex';
            document.getElementById('main-content').style.display = isLoggedIn ? 'block' : 'none';
            //document.getElementById('navbar').style.display = isLoggedIn ? 'block' : 'none';
        }


        function openSeo(event) {
            event.preventDefault();
            deactivateAllButtons();
            const seoButton = document.querySelector('button#seo');

            const icon = document.getElementById('seo').querySelector('i');
            if (icon && icon.classList.contains('fa-plus-square')) {
                icon.classList.remove('fa-plus-square');
                icon.classList.add('fa-minus-square');
            }
            if (seoButton) {
                seoButton.classList.toggle('active');
                const content = seoButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const keywordAnalysisLink = event.currentTarget;
                keywordAnalysisLink.classList.toggle('active-menu');

            };
            closeJourneyModal();
        }

        async function checkContent() {
            const brandGuideUrlsText = document.getElementById('brand_guide_urls').value || "";
            const otherUrlsText = document.getElementById('content_check_other_urls').value || "";
            const instructions = document.getElementById('content_check_instructions').value || "";
            const content = document.getElementById('content_to_check').value;
            document.getElementById("openFeedbackModalBtn").style.display = "none";
            document.getElementById("copy-check-results-button").style.display = "none";

            document.getElementById("contentCheckBtn").innerText = "Checking...";
            document.getElementById("checkContentResults").innerHTML = "";
            document.getElementById("contentcheck").style.backgroundColor = "#004c9d";

            // **Check if the content field is blank**
            if (!content || content.trim() === "") {
                alert("Please enter content to check.");
                document.getElementById("contentCheckBtn").innerText = "Check Content"; // Reset button text
                return;
            }


            // Split URLs by commas or newlines, and trim whitespace
            const brandGuideUrls = brandGuideUrlsText.split(/[, \n]+/).filter(url => url.trim() !== "");  //filter is important to remove empty strings
            const otherUrls = otherUrlsText.split(/[, \n]+/).filter(url => url.trim() !== ""); //filter is important to remove empty strings

            const allUrls = [...brandGuideUrls, ...otherUrls];  // Combine the arrays

            if (allUrls.length === 0) {
                console.warn("No URLs provided.");
                alert("Please enter at least one URL."); // Optional: provide user feedback
                document.getElementById("contentCheckBtn").innerText = "Check Content"; // Reset button text
                return;
            }

            // API endpoints
            const pdfParserApiUrl = "https://i3oxhgicub.execute-api.ap-southeast-1.amazonaws.com/pdfParser";
            const checkContentApiUrl = "https://mmyvj7yj11.execute-api.ap-southeast-1.amazonaws.com/checkContent";
            const contentParsingApiUrl = "https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing"; // Added content parsing API URL

            try {
                // Create an array of promises for the brand guide URLs API calls
                const brandGuideFetchPromises = brandGuideUrls.map(async url => {
                    try {
                        const response = await fetch(pdfParserApiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ url: url })
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`Error fetching URL ${url}: ${response.status} - ${errorText}`);
                            alert("The brand guide(s) failed to load successfully.");
                            throw new Error(`Failed to fetch ${url}: ${response.status} - ${errorText}`);
                        }

                        const data = await response.json();
                        return data;
                    } catch (error) {
                        console.error(`Error processing URL ${url}:`, error);
                        alert("The brand guide(s) failed to load successfully.");
                        return { url: url, error: error.message };
                    }
                });

                // Create an array of promises for the other URLs API calls to contentParsing endpoint
                const otherUrlsFetchPromises = otherUrls.map(async url => {
                    try {
                        const response = await fetch(contentParsingApiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ url: url })
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`Error fetching URL ${url}: ${response.status} - ${errorText}`);
                            alert("The URL(s) failed to load successfully.");
                            throw new Error(`Failed to fetch ${url}: ${response.status} - ${errorText}`);
                        }

                        const data = await response.json();
                        return data;
                    } catch (error) {
                        console.error(`Error processing URL ${url}:`, error);
                        alert("The URL(s) failed to load successfully.");
                        return { url: url, error: error.message };
                    }
                });


                // Use Promise.all to wait for all API calls to complete
                const brandGuideResults = await Promise.all(brandGuideFetchPromises);
                const otherUrlsResults = await Promise.all(otherUrlsFetchPromises);

                // Combine the responses from pdfParser API calls
                let combinedResponseFromBrandGuide = {};
                brandGuideResults.forEach((result, index) => {
                    combinedResponseFromBrandGuide[brandGuideUrls[index]] = result;  // Use the URL as the key for each response.  Important that allUrls[index] is used instead of result.url because result might be an error object without a .url field.
                });

                // Combine the responses from contentParsing API calls, extracting 'body'
                let combinedResponseFromOtherSources = {};
                otherUrlsResults.forEach((result, index) => {
                    if (result && result.body) {
                        combinedResponseFromOtherSources[otherUrls[index]] = result.body;
                    } else {
                        // Handle the case where 'body' is missing or result is an error object
                        combinedResponseFromOtherSources[otherUrls[index]] = result && result.error ? result.error : "No content"; //Store the error message in the combined response, so the user sees the error message on the UI
                        console.warn(`No 'body' found in the response from ${otherUrls[index]}`);
                    }
                });

                console.log("Combined Responses from brandGuideParser:", combinedResponseFromBrandGuide);
                console.log("Combined Responses from otherSources:", combinedResponseFromOtherSources);


                // Now, send the combined response to the checkContent API
                try {
                    const checkContentResponse = await fetch(checkContentApiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            "brand_guide": combinedResponseFromBrandGuide,
                            "instructions": instructions,
                            "content": content,
                            "other_sources": combinedResponseFromOtherSources  // Changed to the combined other sources response
                        })
                    });

                    if (!checkContentResponse.ok) {
                        const errorText = await checkContentResponse.text();
                        console.error(`Error calling checkContent API: ${checkContentResponse.status} - ${errorText}`);
                        throw new Error(`Failed to call checkContent API: ${checkContentResponse.status} - ${errorText}`);
                    }

                    const checkContentData = await checkContentResponse.json();
                    console.log("Response from checkContent API:", checkContentData);
                    // Display the response body to the user (e.g., in a div)
                    displayCheckContentResults(checkContentData['body']); // Implement this function to show the results
                    document.getElementById("contentcheck").style.backgroundColor = "green";
                } catch (checkContentError) {
                    console.error("Error calling checkContent API:", checkContentError);
                    alert("Error occurred while calling the checkContent API. See console for details.");
                }

            } catch (error) {
                console.error("An error occurred during the API calls:", error);
                alert("An error occurred while checking the content. See console for details."); // Provide user feedback
            }
            document.getElementById("contentCheckBtn").innerText = "Check Content"
        }

        function displayCheckContentResults(data) {
            // This function assumes you have an element with id "checkContentResults" to display the data.
            const resultsDiv = document.getElementById("checkContentResults");
            if (!resultsDiv) {
                console.warn("No element with id 'checkContentRsdfsdfsfesults' found to display the results.");
                return;
            }

            // Convert the data to a readable string (you might want to format it better)
            const formattedData = JSON.stringify(data, null, 2); // Pretty print JSON

            // Set the content of the results div
            resultsDiv.innerHTML = formattedData.replaceAll('"', '');
            document.getElementById("openFeedbackModalBtn").style.display = "block";
            document.getElementById("copy-check-results-button").style.display = "block";
        }


        function logout() {
            // Clear Google login
            if (googleUser) {
                google.accounts.id.revoke(googleUser.id_token, () => {
                    console.log('Google account revoked');
                });
                googleUser = null;
                localStorage.removeItem('googleUser');
            }

            // Clear login cookie
            document.cookie = "key=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

            updateUI(false);
            document.getElementById('loginError').textContent = "You have been logged out.";
            document.getElementById('loginForm').style.display = 'flex';
        }
        document.addEventListener('DOMContentLoaded', function () {
            const seoLink = document.getElementById('seo-link');
            const seoSubmenu = document.getElementById('seo-submenu');
            const smmLink = document.getElementById('smm-link');
            const smmSubmenu = document.getElementById('smm-submenu');
        });

        function downloadOverallSummaryTableAsCSV() {
            // CSV content
            const csvRows = [];

            // Add BOM (Byte Order Mark) for UTF-8 encoding, crucial for international characters
            const bom = "\uFEFF";

            // Headers - IMPORTANT:  Explicitly define the order.  This matches the table columns.
            const headers = ['No.', 'Keyword', 'Search Volume', 'CPC', 'Time to Rank', 'Reason', 'Mapping'];
            csvRows.push(headers.join(','));

            // Data rows
            summaryData.forEach(item => {
                const values = [
                    item.No,
                    item.keyword,
                    item.search_volume,
                    item.cpc,
                    item.timeToRank,
                    item.reason,
                ];
                // Use .map() and double quotes to handle commas and special characters
                const row = values.map(value => `"${String(value).replace(/"/g, '""')}"`).join(','); //IMPORTANT: Escape double quotes within the string
                csvRows.push(row);
            });


            // Create the CSV string
            const csvString = bom + csvRows.join('\n');


            // Create a download link
            const blob = new Blob([csvString], {
                type: 'text/csv;charset=utf-8'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'keyword_summary.csv');
            a.style.display = 'none'; // Hide the link

            // Programmatically trigger the download
            document.body.appendChild(a);
            a.click();

            // Clean up
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        async function getWebpageKeywords() {
            const location = document.getElementById('location').value;
            const language = document.getElementById('language').value;
            const target = document.getElementById('domain').value;

            if (target == "") {
                alert("Please enter a Domain / URL");
                return; // Important: Exit the function if target is empty
            }

            document.getElementById("keywords_for_site").style.backgroundColor = "#004c9d";
            document.getElementById("expandWebpageKeywords").style.backgroundColor = "#004c9d";
            document.getElementById('keywords_for_site').innerText = "Getting Webpage Keywords...";

            const endpoint = "https://ei6xj9x2rd.execute-api.ap-southeast-1.amazonaws.com/keywordsForSite";

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        location: location,
                        language: language,
                        target: target
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                allKeywords = Object.entries(data).map(([keyword, values]) => ({
                    keyword,
                    search_volume: values.search_volume,
                    competition: values.competition,
                    search_intent: values.search_intent,
                    reason_for_choosing: values.reason_for_choosing
                }));

                displayKeywordsTable(allKeywords);
                updateKeywordCount(); //added to update the keyword count paragraph
                document.getElementById('keywords_for_site').innerText = "Keywords Based on Webpage Content";
                document.getElementById("keywords_for_site").style.backgroundColor = "green";
                document.getElementById("expandWebpageKeywords").style.backgroundColor = "green";

                const siteKeywordsDiv = document.getElementById("siteKeywords");
                const icon = document.getElementById("expandWebpageKeywords").querySelector('i');

                if (siteKeywordsDiv.style.display === "block") {
                } else {
                    siteKeywordsDiv.style.display = "block";
                    icon.classList.remove('fa-plus-square');
                    icon.classList.add('fa-minus-square');
                }


            } catch (error) {
                console.error("Error fetching keywords:", error);
                document.getElementById('keywords_for_site').innerText = "Keywords Based on Webpage Content";
                document.getElementById('rankingError').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }

        }

        function displayKeywordsTable(keywords) {
            const container = document.getElementById('siteKeywords');

            if (!container) {
                console.error("Keywords container not found");
                return;
            }
            //ADD A PARAGRAPH TO TRACK SELECTED KEYWORDS
            container.innerHTML = `
            <div class="table-container" style="max-height:350px;overflow:auto">
              <table>
                <thead>
                    <tr>
                        <th onclick="sortSiteTable('keyword')">Keyword</th>
                        <th onclick="sortSiteTable('search_volume')">Search Volume</th>
                        <th onclick="sortSiteTable('competition')">Competition</th>
                        <th onclick="sortSiteTable('search_intent')">Search Intent</th>
                        <th onclick="sortSiteTable('reason_for_choosing')">Reason</th>
                        <th>Choose</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
        `;

            const tbody = container.querySelector('tbody');

            keywords.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                        <td>${item.keyword}</td>
                        <td>${item.search_volume}</td>
                        <td>${item.competition}</td>
                        <td>${item.search_intent}</td>
                        <td>${item.reason_for_choosing}</td>
                        <td><input type="checkbox" value="${item.keyword}" onchange="updateSiteKeywords(this)"></td>
                    `;
                tbody.appendChild(row);
            });
            updateKeywordCount()
            document.getElementById('siteKeywords').innerHTML += '<br><button type="button" onclick="exportSiteKeywordsTableToCSV()">Export as .csv</i></button>';
        }

        function updateSiteKeywords(checkbox) {
            const keyword = checkbox.value;
            const keywordsInput = document.getElementById('keywords');
            let currentKeywords = keywordsInput.value.trim();

            if (checkbox.checked) {
                if (currentKeywords === "") {
                    keywordsInput.value = keyword;
                } else {
                    keywordsInput.value = currentKeywords + ", " + keyword;
                }
            } else {
                let keywordsArray = currentKeywords.split(',').map(item => item.trim());
                keywordsArray = keywordsArray.filter(item => item !== keyword);
                keywordsInput.value = keywordsArray.join(', ');
            }

            updateKeywordsField(); //update the main keywords field.
            updateKeywordCount(); //count the checkboxes selected in webpagekeywords
        }

        function sortSiteTable(column) {
            if (currentSortColumn === column) {
                sortAscending = !sortAscending;
            } else {
                currentSortColumn = column;
                sortAscending = true;
            }

            allKeywords.sort((a, b) => {
                let comparison = 0;

                if (column === 'keyword') {
                    comparison = a.keyword.localeCompare(b.keyword);
                } else if (column === 'search_volume') {
                    comparison = a.search_volume - b.search_volume;
                } else if (column === 'competition') {
                    comparison = a.competition - b.competition;
                } else if (column === 'search_intent') {
                    comparison = a.search_intent.localeCompare(b.search_intent);
                } else if (column === 'reason_for_choosing') {
                    comparison = a.reason_for_choosing.localeCompare(b.reason_for_choosing);
                }

                return sortAscending ? comparison : comparison * -1;
            });

            displayKeywordsTable(allKeywords);
        }

        function copyCheckContentResults() {
            const resultsDiv = document.getElementById("checkContentResults");

            if (!resultsDiv) {
                console.warn("No element with id 'checkContentResults' found.");
                alert("Content Check results not found.");
                return;
            }

            // Create a temporary element for copying.  This ensures we get ALL the content, including hidden parts.
            const tempElement = document.createElement("div");
            tempElement.innerHTML = resultsDiv.innerHTML; //copy innerHTML (preserves formatting)
            tempElement.style.whiteSpace = "pre-wrap";  // Preserve line breaks and spaces.  Crucial!
            tempElement.style.userSelect = "auto"; // Allow text selection

            document.body.appendChild(tempElement); // Add to the DOM

            // Select the text in the temporary element
            const selection = window.getSelection();
            selection.removeAllRanges();
            const range = document.createRange();
            range.selectNodeContents(tempElement);
            selection.addRange(range);


            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert("Content check results copied to clipboard!.");
                } else {
                    console.error("Failed to copy text.");
                    alert("Failed to copy.  Please try again or manually select and copy the text.");
                }
            } catch (err) {
                console.error('Unable to copy: ' + err);
                alert("An error occurred while copying.  Please try again or manually select and copy the text.");
            } finally {
                document.body.removeChild(tempElement);  // Remove the temporary element
                selection.removeAllRanges(); // Deselect everything
            }
        }

        function copyPersonaResults() {
            const resultsDiv = document.getElementById("persona-results");

            if (!resultsDiv) {
                console.warn("No element with id 'persona-results' found.");
                alert("Perosna results not found.");
                return;
            }

            // Create a temporary element for copying.  This ensures we get ALL the content, including hidden parts.
            const tempElement = document.createElement("div");
            tempElement.innerHTML = resultsDiv.innerHTML; //copy innerHTML (preserves formatting)
            tempElement.style.whiteSpace = "pre-wrap";  // Preserve line breaks and spaces.  Crucial!
            tempElement.style.userSelect = "auto"; // Allow text selection

            document.body.appendChild(tempElement); // Add to the DOM

            // Select the text in the temporary element
            const selection = window.getSelection();
            selection.removeAllRanges();
            const range = document.createRange();
            range.selectNodeContents(tempElement);
            selection.addRange(range);


            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert("Personas copied to clipboard!.");
                } else {
                    console.error("Failed to copy text.");
                    alert("Failed to copy.  Please try again or manually select and copy the text.");
                }
            } catch (err) {
                console.error('Unable to copy: ' + err);
                alert("An error occurred while copying.  Please try again or manually select and copy the text.");
            } finally {
                document.body.removeChild(tempElement);  // Remove the temporary element
                selection.removeAllRanges(); // Deselect everything
            }
        }


        // Get the modal
        var modal = document.getElementById("feedbackModal");

        // Get the button that opens the modal
        var btn = document.getElementById("openFeedbackModalBtn");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("feedback-close")[0];

        // When the user clicks the button, open the modal 
        btn.onclick = function () {
            populateFeedbackModal();
            modal.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function () {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            } else if (event.target == document.getElementById('queriesModal')) {
                closeQueriesModal();
            }
        }


        function populateFeedbackModal() {
            document.getElementById("guidelinesURLs").value = document.getElementById("brand_guide_urls").value;
            document.getElementById("websiteURLs").value = document.getElementById("content_check_other_urls").value;
            document.getElementById("otherInstructions").value = document.getElementById("content_check_instructions").value;
            document.getElementById("contentToCheck").value = document.getElementById("content_to_check").value;
            document.getElementById("checkResults").value = document.getElementById("checkContentResults").textContent;

            // Show the submit feedback button
            document.getElementById("openFeedbackModalBtn").style.display = "block";
        }


        document.getElementById("submitFeedbackBtn").addEventListener("click", function () {
            const feedbackData = {
                guidelinesURLs: document.getElementById("guidelinesURLs").value,
                websiteURLs: document.getElementById("websiteURLs").value,
                otherInstructions: document.getElementById("otherInstructions").value,
                contentToCheck: document.getElementById("contentToCheck").value,
                checkResults: document.getElementById("checkResults").value,
                userFeedback: document.getElementById("userFeedback").value,
                user: JSON.parse(localStorage.getItem('googleUser')).email
            };

            // API Endpoint URL
            const apiUrl = 'https://bj7bexizm7.execute-api.ap-southeast-1.amazonaws.com/contentCheckerFeedback'; // Replace with your actual API endpoint

            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(feedbackData)
            })
                .then(response => {
                    if (response.ok) {
                        alert("Feedback submitted successfully!");
                        document.getElementById("userFeedback").value = ""; // Clear feedback
                        modal.style.display = "none"; // Close the modal
                    } else {
                        alert("Failed to submit feedback.");
                    }
                })
                .catch(error => {
                    console.error("Error submitting feedback:", error);
                    alert("An error occurred while submitting feedback.");
                });
        });

        document.addEventListener('DOMContentLoaded', function () {
            const coll = document.getElementsByClassName("funnel-collapsible-before");

            for (let i = 0; i < coll.length; i++) {
                coll[i].addEventListener("click", function () {
                    const content = this.nextElementSibling;

                    if (this.classList.contains("funnel-collapsible-before")) {
                        // If it's 'collapsible-before', change to 'collapsible' and show content
                        this.classList.remove("funnel-collapsible-before");
                        this.classList.add("funnel-collapsible");
                        content.style.display = "block";
                    } else {
                        // If it's 'collapsible', change back to 'collapsible-before' and hide content
                        this.classList.remove("funnel-collapsible");
                        this.classList.add("funnel-collapsible-before");
                        content.style.display = "none";
                    }
                });
            }
        });

        function sortIntersectionTable(columnName) {
            const table = document.getElementById('intersectionResultsTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Determine sort direction
            let isAscending = true; // Default to ascending

            if (table.dataset.sortColumn === columnName) {
                // Same column clicked again, toggle sort direction
                isAscending = table.dataset.sortDirection === 'desc'; // Reverse
            }

            table.dataset.sortColumn = columnName;
            table.dataset.sortDirection = isAscending ? 'asc' : 'desc'; //Update direction

            // Sort rows
            const sortedRows = rows.sort((rowA, rowB) => {
                const cellA = rowA.querySelector(`td:nth-child(${getColumnIndex(table, columnName) + 1})`);
                const cellB = rowB.querySelector(`td:nth-child(${getColumnIndex(table, columnName) + 1})`);

                const valueA = cellA ? cellA.textContent.trim() : '';
                const valueB = cellB ? cellB.textContent.trim() : '';

                let comparison;
                if (isFinite(valueA) && isFinite(valueB)) {
                    comparison = Number(valueA) - Number(valueB); // Numeric comparison
                } else {
                    comparison = valueA.localeCompare(valueB);  // Text comparison
                }

                return isAscending ? comparison : -comparison; // Apply sort direction
            });

            // Append sorted rows to the tbody
            sortedRows.forEach(row => tbody.appendChild(row));
        }

        function getColumnIndex(table, columnName) {
            const headers = Array.from(table.querySelectorAll('th'));
            for (let i = 0; i < headers.length; i++) {
                if (headers[i].textContent.trim() === columnName) {
                    return i;
                }
            }
            return -1; // Column not found
        }

        function copyInteractionResultsTable() {
            const table = document.getElementById('intersectionResultsTable'); // Get the table element
            if (!table) {
                console.error("Interaction Results Table not found");
                return;
            }

            // Extract table data
            const rows = Array.from(table.querySelectorAll('tr'));
            const tableData = rows.map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                return cells.map(cell => cell.textContent.trim()).join('\t'); // Tab-separated values
            }).join('\n'); // Newline for each row

            // Copy to clipboard
            navigator.clipboard.writeText(tableData)
                .then(() => {
                    alert('Interaction Results Table copied to clipboard! You can now paste it into a spreadsheet.');
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Failed to copy the table. Please try again.');
                });
        }

        // Function to export the interactionResultsTable as a CSV file
        function exportInteractionResultsTableToCSV() {
            const table = document.getElementById('intersectionResultsTable'); // Get the table element
            if (!table) {
                console.error("Interaction Results Table not found");
                return;
            }

            // Extract table data
            const rows = Array.from(table.querySelectorAll('tr'));
            const csvData = rows.map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                return cells.map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`).join(','); // Comma-separated values, escape double quotes
            }).join('\n'); // Newline for each row

            // Add BOM (Byte Order Mark) for UTF-8 encoding, crucial for international characters
            const bom = "\uFEFF";
            const csvString = bom + csvData;

            // Create a download link
            const blob = new Blob([csvString], {
                type: 'text/csv;charset=utf-8'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'interaction_results.csv');
            a.style.display = 'none';

            // Programmatically trigger the download
            document.body.appendChild(a);
            a.click();

            // Clean up
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function exportSiteKeywordsTableToCSV() {
            const table = document.getElementById('siteKeywords'); // Get the table element
            if (!table) {
                console.error("Site Keywords Table not found");
                return;
            }

            // Extract table data
            const rows = Array.from(table.querySelectorAll('tr'));
            const csvData = rows.map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                return cells.map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`).join(','); // Comma-separated values, escape double quotes
            }).join('\n'); // Newline for each row

            // Add BOM (Byte Order Mark) for UTF-8 encoding, crucial for international characters
            const bom = "\uFEFF";
            const csvString = bom + csvData;

            // Create a download link
            const blob = new Blob([csvString], {
                type: 'text/csv;charset=utf-8'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'site_keywords.csv');
            a.style.display = 'none';

            // Programmatically trigger the download
            document.body.appendChild(a);
            a.click();

            // Clean up
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function exportRankedKeywordsToCSV(rankedKeywordHeaderRow, rankedKeywordList) {
            // Helper function to escape CSV values
            function escapeCsvValue(value) {
                if (typeof value !== 'string') {
                    value = String(value); // Convert to string if not already
                }
                return `"${value.replace(/"/g, '""')}"`; // Escape double quotes
            }

            // 1. Extract header texts from the header row
            const headers = Array.from(rankedKeywordHeaderRow.querySelectorAll('.keyword-column strong'))
                .map(th => th.textContent.trim());  //Get header row texts

            // Create header row string
            const csvHeaderRow = headers.map(header => escapeCsvValue(header)).join(',');

            // Initialize CSV content with header row
            let csvContent = csvHeaderRow + '\n';  //BOM for UTF-8 encoding.

            // 2. Loop through the list items in rankedKeywordList to extract data
            const listItems = Array.from(rankedKeywordList.querySelectorAll('li.keyword-row'));  //Get data rows
            listItems.forEach(item => {
                const columns = Array.from(item.querySelectorAll('.keyword-column'));  //Get data cells
                const rowValues = columns.map(column => column.textContent.trim());  //Trim spaces in between
                csvContent += rowValues.map(value => escapeCsvValue(value)).join(',') + '\n';  //Escape cell values then combine with a comma.
            });

            // Add BOM (Byte Order Mark) for UTF-8 encoding, crucial for special characters
            const bom = "\uFEFF";
            csvContent = bom + csvContent;

            // Create a download link element
            const link = document.createElement('a');
            link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));  //Set download properties
            link.setAttribute('download', 'ranked_keywords.csv');
            link.style.display = 'none';

            // Append the link to the document
            document.body.appendChild(link);

            // Trigger the download
            link.click();

            // Remove the link from the document
            document.body.removeChild(link);
        }

        function exportSelectedRankedKeywordsToCSV(rankedKeywordHeaderRow, rankedKeywordList) {
            // Helper function to escape CSV values
            function escapeCsvValue(value) {
                if (typeof value !== 'string') {
                    value = String(value); // Convert to string if not already
                }
                return `"${value.replace(/"/g, '""')}"`; // Escape double quotes
            }

            // 1. Extract header texts from the header row
            const headers = Array.from(rankedKeywordHeaderRow.querySelectorAll('.keyword-column strong'))
                .map(th => th.textContent.trim());

            // Create header row string
            const csvHeaderRow = headers.map(header => escapeCsvValue(header)).join(',');

            // Initialize CSV content with header row
            let csvContent = csvHeaderRow + '\n';

            // 2. Loop through the list items in rankedKeywordList and only export checked rows
            const listItems = Array.from(rankedKeywordList.querySelectorAll('li.keyword-row'));

            listItems.forEach(item => {
                // Check if the checkbox in the row is checked
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    const columns = Array.from(item.querySelectorAll('.keyword-column'));
                    const rowValues = columns.map(column => column.textContent.trim());
                    csvContent += rowValues.map(value => escapeCsvValue(value)).join(',') + '\n';
                }
            });

            // Add BOM (Byte Order Mark) for UTF-8 encoding
            const bom = "\uFEFF";
            csvContent = bom + csvContent;

            // Create a download link element
            const link = document.createElement('a');
            link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));
            link.setAttribute('download', 'ranked_keywords.csv');
            link.style.display = 'none';

            // Append the link to the document
            document.body.appendChild(link);

            // Trigger the download
            link.click();

            // Remove the link from the document
            document.body.removeChild(link);
        }

        function exportSelectedKeywordSuggestionsToCSV(keywordHeaderRow, keywordList) {
            // Helper function to escape CSV values
            function escapeCsvValue(value) {
                if (typeof value !== 'string') {
                    value = String(value); // Convert to string if not already
                }
                return `"${value.replace(/"/g, '""')}"`; // Escape double quotes
            }

            // 1. Extract header texts from the header row
            const headers = Array.from(keywordHeaderRow.querySelectorAll('.keyword-column strong'))
                .map(th => th.textContent.trim());

            // Create header row string
            const csvHeaderRow = headers.map(header => escapeCsvValue(header)).join(',');

            // Initialize CSV content with header row
            let csvContent = csvHeaderRow + '\n';

            // 2. Loop through the list items in rankedKeywordList and only export checked rows
            const listItems = Array.from(keywordList.querySelectorAll('li.keyword-row'));

            listItems.forEach(item => {
                // Check if the checkbox in the row is checked
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    const columns = Array.from(item.querySelectorAll('.keyword-column'));
                    const rowValues = columns.map(column => column.textContent.trim());
                    csvContent += rowValues.map(value => escapeCsvValue(value)).join(',') + '\n';
                }
            });

            // Add BOM (Byte Order Mark) for UTF-8 encoding
            const bom = "\uFEFF";
            csvContent = bom + csvContent;

            // Create a download link element
            const link = document.createElement('a');
            link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));
            link.setAttribute('download', 'keyword_ideas.csv');
            link.style.display = 'none';

            // Append the link to the document
            document.body.appendChild(link);

            // Trigger the download
            link.click();

            // Remove the link from the document
            document.body.removeChild(link);
        }

        function exportKeywordSuggestionsToCSV(keywordHeaderRow, keywordList) {
            // Helper function to escape CSV values
            function escapeCsvValue(value) {
                if (typeof value !== 'string') {
                    value = String(value); // Convert to string if not already
                }
                return `"${value.replace(/"/g, '""')}"`; // Escape double quotes
            }

            // 1. Extract header texts from the header row
            const headers = Array.from(keywordHeaderRow.querySelectorAll('.keyword-column strong'))
                .map(th => th.textContent.trim());  //Get header row texts

            // Create header row string
            const csvHeaderRow = headers.map(header => escapeCsvValue(header)).join(',');

            // Initialize CSV content with header row
            let csvContent = csvHeaderRow + '\n';  //BOM for UTF-8 encoding.

            // 2. Loop through the list items in rankedKeywordList to extract data
            const listItems = Array.from(keywordList.querySelectorAll('li.keyword-row'));  //Get data rows
            listItems.forEach(item => {
                const columns = Array.from(item.querySelectorAll('.keyword-column'));  //Get data cells
                const rowValues = columns.map(column => column.textContent.trim());  //Trim spaces in between
                csvContent += rowValues.map(value => escapeCsvValue(value)).join(',') + '\n';  //Escape cell values then combine with a comma.
            });

            // Add BOM (Byte Order Mark) for UTF-8 encoding, crucial for special characters
            const bom = "\uFEFF";
            csvContent = bom + csvContent;

            // Create a download link element
            const link = document.createElement('a');
            link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));  //Set download properties
            link.setAttribute('download', 'keyword_ideas.csv');
            link.style.display = 'none';

            // Append the link to the document
            document.body.appendChild(link);

            // Trigger the download
            link.click();

            // Remove the link from the document
            document.body.removeChild(link);
        }

        function logConversation(question, generated_answer, feedback, suggested_answer, conversation_id) {
            let user;
            try {
                user = JSON.parse(localStorage.getItem('googleUser')).email;
            } catch (error) {
                console.error("Error parsing user from local storage", error);
                return; // Early exit if user cannot be determined
            }

            fetch('https://7spo2afb9i.execute-api.ap-southeast-1.amazonaws.com/chatbotLogger', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    question: question,
                    generated_answer: generated_answer,
                    feedback: feedback || "",
                    suggested_answer: suggested_answer || "",
                    conversation_id: conversation_id,
                    user: user,
                    is_feedback: "no"
                })
            })
                .then(response => {
                    if (!response.ok) {
                        // Handle HTTP errors (4xx, 5xx status codes)
                        console.error("HTTP error!", response.status, response.statusText);
                        throw new Error(`HTTP error! ${response.status} ${response.statusText}`); //Re-throw to be caught in the .catch block

                    }
                    return response.json(); // Parse JSON body if the request is successful
                })
                .then(data => {
                    console.log("Conversation logged successfully:", data); //Log successful response
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    // Log the error message to the console, and potentially display it to the user

                });
        }


        //chatbot2
        document.addEventListener('DOMContentLoaded', () => {
            const chatbotButton = document.getElementById('chatbot-button');
            const chatbotModal = document.getElementById('chatbot-modal');
            const closeChatbotButton = document.getElementById('close-chatbot');
            const chatMessages = document.getElementById('chat-messages');
            const questionInput = document.getElementById('question-input');
            const sendButton = document.getElementById('send-button-2');

            let isChatbotOpen = false; // Track chatbot state

            chatbotButton.addEventListener('click', () => {
                isChatbotOpen = !isChatbotOpen;
                chatbotModal.style.display = isChatbotOpen ? 'block' : 'none';

                if (chatMessages.textContent == "") {
                    addMessage('chatbot', 'Hello ' + JSON.parse(localStorage.getItem('googleUser')).name.split(' ')[0] + ', how can I help you today?');
                }
            });

            closeChatbotButton.addEventListener('click', () => {
                chatbotModal.style.display = 'none';
                isChatbotOpen = false;
            });

            sendButton.addEventListener('click', async () => {
                const question = questionInput.value.trim();
                if (question !== '') {
                    addMessage('user', question);
                    +                    addMessage('chatbot', 'getting an answer...'); // Display "getting an answer..."
                    questionInput.value = '';
                    try {
                        const response = await fetch('https://7qet2rnlb3.execute-api.ap-southeast-1.amazonaws.com/gptResponses', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ 'question': question, 'previous_response_id': document.getElementById('previous-response-id').innerText || "" })
                        });
                        + chatMessages.lastChild.remove(); // Remove "getting an answer..."
                        const data = await response.json();
                        console.log(data);
                        addMessage('chatbot', data.answer);
                        document.getElementById('previous-response-id').innerText = data.response_id;
                        logConversation(question, data.answer, "-", "-", document.getElementById('threadId').innerText);
                    } catch (error) {
                        console.error('Error:', error);
                        addMessage('chatbot', 'Sorry, I could not process your request.');
                    }
                }
            });

            questionInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    sendButton.click();
                }
            });

            // Function to create and open the feedback modal
            function openFeedbackModal(question, answer) {
                // 1. Create the Modal Structure
                const modal = document.createElement('div');
                modal.id = 'feedbackModal';
                modal.classList.add('feedback-modal');
                modal.innerHTML = `
                    <div class="feedback-modal-content">
                    <span class="feedback-close"></span>
                    <h2>Give Feedback</h2>
                    <p><b>Question:</b></p>
                    <p>${question}</p>
                    <p><b>Generated Answer:</b></p>
                    <p>${answer}</p>
                    <label for="userFeedback"><b>Your Feedback:</b></label>
                    <textarea id="userFeedback" style="width: 100%; height: 100px;"></textarea><br>
                    <label for="suggestedAnswer"><b>Suggested Answer:</b></label><br>
                    <textarea id="suggestedAnswer" style="width: 100%; height: 100px;"></textarea>
                    <button id="submitFeedbackBtn">Submit Feedback</button>
                    </div>
                `;

                // 2. Add Event Listeners
                document.body.appendChild(modal); // Append to the document

                // Close Modal Button
                const closeBtn = modal.querySelector('.feedback-close');
                closeBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                    modal.remove()
                });

                // Submit Feedback Button
                const submitBtn = modal.querySelector('#submitFeedbackBtn');
                submitBtn.addEventListener('click', () => {
                    const feedback = modal.querySelector('#userFeedback').value;
                    const suggestedAnswer = modal.querySelector('#suggestedAnswer').value;
                    const conversationId = document.getElementById('threadId').innerText; // Or however you get it

                    submitFeedback(question, answer, feedback, suggestedAnswer, conversationId); // Call the submission function
                    modal.style.display = 'none'; // Hide the modal after submission
                    modal.remove()//remove the modal after submission
                });

                // Click outside the modal to close
                window.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                        modal.remove()
                    }
                });

                // 3. Display the Modal
                modal.style.display = 'block';
            }

            // Function to submit the feedback to your API
            async function submitFeedback(question, generatedAnswer, feedback, suggestedAnswer, conversationId) {
                user = JSON.parse(localStorage.getItem('googleUser')).email
                try {
                    const response = await fetch('https://7spo2afb9i.execute-api.ap-southeast-1.amazonaws.com/chatbotLogger', { // Replace with your API endpoint
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            question: question,
                            generated_answer: generatedAnswer,
                            feedback: feedback,
                            suggested_answer: suggestedAnswer,
                            conversation_id: conversationId,
                            user: user,
                            is_feedback: "yes"
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Feedback submitted:', data);
                    alert('Thank you for your feedback!');

                } catch (error) {
                    console.error('Error submitting feedback:', error);
                    alert('Failed to submit feedback. Please try again.');
                }
            }

            function addMessage(sender, message, question = null) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', sender);
                messageDiv.innerHTML = message;

                // Add the "Give Feedback" button *only* to chatbot messages
                if (sender === 'chatbot') {
                    const feedbackButton = document.createElement('button');
                    feedbackButton.textContent = 'Feedback';
                    feedbackButton.classList.add('feedback-button'); // Add a class for styling
                    feedbackButton.addEventListener('click', () => {
                        // Get the current message element
                        const currentMessageDiv = feedbackButton.parentNode; // The parent is the messageDiv

                        // Find the previous element (if it exists)
                        let previousElement = currentMessageDiv.previousElementSibling;

                        let questionText = "";

                        if (previousElement) {
                            questionText = previousElement.textContent;

                        } else {
                            console.warn("No previous element found.  Using empty string for questionText.");
                        }

                        openFeedbackModal(questionText, message);
                    });

                    console.log(document.getElementById('chat-messages').textContent);
                    messageDiv.innerHTML = messageDiv.innerHTML + "<br>";
                    if (message != 'Hello ' + JSON.parse(localStorage.getItem('googleUser')).name.split(' ')[0] + ', how can I help you today?') {
                        messageDiv.appendChild(feedbackButton);
                    }
                }

                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Close chatbot on Esc key press
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && isChatbotOpen) {
                    chatbotModal.style.display = 'none';
                    isChatbotOpen = false;
                }
            });
        });

        function goToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth' // Optional: Adds smooth scrolling
            });
        }

        function clearPageState() {
            const collapsibles = document.querySelectorAll('.collapsible');

            // Iterate over each element
            collapsibles.forEach(collapsible => {
                // Set the background color to the specified color
                collapsible.style.backgroundColor = "#004c9d";
            });
            // Clear input values
            document.getElementById('domain').value = '';
            document.getElementById('location').value = 'Singapore'; // Reset to default
            document.getElementById('language').value = 'English'; // Reset to default
            document.getElementById('keywords').value = '';

            //Clear values of content generator
            document.getElementById('subgroups').value = '';
            document.getElementById('painpoints').value = '';
            document.getElementById('audience_goal').value = '';
            document.getElementById('product_service').value = '';
            document.getElementById('desired_action').value = '';
            document.getElementById('post_objectives').value = '';
            document.getElementById('content-type').value = '';
            document.getElementById('word_count').value = '';
            document.getElementById('tone').value = '';
            document.getElementById('usp').value = '';
            document.getElementById('pov').value = '';
            document.getElementById('emojis').value = '';
            document.getElementById('hashtags').value = '';

            document.getElementById('generator_brand_guide_urls').value = '';
            document.getElementById('sample-text').value = '';
            document.getElementById('post-info').value = '';
            document.getElementById('reference-url').value = '';

            document.getElementById('landingPageUrl').value = '';
            document.getElementById('landingPageAuditKeyword').value = '';

            //Clear output section values
            document.getElementById('targetTitle').innerText = "";
            document.getElementById('targetDescription').innerText = "";
            //document.getElementById('targetDomainRank').innerText = "";
            document.getElementById('targetBacklinks').innerText = "";
            document.getElementById('targetSpamScore').innerText = "";
            document.getElementById('targetRefDomains').innerText = "";
            document.getElementById('targetInternalLinks').innerText = "";
            document.getElementById('targetExternalLinks').innerText = "";
            document.getElementById('targetH1').innerText = "";
            document.getElementById('targetImages').innerText = "";
            document.getElementById('targetCls').innerText = "";
            document.getElementById('targetLcp').innerText = "";
            document.getElementById('targetFid').innerText = "";
            document.getElementById('targetSchema').innerText = "";
            document.getElementById('targetReadability').innerText = "";
            document.getElementById('targetWordCount').innerText = "";
            document.getElementById('da').innerText = "";
            document.getElementById('pa').innerText = "";

            // Clear dynamic content sections
            document.getElementById('overall-summary').innerHTML = '';
            document.getElementById('keyword-analysis-results').innerHTML = '';
            document.getElementById('auditSummary').innerHTML = '';
            document.getElementById('comparison-results').innerHTML = '';

            //document.getElementById('crawlerReport').innerHTML = '';

            document.getElementById("competitors-target1").value = '';
            document.getElementById("competitor_keywords").value = '';
            document.getElementById("competitors-language").value = '';
            document.getElementById("competitors-location").value = '';
            document.getElementById("competitorsOutput").innerHTML = '';

            document.getElementById("persona_webpages").value = '';
            document.getElementById("persona_manual").value = '';
            document.getElementById("persona-results").innerHTML = '';

            document.getElementById("MediaPlanWebpages").value = '';
            document.getElementById("MediaPlanBudget").value = '';
            document.getElementById("MediaPlanManual").value = '';
            document.getElementById("mediaPlanResults").innerHTML = '';

            document.getElementById("content_check_other_urls").value = '';
            document.getElementById("brand_guide_urls").value = '';
            document.getElementById("content_check_instructions").value = '';
            document.getElementById("content_to_check").value = '';
            document.getElementById("checkContentResults").innerHTML = '';

            document.getElementById("on-page-url").value = '';
            document.getElementById("on-page-keywords").value = '';
            document.getElementById("onPageResults").innerHTML = '';
            document.getElementById("imageRecommendations").innerHTML = '';
            document.getElementById("contentRecommendations").innerHTML = '';


            //Clear technical seo output section and buttons
            //document.getElementById("auditSummary").innerHTML = "";
            //document.getElementById('downloadResultsBtn').style.display = 'none';

            // Clear local storage
            localStorage.removeItem('pageState');
            console.log('Page state cleared.');

            // Reset Visibility Style
            document.getElementById('overall-summary').style.display = 'none';

            //Call function to re-render components
            allKeywords = [];
        }

        function openQueriesModal() {
            document.getElementById('queriesModal').style.display = "block";
            loadPreviousQueries('on_page'); // Load data when modal opens
        }

        function openTimeToRankQueriesModal() {
            document.getElementById("timeToRankModal").style.display = "block";
            loadPreviousQueries('time_to_rank'); // Load data when modal opens
        }

        function openContentComparisonQueriesModal() {
            document.getElementById("contentComparisonkModal").style.display = "block";
            loadPreviousQueries('content_comparison'); // Load data when modal opens
        }


        function closeQueriesModal() {
            document.getElementById('queriesModal').style.display = "none";
        }

        function closeContentComparisonQueriesModal() {
            document.getElementById('contentComparisonkModal').style.display = "none";
        }

        function closeTimeToRankQueriesModal() {
            document.getElementById('timeToRankModal').style.display = "none";
        }

        // --- API Interaction Functions ---
        async function loadPreviousQueries(query_type) {
            const API_ENDPOINT = "https://vau2b5m95m.execute-api.ap-southeast-1.amazonaws.com/queryDatabase"; // Replace with your actual API endpoint
            const USER_EMAIL = JSON.parse(localStorage.getItem('googleUser')).email;
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user: USER_EMAIL,
                        collection: query_type
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (query_type == "on_page") {
                    populateQueriesTable(data);
                } else if (query_type == "time_to_rank") {
                    populateTimeToRankQueriesTable(data);
                } else if (query_type == "content_comparison") {
                    populateContentComparisonQueriesTable(data);
                }

            } catch (error) {
                console.error("Error loading previous queries:", error);
                alert("Failed to load previous queries. See console for details.");
            }
        }

        async function contentComparisonToDatabase() {
            endpoint = "https://7gdde3ohdl.execute-api.ap-southeast-1.amazonaws.com/contentComparisonToDatabase";

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    comparison_urls: document.getElementById('comparison-urls').value,
                    comparison_keyword: document.getElementById('comparison-keyword').value,
                    language: document.getElementById('comparison-language').value,
                    location: document.getElementById('comparison-location').value,

                    initial_table: document.getElementById('initial-table').innerHTML,
                    comparison_results: document.getElementById('comparison-results').innerHTML,
                    user: JSON.parse(localStorage.getItem('googleUser')).email
                })
            })

            data = await response.json();
        }

        function populateQueriesTable(queries) {
            const tableBody = document.getElementById('queriesTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ""; // Clear existing rows

            queries.forEach((query, index) => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = formatDate(query.date);
                row.insertCell(2).textContent = query.url;
                row.insertCell(3).textContent = query.keywords;
                row.insertCell(4).textContent = query.user; // Corrected the index here

                row.addEventListener('click', () => loadQueryData(query.id, "on_page")); // Add click listener
            });
            document.getElementById('on_page_loading').style.display = "none";
        }

        function populateTimeToRankQueriesTable(queries) {
            const tableBody = document.getElementById('timeToRankQueriesTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ""; // Clear existing rows

            queries.forEach((query, index) => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = formatDate(query.date);
                row.insertCell(2).textContent = query.url;
                row.insertCell(3).textContent = query.keywords;
                row.insertCell(4).textContent = query.user; // Corrected the index here

                row.addEventListener('click', () => loadTimeToRankQueryData(query.id, "time_to_rank")); // Add click listener
            });
            document.getElementById('time_to_rank_loading').style.display = "none";
        }

        function populateContentComparisonQueriesTable(queries) {
            const tableBody = document.getElementById('contentComparisonQueriesTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ""; // Clear existing rows

            queries.forEach((query, index) => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = formatDate(query.date);
                row.insertCell(2).textContent = query.comparison_urls;
                row.insertCell(3).textContent = query.comparison_keyword;
                row.insertCell(4).textContent = query.user; // Corrected the index here

                row.addEventListener('click', () => loadContentComparisonQueryData(query.id, "content_comparison")); // Add click listener
            });
            document.getElementById('content_comparison_loading').style.display = "none";
        }


        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');

            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        async function loadQueryData(id, collection) {
            showLoadingModal();
            endpoint = "https://3fbj0gjlak.execute-api.ap-southeast-1.amazonaws.com/loadSingleQuery";
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "id": id,
                    "collection": collection,
                })
            })

            query = await response.json();
            document.getElementById('on-page-url').value = query.url;
            document.getElementById('on-page-keywords').value = query.keywords.join(', ');
            document.getElementById('onPageResults').innerHTML = query.meta_table;
            document.getElementById('imageRecommendations').innerHTML = query.image_table;
            document.getElementById('contentRecommendations').innerHTML = query.content_table;

            document.getElementById('onPageResultsCollapsible').style.display = "block";
            document.getElementById('onPageResults').style.display = "block";
            document.getElementById('imageCollapsible').style.display = "block";
            document.getElementById('imageRecommendations').style.display = "block";
            document.getElementById('contentCollapsible').style.display = "block";
            document.getElementById('contentRecommendations').style.display = "block";


            hideLoadingModal();
            closeQueriesModal(); // Close modal after loading
        }

        // Delegate the event listener to the document
        document.addEventListener('DOMContentLoaded', function () {
            const collapsibles = document.querySelectorAll('.keywords-collapsible');

            collapsibles.forEach(collapsible => {
                collapsible.addEventListener('click', function () {
                    this.classList.toggle('keywords-active');
                    const content = this.nextElementSibling;

                    // Toggle the display style of the content
                    if (content.style.display === 'block') {
                        content.style.display = 'none';
                    } else {
                        content.style.display = 'block';
                    }
                });
            });
        });

        async function loadTimeToRankQueryData(id, collection) {
            showLoadingModal();
            endpoint = "https://3fbj0gjlak.execute-api.ap-southeast-1.amazonaws.com/loadSingleQuery";
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "id": id,
                    "collection": collection,
                })
            })

            query = await response.json();

            document.getElementById('domain').value = query.url;
            document.getElementById('keywords').value = query.keywords;
            document.getElementById('location').value = query.location;
            document.getElementById('language').value = query.language;

            document.getElementById('siteKeywords').innerHTML = query.webpage_keywords;
            document.getElementById('rankingKeywords').innerHTML = query.ranking_keywords;
            document.getElementById('keywordSuggestions').innerHTML = query.suggestion_keywords;

            document.getElementById('metaData').innerHTML = query.meta_data;
            document.getElementById('domainMetrics').innerHTML = query.domain_metrics;
            document.getElementById('overall-summary').innerHTML = query.time_to_rank_table;

            document.getElementById('keywordAnalysis').innerHTML = query.keyword_analysis;
            document.getElementById('keywordAnalysis').style.display = "block";
            hideLoadingModal();
            closeTimeToRankQueriesModal(); // Close modal after loading
        }

        async function loadContentComparisonQueryData(id, collection) {
            showLoadingModal();
            endpoint = "https://3fbj0gjlak.execute-api.ap-southeast-1.amazonaws.com/loadSingleQuery";
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "id": id,
                    "collection": collection,
                })
            })

            query = await response.json();
            document.getElementById('comparison-urls').value = query.comparison_urls;
            document.getElementById('comparison-keyword').value = query.comparison_keyword;
            document.getElementById('comparison-location').value = query.location;
            document.getElementById('comparison-language').value = query.language;

            document.getElementById('initial-table').innerHTML = query.initial_table;
            document.getElementById('comparison-results').innerHTML = query.comparison_results;
            hideLoadingModal();
            closeContentComparisonQueriesModal(); // Close modal after loading
        }

        // On Page
        async function getImages() {
            document.getElementById('contentCollapsible').style.backgroundColor = "#004c9d";
            document.getElementById('imageCollapsible').style.backgroundColor = "#004c9d";
            document.getElementById('onPageResultsCollapsible').style.backgroundColor = "#004c9d";

            document.getElementById('onPageResults').innerHTML = ""; // Clear previous results
            document.getElementById('imageRecommendations').innerHTML = ""; // Clear previous results
            document.getElementById('contentRecommendations').innerHTML = ""; // Clear previous results

            document.getElementById('onPageResultsCollapsible').style.display = "none";
            document.getElementById('imageCollapsible').style.display = "none";
            document.getElementById('contentCollapsible').style.display = "none";
            const url = document.getElementById('on-page-url').value;
            const keywords = document.getElementById('on-page-keywords').value; // Get keywords
            document.getElementById("getImagesBtn").innerText = "Extracting elements..."; // Change button text
            document.getElementById("getImagesBtn").innerHTML += '<img src="https://usagif.com/wp-content/uploads/loading-73.gif" width="50">';

            if (!url) {
                document.getElementById("getImagesBtn").innerText = "Extract Elements & Generate Recommendations"; //Revert button text
                return;
            }

            // Process keywords (split by commas or newlines)
            const keywordArray = keywords.split(/[,\n]+/).map(keyword => keyword.trim()).filter(keyword => keyword !== "");

            const endpoint = 'https://udjdc333m9.execute-api.ap-southeast-1.amazonaws.com/getImages';

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url,
                        keywords: keywordArray // Send keywords to the backend
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Call the second API and then display the data
                displayInitialData(data);


                if (!keywords) {
                    alert("No content recommendations will be given as no keywords were entered.")
                    document.getElementById("getImagesBtn").innerText = "Extract Elements & Generate Recommendations"
                    return;
                } else {
                    getOnPageRecommendations(data, keywordArray);
                    getContentRecommendations(url, keywordArray);
                    document.getElementById("getImagesBtn").innerText = "Generating Recommendations...";
                    document.getElementById("getImagesBtn").innerHTML += '<img src="https://usagif.com/wp-content/uploads/loading-73.gif" width="50">';
                }

            } catch (error) {
                document.getElementById('onPageResults').innerHTML = `<p>Error: ${error}</p>`;
                document.getElementById("getImagesBtn").innerText = "Extract Elements & Generate Recommendations";
            }
        }

        // On Page
        async function getContentRecommendations(url, keywordArray) {
            const recommendationEndpoint = 'https://pkkz2e02ch.execute-api.ap-southeast-1.amazonaws.com/onPageContentRecommendations';

            try {
                const recommendationResponse = await fetch(recommendationEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url,
                        "keywords": keywordArray
                    })
                });

                if (!recommendationResponse.ok) {
                    throw new Error(`HTTP error! status: ${recommendationResponse.status}`);
                }

                const recommendationData = await recommendationResponse.json();
                console.log(recommendationData);

                let contentTableHTML = `
            <table id="contentTable">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Current Content</th>
                        <th>Recommendation</th>
                        <th>Rationale</th>
                    </tr>
                </thead>
                <tbody>
            `;

                let i = 0;
                for (const recommendation of recommendationData) {
                    contentTableHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td>${recommendation.current_value}</td>
                    <td><textarea>${recommendation.suggested_value}</textarea></td>
                    <td>${recommendation.rationale}</td>
                </tr>
            `;
                    i++;
                }


                contentTableHTML += `
                </tbody>
            </table>
            `;

                document.getElementById('contentRecommendations').innerHTML = contentTableHTML + '<div style="text-align: center;"><button class="export-button" onclick="exportOnPageToCSV()">Export to CSV</button></div>';
                document.getElementById('contentCollapsible').style.display = "block";
                localStorage.setItem('onPageContent', document.getElementById('contentRecommendations').innerHTML);

            } catch (error) {
                console.error("Error fetching recommendations:", error);
                document.getElementById('contentRecommendations').innerHTML = `<p>Error fetching recommendations: ${error}</p>`;
            }
        }

        async function getOnPageRecommendations(firstApiResponse, keywordArray) {
            const recommendationEndpoint = 'https://vwmqqj251d.execute-api.ap-southeast-1.amazonaws.com/onPageRecommendations';

            try {
                const recommendationResponse = await fetch(recommendationEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "data": firstApiResponse,
                        "keywords": keywordArray
                    })
                });

                if (!recommendationResponse.ok) {
                    throw new Error(`HTTP error! status: ${recommendationResponse.status}`);
                }

                const recommendationData = await recommendationResponse.json();
                displayAllData(recommendationData);
                localStorage.setItem('onPageResults', document.getElementById('onPageResults').innerHTML);
                localStorage.setItem('onPageImages', document.getElementById('imageRecommendations').innerHTML);

            } catch (error) {
                console.error("Error fetching recommendations:", error);
                document.getElementById('onPageResults').innerHTML = `<p>Error fetching recommendations: ${error}</p>`;
            }
        }

        // On page
        function displayInitialData(data) {
            // Add export button above meta table
            let resultsHTML = '';

            let metaTableHTML = `
            <table id="metaTable">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Current Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Meta Title</td>
                        <td>${data.meta_title}</td>
                    </tr>
                    <tr>
                        <td>Meta Description</td>
                        <td>${data.meta_description}</td>
                    </tr>
                    <tr>
                        <td>Canonical URL</td>
                        <td>${data.canonical_url}</td>
                    </tr>`;

            // Function to add heading rows
            function addHeadingRows(headingType, headings) {
                headings.forEach(heading => {
                    metaTableHTML += `
                            <tr>
                                <td>${headingType}</td>
                                <td>${heading}</td>
                            </tr>
                        `;
                });
            }

            addHeadingRows("H1 Heading", data.headings.h1);
            addHeadingRows("H2 Heading", data.headings.h2);
            addHeadingRows("H3 Heading", data.headings.h3);
            addHeadingRows("H4 Heading", data.headings.h4);

            metaTableHTML += `

                    </tbody>
                </table>
            `;

            let imageTableHTML = `
                    <table id="imageTable">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Image URL <button class="copy-button" onclick="copyColumn(1, 'imageTable')">Copy</button></th>
                                <th>Image Preview</th>
                                <th>Alt Text <button class="copy-button" onclick="copyColumn(3, 'imageTable')">Copy</button></th>
                            </tr>
                        </thead>
                        <tbody>
                `;

            for (let i = 0; i < data.image_data.length; i++) {
                const item = data.image_data[i];
                const imageUrl = Object.keys(item)[0];
                const altText = item[imageUrl] || ''; // Handle cases where alt text is empty

                imageTableHTML += `
            <tr>
                <td>${i + 1}</td>
                <td><a href="${imageUrl}" target="_blank">${imageUrl}</a></td>
                <td><img src="${imageUrl}" alt="${altText}"></td>
                <td>${altText}</td>
            </tr>
            `;
            }

            imageTableHTML += `
            </tbody>
        
         `;

            resultsHTML += metaTableHTML

            document.getElementById('imageRecommendations').innerHTML = imageTableHTML;

            // Add export button after image table
            resultsHTML += '<button class="export-button" onclick="exportOnPageToCSV()">Export to CSV</button>';

            document.getElementById('onPageResults').innerHTML = resultsHTML;

            document.getElementById('onPageResultsCollapsible').style.display = "block";
            document.getElementById('imageCollapsible').style.display = "block";

            localStorage.setItem('onPageUrl', document.getElementById('on-page-url').value);
            localStorage.setItem('onPageKeywords', document.getElementById('on-page-keywords').value);
            localStorage.setItem('onPageResults', document.getElementById('onPageResults').innerHTML);
        }

        // On-page
        function displayAllData(data) {
            console.log(data);
            // Add export button above meta table
            let resultsHTML = '';

            let metaTableHTML = `
        <table id="metaTable">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Current Value</th>
                    <th>Suggested Change</th>
                    <th>Rationale</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Meta Title</td>
                    <td>${data.meta_title.current_value}</td>
                    <td><textarea>${data.meta_title.suggested_value}</textarea></td>
                    <td>${data.meta_title.rationale}</td>
                </tr>
                <tr>
                    <td>Meta Description</td>
                    <td>${data.meta_description.current_value}</td>
                    <td><textarea>${data.meta_description.suggested_value}</textarea></td>
                    <td>${data.meta_description.rationale}</td>
                </tr>
                <tr>
                    <td>Canonical URL</td>
                    <td>${data.canonical_url.current_value}</td>
                    <td><textarea>${data.canonical_url.suggested_value}</textarea></td>
                    <td>${data.canonical_url.rationale}</td>
                </tr>`;

            // Function to add heading rows
            function addHeadingRows(headingType, headings) {
                headings.forEach(heading => {
                    metaTableHTML += `
                <tr>
                    <td>${headingType}</td>
                    <td>${heading.current_value}</td>
                    <td><textarea>${heading.suggested_value}</textarea></td>
                    <td>${heading.rationale}</td>
                </tr>
            `;
                });
            }

            addHeadingRows("H1 Heading", data.headings.h1);
            addHeadingRows("H2 Heading", data.headings.h2);
            addHeadingRows("H3 Heading", data.headings.h3);
            addHeadingRows("H4 Heading", data.headings.h4);

            metaTableHTML += `

            </tbody>
        </table>
    `;

            let imageTableHTML = `
            <table id="imageTable">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Image URL <button class="copy-button" onclick="copyColumn(1, 'imageTable')">Copy</button></th>
                        <th>Image Preview</th>
                        <th>Alt Text <button class="copy-button" onclick="copyColumn(3, 'imageTable')">Copy</button></th>
                        <th>Suggested Alt Text</th>
                        <th>Rationale</th>
                    </tr>
                </thead>
                <tbody>
        `;

            let i = 0;
            for (const imageData of data.image_data) {
                const imageUrl = Object.keys(imageData)[0];
                const imageDetails = imageData[imageUrl];

                imageTableHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td><a href="${imageUrl}" target="_blank">${imageUrl}</a></td>
                    <td><img src="${imageUrl}" alt="${imageDetails.current_value}"></td>
                    <td>${imageDetails.current_value}</td>
                    <td><textarea>${imageDetails.suggested_value}</textarea></td>
                    <td>${imageDetails.rationale}</td>
                </tr>
            `;
                i++;
            }


            imageTableHTML += `
                </tbody>
            </table>
        `;

            resultsHTML += metaTableHTML;

            // Add export button after image table
            resultsHTML += '<button class="export-button" onclick="exportOnPageToCSV()">Export to CSV</button>';

            document.getElementById('onPageResults').innerHTML = resultsHTML;
            document.getElementById('imageRecommendations').innerHTML = imageTableHTML;
            document.getElementById("getImagesBtn").innerText = "Extract Elements & Generate Recommendations";
            localStorage.setItem('onPageResults', document.getElementById('onPageResults').innerHTML);
            localStorage.setItem('onPageImages', document.getElementById('imageRecommendations').innerHTML);
            onPageToDatabase();
        }

        async function checkMangoolsQuota() {
            showLoadingModal();
            endpoint = "https://hjw4zjgve4.execute-api.ap-southeast-1.amazonaws.com/mangoolsQuota";

            const response = await fetch(endpoint, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })

            data = await response.json();
            hideLoadingModal();
            alert("Remaining quota for the day: " + data + "/200");

        }

        async function onPageToDatabase() {
            keywords = document.getElementById('on-page-keywords').value; // Get keywords
            keywordArray = keywords.split(/[,\n]+/).map(keyword => keyword.trim()).filter(keyword => keyword !== "");
            endpoint = "https://7nq1nq4ll5.execute-api.ap-southeast-1.amazonaws.com/onPageToDatabase";

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    url: document.getElementById('on-page-url').value,
                    keywords: keywordArray,
                    meta_table: document.getElementById('onPageResults').innerHTML,
                    image_table: document.getElementById('imageRecommendations').innerHTML,
                    content_table: document.getElementById('contentRecommendations').innerHTML,
                    user: JSON.parse(localStorage.getItem('googleUser')).email
                })
            })

            data = await response.json();
        }

        function copyColumn(columnIndex, tableId = 'onPageResults') {
            let table = document.querySelector('table'); // Default to the first table
            if (tableId === 'imageTable') {
                // Find the second table if tableId is 'imageTable'
                const tables = document.querySelectorAll('table');
                table = tables[1]; // Assuming the image table is the second one
            }

            if (!table) {
                console.error('Table not found');
                return;
            }

            const rows = table.querySelectorAll('tr');
            let columnText = '';

            for (let i = 1; i < rows.length; i++) { // Skip the header row
                const cells = rows[i].querySelectorAll('td');
                if (cells.length > columnIndex) {
                    columnText += cells[columnIndex].textContent.trim() + '\n';
                }
            }

            // Create a temporary textarea element to hold the text
            const textarea = document.createElement('textarea');
            textarea.value = columnText;
            document.body.appendChild(textarea);

            // Select the text in the textarea
            textarea.select();

            try {
                // Execute the copy command
                const successful = document.execCommand('copy');
                const msg = successful ? 'successful' : 'unsuccessful';
                console.log('Copying text command was ' + msg);
                alert('Column copied to clipboard!');
            } catch (err) {
                console.error('Oops, unable to copy', err);
                alert('Failed to copy column to clipboard.');
            }

            // Remove the temporary textarea
            document.body.removeChild(textarea);
        }

        function exportOnPageToCSV() {
            // Collect data from both tables
            const metaTable = document.getElementById('metaTable');
            const imageTable = document.getElementById('imageTable');
            const contentTable = document.getElementById('contentTable');


            if (!metaTable || !imageTable) {
                alert('Tables not found. Please extract data first.');
                return;
            }

            const metaData = tableToCSV(metaTable);
            const imageData = tableToCSV(imageTable);
            const contentData = tableToCSV(contentTable);

            // Combine the data with a separator
            const csvData = "Meta Table Data:\n" + metaData + "\n\nImage Table Data:\n" + imageData + "\n\nContent Recommendations:\n" + contentData;

            // Create a download link
            const filename = 'on_page_recommendations.csv';
            const csvFile = new Blob([csvData], {
                type: 'text/csv'
            });
            const downloadLink = document.createElement('a');
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        function tableToCSV(table) {
            const rows = table.querySelectorAll('tr');
            let csv = [];

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].querySelectorAll('th, td');
                let row = [];
                for (let j = 0; j < cells.length; j++) {
                    //remove the button tag
                    let cellText = cells[j].textContent.replace(/<[^>]*>?/gm, '').trim();
                    row.push('"' + cellText.replace(/"/g, '""') + '"'); // Escape double quotes
                }
                csv.push(row.join(','));
            }

            return csv.join('\n');
        }

        function showTooltip(event, text) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = text;
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';  // Position it next to the mouse
            tooltip.style.top = (event.pageY + 10) + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }


        function loadCachedData() {
            const url = localStorage.getItem('onPageUrl');
            const keywords = localStorage.getItem('onPageKeywords');
            const resultsHTML = localStorage.getItem('onPageResults');
            const imageHTML = localStorage.getItem('onPageImages');
            const contentHTML = localStorage.getItem('onPageContent');

            if (url) {
                document.getElementById('on-page-url').value = url;
            }
            if (keywords) {
                document.getElementById('on-page-keywords').value = keywords;
            }
            if (resultsHTML) {
                document.getElementById('onPageResults').innerHTML = resultsHTML;
                document.getElementById('onPageResultsCollapsible').style.display = "block";
                document.getElementById('onPageResultsCollapsible').style.backgroundColor = "green";
            }
            if (imageHTML) {
                document.getElementById('imageRecommendations').innerHTML = imageHTML;
                document.getElementById('imageCollapsible').style.display = "block";
                document.getElementById('imageCollapsible').style.backgroundColor = "green";
            }
            if (contentHTML) {
                document.getElementById('contentRecommendations').innerHTML = contentHTML;
                document.getElementById('contentCollapsible').style.display = "block";
                document.getElementById('contentCollapsible').style.backgroundColor = "green";
            }

            if (url || keywords || resultsHTML || imageHTML || contentHTML) {
            } else {
                alert('No data found in cache.');
            }
        }

        function clearOnPageData() {
            document.getElementById("on-page-url").value = "";
            document.getElementById("keywords").value = "";
            document.getElementById("onPageResults").innerText = "";
            document.getElementById("imageRecommendations").innerText = "";
            document.getElementById("contentRecommendations").innerText = "";

            document.getElementById('onPageResultsCollapsible').style.display = "none";
            document.getElementById('onPageResultsCollapsible').style.backgroundColor = "#004c9d";

            document.getElementById('imageCollapsible').style.display = "none";
            document.getElementById('imageCollapsible').style.backgroundColor = "#004c9d";

            document.getElementById('contentCollapsible').style.display = "none";
            document.getElementById('contentCollapsible').style.backgroundColor = "#004c9d";

        }

        async function checkRanks() {
            document.getElementById('rankCheckerResultsTable').style.display = "none";
            document.getElementById('checkRanksButton').innerHTML = "Checking rankings...";
            const keywords = document.getElementById('rankCheckerKeywords').value.split('\n');
            domain = document.getElementById('rankCheckerDomain').value;
            const tableBody = document.getElementById('rankCheckerResultsTableBody');
            tableBody.innerHTML = ""; // Clear previous results
            const results = [];
            for (keyword of keywords) {
                const row = tableBody.insertRow();
                const rankCell = row.insertCell();
                const keywordCell = row.insertCell();

                rankCell.textContent = 'getting rank...';
                keywordCell.textContent = keyword;

                if (keyword.trim() !== "") { // Only make API call if keyword is not empty
                    results.push(fetchRank(keyword.trim(), row));
                } else {
                    rankCell.textContent = ''; // Clear "getting rank" for empty lines
                }
            }

            await Promise.all(results); // Wait for all API calls to complete
            document.getElementById('rankCheckerResultsTable').style.display = "block";
            document.getElementById('checkRanksButton').innerHTML = "Check Ranks";
        }

        async function fetchRank(keyword, row) {
            domain = document.getElementById('rankCheckerDomain').value;
            console.log(domain);
            const rankCell = row.cells[0];
            try {
                const response = await fetch('https://v5bizygr4m.execute-api.ap-southeast-1.amazonaws.com/rankChecker', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "keyword": keyword,
                        "language": document.getElementById('rankCheckerLanguage').value,
                        "location": document.getElementById('rankCheckerLocation').value,
                        "target": domain
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }

                data = await response.json();

                if (data == null) {
                    data = 999;
                }
                rankCell.textContent = data;
            } catch (error) {
                console.error("Error fetching rank:", error);
                rankCell.textContent = 'not available';
            }
        }

        function loadFromLocalStorage() {
            const inputs = document.querySelectorAll('input, textarea, select');

            inputs.forEach(input => {
                const key = input.id;
                if (key) {
                    try {
                        const storedValue = localStorage.getItem(key);
                        if (storedValue !== null) {
                            const parsedValue = JSON.parse(storedValue);

                            if (input.type === 'checkbox') {
                                input.checked = parsedValue;
                            } else if (input.tagName === 'SELECT') {
                                input.value = parsedValue;
                            } else {
                                input.value = parsedValue;
                            }
                        }
                    } catch (error) {
                        console.error(`Error loading or parsing value for ${key}:`, error);
                    }
                }
            });

            // Load generated content
            const contentIds = [
                'overall-summary',
                'keyword-analysis-results',
                'technicalSeo',
                'contentComparison',
                'schema',
                'onPageSection',
                'rankChecker',
                'socialMedia',
                'SEM',
                'competitors_content',
                'persona_content',
                'mediaplan',
                'content_check_content',
                'landingPageAudit',
                'onPageResults',
                'imageRecommendations',
                'contentRecommendations'
            ];

            contentIds.forEach(id => {
                const element = document.getElementById(id);
                const storedContent = localStorage.getItem(id);
                if (element && storedContent) {
                    element.innerHTML = storedContent;
                }
            });

            console.log('Page state loaded from localStorage');
        }

        function saveToLocalStorage() {
            // Get all input elements (including textareas, selects)
            const inputs = document.querySelectorAll('input, textarea, select');

            inputs.forEach(input => {
                const key = input.id; // Use the input's ID as the storage key

                if (key) { // Only save if the input has an ID
                    let value;

                    if (input.type === 'checkbox') {
                        value = input.checked; // Boolean for checkboxes
                    } else if (input.tagName === 'SELECT') {
                        value = input.value; // Selected option's value
                    } else {
                        value = input.value; // Text input, textarea value
                    }

                    localStorage.setItem(key, JSON.stringify(value)); // Convert value to string for storage
                }
            });

            // Get all generated content elements by ID
            const contentIds = [
                'overall-summary',
                'keyword-analysis-results',
                'technicalSeo',
                'contentComparison',
                'schema',
                'onPageSection',
                'rankChecker',
                'socialMedia',
                'SEM',
                'competitors_content',
                'persona_content',
                'mediaplan',
                'content_check_content',
                'landingPageAudit'
            ];

            contentIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    localStorage.setItem(id, element.innerHTML);
                }
            });

            console.log('Page state saved to localStorage');
        }

        setInterval(saveToLocalStorage, 5000); // Save every 5 seconds
        const seoNavItem = document.getElementById('seoNavItem');
        const smmNavItem = document.getElementById('smmNavItem');
        const othersNavItem = document.getElementById('othersNavItem'); //Add others item

        function toggleDropdown(navItem) {
            navItem.classList.toggle('show');
        }

        if (window.innerWidth <= 600) {
            seoNavItem.addEventListener('click', (event) => {
                event.preventDefault();
                toggleDropdown(seoNavItem);
            });

            smmNavItem.addEventListener('click', (event) => {
                event.preventDefault();
                toggleDropdown(smmNavItem);
            });

            othersNavItem.addEventListener('click', (event) => { //Add function for others nav item on mobile
                event.preventDefault();
                toggleDropdown(othersNavItem);
            });
        }

        function showLoadingModal() {
            document.getElementById('loadingModal').style.display = "block";
        }

        // Function to hide the loading modal
        function hideLoadingModal() {
            document.getElementById('loadingModal').style.display = "none";
        }


        function initializeJourneyCollapsibles() {
            var coll = document.getElementsByClassName("journey-collapsible");
            for (i = 0; i < coll.length; i++) {
                // Calculate and set initial progress
                const totalSteps = parseInt(coll[i].dataset.totalSteps);
                const completedSteps = parseInt(coll[i].dataset.completedSteps);
                const percentage = (completedSteps / totalSteps) * 100;

                const progressBar = coll[i].querySelector('.progress-bar');
                progressBar.style.width = `${percentage}%`;

                coll[i].addEventListener("click", function () {
                    this.classList.toggle("active");
                    var content = this.nextElementSibling;
                    if (content.style.display === "block") {
                        content.style.display = "none";
                    } else {
                        content.style.display = "block";
                    }
                });
            }
            // Close Modal Button
            const closeBtn = modal.querySelector('.journey-close');
            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                modal.remove()
            });
        }

        function openJourneyModal() {
            document.getElementById('journey-modal').style.display = "block";
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    document.getElementById('journey-modal').style.display = 'none';
                }
            });
            updateJourney();
        }

        function closeJourneyModal() {
            document.getElementById('journey-modal').style.display = "none";
        }

        function updateJourney() {
            done = 0;
            // similar keywords
            if (document.getElementById("keywordList").children.length > 0) {
                document.getElementsByClassName('step')[0].innerHTML = '<div class="step-number completed"><i class="fas fa-check"></i></div>';
                done += 1;
            }
            // ranking keywords or keywords based on webpage content
            if (document.getElementById("rankedKeywordList").children.length > 0 || document.getElementById("siteKeywords").children.length > 0) {
                document.getElementsByClassName('step')[1].innerHTML = '<div class="step-number completed"><i class="fas fa-check"></i></div>';
                done += 1
            }
            // time to rank
            if (document.getElementById("overall-summary").children.length > 0) {
                document.getElementsByClassName('step')[2].innerHTML = '<div class="step-number completed"><i class="fas fa-check"></i></div>';
                done += 1
            }
            // seo tech audit
            if (document.getElementById("auditSummary").children.length > 0) {
                document.getElementsByClassName('step')[3].innerHTML = '<div class="step-number completed"><i class="fas fa-check"></i></div>';
                done += 1
            }
            // content comparison
            if (document.getElementById("comparison-results").children.length > 0) {
                document.getElementsByClassName('step')[4].innerHTML = '<div class="step-number completed"><i class="fas fa-check"></i></div>';
                done += 1
            }
            // on-page
            if (document.getElementById("onPageResults").children.length > 0) {
                document.getElementsByClassName('step')[5].innerHTML = '<div class="step-number completed"><i class="fas fa-check"></i></div>';
                done += 1
            }
            // rank checker
            if (document.getElementById("rankCheckerResultsTable").rows.length > 1) {
                document.getElementsByClassName('step')[6].innerHTML = '<div class="step-number completed"><i class="fas fa-check"></i></div>';
                done += 1
            }
            document.getElementsByClassName('journey-collapsible')[0].dataset.completedSteps = String(done);
            var coll = document.getElementsByClassName("journey-collapsible");
            for (i = 0; i < coll.length; i++) {
                // Calculate and set initial progress
                const totalSteps = parseInt(coll[i].dataset.totalSteps);
                const completedSteps = parseInt(coll[i].dataset.completedSteps);
                const percentage = (completedSteps / totalSteps) * 100;

                const progressBar = coll[i].querySelector('.progress-bar');
                progressBar.style.width = `${percentage}%`;
            }

        }

        async function keywordDensity() {
            const url = document.getElementById('google-simulator-url').value;

            // Validation of URL (Basic example)
            try {
                new URL(url); // Try to parse the URL.  Throws an error if invalid
            } catch (error) {
                console.error("Invalid URL:", url);
                return { error: "Invalid URL provided." };
            }

            try {
                const response = await fetch('https://de0bccf9w7.execute-api.ap-southeast-1.amazonaws.com/keywordDensity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ target: url.trim() })
                });

                if (!response.ok) {
                    // Handle HTTP errors (e.g., 404, 500)
                    const errorMessage = await response.text(); // Or response.json() if the API returns a JSON error
                    throw new Error(`HTTP error! Status: ${response.status}, Message: ${errorMessage}`);
                }

                const data = await response.json();

                keywordDensityDiv = document.getElementById("keyword-density");
                let tableHTML = '<table>';

                // Create table headers (URLs)
                tableHTML += '<thead><tr><th onclick="sortDensityKeyword()">Keyword</th>';
                // Assuming 'urls' and 'responses' are defined elsewhere, and are related to multiple URLs.  Since we are only processing ONE URL at a time here, these need to be adjusted or removed.  For this example, I'm assuming it should use the current URL.  If not, you need to define/get the correct 'urls' array.
                const urls = [url]; // Use the current URL in an array for consistency with the original logic
                urls.forEach(url => {
                    tableHTML += `<th onclick="sortDensityTable('${url}')">${url}</th>`;
                });
                tableHTML += `<th>Add to Keyword Analysis</th></tr></thead><tbody>`; // Added the header for the new column.

                // Extract all unique keywords
                let allKeywords = new Set();
                // `data` is now a direct response for a single URL. No need to iterate through `data`.
                if (Array.isArray(data)) {
                    data.forEach(item => allKeywords.add(item.keyword));
                }
                allKeywords = Array.from(allKeywords);

                // Populate table rows with keyword data
                allKeywords.forEach(keyword => {
                    const rowId = `keywordRow-${keyword.replace(/\s+/g, '-')}`; // Create a unique ID for the row.

                    tableHTML += `<tr id="${rowId}" style="cursor:zoom-in;" onclick="highlightKeyword('${keyword}')"><td>${keyword}</td>`; // ADDED onclick HERE!
                    urls.forEach((url, urlIndex) => {
                        let frequency = 0;
                        // Check if the data for the URL is an array.  Again, since we are processing one URL at a time, it should always be an array, *or* contain an error object.
                        if (Array.isArray(data)) {
                            const keywordData = data.find(item => item.keyword === keyword);
                            frequency = keywordData ? keywordData.frequency : 0;
                        } else if (typeof data === 'object' && data !== null && data.error) {
                            frequency = data.error;
                        } else {
                            frequency = "N/A"; // Handle unexpected response
                        }

                        tableHTML += `<td>${frequency}</td>`;
                    });
                    // Add the new column with the plus icon and the click handler. The data-keyword is essential.
                    tableHTML += `<td><a href="#" class="add-keyword-button" data-keyword="${keyword}" onclick="addKeywordToAnalysis(event, this)"><i class="fas fa-plus-circle"></i></a></td></tr>`;
                });

                tableHTML += '</tbody></table>';
                keywordDensityDiv.innerHTML = tableHTML;


            } catch (error) {
                console.error(`Error fetching data for ${url.trim()}:`, error);

            }
        }

        function addKeywordToAnalysis(event, element) { // Modify function to get event and element
            event.preventDefault(); // Prevent page from jumping to top
            const keyword = element.dataset.keyword; // Get the keyword from the data attribute
            const keywordsTextArea = document.getElementById('keywords');
            let currentKeywords = keywordsTextArea.value.trim();
            let keywordsArray = currentKeywords.split(',').map(k => k.trim()); // Split, trim, and create an array
            if (!keywordsArray.includes(keyword)) { // Check if the keyword already exists
                if (currentKeywords === "") {
                    keywordsTextArea.value = keyword;
                } else {
                    keywordsTextArea.value = currentKeywords + ", " + keyword;
                }

                // Change the link to display "Added"
                element.innerHTML = "Added";
                element.classList.remove("add-keyword-button")

            }
            updateKeywordCount(); //update the keyword count paragraph
        }

        function sortDensityTable(url) {
            // Get the table element
            var table = document.querySelector("#keyword-density table"); // Corrected selector
            if (!table) {
                return; // Table doesn't exist
            }

            // Get the index of the URL column to be sorted by
            var headerRow = table.rows[0];
            var columnIndex = -1;
            for (var i = 1; i < headerRow.cells.length; i++) {
                if (headerRow.cells[i].textContent === url) {
                    columnIndex = i;
                    break;
                }
            }

            if (columnIndex === -1) {
                return; // URL not found
            }

            // Get the table rows (excluding the header row)
            var rows = Array.from(table.rows).slice(1); // Convert to array for easier sorting

            // Sort the rows based on the frequency in the specified column
            rows.sort(function (row1, row2) {
                var frequency1 = row1.cells[columnIndex].textContent;
                var frequency2 = row2.cells[columnIndex].textContent;

                // Handle error responses
                if (frequency1 === "N/A") {
                    return -1;
                }
                if (frequency2 === "N/A") {
                    return 1;
                }

                return frequency2 - frequency1;
            });

            // Re-append the sorted rows to the table
            rows.forEach(row => table.appendChild(row));
        }

        function sortDensityKeyword() {
            var table = document.querySelector("#keyword-density table"); // Corrected selector
            if (!table) {
                return;
            }

            var rows = Array.from(table.rows).slice(1);

            rows.sort(function (row1, row2) {
                var keyword1 = row1.cells[0].textContent.toLowerCase();
                var keyword2 = row2.cells[0].textContent.toLowerCase();

                if (keyword1 < keyword2) {
                    return -1;
                }
                if (keyword1 > keyword2) {
                    return 1;
                }
                return 0;
            });

            rows.forEach(row => table.appendChild(row));
        }

        async function googleCrawlerSimulator() {
            const url = document.getElementById('google-simulator-url').value;
            if (!url) {
                alert("Please enter a URL.");
                return;
            }

            document.getElementById('simulatorError').innerText = "";
            document.getElementById('simulatorError').display = 'none';
            document.getElementById('simulatorBtn').innerText = "Loading..";
            document.getElementById('simulatorButton').style.backgroundColor = "004c9d";
            document.getElementById("crawler-simulator-results").style.display = "none";

            try {
                // Extract domain
                let domain;
                try {
                    const urlObj = new URL(url);
                    domain = urlObj.origin;
                } catch (e) {
                    console.error("Invalid URL:", url, e);
                    return;
                }

                // Function to handle successful results and display them
                const handleResult = (result, displayFunction, elementId) => {
                    try {
                        if (displayFunction) {
                            displayFunction(result);
                        } else if (elementId) {
                            document.getElementById(elementId).innerText = result;
                        }
                    } catch (e) {
                        console.error("Error displaying result:", e);
                        document.getElementById('simulatorError').innerText = "Error displaying result: " + e;
                        document.getElementById('simulatorError').style.display = 'block';
                    }
                };

                // Function to handle errors from each promise
                const handleError = (error, functionName) => {
                    console.error(`Error in ${functionName}:`, error);
                    document.getElementById('simulatorError').innerText = `Error in ${functionName}: ` + error;
                    document.getElementById('simulatorError').style.display = 'block';
                };

                // Fetch HTML content  - needs special handling due to displayResults
                const htmlPromise = fetch('https://abrhhnjp4m.execute-api.ap-southeast-1.amazonaws.com/getHtml', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url
                    })
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error fetching HTML! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(htmlData => {
                        return displaySimulatorResults(htmlData.body);  // displayResults *returns* a promise or void
                    })
                    .catch(error => handleError(error, 'fetchHtml'));

                // Call keywordDensity simultaneously
                const keywordDensityPromise = keywordDensity();

                // Optionally, keep track of all promises to ensure they all complete
                Promise.all([
                    htmlPromise,
                    keywordDensityPromise
                ]).then(() => {
                    document.getElementById('simulatorBtn').innerText = "Analyse";
                }).catch(error => {
                    console.error('Error in Promise.all:', error);
                    document.getElementById('simulatorBtn').innerText = "Analyse";
                });


            } catch (error) {
                console.error('General Error:', error);
                document.getElementById('simulatorBtn').innerText = "Analyse";
            }
        }

        async function displaySimulatorResults(html) {
            return new Promise((resolve, reject) => {
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // Meta Information
                    document.getElementById('simulator-meta-title').innerText = doc.querySelector('meta[name="title"]') ? doc
                        .querySelector('meta[name="title"]').content : doc.title;
                    document.getElementById('simulator-meta-description').innerText = doc.querySelector('meta[name="description"]') ?
                        doc.querySelector('meta[name="description"]').content : "";
                    document.getElementById('simulator-canonical-tag').innerText = doc.querySelector('link[rel="canonical"]') ? doc
                        .querySelector('link[rel="canonical"]').href : "";


                    // Headers (H1-H6)
                    const headers = doc.querySelectorAll('h1, h2, h3, h4, h5, h6');
                    const headersBody = document.getElementById('simulator-headers-body');
                    const indentation = {
                        'H1': 0,
                        'H2': 1,
                        'H3': 2,
                        'H4': 3,
                        'H5': 4,
                        'H6': 5
                    };

                    const headerColors = { // Define colors for each header level.  Adjust these!
                        'H1': 'lightgreen',
                        'H2': 'lightblue',
                        'H3': 'lightyellow',
                        'H4': 'lightcoral',
                        'H5': 'lightcyan',
                        'H6': 'lightpink'
                    };

                    headers.forEach(header => {
                        let row = headersBody.insertRow();
                        let cell = row.insertCell();
                        // Remove whitespace and newlines
                        const headerText = header.innerText.trim().replace(/\s+/g, ' ');
                        const indentLevel = indentation[header.tagName];
                        const indent = ''.repeat(indentLevel * 4); // Adjust the number for desired indentation
                        const headerTag = header.tagName;
                        cell.innerHTML = `<span class="header-text">${indent}${headerTag}: ${headerText}</span>`;

                        // Apply background color based on header type
                        if (headerColors[headerTag]) {  // Check if a color is defined for this tag.
                            cell.style.backgroundColor = headerColors[headerTag];
                        }
                    });


                    // Links (Internal and External)
                    const links = doc.querySelectorAll('a[href]');
                    const linksBody = document.getElementById('simulator-links-body');
                    const existingLinks = new Set();

                    const linkPromises = [];

                    domain = 'https://' + document.getElementById('google-simulator-url').value.replace('http://', '').replace('https://', '').split('/')[0] + '/';

                    links.forEach(async link => {
                        href = link.href;
                        href = href.replace('http://127.0.0.1:5500/', domain).replace('https://app.digimetrics.ai/', domain);
                        const linkText = link.innerText.trim(); // Extract link text and trim whitespace


                        if (existingLinks.has(href)) {
                            return;
                        }

                        existingLinks.add(href);

                        let linkType = 'External';
                        try {
                            const url = new URL(href.replace('http://127.0.0.1:5500/', domain).replace('https://app.digimetrics.ai/', domain));
                            const currentUrl = new URL(document.getElementById('google-simulator-url').value);
                            if (url.hostname === currentUrl.hostname) {
                                linkType = 'Internal';
                            }
                        } catch (e) {
                            linkType = 'Internal';
                        }

                        let row = linksBody.insertRow();
                        let typeCell = row.insertCell();
                        let urlCell = row.insertCell();
                        let linkTextCell = row.insertCell(); // Add cell for link text

                        typeCell.innerText = linkType;

                        // Apply background color based on link type
                        if (linkType === 'Internal') {
                            typeCell.style.backgroundColor = 'lightblue';
                        } else {
                            typeCell.style.backgroundColor = 'lightcoral';
                        }


                        urlCell.innerHTML = `<a href="${href}" target="_blank" rel="noopener noreferrer">${href}</a>`;
                        linkTextCell.innerText = linkText; // Set the link text
                    });

                    internalLinks = [];

                    existingLinks.forEach(link => {
                        if (!link.includes("tel:") & !link.includes("mailto:")) {
                            if (link.includes('127.0.0.1:5500')) {
                                link = link.replace('http://127.0.0.1:5500/', domain).replace('https://app.digimetrics.ai/', domain);
                            }
                            internalLinks.push(link);
                        }
                    })


                    // Main function execution
                    /*
                    let initialResponse;
        
                    sendInitialRequest(document.getElementById('google-simulator-url').value, internalLinks)
                        .then(response => {
                            initialResponse = response;
        
                            console.log(document.getElementById('google-simulator-url').value);
                            console.log(initialResponse);
        
                            pollForResults(document.getElementById('google-simulator-url').value, initialResponse);
                        })
                        .catch(error => {
                            console.error("Error during initial request:", error);
                            reject(error); // Reject the promise if the initial request fails.  Crucial.
                            return; // Exit the function to prevent further execution if the initial request fails.
                        });
                    */


                    const clonedBody = doc.body.cloneNode(true);

                    // Remove script tags
                    const scripts = clonedBody.querySelectorAll('script');
                    scripts.forEach(script => script.remove());

                    // Remove style tags
                    const styles = clonedBody.querySelectorAll('style');
                    styles.forEach(style => style.remove());

                    // Remove select elements
                    const selects = clonedBody.querySelectorAll('select');
                    selects.forEach(select => select.remove());

                    try {
                        const customDropdown = clonedBody.querySelector('ul[role="listbox"]').parentNode;
                        if (customDropdown) {
                        } customDropdown.remove();
                    } catch (error) {

                    }

                    // Now get the innerText
                    const visibleText = clonedBody.innerText;
                    //const allPageText = doc.body.innerText || "";  // Extract text from the simulated document
                    document.getElementById("simulatorPageText").textContent = visibleText;

                    // Image Alt Text
                    const images = doc.querySelectorAll('img');
                    const imageAltBody = document.getElementById('simulator-image-alt-body');
                    const imageSizePromises = []; // Array to hold all the image size promises

                    images.forEach(image => {
                        const imageUrl = image.src.replace('http://127.0.0.1:5500/', domain).replace('https://app.digimetrics.ai/', domain);
                        imageSizePromises.push(
                            retryGetImageSize(imageUrl) // Use the retry function here
                                .then(sizeData => {
                                    let row = imageAltBody.insertRow();
                                    let thumbCell = row.insertCell();
                                    let urlCell = row.insertCell();
                                    let titleCell = row.insertCell();
                                    let altCell = row.insertCell();
                                    let sizeCell = row.insertCell(); // New cell for image size

                                    thumbCell.innerHTML = `<img src="${imageUrl}" alt="Thumbnail" class="thumbnail">`;
                                    urlCell.innerText = imageUrl;
                                    titleCell.innerText = image.title || "(No Title)"; // Show "(No Title)" if title is empty
                                    altCell.innerText = image.alt || "(No Alt Text)";
                                    sizeCell.innerText = sizeData || "Size Unavailable"; // Display image size

                                    // Highlight altCell if no alt text is present
                                    if (!image.alt) {
                                        altCell.style.backgroundColor = 'lightcoral';
                                    }
                                })
                                .catch(error => {
                                    console.error(`Failed to get size for ${imageUrl}: ${error}`);
                                    let row = imageAltBody.insertRow();
                                    let thumbCell = row.insertCell();
                                    let urlCell = row.insertCell();
                                    let titleCell = row.insertCell();
                                    let altCell = row.insertCell();
                                    let sizeCell = row.insertCell(); // New cell for image size

                                    thumbCell.innerHTML = `<img src="${imageUrl}" alt="Thumbnail" class="thumbnail">`;
                                    urlCell.innerText = imageUrl;
                                    titleCell.innerText = image.title || "(No Title)"; // Show "(No Title)" if title is empty
                                    altCell.innerText = image.alt || "(No Alt Text)";
                                    sizeCell.innerText = "Size Unavailable"; // Indicate size is unavailable

                                    // Highlight altCell if no alt text is present
                                    if (!image.alt) {
                                        altCell.style.backgroundColor = 'lightcoral';
                                    }
                                })
                        );
                    });

                    // Wait for all image size fetches and status code fetches to complete.
                    Promise.all([...imageSizePromises, ...linkPromises])
                        .then(() => {
                            document.getElementById("crawler-simulator-results").style.display = "block";
                            document.getElementById('simulatorButton').style.backgroundColor = "green";
                            resolve();
                        })
                        .catch(error => {
                            console.error("Error in displayResults", error);
                            reject(error);
                        });

                } catch (error) {
                    console.error("Error in displayResults", error);
                    reject(error);
                }
            });

        }

        async function retryGetImageSize(imageUrl, retries = 1) {
            try {
                return await getImageSize(imageUrl);
            } catch (error) {
                if (retries > 0) {
                    console.log(`Retrying getImageSize for ${imageUrl}, ${retries} retries remaining`);
                    await new Promise(resolve => setTimeout(resolve, 3000)); // Wait 1 second before retrying
                    return retryGetImageSize(imageUrl, retries - 1); // Decrement retries
                } else {
                    throw error; // If no retries left, throw the error
                }
            }
        }

        async function getImageSize(url) {
            const endpoint = "https://ftz64xiuh3.execute-api.ap-southeast-1.amazonaws.com/getImageSize";
            try {
                const response = await fetch(endpoint, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        url: url
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Initial request error:", error);
                throw error;
            }
        }

        async function sendInitialRequest(domain, urls) {
            const endpoint = "https://n0ge4xdang.execute-api.ap-southeast-1.amazonaws.com/getStatusCode";
            try {
                const response = await fetch(endpoint, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        domain: domain,
                        target_urls: urls,
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Initial request error:", error);
                throw error;
            }
        }


        async function pollForResults(domain, taskId) {
            const endpoint = "https://n0ge4xdang.execute-api.ap-southeast-1.amazonaws.com/getStatusCode";
            let intervalId;

            return new Promise((resolve, reject) => {
                intervalId = setInterval(async () => {
                    try {
                        const response = await fetch(endpoint, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                domain: domain,
                                task_id: taskId,
                            }),
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();

                        console.log(data);

                        if (data.remaining === 0) {
                            clearInterval(intervalId);
                            // Process results and resolve the promise
                            const results = {};
                            for (const page_to in data.results) {
                                results[domain + page_to['page_to']] = page_to["page_to_status_code"];
                            }
                            console.log(results);
                            resolve(results); // Resolve with the results
                        } else {
                            console.log(`Remaining: ${data.remaining}, Task ID: ${taskId}`);
                        }
                    } catch (error) {
                        clearInterval(intervalId);
                        console.error("Polling error:", error);
                        reject(error); // Reject the promise if there's an error
                    }
                }, 10000); // Poll every 10 seconds

                // Set initial delay to 10 seconds as requested
                setTimeout(() => {
                    // Do nothing - the interval will start after 10 seconds
                }, 10000);
            });
        }


        async function exportToPdf() {
            window.jsPDF = window.jspdf.jsPDF;
            // First, expand all collapsibles
            const collapsibles = document.querySelectorAll('.collapsible');
            collapsibles.forEach(collapsible => {
                collapsible.classList.add('active');
                collapsible.nextElementSibling.style.display = 'block';

                const icon = collapsible.querySelector('i');
                if (icon && icon.classList.contains('fa-plus-square')) {
                    icon.classList.remove('fa-plus-square');
                    icon.classList.add('fa-minus-square');
                }
            });

            // Get all journey collapsibles too
            const journeyCollapsibles = document.querySelectorAll('.journey-collapsible');
            journeyCollapsibles.forEach(collapsible => {
                collapsible.classList.add('active');
                collapsible.nextElementSibling.style.display = 'block';
                const totalSteps = parseInt(collapsible.dataset.totalSteps);
                const completedSteps = parseInt(collapsible.dataset.completedSteps);
                const percentage = (completedSteps / totalSteps) * 100;

                const progressBar = collapsible.querySelector('.progress-bar');
                progressBar.style.width = `${percentage}%`;
            });

            window.print();
        }

        function removeHighlights() {
            targeted_sections = ["simulatorPageText", "meta-table", "keyword-density", "headers-table", "links-table", "image-alt-table"];

            targeted_sections.forEach(sectionId => {
                const element = document.getElementById(sectionId);
                const highlighted = document.querySelectorAll('.highlight');
                highlighted.forEach(el => {
                    el.outerHTML = el.innerHTML; // Replace highlighted spans with their content
                });

            })
        }

        function highlightKeyword(keyword) {
            targeted_sections = ["simulatorPageText", "meta-table", "keyword-density", "headers-table", "links-table", "image-alt-table"];

            removeHighlights();

            targeted_sections.forEach(sectionId => {
                const element = document.getElementById(sectionId);

                if (element) {
                    if (!keyword) return; // If no keyword, do nothing

                    function highlightText(node, keyword) {
                        if (node.nodeType === Node.TEXT_NODE) {
                            const text = node.nodeValue;

                            // Create the flexible regex
                            const safeKeyword = keyword.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'); // Escape special characters in keyword for regex
                            const regexPattern = `(${safeKeyword.replace(/\s+/g, '[\\s-]*')})`;  // Replace spaces with flexible whitespace/hyphen
                            const regex = new RegExp(regexPattern, 'gi');

                            if (regex.test(text)) {
                                const newHtml = text.replace(regex, '<span class="highlight">$1</span>');
                                const tempElement = document.createElement('span');
                                tempElement.innerHTML = newHtml;

                                let nextSibling = node.nextSibling;
                                while (tempElement.firstChild) {
                                    node.parentNode.insertBefore(tempElement.firstChild, nextSibling);
                                }

                                node.remove();
                            }
                        } else if (node.nodeType === Node.ELEMENT_NODE) {
                            // Recursively process child nodes of element nodes
                            for (let i = 0; i < node.childNodes.length; i++) {
                                highlightText(node.childNodes[i], keyword);
                            }
                        }
                    }

                    // Start the recursive highlighting process from the root element
                    highlightText(element, keyword);

                } else {
                    console.warn(`Element with ID "${sectionId}" not found. Skipping.`);
                }
            });
        }

        let listCounter = 1;
        let deletedLists = []; // Store an array of deleted lists for multiple undo

        const undoBtn = document.getElementById('undoBtn');
        undoBtn.addEventListener('click', undoDelete);

        document.getElementById('addListBtn').addEventListener('click', addNewList);

        // No longer using a hardcoded mapping
        let keywordMapping = {};

        const listsContainer = document.getElementById('listsContainer');

        async function mapKeywords() {
            collapsible = document.getElementById('keyword_mapping')
            collapsible.classList.add('active');
            collapsible.nextElementSibling.style.display = 'block';
            const domain = document.getElementById('domain').value; // Get domain
            const location = document.getElementById('location').value;
            const language = document.getElementById('language').value;
            const keywordsInput = document.getElementById('keywords').value;

            console.log(keywordsInput);

            mapKeywordsBtn.innerText = "Mapping...";

            const keywords = keywordsInput.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);

            // Clear the existing mapping
            keywordMapping = {};
            clearAllLists(); //remove all the lists
            listCounter = 1; //restart the list counter


            // Create an array to hold the promises for each fetch request
            const fetchPromises = keywords.map(keyword => {
                return fetch('https://6s7ijwwsa8.execute-api.ap-southeast-1.amazonaws.com/dragDrop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        domain: domain,
                        keyword: keyword,
                        language: language,
                        location: location,
                    })
                }).then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                }).then(data => {
                    data = data.replace(domain, '').replace('http://', '').replace('www.', '').replace('https://', '');
                    // Use the API response URL as the key in your mapping
                    if (data) {
                        if (!keywordMapping[data]) {
                            keywordMapping[data] = [];
                        }
                        keywordMapping[data].push(keyword); // Map keyword to URL
                    } else {
                        console.warn(`API response missing URL for keyword: ${keyword}`);
                    }
                })
                    .catch(error => {
                        console.error(`Error for keyword "${keyword}":`, error);
                    });
            });

            try {
                // Wait for all promises to resolve before populating the lists
                await Promise.all(fetchPromises);

                // Now populate the lists based on the built-up keywordMapping
                populateListsFromMapping();
                mapKeywordsBtn.innerText = "Map Keywords";
            } catch (error) {
                console.error("An error occurred during the fetch requests:", error);
                mapKeywordsBtn.innerText = "Map Keywords";
            }
        }

        function createListContainer(url) {
            const listContainer = document.createElement('div');
            listContainer.classList.add('list-container');

            const renameInput = document.createElement('input');
            renameInput.type = 'text';
            renameInput.classList.add('rename-input');
            renameInput.value = url;

            // Add event listener for renameList
            renameInput.addEventListener('blur', function () {
                renameList(this);
            });

            const deleteButton = document.createElement('button');
            deleteButton.classList.add('delete-list-btn');
            deleteButton.textContent = 'X';
            deleteButton.addEventListener('click', function () {
                deleteList(this);
            });


            const listId = 'list' + listCounter;
            const list = document.createElement('ul');
            list.id = listId;
            list.classList.add('keyword-list');
            list.addEventListener('drop', drop);
            list.addEventListener('dragover', allowDrop);

            listContainer.appendChild(renameInput);
            listContainer.appendChild(deleteButton);
            listContainer.appendChild(list);

            // Add the "Page Recommendations" button
            const recommendationsButton = document.createElement('button');
            recommendationsButton.style.margin = "5px auto";
            recommendationsButton.style.display = "block";
            domain = document.getElementById('domain').value;
            recommendationsButton.textContent = 'Page Recommendations';
            recommendationsButton.addEventListener('click', function () {
                // Disable the button
                this.disabled = true;
                this.classList.add('disabled');

                // Get the URL from the input field *inside* this function
                const currentURL = domain + renameInput.value;

                console.log(currentURL);

                // Get the list items and put them into an array
                const listItems = Array.from(list.children).map(item => item.textContent.trim());

                getPageRecommendations(currentURL, listItems, this); // Pass the button element
            });
            listContainer.appendChild(recommendationsButton);
            return { listContainer, list, renameInput };
        }

        function createKeywordListItem(keyword) {
            const listItem = document.createElement('li');
            listItem.draggable = true;
            listItem.addEventListener('dragstart', drag);
            listItem.id = keyword;
            listItem.textContent = keyword; // Display keyword
            return listItem;
        }

        function populateListsFromMapping() {
            for (const url in keywordMapping) {
                if (keywordMapping.hasOwnProperty(url)) {
                    const { listContainer, list, renameInput } = createListContainer(url);

                    keywordMapping[url].forEach(keyword => {
                        const listItem = createKeywordListItem(keyword);
                        list.appendChild(listItem);
                    });

                    listsContainer.appendChild(listContainer);
                    listCounter++;
                }
            }
        }

        function clearAllLists() {
            while (listsContainer.firstChild) {
                listsContainer.removeChild(listsContainer.firstChild);
            }
        }



        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }

        const MAX_ITEMS_PER_LIST = 20; // Set the maximum limit
        const HEIGHT_PER_KEYWORD = 6; // Additional increase per keyword.



        function drop(ev) {
            ev.preventDefault();
            const target = ev.target;

            if (target.classList.contains('keyword-list')) {
                target.classList.remove('drag-over'); // Always remove the drag-over class

                // Check if the list is full again before dropping (safety check)
                if (target.children.length < MAX_ITEMS_PER_LIST) {
                    var data = ev.dataTransfer.getData("text");
                    var draggedElement = document.getElementById(data);
                    target.appendChild(draggedElement);

                    // Increase the height of the list
                    const currentHeight = parseInt(window.getComputedStyle(target).minHeight);
                    const numberOfKeywords = target.children.length;
                    const heightIncrease = (numberOfKeywords * HEIGHT_PER_KEYWORD);
                    target.style.minHeight = (currentHeight + heightIncrease) + 'px';

                    target.classList.remove('list-full'); // remove the list-full class if there are items to drop
                } else {
                    //Optional: Prevent the drop from occurring
                    //You can optionally add additional error handling here
                    target.classList.remove('list-full');
                    return;
                }

            } else {
                target.classList.remove('drag-over');
                target.classList.remove('list-full'); //also, prevent adding css if element does not have the correct class
            }
        }

        function addNewList() {
            const listsContainer = document.getElementById('listsContainer');

            const listContainer = document.createElement('div');
            listContainer.classList.add('list-container');

            const listId = 'list' + listCounter;
            const defaultName = '/url-' + listCounter;

            const renameInput = document.createElement('input');
            renameInput.type = 'text';
            renameInput.classList.add('rename-input');
            renameInput.value = defaultName;

            // Add event listener for renameList
            renameInput.addEventListener('blur', function () {
                renameList(this);
            });


            const deleteButton = document.createElement('button');
            deleteButton.classList.add('delete-list-btn');
            deleteButton.textContent = 'X';
            deleteButton.addEventListener('click', function () {
                deleteList(this);
            });

            const list = document.createElement('ul');
            list.id = listId;
            list.classList.add('keyword-list');
            list.addEventListener('drop', drop);
            list.addEventListener('dragover', allowDrop);

            listContainer.appendChild(renameInput);
            listContainer.appendChild(deleteButton);
            listContainer.appendChild(list);

            // Add the "Page Recommendations" button
            const recommendationsButton = document.createElement('button');
            recommendationsButton.textContent = 'Page Recommendations';
            recommendationsButton.addEventListener('click', function () {
                // Disable the button
                this.disabled = true;
                this.classList.add('disabled');

                const url = renameInput.value; //get the url value

                // Get the list items and put them into an array
                const listItems = Array.from(list.children).map(item => item.textContent.trim());

                console.log(listItems);

                getPageRecommendations(url, listItems, this); // Pass both URL and the array of list items and the button element
            });
            listContainer.appendChild(recommendationsButton);

            listsContainer.appendChild(listContainer);

            listCounter++;
        }

        function renameList(inputElement) {
            // No longer need to update a separate H2. The input itself IS the name.
        }

        function deleteList(deleteButton) {
            const listContainer = deleteButton.parentNode;
            const listsContainer = document.getElementById('listsContainer');

            // Store the deleted list details for undo
            deletedLists.push({
                element: listContainer,
                nextSibling: listContainer.nextSibling,
                listsContainer: listsContainer
            });

            listsContainer.removeChild(listContainer);

            // Enable the undo button if there are no more deleted lists
            undoBtn.disabled = deletedLists.length === 0;
        }

        function undoDelete() {
            if (deletedLists.length > 0) {
                const lastDeleted = deletedLists.pop(); // Get the last deleted list

                // Re-insert the deleted list
                if (lastDeleted.nextSibling) {
                    lastDeleted.listsContainer.insertBefore(lastDeleted.element, lastDeleted.nextSibling);
                } else {
                    lastDeleted.listsContainer.appendChild(lastDeleted.element);
                }

                // Disable the undo button if there are no more deleted lists
                undoBtn.disabled = deletedLists.length === 0;
            }
        }

        async function getPageRecommendations(url, listElement, button) {
            const recommendationEndpoint = 'https://pkkz2e02ch.execute-api.ap-southeast-1.amazonaws.com/onPageContentRecommendations';

            try {
                const recommendationResponse = await fetch(recommendationEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url,
                        "keywords": listElement
                    })
                });

                recommendationData = await recommendationResponse.json();

                // Create collapsible structure
                const collapsibleButton = document.createElement('button');
                collapsibleButton.classList.add('collapsible50');
                collapsibleButton.textContent = `${url}`;

                const contentDiv = document.createElement('div');
                contentDiv.classList.add('content');

                // Check if the response is a list of dictionaries
                if (Array.isArray(recommendationData) && recommendationData.length > 0 && typeof recommendationData[0] === 'object') {
                    // Create a table
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';

                    // Create table header
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    const headers = Object.keys(recommendationData[0]);

                    headers.forEach(headerText => {
                        const th = document.createElement('th');
                        th.textContent = headerText;
                        th.style.border = '1px solid #ddd';
                        th.style.padding = '8px';
                        th.style.textAlign = 'left';
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);


                    // Create table body
                    const tbody = document.createElement('tbody');
                    recommendationData.forEach(item => {
                        const row = document.createElement('tr');
                        headers.forEach(header => {
                            const cell = document.createElement('td');
                            cell.textContent = item[header];
                            cell.style.border = '1px solid #ddd';
                            cell.style.padding = '8px';
                            row.appendChild(cell);
                        });
                        tbody.appendChild(row);
                    });
                    table.appendChild(tbody);

                    contentDiv.innerHTML += '<h3>Content Optimisation</h3>';

                    contentDiv.appendChild(table); // Append the table to the content div

                    endpoint = 'https://udjdc333m9.execute-api.ap-southeast-1.amazonaws.com/getImages';

                    response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            url: url,
                            keywords: listElement // Send keywords to the backend
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    data = await response.json();

                    console.log(data);

                    const recommendationEndpoint = 'https://vwmqqj251d.execute-api.ap-southeast-1.amazonaws.com/onPageRecommendations';

                    const recommendationResponse = await fetch(recommendationEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            "data": data,
                            "keywords": listElement
                        })
                    });

                    if (!recommendationResponse.ok) {
                        throw new Error(`HTTP error! status: ${recommendationResponse.status}`);
                    }

                    recommendationData = await recommendationResponse.json();

                    data = recommendationData;
                    let resultsHTML = '';

                    let metaTableHTML = `<h3>Meta and Headings</h3>
        <table id="metaTable">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Current Value</th>
                    <th>Suggested Change</th>
                    <th>Rationale</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Meta Title</td>
                    <td>${data.meta_title.current_value}</td>
                    <td><textarea>${data.meta_title.suggested_value}</textarea></td>
                    <td>${data.meta_title.rationale}</td>
                </tr>
                <tr>
                    <td>Meta Description</td>
                    <td>${data.meta_description.current_value}</td>
                    <td><textarea>${data.meta_description.suggested_value}</textarea></td>
                    <td>${data.meta_description.rationale}</td>
                </tr>
                <tr>
                    <td>Canonical URL</td>
                    <td>${data.canonical_url.current_value}</td>
                    <td><textarea>${data.canonical_url.suggested_value}</textarea></td>
                    <td>${data.canonical_url.rationale}</td>
                </tr>`;

                    // Function to add heading rows
                    function addHeadingRows(headingType, headings) {
                        headings.forEach(heading => {
                            metaTableHTML += `
                <tr>
                    <td>${headingType}</td>
                    <td>${heading.current_value}</td>
                    <td><textarea>${heading.suggested_value}</textarea></td>
                    <td>${heading.rationale}</td>
                </tr>
            `;
                        });
                    }

                    addHeadingRows("H1 Heading", data.headings.h1);
                    addHeadingRows("H2 Heading", data.headings.h2);
                    addHeadingRows("H3 Heading", data.headings.h3);
                    addHeadingRows("H4 Heading", data.headings.h4);

                    metaTableHTML += `

            </tbody>
        </table>
    `;

                    let imageTableHTML = `<h3>Image Title and Alt Text</h3>
            <table id="imageTable">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Image URL <button class="copy-button" onclick="copyColumn(1, 'imageTable')">Copy</button></th>
                        <th>Image Preview</th>
                        <th>Alt Text <button class="copy-button" onclick="copyColumn(3, 'imageTable')">Copy</button></th>
                        <th>Suggested Alt Text</th>
                        <th>Rationale</th>
                    </tr>
                </thead>
                <tbody>
        `;

                    let i = 0;
                    for (const imageData of data.image_data) {
                        const imageUrl = Object.keys(imageData)[0];
                        const imageDetails = imageData[imageUrl];

                        imageTableHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td><a href="${imageUrl}" target="_blank">${imageUrl}</a></td>
                    <td><img src="${imageUrl}" alt="${imageDetails.current_value}"></td>
                    <td>${imageDetails.current_value}</td>
                    <td><textarea>${imageDetails.suggested_value}</textarea></td>
                    <td>${imageDetails.rationale}</td>
                </tr>
            `;
                        i++;
                    }


                    imageTableHTML += `
                </tbody>
            </table>
        `;

                    resultsHTML += metaTableHTML;

                    // Add export button after image table
                    resultsHTML += '<button class="export-button" onclick="exportOnPageToCSV()">Export to CSV</button>';

                    contentDiv.innerHTML += resultsHTML;
                    contentDiv.innerHTML += imageTableHTML;

                } else {
                    // If it's not a list of dictionaries, just set the innerHTML
                    contentDiv.innerHTML = recommendationData;
                }


                // Append elements to the recommendations div
                const recommendationsDiv = document.getElementById('recommendations');
                recommendationsDiv.appendChild(collapsibleButton);
                recommendationsDiv.appendChild(contentDiv);

                // Add event listener for collapsible functionality
                collapsibleButton.addEventListener('click', function () {
                    this.classList.toggle('active');
                    const content = this.nextElementSibling;
                    if (content.style.display === 'block') {
                        content.style.display = 'none';
                    } else {
                        content.style.display = 'block';
                    }
                });

                console.log(recommendationData); // Now logs the parsed JSON data

            } catch (error) {
                console.error("Error fetching recommendations:", error);
            } finally {
                // Re-enable the button in the finally block to ensure it always happens
                button.disabled = false;
                button.classList.remove('disabled');
            }
        }

        async function generateHumanReply() {
            const commentInput = document.getElementById('smm-comment-input');
            const instructionInput = document.getElementById('smm-instructions-input');
            const replyDisplay = document.getElementById('smm-reply-display');
            const submitBtn = document.getElementById('generateSmmReplyBtn');

            // NEW: read optional form fields
            const sensitivityEl = document.getElementById('sensitivity');
            const responseObjectiveEl = document.getElementById('response_objective');
            const responsePlatformEl = document.getElementById('response_platform');

            const commentText = commentInput.value.trim();
            const instructionText = instructionInput.value.trim();

            // NEW: optional values (safe even if fields are missing)
            const sensitivity = sensitivityEl ? sensitivityEl.value : "";
            const response_objective = responseObjectiveEl ? responseObjectiveEl.value : "";
            const response_platform = responsePlatformEl ? responsePlatformEl.value : "";

            if (!commentText) {
                alert("Please paste a comment to generate a reply.");
                return;
            }

            submitBtn.innerText = "Drafting Reply...";
            submitBtn.disabled = true;
            replyDisplay.style.display = "none";
            replyDisplay.innerHTML = "";

            try {
                const response = await fetch('https://5m2upu2fxf.execute-api.ap-southeast-1.amazonaws.com/communityEngagement', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: commentText,
                        instruction: instructionText,

                        // NEW: include structured fields
                        sensitivity: sensitivity,
                        response_objective: response_objective,
                        response_platform: response_platform
                    })
                });

                if (!response.ok) throw new Error(`Server error: ${response.statusText}`);

                const data = await response.json();
                replyDisplay.innerText = data.answer;
                replyDisplay.style.display = "block";
                document.getElementById("smmReplyButton").style.backgroundColor = "green";

            } catch (error) {
                console.error("Error generating reply:", error);
                replyDisplay.style.display = "block";
                replyDisplay.innerText = "Sorry, I couldn't generate a reply at this moment. Please check your connection and try again.";
                replyDisplay.style.color = "red";
            } finally {
                submitBtn.innerText = "Generate Reply";
                submitBtn.disabled = false;
            }
        }


        function allowDrop(ev) {
            ev.preventDefault();
            const target = ev.target;

            if (target.classList.contains('keyword-list')) {
                // Check if the list is full
                if (target.children.length < MAX_ITEMS_PER_LIST) {
                    target.classList.add('drag-over');
                } else {
                    // Optional: Provide visual feedback that the list is full
                    target.classList.add('list-full'); // Add a class for styling, e.g., red border
                }
            }
        }


    </script>

    <!-- AI Settings Modal -->
    <div id="aiSettingsModal" class="feedback-modal">
        <div class="ai-settings-modal-content">
            <div class="modal-header">
                <h2>Article Optimizer</h2>
                <span class="close-modal" onclick="closeAiSettingsModal()">&times;</span>
            </div>

            <div class="settings-sections-container">
                <!-- Configuration Section -->
                <div class="settings-section">
                    <div class="section-header">
                        <h3><i class="fas fa-cog"></i> Configuration</h3>
                    </div>
                    <div class="form-group full">
                        <label>Target Audience: <span class="required">*</span></label>
                        <input type="text" id="setAudience"
                            placeholder="e.g., Young working professionals in Singapore">
                    </div>
                    <div class="form-row">
                        <div class="form-group half">
                            <label>Brand Tone: <span class="required">*</span></label>
                            <select id="setBrandTone">
                                <option value="Professional">Professional</option>
                                <option value="Casual">Casual</option>
                                <option value="Authoritative">Authoritative</option>
                            </select>
                        </div>
                        <div class="form-group half">
                            <label>Search Intent:</label>
                            <select id="setSearchIntent">
                                <option value="Informational">Informational</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Transactional">Transactional</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Industry & Compliance Section -->
                <div class="settings-section">
                    <h3>Industry & Compliance</h3>
                    <div class="form-row">
                        <div class="form-group half">
                            <label>Industry:</label>
                            <select id="setIndustry">
                                <option value="General">General</option>
                                <option value="Finance">Finance</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Technology">Technology</option>
                            </select>
                        </div>
                        <div class="form-group half">
                            <label>Risk Level:</label>
                            <select id="setRiskLevel">
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group full">
                        <label>Jurisdictions:</label>
                        <input type="text" id="setJurisdictions" placeholder="SG">
                        <span class="help-text">Comma-separated country codes</span>
                    </div>
                </div>

                <!-- Locale & Style Section -->
                <div class="settings-section">
                    <h3>Locale & Style</h3>
                    <div class="form-row">
                        <div class="form-group half">
                            <label>Locale:</label>
                            <select id="setLocale">
                                <option value="en-SG">English (Singapore)</option>
                                <option value="en-US">English (US)</option>
                                <option value="en-GB">English (UK)</option>
                            </select>
                        </div>
                        <div class="form-group half">
                            <label>Reading Level:</label>
                            <select id="setReadingLevel">
                                <option value="Grade 6-8 (Easy)">Grade 6-8 (Easy)</option>
                                <option value="High School">High School</option>
                                <option value="University">University</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Content Guidelines Section -->
                <div class="settings-section">
                    <h3>Content Guidelines</h3>
                    <div class="form-group full">
                        <label>DO Use Words:</label>
                        <input type="text" id="setDoUseWords" placeholder="e.g., premium, luxury, sophisticated">
                        <span class="help-text">Comma-separated mandatory terms</span>
                    </div>
                    <div class="form-group full">
                        <label>DO NOT Use Words:</label>
                        <input type="text" id="setDoNotUseWords" placeholder="e.g., cheap, economical, budget">
                        <span class="help-text">Comma-separated banned terms</span>
                    </div>
                    <div class="form-group full">
                        <label>Focus Products/Services:</label>
                        <input type="text" id="setFocusProducts" placeholder="e.g., Premium Condos, Luxury Apartments">
                        <span class="help-text">Comma-separated products to highlight</span>
                    </div>
                </div>

                <!-- SEO & Compliance Section -->
                <div class="settings-section">
                    <h3>SEO & Compliance</h3>
                    <div class="form-group full">
                        <label>Schema Type:</label>
                        <select id="setSchemaType">
                            <option value="Article">Article</option>
                            <option value="BlogPosting">Blog Posting</option>
                            <option value="Product">Product</option>
                        </select>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="setComplianceDisclaimers">
                        <label for="setComplianceDisclaimers">Require Compliance Disclaimers</label>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-reset" onclick="resetAiSettings()">Reset to Default</button>
                <div class="footer-right">
                    <button class="btn-close" onclick="closeAiSettingsModal()">Close</button>
                    <button class="btn-apply" onclick="applyAiSettings()">Apply</button>
                </div>
            </div>
        </div>
    </div>
</body>


</html>