<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon"
    href="https://mediaonemarketing.com.sg/wp-content/uploads/2023/11/cropped-MediaOne-M-favicon-logo-32x32.png"
    sizes="32x32" />
  <title>Digimetrics Chatbot</title>

  <!-- Modern Fonts and Icons -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary-navy: #1a1f3c;
      --secondary-navy: #2a2f5b;
      --accent-blue: #3b82f6;
      --accent-light: #dbeafe;
      --bg-gradient: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
      --glass-bg: rgba(255, 255, 255, 0.85);
      --glass-border: rgba(255, 255, 255, 0.3);
      --text-main: #1e293b;
      --text-muted: #64748b;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* General Styles */
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-gradient);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: var(--text-main);
    }

    /* Layout Container */
    .main-container {
      display: flex;
      width: 95%;
      max-width: 1400px;
      height: 90vh;
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      box-shadow: var(--shadow-lg);
      overflow: hidden;
    }

    /* Conversation Picker Styles */
    .conversation-picker {
      flex: 0 0 320px;
      background: rgba(255, 255, 255, 0.5);
      border-right: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
    }

    /* Header Styles */
    .chat-header {
      height: 72px !important;
      min-height: 72px !important;
      max-height: 72px !important;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-sizing: border-box;
      flex-shrink: 0;
      background: var(--primary-navy);
      color: #fff;
      z-index: 10;
    }

    .conversation-picker .chat-header {
      border-right: 1px solid rgba(255, 255, 255, 0.05);
    }

    .chat-container .chat-header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chat-header h2 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 700;
      font-family: 'Outfit', sans-serif;
    }

    .search-bar {
      padding: 16px;
      background: transparent;
    }

    .search-bar .search-container {
      position: relative;
    }

    .search-bar i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .search-bar input[type="text"] {
      width: 100%;
      padding: 10px 12px 10px 36px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      background: #fff;
      font-size: 0.9rem;
      outline: none;
      transition: all 0.2s ease;
      box-sizing: border-box;
    }

    .search-bar input[type="text"]:focus {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .conversation-list {
      overflow-y: auto;
      flex-grow: 1;
      padding: 8px;
    }

    .conversation-item {
      padding: 14px;
      border-radius: 12px;
      margin-bottom: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      position: relative;
      border: 1px solid transparent;
    }

    .conversation-item:hover {
      background: rgba(255, 255, 255, 0.8);
      transform: translateY(-1px);
    }

    .conversation-item.active {
      background: #fff;
      border-color: var(--accent-blue);
      box-shadow: var(--shadow-sm);
    }

    .conversation-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 20%;
      bottom: 20%;
      width: 3px;
      background: var(--accent-blue);
      border-radius: 0 4px 4px 0;
    }

    .conversation-details {
      flex-grow: 1;
      min-width: 0;
    }

    .name {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-main);
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .latest-message {
      font-size: 0.85rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .date {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-left: 8px;
    }

    /* Chat Container Styles */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: transparent;
    }

    .chat-container .chat-header {
      /* Specific styles only - base styles from .chat-header */
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background: var(--primary-navy);
    }

    .chat-messages {
      padding: 24px;
      overflow-y: auto;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Message Styles */
    .message-wrapper {
      display: flex;
      flex-direction: column;
      width: 100%;
      margin-bottom: 8px;
    }

    .message {
      padding: 14px 18px;
      border-radius: 18px;
      max-width: 80%;
      line-height: 1.5;
      font-size: 0.95rem;
      position: relative;
      animation: messageIn 0.3s ease-out;
    }

    @keyframes messageIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      background: var(--accent-blue);
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }

    .message.bot {
      background: #fff;
      color: var(--text-main);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(0, 0, 0, 0.05);
      margin-left: 44px;
      /* Space for the bot avatar */
    }

    .message.user {
      background: var(--accent-blue);
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
      margin-right: 44px;
      /* Space for the user avatar */
    }

    .message-wrapper.bot {
      align-items: flex-start;
    }

    .message-wrapper.user {
      align-items: flex-end;
    }

    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      position: absolute;
      bottom: 22px;
      /* Align with bottom of message bubble (above timestamp) */
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      box-shadow: var(--shadow-sm);
      z-index: 5;
    }

    .message.bot .avatar {
      left: -44px;
      background: var(--secondary-navy);
      color: #fff;
    }

    .message.user .avatar {
      right: -44px;
      background: var(--accent-light);
      color: var(--accent-blue);
      overflow: hidden;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      margin: 0 !important;
      /* Override general img styles */
    }

    /* Remove the old bot avatar pseudo-element */
    .message.bot::before {
      display: none;
    }

    .timestamp {
      font-size: 0.7rem;
      margin-top: 6px;
      opacity: 0.6;
    }

    .message.user .timestamp {
      color: rgba(255, 255, 255, 0.8);
      text-align: right;
    }

    .message.bot .timestamp {
      color: var(--text-muted);
      text-align: left;
    }

    .message img {
      max-width: 250px;
      max-height: 250px;
      object-fit: contain;
      border-radius: 12px;
      margin: 8px 0;
      display: block;
      cursor: zoom-in;
      transition: transform 0.2s ease;
    }

    .message img:hover {
      transform: scale(1.02);
    }

    /* Attachment Preview Styles */
    .attachment-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
      padding: 0 4px;
    }

    .attachment-item {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 12px;
      background: #f1f5f9;
      border: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: visible;
      transition: all 0.2s ease;
    }

    .attachment-thumb {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 11px;
    }

    .attachment-icon-placeholder {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .attachment-remove-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 20px;
      height: 20px;
      background: #ef4444;
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 10;
      line-height: 1;
    }

    .attachment-remove-btn:hover {
      background: #dc2626;
      transform: scale(1.1);
    }

    .attachment-name {
      position: absolute;
      bottom: -22px;
      left: 0;
      width: 100%;
      font-size: 0.65rem;
      color: var(--text-muted);
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 2px 4px;
    }

    /* Option Buttons */
    .option-section h4 {
      margin: 0 0 12px 0;
      font-family: 'Outfit', sans-serif;
      font-size: 0.9rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .button-container {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .button-container button {
      background: #fff;
      color: var(--primary-navy);
      border: 1px solid rgba(0, 0, 0, 0.1);
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .button-container button:hover {
      background: var(--accent-light);
      border-color: var(--accent-blue);
      color: var(--accent-blue);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .button-container button i {
      font-size: 0.85rem;
    }

    /* Typing Indicator */
    .typing-indicator {
      padding: 8px 24px;
      font-size: 0.85rem;
      color: var(--text-muted);
      display: none;
      /* Hidden by default */
      align-items: center;
      gap: 4px;
    }

    .typing-indicator.active {
      display: flex;
      /* Show when active */
    }

    .typing-indicator::after {
      content: '...';
      animation: blink 1.5s infinite;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 0.3;
      }

      50% {
        opacity: 1;
      }
    }

    .chat-input-container {
      padding: 16px 24px 24px;
      background: #fff;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
    }

    .chat-input {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chat-input textarea {
      flex: 1;
      padding: 12px 20px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 24px;
      background: #f8fafc;
      font-size: 0.95rem;
      resize: none;
      min-height: 48px;
      max-height: 120px;
      outline: none;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .chat-input textarea:focus {
      background: #fff;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .send-btn {
      width: 48px;
      height: 48px;
      background: var(--accent-blue);
      color: #fff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
    }

    .send-btn:hover {
      background: #2563eb;
      transform: scale(1.05);
    }

    .attach-btn {
      width: 40px;
      height: 40px;
      background: #f1f5f9;
      color: var(--text-muted);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .attach-btn:hover {
      background: var(--accent-light);
      color: var(--accent-blue);
    }

    /* Style for the New Chat Button */
    .new-chat-button {
      background: var(--accent-blue);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
    }

    .new-chat-button:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 6px 8px rgba(59, 130, 246, 0.3);
    }

    .conversation-item:hover .delete-button,
    .conversation-item:hover .rename-button {
      opacity: 1;
    }

    .rename-button {
      padding: 6px 10px;
      background: #e0f2fe;
      color: var(--accent-blue);
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      opacity: 0;
      transition: all 0.2s ease;
      position: absolute;
      top: 16px;
      right: 70px;
      /* Offset from delete button */
      cursor: pointer;
    }

    .rename-button:hover {
      background: var(--accent-light);
    }

    .delete-button {
      padding: 6px 10px;
      background: #fee2e2;
      color: #ef4444;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      opacity: 0;
      transition: all 0.2s ease;
      position: absolute;
      top: 16px;
      right: 16px;
      cursor: pointer;
    }

    .rename-input {
      width: 100%;
      padding: 4px 8px;
      border: 1px solid var(--accent-blue);
      border-radius: 4px;
      font-size: 0.9rem;
      font-family: inherit;
      outline: none;
      background: #fff;
    }

    /* Responsible */
    @media (max-width: 900px) {
      .conversation-picker {
        display: none;
      }
    }

    /* Skeleton Loading Styles */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
      border-radius: 4px;
    }

    @keyframes skeleton-loading {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    .skeleton-item {
      padding: 16px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .skeleton-name {
      height: 18px;
      width: 60%;
    }

    .skeleton-message {
      height: 14px;
      width: 85%;
    }

    .skeleton-date {
      height: 12px;
      width: 30%;
      align-self: flex-end;
    }

    /* --- IMAGE MODAL STYLES --- */
    .image-modal {
      display: none;
      /* Hidden by default */
      position: fixed;
      z-index: 2000;
      /* Sit on top */
      padding-top: 50px;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0, 0, 0);
      background-color: rgba(0, 0, 0, 0.9);
      /* Black w/ opacity */
    }

    .modal-content {
      margin: auto;
      display: block;
      width: 80%;
      max-width: 900px;
      max-height: 85vh;
      object-fit: contain;
      border-radius: 5px;
      animation-name: zoom;
      animation-duration: 0.3s;
    }

    @keyframes zoom {
      from {
        transform: scale(0)
      }

      to {
        transform: scale(1)
      }
    }

    .close-modal {
      position: absolute;
      top: 15px;
      right: 35px;
      color: #f1f1f1;
      font-size: 40px;
      font-weight: bold;
      transition: 0.3s;
      cursor: pointer;
    }

    .close-modal:hover,
    .close-modal:focus {
      color: #bbb;
      text-decoration: none;
      cursor: pointer;
    }

    /* Cursor pointer for chat images to indicate clickability */
    .message img {
      cursor: zoom-in;
    }
  </style>
</head>

<body>
  <div class="main-container">
    <div class="conversation-picker">
      <div class="chat-header">
        <h2>Past Conversations</h2>
      </div>
      <div class="search-bar">
        <div class="search-container">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" placeholder="Search conversations..." onkeyup="filterConversations()" />
        </div>
      </div>
      <div class="conversation-list" id="conversation-list"></div>
    </div>
    <div class="chat-container">
      <div class="chat-header">
        <img src="Digimetrics Logo-02.png" alt="navbar brand" class="navbar-brand" height="30" />
        <button class="new-chat-button" onclick="startNewConversation()">
          New Chat
        </button>
      </div>
      <div class="chat-messages" id="chat-messages">
        <div class="chat-options" id="chat-options" style="display: none"></div>
      </div>
      <div class="typing-indicator" id="typing-indicator"></div>
      <div class="chat-input-container">
        <div id="attachment-preview" class="attachment-preview"></div>
        <div class="chat-input">
          <!-- Hidden File Input -->
          <input type="file" id="file-input" multiple style="display: none" onchange="handleFileSelect(event)" />

          <!-- Paperclip Icon Button -->
          <button class="attach-btn" onclick="document.getElementById('file-input').click()" title="Attach files">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round">
              <path
                d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48">
              </path>
            </svg>
          </button>

          <textarea id="message-input" placeholder="Type your message..." rows="1"></textarea>
          <button class="send-btn" onclick="sendMessage()">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="image-modal" class="image-modal" onclick="closeImageModal()">
    <span class="close-modal">&times;</span>
    <img class="modal-content" id="img-modal-full" onclick="event.stopPropagation()">
    <!-- Stop propagation so clicking image doesn't close it -->
  </div>

  <script>
    chatMessages = document.getElementById("chat-messages");
    const messageInput = document.getElementById("message-input");
    const typingIndicator = document.getElementById("typing-indicator");
    const conversationList = document.getElementById("conversation-list");

    // Get Google User Info
    const storedUser = localStorage.getItem('googleUser');
    let userEmail = "kenneth@mediaone.co";
    let userPhoto = null;
    let userName = "User";

    if (storedUser) {
      const googleUser = JSON.parse(storedUser);
      userEmail = googleUser.email || userEmail;
      userPhoto = googleUser.picture || null;
      userName = googleUser.name || "User";
    }

    messageInput.addEventListener('paste', function (event) {
      // Get the clipboard data
      const items = (event.clipboardData || event.originalEvent.clipboardData).items;
      let hasImage = false;

      // Loop through clipboard items
      for (let i = 0; i < items.length; i++) {
        // Check if the item is an image
        if (items[i].type.indexOf("image") !== -1) {
          const blob = items[i].getAsFile();

          if (blob) {
            hasImage = true;

            // Generate a unique name for the pasted image (e.g., pasted-image-1715622.png)
            const timestamp = new Date().getTime();
            const fileName = `pasted-image-${timestamp}.png`;

            // Create a File object from the blob
            const file = new File([blob], fileName, { type: blob.type });

            // Add to our global selectedFiles array
            selectedFiles.push(file);
          }
        }
      }

      // If an image was pasted, update the preview UI
      if (hasImage) {
        renderAttachmentPreview();

        // Optional: Prevent the default paste behavior if you don't want 
        // the binary string/filename appearing in the text box.
        // However, usually browsers don't paste image data into textareas anyway.
      }
    });

    // NEW Global variable for attachments
    let selectedFiles = [];

    messageInput.addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        if (!event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      }
    });

    // --- NEW: FILE HANDLING FUNCTIONS ---

    function handleFileSelect(event) {
      const files = Array.from(event.target.files);
      // Add new files to our array
      selectedFiles = [...selectedFiles, ...files];
      renderAttachmentPreview();
      // Reset the input value so same file can be selected again if needed
      event.target.value = "";
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      renderAttachmentPreview();
    }

    function renderAttachmentPreview() {
      const previewContainer = document.getElementById('attachment-preview');
      previewContainer.innerHTML = '';

      selectedFiles.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'attachment-item';

        // 1. Create Thumbnail or Icon
        let contentDisplay;
        if (file.type.startsWith('image/')) {
          const img = document.createElement('img');
          img.className = 'attachment-thumb';
          img.src = URL.createObjectURL(file); // Generate preview blob
          img.onload = () => URL.revokeObjectURL(img.src); // Free memory after loading
          contentDisplay = img;
        } else {
          // For non-images (PDF, etc), show extension
          const div = document.createElement('div');
          div.className = 'attachment-icon-placeholder';
          // Get extension (e.g., pdf, txt)
          const ext = file.name.split('.').pop().substring(0, 4);
          div.textContent = ext || "FILE";
          contentDisplay = div;
        }

        // 2. Create Remove Button
        const removeBtn = document.createElement('div');
        removeBtn.className = 'attachment-remove-btn';
        removeBtn.innerHTML = '&times;';
        removeBtn.onclick = () => removeFile(index);

        // 3. Create Name Label
        const nameSpan = document.createElement('div');
        nameSpan.className = 'attachment-name';
        nameSpan.textContent = file.name;
        nameSpan.title = file.name; // Tooltip for full name

        // Assemble
        item.appendChild(removeBtn);
        item.appendChild(contentDisplay);
        item.appendChild(nameSpan);

        previewContainer.appendChild(item);
      });
    }

    // Helper to convert file to Base64
    const convertToBase64 = (file) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
          // result looks like "data:image/png;base64,iVBOR..."
          // We need to strip the prefix for some APIs, or keep it.
          // The Python code expects: "data:{type};base64,{data}" construction.
          // So we need to extract just the base64 part and the mime type.

          const result = reader.result;
          const base64Data = result.split(",")[1]; // Get data after comma

          resolve({
            name: file.name,
            type: file.type,
            data: base64Data,
          });
        };
        reader.onerror = (error) => reject(error);
      });
    };

    function displayTypingIndicator() {
      typingIndicator.innerHTML = 'Processing... <span></span><span></span><span></span>';
      typingIndicator.classList.add("active");
    }

    function hideTypingIndicator() {
      typingIndicator.classList.remove("active");
      typingIndicator.innerHTML = "";
    }

    async function sendMessage() {
      const messageText = messageInput.value.trim();
      const hasAttachments = selectedFiles.length > 0;

      // If no text and no attachments, do nothing
      if (!messageText && !hasAttachments) return;

      const optionsContainer = document.getElementById("chat-options");
      if (optionsContainer) optionsContainer.innerHTML = ""; // Clear previous options

      // ---------------------------------------------------------
      // 1. Process Attachments (Convert to Base64)
      // ---------------------------------------------------------
      let attachmentsPayload = [];
      if (hasAttachments) {
        try {
          // Convert all files to { name, type, data }
          attachmentsPayload = await Promise.all(
            selectedFiles.map((file) => convertToBase64(file))
          );
        } catch (err) {
          console.error("Error reading files", err);
          alert("Error reading attached files.");
          return;
        }
      }

      // Get history
      let input_messages = [];
      try {
        input_messages = JSON.parse(localStorage.getItem("input_messages")) || [];
      } catch (error) {
        input_messages = [];
      }

      // ---------------------------------------------------------
      // 2. Display Message Locally (Visual Preview with Thumbnails)
      // ---------------------------------------------------------
      // We construct a structure similar to what the API returns 
      // so displayMessage can handle text and images together.
      let localDisplayContent = [];

      // Add text part if exists
      if (messageText) {
        localDisplayContent.push({ type: "text", text: messageText });
      }

      // Add image parts if exist
      attachmentsPayload.forEach((att) => {
        if (att.type.startsWith("image/")) {
          // Display as image
          localDisplayContent.push({
            type: "image_url",
            image_url: `data:${att.type};base64,${att.data}`,
          });
        } else {
          // Display non-images as text reference
          localDisplayContent.push({
            type: "text",
            text: `<i>[Attached File: ${att.name}]</i>`,
          });
        }
      });

      // Render to UI
      displayMessage(localDisplayContent, "user");

      // ---------------------------------------------------------
      // 3. Reset UI Inputs
      // ---------------------------------------------------------
      messageInput.value = "";
      selectedFiles = []; // Clear global files array
      renderAttachmentPreview(); // Clear the visual preview bar

      // ---------------------------------------------------------
      // 4. Check for Templated Actions (SEO/GEO/Social)
      // ---------------------------------------------------------

      if (messageText.toLowerCase().includes("show options")) {
        chatMessages = document.getElementById("chat-messages");
        displayOptions();
        return;
      }
      else if (messageText.includes("I would like to look at SEO today")) {
        displayTypingIndicator();
        const sections = [
          {
            header: "Keywords",
            options: [
              { label: "Keyword Research", value: "I want to do keyword research", icon: "fa-magnifying-glass" },
              { label: "Check SERPs", value: "I want to check SERPs", icon: "fa-list-ol" },
              { label: "Rank Checker", value: "I want to check rankings", icon: "fa-arrow-up-9-1" },
              { label: "Find Similar Keywords", value: "I want to find similar keywords", icon: "fa-tags" },
              { label: "Keyword Mapping", value: "I want to do keyword mapping", icon: "fa-map" },
              { label: "Keyword Analysis", value: "I want to do keyword analysis", icon: "fa-chart-simple" },
              { label: "Keyword Density", value: "I want to check the keyword density of a chunk of text.", icon: "fa-percent" }
            ],
          },
          {
            header: "Technical SEO",
            options: [
              { label: "Check Page Speed", value: "I want to check my pagespeed using GTmetrix", icon: "fa-gauge-high" },
              { label: "Check Domain Authority", value: "I want to check domain authority", icon: "fa-shield-halved" },
              { label: "Generate Schema", value: "I want to generate schema markup", icon: "fa-code" },
              { label: "Google Webpage Crawler Simulator", value: "I want to simulate the Google Webpage Crawler", icon: "fa-robot" },
            ],
          },
          {
            header: "Content Analysis",
            options: [
              { label: "Check Content", value: "I want to check the content I've written", icon: "fa-file-lines" },
              { label: "Content Comparison", value: "I want to do content comparison", icon: "fa-code-compare" },
            ],
          },
        ];
        renderOptionsMessage(sections, optionsContainer);
        return;
      }
      else if (messageText.includes("I would like to look at GEO today")) {
        displayTypingIndicator();
        const sections = [
          {
            header: "GEO",
            options: [
              { label: "AI SEO audit for brand Research", value: "GEO: Run an AI SEO audit for my brand", icon: "fa-clipboard-check" },
              { label: "Improve GEO for website", value: "How can I improve GEO for my website?", icon: "fa-wand-magic-sparkles" },
              { label: "Compare AI visibility against competitors", value: "GEO: Compare my AI visibility vs competitors", icon: "fa-binoculars" },
              { label: "GEO prompt proposal", value: "I need prompt proposal for my GEO project", icon: "fa-lightbulb" },
            ],
          },
        ];
        renderOptionsMessage(sections, optionsContainer);
        return;
      }
      else if (messageText.includes("I would like to look at Paid Ads today")) {
        displayTypingIndicator();
        const sections = [
          {
            header: "SEM Tools",
            options: [
              { label: "SEM Ad Generator", value: "I want to generate SEM ads", icon: "fa-rectangle-ad" },
            ],
          },
        ];
        renderOptionsMessage(sections, optionsContainer);
        return;
      }
      else if (messageText.includes("I would like to look at social media today")) {
        displayTypingIndicator();
        const sections = [
          {
            header: "Creation",
            options: [
              { label: "Content Generator", value: "I want to generate social media content", icon: "fa-pen-to-square" },
            ],
          },
          {
            header: "Management",
            options: [
              { label: "Response Generator", value: "I want to generate a social media response", icon: "fa-reply" },
            ],
          },
          {
            header: "Analysis",
            options: [
              { label: "Check Content", value: "I want to check the content I've written", icon: "fa-file-circle-check" },
            ],
          },
        ];
        renderOptionsMessage(sections, optionsContainer);
        return;
      }
      else if (messageText.includes("I would like to look at others today")) {
        displayTypingIndicator();
        const sections = [
          {
            header: "Strategy",
            options: [
              { label: "Persona Generator", value: "I want to generate a persona", icon: "fa-user-gear" },
              { label: "Media Plan", value: "I want to create a media plan", icon: "fa-file-invoice" },
            ],
          },
          {
            header: "Competitive",
            options: [
              { label: "Competitors Identifier", value: "I want to identify competitors", icon: "fa-users-viewfinder" },
            ],
          },
          {
            header: "Audit",
            options: [
              { label: "Landing Page Audit", value: "I want to audit a landing page", icon: "fa-magnifying-glass-chart" },
            ],
          },
          {
            header: "Optimisation",
            options: [
              { label: "AI Content Optimiser", value: "I want to use the AI content optimiser", icon: "fa-sparkles" },
            ],
          },
        ];
        renderOptionsMessage(sections, optionsContainer);
        return;
      }

      // ---------------------------------------------------------
      // 5. Send to API (Standard Request)
      // ---------------------------------------------------------
      displayTypingIndicator();

      fetch(
        "https://8q9qwp4ytd.execute-api.ap-southeast-1.amazonaws.com/gptResponses2",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            question: messageText,
            input_messages: input_messages,
            attachments: attachmentsPayload, // Send the processed files
          }),
        }
      )
        .then((response) => response.json())
        .then((data) => {
          processData(data);
          // Save history handled inside processData/saveConversation
        })
        .catch((error) => {
          hideTypingIndicator();
          console.error("Error:", error);
          displayMessage("Error: Could not get response.", "bot");
          saveConversation();
        });
    }

    // ---------------------------------------------------------
    // Helper Function for Templated Options
    // ---------------------------------------------------------
    function renderOptionsMessage(sections, optionsContainer) {
      const optionsMessage = document.createElement("div");
      optionsMessage.classList.add("message", "bot");
      optionsMessage.style.marginBottom = "10px";

      sections.forEach((section) => {
        const sectionDiv = document.createElement("div");
        sectionDiv.classList.add("option-section");
        sectionDiv.style.marginBottom = "15px";

        // Header
        const header = document.createElement("h4");
        header.textContent = section.header;
        header.style.marginBottom = "8px";
        header.style.color = "#333";
        sectionDiv.appendChild(header);

        // Button container
        const buttonContainer = document.createElement("div");
        buttonContainer.classList.add("button-container");

        section.options.forEach((opt) => {
          const button = document.createElement("button");
          if (opt.icon) {
            button.innerHTML = `<i class="fas ${opt.icon}"></i> ${opt.label}`;
          } else {
            button.textContent = opt.label;
          }
          button.onclick = () => {
            if (optionsContainer) optionsContainer.style.display = "none";
            messageInput.value = opt.value;
            sendMessage();
          };
          buttonContainer.appendChild(button);
        });

        sectionDiv.appendChild(buttonContainer);
        optionsMessage.appendChild(sectionDiv);
      });

      // Simulate processing time then show options
      setTimeout(() => {
        hideTypingIndicator();
        chatMessages.appendChild(optionsMessage);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 500);
    }

    function formatMessageContent(content) {
      if (!content) return "";

      // If it's already a string (old messages), return it
      if (typeof content === 'string') return content;

      // If it's an array (new messages with potential attachments)
      if (Array.isArray(content)) {
        let textAcc = "";
        let hasAttachment = false;

        content.forEach(item => {
          // Check for text types
          if (item.type === 'input_text' || item.type === 'text') {
            textAcc += item.text + " ";
          }
          // Check for image/file types
          else if (item.type === 'input_image' || item.type === 'image_url') {
            hasAttachment = true;
          }
        });

        // Format the output
        if (hasAttachment) {
          return textAcc.trim() ? `${textAcc} <em style="font-size:0.8em; color:#666;">[Attachment]</em>` : `<em style="font-size:0.8em; color:#666;">[Attachment]</em>`;
        }
        return textAcc.trim();
      }

      return JSON.stringify(content); // Fallback
    }

    async function processData(data) {
      console.log(data);
      let input_messages = data.input_messages || [];

      const hasFunctions =
        Array.isArray(data.functions) && data.functions.length > 0;

      if (!hasFunctions) {
        // No more tool calls expected — render answer safely
        if (typeof data.answer === "string" && data.answer.trim()) {
          displayMessage(data.answer, "bot");
        } else {
          displayMessage("Sorry, I could not get an answer.", "bot");
        }
        console.log(input_messages);
        localStorage.setItem(
          "input_messages",
          JSON.stringify(input_messages)
        );
        saveConversation();
        hideTypingIndicator();
        return;
      }

      // There are pending function calls: execute them serially
      try {
        // Keep the dots while updating text
        typingIndicator.innerHTML = 'Getting external data... <span></span><span></span><span></span>';
        typingIndicator.classList.add("active");
        for (const fn of data.functions) {
          // fn is [name, args, call_id]
          const [name, args, call_id] = fn;
          const function_result = await call_function(name, args);

          // Optional: only set title once (first tool call of a chain)
          if (
            !localStorage.getItem("conversation_title") ||
            localStorage.getItem("conversation_title") === "New Conversation"
          ) {
            localStorage.setItem("conversation_title", name);
          }

          input_messages.push({
            type: "function_call_output",
            call_id: call_id,
            output: JSON.stringify(function_result),
          });
        }

        localStorage.setItem(
          "input_messages",
          JSON.stringify(input_messages)
        );
        saveConversation();

        // Send the tool outputs back to the model and continue the loop
        await returnFunctionResult();
      } catch (err) {
        console.error("Error during function execution chain:", err);
        hideTypingIndicator();
        displayMessage(
          "Error: Could not complete external data retrieval.",
          "bot"
        );
        saveConversation();
      }
    }

    async function returnFunctionResult() {
      try {
        const input_messages =
          JSON.parse(localStorage.getItem("input_messages")) || [];

        const resp = await fetch(
          "https://8q9qwp4ytd.execute-api.ap-southeast-1.amazonaws.com/gptResponses2",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ input_messages }),
          }
        );

        const data = await resp.json();
        console.log("returnFunctionResult ->", data);

        // Keep chaining until no functions remain
        const hasFunctions =
          Array.isArray(data.functions) && data.functions.length > 0;

        if (hasFunctions) {
          // Re-enter the same decision logic
          await processData(data);
          saveConversation();
          return;
        }

        // Terminal response
        if (typeof data.answer === "string" && data.answer.trim()) {
          displayMessage(data.answer, "bot");
        } else {
          displayMessage(
            "Sorry, I couldn’t parse a reply from the model.",
            "bot"
          );
        }

        localStorage.setItem(
          "input_messages",
          JSON.stringify(data.input_messages || input_messages)
        );
        saveConversation();
        hideTypingIndicator();
      } catch (error) {
        console.error("Error in returnFunctionResult:", error);
        hideTypingIndicator();
        displayMessage("Error: Could not get response.", "bot");
        saveConversation();
      }
    }

    function handleSearch() {
      const searchTerm = document.getElementById("search-bar").value.trim();

      if (searchTerm.length > 0) {
        fetchConversations(searchTerm);
      } else {
        conversationList.innerHTML = "";
      }
    }

    // Function to fetch conversations based on search term
    async function fetchConversations(searchTerm) {
      try {
        const response = await fetch(
          "https://your-api-endpoint.com/searchConversations",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: searchTerm }),
          }
        );

        if (!response.ok) {
          throw new Error("Failed to fetch search results");
        }

        const conversations = await response.json();
        displaySearchResults(conversations);
      } catch (error) {
        console.error("Error fetching search results:", error);
        conversationList.innerHTML =
          '<div class="conversation-item">Error loading results.</div>';
      }
    }

    // Function to display the search results
    function displaySearchResults(conversations) {
      conversationList.innerHTML = "";
      if (conversations.length === 0) {
        conversationList.innerHTML =
          '<div class="conversation-item">No results found.</div>';
        return;
      }

      conversations.forEach((conversation) => {
        const conversationItem = document.createElement("div");
        conversationItem.classList.add("conversation-item");
        conversationItem.id = conversation.id;

        const conversationDetails = document.createElement("div");
        conversationDetails.classList.add("conversation-details");

        const nameDiv = document.createElement("div");
        nameDiv.classList.add("name");
        nameDiv.textContent = conversation.title;

        const latestMessageDiv = document.createElement("div");
        latestMessageDiv.classList.add("latest-message");
        const firstMessage = conversation.messages
          .filter((msg) => msg.role === "user")
          .shift();
        latestMessageDiv.textContent = firstMessage
          ? firstMessage.content
          : "No messages yet";

        const dateDiv = document.createElement("div");
        dateDiv.classList.add("date");
        dateDiv.textContent = conversation.last_updated.split(" ")[0];

        conversationDetails.appendChild(nameDiv);
        conversationDetails.appendChild(latestMessageDiv);
        conversationDetails.appendChild(dateDiv);

        conversationItem.appendChild(conversationDetails);
        conversationList.appendChild(conversationItem);
      });
    }

    function displayMessage(content, sender) {
      const messageContainer = document.createElement("div");
      messageContainer.classList.add("message-wrapper", sender);

      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message", sender);

      // Create Avatar
      const avatarDiv = document.createElement("div");
      avatarDiv.classList.add("avatar");
      if (sender === "bot") {
        avatarDiv.innerHTML = '<i class="fas fa-robot"></i>';
      } else {
        if (userPhoto) {
          avatarDiv.innerHTML = `<img src="${userPhoto}" alt="${userName}">`;
        } else {
          avatarDiv.innerHTML = '<i class="fas fa-user"></i>';
        }
      }
      messageDiv.appendChild(avatarDiv);

      // Add timestamp
      const now = new Date();
      const dateStr = now.getDate().toString().padStart(2, '0') + '/' + (now.getMonth() + 1).toString().padStart(2, '0');
      const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
      const timestamp = document.createElement("div");
      timestamp.classList.add("timestamp");
      timestamp.textContent = dateStr + ' ' + timeStr;

      // Case 1: Simple String
      if (typeof content === 'string') {
        messageDiv.innerHTML = content;
      }
      // Case 2: Structured Array (New format)
      else if (Array.isArray(content)) {
        content.forEach(item => {
          // Render Text
          if (item.type === 'text' || item.type === 'input_text') {
            if (item.text && item.text.trim() !== "") {
              const textSpan = document.createElement("div");
              textSpan.innerHTML = item.text.replace(/\n/g, '<br>');
              messageDiv.appendChild(textSpan);
            }
          }
          // Render Image
          else if (item.type === 'image_url' || item.type === 'input_image') {
            const img = document.createElement("img");

            let src = "";
            if (typeof item.image_url === 'object') {
              src = item.image_url.url;
            } else {
              src = item.image_url;
            }

            img.src = src;
            img.alt = "Uploaded image";

            // --- NEW: Add Click Handler ---
            img.onclick = function () {
              openImageModal(this.src);
            };

            messageDiv.appendChild(img);
          }
        });
      }

      messageDiv.appendChild(timestamp);
      messageContainer.appendChild(messageDiv);
      chatMessages.appendChild(messageContainer);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function call_function(name, args) {
      switch (name) {
        case "get_serps":
          return await get_serps(args.keyword, args.language, args.location);
        case "rank_checker":
          return await rank_checker(
            args.keyword,
            args.language,
            args.location,
            args.target
          );
        case "moz":
          return await moz(args.domain);
        case "gtMetrix":
          return await gtMetrix(args.target);
        case "keyword_metrics":
          return await keyword_metrics(
            args.keywords,
            args.location,
            args.language
          );
        case "scrape_webpage":
          return await scrape_webpage(args.url);
        case "get_html_values":
          return await get_html_values(args.url);
        case "ranking_keywords":
          return await ranking_keywords(args.target, args.location);
        case "similar_keywords":
          return await similar_keywords(
            args.keywords,
            args.language,
            args.location
          );
        case "spacy":
          return await spacy(args.text);
        case "keywords_for_site":
          return await keywords_for_site(
            args.target,
            args.language,
            args.location
          );
        case "getHTML":
          return await getHTML(args.target);
        default:
          throw new Error(`Function ${name} not found`);
      }
    }

    async function get_serps(keyword, language, location) {
      const url =
        "https://8k6r15rg4m.execute-api.ap-southeast-1.amazonaws.com/serpLite";
      const payload = {
        keyword: keyword,
        language: language,
        location: location,
      };
      const headers = {
        "Content-Type": "application/json",
      };

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: headers,
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("Error in get_serps:", error);
        throw error; // Re-throw to allow handling further up the call stack
      }
    }

    async function rank_checker(keyword, language, location, target) {
      const url =
        "https://v5bizygr4m.execute-api.ap-southeast-1.amazonaws.com/rankChecker";
      const payload = {
        keyword: keyword,
        language: language,
        location: location,
        target: target,
      };
      const headers = {
        "Content-Type": "application/json",
      };

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: headers,
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("Error in rank_checker:", error);
        throw error;
      }
    }

    async function getHTML(target) {
      const url =
        "https://abrhhnjp4m.execute-api.ap-southeast-1.amazonaws.com/getHtml";
      const payload = {
        url: target,
      };
      const headers = {
        "Content-Type": "application/json",
      };

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: headers,
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("Error in getHtml:", error);
        throw error;
      }
    }

    async function moz(domain) {
      const url =
        "https://a7hptjtc8e.execute-api.ap-southeast-1.amazonaws.com/new";
      const payload = {
        domain: domain,
      };
      const headers = {
        "Content-Type": "application/json",
      };

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: headers,
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("Error in moz:", error);
        throw error;
      }
    }

    async function keyword_metrics(keywords, location, language) {
      const url =
        "https://eo2ckwvxmf.execute-api.ap-southeast-1.amazonaws.com/keywordMetrics";
      const payload = {
        keywords: keywords,
        language: language,
        location: location,
      };
      const headers = {
        "Content-Type": "application/json",
      };

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: headers,
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("Error in keyword_metrics:", error);
        throw error;
      }
    }

    async function scrape_webpage(target_url) {
      const url =
        "https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing";
      const payload = {
        url: target_url,
      };
      const headers = {
        "Content-Type": "application/json",
      };

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: headers,
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("Error in scrape_webpage:", error);
        throw error;
      }
    }

    async function get_html_values(target_url) {
      const url =
        "https://udjdc333m9.execute-api.ap-southeast-1.amazonaws.com/getImages";
      const payload = {
        url: target_url,
      };
      const headers = {
        "Content-Type": "application/json",
      };

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: headers,
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("Error in scrape_webpage:", error);
        throw error;
      }
    }

    async function ranking_keywords(target, location) {
      const url =
        "https://0dqny7l5y9.execute-api.ap-southeast-1.amazonaws.com/rankingKeywords";
      const payload = {
        target: target,
        location: location,
      };
      const headers = {
        "Content-Type": "application/json",
      };

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: headers,
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("Error in ranking_keywords:", error);
        throw error;
      }
    }

    async function spacy(text) {
      const url =
        "https://mxyyoh5y2d.execute-api.ap-southeast-1.amazonaws.com/spacy";
      const payload = {
        text: text,
      };
      const headers = {
        "Content-Type": "application/json",
      };

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: headers,
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("Error in keyword frequency:", error);
        throw error;
      }
    }

    async function similar_keywords(keywords, language, location) {
      const url =
        "https://lgvdhcs4t2.execute-api.ap-southeast-1.amazonaws.com/similarKeywords";
      const payload = {
        keywords: keywords,
        location: location,
        language: language,
      };
      const headers = {
        "Content-Type": "application/json",
      };

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: headers,
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("Error in similar_keywords:", error);
        throw error;
      }
    }

    async function keywords_for_site(target_url, language, location) {
      const url =
        "https://ei6xj9x2rd.execute-api.ap-southeast-1.amazonaws.com/keywordsForSite";
      const payload = {
        target: target_url,
        location: location,
        language: language,
      };
      const headers = {
        "Content-Type": "application/json",
      };

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: headers,
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("Error in keywords_for_site:", error);
        throw error;
      }
    }

    async function gtMetrix(target) {
      try {
        response = await fetch(
          "https://y5830908vh.execute-api.ap-southeast-1.amazonaws.com/gtmetrix",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ url: target }),
          }
        );
        const data = await response.json();

        return data;
      } catch (error) {
        console.error("Error in gtMetrix:", error);
        throw error;
      }
    }

    function setActiveClass(element) {
      // Remove 'active' class from any previously active items
      let activeItems = document.querySelectorAll(
        ".conversation-item.active"
      );
      activeItems.forEach((item) => {
        item.classList.remove("active");
      });

      // Add 'active' class to the clicked element
      element.classList.add("active");
    }

    function filterConversations() {
      const input = document.getElementById('searchInput');
      const filter = input.value.toLowerCase();
      const list = document.getElementById('conversation-list');
      const items = list.getElementsByClassName('conversation-item');

      for (let i = 0; i < items.length; i++) {
        const title = items[i].getElementsByClassName('name')[0];
        const preview = items[i].getElementsByClassName('latest-message')[0];
        const textValue = (title.textContent || title.innerText) + " " + (preview.textContent || preview.innerText);

        if (textValue.toLowerCase().indexOf(filter) > -1) {
          items[i].style.display = "";
        } else {
          items[i].style.display = "none";
        }
      }
    }

    window.onload = function () {
      //displayMessage('Hello! How can I help you today?', 'bot');
      localStorage.setItem("input_messages", []);
      localStorage.setItem("conversation_title", "New Conversation");
      displayOptions(); // show the quick buttons after greeting
      loadPastConversations();
    };

    // Function to display option buttons inside a message bubble
    function displayOptions() {
      chatMessages.innerHTML +=
        '<div class="chat-options" id="chat-options" style="display: none;"></div>';
      const optionsContainer = document.getElementById("chat-options");
      optionsContainer.innerHTML = ""; // clear previous options

      // Create the main message
      const optionsMessage = document.createElement("div");
      optionsMessage.classList.add("message", "bot");
      optionsMessage.style.marginBottom = "10px";
      optionsMessage.innerHTML =
        "Which area would you like to explore today?";

      const pathwayOne = [
        {
          header: "Focus",
          options: [
            {
              label: "Search Engine Optimisation (SEO)",
              value: "I would like to look at SEO today",
              icon: "fa-rocket"
            },
            {
              label: "Generative Engine Optimisation (GEO)",
              value: "I would like to look at GEO today",
              icon: "fa-brain"
            },
            {
              label: "Paid Ads",
              value: "I would like to look at Paid Ads today",
              icon: "fa-ad"
            },
            {
              label: "Social Media",
              value: "I would like to look at social media today",
              icon: "fa-share-nodes"
            },
            {
              label: "Others",
              value: "I would like to look at others today",
              icon: "fa-ellipsis"
            },
          ],
        },
      ];

      pathwayOne.forEach((section) => {
        const sectionDiv = document.createElement("div");
        sectionDiv.classList.add("option-section");
        sectionDiv.style.marginBottom = "15px";

        // Header
        const header = document.createElement("h4");
        header.textContent = section.header;
        header.style.marginBottom = "8px";
        header.style.color = "#333";
        sectionDiv.appendChild(header);

        // Button container
        const buttonContainer = document.createElement("div");
        buttonContainer.classList.add("button-container");

        section.options.forEach((opt) => {
          const button = document.createElement("button");
          if (opt.icon) {
            button.innerHTML = `<i class="fas ${opt.icon}"></i> ${opt.label}`;
          } else {
            button.textContent = opt.label;
          }
          button.onclick = () => {
            optionsContainer.style.display = "none"; // Hide after selection
            messageInput.value = opt.value;
            sendMessage();
          };
          buttonContainer.appendChild(button);
        });

        sectionDiv.appendChild(buttonContainer);
        optionsMessage.appendChild(sectionDiv);
      });

      chatMessages.appendChild(optionsMessage);

      // Scroll to bottom of chat messages
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function loadPastConversations() {
      // Show skeleton loaders
      conversationList.innerHTML = '';
      for (let i = 0; i < 5; i++) {
        const skeleton = document.createElement("div");
        skeleton.classList.add("skeleton-item");
        skeleton.innerHTML = `
          <div class="skeleton skeleton-name"></div>
          <div class="skeleton skeleton-message"></div>
          <div class="skeleton skeleton-date"></div>
        `;
        conversationList.appendChild(skeleton);
      }

      try {
        const response = await fetch(
          "https://ro2g6qodt1.execute-api.ap-southeast-1.amazonaws.com/chatbotPastConversations",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              user: userEmail,
            }),
          }
        );

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const conversations = await response.json();
        populateConversationList(conversations);
      } catch (error) {
        console.error("Error fetching past conversations:", error);
        conversationList.innerHTML =
          '<div class="conversation-item">Error loading conversations.</div>';
      }
    }

    function populateConversationList(conversations) {
      conversationList.innerHTML = "";

      conversations.forEach((conversation) => {
        const conversationItem = document.createElement("div");
        conversationItem.classList.add("conversation-item");
        conversationItem.id = conversation.id;
        conversationItem.addEventListener("click", () =>
          loadConversationById(conversation.id)
        );

        const conversationDetails = document.createElement("div");
        conversationDetails.classList.add("conversation-details");

        const nameDiv = document.createElement("div");
        nameDiv.classList.add("name");
        nameDiv.textContent = conversation.title;

        const latestMessageDiv = document.createElement("div");
        latestMessageDiv.classList.add("latest-message");

        // Use helper to format the preview text (handles structured arrays/objects)
        const previewText = formatMessageContent(conversation.first_message) || "No messages yet";
        latestMessageDiv.innerHTML = previewText;

        const dateDiv = document.createElement("div");
        dateDiv.classList.add("date");
        dateDiv.textContent = conversation.last_updated.split(" ")[0];

        conversationDetails.appendChild(nameDiv);
        conversationDetails.appendChild(latestMessageDiv);
        conversationDetails.appendChild(dateDiv);

        // Create the rename button
        const renameButton = document.createElement("button");
        renameButton.classList.add("rename-button");
        renameButton.innerHTML = '<i class="fas fa-pencil-alt"></i>';
        renameButton.title = "Rename conversation";

        renameButton.onclick = (e) => {
          e.stopPropagation();
          startRenaming(conversation.id, nameDiv, conversation.title);
        };

        // Create the delete button
        const deleteButton = document.createElement("button");
        deleteButton.classList.add("delete-button");
        deleteButton.textContent = "Delete";

        deleteButton.onclick = (e) => {
          e.stopPropagation();
          deleteConversation(conversation.id, deleteButton);
        };

        conversationItem.appendChild(conversationDetails);
        conversationItem.appendChild(renameButton);
        conversationItem.appendChild(deleteButton);
        conversationList.appendChild(conversationItem);
      });
    }

    function startRenaming(id, nameDiv, currentTitle) {
      const input = document.createElement("input");
      input.type = "text";
      input.className = "rename-input";
      input.value = currentTitle;

      const originalContent = nameDiv.textContent;
      nameDiv.innerHTML = "";
      nameDiv.appendChild(input);
      input.focus();

      // Handle blur and enter
      const save = async () => {
        const newTitle = input.value.trim();
        if (newTitle && newTitle !== currentTitle) {
          nameDiv.textContent = newTitle;
          await renameConversation(id, newTitle);
        } else {
          nameDiv.textContent = currentTitle;
        }
      };

      input.onblur = save;
      input.onkeydown = (e) => {
        if (e.key === "Enter") {
          input.onblur = null; // Prevent double trigger
          save();
        }
        if (e.key === "Escape") {
          input.onblur = null;
          nameDiv.textContent = currentTitle;
        }
      };
    }

    async function renameConversation(id, newTitle) {
      try {
        const response = await fetch(
          "https://8i8tbru5m2.execute-api.ap-southeast-1.amazonaws.com/createUpdateConversation",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              conversation_id: id,
              title: newTitle,
              user: userEmail
            }),
          }
        );

        if (!response.ok) {
          throw new Error("Failed to rename conversation");
        }

        // Update the local storage title if this is the active conversation
        if (id === localStorage.getItem("current_conversation_id")) {
          localStorage.setItem("conversation_title", newTitle);
        }
      } catch (error) {
        console.error("Error renaming:", error);
        alert("Failed to rename conversation. Please try again.");
      }
    }

    async function loadConversationById(id) {
      // Show local typing/loading indicator in chat
      chatMessages.innerHTML = '<div class="message bot"><div class="typing-indicator active"><span></span><span></span><span></span></div></div>';

      try {
        const response = await fetch(
          "https://ro2g6qodt1.execute-api.ap-southeast-1.amazonaws.com/chatbotPastConversations",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              conversation_id: id,
            }),
          }
        );

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const conversation = await response.json();
        if (conversation.error) {
          throw new Error(conversation.error);
        }
        loadConversation(conversation);
      } catch (error) {
        console.error("Error loading conversation:", error);
        chatMessages.innerHTML = `<div class="message bot">Error loading conversation: ${error.message}</div>`;
      }
    }

    // Function to delete the conversation
    async function deleteConversation(conversationId, button) {
      // Show loading state
      const originalText = button.textContent;
      button.textContent = "Deleting...";
      button.disabled = true;
      button.style.opacity = "0.7";
      button.style.cursor = "not-allowed";

      try {
        // Send delete API request
        const response = await fetch(
          "https://zuhpw7ts50.execute-api.ap-southeast-1.amazonaws.com/deleteChatbotConversation",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ conversation_id: conversationId }),
          }
        );

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        // Successfully deleted, remove from UI
        const item = document.getElementById(conversationId);
        if (item) item.remove();
      } catch (error) {
        console.error("Error deleting conversation:", error);
        // Revert state on error
        button.textContent = originalText;
        button.disabled = false;
        button.style.opacity = "1";
        button.style.cursor = "pointer";
        alert("Failed to delete conversation. Please try again.");
      }
    }

    async function loadConversation(conversation) {
      localStorage.setItem("conversation_id", conversation["id"]);
      chatMessages.innerHTML = "";

      const filteredMessages = conversation.messages.filter(
        (message) => message.role === "user" || message.role === "assistant"
      );

      filteredMessages.forEach((message) => {
        // PASS RAW CONTENT to displayMessage, do not format it to string here.
        // displayMessage now handles the objects/arrays.
        if (message.role === "user") {
          displayMessage(message.content, "user");
        } else if (message.role === "assistant") {
          displayMessage(message.content, "bot");
        }
      });

      localStorage.setItem(
        "input_messages",
        JSON.stringify(conversation.messages)
      );
    }

    async function saveConversation() {
      try {
        const response = await fetch(
          "https://8i8tbru5m2.execute-api.ap-southeast-1.amazonaws.com/createUpdateConversation",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              user: userEmail,
              conversation_id: localStorage.getItem("conversation_id"),
              messages: JSON.parse(localStorage.getItem("input_messages")),
              title: localStorage.getItem("conversation_title"),
            }),
          }
        );

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        output = await response.json();
        if (localStorage.getItem("conversation_id") == "") {
          localStorage.setItem("conversation_id", output);
        }

        loadPastConversations();
      } catch (error) {
        console.error("Error updating/creating conversations:", error);
        // Display a user-friendly error message in the conversation list
        conversationList.innerHTML =
          '<div class="conversation-item">Error creating / updating conversations.</div>';
        loadPastConversations();
      }
    }

    function startNewConversation() {
      // Clear chat messages
      chatMessages.innerHTML = "";
      localStorage.setItem("conversation_id", "");
      localStorage.setItem("input_messages", []);
      localStorage.setItem("conversation_title", "New Conversation");

      // Clear local storage
      localStorage.removeItem("input_messages");
      localStorage.setItem("input_messages", JSON.stringify([]));

      // Display initial bot message
      displayMessage("Hello! How can I help you today?", "bot");

      // Display options
      displayOptions();
    }

    // --- MODAL FUNCTIONS ---
    function openImageModal(src) {
      const modal = document.getElementById("image-modal");
      const modalImg = document.getElementById("img-modal-full");

      modal.style.display = "flex";
      modal.style.alignItems = "center";
      modal.style.justifyContent = "center";
      modalImg.src = src;
    }

    function closeImageModal() {
      const modal = document.getElementById("image-modal");
      modal.style.display = "none";
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function (event) {
      if (event.key === "Escape") {
        closeImageModal();
      }
    });
  </script>
</body>

</html>