<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digimetrics</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon"
        href="https://mediaonemarketing.com.sg/wp-content/uploads/2023/11/cropped-MediaOne-M-favicon-logo-32x32.png"
        sizes="32x32">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="..." crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <script>
        // Google Sign-In variables (global scope)
        let googleUser = null; // Store the Google user object
        let codeReceiverURI = 'https://ts9k398yn8.execute-api.ap-southeast-1.amazonaws.com/googleLogin'; // Update with your actual URI

        // Function called after successful Google Sign-In
        function handleCredentialResponse(response) {
            fetch(codeReceiverURI, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ credential: response.credential })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.body.success) {
                        googleUser = data.body.user;
                        localStorage.setItem('googleUser', JSON.stringify(googleUser));
                        updateUI(true); // User logged in
                        console.log(data.body);
                        document.getElementById('logoutLink').querySelector('span') = "Logout " + data.body.user.name;
                    } else {
                        console.error("Backend verification failed:", data.message);
                        document.getElementById('loginError').textContent = data.message || "Google login failed.";
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loginError').textContent = "An error occurred.";
                });
        }

        function checkGoogleLogin() {
            const storedUser = localStorage.getItem('googleUser');
            if (storedUser) {
                googleUser = JSON.parse(storedUser);
                updateUI(true); // Already logged in via Google
                return true; // Indicate Google login success
            }

            google.accounts.id.initialize({
                client_id: '365369983219-12iqvk3v35kf03p3ts1gikglddtkofvq.apps.googleusercontent.com',
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.getElementById('googleSignInButton'),
                { theme: "outline", size: "large" }
            );
            return false; // Google login not yet completed
        }

        // Function to update UI based on login status (modified)
        function updateUI(isLoggedIn) {
            document.getElementById('loginForm').style.display = isLoggedIn ? 'none' : 'flex';
            document.getElementById('main-content').style.display = isLoggedIn ? 'block' : 'none';
            document.getElementById('navbar').style.display = isLoggedIn ? 'block' : 'none';

            //Optionally: Display user info after Google login
            if (isLoggedIn && googleUser) {
                // Example: Show username after successful login
                const welcomeMessage = document.createElement('p');
                welcomeMessage.textContent = `Welcome, ${googleUser.name}!`;
                document.getElementById('main-content').prepend(welcomeMessage);  // or wherever you want to display it.
            }
        }

        window.onload = async () => {
            const isLoggedIn = checkGoogleLogin();
            if (!isLoggedIn) {
                // Show the regular login form only if neither Google nor cookie login are active.
                document.getElementById('loginForm').style.display = 'flex';
            }

            try {
                const response = await fetch('https://nud0xqa1h4.execute-api.ap-southeast-1.amazonaws.com/createThreadId', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                document.getElementById('threadId').innerText = data;
                console.log(data);
                //loadFromLocalStorage();

            } catch (error) {
                console.error('Error fetching or parsing thread ID:', error);
                // Handle the error appropriately, e.g., display an error message to the user.
                document.getElementById('threadId').innerText = "Error retrieving thread ID"; // or some other error message
            }
        };

    </script>



    <style>
        #loginForm {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            /* Semi-transparent background */
            z-index: 9999;
            /* Ensure it's on top */
        }

        #loginForm input {
            margin: 10px 0;
            padding: 8px;
            min-width: 40%;
        }

        #loginForm button {
            background-color: #004c9d;
            /* Example color */
            color: white;
            /* Text color */
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #navbar a.active-menu {
            background-color: #0056b3;
            font-weight: bold;
            border-radius: 10px;
        }


        #analysistable th:first-child,
        #analysistable td:first-child {
            position: sticky;
            left: 0;
            background-color: #004c9d;
            color: white;
        }

        thead th {
            position: sticky;
            top: 0;
            /* Stick the header to the top */
            background-color: #004c9d;
            /* Optional: Different background for header */
            z-index: 1;
            /* Ensure header stays above other sticky elements */
        }


        #main-content {
            /* Initially hidden */
            display: none;
        }

        #schema-output {
            white-space: pre-wrap;
            /* Allow line breaks */
            border: 1px solid #ccc;
            padding: 10px;
            font-family: monospace;
        }

        #navbar a i {
            margin-right: 2%;
            /* Adjust spacing as needed */
        }

        #navbar {
            width: 15%;
            background-color: #004c9d;
            color: white;
            padding: 10px;
            position: fixed;
            height: 100%;
            overflow-y: auto;
            border-radius: 10px;
            transition: width 0.3s;
        }

        #navbar img {
            display: block;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 10%;
            margin-top: 10%;
        }

        #navbar a {
            display: block;
            padding: 5px 2px;
            color: white;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        #navbar a:hover {
            background-color: #0056b3;
            border-radius: 10px;
        }

        /* Adjust main content area to accommodate the navbar */
        #main-content {
            flex: 1;
            padding: 10px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 10px;
            background-color: #fbf7f5;
            color: #333;
            text-wrap: wrap;
            font-size: 0.9em;
        }

        input,
        select,
        button,
        textarea {
            padding: 5px 8px;
            margin: 5px;
            border-radius: 10px;
            border: 1px solid #c8c8c8;
            font-family: inherit;
            font-size: 14px;
        }

        button {
            margin: 5px;
            transition: background-color 0.3s, transform 0.1s;
            /* Add transform for a subtle lift effect */
            background-color: #c8c9ca;
        }

        button:hover {
            background-color: #004c9d;
            /* Darker blue on hover */
            transform: translateY(-2px);
            /* Move up slightly on hover */
            cursor: pointer;
            /* Change cursor to a pointer on hover */
            color: white;
        }

        .input-short {
            min-width: 30%;
        }

        textarea {
            min-width: 90%;
            min-height: 50px;
            max-width: 90%;
        }

        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            background-color: #fffef7;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            table-layout: auto;
            display: block;
            table-layout: fixed;
            overflow-y: scroll;
            word-break: break-word;
        }

        #crawlerReport table {
            height: 600px;
        }

        .hidden-table {
            display: none;
        }

        th {
            resize: horizontal;
        }

        #crawlerReport th,
        #crawlerReport td {
            width: 10%;
            /* Adjust as needed for column distribution */
            overflow-x: auto;
            /* white-space: nowrap; Prevent text from wrapping */
            max-width: 200px;
            /* Adjust as needed */
            overflow-x: auto;
            vertical-align: top;
        }

        th,
        td {
            padding: 8px 8px;
            border: 1px solid #ddd;
            font-size: 1em;
            background-color: white;
            overflow: hidden;
        }

        th {
            background-color: #004c9d;
            position: sticky;
            color: white;
            top: 0;
        }

        .error {
            color: red;
            margin-left: 10px;
        }

        .collapsible {
            background-color: #004c9d;
            color: white;
            cursor: pointer;
            padding: 10px;
            width: 99%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .collapsible90 {
            background-color: #004c9d;
            color: white;
            cursor: pointer;
            padding: 10px;
            width: 85%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .collapsible-plus {
            background-color: #004c9d;
            color: white;
            cursor: pointer;
            border: none;
            text-align: left;
            outline: none;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .collapsible:hover {
            background-color: #0056b3;
        }

        .content {
            display: none;
            padding: 5px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 10px;
        }

        button.sort-button {
            padding: 3px 6px;
            font-size: 1em;
            margin-left: 5px;
            background-color: #286b37;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }

        button.sort-button:hover {
            background-color: #218838;
        }

        hr {
            border-top: 4px solid rgb(95, 103, 154);
            border-radius: 7px;
            width: 100%;
        }

        .header-container {
            display: flex;
            align-items: center;
            /* Vertically center the items in the container */
            margin: 20px 0;
            /* Add some margin for spacing around the header */
            background-color: black;
            height: 70px;
            border-radius: 10px;
        }

        .header-container img {
            margin-right: 15px;
            /* Space between the image and the text */
            width: auto;
            /* Adjust the width as needed */
            height: 70%;
        }

        p,
        h1,
        h2,
        h3 {
            text-wrap: wrap;
            font-family: 'Roboto', sans-serif;
        }

        h2 {
            margin-top: 20px;
        }

        h1 {
            margin: 0;
            /* Removes default margin */
            font-size: 1.5em;
            /* Optional: Adjust font size as needed */
        }

        #keywordListContainer {
            display: flex;
            /* Enable Flexbox layout for columns */
            flex-direction: column;
            /* Stack columns vertically */
            max-width: 100%;
            padding: 2px;
        }

        #keywordListContainer h3 {
            font-size: 1em;
            margin-top: 0;
            /* Reduce default margin */
        }

        .keyword-row {
            /* Style each row */
            display: flex;
            /* Use Flexbox for each row */
            align-items: center;
            /* Vertically center content in each row */
            margin-bottom: 5px;
            max-width: 65%;
        }

        .keyword-column {
            /* Style for each column */
            flex: 1;
            /* Each column takes equal width */
            margin-right: 5px;
            /* Space between columns */
            min-width: 50px;
        }

        .keyword-column:hover {
            font-size: 1em;
            cursor: pointer;
        }

        .keyword-column:nth-child(1) {
            /* Keyword column */
            flex: 0 0 60%;
        }

        .keyword-column:nth-child(2) {
            /* Search Volume column */
            flex: 0 0 30%;
        }

        .keyword-column:nth-child(3) {
            /* Difficulty column */
            flex: 0 0 22%;
        }

        input[type="checkbox"] {
            width: 3em;
        }


        .checkbox-column {
            flex: 0 0 5%;
            margin-right: 0;
        }

        .column {
            float: left;
            width: 50%;
        }

        .column60 {
            float: left;
            width: 60%;
        }

        .column40 {
            float: left;
            width: 40%;
        }

        .column50 {
            float: left;
            width: 48%;
            padding: 1%;
        }

        ul {
            max-height: 350px;
            overflow: auto;
            width: 100%;
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: Window;
        }

        li {
            margin: 5px;
            padding: 0px;
            align-items: left;
        }

        label,
        label-fixed {
            color: WindowText;
            margin: 0;
            padding: 0;
            width: 100%;
        }

        .label-short {
            width: 100%;
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 2em;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #auditSummary table {
            width: 50%;
            float: right;
            padding: 10px;
            height: 560px;
        }

        /* Table styling */
        #analysisTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            /* Remove display: block and table-layout: fixed  */
            max-height: 700px;
            /* Or whatever max height you want */
            overflow: auto;
            /* Scrollbars appear only when needed */
        }

        #analysisTable a {
            color: white;
        }

        #analysisTable th,
        #analysisTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            word-wrap: break-word;
            vertical-align: top;
            /* Align content to the top of each cell */
        }

        /* Make the table scrollable if it's too wide */
        #tableContainer {
            width: 100%;
            overflow-x: auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #SEM .column {
            width: 48%;
            /* Adjust as needed */
            float: left;
            /* Float columns side by side */
            margin-right: 2%;
            /* Add spacing between columns */
            box-sizing: border-box;
            /* Include padding and border in width calculation */
        }

        #SEM .column:last-child {
            margin-right: 0;
            /* No margin on the last column */
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 3em;
            height: 1.5em;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 1em;
            width: 1em;
            left: 4%;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #004c9d;
        }

        input:focus+.slider {
            box-shadow: 0 0 1px #004c9d;
        }

        input:checked+.slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }


        .toggle-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .toggle-label {
            margin-right: 10px;
        }

        .toggle-label-right {
            margin-left: 10px;
        }

        .header-container img {
            margin-left: 20px;
            width: 400px;
            height: auto;
        }

        .faq-item {
            display: flex;
            align-items: flex-start;
            /* Align to top */
            margin-bottom: 10px;
        }

        .faq-item input,
        .faq-item textarea {
            flex-grow: 1;
            margin-right: 10px;
            min-width: 0;
            /* Prevent inputs from taking minimum width */
        }

        .faq-item textarea {
            min-height: 80px;
        }

        #navbar ul {
            list-style: none;
            padding: 0;
            margin: 0;
            background-color: #004c9d;
            max-height: None;
        }

        #navbar li {
            padding-left: 10px;
            /* Base indentation */
        }

        #navbar li ul li {
            padding-left: 20px;
            /* Increased indentation for sub-items */
        }

        /* You can add more levels as needed */
        #navbar li ul li ul li {
            padding-left: 30px;
        }

        .keyword-count {
            margin-left: 10px;
            color: #004c9d;
        }

        #downloadResultsBtn {
            display: none;
            /* Initially hidden */
            margin-top: 20px;
        }

        #navbar li a#logoutLink {
            display: block;
            color: white;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        #navbar li a#logoutLink:hover {
            background-color: #0056b3;
            /* Match hover effect of other links */
            border-radius: 10px;
        }

        #navbar li a#logoutLink i {
            /* Icon styling if needed */
            margin-right: 2%;
        }

        #navbar .submenu {
            display: none;
            /* Hide submenus by default */
        }


        .tooltip {
            position: relative;
            /* Make the button position its children */
            display: inline-block;
            /* Necessary for relative positioning to work */
        }

        .tooltip span {
            position: absolute;
            z-index: 10;
            left: 50%;
            /* Center horizontally */
            transform: translateX(-50%);
            /* Center horizontally */
            bottom: calc(100% + 5px);
            /* Position below the button */
            min-width: 200px;
            max-width: 500px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            opacity: 0;
            visibility: hidden;
            /* Hide initially */
            transition: opacity 0.3s, visibility 0.3s;
            border-radius: 15px;
            font-size: 0.9em;
        }

        .tooltip:hover span {
            opacity: 1;
            visibility: visible;
        }

        #overall-summary .table-container table {
            width: 100%;
            /* Ensure the table takes up full container width */
            table-layout: auto;
            /* Let the browser calculate column widths */
        }

        #overall-summary .table-container th,
        #overall-summary .table-container td {
            white-space: normal;
            word-break: break-word;
            max-width: none;
            /* Remove max-width restrictions */
            padding: 8px;
            /* Added padding for better readability */
            vertical-align: top;
            /* Align content to the top */
        }

        #overall-summary .table-container th:nth-child(1),
        /* Column number */
        #overall-summary .table-container td:nth-child(1) {
            width: 5%;
            /* Column number width */
        }

        #overall-summary .table-container th:nth-child(2),
        /* Column KW */
        #overall-summary .table-container td:nth-child(2) {
            width: 25%;
            /* Column KW width */
        }

        #overall-summary .table-container th:nth-child(3),
        /* Column SV */
        #overall-summary .table-container td:nth-child(3) {
            width: 10%;
            /* Column SV width */
        }

        #overall-summary .table-container th:nth-child(4),
        /* Column CPC */
        #overall-summary .table-container td:nth-child(4) {
            width: 5%;
            /* Column CPC width */
        }

        #overall-summary .table-container th:nth-child(5),
        /* Column Time */
        #overall-summary .table-container td:nth-child(5) {
            width: 15%;
            /* Column Time width */
        }

        #overall-summary .table-container th:nth-child(6),
        /* Column Reason */
        #overall-summary .table-container td:nth-child(6) {
            width: 40%;
            /* Column Reason width */
        }

        #overall-summary .table-container textarea {
            width: 100%;
            /* Make textareas fill the column width */
            box-sizing: border-box;
            /* Include padding and border in the width */
            height: 80px;
            /* Set an initial height for the textareas */
            resize: vertical;
            /* Allow vertical resizing */
            font-family: inherit;
        }

        .keywords-collapsible {
            min-width: 100%;
            text-align: left;
            margin: 1px;
        }

        .time-to-rank-0-3 {
            background-color: #c6efc6;
            /* Example: Light green */
        }

        .time-to-rank-3-6 {
            background-color: #9bd3ae;
            /* Example: Medium green */
        }

        .time-to-rank-6-9 {
            background-color: #ffda66;
            /* Example: Yellow */
        }

        .time-to-rank-9-12 {
            background-color: #fbb668;
            /* Example: Orange */
        }

        .time-to-rank-more-than-12 {
            background-color: #f4746b;
            /* Example: Red */
        }

        .media-plan-checkbox {
            min-width: 0%;
        }

        /* The Modal (background) */
        .feedback-modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 1;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
        }

        .modal-content {
            display: block;
            position: fixed;
            /* Stay in place */
            z-index: 1;
            /* Sit on top */
            left: 5%;
            top: 5%;
            width: 90%;
            /* Full width */
            height: auto;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: #fefefe;
            border-radius: 10px;
            padding: 1%;
            border: 3px solid #ccc;
        }

        /* Modal Content/Box */
        .feedback-modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 60%;
            /* Could be more or less, depending on screen size */
            border-radius: 10px;
        }

        /* The Close Button */
        .feedback-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .feedback-close:hover,
        .feedback-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .funnel-container {
            width: 90%;
            margin: 20px auto;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .funnel-collapsible-before {
            color: white;
            cursor: pointer;
            padding: 20px;
            width: 100%;
            border: none;
            text-align: center;
            outline: none;
            transition: background-color 0.8s ease;
            border-radius: 50px;
            font-size: 1em;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        .funnel-collapsible {
            color: white;
            cursor: pointer;
            padding: 20px;
            width: 100%;
            border: none;
            text-align: center;
            outline: none;
            transition: background-color 0.8s ease;
            border-radius: 50px 50px 0px 0px;
            font-size: 1em;
            box-sizing: border-box;
            margin: 0px;
        }

        .funnel-content {
            width: 100%;
            display: none;
            padding: 20px;
            border-radius: 0px 0px 50px 50px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .gauge {
            width: 100%;
            max-width: 250px;
            font-family: "Roboto", sans-serif;
            font-size: 18px;
            font-weight: bolder;
            color: #686868;
        }

        .gauge__body {
            width: 100%;
            height: 0;
            padding-bottom: 50%;
            background: linear-gradient(90deg, rgba(253, 29, 29, 1) 0%, rgb(245, 229, 0) 50%, rgba(33, 255, 68, 1) 100%);
            position: relative;
            border-top-left-radius: 100% 200%;
            border-top-right-radius: 100% 200%;
            overflow: hidden;
        }

        .gauge__fill {
            position: absolute;
            top: 100%;
            left: 0;
            width: inherit;
            height: 100%;
            transform-origin: center top;
            transform: rotate(0.25turn);
            transition: transform 0.2s ease-out;
            border: 2.5px solid #5d5d5d;
            /* Solid border for a more defined outline */
        }

        .gauge__cover {
            width: 75%;
            height: 150%;
            background: #f0f0f0;
            border-radius: 50%;
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-bottom: 25%;
            box-sizing: border-box;
            text-align: center;
        }

        .collapsible i {
            /* Style all icons within .collapsible */
            margin-right: 1em;
            /* or padding-right: 0.5em;  Adjust the value as needed */
        }

        /* Styles for smaller screens (e.g., mobile) */

        .checkbox-wrapper-25 input[type="checkbox"] {
            background-image: -webkit-linear-gradient(hsla(0, 0%, 0%, .1), hsla(0, 0%, 100%, .1)),
                -webkit-linear-gradient(left, #f66 50%, rgb(0, 164, 90) 50%);
            background-size: 100% 100%, 200% 100%;
            background-position: 0 0, 15px 0;
            border-radius: 25px;
            box-shadow: inset 0 1px 4px hsla(0, 0%, 0%, .5),
                inset 0 0 10px hsla(0, 0%, 0%, .5),
                0 0 0 1px hsla(0, 0%, 0%, .1),
                0 -1px 2px 2px hsla(0, 0%, 0%, .25),
                0 2px 2px 2px hsla(0, 0%, 100%, .75);
            cursor: pointer;
            height: 25px;
            padding: 0px 25px 0px 0px;
            -webkit-appearance: none;
            -webkit-transition: .25s;
            min-width: 50px;
        }

        .checkbox-wrapper-25 input[type="checkbox"]:after {
            background-color: #eee;
            background-image: -webkit-linear-gradient(hsla(0, 0%, 100%, .1), hsla(0, 0%, 0%, .1));
            border-radius: 25px;
            box-shadow: inset 0 1px 1px 1px hsla(0, 0%, 100%, 1),
                inset 0 -1px 1px 1px hsla(0, 0%, 0%, .25),
                0 1px 3px 1px hsla(0, 0%, 0%, .5),
                0 0 2px hsla(0, 0%, 0%, .25);
            content: '';
            display: block;
            height: 25px;
            width: 25px;
        }

        .checkbox-wrapper-25 input[type="checkbox"]:checked {
            background-position: 0 0, 35px 0;
            padding-left: 25px;
            padding-right: 0;
        }

        .mediaPlanPersonaResults {
            max-height: 500px;
            overflow: auto;
            display: none;
        }

        /* The Modal (background) */
        .feedback-modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 1002;
            /* Ensure it's on top of chatbot-modal */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
        }

        /* Modal Content/Box */
        .feedback-modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            /* Could be more or less, depending on screen size */
            border-radius: 10px;
            position: relative;
            /* Add this */
            z-index: 1002;
            /* Ensure it's on top */
        }

        #chatbot-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            /* Lower z-index than feedback modal */
            width: 60%;
            border: 5px solid #bababa;
            height: 80%;
        }

        #chat-messages {
            overflow-y: scroll;
            margin-bottom: 10px;
            padding: 10px;
            height: 83%;
        }

        .message {
            padding: 8px 12px;
            border-radius: 20px;
            margin-bottom: 8px;
            clear: both;
            /* Prevents floating issues */
            max-width: 70%;
            /* Limits bubble width */
            word-wrap: break-word;
            /* Long words don't break the layout */
        }

        .user {
            background-color: #DCF8C6;
            /* Light green for user */
            float: right;
            /* Align user messages to the right */
        }

        .chatbot {
            background-color: #ECE5DD;
            /* Light gray for chatbot */
            float: left;
            /* Align chatbot messages to the left */
        }

        #question-input {
            flex-grow: 1;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            min-width: 70%;
        }

        .collapsible-icon {
            margin-right: 5px;
            /* Changed from margin-left to margin-right */
            cursor: pointer;
            /*  Change cursor on hover */
            font-size: larger;
            /* Adjust size of the icon as needed */
            transition: transform 0.2s ease-in-out;
            /* Smooth animation when changing */
        }

        .collapsible-icon.open {
            transform: rotate(45deg);
            /* Rotate to become a "x" sign when open */
        }

        #seo-submenu.submenu.show,
        #smm-submenu.submenu.show {
            display: block;
        }

        #seo-submenu.submenu,
        #smm-submenu.submenu {
            display: none;
        }

        #metaTable td:nth-child(1) {
            width: 15%;
            /* Adjust this value as needed */
            word-break: break-word;
            /* Prevent overflow by breaking long words */
        }

        #metaTable td:nth-child(2) {
            width: 20%;
            /* Adjust this value as needed */
            word-break: break-word;
            /* Prevent overflow by breaking long words */
        }

        #metaTable td:nth-child(3) {
            width: 30%;
            /* Adjust this value as needed */
            word-break: break-word;
            /* Prevent overflow by breaking long words */
        }

        #imageTable img {
            max-width: 80px;
            max-height: 80px;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
            /* Center the images */
        }


        #imageTable td:nth-child(2) {
            width: 20%;
            /* Adjust this value as needed */
            word-break: break-word;
        }

        #imageTable td:nth-child(4) {
            width: 30%;
            /* Adjust this value as needed */
            word-break: break-word;
        }

        #imageTable td:nth-child(5) {
            width: 30%;
            /* Adjust this value as needed */
            word-break: break-word;
        }

        #contentTable td:nth-child(1) {
            text-align: center;
            padding: 10px;
        }

        #contentTable td:nth-child(2) {
            width: 30%;
            /* Adjust this value as needed */
            word-break: break-word;
            padding: 10px;
        }

        #contentTable td:nth-child(3) {
            width: 36%;
            /* Adjust this value as needed */
            word-break: break-word;
        }

        #contentTable td:nth-child(4) {
            width: 32%;
            /* Adjust this value as needed */
            word-break: break-word;
            padding: 10px;
        }

        .queries-modal {
            display: none;
            position: fixed;
            z-index: 20;
            left: 5%;
            top: 5%;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            overflow: auto;
        }

        .queries-modal-content {
            background-color: #fefefe;
            padding: 20px;
            border: 1px solid #888;
            width: fit-content;
            border-radius: 20px;
            /* Could be more or less, depending on screen size */
        }

        css to set width of individual columns in table in div id modalContent #modalContent table {
            width: 100%;
            /* Ensure the table takes up the full width of the modal */
            table-layout: fixed;
            /* Crucial for fixed column widths */
        }

        #modalContent table {
            width: 100%;
            /* Ensure the table takes up the full width of the modal */
            table-layout: fixed;
            /* Crucial for fixed column widths */
            border-collapse: collapse;
            /* Good to have for consistent borders */
            word-break: break-word;
        }

        #modalContent table tr {
            height: 10px;
        }

        #modalContent th:nth-child(1),
        #modalContent td:nth-child(1) {
            width: 10%;

        }

        #modalContent th:nth-child(2),
        #modalContent td:nth-child(2) {
            max-width: 20%;
        }

        #modalContent th:nth-child(3),
        #modalContent td:nth-child(3) {
            max-width: 20%;
        }

        #modalContent th:nth-child(4),
        #modalContent td:nth-child(4) {
            max-width: 30%;
        }

        #modalContent th:nth-child(5),
        #modalContent td:nth-child(5) {
            width: 10%;
        }

        /* Add this rule to your existing CSS */
        #logoutNavItem {
            margin-left: auto;
        }

        @media screen and (max-width: 1081px) {

            .column,
            .column40,
            .column60 {
                width: 100%;
            }

            #SEM .column {
                width: 100%;
            }
        }

        @media screen and (max-width: 900px) {

            .content {
                width: 100%;
            }


            .header-container img {
                margin-right: 5%;
                /* Space between the image and the text */
                width: 80%;
                /* Adjust the width as needed */
                height: auto;
            }

            .collapsible-icon {
                display: none;
            }

            #navbar {
                width: 60px;
                /* Reduced width for smaller screens */
            }

            #navbar img {
                width: 100%;
                /* Smaller logo */
            }

            #navbar span {
                display: none;
                /* Hide text labels */
            }

            .column,
            .column40,
            .column60,
            .column50 {
                width: 100%;
            }

            .toggle-label {
                margin-right: 10px;
            }

            .toggle-label-right {
                margin-left: 10px;
            }

            #SEM .column {
                width: 100%;
            }

            .sliderMobile {
                min-width: 20px;
            }

            input:checked+.slider:before {
                -webkit-transform: translateX(18px);
                -ms-transform: translateX(18px);
                transform: translateX(18px);
            }

            #navbar li ul li {
                padding-left: 0px;
                /* Increased indentation for sub-items */
            }

            .toggle-label,
            .toggle-label-right {
                font-size: 0.75em;
            }
        }

        /* Style the navbar */
        .navbar {
            background-color: #21468B;
            display: flex;
            align-items: center;
            padding: 0.05%;
            color: white;
            position: relative;
            z-index: 2;
            border-radius: 10px;
        }

        /* Logo Container */
        .logo-container {
            width: 150px;
            text-align: center;
            padding-right: 30px;
        }

        .logo-container img {
            padding-left: 20px;
            height: 15px;
        }

        /* Style the nav links */
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            /* Important: Needed for dropdown positioning */
        }

        .nav-item>a {
            color: white;
            text-decoration: none;
            font-size: 16px;
            padding: 8px 40px;
            text-align: center;
            display: block;
        }

        /* Style the dropdown content (hidden by default) */
        .dropdown-content {
            display: none;
            /* Important: Hidden by default */
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 3;
            top: 100%;
            /* Position below the nav item */
            left: 50%;
            /* Center horizontally */
            transform: translateX(-50%);
            /* Adjust centering */
            border-radius: 10px;
            box-sizing: border-box;
            /* Important: Keep padding within the element's width */
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
        }

        /* Change color on hover */
        .nav-item:hover a {
            background-color: #ddd;
            color: black;
        }

        .dropdown-content a:hover {
            background-color: #ddd;
        }

        /* Show the dropdown menu on hover */
        .nav-item:hover .dropdown-content {
            display: block;
            /* This line makes the dropdown visible */
        }

        /* Mobile adjustments (example) */
        @media screen and (max-width: 600px) {
            .navbar {
                flex-direction: column;
                align-items: left;
            }

            .nav-item {
                width: 100%;
            }

            .nav-item>a {
                text-align: left;
            }

            .dropdown-content {
                position: relative;
                left: 0;
                transform: none;
                width: 100%;
                box-shadow: none;
            }

            .nav-item:hover .dropdown-content {
                display: none;
            }

            .nav-item.show .dropdown-content {
                display: block;
            }

            .nav-item.show {
                background-color: #ddd;
                color: black;
            }

            .nav-item.show>a {
                color: black;
                background-color: #ddd;
            }
        }
    </style>
</head>

<body>

    <div id="loginForm">
        <div id="googleSignInButton"></div>
        <p id="loginError" style="color: red;"></p>
    </div>

    <div class="navbar">
        <div class="logo-container">
            <img src="Digimetrics Logo-02.png" alt="MediaOne Logo" href="/">
        </div>

        <div class="nav-item" id="seoNavItem">
            <a href="#">SEO</a>
            <div class="dropdown-content">
                <a href="#keywordAnalysis" onclick="openKeywordAnalysis(event)">Keyword Analysis</a>
                <a href="#technicalSeo" onclick="openTechnicalSeo(event)">Technical SEO</a>
                <a href="#contentComparison" onclick="openContentComparison(event)">Content Comparison</a>
                <a href="#schemaGeneratorButton" onclick="openSchemaGenerator(event)">Schema Generator</a>
                <a href="#onPageSection" onclick="openOnPage(event)">On-Page</a>
                <a href="#rankCheckerSection" onclick="openRankChecker(event)">Rank Checker</a>
            </div>
        </div>

        <div class="nav-item" id="smmNavItem">
            <a href="#">SMM</a>
            <div class="dropdown-content">
                <a href="#contentGenerator" onclick="openContentGenerator(event)">Content Generator</a>
            </div>
        </div>

        <div class="nav-item">
            <a href="#" onclick="openSem(event)">SEM</a>
        </div>

        <div class="nav-item" id="othersNavItem">
            <a href="#">Others</a>
            <div class="dropdown-content">
                <a href="#" onclick="openCompetitors(event)">Competitors Identifier</a>
                <a href="#personaContent" onclick="openPersona(event)">Persona Generator</a>
                <a href="#mediaplan" onclick="openMediaPlan(event)">Media Plan</a>
                <a href="#" onclick="openContentCheck(event)">Content Check</a>
                <a href="#" onclick="openLandingPageAudit(event)">Landing Page Audit</a>
            </div>
        </div>


        <div class="nav-item" id="logoutNavItem">
            <a href="#" onclick="logout(event)">Logout Kenneth</a>
        </div>


    </div>
    <div id="main-content">

        <div id="chatbot-modal">
            <div style="display: none;" id="threadId"></div>
            <div style="display: none;" id="previous-response-id"></div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Chat with Digimetrics AI</h2>
                <button id="close-chatbot"
                    style="background: none; border: none; font-size: 25px; cursor: pointer;">×</button>
            </div>
            <div id="chat-messages"></div>
            <div style="display: flex;">
                <input type="text" id="question-input" placeholder="Type your question...">
                <button id="send-button-2">Send</button>
            </div>
        </div>

        <button class="collapsible" id="seo"><i class="fas fa-plus-square"></i><i class="fab fa-google"></i>Search
            Engine Optimisation (SEO)</button>
        <div class="content" id="seoSection">

            <!-- Modal for Content Comparison Queries -->
            <div id="contentComparisonkModal" class="queries-modal" style="display:none">
                <div class="queries-modal-content">
                    <span class="close" onclick="closeContentComparisonQueriesModal()">×</span>
                    <h2>Previous Content Comparison Queries</h2>
                    <div id="content_comparison_loading"
                        style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; /* Adjust height as needed */">
                        <img src="https://usagif.com/wp-content/uploads/loading-73.gif" alt="Loading..."
                            style="width: 100px; height: 100px;">
                        <p style="text-align: center;">Loading queries...</p>
                    </div>

                    <table id="contentComparisonQueriesTable">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Date</th>
                                <th>URL</th>
                                <th>Keywords</th>
                                <th>User</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Queries will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Modal for Previous Time To Rank Queries -->
            <div id="timeToRankModal" class="queries-modal" style="display:none">
                <div class="queries-modal-content">
                    <span class="close" onclick="closeTimeToRankQueriesModal()">×</span>
                    <h2>Previous Time To Rank Queries</h2>
                    <div id="time_to_rank_loading"
                        style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; /* Adjust height as needed */">
                        <img src="https://usagif.com/wp-content/uploads/loading-73.gif" alt="Loading..."
                            style="width: 100px; height: 100px;">
                        <p style="text-align: center;">Loading queries...</p>
                    </div>

                    <table id="timeToRankQueriesTable">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Date</th>
                                <th>URL</th>
                                <th>Keywords</th>
                                <th>User</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Queries will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Modal for Previous On-Page Queries -->
            <div id="queriesModal" class="queries-modal" style="display:none">
                <div class="queries-modal-content">
                    <span class="close" onclick="closeQueriesModal()">×</span>
                    <h2>Previous On-Page Queries</h2>

                    <div id="on_page_loading"
                        style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; /* Adjust height as needed */">
                        <img src="https://usagif.com/wp-content/uploads/loading-73.gif" alt="Loading..."
                            style="width: 100px; height: 100px;">
                        <p style="text-align: center;">Loading queries...</p>
                    </div>

                    <table id="queriesTable">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Date</th>
                                <th>URL</th>
                                <th>Keywords</th>
                                <th>User</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Queries will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="feedbackModal" class="feedback-modal">
                <div class="feedback-modal-content">
                    <span class="feedback-close">×</span>
                    <h2>Feedback</h2>

                    <label for="userFeedback">Your Feedback:</label>
                    <textarea id="userFeedback"
                        style="width: 100%; height: 100px; background-color:#eef5fe;"></textarea><br>

                    <label for="checkResults">Check Results:</label>
                    <textarea id="checkResults" readonly style="width: 100%; height: 100px;"></textarea><br>

                    <label for="guidelinesURLs">URLs of Guidelines PDFs:</label>
                    <textarea id="guidelinesURLs" readonly style="width: 100%; height: 20px;"></textarea><br>

                    <label for="websiteURLs">Any other website/guidelines URLs:</label>
                    <textarea id="websiteURLs" readonly style="width: 100%; height: 20px;"></textarea><br>

                    <label for="otherInstructions">Any other instructions:</label>
                    <textarea id="otherInstructions" readonly style="width: 100%; height: 20px;"></textarea><br>

                    <label for="contentToCheck">Content to Check:</label>
                    <textarea id="contentToCheck" readonly style="width: 100%; height: 30px;"></textarea><br>

                    <button id="submitFeedbackBtn">Submit Feedback</button>
                </div>
            </div>

            <!-- Input Form for User Data -->
            <div class="column50">
                <form id="seoForm">
                    <label-fixed for="domain">Domain / URL:</label-fixed>
                    <input type="url" id="domain" name="domain" style="min-width: 60%"
                        placeholder="Site Audit: https://www.abc.com | Page Audit: www.abc.com">
                    <span class="error" id="domainError"></span>
                    <br>
                    <label-fixed for="location">Targeted Location (required):</label-fixed>
                    <select id="location" name="location" required>
                        <option value="Singapore">Singapore</option>
                        <option value="None">Global</option>
                        <option value="Australia">Australia</option>
                        <option value="Bhutan">Bhutan</option>
                        <option value="Brazil">Brazil</option>
                        <option value="Canada">Canada</option>
                        <option value="China">China</option>
                        <option value="France">France</option>
                        <option value="Germany">Germany</option>
                        <option value="India">India</option>
                        <option value="Indonesia">Indonesia</option>
                        <option value="Italy">Italy</option>
                        <option value="Japan">Japan</option>
                        <option value="Malaysia">Malaysia</option>
                        <option value="Mexico">Mexico</option>
                        <option value="Netherlands">Netherlands</option>
                        <option value="Netherlands">Philippines</option>
                        <option value="South Korea">South Korea</option>
                        <option value="Spain">Spain</option>
                        <option value="Thailand">Thailand</option>
                        <option value="United Kingdom">United Kingdom</option>
                        <option value="United States">United States</option>
                        <option value="Vietnam">Vietnam</option>
                    </select>

                    <label-fixed for="language">Language (required):</label-fixed>
                    <select id="language" name="language" required>
                        <option value="English">English</option>
                        <option value="Arabic">Arabic</option>
                        <option value="Chinese (Simplified)">Chinese (Simplified)</option>
                        <option value="Chinese (Traditional)">Chinese (Traditional)</option>
                        <option value="Dutch">Dutch</option>
                        <option value="French">French</option>
                        <option value="German">German</option>
                        <option value="Hindi">Hindi</option>
                        <option value="Indonesian">Indonesian</option>
                        <option value="Italian">Italian</option>
                        <option value="Japanese">Japanese</option>
                        <option value="Korean">Korean</option>
                        <option value="Malay">Malay</option>
                        <option value="Portuguese">Portuguese</option>
                        <option value="Russian">Russian</option>
                        <option value="Spanish">Spanish</option>
                        <option value="Tamil">Tagalog</option>
                        <option value="Tamil">Tamil</option>
                        <option value="Thai">Thai</option>
                        <option value="Vietnamese">Vietnamese</option>
                    </select>
                    <br>
                    <div>
                        <label-fixed for="keywords">Keyword(s) of Interest (comma or newline separated):</label-fixed>
                        <span id="keywordCount" style="margin-left: 10px; color: #004c9d;"></span><br> <textarea
                            id="keywords" name="keywords" required placeholder="keyword1, keyword2"
                            oninput="updateKeywordCount()"></textarea>
                        <span class="error" id="keywordsError"></span>
                    </div>

                    <button type="button" id="keyword-research-analysis-button" class="tooltip"
                        onclick="validateAndSubmit(event)">Get Time To Rank
                        <span>Click to get the estimated time to rank for the selected keywords and the webpage's
                            metrics.</span>
                    </button>
                    <button onclick="openTimeToRankQueriesModal()" id="loadTimeToRankQueriesBtn">Load Previous
                        Queries</button>
                </form>
                <div id="rankingError"></div>
                <table id="keywordTable" style="display: none;">
                    <tr>
                        <th>Keyword</th>
                        <th>Search Volume</th>
                        <th>Competition</th>
                        <th>Rank</th>
                    </tr>
                </table>

                <table id="top100Table" style="display: none;">
                    <tr>
                        <th>Keyword</th>
                        <th>Search Volume</th>
                        <th>Competition</th>
                        <th>Rank</th>
                    </tr>
                </table>
                <button class="collapsible-plus" id="expandSimilarKeywords"><i class="fas fa-plus-square"></i></button>
                <button class="collapsible90" id="keyword_suggestions" onclick="similarKeywords(event)">Keyword
                    Suggestions (Similar Keywords / SERPs)
                </button>
                <div class="content" id="keywordSuggestions">
                    <div id="keywordListContainer">
                        <div class="keyword-row" id="keywordHeaderRow">
                            <div class="keyword-column tooltip" onclick="sortKeywordSuggestions(0)">
                                <strong>Keyword</strong>
                                <span>Click on the keyword to see it's SERPs.</span>
                            </div>
                            <div class="keyword-column" onclick="sortKeywordSuggestions(1)">
                                <strong>Search Vol</strong>
                            </div>
                            <div class="keyword-column" onclick="sortKeywordSuggestions(2)">
                                <strong>Difficulty</strong>
                            </div>
                            <div class="keyword-column" onclick="sortKeywordSuggestions(3)">
                                <strong>CPC</strong>
                            </div>
                            <div class="checkbox-column"></div><strong>Choose</strong>
                        </div>
                        <ul id="keywordList"></ul>
                        <div id="keywordSuggestionsExport" style="display:none">
                            <button type="button"
                                onclick="exportSelectedKeywordSuggestionsToCSV(keywordHeaderRow, keywordList)">Export
                                selected as
                                .csv</button>
                            <button type="button"
                                onclick="exportKeywordSuggestionsToCSV(keywordHeaderRow, keywordList)">Export all as
                                .csv</button>
                        </div>
                    </div>
                </div>

                <br>
                <button class="collapsible-plus" id="expandRankingKeywords"><i class="fas fa-plus-square"></i></button>
                <button class="collapsible90" id="ranking_keywords" onclick="rankingKeywords(event)">Ranking
                    Keywords</button>
                <div class="content" id="rankingKeywords">
                    <div id="rankedKeywordsCount"></div>
                    <div id="keywordListContainer">
                        <div class="keyword-row" id="rankedKeywordHeaderRow">
                            <div class="keyword-column" onclick="sortRankedKeywords(0)">
                                <strong>Keyword</strong>
                            </div>
                            <div class="keyword-column" onclick="sortRankedKeywords(1)">
                                <strong>Search Vol</strong>
                            </div>
                            <div class="keyword-column" onclick="sortRankedKeywords(2)">
                                <strong>Rank</strong>
                            </div>
                            <div class="keyword-column" onclick="sortRankedKeywords(3)">
                                <strong>Difficulty</strong>
                            </div>
                            <div class="checkbox-column"></div><strong>Choose</strong>
                        </div>
                        <ul id="rankedKeywordList"></ul>
                        <div id="rankingKeywordsExport" style="display:none">
                            <button type="button"
                                onclick="exportSelectedRankedKeywordsToCSV(rankedKeywordHeaderRow, rankedKeywordList)">Export
                                selected as
                                .csv</button>
                            <button type="button"
                                onclick="exportRankedKeywordsToCSV(rankedKeywordHeaderRow, rankedKeywordList)">Export
                                all as
                                .csv</button>
                        </div>
                    </div>
                </div><br>
                <button class="collapsible-plus" id="expandWebpageKeywords"><i class="fas fa-plus-square"></i></button>
                <button class="collapsible90" id="keywords_for_site" onclick="getWebpageKeywords(event)">Keywords Based
                    on Webpage Content</button>
                <div class="content" id="siteKeywords" style="padding:10px">
                </div>
            </div>

            <div class="column50">
                <div id="serp-section"></div>
            </div>


            <hr>
            <button class="collapsible" id="meta_data"><i class="fas fa-plus-square"></i>Meta Data</button>
            <div class="content" id="metaData">
                <p><b>Meta Title: </b><span id="targetTitle">-</span></p>
                <p><b>Meta Description: </b><span id="targetDescription">-</span></p>
                <p><b>h1 Header: </b><span id="targetH1">-</span></p>

            </div>

            <button class="collapsible" id="domain_metrics"><i class="fas fa-plus-square"></i>Domain Metrics (DA, PA,
                PageSpeed)</button>
            <div class="content" id="domainMetrics">
                <div class="column">
                    <p><b>Domain Authority (DA): </b><span id="da">-</span></p>
                    <p><b>Page Authority (PA): </b><span id="pa">-</span></p>
                    <p><b>Backlinks Spam Score: </b><span id="targetSpamScore">-</span></p>
                    <p><b>Backlinks: </b><span id="targetBacklinks">-</span></p>
                    <p><b>Referring Domains: </b><span id="targetRefDomains">-</span></p>
                    <p><b>Page Word Count: </b><span id="targetWordCount">-</span></p>
                </div>
                <div class="column">
                    <p><b>Internal Links: </b><span id="targetInternalLinks">-</span></p>
                    <p><b>External Links: </b><span id="targetExternalLinks">-</span></p>
                    <p><b>Flesch Readability: </b><span id="targetReadability">-</span></p>
                    <p><b>Images: </b><span id="targetImages">-</span></p>
                    <p><b>CLS: </b><span id="targetCls">-</span></p>
                    <p><b>LCP: </b><span id="targetLcp">-</span></p>
                    <p><b>FID: </b><span id="targetFid">-</span></p>
                    <p><b>Schema: </b><span id="targetSchema">-</span></p>
                </div>
                <div style="clear: both;"></div>
                <div> </div> <!-- Clearfix -->
            </div>
            <hr>
            <button class="collapsible" id="keywordAnalysisBtn"><i class="fas fa-plus-square"></i>Keyword
                Analysis</button>
            <div class="content" id="keywordAnalysis">
                <div id="overall-summary" style="display:none;"></div>
                <div id="keyword-analysis-results">
                    <!-- Collapsible sections for each keyword analysis will be added here -->
                </div>
            </div>
            <hr>
            <button class="collapsible" id="technicalButton"><i class="fas fa-plus-square"></i>Technical SEO</button>
            <div class="content" id="technicalSeo">
                <label for="urlInput">Enter URL:</label>
                <input type="text" id="urlInput">
                <br>
                <label for="maxPagesInput">Max Pages to Crawl:</label>
                <input type="number" id="maxPagesInput" value="10">

                <button id="submitBtn">Analyse Website</button>

                <br><br>

                <div id="auditSummary"></div>

                <button class="collapsible" id="gtButton"><i class="fas fa-plus-square"></i>GTmetrix Results</button>
                <div class="content" id="gtMetrix">
                    <div id="gtmetrixReport" style="display:none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Report URL</td>
                                    <td id="reportUrl"></td>
                                </tr>
                                <tr>
                                    <td>Cumulative Layout Shift</td>
                                    <td id="cls"></td>
                                </tr>
                                <tr>
                                    <td>Largest Contentful Paint</td>
                                    <td id="lcp"></td>
                                </tr>
                                <tr>
                                    <td>Total Blocking Time</td>
                                    <td id="tbt"></td>
                                </tr>
                                <tr>
                                    <td>GTmetrix Grade</td>
                                    <td id="grade"></td>
                                </tr>
                                <tr>
                                    <td>GTmetrix Performance Score</td>
                                    <td id="performance"></td>
                                </tr>
                            </tbody>
                        </table>
                        <br><br>
                    </div>
                </div>

                <button class="collapsible" id="pageButton"><i class="fas fa-plus-square"></i>Page Analysis
                    Results</button>
                <div class="content" id="pageAnalysis">
                    <div id="pageAuditReport" style="display:none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>PageSpeed (Mobile)</td>
                                    <td id="pagespeed_audit"></td>
                                </tr>
                                <tr>
                                    <td>Malware</td>
                                    <td id="malware"></td>
                                </tr>
                                <tr>
                                    <td>robots.txt</td>
                                    <td id="robots"></td>
                                </tr>
                                <tr>
                                    <td>Sitemap</td>
                                    <td id="sitemap"></td>
                                </tr>
                            </tbody>
                        </table>
                        <br><br>
                    </div>
                </div>

                <button class="collapsible" id="crawlerButton"><i class="fas fa-plus-square"></i>Crawler Report</button>
                <div class="content" id="crawlerSection">
                    <div id="crawlerReport" style="display:none;">
                        <table>
                            <thead>
                                <tr>
                                    <th>URL</th>
                                    <th>Code</th>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>Canonical</th>
                                    <th>Hreflang</th>
                                    <th>Alt Text</th>
                                    <th>H1</th>
                                    <th>H2</th>
                                    <th>Word Count</th>
                                    <th>UI/UX</th>
                                </tr>
                            </thead>
                            <tbody id="crawlerTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <button id="downloadResultsBtn" onclick="downloadResultsAsXlsx()">Download results as xlsx</button>
            </div>
            <hr>
            <button class="collapsible" id="contentComparisonButton"><i class="fas fa-plus-square"></i>Content
                Comparison</button>
            <div class="content" id="contentComparison">
                <label for="comparison-keyword">Keyword:</label>
                <input type="text" id="comparison-keyword" placeholder="e.g., digital marketing">
                <br>
                <label for="comparison-urls">or URLs (separate by new line or comma):</label>
                <textarea id="comparison-urls"
                    placeholder="e.g., https://example.com, https://another-example.com"></textarea>
                <br>
                <div class="column">
                    <label for="comparison-language">Language:</label>
                    <input type="text" id="comparison-language" value="English" placeholder="e.g., English">
                </div>
                <div class="column">
                    <label for="comparison-location">Location:</label>
                    <input type="text" id="comparison-location" value="Singapore" placeholder="e.g., Singapore">
                </div>
                <br>
                <button id="contentComparisonAnalyzeBtn" onclick="contentComparisonAnalysis()">Analyse (up to 3
                    mins)</button>
                <button onclick="openContentComparisonQueriesModal()" id="loadTimeToRankQueriesBtn">Load Previous
                    Queries</button>

                <div id="loading-messages">
                    <p class="message"></p>
                </div>
                <div id="initial-table"></div>
                <div id="comparison-results"></div>
            </div>

            <hr>

            <button class="collapsible" id="schemaGeneratorButton"><i class="fas fa-plus-square"></i>Schema
                Generator</button>
            <div class="content" id="schema">
                <label for="schema-type">Schema Type:</label>
                <select id="schema-type">
                    <option value="LocalBusiness">Local Business</option>
                    <option value="Product">Product</option>
                    <option value="Event">Event</option>
                    <option value="Article">Article</option>
                    <option value="BreadcrumbList">Breadcrumb</option>
                    <option value="Event">Event</option>
                    <option value="FAQPage">FAQ Page</option>
                    <option value="HowTo">How-to</option>
                    <option value="JobPosting">Job Posting</option>
                    <option value="Organization">Organisation</option>
                    <option value="Person">Person</option>
                    <option value="Product">Product</option>
                    <option value="VideoObject">Video</option>
                    <option value="Website">Website</option>
                    <!-- Add more schema types as needed -->
                </select>

                <div id="input-fields"></div>
                <div id="schema-output"></div>
            </div>
            <hr>
            <button class="collapsible" id="onPageButton"><i class="fas fa-plus-square"></i>On-Page</button>
            <div id="onPageSection" class="content">
                <div class="input-group">
                    <div style="align-items: center; margin-bottom: 5px;">
                        <label for="on-page-url" style="margin-right: 5px;">Enter URL:</label><br>
                        <input type="url" id="on-page-url" placeholder="https://example.com" required>

                    </div>

                    <label for="on-page-keywords">Enter Keywords (comma or newline separated):</label>
                    <textarea id="on-page-keywords" rows="4" placeholder="keyword1, keyword2, keyword3"></textarea>

                    <button onclick="getImages()" id="getImagesBtn">Extract Elements & Generate Recommendations</button>
                    <!-- 
                <button onclick="loadCachedData()" class="load-cache-button">Load Cached Data From Browser</button>
                -->
                    <button onclick="openQueriesModal()" id="loadQueriesBtn">Load Previous Queries</button>
                    <button onclick="clearOnPageData()" style="white-space: nowrap;">Clear Data</button>
                </div>
                <button class="collapsible" id="onPageResultsCollapsible" style="display: none;">Meta Data and
                    Headings</button>
                <div class="content" id="onPageResults"></div>
                <button class="collapsible" id="imageCollapsible" style="display: none;">Image Alt Text</button>
                <div class="content" id="imageRecommendations"></div>
                <button class="collapsible" id="contentCollapsible" style="display: none;">Content</button>
                <div class="content" id="contentRecommendations"></div>
            </div>
            <hr>
            <button class="collapsible" id="rankCheckerButton"><i class="fas fa-plus-square"></i>Rank Checker</button>
            <div class="content" id="rankChecker">
                <label-fixed for="rankCheckerKeywords">Keywords:</label-fixed><br>
                <textarea id="rankCheckerKeywords" rows="10" cols="50"
                    placeholder="Enter keywords, one per line, up to 1,200 keywords"></textarea>
                <br>
                <label-fixed for="rankCheckerDomain">Targeted Domain / URL:</label-fixed><br>
                <input type="url" id="rankCheckerDomain" value="https://mediaonemarketing.com.sg"><br>
                <label-fixed for="rankCheckerLanguage">Language:</label-fixed><br>
                <input type="text" id="rankCheckerLanguage" value="English"><br>
                <label-fixed for="rankCheckerLocation">Location:</label-fixed><br>
                <input type="text" id="rankCheckerLocation" value="Singapore">
                <br><br>
                <button id="checkRanksButton" onclick="checkRanks()">Check Ranks</button>
                <hr>
                <br>
                <table id="rankCheckerResultsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Keyword</th>
                        </tr>
                    </thead>
                    <tbody id="rankCheckerResultsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        <hr>
        <button class="collapsible" id="smm"><i class="fas fa-plus-square"></i><i class="fas fa-share-alt"></i>Social
            Media (SMM)</button>
        <div class="content" id="socialMedia">
            <button class="collapsible" id="contentGeneratorButton"><i class="fas fa-plus-square"></i>Content Generator</button>
            <div class="content" id="contentGenerator">
                <form id="content-form">
                    <div class="column">
                        <div class="column">
                            <label for="gender">Gender:</label><br>
                            <select id="gender" name="gender">
                                <option value=""></option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="non-specfic-gender">Non-Specific</option>
                            </select>
                        </div>
                        <div class="column">
                            <label for="age-range">Age e.g. Students, 30-40 years old:</label>
                            <input class="input-short" type="text" id="age-range" name="age-range">
                        </div>

                        <div style="clear: both;"></div>

                        <label for="occupation">Occupation e.g. Homemakers, Professionals:</label><br>
                        <input type="text" id="occupation" name="occupation">

                        <label for="income">Income (e.g. Mid Income):</label>
                        <input type="text" id="income" name="income">

                        <label for="reference-url">Reference Webpage URL (Optional):</label>
                        <textarea id="reference-url" name="reference-url"
                            placeholder="Enter URLs separated by commas or newlines"></textarea><br>

                    </div>

                    <div class="column">

                        <label for="subgroups">Sub-Groups (e.g. Badminton Players):</label>
                        <input type="text" id="subgroups" name="subgroups"><br>

                        <label for="painpoints">Pain Points (e.g. not enough time):</label>
                        <input type="text" id="painpoints" name="painpoints"><br>

                        <label for="audience_goal">Audience Goals (e.g. Convenience):</label>
                        <input type="text" id="audience_goal" name="audience_goal">

                        <label for="generator_brand_guide_urls">URLs of Brand Guide PDFs (public
                            accessible):</label><br>
                        <textarea style="min-width: 90%; max-width: 90%;" id="generator_brand_guide_urls"
                            placeholder="Enter URLs separated by commas or newlines"></textarea><br>
                        <br>
                    </div>
                    <br>

                    <label for="sample-text">Sample Text/Post (Optional):</label><br>
                    <textarea id="sample-text" name="sample-text"></textarea><br><br>

                    <label for="post-info">Content of Post:</label><br>
                    <textarea id="post-info" name="post-info"></textarea><br><br>

                    <div class="column">

                        <label for="product_service">Product / Service:</label>
                        <input type="text" id="product_service" name="product_service">

                        <label for="desired_action">Desired Action e.g. Contact us:</label>
                        <input type="text" id="desired_action" name="desired_action">
                        <br>

                        <label for="post_objectives">Post Objectives e.g. Branding, Lifestyle, Seasonal
                            Greetings:</label>
                        <input type="text" id="post_objectives" name="post_objectives">

                        <div class="column">
                            <label for="content-type">Type of Content:</label><br>
                            <select id="content-type" name="content-type">
                                <option value="blog-post">Blog Post</option>
                                <option value="instagram-caption">Instagram Caption</option>
                                <option value="facebook-post">Facebook Post</option>
                                <option value="linkedin-post">LinkedIn Post</option>
                            </select>
                        </div>

                        <br>
                        <div class="column">

                            <label for="word_count">Word Count e.g. Long, 100 words:</label>
                            <input class="input-short" type="text" id="word_count" name="word_count">
                        </div>


                    </div>

                    <div class="column">

                        <label for="tone">Tone of Voice e.g. Luxury, Professional, Casual:</label>
                        <input type="text" id="tone" name="tone">
                        <br>

                        <label for="usp">Unique Selling Point e.g. Available 24/7, Budget friendly:</label>
                        <input type="text" id="usp" name="usp"><br>

                        <label for="pov">POV e.g. 1st person, 3rd person:</label>
                        <input type="text" id="pov" name="pov">
                        <br>

                        <div class="column">
                            <label for="emojis">Emojis:</label><br>
                            <select id="emojis" name="emojis">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                        <div class="column">
                            <label for="hashtags">Hashtags:</label><br>
                            <select id="hashtags" name="hashtags">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                    </div>
                    <div style="clear: both;"></div>

                    <button type="submit" id="generate-button">Generate Content</button>
                </form>

                <div id="generated-content"></div>
            </div>
        </div>
        <hr>
        <button class="collapsible" id="semButton"><i class="fas fa-plus-square"></i><i class="fas fa-ad"></i>Search
            Engine Marketing (SEM)</button>
        <div class="content" id="SEM">
            <label for="ad_format">Ad Formats:</label><br>
            <select id="ad_format" name="ad_format">
                <option value="google-responsive-search-ads">Google Responsive Search Ads</option>
                <option value="google-performance-max-ads">Google Performance Max Ads</option>
                <option value="google-display-ads">Google Display Ads</option>
                <option value="meta-image-ads">Meta Image Ads</option>
                <option value="meta-video-ads">Meta Video Ads</option>
                <option value="meta-carousel-ads">Meta Carousel Ads</option>
                <option value="meta-collection-ads">Meta Collection Ads</option>
                <option value="linkedin-image-ads">LinkedIn Image Ads</option>
                <option value="linkedin-carousel-ads">LinkedIn Carousel Ads</option>
                <option value="linkedin-video-ads">LinkedIn Video Ads</option>
                <option value="linkedin-click-to-message-ads">LinkedIn Click To Message Ads</option>
            </select>
            <br>
            <label for="sem_webpages">Webpages (seperated by commas or new lines):</label><br>
            <textarea id="sem_webpages" placeholder="e.g., https://example.com, https://another-example.com"></textarea>
            <br>
            <div class="column">
                <label for="sem_country">Country:</label><br>
                <input type="text" id="sem_country" value="Singapore"><br>
            </div>
            <div class="column">
                <label for="sem_tone">Tone of Voice:</label><br>
                <input type="text" id="sem_tone" value="Salesy"><br>
            </div>
            <div class="column">
                <label for="sem_language">Language:</label><br>
                <input type="text" id="sem_language" value="English"><br>
            </div>
            <div style="clear: both;"></div><br>
            <div class="toggle-container" id="semBrandFocus">
                <span class="toggle-label">Don't Focus on Brand/Company</span>
                <label class="switch">
                    <input type="checkbox" id="brand-checkbox" class="sliderMobile"> <span class="slider round"></span>
                </label>
                <span class="toggle-label-right">Focus on Brand/Company</span>
            </div><br>
            <div class="toggle-container" id="semProductFocus">
                <span class="toggle-label">Don't Focus on Products/Services</span>
                <label class="switch">
                    <input type="checkbox" id="product-checkbox" class="sliderMobile" checked> <span
                        class="slider round"></span>
                </label>
                <span class="toggle-label-right">Focus on Products/Services</span>
            </div>
            <div style="clear: both;"></div>
            <br>
            <label for="sem_additional">Addtional Information (optional):</label><br>
            <textarea id="sem_additional"
                placeholder="You can input information that is not found in the webpage(s) content or focus area(s) here"></textarea></textarea>

            <br>
            <button id="getProducts" onclick="semWebpageProducts()">Step 1: Identify
                products/services/brand/company</button>
            <br>
            <div id="products"></div>
            <br>
            <button id="semAnalyse" onclick="semAnalyseWebsite()">Step 2: Generate KWs, USPs & Audience</button>
            <br>

            <div class="column" id="output"></div>
            <div class="column" id="selected" style="display:none;">
                <h2>Selected</h2>
                <textarea id="selectedText" rows="20"></textarea><br>
                <button id="generateSem" onclick="generateGoogle()">Step 3: Select checkboxes then click
                    here</button>
                <h2>Generated</h2>
                <div id="generated"></div>
            </div>
            <div style="clear: both;"></div>
            <div> </div> <!-- Clearfix -->
        </div>
        <hr>

        <button class="collapsible" id="competitionBtn"><i class="fas fa-plus-square"></i><i
                class="fas fa-search"></i>Competitors Identifier</button>
        <div class="content" id="competitors_content">
            <label for="competitors-target1">Target Domain:</label>
            <input type="text" id="competitors-target1" placeholder="e.g. www.abc.com"><br>
            <label for="competitor_keywords">Keywords (seperated by commas or new
                lines):</label><br>
            <textarea id="competitor_keywords"></textarea><br>
            <label for="competitors-language">Language:</label>
            <input type="text" id="competitors-language" value="English" placeholder="e.g., English"><br>
            <label for="competitors-location">Location:</label><br>
            <input type="text" id="competitors-location" value="Singapore" placeholder="e.g., Singapore">
            <button id="getCompetitorsBtn" onclick="getCompetitors()">Step 1: Get Competitors</button>
            <div id="competitorsOutput" style="display:none;height:400px;overflow:auto;">
                <br>
            </div>
            <!-- Add this button below the competitors table -->
            <button id="getIntersectionResults" style="display:none" onclick="getIntersectionResults()">Step 2: Choose
                Competiors & Get Intersection
                Results</button>
            <div id="competitorsRanking" style="display:none;height:400px;overflow:auto;"></div>
        </div>
        <hr>


        <button class="collapsible" id="persona"><i class="fas fa-plus-square"></i><i class="fas fa-users"></i>Persona
            Generator</button>
        <div class="content" id="persona_content">
            <label for="persona_webpages">Company / Product Information Webpages (seperated by commas or new
                lines):</label><br>
            <textarea id="persona_webpages"
                placeholder="e.g., https://example.com, https://another-example.com"></textarea><br>
            <label for="persona_manual">Any other information (optional):</label><br>
            <textarea id="persona_manual" placeholder="Focus on this product."></textarea>
            <button id="generatePersonaBtn" onclick="generatePersona()">Generate Personas</button>
            <div id="persona-results"></div>
            <button type="button" id="copy-persona-results-button" class="tooltip" style="display:none"
                onclick="copyPersonaResults(event)">Copy to clipboard<span>Click to copy the persona results to your
                    clipboard.</span>
            </button>
        </div>
        <hr>
        <button class="collapsible" id="mediaPlanBtn"><i class="fas fa-plus-square"></i><i
                class="fas fa-bullseye"></i>Media Plan</button>
        <div class="content" id="mediaplan">
            <label for="MediaPlanWebpages">Company / Product Information Webpages (seperated by commas or new
                lines):</label><br>
            <textarea id="MediaPlanWebpages"
                placeholder="e.g., https://example.com, https://another-example.com"></textarea><br>
            <label for="MediaPlanBudget">Monthly Budget:</label><br>
            <input type="text" id="MediaPlanBudget" name="budget"><br>
            <label for="MediaPlanAdFormats">Preferred Ad Formats:</label><br>

            <input type="checkbox" checked class="media-plan-checkbox" id="MediaPlanAdFormatsGoogleDisplay"
                name="MediaPlanAdFormatsGoogleDisplay" value="MediaPlanAdFormatsGoogleDisplay">
            <label for="MediaPlanAdFormatsGoogleDisplay">Google Display</label><br>
            <input type="checkbox" checked class="media-plan-checkbox" id="MediaPlanAdFormatsGoogleSearch"
                name="MediaPlanAdFormatsGoogleSearch" value="MediaPlanAdFormatsGoogleSearch">
            <label for="MediaPlanAdFormatsGoogleSearch">Google Search</label><br>
            <input type="checkbox" checked class="media-plan-checkbox" id="MediaPlanAdFormatsFBIG"
                name="MediaPlanAdFormatsFBIG" value="MediaPlanAdFormatsFBIG">
            <label for="MediaPlanAdFormatsFBIG">Facebook / Instagram</label><br>
            <input type="checkbox" checked class="media-plan-checkbox" id="MediaPlanAdFormatsLinkedIn"
                name="MediaPlanAdFormatsLinkedIn" value="MediaPlanAdFormatsLinkedIn">
            <label for="MediaPlanAdFormatsLinkedIn">LinkedIn</label><br>
            <input type="checkbox" checked class="media-plan-checkbox" id="MediaPlanAdFormatsTikTok"
                name="MediaPlanAdFormatsTikTok" value="MediaPlanAdFormatsTikTok">
            <label for="MediaPlanAdFormatsTikTok">TikTok</label><br><br>

            <label for="MediaPlanManual">Any other information (optional):</label><br>
            <textarea id="MediaPlanManual" placeholder="Focus on this product."></textarea><br>

            <button class="collapsible" id="mediaPlanOtherFieldsBtn">Other Fields (optional)</button>
            <div class="content" id="mediaplanothers">

                <label for="MediaPlanOrganisationalObjectives">Organisational Objectives:</label><br>
                <textarea id="MediaPlanOrganisationalObjectives"
                    placeholder="e.g., Increase brand awareness by 20%"></textarea><br>

                <label for="MediaPlanLocation">Target Location:</label><br>
                <input type="text" id="MediaPlanLocation" name="mediaPlanLocation" placeholder="e.g., Singapore"><br>

                <label for="MediaPlanTargetAudience">Target Audience:</label><br>
                <input type="text" id="MediaPlanTargetAudience" name="mediaPlanTargetAudience"
                    placeholder="e.g., Millennials, Tech Enthusiasts"><br>

                <label for="MediaPlanCustomerPersonas">Customer Personas:</label><br>
                <textarea id="MediaPlanCustomerPersonas"
                    placeholder="Description of your ideal customers."></textarea><br>

                <label for="MediaPlanTouchpoints">Customer Touchpoints:</label><br>
                <textarea id="MediaPlanTouchpoints"
                    placeholder="List all interaction points a customer might have with your brand."></textarea><br>

                <label for="MediaPlanContentStrategy">Content Strategy:</label><br>
                <textarea id="MediaPlanContentStrategy"
                    placeholder="e.g., Blog posts, videos, infographics"></textarea><br>

                <label for="MediaPlanLandingPages">Landing Pages:</label><br>
                <textarea id="MediaPlanLandingPages" placeholder="URLs of relevant landing pages."></textarea><br>

                <label for="MediaPlanCta">Calls-to-Action (CTAs):</label><br>
                <textarea id="MediaPlanCta" placeholder="e.g., Sign up, Download, Buy Now"></textarea><br>

                <label for="MediaPlanProductService">Specific Products/Services to Promote:</label><br>
                <textarea id="MediaPlanProductService"
                    placeholder="List the products or services you want to highlight."></textarea><br>

                <label for="MediaPlanKpis">Key Performance Indicators (KPIs):</label><br>
                <textarea id="MediaPlanKpis" placeholder="e.g., Engagement rate, Conversion rate, ROAS"></textarea><br>

                <label for="MediaPlanCompetitiveAnalysis">Competitive Analysis:</label><br>
                <textarea id="MediaPlanCompetitiveAnalysis"
                    placeholder="Information about your competitors' strategies."></textarea><br>

                <label for="MediaPlanCompliance">Compliance and Regulations:</label><br>
                <textarea id="MediaPlanCompliance"
                    placeholder="Relevant legal and industry regulations."></textarea><br>

                <label for="MediaPlanTechnologyPlan">Technology Plan:</label><br>
                <textarea id="MediaPlanTechnologyPlan"
                    placeholder="Marketing technologies and tools to be used."></textarea><br>

                <label for="MediaPlanAnalyticsReporting">Analytics and Reporting:</label><br>
                <textarea id="MediaPlanAnalyticsReporting"
                    placeholder="Processes for tracking and reporting performance."></textarea><br>

            </div>

            <button id="generateMediaPlanBtn" onclick="generateMediaPlan()">Generate Media Plan</button>
            <div id="mediaPlanPersonaResults" class="mediaPlanPersonaResults">
                <hr>
            </div>
            <div id="mediaPlanResults"></div>

            <div class="funnel-container" id="funnel-container" style="display:none;">
                <button class="funnel-collapsible-before" style="background-color: #7554ae; width:100%;"><b>AWARENESS
                        (TOFU)</b>
                    <p id="awareness-summary">Attract a wider audience. Make your brand known using tactics like
                        SEO, social media, content marketing, and paid ads. The goal is to increase visibility and spark
                        initial interest in your brand.</p>
                </button>
                <div class="funnel-content" style="background-color: #bba9d9;">
                    <p id="awareness-details">N.A.</p>
                </div>

                <button class="funnel-collapsible-before" style="background-color: #3a857d; width:90%;"><b>DISCOVERY
                        (MOFU)</b>
                    <p id="discovery-summary">Educate and engage your audience. Provide valuable information and
                        resources that help potential customers understand their problem and your potential solution.
                        Content like ebooks, webinars, and helpful blog posts are key.</p>
                </button>
                <div class="funnel-content" style="background-color: #b8d1cf; width:90%;">
                    <p id="discovery-details">N.A.</p>
                </div>

                <button class="funnel-collapsible-before" style="background-color: #e67c3a; width:80%;"><b>CONSIDERATION
                        (MOFU)</b>
                    <p id="consideration-summary">Showcase your value proposition. Demonstrate how your product or
                        service specifically solves the customer's needs and stands out from the competition. Use case
                        studies, testimonials, product demos, and comparisons.</p>
                </button>
                <div class="funnel-content" style="background-color: #f0cbb4; width:80%;">
                    <p id="consideration-details">N.A.</p>
                </div>

                <button class="funnel-collapsible-before" style="background-color: #e57373; width:70%;"><b>CONVERSION
                        (BOFU)</b>
                    <p id="conversion-summary">Drive action and close the sale. Make it easy for potential customers
                        to purchase by offering trials, discounts, consultations, or clear calls to action. Focus on
                        removing obstacles and building confidence in their decision.</p>
                </button>
                <div class="funnel-content" style="background-color: #f4c8c8; width:70%;">
                    <p id="conversion-details">N.A.</p>
                </div>

                <button class="funnel-collapsible-before" style="background-color: #3a85c3; width:60%;"><b>RETENTION</b>
                    <p id="retention-summary">Foster loyalty. Provide ongoing value and build lasting relationships
                        with
                        your customers. Offer
                        personalized communications, loyalty programs, and exclusive offers to encourage repeat
                        purchases and
                        brand advocacy. Happy customers become your best marketers.</p>
                </button>
                <div class="funnel-content" style="background-color: #b2cfe7; width:60%;">
                    <p id="retention-details">N.A.</p>
                </div>
            </div>
        </div>

        <hr>
        <button class="collapsible" id="contentcheck"><i class="fas fa-plus-square"></i><i
                class="fas fa-book-open"></i>Content Checker</button>
        <div class="content" id="content_check_content">
            <label for="brand_guide_urls">URLs of Guidelines PDFs (public accessible) e.g. brand guides:</label><br>
            <textarea id="brand_guide_urls"
                placeholder="e.g., https://drive.google.com/file/d/xxxxxxxxx/view?usp=drive_link&#10https://another-example.com/sample.pdf"></textarea><br>
            <label for="content_check_other_urls">Any other website/guidelines URLs: </label><br>
            <textarea id="content_check_other_urls"
                placeholder="https://regulations-for-industry-advertising.com/"></textarea><br>
            <label for="content_check_instructions">Any other instructions: </label><br>
            <textarea id="content_check_instructions"
                placeholder="e.g Do not use the word 'cheap' in the content'"></textarea><br>
            <label for="content_to_check">Content to Check: </label><br>
            <textarea id="content_to_check" style="min-height: 200px;" placeholder="Your content here"></textarea><br>
            <button id="contentCheckBtn" onclick="checkContent()">Check Content</button><br>
            <div id="checkContentResults"></div>
            <div style="display: flex; align-items: center;">
                <button type="button" id="copy-check-results-button" class="tooltip" style="display:none"
                    onclick="copyCheckContentResults(event)">
                    <i class="fa fa-copy"></i>
                    <span>Click to copy the check results to your clipboard.</span>
                </button>
                <button id="openFeedbackModalBtn" style="display:none; margin-left: 10px;">Feedback</button>
            </div>
        </div>
        <hr>
        <button class="collapsible" id="landingPageAuditBtn"><i class="fas fa-plus-square"></i><i
                class="fas fa-clipboard-check"></i>Landing Page
            Audit</button>
        <div class="content" id="landingPageAudit">
            <label for="landingPageUrl">Landing Page URL:</label><br>
            <input type="url" id="landingPageUrl" placeholder="e.g., https://example.com"><br>
            <label for="landingPageAuditKeyword">Target Keyword (optional):</label><br>
            <input type="text" id="landingPageAuditKeyword" name="landingPageAuditKeyword"><br>
            <button id="auditLandingPageBtn" onclick="auditLandingPageDirectWeb()">Audit Landing Page</button>
            <div class="gauge" id="gauge" style="display:none;">
                <br>
                <div class="gauge__body">
                    <div class="gauge__fill"></div>
                    <div class="gauge__cover"></div>
                    <br>
                </div>
                <br>
            </div>
            <div id="landingPageAuditResults"></div>
        </div>
    </div>

    <button id="goToTop-button" onclick="goToTop()"
        style="position: fixed; bottom: 10px; right: 245px; background-color: #d89030; color: white; border: none; padding: 10px 20px; border-radius: 100px; cursor: pointer; z-index: 1000; font-size:1.2em">
        <i class="fas fa-arrow-up"></i>
    </button>

    <button id="cleanup-button" onclick="clearPageState()"
        style="position: fixed; bottom: 10px; right: 80px; background-color: hsl(0, 71%, 49%); color: white; border: none; padding: 10px 20px; border-radius: 100px; cursor: pointer; z-index: 1000; font-size:1.2em">
        Clear Data <i class="fas fa-trash-alt" style="margin-left: 10px;"></i>
    </button>
    <button id="chatbot-button"
        style="position: fixed; bottom: 10px; right: 10px; background-color: hsl(118, 40%, 43%); color: white; border: none; padding: 10px 20px; border-radius: 100px; cursor: pointer; z-index: 1000; font-size:1.2em">
        <i class="fas fa-comment-dots"></i>
    </button>

    <script id="local-business-template" type="text/x-handlebars-template">
        <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
        <label for="address">Address:</label><input type="text" id="address" oninput="updateSchema()"><br>
        <label for="telephone">Telephone:</label><input type="text" id="telephone" oninput="updateSchema()"><br>
      </script>

    <script id="product-template" type="text/x-handlebars-template">
          <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
          <label for="description">Description:</label><input type="text" id="description" oninput="updateSchema()"><br>
          <label for="brand">Brand:</label><input type="text" id="brand" oninput="updateSchema()"><br>
      </script>

    <script id="event-template" type="text/x-handlebars-template">
          <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
          <label for="startDate">Start Date:</label><input type="date" id="startDate" oninput="updateSchema()"><br>
          <label for="location">Location:</label><input type="text" id="location" oninput="updateSchema()"><br>
          <label for="description">Description:</label><textarea id="description" oninput="updateSchema()"></textarea><br>
      </script>

    <script id="article-template" type="text/x-handlebars-template">
          <label for="headline">Headline:</label><input type="text" id="headline" oninput="updateSchema()"><br>
          <label for="author">Author:</label><input type="text" id="author" oninput="updateSchema()"><br>
          <label for="datePublished">Date Published:</label><input type="date" id="datePublished" oninput="updateSchema()"><br>
          <label for="articleBody">Article Body:</label><textarea id="articleBody" oninput="updateSchema()"></textarea><br>
      </script>

    <script id="breadcrumblist-template" type="text/x-handlebars-template">
          <div id="breadcrumb-items">
              <div class="breadcrumb-item">
                  <input type="text" id="name1" placeholder="Page #1's name" oninput="updateSchema()">
                  <input type="url" id="url1" placeholder="URL #1" oninput="updateSchema()">
                  <button class="remove-item" onclick="removeItem(this)">x</button>
              </div>
              <div class="breadcrumb-item">
                  <input type="text" id="name2" placeholder="Page #2's name" oninput="updateSchema()">
                  <input type="url" id="url2" placeholder="URL #2" oninput="updateSchema()">
                   <button class="remove-item" onclick="removeItem(this)">x</button>
              </div>
          </div>
          <button onclick="addItem()"> + ADD URL </button>
      
        </script>

    <script id="faqpage-template" type="text/x-handlebars-template">
          <div id="faq-items">
              <div class="faq-item">
                  <input type="text" id="question1" placeholder="Question #1" oninput="updateSchema()">
                  <textarea id="answer1" placeholder="Answer" oninput="updateSchema()"></textarea>
                  <button class="remove-item" onclick="removeFaqItem(this)">x</button> <br>
              </div>
          </div>
          <button onclick="addFaqItem()">+ ADD QUESTION</button>
      </script>
    <script id="howto-template" type="text/x-handlebars-template">
          <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
          <label for="description">Description:</label><textarea id="description" oninput="updateSchema()"></textarea><br>
          <label for="supply">Supply (JSON-LD array of HowToSupply objects):</label><textarea id="supply" class="json-ld" oninput="updateSchema()"></textarea><br>
          <label for="step">Steps (JSON-LD array of HowToStep objects):</label><textarea id="step" class="json-ld" oninput="updateSchema()"></textarea><br>
          * See schema.org/HowTo for details on HowToSupply and HowToStep structure.
        </script>

    <script id="jobposting-template" type="text/x-handlebars-template">
          <label for="title">Job Title:</label><input type="text" id="title" oninput="updateSchema()"><br>
          <label for="description">Job Description:</label><textarea id="description" oninput="updateSchema()"></textarea><br>
          <label for="datePosted">Date Posted:</label><input type="date" id="datePosted" oninput="updateSchema()"><br>
          <label for="employmentType">Employment Type:</label><input type="text" id="employmentType" oninput="updateSchema()"><br>
          <label for="hiringOrganization">Hiring Organization (Name):</label><input type="text" id="hiringOrganization_name" oninput="updateSchema()"><br>
         <label for="hiringOrganization">Hiring Organization (Website):</label><input type="url" id="hiringOrganization_sameAs" oninput="updateSchema()"><br>
        </script>


    <script id="organization-template" type="text/x-handlebars-template">
          <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
          <label for="url">URL:</label><input type="url" id="url" oninput="updateSchema()"><br>
          <label for="logo">Logo URL:</label><input type="url" id="logo" oninput="updateSchema()"><br>
        </script>

    <script id="person-template" type="text/x-handlebars-template">
          <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
          <label for="jobTitle">Job Title:</label><input type="text" id="jobTitle" oninput="updateSchema()"><br>
        
        </script>


    <script id="video-object-template" type="text/x-handlebars-template">
            <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
            <label for="description">Description:</label><input type="text" id="description" oninput="updateSchema()"><br>
            <label for="uploadDate">Upload Date:</label><input type="date" id="uploadDate" oninput="updateSchema()"><br>
            <label for="thumbnailUrl">Thumbnail URL:</label><input type="url" id="thumbnailUrl" oninput="updateSchema()"><br>
        </script>

    <script id="website-template" type="text/x-handlebars-template">
            <label for="name">Name:</label><input type="text" id="name" oninput="updateSchema()"><br>
            <label for="url">URL:</label><input type="url" id="url" oninput="updateSchema()"><br>
        </script>

    <script>

        document.addEventListener('DOMContentLoaded', function () {
            const collapsibles = document.querySelectorAll('.collapsible'); // Select all collapsibles
            collapsibles.forEach(collapsible => {
                collapsible.addEventListener('click', function () {
                    this.classList.toggle('active');
                    const content = this.nextElementSibling;

                    const icon = this.querySelector('i');

                    if (icon) {
                        if (icon.classList.contains('fa-plus-square')) {
                            icon.classList.remove('fa-plus-square');
                            icon.classList.add('fa-minus-square');
                        } else {
                            icon.classList.remove('fa-minus-square');
                            icon.classList.add('fa-plus-square');
                        }
                    }

                    content.style.display = content.style.display === 'block' ? 'none' : 'block';
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            const collapsibles = document.querySelectorAll('.collapsible-plus'); // Select all collapsibles
            collapsibles.forEach(collapsible => {
                collapsible.addEventListener('click', function () {
                    const icon = this.querySelector('i'); // Select the <i> element
                    const content = this.nextElementSibling.nextElementSibling; //Select the actual content

                    if (!content) {
                        console.warn("No content found after the .collapsible");
                        return;
                    }
                    icon.classList.toggle('fa-plus-square');
                    icon.classList.toggle('fa-minus-square');

                    content.style.display = content.style.display === 'block' ? 'none' : 'block';
                });
            });
        });

        let currentKeywordSortColumn = null;
        let keywordSortAscending = true;

        let currentRankedKeywordSortColumn = null;
        let rankedKeywordSortAscending = true;

        const submitBtn = document.getElementById('submitBtn');
        const gtmetrixReportDiv = document.getElementById('gtmetrixReport');
        const crawlerReportDiv = document.getElementById('crawlerReport');
        const crawlerTableBody = document.getElementById('crawlerTableBody');
        const pageAuditReportDiv = document.getElementById('pageAuditReport');

        analyzeBtn = document.getElementById('analyzeBtn');
        const resultsDiv = document.getElementById('comparison-results');
        const loadingMessagesDiv = document.getElementById('loading-messages');
        const messageElement = document.querySelector('.message');
        const messages = [
            'Getting SERP results...',
            'Analysing Page Content...',
            'Formulating Content Topics...',
            'Comparing Topics Across Results...',
            'Collating Findings...'
        ];
        let currentMessageIndex = 0;

        brandCheckbox = document.getElementById('brand-checkbox');
        productCheckbox = document.getElementById('product-checkbox');

        brandCheckbox.addEventListener('change', () => {
            if (brandCheckbox.checked) {
            } else {
                if (productCheckbox.checked) {

                } else {
                    productCheckbox.checked = true;
                }
            }
        });

        productCheckbox.addEventListener('change', () => {
            if (productCheckbox.checked) {
            } else {
                if (brandCheckbox.checked) {

                } else {
                    brandCheckbox.checked = true;
                }
            }
        });

        submitBtn.addEventListener('click', () => {
            const url = document.getElementById('urlInput').value;
            const maxPages = document.getElementById('maxPagesInput').value;

            submitBtn.innerHTML = 'Analysing...';
            document.getElementById("technicalButton").style.backgroundColor = "#004c9d";
            document.getElementById("gtButton").style.backgroundColor = "#004c9d";
            document.getElementById("pageButton").style.backgroundColor = "#004c9d";
            document.getElementById("crawlerButton").style.backgroundColor = "#004c9d";

            document.getElementById('auditSummary').innerHTML = "";

            // GTMetrix API call
            fetch("https://y5830908vh.execute-api.ap-southeast-1.amazonaws.com/gtmetrix", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            })
                .then(response => response.json())
                .then(gt_data => {
                    document.getElementById('reportUrl').innerHTML = '<a href="' + gt_data.body.data.links.report_url + '" target="_blank" rel="noopener noreferrer">' + gt_data.body.data.links.report_url + '</a>';
                    document.getElementById('cls').textContent = gt_data.body.data.attributes.cumulative_layout_shift;
                    document.getElementById('lcp').textContent = gt_data.body.data.attributes.largest_contentful_paint;
                    document.getElementById('tbt').textContent = gt_data.body.data.attributes.total_blocking_time;
                    document.getElementById('grade').textContent = gt_data.body.data.attributes.gtmetrix_grade;
                    document.getElementById('performance').textContent = gt_data.body.data.attributes.performance_score;

                    gtmetrixReportDiv.style.display = 'block';
                    document.getElementById("gtButton").style.backgroundColor = "green";

                })

                .catch(error => console.error('Error fetching GTMetrix data:', error));


            // Webpage Audit
            fetch("https://7vkudwlzhh.execute-api.ap-southeast-1.amazonaws.com/webpageAudit", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            })
                .then(response => response.json())
                .then(webpage_audit_data => {
                    document.getElementById('malware').textContent = webpage_audit_data.body.malware;
                    document.getElementById('sitemap').textContent = webpage_audit_data.body.sitemap;
                    document.getElementById('robots').innerHTML = webpage_audit_data.body.robots;
                    document.getElementById('pagespeed_audit').textContent = webpage_audit_data.body.pagespeed;

                    pageAuditReportDiv.style.display = 'block';
                    document.getElementById("pageButton").style.backgroundColor = "green";
                    document.getElementById("technicalButton").style.backgroundColor = "green";
                })
                .catch(error => console.error('Error fetching Webpage Audit data:', error));


            // Crawler API call
            fetch("https://464q7iox7h.execute-api.ap-southeast-1.amazonaws.com/crawler", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url, max_pages: parseInt(maxPages) })
            })
                .then(response => response.json())
                .then(data => {
                    crawlerTableBody.innerHTML = ''; // Clear previous data

                    for (const pageUrl in data.body) {
                        const pageData = data.body[pageUrl];
                        const row = document.createElement('tr');
                        row.innerHTML = `   
                        <td>${pageUrl}</td>
                        <td>${pageData.code}</td>
                        <td>${pageData.title}</td>
                        <td>${pageData.description}</td>
                        <td>${pageData.canonical}</td>
                        <td>${pageData.hreflang}</td>
                        <td>${pageData.alt_text}</td>
                        <td>${pageData.h1}</td>
                        <td>${pageData.h2}</td>
                        <td>${pageData.word_count}</td>
                        <td>${pageData.uiux}</td>
                    `;
                        crawlerTableBody.appendChild(row);
                    }
                    crawlerReportDiv.style.display = 'block';
                    submitBtn.innerHTML = 'Analyse Website';


                    // Audit Summary
                    gt_data = { "cumulative_layout_shift": document.getElementById('cls').textContent, "largest_contentful_paint": document.getElementById('lcp').textContent, "total_blocking_time": document.getElementById('tbt').textContent };
                    webpage_audit_data = { 'google_safe_site': document.getElementById('malware').textContent, 'sitemap': document.getElementById('sitemap').textContent, 'robots_txt': document.getElementById('robots').innerHTML, 'pagespeed': document.getElementById('pagespeed_audit').textContent };

                    fetch("https://ccgdpp7dna.execute-api.ap-southeast-1.amazonaws.com/techAuditSummary", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ crawl: data, gtmetrix: gt_data, webpage_audit: webpage_audit_data })
                    })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('auditSummary').innerHTML = data.body;
                            document.getElementById("crawlerButton").style.backgroundColor = "green";
                        })
                        .catch(error => console.error('Error fetching Audt Summary API:', error));

                })
                .catch(error => {
                    console.error('Error fetching crawler data:', error);
                    submitBtn.innerHTML = 'Analyse Website';
                })

                .finally(() => {
                    document.getElementById('downloadResultsBtn').style.display = 'block';
                });

        });

        async function contentComparisonAnalysis() {
            analyzeBtn = document.getElementById('contentComparisonAnalyzeBtn');
            // Show loading messages, hide previous results
            resultsDiv.innerHTML = '';
            analyzeBtn.innerHTML = 'Analysing...';
            loadingMessagesDiv.classList.add('active');

            keyword = document.getElementById('comparison-keyword').value;
            const urlsInput = document.getElementById('comparison-urls').value;
            const language = document.getElementById('comparison-language').value;
            const location = document.getElementById('comparison-location').value;
            user = JSON.parse(localStorage.getItem('googleUser')).email
            urls = urlsInput.split(/[\s,]+/).filter(url => url.trim() !== "");
            const loadingMessageInterval = setInterval(updateLoadingMessage, 4000);

            try {
                // Function to cycle through loading messages
                function updateLoadingMessage() {
                    messageElement.textContent = messages[currentMessageIndex];
                    currentMessageIndex = (currentMessageIndex + 1) % messages.length;
                }

                // Start cycling loading messages
                //const loadingMessageInterval = setInterval(updateLoadingMessage, 4000);

                let serpUrls = [];
                try {
                    if (keyword != "") {
                        // 1. Fetch URLs from SERP API
                        const serpResponse = await fetch('https://u22k9g2y8c.execute-api.ap-southeast-1.amazonaws.com/new', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ keyword, language, location, user }),
                        });
                        const serpData = await serpResponse.json();
                        if (serpData.statusCode !== 200) {
                            throw new Error(`SERP API Error: ${serpData.body || serpData.errorMessage}`);
                        }
                        serpUrls = Object.values(serpData.body).map(result => result.url);

                        if (urls != "") {
                            serpUrls = [...new Set([...serpUrls, ...urls])]; // Combine and deduplicate
                        }

                    } else {
                        serpUrls = urls;
                    }
                } catch (error) {
                    serpUrls = urls;
                }

                // 2. Fetch content analysis for each URL *concurrently*
                const analysisPromises = serpUrls.map(url =>
                    fetch('https://u24f9208q0.execute-api.ap-southeast-1.amazonaws.com/gptTopicsPerUrl', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, keyword }),
                    }).then(res => {
                        if (!res.ok) {  // Check for errors
                            throw new Error(`Content analysis API error for ${url}: ${res.status} ${res.statusText}`);
                        }
                        return res.json();
                    })
                );

                // Wait for *all* content analysis calls to complete
                analysisDataArray = await Promise.all(analysisPromises);

                // Combine analysis data, handling potential errors from individual API calls
                analysisData = {};
                analysisDataArray.forEach(item => {
                    url = Object.keys(item['body'])[0];
                    analysisData[url] = item['body'][url];
                }
                );

                // Check if analysisData is empty after combining results.
                if (Object.keys(analysisData).length === 0) {
                    throw new Error("Content analysis failed for all URLs. Please check the URLs and try again.");
                }

                // 3. Create and display the table (modified createAnalysisTable function below)
                comparisonTableHTML = createAnalysisTable(analysisData, keyword, urls);  // Pass keyword and target URLs
                document.getElementById('initial-table').innerHTML = `<div id="tableContainer">${comparisonTableHTML}</div>`;

                // 4. Apply gradients (no change needed)
                applyGradientsToRows();

                // 5. Submit table data to comparisonRecommender API
                const comparisonResponse = await fetch('https://33v5mhjt47.execute-api.ap-southeast-1.amazonaws.com/comparisonRecommender', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ output: analysisData, keyword }), // Send analysisData directly
                });
                const comparisonData = await comparisonResponse.json();

                // Display recommendations and output table from comparison API
                const recommendation = comparisonData.body.recommendation;

                try {
                    //const outputTableHTML = createHTMLTableFromJSON(comparisonData.body.output); // Parse JSON string to object
                    const outputTableHTML = createAnalysisTable(comparisonData.body.output, keyword, urls)
                    document.getElementById('initial-table').innerHTML = "";
                    document.getElementById('initial-table').innerHTML = `<div id="tableContainer">${outputTableHTML}</div>`;
                    resultsDiv.innerHTML += `<pre>${recommendation}</pre>`;
                    console.log('refresh succesful');

                    // 4. Apply gradients (no change needed)
                    applyGradientsToRows();

                } catch (error) {
                    console.log(error)
                    resultsDiv.innerHTML += `<pre>${recommendation}</pre>`;
                }

                // --- Data is ready, stop loading messages ---
                clearInterval(loadingMessageInterval);
                loadingMessagesDiv.classList.remove('active');

                analyzeBtn.innerHTML = 'Analyse (up to 3 mins)';
                await contentComparisonToDatabase();

            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                try {
                    clearInterval(loadingMessageInterval);
                    loadingMessagesDiv.classList.remove('active');
                } catch (error) {
                    clearInterval(loadingMessageInterval);
                    loadingMessagesDiv.classList.remove('active');
                }
                loadingMessagesDiv.classList.remove('active');
                analyzeBtn.innerHTML = 'Analyse (up to 3 mins)';
            }
        }

        // Function to create the HTML table from the analysis data
        function createAnalysisTable(data, keyword, targetUrls) {
            let tableHTML = '<table id="analysisTable">';
            tableHTML += '<tr><th>URL</th>';

            const urls = Object.keys(data);
            urls.forEach(url => {
                tableHTML += `<th ${targetUrls.includes(url) && keyword ? 'class="targetUrl"' : ''}>
                        <a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a></th>`;
            });
            tableHTML += '</tr>';


            // Add Word Count row
            tableHTML += '<tr><td>Word Count</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td data-value="${data[url].word_count}">${data[url].word_count}</td>`;
                } catch (error) {
                    tableHTML += `<td data-value="0">0</td>`;
                }
            });
            tableHTML += '</tr>';

            // Add Page Type row
            tableHTML += '<tr><td>Page Type</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td>${data[url].page_type}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            // Add headings rows
            tableHTML += '<tr><td>h1</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td> • ${data[url].h1.join('<br> • ')}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            tableHTML += '<tr><td>h2</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td> • ${data[url].h2.join('<br> • ')}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            tableHTML += '<tr><td>h3</td>';
            urls.forEach(url => {
                try {
                    tableHTML += `<td> • ${data[url].h3.join('<br> • ')}</td>`;
                } catch (error) {
                    tableHTML += `<td>-</td>`;
                }
            });
            tableHTML += '</tr>';

            // Get all unique topics, handling missing topics
            let allTopics = [];
            urls.forEach(url => {
                if (data[url] && data[url].topics) {
                    allTopics = [...allTopics, ...Object.keys(data[url].topics)];
                }
            });
            const uniqueTopics = [...new Set(allTopics)];

            // Add Topic rows (handling missing topic data)
            uniqueTopics.forEach(topic => {
                tableHTML += `<tr><td>${topic.replaceAll('_', ' ')}</td>`;
                urls.forEach(url => {
                    const value = (data[url] && data[url].topics && data[url].topics[topic]) ? data[url].topics[topic] : 0;
                    tableHTML += `<td data-value="${value}">${value}</td>`;
                });
                tableHTML += '</tr>';
            });

            tableHTML += '</table>';
            return tableHTML;
        }

        function applyGradientsToRows() {
            const table = document.getElementById('analysisTable');
            for (let i = 1; i < table.rows.length; i++) { // Start from row 1 to skip header
                applyGradientToRow(table.rows[i]);
            }
        }

        function applyGradientToRow(row) {
            const values = Array.from(row.cells)
                .slice(1) // Skip the first cell (topic name)
                .map(cell => {
                    const value = parseFloat(cell.dataset.value);
                    return isNaN(value) ? -1 : value; // Assign -1 for non-numeric values
                });

            const max = Math.max(...values);
            const min = Math.min(...values);

            values.forEach((value, index) => {
                const cell = row.cells[index + 1]; // +1 to account for the first cell
                if (!isNaN(value) && value !== -1) { // Apply gradient only to numeric values
                    const percent = (value - min) / (max - min);
                    const red = Math.round(255 * (1 - percent));
                    const green = Math.round(255 * percent);
                    cell.style.backgroundColor = `rgb(${red}, ${green}, 0)`;
                }
            });
        }



        // Function to generate content
        const form = document.getElementById('content-form');
        const generatedContentDiv = document.getElementById('generated-content');
        const generateButton = document.getElementById('generate-button');

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            // Disable the button and change text
            generateButton.disabled = true;
            generateButton.textContent = 'Generating Content...';
            document.getElementById("smm").style.backgroundColor = "#004c9d";

            const formData = new FormData(form);

            // Helper function to process URLs
            async function processUrls(urlsText, apiUrl) {
                if (!urlsText) {
                    return []; // Return an empty array if the input is blank
                }

                const urls = urlsText.split(/[, \n]+/).filter(url => url.trim() !== "");
                const promises = urls.map(async url => {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ "url": url.trim() })
                        });
                        if (!response.ok) {
                            console.error(`Error fetching data from ${url}: ${response.status} - ${response.statusText}`);
                            return null;
                        }
                        return await response.json();
                    } catch (error) {
                        console.error(`Error fetching data from ${url}:`, error);
                        return null;
                    }
                });
                return (await Promise.all(promises)).filter(data => data !== null);
            }

            try {
                // Process Brand Guide URLs
                const brandGuideUrlsText = formData.get('generator_brand_guide_urls');
                const brandGuideData = await processUrls(brandGuideUrlsText, 'https://i3oxhgicub.execute-api.ap-southeast-1.amazonaws.com/pdfParser');

                // Process Reference URLs
                const referenceUrlsText = formData.get('reference-url');
                const webpageData = await processUrls(referenceUrlsText, 'https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing');

                const contentData = {
                    "reference_post": formData.get('sample-text') || "", // Use empty string as default
                    "content_type": formData.get('content-type') || "blog-post", //added default
                    "post_info": formData.get('post-info') || "",
                    "gender": formData.get('gender') || "",
                    "age-range": formData.get('age-range') || "",
                    "occupation": formData.get('occupation') || "",
                    "income": formData.get('income') || "",
                    "subgroups": formData.get('subgroups') || "",
                    "painpoints": formData.get('painpoints') || "",
                    "audience_goal": formData.get('audience_goal') || "",
                    "product_service": formData.get('product_service') || "",
                    "desired_action": formData.get('desired_action') || "",
                    "post_objectives": formData.get('post_objectives') || "",
                    "word_count": formData.get('word_count') || "",
                    "tone": formData.get('tone') || "",
                    "usp": formData.get('usp') || "",
                    "pov": formData.get('pov') || "",
                    "emojis": formData.get('emojis') || "no", //added default
                    "hashtags": formData.get('hashtags') || "no", //added default
                    "brand_guide": brandGuideData,
                    "webpage_data": webpageData
                };

                const response = await fetch('https://panc0eazwj.execute-api.ap-southeast-1.amazonaws.com/content-generator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(contentData)
                });

                const data = await response.json();

                // Display the API response or error
                if (response.ok) {
                    generatedContentDiv.innerHTML = `<p>${data}</p>`;
                } else {
                    generatedContentDiv.innerHTML = `<p class="error">Error: ${data.error || response.statusText}</p>`;
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                generatedContentDiv.innerHTML = '<p class="error">An error occurred while fetching data.</p>';
            } finally {
                // Re-enable the button and reset text
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Content';
                document.getElementById("smm").style.backgroundColor = "#green";
            }
        });

        function removeFaqItem(button) {
            const item = button.parentNode;
            item.remove();
            updateSchema(); // Update the schema after removing an item
        }

        let breadcrumbItemCount = 2; // Start with 2 items
        function addItem() {
            breadcrumbItemCount++;
            const breadcrumbItemsDiv = document.getElementById('breadcrumb-items');
            const newItem = document.createElement('div');
            newItem.className = "breadcrumb-item";
            newItem.innerHTML = `
            <input type="text" id="name${breadcrumbItemCount}" placeholder="Page #${breadcrumbItemCount}'s name" oninput="updateSchema()">
            <input type="url" id="url${breadcrumbItemCount}" placeholder="URL #${breadcrumbItemCount}" oninput="updateSchema()">
            <button class="remove-item" onclick="removeItem(this)">x</button>
        `;
            breadcrumbItemsDiv.appendChild(newItem);

            // Attach event listeners to new elements
            newItem.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updateSchema);
            });

            updateSchema();
        }

        function removeItem(button) {
            const item = button.parentNode;
            item.remove();
            updateSchema();
        }

        const schemaTypeSelect = document.getElementById('schema-type');
        const inputFieldsDiv = document.getElementById('input-fields');
        const schemaOutputDiv = document.getElementById('schema-output');

        const templates = {
            "LocalBusiness": Handlebars.compile(document.getElementById('local-business-template').innerHTML),
            "Product": Handlebars.compile(document.getElementById('product-template').innerHTML),
            "Event": Handlebars.compile(document.getElementById('event-template').innerHTML),
            "Article": Handlebars.compile(document.getElementById('article-template').innerHTML),
            "BreadcrumbList": Handlebars.compile(document.getElementById('breadcrumblist-template').innerHTML),
            "FAQPage": Handlebars.compile(document.getElementById('faqpage-template').innerHTML),
            "HowTo": Handlebars.compile(document.getElementById('howto-template').innerHTML),
            "JobPosting": Handlebars.compile(document.getElementById('jobposting-template').innerHTML),
            "Organization": Handlebars.compile(document.getElementById('organization-template').innerHTML),
            "Person": Handlebars.compile(document.getElementById('person-template').innerHTML),
            "VideoObject": Handlebars.compile(document.getElementById('video-object-template').innerHTML),
            "Website": Handlebars.compile(document.getElementById('website-template').innerHTML),
        }

        let faqItemCount = 1;

        schemaTypeSelect.addEventListener('change', () => {
            const selectedType = schemaTypeSelect.value;
            const template = templates[selectedType];

            if (template) {
                inputFieldsDiv.innerHTML = template();
                updateSchema(); // Initial update after template render
            } else {
                inputFieldsDiv.innerHTML = ''; // Clear if no template exists
                schemaOutputDiv.textContent = '';
            }


            // Add event listeners after rendering the template
            inputFieldsDiv.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updateSchema);
            });
        });

        // Initial setup (trigger the change event once to populate fields for default type)
        schemaTypeSelect.dispatchEvent(new Event('change'));

        function updateSchema() {
            const selectedType = schemaTypeSelect.value;
            const data = {};

            // Gather input values based on the selected schema type
            for (const input of inputFieldsDiv.querySelectorAll('input')) {
                data[input.id] = input.value;
            }

            try {

                const schema = {
                    "@context": "https://schema.org",
                    "@type": selectedType,
                    ...data // Spread the input data into the schema object
                };

                // Special handling for fields that require JSON-LD structures:
                if (selectedType === "FAQPage" && data.mainEntity) {
                    schema.mainEntity = JSON.parse(data.mainEntity);
                }
                if (selectedType === "BreadcrumbList" && data.itemListElement) {
                    schema.itemListElement = JSON.parse(data.itemListElement);
                }

                if (selectedType === "BreadcrumbList") {
                    const itemListElement = [];

                    for (let i = 1; i <= breadcrumbItemCount; i++) {
                        const name = document.getElementById(`name${i}`);
                        const url = document.getElementById(`url${i}`);

                        if (name && url && name.value && url.value) {
                            itemListElement.push({
                                "@type": "ListItem",
                                "position": i,
                                "name": name.value,
                                "item": url.value
                            });
                        }

                    }
                    if (itemListElement.length > 0) {
                        schema.itemListElement = itemListElement;
                    }

                }


                if (selectedType === "FAQPage") {
                    const mainEntity = [];


                    for (let i = 1; document.getElementById(`question${i}`); i++) {
                        const question = document.getElementById(`question${i}`).value;
                        const answer = document.getElementById(`answer${i}`).value;

                        if (question && answer) {  // Make sure both question and answer are filled
                            mainEntity.push({
                                "@type": "Question",
                                "name": question,
                                "acceptedAnswer": {
                                    "@type": "Answer",
                                    "text": answer
                                }
                            });
                        }

                    }

                    if (mainEntity.length > 0) { // Only add mainEntity if there are FAQ items
                        schema.mainEntity = mainEntity;
                    }

                }

                schemaOutputDiv.textContent = '<script type="application/ld+json">\n' + JSON.stringify(schema, null, 2) + '\n<\/script>';

            } catch (error) {
                schemaOutputDiv.textContent = "Invalid JSON-LD input in one of the fields.";
                console.error("JSON Parsing Error:", error);
            }
        }

        function similarKeywords() {
            const keywordsInput = document.getElementById('keywords').value.split(/[\n,]+/).map(k => k.trim());
            const location = document.getElementById('location').value;
            const language = document.getElementById('language').value;

            if (keywordsInput[0] == "") {
                alert('Please enter keyword(s).');
                return;
            }
            if (!location) {
                alert('Please select a location.');
                return;
            }

            document.getElementById("keyword_suggestions").style.backgroundColor = "#004c9d";
            document.getElementById("expandSimilarKeywords").style.backgroundColor = "#004c9d";
            document.getElementById('keyword_suggestions').innerText = "Generating Similar Keywords..";

            var url = "https://lgvdhcs4t2.execute-api.ap-southeast-1.amazonaws.com/similarKeywords";
            var queryString = {
                "keywords": keywordsInput,
                "location": location,
                "language": language,
                "user": JSON.parse(localStorage.getItem('googleUser')).email
            };

            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json",
            };
            fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(queryString)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('rankingError').innerText = "";
                    displaySimilarKeywords(data);
                    document.getElementById("keyword_suggestions").style.backgroundColor = "green";
                    document.getElementById("expandSimilarKeywords").style.backgroundColor = "green";
                    const keywordSuggestions = document.getElementById("keywordSuggestions");

                    const icon = document.getElementById("expandSimilarKeywords").querySelector('i');

                    if (keywordSuggestions.style.display === "block") {
                        document.getElementById('keyword_suggestions').innerText = "Keyword Suggestions (Similar Keywords / SERPs)";
                    }
                    else {
                        keywordSuggestions.style.display = "block";
                        icon.classList.remove('fa-plus-square');
                        icon.classList.add('fa-minus-square');
                        document.getElementById('keyword_suggestions').innerText = "Keyword Suggestions (Similar Keywords / SERPs)";
                    }
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                    document.getElementById("keyword_suggestions").style.backgroundColor = "#004c9d";
                    document.getElementById('keyword_suggestions').innerText = "Keyword Suggestions (Similar Keywords / SERPs)";
                });
            const tooltip = event.target.querySelector('span');  // Get the tooltip span
            if (tooltip) { // Check if the span element exists
                // The tooltip will now position itself correctly due to the CSS changes
            }
        }

        function rankingKeywords() {
            var domain = document.getElementById('domain').value;
            var location = document.getElementById('location').value;

            document.getElementById('rankingError').textContent = '';
            document.getElementById("ranking_keywords").style.backgroundColor = "#004c9d";
            document.getElementById("expandRankingKeywords").style.backgroundColor = "#004c9d";

            if (!domain) {
                alert('Please enter a URL or domain.');
                return;
            }
            if (!location) {
                alert('Please select a location.');
                return;
            }

            document.getElementById('ranking_keywords').innerText = "Getting Ranked Keywords..";

            var url = "https://0dqny7l5y9.execute-api.ap-southeast-1.amazonaws.com/rankingKeywords";

            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json",
            };

            var queryString = {
                "target": domain,
                "location": location,
                "user": JSON.parse(localStorage.getItem('googleUser')).email
            };

            fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(queryString)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayRankedKeywords(data.body);
                    document.getElementById('ranking_keywords').innerText = "Ranking Keywords"; 
                    document.getElementById("ranking_keywords").style.backgroundColor = "green";
                    document.getElementById("expandRankingKeywords").style.backgroundColor = "green";
                    const rankingKeywordsDiv = document.getElementById("rankingKeywords");
                    const icon = document.getElementById("expandRankingKeywords").querySelector('i');

                    if (rankingKeywordsDiv.style.display === "block") {
                        console.log('Ranking Keywords already displayed');

                    } else {
                        console.log('ranking keywords not displayed');
                        rankingKeywordsDiv.style.display = "block"; // Show the element
                        icon.classList.remove('fa-plus-square');
                        icon.classList.add('fa-minus-square');
                    }
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                    document.getElementById('ranking_keywords').innerText = "Ranking Keywords";  // Consistent use of innerText
                    document.getElementById("ranking_keywords").style.backgroundColor = "#004c9d";
                });
            const tooltip = event.target.querySelector('span');  // Get the tooltip span
            if (tooltip) { // Check if the span element exists
                // The tooltip will now position itself correctly due to the CSS changes
            }
        }

        const modalCache = {};

        function showSerps(keyword) {
            serpSection = document.getElementById("serp-section");
            serpSection.innerHTML = '<div><h2 id="modalKeyword"></h2><b>Search Volume: ' + keywordsCache[keyword]['search_vol'] + '  |  Difficulty: ' + keywordsCache[keyword]['competition'] + '</b><div id="modalContent"></div></div>';
            document.getElementById("modalKeyword").textContent = keyword;

            document.getElementById("modalContent").innerHTML = "<p>Loading SERPs for " + keyword + "...</p>"; // Placeholder

            if (modalCache[keyword]) {
                document.getElementById("modalContent").innerHTML = modalCache[keyword];
                return; // Exit early if data is in cache
            }

            serpModal(keyword).then(data => {
                if (data.error) {
                    document.getElementById("modalContent").innerHTML = "<p class='error'>Error: " + data.error + "</p>";
                    return;
                }

                modalCache[keyword] = document.getElementById("modalContent").innerHTML;

                const urls = Object.values(data.body).map(result => result.url);
                const metricsPromises = urls.map(url => fetchMetrics(url));

                Promise.all(metricsPromises)
                    .then(metricsResults => {
                        addMetricsToTable(data, metricsResults);

                        // Cache the final table HTML
                        modalCache[keyword] = document.getElementById("modalContent").innerHTML;
                    })
                    .catch(error => {
                        console.error("Error fetching metrics:", error);
                        document.getElementById("modalContent").innerHTML += "<p class='error'>Error fetching some metrics.</p>";
                    });

            });

        }

        async function serpModal(keyword) {
            const language = document.getElementById('language').value;
            const location = document.getElementById('location').value;
            user = JSON.parse(localStorage.getItem('googleUser')).email;
            try {
                const response = await fetch('https://8k6r15rg4m.execute-api.ap-southeast-1.amazonaws.com/serpLite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword, language, location, user }),
                });
                const serpData = await response.json();

                // Check for errors in SERP data
                if (serpData.error || serpData.statusCode !== 200) {
                    throw new Error("SERP API Error: " + (serpData.error || "Status code " + serpData.statusCode));
                }

                displayInitialTable(serpData);

                return serpData;


            } catch (error) {
                console.error("Error fetching data:", error);
                return { error: error.message }; // Return error message
            }
        }

        // Function to close the modal
        function closeModal() {
            const modal = document.getElementById("keywordModal");
            if (modal) {
                modal.style.display = "none";
            }
        }

        async function fetchMetrics(domain) { // for moz
            try {
                const response = await fetch('https://a7hptjtc8e.execute-api.ap-southeast-1.amazonaws.com/new', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ domain })
                });

                if (!response.ok) {
                    throw new Error(`Metrics API Error: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();

                return { "DA": data.body.results[0].domain_authority };

                return data.body; // Return the body directly
            } catch (error) {
                console.error("Error fetching metrics:", error);
                return { error: error.message }; // Return error object, better for handling
            }
        }

        function displayInitialTable(data) {
            let tableHtml = "<table><tr><th>Rank</th><th>URL</th><th>Title</th><th>Description</th></tr>";
            for (const rank in data.body) {
                const result = data.body[rank];
                tableHtml += `<tr><td>${rank}</td><td><a href="${result.url}" target="_blank">${result.url.replace('https://', '').replace('http://', '').replace('www.', '')}</a></td><td>${result.title}</td><td>${result.description}</td></tr>`;
            }
            tableHtml += "</table>";
            document.getElementById("modalContent").innerHTML = tableHtml;
        }

        function addMetricsToTable(data, metricsResults) {
            const table = document.getElementById("modalContent").querySelector("table");

            // Add header cells for metrics
            const headerRow = table.rows[0];
            const firstResultMetrics = metricsResults[0] || {}; //Handle missing metrics
            if (!firstResultMetrics.error) {
                for (const metricKey in firstResultMetrics) {
                    if (metricKey !== 'visible_text' && metricKey !== 'word_count' && metricKey !== 'title' && metricKey !== 'description' && metricKey !== 'click_depth') {
                        const th = document.createElement("th");
                        th.textContent = metricKey.replace(/_/g, ' ').toUpperCase();
                        headerRow.appendChild(th);
                    }
                }
            }

            // Add metric data to rows
            for (let i = 0; i < metricsResults.length; i++) {
                const row = table.rows[i + 1]; // Skip header row
                const metrics = metricsResults[i] || {};
                if (!metrics.error) {
                    for (const metricKey in firstResultMetrics) {   //Use firstResultMetrics for keys order
                        if (metricKey !== 'visible_text' && metricKey !== 'word_count' && metricKey !== 'title' && metricKey !== 'description' && metricKey !== 'click_depth') {

                            if (metrics.hasOwnProperty(metricKey)) {
                                const cell = row.insertCell();
                                cell.textContent = metrics[metricKey];
                            } else {
                                row.insertCell(); // Add an empty cell if the metric is missing
                            }

                        }
                    }
                } else {
                    // Add empty cells for all metrics if there is an error
                    for (const metricKey in firstResultMetrics) {
                        if (metricKey !== 'visible_text' && metricKey !== 'word_count' && metricKey !== 'title' && metricKey !== 'description' && metricKey !== 'click_depth') {
                            row.insertCell();
                        }
                    }
                }
            }
        }

        function displayRankedKeywords(rankedKeywordsData) {
            const rankedKeywordList = document.getElementById('rankedKeywordList');
            rankedKeywordList.innerHTML = ''; // Clear previous keywords

            const headerCells = Array.from(document.querySelectorAll('#rankedKeywordHeaderRow .keyword-column'));

            // 1. Transform the data:
            const rankedKeywordsArray = Object.entries(rankedKeywordsData).map(([keyword, data]) => ({
                keyword: keyword,
                search_volume: data.search_volume,
                rank: data.rank,
                difficulty: data.difficulty
            }));

            rankedKeywordsArray.forEach((keywordObj, index) => {
                const listItem = document.createElement('li');
                listItem.classList.add('keyword-row');

                // Keyword column
                const keywordDiv = document.createElement('div');
                keywordDiv.classList.add('keyword-column');
                keywordDiv.style.width = `${headerCells[0].offsetWidth}px`;
                keywordDiv.textContent = keywordObj.keyword;
                listItem.appendChild(keywordDiv);

                // Search Volume column
                const searchVolumeDiv = document.createElement('div');
                searchVolumeDiv.classList.add('keyword-column');
                searchVolumeDiv.style.width = `${headerCells[1].offsetWidth}px`;
                searchVolumeDiv.textContent = keywordObj.search_volume != null ? keywordObj.search_volume.toLocaleString() : '-'; // Handle null search volume
                listItem.appendChild(searchVolumeDiv);

                // Rank
                const rankDiv = document.createElement('div');
                rankDiv.classList.add('keyword-column');
                rankDiv.style.width = `${headerCells[2].offsetWidth}px`;
                rankDiv.textContent = keywordObj.rank || '-';
                listItem.appendChild(rankDiv);

                // Difficulty column
                const difficultyDiv = document.createElement('div');
                difficultyDiv.classList.add('keyword-column');
                difficultyDiv.style.width = `${headerCells[3].offsetWidth}px`;
                difficultyDiv.textContent = keywordObj.difficulty || '-';
                listItem.appendChild(difficultyDiv);

                // Checkbox column
                const checkboxDiv = document.createElement('div');
                checkboxDiv.classList.add('checkbox-column');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = `chk${index + 1}`;
                checkbox.id = `chk${index + 1}`;
                checkbox.value = keywordObj.keyword;
                checkbox.checked = false;
                checkbox.addEventListener('change', updateKeywordsField);
                checkboxDiv.appendChild(checkbox);
                listItem.appendChild(checkboxDiv);

                rankedKeywordList.appendChild(listItem);
            });
            updateRankedKeywordsCount();
            document.getElementById('rankingKeywordsExport').style.display = 'block';
            rankedKeywordList.innerHTML += '<button type="button" id="get-more-keywords-button" onclick="getMoreRanked()">Get More Keywords</button>';
        }

        document.getElementById('rankedKeywordList').addEventListener('change', function (event) {
            if (event.target.type === 'checkbox') { // Only handle checkbox changes
                updateKeywordsField();
            }
        });


        const keywordTable = document.getElementById('keywordTable');
        const top100Table = document.getElementById('top100Table');

        async function getMoreRanked() {
            document.getElementById('rankedKeywordList').innerHTML = document.getElementById('rankedKeywordList').innerHTML.replace('<button type="button" id="get-more-keywords-button" onclick="getMoreRanked()">Get More Keywords</button>', '<button type="button" disabled id="get-more-keywords-button" onclick="getMoreRanked()">Getting Keywords</button>')
            const target = document.getElementById('domain').value;
            const language = document.getElementById('language').value;
            const location = document.getElementById('location').value;

            const apiUrl = 'https://ei6xj9x2rd.execute-api.ap-southeast-1.amazonaws.com/keywordsForSite';
            const requestBody = {
                location: location,
                language: language,
                target: target
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Clear existing table rows (except header)
                while (keywordTable.rows.length > 1) {
                    keywordTable.deleteRow(1);
                }

                // Clear top100Table rows (except header) before new data is added
                while (top100Table.rows.length > 1) {
                    top100Table.deleteRow(1);
                }

                document.getElementById("get-more-keywords-button").remove();

                const rankCheckerPromises = []; // Store promises for rank checking API calls

                for (const keyword in data) {
                    const row = keywordTable.insertRow();
                    const keywordCell = row.insertCell();
                    const volumeCell = row.insertCell();
                    const competitionCell = row.insertCell();
                    const rankCell = row.insertCell(); // New cell for rank

                    keywordCell.innerHTML = keyword;
                    volumeCell.innerHTML = data[keyword].search_volume;
                    competitionCell.innerHTML = data[keyword].competition || "N/A"; // Handle null competition

                    // Make rank checker API call and update rankCell when resolved
                    const rankCheckerApiUrl = 'https://v5bizygr4m.execute-api.ap-southeast-1.amazonaws.com/rankChecker';
                    const rankRequestBody = {
                        keyword: keyword,
                        language: language,
                        location: location,
                        target: target
                    };

                    const rankPromise = fetch(rankCheckerApiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(rankRequestBody)
                    }).then(res => {
                        if (!res.ok) {
                            throw new Error(`Rank checker HTTP error! status: ${res.status}`);
                        }
                        return res.json();
                    }).then(rankData => {

                        rankCell.innerHTML = rankData || 999; // Handle cases where rank is unavailable

                        const rank = parseInt(rankData); // Parse rankData to integer
                        if (rank >= 1 && rank <= 100) {
                            const top100Row = top100Table.insertRow();
                            const top100KeywordCell = top100Row.insertCell();
                            const top100VolumeCell = top100Row.insertCell();
                            const top100CompetitionCell = top100Row.insertCell();
                            const top100RankCell = top100Row.insertCell();

                            top100KeywordCell.innerHTML = keyword;
                            top100VolumeCell.innerHTML = data[keyword].search_volume;
                            top100CompetitionCell.innerHTML = data[keyword].competition || "N/A";
                            top100RankCell.innerHTML = rank;

                            const rankedKeywordList = document.getElementById('rankedKeywordList');
                            const headerCells = Array.from(document.querySelectorAll('#rankedKeywordHeaderRow .keyword-column'));
                            const currentKeywordCount = rankedKeywordList.querySelectorAll('li.keyword-row').length; //Correct length

                            // Append to rankedKeywordList (using a separate function for clarity)
                            appendRankedKeyword({ // Pass data as an object
                                keyword: keyword,
                                search_volume: data[keyword].search_volume,
                                rank: rank, // Use the parsed rank value
                                difficulty: data[keyword].competition || "N/A"
                            }, rankedKeywordList.children.length, headerCells, rankedKeywordList); // Use children.length to get correct index
                        }
                    }).catch(error => {
                        console.error('Error checking rank:', error);
                        rankCell.innerHTML = "Error"; // Indicate an error in the rank cell
                    });
                    rankCheckerPromises.push(rankPromise);
                }
                // Wait for all rank checking API calls to complete
                await Promise.all(rankCheckerPromises);


            } catch (error) {
                console.error('Error fetching keyword data:', error);
                // Display error message in the table or elsewhere on the page
                keywordTable.innerHTML = "<tr><td>Error fetching data.</td></tr>";

            }

        }

        function appendRankedKeyword(item, index, headerCells, rankedKeywordList) {
            const listItem = document.createElement('li');
            listItem.classList.add('keyword-row');

            // Column 0: Keyword
            const keywordDiv = document.createElement('div');
            keywordDiv.classList.add('keyword-column');
            keywordDiv.textContent = item.keyword;
            listItem.appendChild(keywordDiv);

            // Column 1: Search Volume
            const searchVolumeDiv = document.createElement('div');
            searchVolumeDiv.classList.add('keyword-column');
            searchVolumeDiv.textContent = item.search_volume || '-';
            listItem.appendChild(searchVolumeDiv);

            // Column 2: Rank
            const rankDiv = document.createElement('div');
            rankDiv.classList.add('keyword-column');
            rankDiv.textContent = item.rank || '-';
            listItem.appendChild(rankDiv);

            // Column 3: Difficulty
            const difficultyDiv = document.createElement('div');
            difficultyDiv.classList.add('keyword-column');
            difficultyDiv.textContent = item.difficulty || '-';
            listItem.appendChild(difficultyDiv);

            // Column 4: Checkbox
            const checkboxDiv = document.createElement('div');
            checkboxDiv.classList.add('checkbox-column');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = item.keyword;
            checkbox.addEventListener('change', updateKeywordsField);
            checkboxDiv.appendChild(checkbox);
            listItem.appendChild(checkboxDiv);

            rankedKeywordList.appendChild(listItem);
            updateRankedKeywordsCount();

            document.getElementById('rankedKeywordList').innerHTML = document.getElementById('rankedKeywordList').innerHTML.replace('<button type="button" disabled id="get-more-keywords-button" onclick="getMoreRanked()">Getting Keywords</button>', '');
        }

        keywordsCache = {};

        function displaySimilarKeywords(keywordsData) {
            const keywordList = document.getElementById('keywordList');
            keywordList.innerHTML = ''; // Clear previous keywords

            const headerCells = Array.from(document.querySelectorAll('#keywordHeaderRow .keyword-column'));

            // 1. Transform the data:
            const keywordsArray = Object.entries(keywordsData.body).map(([keyword, data]) => ({
                keyword,
                search_volume: data.search_volume,
                competition: data.competition,
                cpc: data.cpc
            }));

            keywordsArray.forEach((keywordObj, index) => {
                const listItem = document.createElement('li');
                listItem.classList.add('keyword-row');

                // Keyword column
                const keywordDiv = document.createElement('div');
                keywordDiv.classList.add('keyword-column');
                keywordDiv.style.width = `${headerCells[0].offsetWidth}px`;
                keywordDiv.textContent = keywordObj.keyword;
                keywordDiv.addEventListener('click', () => showSerps(keywordObj.keyword));
                listItem.appendChild(keywordDiv);

                // Search Volume column
                const searchVolumeDiv = document.createElement('div');
                searchVolumeDiv.classList.add('keyword-column');
                searchVolumeDiv.style.width = `${headerCells[1].offsetWidth}px`;
                searchVolumeDiv.textContent = keywordObj.search_volume != null ? keywordObj.search_volume.toLocaleString() : '-'; // Handle null search volume
                listItem.appendChild(searchVolumeDiv);

                // Difficulty column
                const difficultyDiv = document.createElement('div');
                difficultyDiv.classList.add('keyword-column');
                difficultyDiv.style.width = `${headerCells[2].offsetWidth}px`;
                difficultyDiv.textContent = keywordObj.competition || '-';
                listItem.appendChild(difficultyDiv);

                // CPC column
                const cpcDiv = document.createElement('div');
                cpcDiv.classList.add('keyword-column');
                cpcDiv.style.width = `${headerCells[3].offsetWidth}px`;
                cpcDiv.textContent = keywordObj.cpc || '-';
                listItem.appendChild(cpcDiv);

                // Checkbox column
                const checkboxDiv = document.createElement('div');
                checkboxDiv.classList.add('checkbox-column');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = `chk${index + 1}`;
                checkbox.id = `chk${index + 1}`;
                checkbox.value = keywordObj.keyword;
                checkbox.checked = false;
                checkbox.addEventListener('change', updateKeywordsField);
                checkboxDiv.appendChild(checkbox);
                listItem.appendChild(checkboxDiv);

                keywordList.appendChild(listItem);

                keywordsCache[keywordObj.keyword] = {};
                keywordsCache[keywordObj.keyword]['search_vol'] = keywordObj.search_volume != null ? keywordObj.search_volume.toLocaleString() : '-';
                keywordsCache[keywordObj.keyword]['competition'] = keywordObj.competition;
                keywordsCache[keywordObj.keyword]['cpc'] = keywordObj.cpc;
            });
            document.getElementById('keywordSuggestionsExport').style.display = 'block';
        }

        function updateRankedKeywordsCount() {
            const rankedKeywordList = document.getElementById('rankedKeywordList');
            const count = rankedKeywordList.querySelectorAll('li.keyword-row').length; // Count only the keyword rows (li elements)
            const heading = document.getElementById('rankedKeywordsCount');
            heading.textContent = `Ranked Keywords (${count}):`; // Update the heading text
        }

        function updateKeywordCount() {
            const keywordsTextArea = document.getElementById('keywords');
            const keywords = keywordsTextArea.value.split(/[\n,]+/).map(k => k.trim()).filter(Boolean); // Split by comma or newline, trim whitespace, remove empty strings
            const keywordCountSpan = document.getElementById('keywordCount');
            keywordCountSpan.textContent = `${keywords.length} keyword(s) selected`;
        }

        function updateKeywordsField() {
            const keywordsTextArea = document.getElementById('keywords');
            const checkedKeywords = new Set(); // Use a Set to store unique values

            // Get checked keywords from both tables
            try {
                const rankedKeywordsCheckboxes = document.querySelectorAll('#rankedKeywordList input[type="checkbox"]:checked');
                rankedKeywordsCheckboxes.forEach(checkbox => checkedKeywords.add(checkbox.value));
            } catch (error) {
                console.log(error);
            }

            try {
                const similarKeywordsCheckboxes = document.querySelectorAll('#keywordList input[type="checkbox"]:checked');
                similarKeywordsCheckboxes.forEach(checkbox => checkedKeywords.add(checkbox.value));
            } catch (error) {
                console.log(error);
            }

            try {
                const webpageKeywordsCheckboxes = document.querySelectorAll('#siteKeywords input[type="checkbox"]:checked');
                webpageKeywordsCheckboxes.forEach(checkbox => checkedKeywords.add(checkbox.value));
            } catch (error) {
                console.log(error);
            }

            keywordsTextArea.value = Array.from(checkedKeywords).join(', '); // Convert Set back to array before joining
            updateKeywordCount();
        }

        async function validateAndSubmit() {
            const domain = document.getElementById('domain').value;
            const keywordsInput = document.getElementById('keywords').value;
            const location = document.getElementById('location').value;
            const language = document.getElementById('language').value;

            document.getElementById('domainError').textContent = '';
            document.getElementById('keywordsError').textContent = '';

            if (!keywordsInput) {
                document.getElementById('keywordsError').textContent = 'Please enter one or more keywords.';
                return;
            }
            if (!location) {
                alert("Please select a location.");
                return;
            }

            const keywords = keywordsInput.split(/[\n,]+/).map(k => k.trim()).filter(Boolean);

            document.getElementById('targetTitle').innerText = "";
            document.getElementById('targetDescription').innerText = "";
            //document.getElementById('targetDomainRank').innerText = "";
            document.getElementById('targetBacklinks').innerText = "";
            document.getElementById('targetSpamScore').innerText = "";
            document.getElementById('targetRefDomains').innerText = "";
            document.getElementById('targetInternalLinks').innerText = "";
            document.getElementById('targetExternalLinks').innerText = "";
            document.getElementById('targetH1').innerText = "";
            document.getElementById('targetImages').innerText = "";
            document.getElementById('targetCls').innerText = "";
            document.getElementById('targetLcp').innerText = "";
            document.getElementById('targetFid').innerText = "";
            document.getElementById('targetSchema').innerText = "";
            document.getElementById('targetReadability').innerText = "";
            document.getElementById('targetWordCount').innerText = "";
            document.getElementById('da').innerText = "";
            document.getElementById('pa').innerText = "";

            document.getElementById("meta_data").style.backgroundColor = "#004c9d";
            document.getElementById("domain_metrics").style.backgroundColor = "#004c9d";
            document.getElementById("keywordAnalysisBtn").style.backgroundColor = "#004c9d";

            if (!domain) { // if no target URL / domain
            } else {
                fetchDomainMetrics(domain);
            }

            await fetchKeywordMetrics(keywords, location, language);

            // **AWAIT ALL `keywordAnalysis` CALLS**
            await Promise.all(keywords.map(async keyword => {
                try {
                    await keywordAnalysis(keyword, language, location, domain);
                } catch (error) {
                    console.error(`Error during analysis for keyword ${keyword}:`, error);
                    // Display error in the keyword's collapsible section
                    const keywordContainer = document.getElementById(`keyword-container-${keyword.replace(/\s+/g, '-')}`);
                    if (keywordContainer) {
                        keywordContainer.innerHTML += `<p class="error">Error during analysis: ${error.message}</p>`;
                    }
                }
            }));

            // **NOW, displayOverallSummaryTable AFTER `keywordAnalysis` IS DONE for all keywords**
            await displayOverallSummaryTable(keywords, location, language, domain);
            await timeToRankToDatabase();
        }

        function displayTargetContentTable(targetContent, containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Element with ID '${containerId}' not found.`);
                return;
            }

            let tableHTML = `
        <h2>Possible URLs for KW Mapping</h2>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>URL</th>
                <th>Title</th>
                <th>Description</th>
                <th>Domain Rank</th>
                <th>Backlinks</th>
                <th>Referring Domains</th>
                <th>Internal Links Count</th>
                <th>External Links Count</th>
                <th>Image Count</th>
                <th>CLS</th>
                <th>LCP</th>
                <th>FID</th>
                <th>Schema</th>
                <th>Readability</th>
                <th>Word Count</th>
                <th>Keyword in URL</th>
                <th>Keyword in Title</th>
                <th>Keyword in Description</th>
                <th>Keyword in H1</th>
                <th>Keyword in H2</th>
                <th>Keyword in Alt</th>
                <th>Keyword in Text</th>
              </tr>
            </thead>
            <tbody>
      `;

            targetContent.forEach(item => {
                tableHTML += `
            <tr>
              <td>${item.rank || 'N/A'}</td>
              <td><a href="${item.url}" target="_blank">${item.url}</a></td>
              <td>${item.title || 'N/A'}</td>
              <td>${item.description || 'N/A'}</td>
              <td>${item.domain_rank || 'N/A'}</td>
              <td>${item.backlinks || 'N/A'}</td>
              <td>${item.referring_domains || 'N/A'}</td>
              <td>${item.internal_links_count || 'N/A'}</td>
              <td>${item.external_links_count || 'N/A'}</td>
              <td>${item.image || 'N/A'}</td>
              <td>${item.cls || 'N/A'}</td>
              <td>${item.lcp || 'N/A'}</td>
              <td>${item.fid || 'N/A'}</td>
              <td>${item.schema || 'N/A'}</td>
              <td>${item.readability || 'N/A'}</td>
              <td>${item.word_count || 'N/A'}</td>
              <td>${item.eval?.kw_in_url || 'N/A'}</td>
              <td>${item.eval?.kw_in_title || 'N/A'}</td>
              <td>${item.eval?.kw_in_desc || 'N/A'}</td>
              <td>${item.eval?.kw_in_h1 || 'N/A'}</td>
              <td>${item.eval?.kw_in_h2 || 'N/A'}</td>
              <td>${item.eval?.kw_in_alt || 'N/A'}</td>
              <td>${item.eval?.kw_in_text || 'N/A'}</td>
            </tr>
          `;
            });

            tableHTML += `
            </tbody>
          </table>
        </div>
      `;

            container.innerHTML = tableHTML;
        }

        async function displaySerpResults(serpResults, containerId) {
            const resultsContainer = document.getElementById(containerId);
            if (!resultsContainer) {
                console.error(`Element with ID '${containerId}' not found.`);
                return;
            }

            let tableHTML = `
        <h2>SERP Results</h2>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>URL</th>
                <th>Title</th>
                <th>Description</th>
                <th>Domain Rank</th>
                <th>Backlinks</th>
                <th>Backlinks Spam Score</th>
                <th>Referring Domains</th>
                <th>Internal Links Count</th>
                <th>External Links Count</th>
                <th>Image Count</th>
                <th>CLS</th>
                <th>LCP</th>
                <th>FID</th>
                <th>Schema</th>
                <th>Readability</th>
                <th>Word Count</th>
                <th>Keyword in URL</th>
                <th>Keyword in Title</th>
                <th>Keyword in Description</th>
                <th>Keyword in H1</th>
                <th>Keyword in H2</th>
                <th>Keyword in Alt</th>
                <th>Keyword in Text</th>
              </tr>
            </thead>
            <tbody>
      `;

            serpResults.forEach(result => {
                tableHTML += `
            <tr>
              <td>${result.rank}</td>
              <td><a href="${result.url}" target="_blank">${result.url}</a></td>
              <td>${result.title}</td>
              <td>${result.description}</td>
              <td>${result.domain_rank || 'N/A'}</td>
              <td>${result.backlinks || 'N/A'}</td>
              <td>${result.backlinks_spam_score || 'N/A'}</td>
              <td>${result.referring_domains || 'N/A'}</td>
              <td>${result.internal_links_count || 'N/A'}</td>
              <td>${result.external_links_count || 'N/A'}</td>
              <td>${result.image || 'N/A'}</td>
              <td>${result.cls || 'N/A'}</td>
              <td>${result.lcp || 'N/A'}</td>
              <td>${result.fid || 'N/A'}</td>
              <td>${result.schema || 'N/A'}</td>
              <td>${result.readability || 'N/A'}</td>
              <td>${result.word_count || 'N/A'}</td>
              <td>${result.eval?.kw_in_url || 'N/A'}</td>
              <td>${result.eval?.kw_in_title || 'N/A'}</td>
              <td>${result.eval?.kw_in_desc || 'N/A'}</td>
              <td>${result.eval?.kw_in_h1 || 'N/A'}</td>
              <td>${result.eval?.kw_in_h2 || 'N/A'}</td>
              <td>${result.eval?.kw_in_alt || 'N/A'}</td>
              <td>${result.eval?.kw_in_text || 'N/A'}</td>
            </tr>
          `;
            });

            tableHTML += `
            </tbody>
          </table>
        </div>
      `;

            resultsContainer.innerHTML = tableHTML;
        }

        function displayKeywordRecommendations(recommendations, containerId) {
            const recommendationsContainer = document.getElementById(containerId);
            if (!recommendationsContainer) {
                console.error(`Element with ID '${containerId}' not found.`);
                return;
            }

            recommendationsContainer.innerHTML = `${recommendations}`;
        }

        async function getKeywordRecommendations(keyword, language, location, target_url, serp_dict) {
            const keywordMappingEndpoint = 'https://c0bkxhc1s3.execute-api.ap-southeast-1.amazonaws.com/keywordMapping';
            const kwRecommendationsEndpoint = 'https://pkbguam62a.execute-api.ap-southeast-1.amazonaws.com/kwRecommendationsStructured';
            const targetContentTableContainerId = `target-content-table-container-${keyword.replace(/\s+/g, '-')}`;

            try {
                // 1. Keyword Mapping API
                const keywordMappingResponse = await fetch(keywordMappingEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        location: location,
                        keyword: keyword,
                        language: language,
                        target: target_url //use target_url instead of target.
                    })
                });

                if (!keywordMappingResponse.ok) {
                    throw new Error(`Keyword Mapping API Error for ${keyword}: ${keywordMappingResponse.status} ${keywordMappingResponse.statusText}`);
                }

                const keywordMappingData = await keywordMappingResponse.json();
                console.log(`Keyword Mapping API Response for ${keyword}:`, keywordMappingData);

                if (keywordMappingData && keywordMappingData.body && Array.isArray(keywordMappingData.body)) {
                    const targetUrls = keywordMappingData.body;

                    // 2. Get Domain Metrics for Target URLs & Rank Checking
                    const targetDataPromises = targetUrls.map(async (url) => {
                        const domainMetrics = await getDomainMetrics(url, keyword);
                        //const rankData = await getRankForUrl(url, keyword, language, location);  Remove this.

                        return {
                            url: url,
                            ...domainMetrics?.body,
                            title: keywordMappingData.dict[url]?.title || 'N/A',
                            description: keywordMappingData.dict[url]?.description || 'N/A',
                            //rank: rankData  Remove this
                        };
                    });

                    const targetData = await Promise.all(targetDataPromises);

                    console.log(`Target Content with Metrics and Rank for ${keyword}:`, targetData);

                    //Get the rank from the targetData table
                    const targetDataWithRank = await Promise.all(
                        targetData.map(async (item) => {
                            const rankData = await getRankForUrl(item.url, keyword, language, location);
                            return {
                                ...item,
                                rank: rankData
                            };
                        })
                    );

                    displayTargetContentTable(targetDataWithRank, targetContentTableContainerId);

                    // 3. Call Keyword Recommendations API
                    if (serp_dict) {
                        const kwRecommendationsResponse = await fetch(kwRecommendationsEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                keyword: keyword,
                                target_content: targetDataWithRank.map(item => ({ url: item.url, domain_metrics: item, rank: item.rank })), // Pass all data as domain_metrics
                                serps_dict: serp_dict
                            })
                        });

                        if (!kwRecommendationsResponse.ok) {
                            throw new Error(`Keyword Recommendations API Error for ${keyword}: ${kwRecommendationsResponse.status} ${kwRecommendationsResponse.statusText}`);
                        }

                        const kwRecommendationsData = await kwRecommendationsResponse.json();
                        console.log(`Keyword Recommendations API Response for ${keyword}:`, kwRecommendationsData);

                        displayKeywordRecommendations(kwRecommendationsData.body, `recommendations-container-${keyword.replace(/\s+/g, '-')}`);

                        // Extract Time to Rank using regex
                        const timeToRankMatch = kwRecommendationsData.body.match(/(0-3 months|3-6 months|6-9 months|9-12 months|more than 12 months)/);
                        const timeToRank = timeToRankMatch ? timeToRankMatch[0] : 'N/A';
                        return timeToRank;
                    } else {
                        console.warn(`Skipping Keyword Recommendations for ${keyword} due to missing serp_dict.`);
                        return 'N/A';
                    }
                } else {
                    console.warn(`Invalid Keyword Mapping API response format for ${keyword}. Expected 'body' as array.`);
                    return 'N/A';
                }

            } catch (error) {
                console.error(`Error during Keyword Mapping, Target Content Processing, or Keyword Recommendations for ${keyword}:`, error);
                return 'N/A';
            }
        }

        async function getRankForUrl(url, keyword, language, location) {
            try {
                const rankCheckerResponse = await fetch('https://v5bizygr4m.execute-api.ap-southeast-1.amazonaws.com/rankChecker', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword: keyword,
                        language: language,
                        location: location,
                        target: url // Set target to the current URL
                    })
                });

                if (rankCheckerResponse.ok) {
                    const rankCheckerData = await rankCheckerResponse.json();
                    return rankCheckerData; // Returns rank number.
                } else {
                    console.error(`Rank Checker API error for ${url}:`, rankCheckerResponse.status);
                    return 'N/A';
                }
            } catch (error) {
                console.error(`Error fetching rank for ${url}:`, error);
                return 'N/A';
            }
        }

        let allKeywords = [];
        let currentSortColumn = null;
        let sortAscending = true;
        let keywordMetrics = {}; // Store search volume and cpc
        let summaryData = [];

        async function getDomainMetrics(url, keyword) {
            const domainMetricsEndpoint = 'https://5zdbpwaia5.execute-api.ap-southeast-1.amazonaws.com/pageDomainMetrics';

            try {
                const response = await fetch(domainMetricsEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url,
                        keyword: keyword
                    })
                });

                if (!response.ok) {
                    console.warn(`Domain Metrics API Error for URL ${url}: ${response.status} ${response.statusText}`);
                    return null;
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error(`Error fetching domain metrics for URL ${url}:`, error);
                return null;
            }
        }

        async function keywordAnalysis(keyword, language, location, target) {
            user = JSON.parse(localStorage.getItem('googleUser')).email;
            const analysisResultsContainer = document.getElementById('keyword-analysis-results');
            const keywordContainerId = `keyword-container-${keyword.replace(/\s+/g, '-')}`;

            document.getElementById("keywordAnalysisBtn").style.backgroundColor = "#004c9d";

            // Create a collapsible section for the keyword
            const collapsibleSection = document.createElement('div');
            collapsibleSection.id = keywordContainerId;
            collapsibleSection.innerHTML = `
            <button type="button" class="keywords-collapsible">${keyword}</button>
            <div class="keywords-content" id="keyword-content-${keyword.replace(/\s+/g, '-')}">
                <div id="target-content-table-container-${keyword.replace(/\s+/g, '-')}"></div>
                <div id="results-container-${keyword.replace(/\s+/g, '-')}"></div>
                <div id="recommendations-container-${keyword.replace(/\s+/g, '-')}"></div>
            </div>
            `;
            analysisResultsContainer.appendChild(collapsibleSection);

            // Add event listener for the collapsible button
            const coll = collapsibleSection.querySelector(".keywords-collapsible");
            coll.addEventListener("click", function () {
                this.classList.toggle("keywords-active");
                const content = this.nextElementSibling;
                if (content.style.display === "block") {
                    content.style.display = "none";
                } else {
                    content.style.display = "block";
                }
            });

            try {
                const serpEndpoint = 'https://8k6r15rg4m.execute-api.ap-southeast-1.amazonaws.com/serpLite';
                const serpResponse = await fetch(serpEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keyword: keyword,
                        language: language,
                        location: location,
                        user: user
                    })
                });

                if (!serpResponse.ok) {
                    throw new Error(`SERP API Error: ${serpResponse.status} ${serpResponse.statusText}`);
                }

                const serpData = await serpResponse.json();
                console.log(`SERP API Response for ${keyword}:`, serpData);

                if (!serpData || !serpData.body) {
                    throw new Error(`Invalid SERP API response format for ${keyword}. Expected 'body' property.`);
                }

                const serp_dict = serpData.body;

                // Fetch domain metrics for SERP results and then display them
                const serpResultsWithMetrics = await Promise.all(
                    Object.entries(serp_dict).map(async ([rank, result]) => {
                        const domainMetrics = await getDomainMetrics(result.url, keyword);
                        return {
                            rank: rank,
                            ...result,
                            ...domainMetrics?.body // Add domain metrics to the result object
                        };
                    })
                );

                displaySerpResults(serpResultsWithMetrics, `results-container-${keyword.replace(/\s+/g, '-')}`);

                // Await the keyword recommendations
                const timeToRank = await getKeywordRecommendations(keyword, language, location, target, serp_dict);

                // Update the keywordMetrics object with time to rank
                keywordMetrics[keyword] = {
                    ...keywordMetrics[keyword],
                    timeToRank: timeToRank
                };

                console.log("Keyword Metrics after keywordAnalysis:", keywordMetrics);

                await displayOverallSummaryTable(keywords, location, language, target);
                document.getElementById('keyword-research-analysis-button').innerText = "Analyse";

            } catch (error) {
                console.error(`An error occurred for ${keyword}:`, error);
                const container = document.getElementById(`results-container-${keyword.replace(/\s+/g, '-')}`);
                container.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                document.getElementById('keyword-research-analysis-button').innerText = "Analyse";
            }
        }

        async function timeToRankToDatabase() {
            endpoint = "https://0tmfunltch.execute-api.ap-southeast-1.amazonaws.com/timeToRankToDatabase";

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    url: document.getElementById('domain').value,
                    keywords: document.getElementById('keywords').value,
                    language: document.getElementById('language').value,
                    location: document.getElementById('location').value,
                    ranking_keywords: document.getElementById('rankingKeywords').innerHTML,
                    webpage_keywords: document.getElementById('siteKeywords').innerHTML,
                    suggestion_keywords: document.getElementById('keywordSuggestions').innerHTML,

                    meta_data: document.getElementById('metaData').innerHTML,
                    domain_metrics: document.getElementById('domainMetrics').innerHTML,

                    time_to_rank_table: document.getElementById('overall-summary').innerHTML,
                    keyword_analysis: document.getElementById('keywordAnalysis').innerHTML,

                    user: JSON.parse(localStorage.getItem('googleUser')).email
                })
            })

            data = await response.json();
        }

        async function displayOverallSummaryTable(keywords, location, language, target) {
            keywordsInput = document.getElementById('keywords').value;
            keywords = keywordsInput.split(',').map(keyword => keyword.trim()).filter(keyword => keyword !== "");
            const summaryContainer = document.getElementById('overall-summary');
            if (!summaryContainer) {
                console.error("Summary container not found");
                return;
            }

            // Prepare the data for the summary table, using keywordMetrics
            summaryData = keywords.map((keyword, index) => {
                const metrics = keywordMetrics[keyword] || {
                    cpc: 'N/A',
                    search_volume: 'N/A',
                    timeToRank: 'N/A'
                }; // Provide default values

                return {
                    No: index + 1,
                    keyword: keyword,
                    search_volume: metrics.search_volume || 'N/A',
                    cpc: metrics.cpc || 'N/A',
                    timeToRank: metrics.timeToRank || 'N/A',
                    reason: '' // Initialize the 'Reason' field
                };
            });


            let tableHTML = `
        <h2>Overall Keyword Summary</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>No.</th>
                        <th onclick="sortSummaryTable('keyword')">Keyword</th>
                        <th onclick="sortSummaryTable('search_volume')">Search Volume</th>
                        <th onclick="sortSummaryTable('cpc')">CPC</th>
                        <th onclick="sortSummaryTable('timeToRank')">Time to Rank</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody>
      `;

            for (let index = 0; index < summaryData.length; index++) {
                const item = summaryData[index];
                const timeToRankClass = getTimeToRankClass(item.timeToRank);

                // Fetch initial reason from API
                const reason = await fetchReasonFromAPI(item.keyword, location, language, target);
                summaryData[index].reason = reason; // Update summaryData with initial reason

                tableHTML += `
            <tr>
              <td>${item.No}</td>
              <td>${item.keyword}</td>
              <td>${item.search_volume}</td>
              <td>${item.cpc}</td>
              <td class="${timeToRankClass}">${item.timeToRank}</td>
              <td><textarea class="multiline-input" id="reason-${index}" onchange="updateReason(${index}, this.value)">${reason}</textarea></td>
              </tr>
          `;
            }

            tableHTML += `
                </tbody>
            </table>
        </div>
      `;

            summaryContainer.innerHTML = tableHTML + '<button id="downloadCsvBtn" onclick="downloadOverallSummaryTableAsCSV()">Download Keyword Summary as CSV</button><br><br>';

            // Show the download button
            document.getElementById('overall-summary').style.display = 'block';
            document.getElementById('downloadCsvBtn').style.display = 'block';

            document.getElementById("keywordAnalysisBtn").style.backgroundColor = "green";

        }

        function getTimeToRankClass(timeToRank) {
            if (timeToRank === 'more than 12 months') {
                return 'time-to-rank-more-than-12';
            } else if (timeToRank === '9-12 months') {
                return 'time-to-rank-9-12';
            } else if (timeToRank === '6-9 months') {
                return 'time-to-rank-6-9';
            } else if (timeToRank === '3-6 months') {
                return 'time-to-rank-3-6';
            } else if (timeToRank === '0-3 months') {
                return 'time-to-rank-0-3';
            } else {
                return ''; // Default class or no class
            }
        }

        async function fetchReasonFromAPI(keyword, location, language, target) {
            const reasonApiEndpoint = "https://cdahvw5qi7.execute-api.ap-southeast-1.amazonaws.com/reasonForKwSelection";

            try {
                const response = await fetch(reasonApiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        location: location,
                        language: language,
                        target: target,
                        keyword: keyword
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.body;
                } else {
                    console.error("Error fetching reason from API:", response.status);
                    return ''; // Return empty string in case of error
                }
            } catch (error) {
                console.error("Error fetching reason from API:", error);
                return ''; // Return empty string in case of error
            }
        }

        // Function to update the 'Reason' in the summaryData array
        function updateReason(index, reason) {
            summaryData[index].reason = reason;
        }

        let currentSummarySortColumn = null;
        let summarySortAscending = true;

        function fetchDomainMetrics(domain) {
            document.getElementById('keyword-research-analysis-button').innerText = "Analysing...";

            //moz 
            var url = "https://a7hptjtc8e.execute-api.ap-southeast-1.amazonaws.com/new";
            var queryString = {
                "domain": domain
            };
            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json"
            };
            fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(queryString)
            })
                .then(response => {
                    // Check if the response is successful
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('da').innerText = data.body.results[0].domain_authority;
                    document.getElementById('pa').innerText = data.body.results[0].page_authority;
                })
                .catch(error => {
                    console.error("Error fetching data:", error); // Log any errors
                    // Handle the error gracefully, perhaps display an error message to the user
                });

            api_url = "https://9px7sjbyyb.execute-api.ap-southeast-1.amazonaws.com/new";
            var headers = {
                "Accept": "application/json",
                "Content-Type": "application/json"
            };
            fetch(api_url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ url: domain })
            }).then(response => {
                // Check if the response is successful
                if (!response.ok) {
                    throw new Error(`Error obtaining domain metrics Status: ${response.status}`);
                }
                return response.json();
            })
                .then(data => {
                    console.log(data);
                    document.getElementById('targetTitle').innerText = data.body.title;
                    document.getElementById('targetDescription').innerText = data.body.description;
                    document.getElementById('targetBacklinks').innerText = data.body.backlinks;
                    document.getElementById('targetSpamScore').innerText = data.body.backlinks_spam_score;
                    document.getElementById('targetRefDomains').innerText = data.body.referring_domains;
                    document.getElementById('targetInternalLinks').innerText = data.body.internal_links_count;
                    document.getElementById('targetExternalLinks').innerText = data.body.external_links_count;
                    document.getElementById('targetH1').innerText = data.body.h1;
                    document.getElementById('targetImages').innerText = data.body.image;
                    document.getElementById('targetCls').innerText = data.body.cls;
                    document.getElementById('targetLcp').innerText = data.body.lcp;
                    document.getElementById('targetFid').innerText = data.body.fid;
                    document.getElementById('targetSchema').innerText = data.body.schema;
                    document.getElementById('targetReadability').innerText = data.body.readability;
                    document.getElementById('targetWordCount').innerText = data.body.word_count;

                    document.getElementById("meta_data").style.backgroundColor = "green";
                    document.getElementById("domain_metrics").style.backgroundColor = "green";
                })
                .catch(error => {
                    console.error("Error fetching targeted domain data:", error); // Log any errors
                    // Handle the error gracefully, perhaps display an error message to the user
                });
        }

        async function fetchSerpResults(keyword, location, domain) {
            user = JSON.parse(localStorage.getItem('googleUser')).email
            const apiEndpoint = "https://u22k9g2y8c.execute-api.ap-southeast-1.amazonaws.com/new";
            const requestBody = {
                location: location,
                keyword: keyword,
                targeted_url: domain,
                language: document.getElementById("location").value,
                user: user
            };

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                console.log(data);
                return data;
            } catch (error) {
                console.error('Error fetching SERP data:', error);
                return null;
            }
        }

        function removeRow(button) {
            let row = button.parentNode.parentNode;
            row.parentNode.removeChild(row);
        }

        function sortTable(column) {
            const table = document.getElementById("keywordResults");
            const rows = Array.from(table.rows);
            const dir = this.asc ? 'asc' : 'desc';

            rows.sort((a, b) => {
                // **Convert cell content to numbers before comparison:**
                const ax = parseFloat(a.cells[column].textContent) || 0; // Use parseFloat for numbers, 0 for non-numeric
                const bx = parseFloat(b.cells[column].textContent) || 0;

                return (ax > bx) ? (dir === 'asc' ? 1 : -1) : (ax < bx ? (dir === 'asc' ? -1 : 1) : 0);
            });

            rows.forEach(row => table.appendChild(row));
            this.asc = !this.asc;
        }

        function downloadSemCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";

            const generatedDiv = document.getElementById('generated');
            const tablesAndHeadings = Array.from(generatedDiv.querySelectorAll('h3, table')); // Select both h3 and table

            tablesAndHeadings.forEach((element, index) => {
                if (element.tagName === 'H3') {  // Check if it's a heading
                    const headingText = element.textContent.trim().replace(/_/g, ' ').toUpperCase(); //Add same formatting
                    const nextElement = tablesAndHeadings[index + 1]; // Check if next element exists

                    if (nextElement && nextElement.tagName === 'TABLE') {
                        const rows = Array.from(nextElement.querySelectorAll("tr"));

                        rows.forEach(row => {
                            const cells = Array.from(row.querySelectorAll("th, td"));

                            if (cells.length >= 2) { //Check if remove cell exists
                                cells.splice(1, 1); //Remove remove cell
                            }
                            //Replace 'Value' with headingText
                            if (cells.length > 0 && cells[0].textContent.trim() === 'Value') {
                                cells[0].textContent = headingText;
                            }

                            const rowText = cells.map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`).join(",");
                            csvContent += rowText + "\n";

                        });

                        csvContent += "\n"; // Add an empty row after each table's data
                    }


                }
            });


            // Create a hidden link element and trigger a click to download
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "generated_sem.csv");
            document.body.appendChild(link); // Required for Firefox
            link.click(); // This will download the data file
            document.body.removeChild(link); // Cleanup 
        }

        function downloadKeywordAnalysisTableAsCSV() {
            const table = document.getElementById("keywordAnalysisResults").querySelector('table');
            if (!table) {
                console.error("Table not found!");
                return;
            }

            const rows = Array.from(table.querySelectorAll("tr"));

            // Add UTF-8 BOM (Byte Order Mark) to ensure proper encoding in Excel
            let csvContent = "\uFEFF";  // Unicode BOM
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll("th, td"));
                csvContent += cells.map(cell => {
                    let cellText = cell.textContent.trim();
                    if (!cellText && cell.innerHTML) {
                        cellText = cell.innerHTML.replace(/<[^>]*>/g, "").trim();
                    }

                    // **DEBUGGING:  Inspect the text BEFORE CSV escaping**
                    console.log("Cell text before escaping:", cellText); // Check if Korean is already garbled

                    return `"${cellText.replace(/"/g, '""')}"`;
                }).join(",") + "\n";
            });

            // **DEBUGGING: Inspect the CSV content before creating Blob**
            console.log("CSV Content before Blob:", csvContent);

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { // feature detection
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "keyword_analysis.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);  // Clean up
            } else {
                // IE10+ Fallback - opens the data URI in a new window
                window.open('data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));
            }
        }

        function sortKeywordSuggestions(column) {
            const keywordList = document.getElementById('keywordList');
            const listItems = Array.from(keywordList.children);

            if (column === currentKeywordSortColumn) {
                keywordSortAscending = !keywordSortAscending;
            } else {
                keywordSortAscending = true;
                currentKeywordSortColumn = column;
            }

            listItems.sort((a, b) => {
                const aValue = a.children[column].textContent;
                const bValue = b.children[column].textContent;

                // Convert to number for sorting if possible
                const aNum = parseFloat(aValue.replace(/,/g, ''));
                const bNum = parseFloat(bValue.replace(/,/g, ''));

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return keywordSortAscending ? aNum - bNum : bNum - aNum;
                } else {
                    return keywordSortAscending
                        ? aValue.localeCompare(bValue)
                        : bValue.localeCompare(aValue);
                }
            });

            listItems.forEach(item => keywordList.appendChild(item));
        }

        function sortRankedKeywords(column) {
            const keywordList = document.getElementById('rankedKeywordList');
            const listItems = Array.from(keywordList.children);

            // Toggle sort direction if same column is clicked
            if (column === currentRankedKeywordSortColumn) {
                rankedKeywordSortAscending = !rankedKeywordSortAscending;
            } else {
                rankedKeywordSortAscending = true;
                currentRankedKeywordSortColumn = column;
            }

            listItems.sort((a, b) => {
                try {
                    const aValue = a.children[column].textContent.trim();
                    const bValue = b.children[column].textContent.trim();

                    const aNum = parseFloat(aValue.replace(/,/g, ''));
                    const bNum = parseFloat(bValue.replace(/,/g, ''));

                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return rankedKeywordSortAscending ? aNum - bNum : bNum - aNum;
                    } else {
                        return rankedKeywordSortAscending
                            ? aValue.localeCompare(bValue)
                            : bValue.localeCompare(aValue);
                    }
                } catch (error) {
                }
            });

            listItems.forEach(item => keywordList.appendChild(item));
        }

        selectedItems = {};
        generatedData = {};

        async function semWebpageProducts() {
            const getProducts = document.getElementById("getProducts");
            if (!document.getElementById('sem_webpages').value && !document.getElementById('sem_additional').value) {
                alert("Please enter webpage URLs or additional information.");
                return;
            } else {
                getProducts.innerText = "Analysing...";
                if (document.getElementById("semProductFocus").checked) {
                    productFocus = true;
                } else {
                    productFocus = false;
                }
                if (document.getElementById("semBrandFocus").checked) {
                    brandFocus = true;
                } else {
                    brandFocus = false;
                }

                urls = document.getElementById("sem_webpages").value.split(/[\s,]+/).filter(url => url.trim() !== "");

                try {
                    const response = await fetch("https://13kntbziug.execute-api.ap-southeast-1.amazonaws.com/webpageProducts", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            pages: urls,
                            brand: brandFocus,
                            product: productFocus,
                            language: document.getElementById("sem_language").value,
                            additional: document.getElementById("sem_additional").value,
                        })
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const responseData = await response.json();
                    const body = JSON.parse(responseData.body);

                    formattedString = "";

                    if (body['product/service'].length > 0) {
                        formattedString += "Product/Service: ";
                        if (Object.prototype.toString.call(body['product/service']) === '[object Array]') {
                            for (value in body['product/service']) {
                                formattedString += body['product/service'][value] + ", ";
                            }
                            formattedString = formattedString.slice(0, -2)
                        } else {
                            formattedString += body['product/service']
                        }
                    }

                    if (formattedString != "") {
                        formattedString += "\n\n";
                    }

                    if (body['brand/company'].length > 0) {
                        formattedString += "Brand/Company: ";
                        if (Object.prototype.toString.call(body['brand/company']) === '[object Array]') {
                            for (value in body['brand/company']) {
                                formattedString += body['brand/company'][value] + ", ";
                            }
                            formattedString = formattedString.slice(0, -2)
                        } else {
                            formattedString += body['brand/company']
                        }
                    }

                    document.getElementById("products").innerHTML = '<label for="identifiedProducts">Identfied Products/Services/Brand/Company:</label><br><textarea rows="6" id="identifiedProducts">' + formattedString + '</textarea>';
                    getProducts.innerText = "Step 1: Identify products/services/brand/company";
                } catch (error) {
                    console.error("Error:", error);
                    document.getElementById("output").innerText = "An error occurred with semWebpageProducts. Please check the console for details.";
                    getProducts.innerText = "Step 1: Identify products/services/brand/company";
                }
            }
        }

        async function semAnalyseWebsite() {
            const semButton = document.getElementById("semAnalyse");
            semButton.innerText = "Analysing...";
            try {
                const response = await fetch("https://sk7akfiy89.execute-api.ap-southeast-1.amazonaws.com/semWebsiteAnalyser", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        country: document.getElementById("sem_country").value,
                        additional: document.getElementById("sem_additional").value,
                        products: document.getElementById("identifiedProducts").value,
                        language: document.getElementById("sem_language").value,
                    })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const responseData = await response.json();
                const body = responseData.body;
                selectedItems = {}; // Clear selections
                document.getElementById('selected').style.display = 'block';
                //document.getElementById("selectedText").value = ""; // Clear textarea
                document.getElementById("output").innerHTML = await createSemTables(body);

                semButton.innerText = "Step 2: Generate KWs, USPs & Audience";
            } catch (error) {
                console.error("Error:", error);
                document.getElementById("output").innerText = "An error occurred with semWebsiteAnalyser. Please check the console for details.";
                semButton.innerText = "Step 2: Generate KWs, USPs & Audience";
            }
        }

        async function createSemTables(data) {
            let tablesHTML = "";
            const categories = ["short_keywords", "long_keywords", "usp", "target_audience_name"];
            const titles = ["Short-tail Keywords", "Long-tail Keywords", "USPs", "Target Audience"];

            for (let i = 0; i < categories.length; i++) {
                const category = categories[i];
                const title = titles[i];
                const items = data[category];


                // Fetch keyword metrics for short and long tail keywords
                let keywordMetrics = {};
                if (category === "short_keywords" || category === "long_keywords") {
                    const keywords = items.map(item => typeof item === 'object' ? Object.values(item)[0] : item);
                    keywordMetrics = await fetchKeywordMetricsSem(keywords);
                }

                let tableHTML = `<h2>${title}</h2><table><tr><th>Select</th><th>Value</th>`;
                if (category === "short_keywords" || category === "long_keywords") {
                    tableHTML += `<th>CPC</th><th>Search Volume</th>`; // Add CPC and Search Volume headers
                }
                tableHTML += `</tr>`;

                for (const item of items) {
                    const value = typeof item === 'object' ? Object.values(item)[0] : item;
                    tableHTML += `<tr><td><input type="checkbox" onchange="updateSemSelected('${value}', '${title}')"></td><td>${value}</td>`;

                    if (category === "short_keywords" || category === "long_keywords") {
                        const metrics = keywordMetrics[value] || { cpc: 'N/A', search_volume: 'N/A' };
                        tableHTML += `<td>${metrics.cpc}</td><td>${metrics.search_volume}</td>`; // Add CPC and Search Volume data
                    }

                    tableHTML += `</tr>`;
                }
                tableHTML += '</table>';
                tablesHTML += tableHTML;
            }
            return tablesHTML;
        }

        async function fetchKeywordMetrics(keywords, location, language) {
            const keywordMetricsEndpoint = 'https://eo2ckwvxmf.execute-api.ap-southeast-1.amazonaws.com/keywordMetrics';

            try {
                const response = await fetch(keywordMetricsEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keywords: keywords,
                        location: location,
                        language: language
                    })
                });

                if (!response.ok) {
                    throw new Error(`Keyword Metrics API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                keywordMetrics = data.body;
                console.log("Keyword Metrics:", keywordMetrics);

            } catch (error) {
                console.error("Error fetching keyword metrics:", error);
            }
        }

        async function fetchKeywordMetricsSem(keywords) {
            console.log(keywords);
            const location = document.getElementById("sem_country").value;
            const language = document.getElementById("sem_language").value;

            try {
                const response = await fetch("https://eo2ckwvxmf.execute-api.ap-southeast-1.amazonaws.com/keywordMetrics", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ keywords: keywords, location: location, language: language })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const metrics = data.body;

                console.log(data);

                // Convert the returned keyword metrics to a format that is easily accessible when populating the table
                const formattedMetrics = {};
                for (const keyword in metrics) {
                    formattedMetrics[keyword] = {
                        cpc: metrics[keyword].cpc,
                        search_volume: metrics[keyword].search_volume
                    };
                }
                return formattedMetrics;

            } catch (error) {
                console.error("Error fetching keyword metrics:", error);
                return {}; // Return an empty object in case of an error
            }
        }
        function updateSemSelected(value, category) {
            if (!selectedItems[category]) {
                selectedItems[category] = [];
            }
            const index = selectedItems[category].indexOf(value);
            if (index > -1) {
                selectedItems[category].splice(index, 1);
            } else {
                selectedItems[category].push(value);
            }
            displaySemSelectedItems();
        }
        function displaySemSelectedItems() {
            let selectedText = "";
            for (const category in selectedItems) {
                if (selectedItems[category].length > 0) {
                    selectedText += `${category}\n`;
                    selectedItems[category].forEach(item => {
                        selectedText += `${item}\n`;
                    });
                    selectedText += "\n"; // Add extra newline between categories
                }
            }
            document.getElementById("selectedText").value = selectedText;  // Update textarea value
        }

        function getCompetitors() {
            document.getElementById("getCompetitorsBtn").innerText = "Getting Competitors...";
            document.getElementById("competitionBtn").style.backgroundColor = "#004c9d";
            const keywords = document.getElementById('competitor_keywords').value.split(/[\n,]+/).map(k => k.trim());
            console.log(keywords);
            const competitorsLanguage = document.getElementById("competitors-language").value;
            const competitorsLocation = document.getElementById("competitors-location").value;

            fetch("https://itzj193chl.execute-api.ap-southeast-1.amazonaws.com/serpCompetitors", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    keywords: keywords,
                    location: competitorsLocation,
                    language: competitorsLanguage
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayCompetitorResults(data.body);
                    document.getElementById("competitorsOutput").style.display = "block";
                    document.getElementById("competitionBtn").style.backgroundColor = "green";
                })
                .catch(error => {
                    console.error("Error fetching competitors:", error);
                    document.getElementById("competitorsOutput").innerHTML = "Error fetching competitors.  See console for details.";
                    document.getElementById("competitionBtn").style.backgroundColor = "#004c9d";
                })
                .finally(() => {
                    document.getElementById("getCompetitorsBtn").innerText = "Step 1: Get Competitors";
                });
        }

        function displayCompetitorResults(results) {
            const outputDiv = document.getElementById("competitorsOutput");
            if (results === undefined) {
                alert("There are no results found for the keyword(s). Please try other keyword(s).")
            }
            if (!outputDiv) {
                console.error("Competitors output div not found!");
                return;
            }

            let tableHTML = `
        <table>
            <thead>
                <tr>
                    <th>Domain</th>
                    <th>Keyword and Rank</th>
                    <th>Select</th>
                </tr>
            </thead>
            <tbody>
    `;

            for (const domain in results) {
                if (results.hasOwnProperty(domain)) {
                    const keywordRanks = results[domain];
                    let keywordRankText = "";
                    for (const keyword in keywordRanks) {
                        if (keywordRanks.hasOwnProperty(keyword)) {
                            keywordRankText += `${keyword}: ${keywordRanks[keyword]}<br>`;
                        }
                    }

                    // Make the domain a hyperlink
                    const linkedDomain = `<a href="http://${domain}" target="_blank" rel="noopener noreferrer">${domain}</a>`;  //IMPORTANT:  Added http:// to the domain so if a naked domain is returned it will open.  Also add noreferrer to protect user privacy

                    tableHTML += `
                <tr>
                    <td>${linkedDomain}</td>
                    <td>${keywordRankText}</td>
                    <td><input type="checkbox" class="domain-checkbox" value="${domain}"></td>
                </tr>
            `;
                }
            }

            tableHTML += `
            </tbody>
        </table>
    `;

            outputDiv.innerHTML = tableHTML;
            // Show the button
            document.getElementById('getIntersectionResults').style.display = 'block';
        }

        async function getIntersectionResults() {
            document.getElementById('competitorsRanking').style.display = 'none';
            document.getElementById('getIntersectionResults').innerText = 'Getting Results...';
            const checkedDomains = Array.from(document.querySelectorAll('.domain-checkbox:checked'))
                .map(checkbox => checkbox.value);

            if (checkedDomains.length === 0) {
                alert('Please select at least one domain.');
                return;
            }

            const target1Value = document.getElementById('competitors-target1').value;

            const apiCalls = checkedDomains.map(domain => {
                const requestBody = {
                    "language": "English",
                    "location": "Singapore",
                    "target1": target1Value,
                    "target2": domain
                };

                return fetch('https://8llvcx7m6e.execute-api.ap-southeast-1.amazonaws.com/domainIntersection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        return { domain: domain, data: data }; // Return domain along with the data
                    })
                    .catch(error => {
                        console.error(`Error fetching intersection results for ${domain}:`, error);
                        return { domain: domain, error: error }; // Return domain and the error
                    });
            });

            // Execute all API calls in parallel
            const results = await Promise.all(apiCalls);
            displayIntersectionResults(results);

        }

        function displayIntersectionResults(results) {
            const outputDiv = document.getElementById("competitorsRanking");
            if (!outputDiv) {
                console.error("Competitors output div not found!");
                return;
            }

            let tableHTML = `
    <table id="intersectionResultsTable">
      <thead>
        <tr>
          <th onclick="sortIntersectionTable('keyword')">Keyword</th>
          <th onclick="sortIntersectionTable('${document.getElementById("competitors-target1").value}')">${document.getElementById("competitors-target1").value}</th>
          ${results.map(result => `<th onclick="sortIntersectionTable('${result.domain}')">${result.domain}</th>`).join('')}
        </tr>
      </thead>
      <tbody>
  `;

            // Collect all unique keywords from the results
            const allKeywords = new Set();
            results.forEach(result => {
                if (result.data) {
                    Object.keys(result.data).forEach(keyword => allKeywords.add(keyword));
                }
            });

            // Iterate over each unique keyword and create a row
            allKeywords.forEach(keyword => {
                tableHTML += `
      <tr>
        <td>${keyword}</td>
    `;

                // Get target1 data
                tableHTML += `
      <td>${(results[0].data && results[0].data[keyword]) ? `<a href="${results[0].data[keyword][Object.keys(results[0].data[keyword])[3]][1]}">${results[0].data[keyword][Object.keys(results[0].data[keyword])[3]][0]}</a>` : '999'}</td>
    `;

                //Add rankings for the rest of the selected domains
                results.forEach(result => {
                    if (result.data && result.data[keyword]) {

                        // Find first domain and retrieve rankings and URLs
                        const firstDomain = Object.keys(result.data[keyword])[4]
                        const domainData = result.data[keyword][firstDomain]

                        //Set ranks and URLs into the rows
                        tableHTML += `<td><a href="${domainData[1]}">${domainData[0]}</a></td>`;

                    } else if (result.error) {
                        tableHTML += `<td>Error</td>`;
                    } else {
                        tableHTML += `<td>999</td>`;
                    }
                });

                tableHTML += `</tr>`;
            });

            tableHTML += `
      </tbody>
    </table>
  `;

            outputDiv.innerHTML = tableHTML;
            outputDiv.innerHTML += '<br><button type="button" onclick="copyInteractionResultsTable()"><i class="fa fa-copy"></i></button>';
            outputDiv.innerHTML += '<button type="button" onclick="exportInteractionResultsTableToCSV()">Export as .csv</button>';
            document.getElementById('getIntersectionResults').innerText = 'Step 2: Choose Competiors & Get Intersection Results';
            document.getElementById('competitorsRanking').style.display = 'block';
        }

        async function generatePersona() {
            document.getElementById("generatePersonaBtn").innerText = "Generating...";
            document.getElementById("persona").style.backgroundColor = "#004c9d";
            const webpagesInput = document.getElementById("persona_webpages").value;
            const manualInput = document.getElementById("persona_manual").value;
            const webpages = webpagesInput.split(/[\s,]+/).filter(url => url.trim() !== "");
            const personaContentDiv = document.getElementById("persona-results");
            let combinedResponses = "";

            try {
                // Fetch data from all URLs concurrently using Promise.all
                const responses = await Promise.all(
                    webpages.map(async url => {
                        try {
                            const response = await fetch("https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({ url: url })
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status} for URL: ${url}`);
                            }

                            return await response.json(); // Return the parsed JSON data
                        } catch (error) {
                            console.error(`Error fetching data from ${url}:`, error);
                            return null; // Return null in case of an error
                        }
                    })
                );

                // Combine the responses
                combinedResponses = responses.filter(response => response !== null).map(response => JSON.stringify(response)).join("\n");

                console.log(combinedResponses);

                // Send combined responses to the second API
                try {
                    const personaResponse = await fetch("https://tyqj3fni7h.execute-api.ap-southeast-1.amazonaws.com/personaGenerator", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ data: combinedResponses, manual: manualInput })
                    });

                    if (!personaResponse.ok) {
                        throw new Error(`HTTP error! status: ${personaResponse.status} for persona API`);
                    }

                    const personaData = await personaResponse.json();
                    personaContentDiv.innerHTML += personaData.body;

                } catch (error) {
                    personaContentDiv.innerHTML = `<p style="color: red;">Error sending data to persona API: ${error.message}</p>`;
                    console.error("Error sending data to persona API:", error);
                }

            } catch (error) {
                personaContentDiv.innerHTML = `<p style="color: red;">An error occurred: ${error.message}</p>`;
                console.error("An error occurred:", error);
            } finally {
                document.getElementById("generatePersonaBtn").innerText = "Generate Personas";
                document.getElementById("persona").style.backgroundColor = "green";
                document.getElementById("copy-persona-results-button").style.display = "block";
            }
        }

        async function generateMediaPlan() {
            document.getElementById("generateMediaPlanBtn").innerText = "Generating...";
            document.getElementById("mediaPlanBtn").style.backgroundColor = "#004c9d";
            const mediaplanContentDiv = document.getElementById("mediaPlanResults");
            const webpages = document.getElementById("MediaPlanWebpages").value.split(/[\s,]+/).filter(url => url.trim() !== "");

            const responses = await Promise.all(
                webpages.map(async url => {
                    try {
                        const response = await fetch("https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({ url: url })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} for URL: ${url}`);
                        }

                        return await response.json(); // Return the parsed JSON data
                    } catch (error) {
                        console.error(`Error fetching data from ${url}:`, error);
                        return null; // Return null in case of an error
                    }
                })
            );

            word_count = 0;
            responses.forEach((page) => {
                word_count += (page.body.other_text.split(" ")).length;
            });

            if (word_count < 500) {
                alert("Please consider adding more webpage URLs for the tool to generate better results. The tool will continue generating the media plan.");
            }


            personaData = document.getElementById("MediaPlanCustomerPersonas").value;
            manualInput = document.getElementById("persona_manual").value;

            if (personaData == "") {
                try {
                    const personaResponse = await fetch("https://tyqj3fni7h.execute-api.ap-southeast-1.amazonaws.com/personaGenerator", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ data: responses, manual: manualInput })
                    });

                    if (!personaResponse.ok) {
                        throw new Error(`HTTP error! status: ${personaResponse.status} for persona API`);
                    }

                    personaData = await personaResponse.json();
                    document.getElementById("mediaPlanPersonaResults").innerHTML = "<h2>Generated Personas</h2>" + personaData.body;
                    document.getElementById("mediaPlanPersonaResults").style.display = "block"

                } catch (error) {
                    alert(`Error sending data to persona API: ${error.message}`);
                    console.error("Error sending data to persona API:", error);
                }
            }

            // Gather all the data from the form fields
            const data = {
                webpagesInput: responses,
                budget: document.getElementById("MediaPlanBudget").value,
                manualInput: document.getElementById("MediaPlanManual").value,
                organisationalObjectives: document.getElementById("MediaPlanOrganisationalObjectives").value,
                mediaPlanLocation: document.getElementById("MediaPlanLocation").value,
                mediaPlanTargetAudience: document.getElementById("MediaPlanTargetAudience").value,
                mediaPlanCustomerPersonas: personaData,
                mediaPlanTouchpoints: document.getElementById("MediaPlanTouchpoints").value,
                mediaPlanContentStrategy: document.getElementById("MediaPlanContentStrategy").value,
                mediaPlanLandingPages: document.getElementById("MediaPlanLandingPages").value,
                mediaPlanCta: document.getElementById("MediaPlanCta").value,
                mediaPlanProductService: document.getElementById("MediaPlanProductService").value,
                mediaPlanKpis: document.getElementById("MediaPlanKpis").value,
                mediaPlanCompetitiveAnalysis: document.getElementById("MediaPlanCompetitiveAnalysis").value,
                mediaPlanCompliance: document.getElementById("MediaPlanCompliance").value,
                mediaPlanTechnologyPlan: document.getElementById("MediaPlanTechnologyPlan").value,
                mediaPlanAnalyticsReporting: document.getElementById("MediaPlanAnalyticsReporting").value,

                adFormats: {
                    googleDisplay: document.getElementById("MediaPlanAdFormatsGoogleDisplay").checked,
                    googleSearch: document.getElementById("MediaPlanAdFormatsGoogleSearch").checked,
                    fbIg: document.getElementById("MediaPlanAdFormatsFBIG").checked,
                    linkedIn: document.getElementById("MediaPlanAdFormatsLinkedIn").checked,
                    tikTok: document.getElementById("MediaPlanAdFormatsTikTok").checked
                }
            };

            try {
                // Combine the responses - the original implementation was parsing webpage
                // content, but now we skip that step and pass the data directly

                // Send the combined data to the media plan API
                const mediaPlanResponse = await fetch("https://h8ih2vc2xi.execute-api.ap-southeast-1.amazonaws.com/mediaPlanGenerator", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data) // Send all the data gathered from the form
                });

                if (!mediaPlanResponse.ok) {
                    throw new Error(`HTTP error! status: ${mediaPlanResponse.status} for media plan API`);
                }

                const mediaPlanData = await mediaPlanResponse.json();
                mediaplanContentDiv.innerHTML += "<br>" + mediaPlanData.body;

                // Funnel
                funnelResponse = await fetch("https://dpjtg2sr30.execute-api.ap-southeast-1.amazonaws.com/generateFunnel", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(Object.assign({}, personaData, mediaPlanData)) // Send all the data gathered from the form
                });

                if (!funnelResponse.ok) {
                    throw new Error(`HTTP error! status: ${funnelResponse.status} for media plan API`);
                }
                funnelData = await funnelResponse.json();

                funnelData = JSON.parse(funnelData.body);

                try {
                    document.getElementById("awareness-details").innerHTML = funnelData.Awareness.join('\n');
                } catch (error) {
                    document.getElementById("awareness-details").innerHTML = "N.A.";
                }
                try {
                    document.getElementById("discovery-details").innerHTML = funnelData.Discovery.join('\n');
                } catch (error) {
                    document.getElementById("discovery-details").innerHTML = "N.A.";
                }
                try {
                    document.getElementById("consideration-details").innerHTML = funnelData.Consideration.join('\n');
                } catch (error) {
                    document.getElementById("consideration-details").innerHTML = "N.A.";
                }
                try {
                    document.getElementById("conversion-details").innerHTML = funnelData.Conversion.join('\n');
                } catch (error) {
                    document.getElementById("conversion-details").innerHTML = "N.A.";
                }
                try {
                    document.getElementById("retention-details").innerHTML = funnelData.Retention.join('\n');
                } catch (error) {
                    document.getElementById("retention-details").innerHTML = "N.A.";
                }

                document.getElementById("funnel-container").style.display = "flex";
                document.getElementById("mediaPlanBtn").style.backgroundColor = "green";

            } catch (error) {
                mediaplanContentDiv.innerHTML = `<p style="color: red;">Error sending data to media plan API: ${error.message}</p>`;
                console.error("Error sending data to media plan API:", error);
            } finally {
                document.getElementById("generateMediaPlanBtn").innerText = "Generate Media Plan";
            }
        }

        async function auditLandingPageDirectWeb() {
            document.getElementById("gauge").style.display = "none";
            document.getElementById("auditLandingPageBtn").innerText = "Evaluating landing page...";
            document.getElementById("landingPageAuditBtn").style.backgroundColor = "#004c9d";
            landingPageAuditResultDiv = document.getElementById("landingPageAuditResults");

            const urlInput = document.getElementById("landingPageUrl").value;
            const auditKeyword = document.getElementById("landingPageAuditKeyword")?.value || null;

            // Check if the URL input is empty
            if (!urlInput || urlInput.trim() === "") {
                alert("Please enter a landing page URL.");
                document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
                return;
            }
            const finalAuditResponse = await fetch("https://7eehmzk9e0.execute-api.ap-southeast-1.amazonaws.com/auditLandingPageDirectWeb", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    keyword: auditKeyword, // Pass the keyword for main audit
                    url: urlInput
                })
            });

            const finalAuditData = await finalAuditResponse.json();

            // Display the results
            document.getElementById("landingPageAuditResults").innerHTML = finalAuditData.body;
            const gaugeElement = document.querySelector(".gauge");
            quality_score = finalAuditData.quality_score;
            setGaugeValue(gaugeElement, quality_score / 10);
            document.getElementById("gauge").style.display = "block";

            document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
        }

        async function auditLandingPage2() {
            document.getElementById("gauge").style.display = "none";
            document.getElementById("auditLandingPageBtn").innerText = "Getting page content...";
            document.getElementById("landingPageAuditBtn").style.backgroundColor = "#004c9d";
            landingPageAuditResultDiv = document.getElementById("landingPageAuditResults");

            const urlInput = document.getElementById("landingPageUrl").value;
            const auditKeyword = document.getElementById("landingPageAuditKeyword")?.value || null;

            // Check if the URL input is empty
            if (!urlInput || urlInput.trim() === "") {
                alert("Please enter a landing page URL.");
                document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
                return;
            }

            try {
                const landingPageAuditResponse = await fetch("https://ocgawi1990.execute-api.ap-southeast-1.amazonaws.com/auditLandingPageDataPull", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        url: urlInput
                    })
                });

                if (!landingPageAuditResponse.ok) {
                    const errorText = await landingPageAuditResponse.text();
                    throw new Error(`HTTP error! status: ${landingPageAuditResponse.status} - ${errorText}`);
                }

                const landingPageAuditData = await landingPageAuditResponse.json();

                // Split the HTML content into snippets of up to 100,000 characters
                const html = landingPageAuditData.html;
                const snippetSize = 100000;
                const snippets = [];
                for (let i = 0; i < html.length; i += snippetSize) {
                    snippets.push(html.substring(i, i + snippetSize));
                }

                console.log(landingPageAuditData.html.length);
                console.log(snippets.length);

                document.getElementById("auditLandingPageBtn").innerText = "Evaluating page elements...";

                // Send each snippet to the excerpt API concurrently
                const excerptPromises = snippets.map(snippet =>
                    fetch("https://vvoc1htseh.execute-api.ap-southeast-1.amazonaws.com/auditLandingPageExcerpt", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            html: snippet,
                            keyword: auditKeyword
                        })
                    }).then(response => {
                        if (!response.ok) {
                            return response.json().then(err => {
                                throw new Error(`Excerpt API error! status: ${response.status} - ${err.message || 'Unknown error'}`);
                            });
                        }
                        return response.json();
                    })
                );

                // Wait for all excerpt API calls to complete
                const excerptResponses = await Promise.all(excerptPromises);

                // Combine the responses from the excerpt API calls
                let combinedExcerptResponse = {
                    results: []
                };

                excerptResponses.forEach(response => {
                    if (response && response.results) {
                        combinedExcerptResponse.results = combinedExcerptResponse.results.concat(response.results);
                    }
                });

                document.getElementById("auditLandingPageBtn").innerText = "Auditing overall page...";

                // Send the combined response to the main audit API
                const finalAuditResponse = await fetch("https://llufeecqoe.execute-api.ap-southeast-1.amazonaws.com/auditLandingPage", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        excerpt_results: combinedExcerptResponse.results, // Pass the combined excerpt results
                        keyword: auditKeyword, // Pass the keyword for main audit
                        url: urlInput,
                        speed: landingPageAuditData.speed
                    })
                });

                if (!finalAuditResponse.ok) {
                    const errorText = await finalAuditResponse.text();
                    throw new Error(`Final Audit API error! status: ${finalAuditResponse.status} - ${errorText}`);
                }

                const finalAuditData = await finalAuditResponse.json();

                console.log(finalAuditData);

                // Display the results
                document.getElementById("landingPageAuditResults").innerHTML = `${JSON.stringify(finalAuditData['body'], null, 2)}`.replaceAll('"', '');
                const gaugeElement = document.querySelector(".gauge");
                quality_score = finalAuditData.quality_score;
                setGaugeValue(gaugeElement, quality_score / 10);
                document.getElementById("gauge").style.display = "block";

            } catch (error) {
                console.error("Error during audit:", error);
                alert(`Audit failed: ${error.message}`);
                document.getElementById("landingPageAuditResults").innerText = `Error: ${error.message}`;
            } finally {
                document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
                document.getElementById("landingPageAuditBtn").style.backgroundColor = "green"; // Revert to original style
            }
        }

        async function auditLandingPage() {
            document.getElementById("gauge").style.display = "none";
            document.getElementById("auditLandingPageBtn").innerText = "Auditing...";
            document.getElementById("landingPageAuditBtn").style.backgroundColor = "#004c9d";
            landingPageAuditResultDiv = document.getElementById("landingPageAuditResults");

            const urlInput = document.getElementById("landingPageUrl").value;
            const auditKeyword = document.getElementById("landingPageAuditKeyword")?.value || null;

            // Check if the URL input is empty
            if (!urlInput || urlInput.trim() === "") {
                alert("Please enter a landing page URL.");
                document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
                return;
            }

            // Send combined responses to the second API
            try {
                const landingPageAuditResponse = await fetch("https://llufeecqoe.execute-api.ap-southeast-1.amazonaws.com/auditLandingPage", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        url: urlInput,
                        keyword: auditKeyword
                    })
                });

                if (!landingPageAuditResponse.ok) {
                    const errorText = await landingPageAuditResponse.text();
                    throw new Error(`HTTP error! status: ${landingPageAuditResponse.status} - ${errorText}`);
                }

                const landingPageAuditData = await landingPageAuditResponse.json();

                if (landingPageAuditData && landingPageAuditData.body) {
                    landingPageAuditResultDiv.innerHTML = landingPageAuditData.body; // Removed +=
                    const gaugeElement = document.querySelector(".gauge");
                    quality_score = landingPageAuditData.quality_score;
                    setGaugeValue(gaugeElement, quality_score / 10);
                    document.getElementById("gauge").style.display = "block";
                } else {
                    landingPageAuditResultDiv.innerHTML = "<p>No results found.</p>";
                }

            } catch (error) {
                landingPageAuditResultDiv.innerHTML = `<p style="color: red;">Error landing page audit API: ${error.message}</p>`;
                console.error("Error sending data to landing page audit API:", error);
            } finally {

                document.getElementById("auditLandingPageBtn").innerText = "Audit Landing Page";
                document.getElementById("landingPageAuditBtn").style.backgroundColor = "green";
            }
        }

        function setGaugeValue(gauge, value) {
            if (value < 0 || value > 1) {
                return;
            }

            const fillElement = gauge.querySelector(".gauge__fill");
            fillElement.style.transform = `rotate(${value / 2}turn)`;
            gauge.querySelector(".gauge__cover").innerHTML = `Quality Score<br>${Math.round(value * 10)}/10`;
        }

        async function generateGoogle() {
            document.getElementById("generateSem").innerText = "Generating...";
            document.getElementById("semButton").style.backgroundColor = "#004c9d";
            try {
                const response = await fetch("https://bztsly2z89.execute-api.ap-southeast-1.amazonaws.com/generateSemGoogle", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        country: document.getElementById("sem_country").value,
                        input: document.getElementById("selectedText").value,
                        tone: document.getElementById("sem_tone").value,
                        language: document.getElementById("sem_language").value,
                        type: document.getElementById("ad_format").value
                    })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const responseData = await response.json();
                const body = responseData.body;
                for (const key in body) {
                    if (!generatedData[key]) {
                        generatedData[key] = [];
                    }
                    generatedData[key] = generatedData[key].concat(body[key]); // Concatenate new data
                }
                displaySemGeneratedData(); // Call function to update HTML
                document.getElementById("generateSem").innerText = "Step 3: Select checkboxes then click here";
            } catch (error) {
                console.error("Error:", error);
                document.getElementById("generated").innerText = "An error occurred. Please check the console for details.";
                document.getElementById("generateSem").innerText = "Step 3: Select checkboxes then click here";
            }
        }
        function displaySemGeneratedData() {
            let generatedHTML = "";
            for (const category in generatedData) {
                if (generatedData[category].length > 0) {
                    if (category == "sitelinks") {
                        generatedHTML += `<h3>${category.replace(/_/g, ' ').toUpperCase()}</h3>`; // Nicer titles
                        generatedHTML += `<table>`;
                        generatedHTML += `<tr><th>Value</th><th>Remove</th></tr>`; // Add remove column header
                        generatedData[category].forEach((item, index) => { // Add index for row removal
                            sitelink = "";
                            for ([key, value] of Object.entries(item)) {
                                sitelink += `${value}<br>`;
                            }
                            generatedHTML += `<tr>
                            <td>${sitelink}</td>
                            <td><span class="remove-row" onclick="removeSemGeneratedRow('${category}', ${index})" onmouseover="" style="cursor: pointer;">X</span></td>
                         </tr>`;
                        });
                    } else {
                        generatedHTML += `<h3>${category.replace(/_/g, ' ').toUpperCase()}</h3>`; // Nicer titles
                        generatedHTML += `<table>`;
                        generatedHTML += `<tr><th>Value</th><th>Remove</th></tr>`; // Add remove column header
                        generatedData[category].forEach((item, index) => { // Add index for row removal
                            generatedHTML += `<tr>
                            <td>${item}</td>
                            <td><span class="remove-row" onclick="removeSemGeneratedRow('${category}', ${index})" onmouseover="" style="cursor: pointer;">X</span></td>
                         </tr>`;
                        });
                    }
                    generatedHTML += `</table>`;
                }
            }
            document.getElementById("generated").innerHTML = generatedHTML;
            document.getElementById("generated").innerHTML = document.getElementById("generated").innerHTML + '<br><button id="downloadSem" onclick="downloadSemCSV()">Download .csv</button>'
            document.getElementById("downloadSem").addEventListener("click", downloadSemCSV);
            document.getElementById("semButton").style.backgroundColor = "green";
        }
        function removeSemGeneratedRow(category, index) {
            generatedData[category].splice(index, 1);
            displaySemGeneratedData(); // Redraw the table
        }

        function downloadResultsAsXlsx() {
            const wb = XLSX.utils.book_new();

            // Add auditSummary tab
            const auditSummaryTables = document.getElementById('auditSummary').querySelectorAll('table');
            let auditSummaryData = [];

            auditSummaryTables.forEach((table, tableIndex) => {
                const tableData = extractTableData(table);

                // Add a blank row between tables (if it's not the first table)
                if (tableIndex > 0) {
                    auditSummaryData.push([]);
                }
                auditSummaryData = auditSummaryData.concat(tableData);
            });

            const auditSummaryWS = XLSX.utils.aoa_to_sheet(auditSummaryData);
            XLSX.utils.book_append_sheet(wb, auditSummaryWS, 'auditSummary');

            // Add gtMetrix tab
            const gtMetrixData = extractTableData(document.getElementById('gtmetrixReport').querySelector('table'));
            const gtMetrixWS = XLSX.utils.aoa_to_sheet(gtMetrixData);
            XLSX.utils.book_append_sheet(wb, gtMetrixWS, 'gtMetrix');

            // Add pageAnalysis tab
            const pageAnalysisData = extractTableData(document.getElementById('pageAuditReport').querySelector('table'));
            const pageAnalysisWS = XLSX.utils.aoa_to_sheet(pageAnalysisData);
            XLSX.utils.book_append_sheet(wb, pageAnalysisWS, 'pageAnalysis');


            // Add crawlerSection tab
            const crawlerData = extractTableData(document.getElementById('crawlerReport').querySelector('table'));
            const crawlerWS = XLSX.utils.aoa_to_sheet(crawlerData);
            XLSX.utils.book_append_sheet(wb, crawlerWS, 'crawlerSection');

            XLSX.writeFile(wb, 'technical_seo_results.xlsx');
        }

        function extractTableData(table) {
            const data = [];
            const rows = table.querySelectorAll('tr');

            rows.forEach(row => {
                const rowData = [];
                const cells = row.querySelectorAll('th, td');
                cells.forEach(cell => {
                    // Get text content, handling potential HTML inside cells
                    let cellText = cell.textContent.trim();
                    if (!cellText && cell.innerHTML) {
                        cellText = cell.innerHTML.replace(/<[^>]*>/g, "").trim();
                    }

                    rowData.push(cellText);
                });
                data.push(rowData);
            });
            return data;
        }

        function updateUI(isLoggedIn) {
            document.getElementById('loginForm').style.display = isLoggedIn ? 'none' : 'flex';
            document.getElementById('main-content').style.display = isLoggedIn ? 'block' : 'none';
            //document.getElementById('navbar').style.display = isLoggedIn ? 'block' : 'none';
        }


        function openSeo(event) {
            event.preventDefault();
            deactivateAllButtons();
            const seoButton = document.querySelector('button#seo');
            if (seoButton) {
                seoButton.classList.toggle('active');
                const content = seoButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const keywordAnalysisLink = event.currentTarget;
                keywordAnalysisLink.classList.toggle('active-menu');

            };
        }

        function openKeywordAnalysis(event) {
            event.preventDefault();
            deactivateAllButtons();
            const seoButton = document.querySelector('button#seo');
            if (seoButton) {
                seoButton.classList.toggle('active');
                const content = seoButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const keywordAnalysisLink = event.currentTarget;
                keywordAnalysisLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const keywordAnalysisSection = document.getElementById('seo');
                    if (keywordAnalysisSection) {
                        keywordAnalysisSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }

        function openTechnicalSeo(event) {
            event.preventDefault();
            deactivateAllButtons();
            openSeo(event);
            Button = document.querySelector('button#technicalButton');
            if (Button) {
                Button.classList.toggle('active');
                const content = Button.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const technicalSeoLink = event.currentTarget;
                technicalSeoLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const technicalSeoSection = document.getElementById('technicalButton');
                    if (technicalSeoSection) {
                        technicalSeoSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }

        function openContentComparison(event) {
            event.preventDefault();
            deactivateAllButtons();
            openSeo(event);
            Button = document.querySelector('button#contentComparisonButton');
            if (Button) {
                Button.classList.toggle('active');
                const content = Button.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const contentComparisonLink = event.currentTarget;
                contentComparisonLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const contentComparisonSection = document.getElementById('contentComparisonButton');
                    if (contentComparisonSection) {
                        contentComparisonSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }

        function openSchemaGenerator(event) {
            event.preventDefault();
            deactivateAllButtons();
            openSeo(event);
            Button = document.querySelector('button#schemaGeneratorButton');
            if (Button) {
                Button.classList.toggle('active');
                const content = Button.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const schemaGeneratorLink = event.currentTarget;
                schemaGeneratorLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const schemaGeneratorSection = document.getElementById('schemaGeneratorButton');
                    if (schemaGeneratorSection) {
                        schemaGeneratorSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }


        function openOnPage(event) {
            event.preventDefault();
            deactivateAllButtons();
            openSeo(event);
            Button = document.querySelector('button#onPageButton');
            if (Button) {
                Button.classList.toggle('active');
                const content = Button.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const schemaGeneratorLink = event.currentTarget;
                schemaGeneratorLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const schemaGeneratorSection = document.getElementById('onPageButton');
                    if (schemaGeneratorSection) {
                        schemaGeneratorSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }

        function openRankChecker(event) {
            event.preventDefault();
            deactivateAllButtons();
            openSeo(event);
            Button = document.querySelector('button#rankCheckerButton');
            if (Button) {
                Button.classList.toggle('active');
                const content = Button.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const schemaGeneratorLink = event.currentTarget;
                schemaGeneratorLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const schemaGeneratorSection = document.getElementById('rankCheckerButton');
                    if (schemaGeneratorSection) {
                        schemaGeneratorSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }

        function openContentGenerator(event) {
            event.preventDefault();
            deactivateAllButtons();
            const smmButton = document.querySelector('button#smm');
            if (smmButton) {
                smmButton.classList.toggle('active');
                const content = smmButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const smmLink = event.currentTarget;
                smmLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const smmSection = document.getElementById('smm');
                    if (smmSection) {
                        smmSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
            Button = document.querySelector('button#contentGeneratorButton');
            if (Button) {
                Button.classList.toggle('active');
                const content = Button.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const contentGeneratorLink = event.currentTarget;
                contentGeneratorLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const contentGeneratorSection = document.getElementById('smm');
                    if (contentGeneratorSection) {
                        contentGeneratorSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }

        function openSem(event) {
            event.preventDefault();
            deactivateAllButtons();

            const semButton = document.querySelector('button#semButton');
            if (semButton) {
                semButton.classList.toggle('active');
                const content = semButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const semLink = event.currentTarget;
                semLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const semSection = document.getElementById('semButton');
                    if (semSection) {
                        semSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }

        function openCompetitors(event) {
            event.preventDefault();
            deactivateAllButtons();

            const competitorsButton = document.querySelector('button#competitionBtn');
            if (competitorsButton) {
                competitorsButton.classList.toggle('active');
                const content = competitorsButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const competitorsLink = event.currentTarget;
                competitorsLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const competitorsSection = document.getElementById('competitionBtn');
                    if (competitorsSection) {
                        competitorsSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }

        function openPersona(event) {
            event.preventDefault();
            deactivateAllButtons();

            const personaButton = document.querySelector('button#persona');
            if (personaButton) {
                personaButton.classList.toggle('active');
                const content = personaButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const personaLink = event.currentTarget;
                personaLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const personaSection = document.getElementById('persona');
                    if (personaSection) {
                        personaSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }

        function openMediaPlan(event) {
            event.preventDefault();
            deactivateAllButtons();

            const mediaPlanButton = document.querySelector('button#mediaPlanBtn');
            if (mediaPlanButton) {
                mediaPlanButton.classList.toggle('active');
                const content = mediaPlanButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const mediaPlanLink = event.currentTarget;
                mediaPlanLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const mediaPlanSection = document.getElementById('mediaPlanBtn');
                    if (mediaPlanSection) {
                        mediaPlanSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }

        function openContentCheck(event) {
            event.preventDefault();
            deactivateAllButtons();

            const contentCheckButton = document.querySelector('button#contentcheck');
            if (contentCheckButton) {
                contentCheckButton.classList.toggle('active');
                const content = contentCheckButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const contentCheckLink = event.currentTarget;
                contentCheckLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const contentCheckSection = document.getElementById('contentcheck');
                    if (contentCheckSection) {
                        contentCheckSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }

        function openLandingPageAudit(event) {
            event.preventDefault();
            deactivateAllButtons();

            const landingPageAuditButton = document.querySelector('button#landingPageAuditBtn');
            if (landingPageAuditButton) {
                landingPageAuditButton.classList.toggle('active');
                const content = landingPageAuditButton.nextElementSibling;
                if (content) {
                    content.style.display = content.style.display === "block" ? "none" : "block";
                }

                const landingPageAuditLink = event.currentTarget;
                landingPageAuditLink.classList.toggle('active-menu');

                if (content.style.display === "block") {
                    const landingPageAuditSection = document.getElementById('landingPageAudit');
                    if (landingPageAuditSection) {
                        landingPageAuditSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            }
        }

        async function checkContent() {
            const brandGuideUrlsText = document.getElementById('brand_guide_urls').value || "";
            const otherUrlsText = document.getElementById('content_check_other_urls').value || "";
            const instructions = document.getElementById('content_check_instructions').value || "";
            const content = document.getElementById('content_to_check').value;
            document.getElementById("openFeedbackModalBtn").style.display = "none";
            document.getElementById("copy-check-results-button").style.display = "none";

            document.getElementById("contentCheckBtn").innerText = "Checking...";
            document.getElementById("checkContentResults").innerHTML = "";
            document.getElementById("contentcheck").style.backgroundColor = "#004c9d";

            // **Check if the content field is blank**
            if (!content || content.trim() === "") {
                alert("Please enter content to check.");
                document.getElementById("contentCheckBtn").innerText = "Check Content"; // Reset button text
                return;
            }


            // Split URLs by commas or newlines, and trim whitespace
            const brandGuideUrls = brandGuideUrlsText.split(/[, \n]+/).filter(url => url.trim() !== "");  //filter is important to remove empty strings
            const otherUrls = otherUrlsText.split(/[, \n]+/).filter(url => url.trim() !== ""); //filter is important to remove empty strings

            const allUrls = [...brandGuideUrls, ...otherUrls];  // Combine the arrays

            if (allUrls.length === 0) {
                console.warn("No URLs provided.");
                alert("Please enter at least one URL."); // Optional: provide user feedback
                document.getElementById("contentCheckBtn").innerText = "Check Content"; // Reset button text
                return;
            }

            // API endpoints
            const pdfParserApiUrl = "https://i3oxhgicub.execute-api.ap-southeast-1.amazonaws.com/pdfParser";
            const checkContentApiUrl = "https://mmyvj7yj11.execute-api.ap-southeast-1.amazonaws.com/checkContent";
            const contentParsingApiUrl = "https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing"; // Added content parsing API URL

            try {
                // Create an array of promises for the brand guide URLs API calls
                const brandGuideFetchPromises = brandGuideUrls.map(async url => {
                    try {
                        const response = await fetch(pdfParserApiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ url: url })
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`Error fetching URL ${url}: ${response.status} - ${errorText}`);
                            alert("The brand guide(s) failed to load successfully.");
                            throw new Error(`Failed to fetch ${url}: ${response.status} - ${errorText}`);
                        }

                        const data = await response.json();
                        return data;
                    } catch (error) {
                        console.error(`Error processing URL ${url}:`, error);
                        alert("The brand guide(s) failed to load successfully.");
                        return { url: url, error: error.message };
                    }
                });

                // Create an array of promises for the other URLs API calls to contentParsing endpoint
                const otherUrlsFetchPromises = otherUrls.map(async url => {
                    try {
                        const response = await fetch(contentParsingApiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ url: url })
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`Error fetching URL ${url}: ${response.status} - ${errorText}`);
                            alert("The URL(s) failed to load successfully.");
                            throw new Error(`Failed to fetch ${url}: ${response.status} - ${errorText}`);
                        }

                        const data = await response.json();
                        return data;
                    } catch (error) {
                        console.error(`Error processing URL ${url}:`, error);
                        alert("The URL(s) failed to load successfully.");
                        return { url: url, error: error.message };
                    }
                });


                // Use Promise.all to wait for all API calls to complete
                const brandGuideResults = await Promise.all(brandGuideFetchPromises);
                const otherUrlsResults = await Promise.all(otherUrlsFetchPromises);

                // Combine the responses from pdfParser API calls
                let combinedResponseFromBrandGuide = {};
                brandGuideResults.forEach((result, index) => {
                    combinedResponseFromBrandGuide[brandGuideUrls[index]] = result;  // Use the URL as the key for each response.  Important that allUrls[index] is used instead of result.url because result might be an error object without a .url field.
                });

                // Combine the responses from contentParsing API calls, extracting 'body'
                let combinedResponseFromOtherSources = {};
                otherUrlsResults.forEach((result, index) => {
                    if (result && result.body) {
                        combinedResponseFromOtherSources[otherUrls[index]] = result.body;
                    } else {
                        // Handle the case where 'body' is missing or result is an error object
                        combinedResponseFromOtherSources[otherUrls[index]] = result && result.error ? result.error : "No content"; //Store the error message in the combined response, so the user sees the error message on the UI
                        console.warn(`No 'body' found in the response from ${otherUrls[index]}`);
                    }
                });

                console.log("Combined Responses from brandGuideParser:", combinedResponseFromBrandGuide);
                console.log("Combined Responses from otherSources:", combinedResponseFromOtherSources);


                // Now, send the combined response to the checkContent API
                try {
                    const checkContentResponse = await fetch(checkContentApiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            "brand_guide": combinedResponseFromBrandGuide,
                            "instructions": instructions,
                            "content": content,
                            "other_sources": combinedResponseFromOtherSources  // Changed to the combined other sources response
                        })
                    });

                    if (!checkContentResponse.ok) {
                        const errorText = await checkContentResponse.text();
                        console.error(`Error calling checkContent API: ${checkContentResponse.status} - ${errorText}`);
                        throw new Error(`Failed to call checkContent API: ${checkContentResponse.status} - ${errorText}`);
                    }

                    const checkContentData = await checkContentResponse.json();
                    console.log("Response from checkContent API:", checkContentData);
                    // Display the response body to the user (e.g., in a div)
                    displayCheckContentResults(checkContentData['body']); // Implement this function to show the results
                    document.getElementById("contentcheck").style.backgroundColor = "green";
                } catch (checkContentError) {
                    console.error("Error calling checkContent API:", checkContentError);
                    alert("Error occurred while calling the checkContent API. See console for details.");
                }

            } catch (error) {
                console.error("An error occurred during the API calls:", error);
                alert("An error occurred while checking the content. See console for details."); // Provide user feedback
            }
            document.getElementById("contentCheckBtn").innerText = "Check Content"
        }

        function displayCheckContentResults(data) {
            // This function assumes you have an element with id "checkContentResults" to display the data.
            const resultsDiv = document.getElementById("checkContentResults");
            if (!resultsDiv) {
                console.warn("No element with id 'checkContentRsdfsdfsfesults' found to display the results.");
                return;
            }

            // Convert the data to a readable string (you might want to format it better)
            const formattedData = JSON.stringify(data, null, 2); // Pretty print JSON

            // Set the content of the results div
            resultsDiv.innerHTML = formattedData.replaceAll('"', '');
            document.getElementById("openFeedbackModalBtn").style.display = "block";
            document.getElementById("copy-check-results-button").style.display = "block";
        }



        function deactivateAllButtons() {
            const buttons = document.querySelectorAll('button.collapsible'); // Select all collapsible buttons
            buttons.forEach(button => {
                button.classList.remove('active'); // Remove the 'active' class
                const content = button.nextElementSibling; // Get the content div
                if (content) {
                    content.style.display = 'none'; // Hide the content
                }

                button.style.backgroundColor = "#004c9d"; // Reset color

                // Remove active class from menu items
                const navbarLinks = document.querySelectorAll('#navbar a');
                navbarLinks.forEach(link => link.classList.remove('active-menu'));


            });
        }

        function logout() {
            // Clear Google login
            if (googleUser) {
                google.accounts.id.revoke(googleUser.id_token, () => {
                    console.log('Google account revoked');
                });
                googleUser = null;
                localStorage.removeItem('googleUser');
            }

            // Clear login cookie
            document.cookie = "key=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

            updateUI(false);
            document.getElementById('loginError').textContent = "You have been logged out.";
            document.getElementById('loginForm').style.display = 'flex';
        }
        document.addEventListener('DOMContentLoaded', function () {
            const seoLink = document.getElementById('seo-link');
            const seoSubmenu = document.getElementById('seo-submenu');
            const smmLink = document.getElementById('smm-link');
            const smmSubmenu = document.getElementById('smm-submenu');
        });

        function downloadOverallSummaryTableAsCSV() {
            // CSV content
            const csvRows = [];

            // Add BOM (Byte Order Mark) for UTF-8 encoding, crucial for international characters
            const bom = "\uFEFF";

            // Headers - IMPORTANT:  Explicitly define the order.  This matches the table columns.
            const headers = ['No.', 'Keyword', 'Search Volume', 'CPC', 'Time to Rank', 'Reason'];
            csvRows.push(headers.join(','));

            // Data rows
            summaryData.forEach(item => {
                const values = [
                    item.No,
                    item.keyword,
                    item.search_volume,
                    item.cpc,
                    item.timeToRank,
                    item.reason
                ];
                // Use .map() and double quotes to handle commas and special characters
                const row = values.map(value => `"${String(value).replace(/"/g, '""')}"`).join(','); //IMPORTANT: Escape double quotes within the string
                csvRows.push(row);
            });


            // Create the CSV string
            const csvString = bom + csvRows.join('\n');


            // Create a download link
            const blob = new Blob([csvString], {
                type: 'text/csv;charset=utf-8'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'keyword_summary.csv');
            a.style.display = 'none'; // Hide the link

            // Programmatically trigger the download
            document.body.appendChild(a);
            a.click();

            // Clean up
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        async function getWebpageKeywords() {
            const location = document.getElementById('location').value;
            const language = document.getElementById('language').value;
            const target = document.getElementById('domain').value;

            if (target == "") {
                alert("Please enter a Domain / URL");
                return; // Important: Exit the function if target is empty
            }

            document.getElementById("keywords_for_site").style.backgroundColor = "#004c9d";
            document.getElementById("expandWebpageKeywords").style.backgroundColor = "#004c9d";
            document.getElementById('keywords_for_site').innerText = "Getting Webpage Keywords...";

            const endpoint = "https://ei6xj9x2rd.execute-api.ap-southeast-1.amazonaws.com/keywordsForSite";

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        location: location,
                        language: language,
                        target: target
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                allKeywords = Object.entries(data).map(([keyword, values]) => ({
                    keyword,
                    search_volume: values.search_volume,
                    competition: values.competition,
                    search_intent: values.search_intent,
                    reason_for_choosing: values.reason_for_choosing
                }));

                displayKeywordsTable(allKeywords);
                updateKeywordCount(); //added to update the keyword count paragraph
                document.getElementById('keywords_for_site').innerText = "Keywords Based on Webpage Content";
                document.getElementById("keywords_for_site").style.backgroundColor = "green";
                document.getElementById("expandWebpageKeywords").style.backgroundColor = "green";

                const siteKeywordsDiv = document.getElementById("siteKeywords");
                const icon = document.getElementById("expandWebpageKeywords").querySelector('i');

                if (siteKeywordsDiv.style.display === "block") {
                } else {
                    siteKeywordsDiv.style.display = "block";
                    icon.classList.remove('fa-plus-square');
                    icon.classList.add('fa-minus-square');
                }


            } catch (error) {
                console.error("Error fetching keywords:", error);
                document.getElementById('keywords_for_site').innerText = "Keywords Based on Webpage Content";
                document.getElementById('rankingError').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }

        }

        function displayKeywordsTable(keywords) {
            const container = document.getElementById('siteKeywords');

            if (!container) {
                console.error("Keywords container not found");
                return;
            }
            //ADD A PARAGRAPH TO TRACK SELECTED KEYWORDS
            container.innerHTML = `
            <div class="table-container" style="max-height:350px;overflow:auto">
              <table>
                <thead>
                    <tr>
                        <th onclick="sortSiteTable('keyword')">Keyword</th>
                        <th onclick="sortSiteTable('search_volume')">Search Volume</th>
                        <th onclick="sortSiteTable('competition')">Competition</th>
                        <th onclick="sortSiteTable('search_intent')">Search Intent</th>
                        <th onclick="sortSiteTable('reason_for_choosing')">Reason</th>
                        <th>Choose</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
        `;

            const tbody = container.querySelector('tbody');

            keywords.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                        <td>${item.keyword}</td>
                        <td>${item.search_volume}</td>
                        <td>${item.competition}</td>
                        <td>${item.search_intent}</td>
                        <td>${item.reason_for_choosing}</td>
                        <td><input type="checkbox" value="${item.keyword}" onchange="updateSiteKeywords(this)"></td>
                    `;
                tbody.appendChild(row);
            });
            updateKeywordCount()
            document.getElementById('siteKeywords').innerHTML += '<br><button type="button" onclick="exportSiteKeywordsTableToCSV()">Export as .csv</i></button>';
        }

        function updateSiteKeywords(checkbox) {
            const keyword = checkbox.value;
            const keywordsInput = document.getElementById('keywords');
            let currentKeywords = keywordsInput.value.trim();

            if (checkbox.checked) {
                if (currentKeywords === "") {
                    keywordsInput.value = keyword;
                } else {
                    keywordsInput.value = currentKeywords + ", " + keyword;
                }
            } else {
                let keywordsArray = currentKeywords.split(',').map(item => item.trim());
                keywordsArray = keywordsArray.filter(item => item !== keyword);
                keywordsInput.value = keywordsArray.join(', ');
            }

            updateKeywordsField(); //update the main keywords field.
            updateKeywordCount(); //count the checkboxes selected in webpagekeywords
        }

        function sortSiteTable(column) {
            if (currentSortColumn === column) {
                sortAscending = !sortAscending;
            } else {
                currentSortColumn = column;
                sortAscending = true;
            }

            allKeywords.sort((a, b) => {
                let comparison = 0;

                if (column === 'keyword') {
                    comparison = a.keyword.localeCompare(b.keyword);
                } else if (column === 'search_volume') {
                    comparison = a.search_volume - b.search_volume;
                } else if (column === 'competition') {
                    comparison = a.competition - b.competition;
                } else if (column === 'search_intent') {
                    comparison = a.search_intent.localeCompare(b.search_intent);
                } else if (column === 'reason_for_choosing') {
                    comparison = a.reason_for_choosing.localeCompare(b.reason_for_choosing);
                }

                return sortAscending ? comparison : comparison * -1;
            });

            displayKeywordsTable(allKeywords);
        }

        function copyCheckContentResults() {
            const resultsDiv = document.getElementById("checkContentResults");

            if (!resultsDiv) {
                console.warn("No element with id 'checkContentResults' found.");
                alert("Content Check results not found.");
                return;
            }

            // Create a temporary element for copying.  This ensures we get ALL the content, including hidden parts.
            const tempElement = document.createElement("div");
            tempElement.innerHTML = resultsDiv.innerHTML; //copy innerHTML (preserves formatting)
            tempElement.style.whiteSpace = "pre-wrap";  // Preserve line breaks and spaces.  Crucial!
            tempElement.style.userSelect = "auto"; // Allow text selection

            document.body.appendChild(tempElement); // Add to the DOM

            // Select the text in the temporary element
            const selection = window.getSelection();
            selection.removeAllRanges();
            const range = document.createRange();
            range.selectNodeContents(tempElement);
            selection.addRange(range);


            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert("Content check results copied to clipboard!.");
                } else {
                    console.error("Failed to copy text.");
                    alert("Failed to copy.  Please try again or manually select and copy the text.");
                }
            } catch (err) {
                console.error('Unable to copy: ' + err);
                alert("An error occurred while copying.  Please try again or manually select and copy the text.");
            } finally {
                document.body.removeChild(tempElement);  // Remove the temporary element
                selection.removeAllRanges(); // Deselect everything
            }
        }

        function copyPersonaResults() {
            const resultsDiv = document.getElementById("persona-results");

            if (!resultsDiv) {
                console.warn("No element with id 'persona-results' found.");
                alert("Perosna results not found.");
                return;
            }

            // Create a temporary element for copying.  This ensures we get ALL the content, including hidden parts.
            const tempElement = document.createElement("div");
            tempElement.innerHTML = resultsDiv.innerHTML; //copy innerHTML (preserves formatting)
            tempElement.style.whiteSpace = "pre-wrap";  // Preserve line breaks and spaces.  Crucial!
            tempElement.style.userSelect = "auto"; // Allow text selection

            document.body.appendChild(tempElement); // Add to the DOM

            // Select the text in the temporary element
            const selection = window.getSelection();
            selection.removeAllRanges();
            const range = document.createRange();
            range.selectNodeContents(tempElement);
            selection.addRange(range);


            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert("Personas copied to clipboard!.");
                } else {
                    console.error("Failed to copy text.");
                    alert("Failed to copy.  Please try again or manually select and copy the text.");
                }
            } catch (err) {
                console.error('Unable to copy: ' + err);
                alert("An error occurred while copying.  Please try again or manually select and copy the text.");
            } finally {
                document.body.removeChild(tempElement);  // Remove the temporary element
                selection.removeAllRanges(); // Deselect everything
            }
        }


        // Get the modal
        var modal = document.getElementById("feedbackModal");

        // Get the button that opens the modal
        var btn = document.getElementById("openFeedbackModalBtn");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("feedback-close")[0];

        // When the user clicks the button, open the modal 
        btn.onclick = function () {
            populateFeedbackModal();
            modal.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function () {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            } else if (event.target == document.getElementById('queriesModal')) {
                closeQueriesModal();
            }
        }


        function populateFeedbackModal() {
            document.getElementById("guidelinesURLs").value = document.getElementById("brand_guide_urls").value;
            document.getElementById("websiteURLs").value = document.getElementById("content_check_other_urls").value;
            document.getElementById("otherInstructions").value = document.getElementById("content_check_instructions").value;
            document.getElementById("contentToCheck").value = document.getElementById("content_to_check").value;
            document.getElementById("checkResults").value = document.getElementById("checkContentResults").textContent;

            // Show the submit feedback button
            document.getElementById("openFeedbackModalBtn").style.display = "block";
        }


        document.getElementById("submitFeedbackBtn").addEventListener("click", function () {
            const feedbackData = {
                guidelinesURLs: document.getElementById("guidelinesURLs").value,
                websiteURLs: document.getElementById("websiteURLs").value,
                otherInstructions: document.getElementById("otherInstructions").value,
                contentToCheck: document.getElementById("contentToCheck").value,
                checkResults: document.getElementById("checkResults").value,
                userFeedback: document.getElementById("userFeedback").value,
                user: JSON.parse(localStorage.getItem('googleUser')).email
            };

            // API Endpoint URL
            const apiUrl = 'https://bj7bexizm7.execute-api.ap-southeast-1.amazonaws.com/contentCheckerFeedback'; // Replace with your actual API endpoint

            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(feedbackData)
            })
                .then(response => {
                    if (response.ok) {
                        alert("Feedback submitted successfully!");
                        document.getElementById("userFeedback").value = ""; // Clear feedback
                        modal.style.display = "none"; // Close the modal
                    } else {
                        alert("Failed to submit feedback.");
                    }
                })
                .catch(error => {
                    console.error("Error submitting feedback:", error);
                    alert("An error occurred while submitting feedback.");
                });
        });

        document.addEventListener('DOMContentLoaded', function () {
            const coll = document.getElementsByClassName("funnel-collapsible-before");

            for (let i = 0; i < coll.length; i++) {
                coll[i].addEventListener("click", function () {
                    const content = this.nextElementSibling;

                    if (this.classList.contains("funnel-collapsible-before")) {
                        // If it's 'collapsible-before', change to 'collapsible' and show content
                        this.classList.remove("funnel-collapsible-before");
                        this.classList.add("funnel-collapsible");
                        content.style.display = "block";
                    } else {
                        // If it's 'collapsible', change back to 'collapsible-before' and hide content
                        this.classList.remove("funnel-collapsible");
                        this.classList.add("funnel-collapsible-before");
                        content.style.display = "none";
                    }
                });
            }
        });

        function sortIntersectionTable(columnName) {
            const table = document.getElementById('intersectionResultsTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Determine sort direction
            let isAscending = true; // Default to ascending

            if (table.dataset.sortColumn === columnName) {
                // Same column clicked again, toggle sort direction
                isAscending = table.dataset.sortDirection === 'desc'; // Reverse
            }

            table.dataset.sortColumn = columnName;
            table.dataset.sortDirection = isAscending ? 'asc' : 'desc'; //Update direction

            // Sort rows
            const sortedRows = rows.sort((rowA, rowB) => {
                const cellA = rowA.querySelector(`td:nth-child(${getColumnIndex(table, columnName) + 1})`);
                const cellB = rowB.querySelector(`td:nth-child(${getColumnIndex(table, columnName) + 1})`);

                const valueA = cellA ? cellA.textContent.trim() : '';
                const valueB = cellB ? cellB.textContent.trim() : '';

                let comparison;
                if (isFinite(valueA) && isFinite(valueB)) {
                    comparison = Number(valueA) - Number(valueB); // Numeric comparison
                } else {
                    comparison = valueA.localeCompare(valueB);  // Text comparison
                }

                return isAscending ? comparison : -comparison; // Apply sort direction
            });

            // Append sorted rows to the tbody
            sortedRows.forEach(row => tbody.appendChild(row));
        }

        function getColumnIndex(table, columnName) {
            const headers = Array.from(table.querySelectorAll('th'));
            for (let i = 0; i < headers.length; i++) {
                if (headers[i].textContent.trim() === columnName) {
                    return i;
                }
            }
            return -1; // Column not found
        }

        function copyInteractionResultsTable() {
            const table = document.getElementById('intersectionResultsTable'); // Get the table element
            if (!table) {
                console.error("Interaction Results Table not found");
                return;
            }

            // Extract table data
            const rows = Array.from(table.querySelectorAll('tr'));
            const tableData = rows.map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                return cells.map(cell => cell.textContent.trim()).join('\t'); // Tab-separated values
            }).join('\n'); // Newline for each row

            // Copy to clipboard
            navigator.clipboard.writeText(tableData)
                .then(() => {
                    alert('Interaction Results Table copied to clipboard! You can now paste it into a spreadsheet.');
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Failed to copy the table. Please try again.');
                });
        }

        // Function to export the interactionResultsTable as a CSV file
        function exportInteractionResultsTableToCSV() {
            const table = document.getElementById('intersectionResultsTable'); // Get the table element
            if (!table) {
                console.error("Interaction Results Table not found");
                return;
            }

            // Extract table data
            const rows = Array.from(table.querySelectorAll('tr'));
            const csvData = rows.map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                return cells.map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`).join(','); // Comma-separated values, escape double quotes
            }).join('\n'); // Newline for each row

            // Add BOM (Byte Order Mark) for UTF-8 encoding, crucial for international characters
            const bom = "\uFEFF";
            const csvString = bom + csvData;

            // Create a download link
            const blob = new Blob([csvString], {
                type: 'text/csv;charset=utf-8'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'interaction_results.csv');
            a.style.display = 'none';

            // Programmatically trigger the download
            document.body.appendChild(a);
            a.click();

            // Clean up
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function exportSiteKeywordsTableToCSV() {
            const table = document.getElementById('siteKeywords'); // Get the table element
            if (!table) {
                console.error("Site Keywords Table not found");
                return;
            }

            // Extract table data
            const rows = Array.from(table.querySelectorAll('tr'));
            const csvData = rows.map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                return cells.map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`).join(','); // Comma-separated values, escape double quotes
            }).join('\n'); // Newline for each row

            // Add BOM (Byte Order Mark) for UTF-8 encoding, crucial for international characters
            const bom = "\uFEFF";
            const csvString = bom + csvData;

            // Create a download link
            const blob = new Blob([csvString], {
                type: 'text/csv;charset=utf-8'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'site_keywords.csv');
            a.style.display = 'none';

            // Programmatically trigger the download
            document.body.appendChild(a);
            a.click();

            // Clean up
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function exportRankedKeywordsToCSV(rankedKeywordHeaderRow, rankedKeywordList) {
            // Helper function to escape CSV values
            function escapeCsvValue(value) {
                if (typeof value !== 'string') {
                    value = String(value); // Convert to string if not already
                }
                return `"${value.replace(/"/g, '""')}"`; // Escape double quotes
            }

            // 1. Extract header texts from the header row
            const headers = Array.from(rankedKeywordHeaderRow.querySelectorAll('.keyword-column strong'))
                .map(th => th.textContent.trim());  //Get header row texts

            // Create header row string
            const csvHeaderRow = headers.map(header => escapeCsvValue(header)).join(',');

            // Initialize CSV content with header row
            let csvContent = csvHeaderRow + '\n';  //BOM for UTF-8 encoding.

            // 2. Loop through the list items in rankedKeywordList to extract data
            const listItems = Array.from(rankedKeywordList.querySelectorAll('li.keyword-row'));  //Get data rows
            listItems.forEach(item => {
                const columns = Array.from(item.querySelectorAll('.keyword-column'));  //Get data cells
                const rowValues = columns.map(column => column.textContent.trim());  //Trim spaces in between
                csvContent += rowValues.map(value => escapeCsvValue(value)).join(',') + '\n';  //Escape cell values then combine with a comma.
            });

            // Add BOM (Byte Order Mark) for UTF-8 encoding, crucial for special characters
            const bom = "\uFEFF";
            csvContent = bom + csvContent;

            // Create a download link element
            const link = document.createElement('a');
            link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));  //Set download properties
            link.setAttribute('download', 'ranked_keywords.csv');
            link.style.display = 'none';

            // Append the link to the document
            document.body.appendChild(link);

            // Trigger the download
            link.click();

            // Remove the link from the document
            document.body.removeChild(link);
        }

        function exportSelectedRankedKeywordsToCSV(rankedKeywordHeaderRow, rankedKeywordList) {
            // Helper function to escape CSV values
            function escapeCsvValue(value) {
                if (typeof value !== 'string') {
                    value = String(value); // Convert to string if not already
                }
                return `"${value.replace(/"/g, '""')}"`; // Escape double quotes
            }

            // 1. Extract header texts from the header row
            const headers = Array.from(rankedKeywordHeaderRow.querySelectorAll('.keyword-column strong'))
                .map(th => th.textContent.trim());

            // Create header row string
            const csvHeaderRow = headers.map(header => escapeCsvValue(header)).join(',');

            // Initialize CSV content with header row
            let csvContent = csvHeaderRow + '\n';

            // 2. Loop through the list items in rankedKeywordList and only export checked rows
            const listItems = Array.from(rankedKeywordList.querySelectorAll('li.keyword-row'));

            listItems.forEach(item => {
                // Check if the checkbox in the row is checked
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    const columns = Array.from(item.querySelectorAll('.keyword-column'));
                    const rowValues = columns.map(column => column.textContent.trim());
                    csvContent += rowValues.map(value => escapeCsvValue(value)).join(',') + '\n';
                }
            });

            // Add BOM (Byte Order Mark) for UTF-8 encoding
            const bom = "\uFEFF";
            csvContent = bom + csvContent;

            // Create a download link element
            const link = document.createElement('a');
            link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));
            link.setAttribute('download', 'ranked_keywords.csv');
            link.style.display = 'none';

            // Append the link to the document
            document.body.appendChild(link);

            // Trigger the download
            link.click();

            // Remove the link from the document
            document.body.removeChild(link);
        }

        function exportSelectedKeywordSuggestionsToCSV(keywordHeaderRow, keywordList) {
            // Helper function to escape CSV values
            function escapeCsvValue(value) {
                if (typeof value !== 'string') {
                    value = String(value); // Convert to string if not already
                }
                return `"${value.replace(/"/g, '""')}"`; // Escape double quotes
            }

            // 1. Extract header texts from the header row
            const headers = Array.from(keywordHeaderRow.querySelectorAll('.keyword-column strong'))
                .map(th => th.textContent.trim());

            // Create header row string
            const csvHeaderRow = headers.map(header => escapeCsvValue(header)).join(',');

            // Initialize CSV content with header row
            let csvContent = csvHeaderRow + '\n';

            // 2. Loop through the list items in rankedKeywordList and only export checked rows
            const listItems = Array.from(keywordList.querySelectorAll('li.keyword-row'));

            listItems.forEach(item => {
                // Check if the checkbox in the row is checked
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    const columns = Array.from(item.querySelectorAll('.keyword-column'));
                    const rowValues = columns.map(column => column.textContent.trim());
                    csvContent += rowValues.map(value => escapeCsvValue(value)).join(',') + '\n';
                }
            });

            // Add BOM (Byte Order Mark) for UTF-8 encoding
            const bom = "\uFEFF";
            csvContent = bom + csvContent;

            // Create a download link element
            const link = document.createElement('a');
            link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));
            link.setAttribute('download', 'keyword_ideas.csv');
            link.style.display = 'none';

            // Append the link to the document
            document.body.appendChild(link);

            // Trigger the download
            link.click();

            // Remove the link from the document
            document.body.removeChild(link);
        }

        function exportKeywordSuggestionsToCSV(keywordHeaderRow, keywordList) {
            // Helper function to escape CSV values
            function escapeCsvValue(value) {
                if (typeof value !== 'string') {
                    value = String(value); // Convert to string if not already
                }
                return `"${value.replace(/"/g, '""')}"`; // Escape double quotes
            }

            // 1. Extract header texts from the header row
            const headers = Array.from(keywordHeaderRow.querySelectorAll('.keyword-column strong'))
                .map(th => th.textContent.trim());  //Get header row texts

            // Create header row string
            const csvHeaderRow = headers.map(header => escapeCsvValue(header)).join(',');

            // Initialize CSV content with header row
            let csvContent = csvHeaderRow + '\n';  //BOM for UTF-8 encoding.

            // 2. Loop through the list items in rankedKeywordList to extract data
            const listItems = Array.from(keywordList.querySelectorAll('li.keyword-row'));  //Get data rows
            listItems.forEach(item => {
                const columns = Array.from(item.querySelectorAll('.keyword-column'));  //Get data cells
                const rowValues = columns.map(column => column.textContent.trim());  //Trim spaces in between
                csvContent += rowValues.map(value => escapeCsvValue(value)).join(',') + '\n';  //Escape cell values then combine with a comma.
            });

            // Add BOM (Byte Order Mark) for UTF-8 encoding, crucial for special characters
            const bom = "\uFEFF";
            csvContent = bom + csvContent;

            // Create a download link element
            const link = document.createElement('a');
            link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent));  //Set download properties
            link.setAttribute('download', 'keyword_ideas.csv');
            link.style.display = 'none';

            // Append the link to the document
            document.body.appendChild(link);

            // Trigger the download
            link.click();

            // Remove the link from the document
            document.body.removeChild(link);
        }

        function logConversation(question, generated_answer, feedback, suggested_answer, conversation_id) {
            let user;
            try {
                user = JSON.parse(localStorage.getItem('googleUser')).email;
            } catch (error) {
                console.error("Error parsing user from local storage", error);
                return; // Early exit if user cannot be determined
            }

            fetch('https://7spo2afb9i.execute-api.ap-southeast-1.amazonaws.com/chatbotLogger', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    question: question,
                    generated_answer: generated_answer,
                    feedback: feedback || "",
                    suggested_answer: suggested_answer || "",
                    conversation_id: conversation_id,
                    user: user,
                    is_feedback: "no"
                })
            })
                .then(response => {
                    if (!response.ok) {
                        // Handle HTTP errors (4xx, 5xx status codes)
                        console.error("HTTP error!", response.status, response.statusText);
                        throw new Error(`HTTP error! ${response.status} ${response.statusText}`); //Re-throw to be caught in the .catch block

                    }
                    return response.json(); // Parse JSON body if the request is successful
                })
                .then(data => {
                    console.log("Conversation logged successfully:", data); //Log successful response
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    // Log the error message to the console, and potentially display it to the user

                });
        }
        //chatbot2
        document.addEventListener('DOMContentLoaded', () => {
            const chatbotButton = document.getElementById('chatbot-button');
            const chatbotModal = document.getElementById('chatbot-modal');
            const closeChatbotButton = document.getElementById('close-chatbot');
            const chatMessages = document.getElementById('chat-messages');
            const questionInput = document.getElementById('question-input');
            const sendButton = document.getElementById('send-button-2');

            let isChatbotOpen = false; // Track chatbot state

            chatbotButton.addEventListener('click', () => {
                isChatbotOpen = !isChatbotOpen;
                chatbotModal.style.display = isChatbotOpen ? 'block' : 'none';

                if (chatMessages.textContent == "") {
                    addMessage('chatbot', 'Hello ' + JSON.parse(localStorage.getItem('googleUser')).name.split(' ')[0] + ', how can I help you today?');
                }
            });

            closeChatbotButton.addEventListener('click', () => {
                chatbotModal.style.display = 'none';
                isChatbotOpen = false;
            });

            sendButton.addEventListener('click', async () => {
                const question = questionInput.value.trim();
                if (question !== '') {
                    addMessage('user', question);
                    +                    addMessage('chatbot', 'getting an answer...'); // Display "getting an answer..."
                    questionInput.value = '';
                    try {
                        const response = await fetch('https://7qet2rnlb3.execute-api.ap-southeast-1.amazonaws.com/gptResponses', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ 'question': question, 'previous_response_id': document.getElementById('previous-response-id').innerText || "" })
                        });
                        + chatMessages.lastChild.remove(); // Remove "getting an answer..."
                        const data = await response.json();
                        console.log(data);
                        addMessage('chatbot', data.answer);
                        document.getElementById('previous-response-id').innerText = data.response_id;
                        logConversation(question, data.answer, "-", "-", document.getElementById('threadId').innerText);
                    } catch (error) {
                        console.error('Error:', error);
                        addMessage('chatbot', 'Sorry, I could not process your request.');
                    }
                }
            });

            questionInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    sendButton.click();
                }
            });

            // Function to create and open the feedback modal
            function openFeedbackModal(question, answer) {
                // 1. Create the Modal Structure
                const modal = document.createElement('div');
                modal.id = 'feedbackModal';
                modal.classList.add('feedback-modal');
                modal.innerHTML = `
                    <div class="feedback-modal-content">
                    <span class="feedback-close">×</span>
                    <h2>Give Feedback</h2>
                    <p><b>Question:</b></p>
                    <p>${question}</p>
                    <p><b>Generated Answer:</b></p>
                    <p>${answer}</p>
                    <label for="userFeedback"><b>Your Feedback:</b></label>
                    <textarea id="userFeedback" style="width: 100%; height: 100px;"></textarea><br>
                    <label for="suggestedAnswer"><b>Suggested Answer:</b></label><br>
                    <textarea id="suggestedAnswer" style="width: 100%; height: 100px;"></textarea>
                    <button id="submitFeedbackBtn">Submit Feedback</button>
                    </div>
                `;

                // 2. Add Event Listeners
                document.body.appendChild(modal); // Append to the document

                // Close Modal Button
                const closeBtn = modal.querySelector('.feedback-close');
                closeBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                    modal.remove()
                });

                // Submit Feedback Button
                const submitBtn = modal.querySelector('#submitFeedbackBtn');
                submitBtn.addEventListener('click', () => {
                    const feedback = modal.querySelector('#userFeedback').value;
                    const suggestedAnswer = modal.querySelector('#suggestedAnswer').value;
                    const conversationId = document.getElementById('threadId').innerText; // Or however you get it

                    submitFeedback(question, answer, feedback, suggestedAnswer, conversationId); // Call the submission function
                    modal.style.display = 'none'; // Hide the modal after submission
                    modal.remove()//remove the modal after submission
                });

                // Click outside the modal to close
                window.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                        modal.remove()
                    }
                });

                // 3. Display the Modal
                modal.style.display = 'block';
            }

            // Function to submit the feedback to your API
            async function submitFeedback(question, generatedAnswer, feedback, suggestedAnswer, conversationId) {
                user = JSON.parse(localStorage.getItem('googleUser')).email
                try {
                    const response = await fetch('https://7spo2afb9i.execute-api.ap-southeast-1.amazonaws.com/chatbotLogger', { // Replace with your API endpoint
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            question: question,
                            generated_answer: generatedAnswer,
                            feedback: feedback,
                            suggested_answer: suggestedAnswer,
                            conversation_id: conversationId,
                            user: user,
                            is_feedback: "yes"
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Feedback submitted:', data);
                    alert('Thank you for your feedback!');

                } catch (error) {
                    console.error('Error submitting feedback:', error);
                    alert('Failed to submit feedback. Please try again.');
                }
            }

            function addMessage(sender, message, question = null) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', sender);
                messageDiv.innerHTML = message;

                // Add the "Give Feedback" button *only* to chatbot messages
                if (sender === 'chatbot') {
                    const feedbackButton = document.createElement('button');
                    feedbackButton.textContent = 'Feedback';
                    feedbackButton.classList.add('feedback-button'); // Add a class for styling
                    feedbackButton.addEventListener('click', () => {
                        // Get the current message element
                        const currentMessageDiv = feedbackButton.parentNode; // The parent is the messageDiv

                        // Find the previous element (if it exists)
                        let previousElement = currentMessageDiv.previousElementSibling;

                        let questionText = "";

                        if (previousElement) {
                            questionText = previousElement.textContent;

                        } else {
                            console.warn("No previous element found.  Using empty string for questionText.");
                        }

                        openFeedbackModal(questionText, message);
                    });

                    console.log(document.getElementById('chat-messages').textContent);
                    messageDiv.innerHTML = messageDiv.innerHTML + "<br>";
                    if (message != 'Hello ' + JSON.parse(localStorage.getItem('googleUser')).name.split(' ')[0] + ', how can I help you today?') {
                        messageDiv.appendChild(feedbackButton);
                    }
                }

                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Close chatbot on Esc key press
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && isChatbotOpen) {
                    chatbotModal.style.display = 'none';
                    isChatbotOpen = false;
                }
            });
        });

        function goToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth' // Optional: Adds smooth scrolling
            });
        }

        function clearPageState() {
            // Clear input values
            document.getElementById('domain').value = '';
            document.getElementById('location').value = 'Singapore'; // Reset to default
            document.getElementById('language').value = 'English'; // Reset to default
            document.getElementById('keywords').value = '';

            //Clear values of content generator
            document.getElementById('gender').value = '';
            document.getElementById('age-range').value = '';
            document.getElementById('occupation').value = '';
            document.getElementById('income').value = '';
            document.getElementById('subgroups').value = '';
            document.getElementById('painpoints').value = '';
            document.getElementById('audience_goal').value = '';
            document.getElementById('product_service').value = '';
            document.getElementById('desired_action').value = '';
            document.getElementById('post_objectives').value = '';
            document.getElementById('content-type').value = '';
            document.getElementById('word_count').value = '';
            document.getElementById('tone').value = '';
            document.getElementById('usp').value = '';
            document.getElementById('pov').value = '';
            document.getElementById('emojis').value = '';
            document.getElementById('hashtags').value = '';

            document.getElementById('generator_brand_guide_urls').value = '';
            document.getElementById('sample-text').value = '';
            document.getElementById('post-info').value = '';
            document.getElementById('reference-url').value = '';

            document.getElementById('landingPageUrl').value = '';
            document.getElementById('landingPageAuditKeyword').value = '';

            //Clear output section values
            document.getElementById('targetTitle').innerText = "";
            document.getElementById('targetDescription').innerText = "";
            //document.getElementById('targetDomainRank').innerText = "";
            document.getElementById('targetBacklinks').innerText = "";
            document.getElementById('targetSpamScore').innerText = "";
            document.getElementById('targetRefDomains').innerText = "";
            document.getElementById('targetInternalLinks').innerText = "";
            document.getElementById('targetExternalLinks').innerText = "";
            document.getElementById('targetH1').innerText = "";
            document.getElementById('targetImages').innerText = "";
            document.getElementById('targetCls').innerText = "";
            document.getElementById('targetLcp').innerText = "";
            document.getElementById('targetFid').innerText = "";
            document.getElementById('targetSchema').innerText = "";
            document.getElementById('targetReadability').innerText = "";
            document.getElementById('targetWordCount').innerText = "";
            document.getElementById('da').innerText = "";
            document.getElementById('pa').innerText = "";

            // Clear dynamic content sections
            document.getElementById('overall-summary').innerHTML = '';
            document.getElementById('keyword-analysis-results').innerHTML = '';
            document.getElementById('auditSummary').innerHTML = '';
            document.getElementById('comparison-results').innerHTML = '';

            //document.getElementById('crawlerReport').innerHTML = '';

            document.getElementById("competitors-target1").value = '';
            document.getElementById("competitor_keywords").value = '';
            document.getElementById("competitors-language").value = '';
            document.getElementById("competitors-location").value = '';
            document.getElementById("competitorsOutput").innerHTML = '';

            document.getElementById("persona_webpages").value = '';
            document.getElementById("persona_manual").value = '';
            document.getElementById("persona-results").innerHTML = '';

            document.getElementById("MediaPlanWebpages").value = '';
            document.getElementById("MediaPlanBudget").value = '';
            document.getElementById("MediaPlanManual").value = '';
            document.getElementById("mediaPlanResults").innerHTML = '';

            document.getElementById("content_check_other_urls").value = '';
            document.getElementById("brand_guide_urls").value = '';
            document.getElementById("content_check_instructions").value = '';
            document.getElementById("content_to_check").value = '';
            document.getElementById("checkContentResults").innerHTML = '';

            document.getElementById("on-page-url").value = '';
            document.getElementById("on-page-keywords").value = '';
            document.getElementById("onPageResults").innerHTML = '';
            document.getElementById("imageRecommendations").innerHTML = '';
            document.getElementById("contentRecommendations").innerHTML = '';


            //Clear technical seo output section and buttons
            //document.getElementById("auditSummary").innerHTML = "";
            //document.getElementById('downloadResultsBtn').style.display = 'none';

            // Clear local storage
            localStorage.removeItem('pageState');
            console.log('Page state cleared.');

            // Reset Visibility Style
            document.getElementById('overall-summary').style.display = 'none';

            //Call function to re-render components
            allKeywords = [];
        }

        function openQueriesModal() {
            document.getElementById('queriesModal').style.display = "block";
            loadPreviousQueries('on_page'); // Load data when modal opens
        }

        function openTimeToRankQueriesModal() {
            document.getElementById("timeToRankModal").style.display = "block";
            loadPreviousQueries('time_to_rank'); // Load data when modal opens
        }

        function openContentComparisonQueriesModal() {
            document.getElementById("contentComparisonkModal").style.display = "block";
            loadPreviousQueries('content_comparison'); // Load data when modal opens
        }


        function closeQueriesModal() {
            document.getElementById('queriesModal').style.display = "none";
        }

        function closeContentComparisonQueriesModal() {
            document.getElementById('contentComparisonkModal').style.display = "none";
        }

        function closeTimeToRankQueriesModal() {
            document.getElementById('timeToRankModal').style.display = "none";
        }

        // --- API Interaction Functions ---
        async function loadPreviousQueries(query_type) {
            const API_ENDPOINT = "https://vau2b5m95m.execute-api.ap-southeast-1.amazonaws.com/queryDatabase"; // Replace with your actual API endpoint
            const USER_EMAIL = JSON.parse(localStorage.getItem('googleUser')).email;
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user: USER_EMAIL,
                        collection: query_type
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (query_type == "on_page") {
                    populateQueriesTable(data);
                } else if (query_type == "time_to_rank") {
                    populateTimeToRankQueriesTable(data);
                } else if (query_type == "content_comparison") {
                    populateContentComparisonQueriesTable(data);
                }

            } catch (error) {
                console.error("Error loading previous queries:", error);
                alert("Failed to load previous queries. See console for details.");
            }
        }

        async function contentComparisonToDatabase() {
            endpoint = "https://7gdde3ohdl.execute-api.ap-southeast-1.amazonaws.com/contentComparisonToDatabase";

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    comparison_urls: document.getElementById('comparison-urls').value,
                    comparison_keyword: document.getElementById('comparison-keyword').value,
                    language: document.getElementById('comparison-language').value,
                    location: document.getElementById('comparison-location').value,

                    initial_table: document.getElementById('initial-table').innerHTML,
                    comparison_results: document.getElementById('comparison-results').innerHTML,
                    user: JSON.parse(localStorage.getItem('googleUser')).email
                })
            })

            data = await response.json();
        }

        function populateQueriesTable(queries) {
            const tableBody = document.getElementById('queriesTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ""; // Clear existing rows

            queries.forEach((query, index) => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = formatDate(query.date);
                row.insertCell(2).textContent = query.url;
                row.insertCell(3).textContent = query.keywords;
                row.insertCell(4).textContent = query.user; // Corrected the index here

                row.addEventListener('click', () => loadQueryData(query.id, "on_page")); // Add click listener
            });
            document.getElementById('on_page_loading').style.display = "none";
        }

        function populateTimeToRankQueriesTable(queries) {
            const tableBody = document.getElementById('timeToRankQueriesTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ""; // Clear existing rows

            queries.forEach((query, index) => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = formatDate(query.date);
                row.insertCell(2).textContent = query.url;
                row.insertCell(3).textContent = query.keywords;
                row.insertCell(4).textContent = query.user; // Corrected the index here

                row.addEventListener('click', () => loadTimeToRankQueryData(query.id, "time_to_rank")); // Add click listener
            });
            document.getElementById('time_to_rank_loading').style.display = "none";
        }

        function populateContentComparisonQueriesTable(queries) {
            const tableBody = document.getElementById('contentComparisonQueriesTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ""; // Clear existing rows

            queries.forEach((query, index) => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = index + 1;
                row.insertCell(1).textContent = formatDate(query.date);
                row.insertCell(2).textContent = query.comparison_urls;
                row.insertCell(3).textContent = query.comparison_keyword;
                row.insertCell(4).textContent = query.user; // Corrected the index here

                row.addEventListener('click', () => loadContentComparisonQueryData(query.id, "content_comparison")); // Add click listener
            });
            document.getElementById('content_comparison_loading').style.display = "none";
        }


        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');

            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        async function loadQueryData(id, collection) {
            endpoint = "https://3fbj0gjlak.execute-api.ap-southeast-1.amazonaws.com/loadSingleQuery";
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "id": id,
                    "collection": collection,
                })
            })

            query = await response.json();
            document.getElementById('on-page-url').value = query.url;
            document.getElementById('on-page-keywords').value = query.keywords.join(', ');
            document.getElementById('onPageResults').innerHTML = query.meta_table;
            document.getElementById('imageRecommendations').innerHTML = query.image_table;
            document.getElementById('contentRecommendations').innerHTML = query.content_table;

            document.getElementById('onPageResultsCollapsible').style.display = "block";
            document.getElementById('onPageResults').style.display = "block";
            document.getElementById('imageCollapsible').style.display = "block";
            document.getElementById('imageRecommendations').style.display = "block";
            document.getElementById('contentCollapsible').style.display = "block";
            document.getElementById('contentRecommendations').style.display = "block";

            closeQueriesModal(); // Close modal after loading
        }

        async function loadTimeToRankQueryData(id, collection) {
            endpoint = "https://3fbj0gjlak.execute-api.ap-southeast-1.amazonaws.com/loadSingleQuery";
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "id": id,
                    "collection": collection,
                })
            })

            query = await response.json();

            document.getElementById('domain').value = query.url;
            document.getElementById('keywords').value = query.keywords;
            document.getElementById('location').value = query.location;
            document.getElementById('language').value = query.language;

            document.getElementById('siteKeywords').innerHTML = query.webpage_keywords;
            document.getElementById('rankingKeywords').innerHTML = query.ranking_keywords;
            document.getElementById('keywordSuggestions').innerHTML = query.suggestion_keywords;

            document.getElementById('metaData').innerHTML = query.meta_data;
            document.getElementById('domainMetrics').innerHTML = query.domain_metrics;
            document.getElementById('overall-summary').innerHTML = query.time_to_rank_table;

            document.getElementById('keywordAnalysis').innerHTML = query.keyword_analysis;
            document.getElementById('keywordAnalysis').style.display = "block";

            closeTimeToRankQueriesModal(); // Close modal after loading
        }

        async function loadContentComparisonQueryData(id, collection) {
            endpoint = "https://3fbj0gjlak.execute-api.ap-southeast-1.amazonaws.com/loadSingleQuery";
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "id": id,
                    "collection": collection,
                })
            })

            query = await response.json();
            document.getElementById('comparison-urls').value = query.comparison_urls;
            document.getElementById('comparison-keyword').value = query.comparison_keyword;
            document.getElementById('comparison-location').value = query.location;
            document.getElementById('comparison-language').value = query.language;

            document.getElementById('initial-table').innerHTML = query.initial_table;
            document.getElementById('comparison-results').innerHTML = query.comparison_results;

            closeContentComparisonQueriesModal(); // Close modal after loading
        }

        // On Page
        async function getImages() {
            document.getElementById('contentCollapsible').style.backgroundColor = "#004c9d";
            document.getElementById('imageCollapsible').style.backgroundColor = "#004c9d";
            document.getElementById('onPageResultsCollapsible').style.backgroundColor = "#004c9d";

            document.getElementById('onPageResults').innerHTML = ""; // Clear previous results
            document.getElementById('imageRecommendations').innerHTML = ""; // Clear previous results
            document.getElementById('contentRecommendations').innerHTML = ""; // Clear previous results

            document.getElementById('onPageResultsCollapsible').style.display = "none";
            document.getElementById('imageCollapsible').style.display = "none";
            document.getElementById('contentCollapsible').style.display = "none";
            const url = document.getElementById('on-page-url').value;
            const keywords = document.getElementById('on-page-keywords').value; // Get keywords
            document.getElementById("getImagesBtn").innerText = "Extracting elements..."; // Change button text
            document.getElementById("getImagesBtn").innerHTML += '<img src="https://usagif.com/wp-content/uploads/loading-73.gif" width="50">';

            if (!url) {
                alert("Please enter a URL.");
                document.getElementById("getImagesBtn").innerText = "Extract Elements & Generate Recommendations"; //Revert button text
                return;
            }

            // Process keywords (split by commas or newlines)
            const keywordArray = keywords.split(/[,\n]+/).map(keyword => keyword.trim()).filter(keyword => keyword !== "");

            const endpoint = 'https://udjdc333m9.execute-api.ap-southeast-1.amazonaws.com/getImages';

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url,
                        keywords: keywordArray // Send keywords to the backend
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Call the second API and then display the data
                displayInitialData(data);


                if (!keywords) {
                    alert("No content recommendations will be given as no keywords were entered.")
                    document.getElementById("getImagesBtn").innerText = "Extract Elements & Generate Recommendations"
                    return;
                } else {
                    getOnPageRecommendations(data, keywordArray);
                    getContentRecommendations(url, keywordArray);
                    document.getElementById("getImagesBtn").innerText = "Generating Recommendations...";
                    document.getElementById("getImagesBtn").innerHTML += '<img src="https://usagif.com/wp-content/uploads/loading-73.gif" width="50">';
                }

            } catch (error) {
                document.getElementById('onPageResults').innerHTML = `<p>Error: ${error}</p>`;
                document.getElementById("getImagesBtn").innerText = "Extract Elements & Generate Recommendations";
            }
        }

        // On Page
        async function getContentRecommendations(url, keywordArray) {
            const recommendationEndpoint = 'https://pkkz2e02ch.execute-api.ap-southeast-1.amazonaws.com/onPageContentRecommendations';

            try {
                const recommendationResponse = await fetch(recommendationEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url,
                        "keywords": keywordArray
                    })
                });

                if (!recommendationResponse.ok) {
                    throw new Error(`HTTP error! status: ${recommendationResponse.status}`);
                }

                const recommendationData = await recommendationResponse.json();
                console.log(recommendationData);

                let contentTableHTML = `
            <table id="contentTable">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Current Content</th>
                        <th>Recommendation</th>
                        <th>Rationale</th>
                    </tr>
                </thead>
                <tbody>
            `;

                let i = 0;
                for (const recommendation of recommendationData) {
                    contentTableHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td>${recommendation.current_value}</td>
                    <td><textarea>${recommendation.suggested_value}</textarea></td>
                    <td>${recommendation.rationale}</td>
                </tr>
            `;
                    i++;
                }


                contentTableHTML += `
                </tbody>
            </table>
            `;

                document.getElementById('contentRecommendations').innerHTML = contentTableHTML + '<div style="text-align: center;"><button class="export-button" onclick="exportOnPageToCSV()">Export to CSV</button></div>';
                document.getElementById('contentCollapsible').style.display = "block";
                localStorage.setItem('onPageContent', document.getElementById('contentRecommendations').innerHTML);

            } catch (error) {
                console.error("Error fetching recommendations:", error);
                document.getElementById('contentRecommendations').innerHTML = `<p>Error fetching recommendations: ${error}</p>`;
            }
        }

        async function getOnPageRecommendations(firstApiResponse, keywordArray) {
            const recommendationEndpoint = 'https://vwmqqj251d.execute-api.ap-southeast-1.amazonaws.com/onPageRecommendations';

            try {
                const recommendationResponse = await fetch(recommendationEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "data": firstApiResponse,
                        "keywords": keywordArray
                    })
                });

                if (!recommendationResponse.ok) {
                    throw new Error(`HTTP error! status: ${recommendationResponse.status}`);
                }

                const recommendationData = await recommendationResponse.json();
                displayAllData(recommendationData);
                localStorage.setItem('onPageResults', document.getElementById('onPageResults').innerHTML);
                localStorage.setItem('onPageImages', document.getElementById('imageRecommendations').innerHTML);

            } catch (error) {
                console.error("Error fetching recommendations:", error);
                document.getElementById('onPageResults').innerHTML = `<p>Error fetching recommendations: ${error}</p>`;
            }
        }

        // On page
        function displayInitialData(data) {
            // Add export button above meta table
            let resultsHTML = '';

            let metaTableHTML = `
            <table id="metaTable">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Current Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Meta Title</td>
                        <td>${data.meta_title}</td>
                    </tr>
                    <tr>
                        <td>Meta Description</td>
                        <td>${data.meta_description}</td>
                    </tr>
                    <tr>
                        <td>Canonical URL</td>
                        <td>${data.canonical_url}</td>
                    </tr>`;

            // Function to add heading rows
            function addHeadingRows(headingType, headings) {
                headings.forEach(heading => {
                    metaTableHTML += `
                            <tr>
                                <td>${headingType}</td>
                                <td>${heading}</td>
                            </tr>
                        `;
                });
            }

            addHeadingRows("H1 Heading", data.headings.h1);
            addHeadingRows("H2 Heading", data.headings.h2);
            addHeadingRows("H3 Heading", data.headings.h3);
            addHeadingRows("H4 Heading", data.headings.h4);

            metaTableHTML += `

                    </tbody>
                </table>
            `;

            let imageTableHTML = `
                    <table id="imageTable">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Image URL <button class="copy-button" onclick="copyColumn(1, 'imageTable')">Copy</button></th>
                                <th>Image Preview</th>
                                <th>Alt Text <button class="copy-button" onclick="copyColumn(3, 'imageTable')">Copy</button></th>
                            </tr>
                        </thead>
                        <tbody>
                `;

            for (let i = 0; i < data.image_data.length; i++) {
                const item = data.image_data[i];
                const imageUrl = Object.keys(item)[0];
                const altText = item[imageUrl] || ''; // Handle cases where alt text is empty

                imageTableHTML += `
            <tr>
                <td>${i + 1}</td>
                <td><a href="${imageUrl}" target="_blank">${imageUrl}</a></td>
                <td><img src="${imageUrl}" alt="${altText}"></td>
                <td>${altText}</td>
            </tr>
            `;
            }

            imageTableHTML += `
            </tbody>
        
         `;

            resultsHTML += metaTableHTML

            document.getElementById('imageRecommendations').innerHTML = imageTableHTML;

            // Add export button after image table
            resultsHTML += '<button class="export-button" onclick="exportOnPageToCSV()">Export to CSV</button>';

            document.getElementById('onPageResults').innerHTML = resultsHTML;

            document.getElementById('onPageResultsCollapsible').style.display = "block";
            document.getElementById('imageCollapsible').style.display = "block";

            localStorage.setItem('onPageUrl', document.getElementById('on-page-url').value);
            localStorage.setItem('onPageKeywords', document.getElementById('on-page-keywords').value);
            localStorage.setItem('onPageResults', document.getElementById('onPageResults').innerHTML);
        }

        // On-page
        function displayAllData(data) {
            console.log(data);
            // Add export button above meta table
            let resultsHTML = '';

            let metaTableHTML = `
        <table id="metaTable">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Current Value</th>
                    <th>Suggested Change</th>
                    <th>Rationale</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Meta Title</td>
                    <td>${data.meta_title.current_value}</td>
                    <td><textarea>${data.meta_title.suggested_value}</textarea></td>
                    <td>${data.meta_title.rationale}</td>
                </tr>
                <tr>
                    <td>Meta Description</td>
                    <td>${data.meta_description.current_value}</td>
                    <td><textarea>${data.meta_description.suggested_value}</textarea></td>
                    <td>${data.meta_description.rationale}</td>
                </tr>
                <tr>
                    <td>Canonical URL</td>
                    <td>${data.canonical_url.current_value}</td>
                    <td><textarea>${data.canonical_url.suggested_value}</textarea></td>
                    <td>${data.canonical_url.rationale}</td>
                </tr>`;

            // Function to add heading rows
            function addHeadingRows(headingType, headings) {
                headings.forEach(heading => {
                    metaTableHTML += `
                <tr>
                    <td>${headingType}</td>
                    <td>${heading.current_value}</td>
                    <td><textarea>${heading.suggested_value}</textarea></td>
                    <td>${heading.rationale}</td>
                </tr>
            `;
                });
            }

            addHeadingRows("H1 Heading", data.headings.h1);
            addHeadingRows("H2 Heading", data.headings.h2);
            addHeadingRows("H3 Heading", data.headings.h3);
            addHeadingRows("H4 Heading", data.headings.h4);

            metaTableHTML += `

            </tbody>
        </table>
    `;

            let imageTableHTML = `
            <table id="imageTable">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Image URL <button class="copy-button" onclick="copyColumn(1, 'imageTable')">Copy</button></th>
                        <th>Image Preview</th>
                        <th>Alt Text <button class="copy-button" onclick="copyColumn(3, 'imageTable')">Copy</button></th>
                        <th>Suggested Alt Text</th>
                        <th>Rationale</th>
                    </tr>
                </thead>
                <tbody>
        `;

            let i = 0;
            for (const imageData of data.image_data) {
                const imageUrl = Object.keys(imageData)[0];
                const imageDetails = imageData[imageUrl];

                imageTableHTML += `
                <tr>
                    <td>${i + 1}</td>
                    <td><a href="${imageUrl}" target="_blank">${imageUrl}</a></td>
                    <td><img src="${imageUrl}" alt="${imageDetails.current_value}"></td>
                    <td>${imageDetails.current_value}</td>
                    <td><textarea>${imageDetails.suggested_value}</textarea></td>
                    <td>${imageDetails.rationale}</td>
                </tr>
            `;
                i++;
            }


            imageTableHTML += `
                </tbody>
            </table>
        `;

            resultsHTML += metaTableHTML;

            // Add export button after image table
            resultsHTML += '<button class="export-button" onclick="exportOnPageToCSV()">Export to CSV</button>';

            document.getElementById('onPageResults').innerHTML = resultsHTML;
            document.getElementById('imageRecommendations').innerHTML = imageTableHTML;
            document.getElementById("getImagesBtn").innerText = "Extract Elements & Generate Recommendations";
            localStorage.setItem('onPageResults', document.getElementById('onPageResults').innerHTML);
            localStorage.setItem('onPageImages', document.getElementById('imageRecommendations').innerHTML);
            onPageToDatabase();
        }

        async function onPageToDatabase() {
            keywords = document.getElementById('on-page-keywords').value; // Get keywords
            keywordArray = keywords.split(/[,\n]+/).map(keyword => keyword.trim()).filter(keyword => keyword !== "");
            endpoint = "https://7nq1nq4ll5.execute-api.ap-southeast-1.amazonaws.com/onPageToDatabase";

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    url: document.getElementById('on-page-url').value,
                    keywords: keywordArray,
                    meta_table: document.getElementById('onPageResults').innerHTML,
                    image_table: document.getElementById('imageRecommendations').innerHTML,
                    content_table: document.getElementById('contentRecommendations').innerHTML,
                    user: JSON.parse(localStorage.getItem('googleUser')).email
                })
            })

            data = await response.json();
        }

        function copyColumn(columnIndex, tableId = 'onPageResults') {
            let table = document.querySelector('table'); // Default to the first table
            if (tableId === 'imageTable') {
                // Find the second table if tableId is 'imageTable'
                const tables = document.querySelectorAll('table');
                table = tables[1]; // Assuming the image table is the second one
            }

            if (!table) {
                console.error('Table not found');
                return;
            }

            const rows = table.querySelectorAll('tr');
            let columnText = '';

            for (let i = 1; i < rows.length; i++) { // Skip the header row
                const cells = rows[i].querySelectorAll('td');
                if (cells.length > columnIndex) {
                    columnText += cells[columnIndex].textContent.trim() + '\n';
                }
            }

            // Create a temporary textarea element to hold the text
            const textarea = document.createElement('textarea');
            textarea.value = columnText;
            document.body.appendChild(textarea);

            // Select the text in the textarea
            textarea.select();

            try {
                // Execute the copy command
                const successful = document.execCommand('copy');
                const msg = successful ? 'successful' : 'unsuccessful';
                console.log('Copying text command was ' + msg);
                alert('Column copied to clipboard!');
            } catch (err) {
                console.error('Oops, unable to copy', err);
                alert('Failed to copy column to clipboard.');
            }

            // Remove the temporary textarea
            document.body.removeChild(textarea);
        }

        function exportOnPageToCSV() {
            // Collect data from both tables
            const metaTable = document.getElementById('metaTable');
            const imageTable = document.getElementById('imageTable');
            const contentTable = document.getElementById('contentTable');


            if (!metaTable || !imageTable) {
                alert('Tables not found. Please extract data first.');
                return;
            }

            const metaData = tableToCSV(metaTable);
            const imageData = tableToCSV(imageTable);
            const contentData = tableToCSV(contentTable);

            // Combine the data with a separator
            const csvData = "Meta Table Data:\n" + metaData + "\n\nImage Table Data:\n" + imageData + "\n\nContent Recommendations:\n" + contentData;

            // Create a download link
            const filename = 'on_page_recommendations.csv';
            const csvFile = new Blob([csvData], {
                type: 'text/csv'
            });
            const downloadLink = document.createElement('a');
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        function tableToCSV(table) {
            const rows = table.querySelectorAll('tr');
            let csv = [];

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].querySelectorAll('th, td');
                let row = [];
                for (let j = 0; j < cells.length; j++) {
                    //remove the button tag
                    let cellText = cells[j].textContent.replace(/<[^>]*>?/gm, '').trim();
                    row.push('"' + cellText.replace(/"/g, '""') + '"'); // Escape double quotes
                }
                csv.push(row.join(','));
            }

            return csv.join('\n');
        }


        function loadCachedData() {
            const url = localStorage.getItem('onPageUrl');
            const keywords = localStorage.getItem('onPageKeywords');
            const resultsHTML = localStorage.getItem('onPageResults');
            const imageHTML = localStorage.getItem('onPageImages');
            const contentHTML = localStorage.getItem('onPageContent');

            if (url) {
                document.getElementById('on-page-url').value = url;
            }
            if (keywords) {
                document.getElementById('on-page-keywords').value = keywords;
            }
            if (resultsHTML) {
                document.getElementById('onPageResults').innerHTML = resultsHTML;
                document.getElementById('onPageResultsCollapsible').style.display = "block";
                document.getElementById('onPageResultsCollapsible').style.backgroundColor = "green";
            }
            if (imageHTML) {
                document.getElementById('imageRecommendations').innerHTML = imageHTML;
                document.getElementById('imageCollapsible').style.display = "block";
                document.getElementById('imageCollapsible').style.backgroundColor = "green";
            }
            if (contentHTML) {
                document.getElementById('contentRecommendations').innerHTML = contentHTML;
                document.getElementById('contentCollapsible').style.display = "block";
                document.getElementById('contentCollapsible').style.backgroundColor = "green";
            }

            if (url || keywords || resultsHTML || imageHTML || contentHTML) {
            } else {
                alert('No data found in cache.');
            }
        }

        function clearOnPageData() {
            document.getElementById("on-page-url").value = "";
            document.getElementById("keywords").value = "";
            document.getElementById("onPageResults").innerText = "";
            document.getElementById("imageRecommendations").innerText = "";
            document.getElementById("contentRecommendations").innerText = "";

            document.getElementById('onPageResultsCollapsible').style.display = "none";
            document.getElementById('onPageResultsCollapsible').style.backgroundColor = "#004c9d";

            document.getElementById('imageCollapsible').style.display = "none";
            document.getElementById('imageCollapsible').style.backgroundColor = "#004c9d";

            document.getElementById('contentCollapsible').style.display = "none";
            document.getElementById('contentCollapsible').style.backgroundColor = "#004c9d";

        }

        async function checkRanks() {
            document.getElementById('rankCheckerResultsTable').style.display = "none";
            document.getElementById('checkRanksButton').innerHTML = "Checking rankings...";
            const keywords = document.getElementById('rankCheckerKeywords').value.split('\n');
            domain = document.getElementById('rankCheckerDomain').value;
            const tableBody = document.getElementById('rankCheckerResultsTableBody');
            tableBody.innerHTML = ""; // Clear previous results
            const results = [];
            for (keyword of keywords) {
                const row = tableBody.insertRow();
                const rankCell = row.insertCell();
                const keywordCell = row.insertCell();

                rankCell.textContent = 'getting rank...';
                keywordCell.textContent = keyword;

                if (keyword.trim() !== "") { // Only make API call if keyword is not empty
                    results.push(fetchRank(keyword.trim(), row));
                } else {
                    rankCell.textContent = ''; // Clear "getting rank" for empty lines
                }
            }

            await Promise.all(results); // Wait for all API calls to complete
            document.getElementById('rankCheckerResultsTable').style.display = "block";
            document.getElementById('checkRanksButton').innerHTML = "Check Ranks";
        }

        async function fetchRank(keyword, row) {
            domain = document.getElementById('rankCheckerDomain').value;
            console.log(domain);
            const rankCell = row.cells[0];
            try {
                const response = await fetch('https://v5bizygr4m.execute-api.ap-southeast-1.amazonaws.com/rankChecker', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "keyword": keyword,
                        "language": document.getElementById('rankCheckerLanguage').value,
                        "location": document.getElementById('rankCheckerLocation').value,
                        "target": domain
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }

                data = await response.json();

                if (data == null) {
                    data = 999;
                }
                rankCell.textContent = data;
            } catch (error) {
                console.error("Error fetching rank:", error);
                rankCell.textContent = 'not available';
            }
        }

        function loadFromLocalStorage() {
            const inputs = document.querySelectorAll('input, textarea, select');

            inputs.forEach(input => {
                const key = input.id;
                if (key) {
                    try {
                        const storedValue = localStorage.getItem(key);
                        if (storedValue !== null) {
                            const parsedValue = JSON.parse(storedValue);

                            if (input.type === 'checkbox') {
                                input.checked = parsedValue;
                            } else if (input.tagName === 'SELECT') {
                                input.value = parsedValue;
                            } else {
                                input.value = parsedValue;
                            }
                        }
                    } catch (error) {
                        console.error(`Error loading or parsing value for ${key}:`, error);
                    }
                }
            });

            // Load generated content
            const contentIds = [
                'overall-summary',
                'keyword-analysis-results',
                'technicalSeo',
                'contentComparison',
                'schema',
                'onPageSection',
                'rankChecker',
                'socialMedia',
                'SEM',
                'competitors_content',
                'persona_content',
                'mediaplan',
                'content_check_content',
                'landingPageAudit',
                'onPageResults',
                'imageRecommendations',
                'contentRecommendations'
            ];

            contentIds.forEach(id => {
                const element = document.getElementById(id);
                const storedContent = localStorage.getItem(id);
                if (element && storedContent) {
                    element.innerHTML = storedContent;
                }
            });

            console.log('Page state loaded from localStorage');
        }

        function saveToLocalStorage() {
            // Get all input elements (including textareas, selects)
            const inputs = document.querySelectorAll('input, textarea, select');

            inputs.forEach(input => {
                const key = input.id; // Use the input's ID as the storage key

                if (key) { // Only save if the input has an ID
                    let value;

                    if (input.type === 'checkbox') {
                        value = input.checked; // Boolean for checkboxes
                    } else if (input.tagName === 'SELECT') {
                        value = input.value; // Selected option's value
                    } else {
                        value = input.value; // Text input, textarea value
                    }

                    localStorage.setItem(key, JSON.stringify(value)); // Convert value to string for storage
                }
            });

            // Get all generated content elements by ID
            const contentIds = [
                'overall-summary',
                'keyword-analysis-results',
                'technicalSeo',
                'contentComparison',
                'schema',
                'onPageSection',
                'rankChecker',
                'socialMedia',
                'SEM',
                'competitors_content',
                'persona_content',
                'mediaplan',
                'content_check_content',
                'landingPageAudit'
            ];

            contentIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    localStorage.setItem(id, element.innerHTML);
                }
            });

            console.log('Page state saved to localStorage');
        }

        setInterval(saveToLocalStorage, 5000); // Save every 5 seconds
        const seoNavItem = document.getElementById('seoNavItem');
        const smmNavItem = document.getElementById('smmNavItem');
        const othersNavItem = document.getElementById('othersNavItem'); //Add others item

        function toggleDropdown(navItem) {
            navItem.classList.toggle('show');
        }

        if (window.innerWidth <= 600) {
            seoNavItem.addEventListener('click', (event) => {
                event.preventDefault();
                toggleDropdown(seoNavItem);
            });

            smmNavItem.addEventListener('click', (event) => {
                event.preventDefault();
                toggleDropdown(smmNavItem);
            });

            othersNavItem.addEventListener('click', (event) => { //Add function for others nav item on mobile
                event.preventDefault();
                toggleDropdown(othersNavItem);
            });
        }
    </script>

</body>

</html>