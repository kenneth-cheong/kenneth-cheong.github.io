<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediaOne FAQ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        h1 {
            color: #4CAF50;
        }

        form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: auto;
            margin: 0 auto;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        input[type="text"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: auto;
        }

        button:hover {
            background: #45a049;
        }

        #apiResponse {
            margin-top: 20px;
            padding: 10px;
            background-color: #ffffff;
            border: 1px solid #dedede;
            border-radius: 4px;
            width: auto;
            margin: 20px auto;
            word-wrap: break-word;
        }

        #base64,
        #consultant {
            display: none;
        }
    </style>
    <script>
  const sheetUrl = 'https://corsproxy.io/?' + 'https://docs.google.com/spreadsheets/d/1C7vKA0lGNKImtAK4-2TpudNqkcp_6A3otl7rcbutDBQ/gviz/tq?tqx=out:csv&sheet=Sheet1';

  fetch(sheetUrl)
    .then(res => res.text())
    .then(csv => {
      const data = parseCSV(csv);
      displayFAQ(data);
    })
    .catch(error => {
      console.error("Error fetching data:", error);
    });

  function parseCSV(csv) {
    console.log(csv);
    const lines = csv.split('\n');
    const data = [];
    for (let i = 1; i < lines.length; i++) { 
      const row = lines[i].split('","');
        
      data.push({
        question: row[0]?.trim().replaceAll('"',''), 
        answer: row[1]?.trim().replaceAll('"',''),   
        category: row[2]?.trim().replaceAll('"','')  
      });
    }
    return data;
  }

  function displayFAQ(data) {
    const faqContainer = document.getElementById('faq-container');
    const categories = {};

    data.forEach(item => {
      const category = item.category;
      if (!categories[category]) {
        categories[category] = [];
      }
      categories[category].push({
        question: item.question,
        answer: item.answer
      });
    });

    const sortedCategories = Object.keys(categories).sort().reverse();

    sortedCategories.slice(1).forEach(category => {
      const categoryDiv = document.createElement('div');
      categoryDiv.classList.add('category-container');

      const title = document.createElement('h2');
      title.classList.add('category-title');
      title.textContent = category;
      categoryDiv.appendChild(title);

      categories[category].forEach(qa => {
        const questionDiv = document.createElement('div');
        questionDiv.classList.add('question');
        questionDiv.textContent = qa.question;

        const answerDiv = document.createElement('div');
        answerDiv.classList.add('answer');
        answerDiv.textContent = qa.answer;

        questionDiv.addEventListener('click', () => {
          answerDiv.style.display = answerDiv.style.display === 'none' ? 'block' : 'none';
        });

        categoryDiv.appendChild(questionDiv);
        categoryDiv.appendChild(answerDiv);
      });

      faqContainer.appendChild(categoryDiv);
    });
  }
        async function readFile() {
            const response = await fetch('https://kenneth-cheong.github.io/base64.txt');
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            const text = await response.text();
            document.getElementById('base64').innerText = text;
        }

        async function readConsultantFile() {
            const response = await fetch('https://kenneth-cheong.github.io/consultant.txt');
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            const text = await response.text();
            document.getElementById('consultant').innerText = text;
        }

        window.onload = function () {
            readFile();
            readConsultantFile();
        };

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('queryForm').addEventListener('submit', function (event) {
                event.preventDefault();
                document.getElementById('apiResponse').textContent = 'Processing your request...';
                var question = document.getElementById('question').value;
                var website = document.getElementById('website').value || "N/A";
                var database = document.getElementById('base64').innerText;
                var consultantData = document.getElementById('consultant').innerText;

                var url = "";

                var queryString = {
                    "contents": [
                        {
                            "parts": [
                                {
                                    "text": "Parse the output nicely in text only without any additional asterisks and do not mention the csv files. You are client whose website is " + website + ". Based on the attached csv, answer the following question concisely. If the csv does not contain the answer, try to answer it using external knowledge. If you do not know the answer, reply 'I don't know the answer, please drop us an email on your query!': " + question
                                },
                                {
                                    "inlineData": {
                                        "mimeType": "text/csv",
                                        "data": database
                                    }
                                },
                                {
                                    "inlineData": {
                                        "mimeType": "text/plain",
                                        "data": consultantData
                                    }
                                }
                            ],
                            "role": "user"
                        }
                    ]
                };

                var headers = {
                    "Accept": "application/json",
                    "Content-Type": "application/json"
                };

                fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(queryString)
                })
                    .then(response => response.json())
                    .then(data => {
                        var apiResponseText = data.candidates[0].content.parts[0].text;
                        document.getElementById('apiResponse').textContent = apiResponseText;
                        return apiResponseText;
                    })
                    .then(responseText => {
                        // Post to Google Sheet
                        var postData = JSON.stringify({ question: question, website: website, response: responseText });
                        fetch('https://proxy.cors.sh/'+'https://script.google.com/a/macros/mediaone.co/s/AKfycbzxDmCcpWcbhY2Ph1AszUEH3QtYuZhtj1Ev_w0uqFD5tNZ6YWZ5Wr-KrN2uWWJOEzs/exec', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: postData
                        });
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        document.getElementById('apiResponse').textContent = "Failed to get response.";
                        // Even if error, send data to Google Sheet
                        var postData = JSON.stringify({ question: question, website: website, response: 'Error getting response' });
                        fetch('https://proxy.cors.sh/'+'https://script.google.com/a/macros/mediaone.co/s/AKfycbzxDmCcpWcbhY2Ph1AszUEH3QtYuZhtj1Ev_w0uqFD5tNZ6YWZ5Wr-KrN2uWWJOEzs/exec', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: postData
                        });
                    });
            });
        });

    </script>
</head>

<body>
    <h1>MediaOne FAQ</h1>
    <form id="queryForm">
        <label for="question">Your question:</label>
        <input type="text" id="question" name="question" required>

        <label for="website">Your website (optional):</label>
        <input type="text" id="website" name="website">

        <button type="submit">Submit</button>
    </form>

    <h2>Response:</h2>
    <p id="apiResponse">Enter your question and hit Enter or click 'Submit'!</p>

    <p id="base64"></p>
    <p id="consultant"></p>
</body>

</html>