<!DOCTYPE html>
<html>

<head>
  <title>Keyword Analysis Tool</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
      cursor: pointer;
    }

    a {
      color: blue;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .error {
      color: red;
      font-weight: bold
    }

    input[type="text"] {
      min-width: 40%;
      padding: 5px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    .collapsible {
      background-color: #777;
      color: white;
      cursor: pointer;
      padding: 18px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 15px;
    }

    .active,
    .collapsible:hover {
      background-color: #555;
    }

    .content {
      padding: 0 18px;
      display: none;
      overflow: hidden;
      background-color: #f1f1f1;
    }

    .keywords-collapsible {
      background-color: #eee;
      color: #444;
      cursor: pointer;
      padding: 10px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .keywords-active,
    .keywords-collapsible:hover {
      background-color: #ddd;
    }

    .keywords-content {
      padding: 0 10px;
      overflow: hidden; /* IMPORTANT:  Remove display:none initial style */
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      margin-bottom: 10px;
    }

    .keywords-container {
      margin-bottom: 20px;
    }

  </style>
</head>

<body>

  <h1>Keyword Analysis Tool</h1>

  <label for="language">Language:</label>
  <input type="text" id="language" value="English"><br><br>

  <label for="location">Location:</label>
  <input type="text" id="location" value="Singapore"><br><br>

  <label for="target">Target URL:</label>
  <input type="text" id="target" value="https://mediaonemarketing.com.sg"><br><br>

  <label for="keywords">Selected Keywords:</label>
  <input type="text" id="keywords" value=""><br><br>

  <button id="getKeywordsBtn" onclick="getKeywords()">Get Keywords</button>
  <button id="analysisBtn" onclick="startAnalysis()">Start Analysis</button>
  <br><br><hr><br>

  <div id="keywords-collapsible-container">
    <button type="button" class="keywords-collapsible keywords-active" id="keywordsCollapsible">Keyword Recommendations</button>
    <div class="keywords-content" id="keywords-container" style="display: block;">
      <!-- Keyword recommendations table will be rendered here -->
    </div>
  </div>

  <div id="analysis-results">
    <!-- Collapsible sections for each keyword analysis will be added here -->
  </div>

  <script>
    let allKeywords = [];
    let currentSortColumn = null;
    let sortAscending = true;

    // Initialize collapsible functionality
    document.addEventListener('DOMContentLoaded', function() {
      const collapsibleButton = document.getElementById('keywordsCollapsible');
      const collapsibleContent = document.getElementById('keywords-container');

      // Set initial state to expanded
      collapsibleButton.classList.add('keywords-active');
      collapsibleContent.style.display = 'block';

      collapsibleButton.addEventListener('click', function() {
        this.classList.toggle('keywords-active');
        collapsibleContent.style.display = (collapsibleContent.style.display === 'block') ? 'none' : 'block';
      });
    });

    async function getKeywords() {
      const location = document.getElementById('location').value;
      const language = document.getElementById('language').value;
      const target = document.getElementById('target').value;

      document.getElementById('getKeywordsBtn').innerText = "Getting Keywords...";

      const endpoint = "https://ei6xj9x2rd.execute-api.ap-southeast-1.amazonaws.com/keywordsForSite";

      try {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            location: location,
            language: language,
            target: target
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        allKeywords = Object.entries(data).map(([keyword, values]) => ({
          keyword,
          search_volume: values.search_volume,
          competition: values.competition
        }));

        displayKeywordsTable(allKeywords);
        document.getElementById('getKeywordsBtn').innerText = "Get Keywords";

      } catch (error) {
        console.error("Error fetching keywords:", error);
        document.getElementById('keywords-container').innerHTML = `<p class="error">Error: ${error.message}</p>`;
      }
    }

    function displayKeywordsTable(keywords) {
      const container = document.getElementById('keywords-container');
      if (!container) {
        console.error("Keywords container not found");
        return;
      }
      container.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th></th>
                        <th onclick="sortTable('keyword')">Keyword</th>
                        <th onclick="sortTable('search_volume')">Search Volume</th>
                        <th onclick="sortTable('competition')">Competition</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        `;

      const tbody = container.querySelector('tbody');

      keywords.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
                        <td><input type="checkbox" value="${item.keyword}" onchange="updateKeywords(this)"></td>
                        <td>${item.keyword}</td>
                        <td>${item.search_volume}</td>
                        <td>${item.competition}</td>
                    `;
        tbody.appendChild(row);
      });
    }

    function updateKeywords(checkbox) {
      const keyword = checkbox.value;
      const keywordsInput = document.getElementById('keywords');
      let currentKeywords = keywordsInput.value.trim();

      if (checkbox.checked) {
        if (currentKeywords === "") {
          keywordsInput.value = keyword;
        } else {
          keywordsInput.value = currentKeywords + ", " + keyword;
        }
      } else {
        let keywordsArray = currentKeywords.split(',').map(item => item.trim());
        keywordsArray = keywordsArray.filter(item => item !== keyword);
        keywordsInput.value = keywordsArray.join(', ');
      }
    }

    function sortTable(column) {
      if (currentSortColumn === column) {
        sortAscending = !sortAscending;
      } else {
        currentSortColumn = column;
        sortAscending = true;
      }

      allKeywords.sort((a, b) => {
        let comparison = 0;

        if (column === 'keyword') {
          comparison = a.keyword.localeCompare(b.keyword);
        } else if (column === 'search_volume') {
          comparison = a.search_volume - b.search_volume;
        } else if (column === 'competition') {
          comparison = a.competition - b.competition;
        }

        return sortAscending ? comparison : comparison * -1;
      });

      displayKeywordsTable(allKeywords);
    }

    async function performSearchAndAnalysis(keyword, language, location, target) {
      const analysisResultsContainer = document.getElementById('analysis-results');
      const keywordContainerId = `keyword-container-${keyword.replace(/\s+/g, '-')}`;

      const collapsibleSection = document.createElement('div');
      collapsibleSection.id = keywordContainerId;
      collapsibleSection.innerHTML = `
            <button type="button" class="keywords-collapsible">${keyword}</button>
            <div class="keywords-content" id="keyword-content-${keyword.replace(/\s+/g, '-')}">
                <div id="results-container-${keyword.replace(/\s+/g, '-')}"></div>
                <div id="recommendations-container-${keyword.replace(/\s+/g, '-')}"></div>
            </div>
        `;
      analysisResultsContainer.appendChild(collapsibleSection);

      const coll = collapsibleSection.querySelector(".keywords-collapsible");
      coll.addEventListener("click", function() {
        this.classList.toggle("keywords-active");
        const content = this.nextElementSibling;
        if (content.style.display === "block") {
          content.style.display = "none";
        } else {
          content.style.display = "block";
        }
      });

      const serpEndpoint = 'https://8k6r15rg4m.execute-api.ap-southeast-1.amazonaws.com/serpLite';
      try {
        const serpResponse = await fetch(serpEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            keyword: keyword,
            language: language,
            location: location
          })
        });

        if (!serpResponse.ok) {
          throw new Error(`SERP API Error: ${serpResponse.status} ${serpResponse.statusText}`);
        }

        const serpData = await serpResponse.json();
        console.log(`SERP API Response for ${keyword}:`, serpData);

        if (!serpData || !serpData.body) {
          throw new Error(`Invalid SERP API response format for ${keyword}. Expected 'body' property.`);
        }

        const serp_dict = serpData.body;

        displaySerpResults(serp_dict, `results-container-${keyword.replace(/\s+/g, '-')}`);

        const urls = Object.values(serp_dict).map(item => item.url);

        const contentParsingPromises = urls.map(async (url) => {
          const contentParsingEndpoint = 'https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing';
          try {
            const contentResponse = await fetch(contentParsingEndpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                url: url
              })
            });

            if (!contentResponse.ok) {
              console.warn(`Content Parsing API Error for URL ${url} (Keyword: ${keyword}): ${contentResponse.status} ${contentResponse.statusText}`);
              return null;
            }
            return await contentResponse.json();
          } catch (error) {
            console.error(`Error fetching content for URL ${url} (Keyword: ${keyword}):`, error);
            return null;
          }
        });

        const keywordMappingEndpoint = 'https://c0bkxhc1s3.execute-api.ap-southeast-1.amazonaws.com/keywordMapping';
        let target_content = null;

        try {
          const keywordMappingResponse = await fetch(keywordMappingEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              location: location,
              keyword: keyword,
              language: language,
              target: target
            })
          });

          if (!keywordMappingResponse.ok) {
            throw new Error(`Keyword Mapping API Error for ${keyword}: ${keywordMappingResponse.status} ${keywordMappingResponse.statusText}`);
          }

          const keywordMappingData = await keywordMappingResponse.json();
          console.log(`Keyword Mapping API Response for ${keyword}:`, keywordMappingData);

          if (keywordMappingData && keywordMappingData.body && Array.isArray(keywordMappingData.body)) {
            const targetUrls = keywordMappingData.body;

            const targetContentPromises = targetUrls.map(async (url) => {
              const contentParsingEndpoint = 'https://0i0g9xfy63.execute-api.ap-southeast-1.amazonaws.com/contentParsing';
              try {
                const contentResponse = await fetch(contentParsingEndpoint, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    url: url
                  })
                });

                if (!contentResponse.ok) {
                  console.warn(`Content Parsing API Error for URL ${url} (Keyword: ${keyword}): ${contentResponse.status} ${contentResponse.statusText}`);
                  return null;
                }
                return await contentResponse.json();
              } catch (error) {
                console.error(`Error fetching content for URL ${url} (Keyword: ${keyword}):`, error);
                return null;
              }
            });

            const targetContentResults = await Promise.all(targetContentPromises);
            const validTargetContent = targetContentResults.filter(result => result !== null);
            target_content = validTargetContent;

            console.log(`Target Content for ${keyword}:`, target_content);
          } else {
            console.warn(`Invalid Keyword Mapping API response format for ${keyword}. Expected 'body' as array.`);
          }

        } catch (error) {
          console.error(`Error during Keyword Mapping or Target Content Processing for ${keyword}:`, error);
        }

        const contentParsingResults = await Promise.all(contentParsingPromises);
        const validContentParsingResults = contentParsingResults.filter(result => result !== null);

        console.log(`Content Parsing Results for ${keyword}:`, validContentParsingResults);

        if (target_content && serp_dict) {
          const kwRecommendationsEndpoint = 'https://yk9fcv2xf3.execute-api.ap-southeast-1.amazonaws.com/kwRecommendations';

          try {
            const kwRecommendationsResponse = await fetch(kwRecommendationsEndpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                keyword: keyword,
                target_content: target_content,
                serps_dict: serp_dict
              })
            });

            if (!kwRecommendationsResponse.ok) {
              throw new Error(`Keyword Recommendations API Error for ${keyword}: ${kwRecommendationsResponse.status} ${kwRecommendationsResponse.statusText}`);
            }

            const kwRecommendationsData = await kwRecommendationsResponse.json();
            console.log(`Keyword Recommendations API Response for ${keyword}:`, kwRecommendationsData);

            displayKeywordRecommendations(kwRecommendationsData.body, `recommendations-container-${keyword.replace(/\s+/g, '-')}`);
          } catch (error) {
            console.error(`Error during Keyword Recommendations for ${keyword}:`, error);
          }
        } else {
          console.warn(`Skipping Keyword Recommendations for ${keyword} due to missing target_content or serp_dict.`);
        }
      } catch (error) {
        console.error(`An error occurred for ${keyword}:`, error);
        const container = document.getElementById(`results-container-${keyword.replace(/\s+/g, '-')}`);
        container.innerHTML = `<p class="error">Error: ${error.message}</p>`;
      }
    }

    function displaySerpResults(serpResults, containerId) {
      const resultsContainer = document.getElementById(containerId);
      if (!resultsContainer) {
        console.error(`Element with ID '${containerId}' not found.`);
        return;
      }

      let tableHTML = `
            <h2>SERP Results</h2>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>URL</th>
                        <th>Title</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
        `;

      for (const rank in serpResults) {
        if (serpResults.hasOwnProperty(rank)) {
          const result = serpResults[rank];
          tableHTML += `
                    <tr>
                        <td>${rank}</td>
                        <td><a href="${result.url}" target="_blank">${result.url}</a></td>
                        <td>${result.title}</td>
                        <td>${result.description}</td>
                    </tr>
                `;
        }
      }

      tableHTML += `
                </tbody>
            </table>
        `;

      resultsContainer.innerHTML = tableHTML;
    }

    function displayKeywordRecommendations(recommendations, containerId) {
      const recommendationsContainer = document.getElementById(containerId);
      if (!recommendationsContainer) {
        console.error(`Element with ID '${containerId}' not found.`);
        return;
      }

      recommendationsContainer.innerHTML = `${recommendations}`;
    }


    async function startAnalysis() {
      const language = document.getElementById('language').value;
      const location = document.getElementById('location').value;
      const target = document.getElementById('target').value;
      const keywordsInput = document.getElementById('keywords').value;
      const keywords = keywordsInput.split(',').map(keyword => keyword.trim()).filter(keyword => keyword !== "");

      document.getElementById('analysisBtn').innerText = "Analysing...";

      document.getElementById('analysis-results').innerHTML = '';

      const analysisPromises = keywords.map(keyword =>
        performSearchAndAnalysis(keyword, language, location, target)
      );

      try {
        await Promise.all(analysisPromises);
        document.getElementById('analysisBtn').innerText = "Start Analysis";

      } catch (error) {
        console.error("Error during analysis:", error);
        document.getElementById('analysis-results').innerHTML = `<p class="error">Error during analysis: ${error.message}</p>`;
        document.getElementById('analysisBtn').innerText = "Start Analysis";
      }
    }
  </script>

</body>

</html>